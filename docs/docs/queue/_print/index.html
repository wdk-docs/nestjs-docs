<!doctype html>
<html lang="zh-cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.97.3" />
<link rel="canonical" type="text/html" href="https://wdk-docs.github.io/nestjs-docs/docs/queue/">
<link rel="alternate" type="application/rss&#43;xml" href="https://wdk-docs.github.io/nestjs-docs/docs/queue/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/nestjs-docs/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/nestjs-docs/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/nestjs-docs/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/nestjs-docs/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/nestjs-docs/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/nestjs-docs/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/nestjs-docs/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/nestjs-docs/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/nestjs-docs/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/nestjs-docs/favicons/android-192x192.png" sizes="192x192">

<title>é˜Ÿåˆ— | NestJS æ–‡æ¡£</title>
<meta name="description" content="
https://github.com/axios/axios

">
<meta property="og:title" content="é˜Ÿåˆ—" />
<meta property="og:description" content="NestJs æ–‡æ¡£" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://wdk-docs.github.io/nestjs-docs/docs/queue/" /><meta property="og:site_name" content="NestJS æ–‡æ¡£" />

<meta itemprop="name" content="é˜Ÿåˆ—">
<meta itemprop="description" content="NestJs æ–‡æ¡£"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="é˜Ÿåˆ—"/>
<meta name="twitter:description" content="NestJs æ–‡æ¡£"/>




<link rel="preload" href="/nestjs-docs/scss/main.min.90983698afafd407e6b72e83a2b749ff1726e8502277108f05bd66510938dec2.css" as="style">
<link href="/nestjs-docs/scss/main.min.90983698afafd407e6b72e83a2b749ff1726e8502277108f05bd66510938dec2.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK"
  crossorigin="anonymous"></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-00000000-0', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/nestjs-docs/">
		<span class="navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="font-weight-bold">NestJS æ–‡æ¡£</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="/nestjs-docs/docs/" ><span class="active">æ–‡æ¡£</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/nestjs-docs/blog/" ><span>åšå®¢</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"><input type="search" class="form-control td-search-input" placeholder="&#xf002; ç«™å†…æœç´¢â€¦" aria-label="ç«™å†…æœç´¢â€¦" autocomplete="off">
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
è¿™æ˜¯æœ¬èŠ‚çš„å¤šé¡µæ‰“å°è§†å›¾ã€‚
<a href="#" onclick="print();return false;">ç‚¹å‡»æ­¤å¤„æ‰“å°</a>.
</p><p>
<a href="/nestjs-docs/docs/queue/">è¿”å›æœ¬é¡µå¸¸è§„è§†å›¾</a>.
</p>
</div>



<h1 class="title">é˜Ÿåˆ—</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-0434ba7f30f49cc3172e991b753c1e82">bull</a></li>


    
  
    
    
	
<li>2: <a href="#pg-f5431b111661b3529e1ee10738caa3ad">æŒ‡å—</a></li>


    
  
    
    
	
<li>3: <a href="#pg-b2b86a8b70578d701ade6f6cd94fede2">å‚è€ƒ</a></li>


    
  
    
    
	
<li>4: <a href="#pg-ad94521a760596fc6e71a48e245b8ae8">æ¨¡å¼</a></li>


    
  

    </ul>


<div class="content">
      <blockquote>
<p><a href="https://github.com/axios/axios">https://github.com/axios/axios</a></p>
</blockquote>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-0434ba7f30f49cc3172e991b753c1e82">1 - bull</h1>
    <div class="lead">æœ€å¿«ã€æœ€å¯é ã€åŸºäºredisçš„Nodeé˜Ÿåˆ—ã€‚ ä»”ç»†å†™çš„å²©çŸ³å›ºä½“çš„ç¨³å®šæ€§å’ŒåŸå­æ€§ã€‚</div>
	<blockquote>
<p><a href="https://github.com/OptimalBits/bull">https://github.com/OptimalBits/bull</a></p>
</blockquote>
<p>è¯·åœ¨<a href="http://twitter.com/manast">ğŸ“»Twitter</a>ä¸Šå…³æ³¨æˆ‘ï¼Œäº†è§£é‡è¦çš„æ–°é—»å’Œæ›´æ–°ã€‚
ä½ å¯ä»¥åœ¨è¿™ä¸ªåšå®¢ä¸­æ‰¾åˆ°æ•™ç¨‹å’Œæ–°é—»: <a href="https://blog.taskforce.sh/">ğŸ›  æ•™ç¨‹</a></p>
<h3 id="bull-ç‰¹æ€§">Bull ç‰¹æ€§</h3>
<ul>
<li><input checked="" disabled="" type="checkbox"> æœ€å°çš„ CPU ä½¿ç”¨ç‡ï¼Œç”±äºæ— è½®è¯¢è®¾è®¡ã€‚</li>
<li><input checked="" disabled="" type="checkbox"> åŸºäº Redis çš„ç¨³å¥è®¾è®¡ã€‚</li>
<li><input checked="" disabled="" type="checkbox"> å»¶è¿Ÿçš„å·¥ä½œã€‚</li>
<li><input checked="" disabled="" type="checkbox"> æ ¹æ® cron è§„èŒƒå®‰æ’å’Œé‡å¤ä½œä¸šã€‚</li>
<li><input checked="" disabled="" type="checkbox"> å¯¹å·¥ä½œçš„ç‡é™åˆ¶ã€‚</li>
<li><input checked="" disabled="" type="checkbox"> é‡è¯•ã€‚</li>
<li><input checked="" disabled="" type="checkbox"> ä¼˜å…ˆçº§ã€‚</li>
<li><input checked="" disabled="" type="checkbox"> å¹¶å‘æ€§ã€‚</li>
<li><input checked="" disabled="" type="checkbox"> æš‚åœ/æ¢å¤-å…¨å±€æˆ–æœ¬åœ°ã€‚</li>
<li><input checked="" disabled="" type="checkbox"> æ¯ä¸ªé˜Ÿåˆ—æœ‰å¤šä¸ªä½œä¸šç±»å‹ã€‚</li>
<li><input checked="" disabled="" type="checkbox"> çº¿ç¨‹(æ²™ç›’)å¤„ç†å‡½æ•°ã€‚</li>
<li><input checked="" disabled="" type="checkbox"> ä»è¿›ç¨‹å´©æºƒä¸­è‡ªåŠ¨æ¢å¤ã€‚</li>
</ul>
<p>æ¥ä¸‹æ¥æ˜¯è·¯çº¿å›¾â€¦</p>
<ul>
<li><input disabled="" type="checkbox"> ä½œä¸šå®Œæˆç¡®è®¤(åŒæ—¶å¯ä»¥ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—<a href="https://github.com/OptimalBits/bull/blob/develop/PATTERNS.md#returning-job-completions">pattern</a>)ã€‚</li>
<li><input disabled="" type="checkbox"> çˆ¶å­çš„å·¥ä½œå…³ç³»ã€‚</li>
</ul>
<hr>
<h3 id="uis">UIs</h3>
<p>ä½ å¯ä»¥ä½¿ç”¨ä¸€äº›ç¬¬ä¸‰æ–¹ ui æ¥è¿›è¡Œç›‘æ§:</p>
<p><strong>BullMQ</strong></p>
<ul>
<li><a href="https://taskforce.sh">Taskforce</a></li>
</ul>
<p><strong>Bull v3</strong></p>
<ul>
<li><a href="https://taskforce.sh">Taskforce</a></li>
<li><a href="https://github.com/vcapretz/bull-board">bull-board</a></li>
<li><a href="https://github.com/darky/bull-repl">bull-repl</a></li>
<li><a href="https://github.com/s-r-x/bull-monitor">bull-monitor</a></li>
<li><a href="https://github.com/AbhilashJN/monitoro">Monitoro</a></li>
</ul>
<p><strong>Bull &lt;= v2</strong></p>
<ul>
<li><a href="https://github.com/ShaneK/Matador">Matador</a></li>
<li><a href="https://github.com/kfatehi/react-bull">react-bull</a></li>
<li><a href="https://github.com/Epharmix/Toureiro">Toureiro</a></li>
</ul>
<hr>
<h3 id="ç›‘æµ‹å’ŒæŠ¥è­¦">ç›‘æµ‹å’ŒæŠ¥è­¦</h3>
<ul>
<li>ä½¿ç”¨ Prometheus <a href="https://github.com/UpHabit/bull_exporter">Bull Queue Exporter</a></li>
</ul>
<hr>
<h3 id="ç‰¹å¾æ¯”è¾ƒ">ç‰¹å¾æ¯”è¾ƒ</h3>
<p>ç”±äºæœ‰ä¸€äº›ä½œä¸šé˜Ÿåˆ—è§£å†³æ–¹æ¡ˆï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªè¡¨æ¯”è¾ƒå®ƒä»¬:</p>
<table>
<thead>
<tr>
<th style="text-align:left">Feature</th>
<th style="text-align:center">Bullmq-Pro</th>
<th style="text-align:center">Bullmq</th>
<th style="text-align:center">Bull</th>
<th style="text-align:center">Kue</th>
<th>Bee</th>
<th>Agenda</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">åç«¯</td>
<td style="text-align:center">redis</td>
<td style="text-align:center">redis</td>
<td style="text-align:center">redis</td>
<td style="text-align:center">redis</td>
<td>redis</td>
<td>mongo</td>
</tr>
<tr>
<td style="text-align:left">è§‚å¯Ÿ</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">ç»„é€Ÿç‡é™åˆ¶</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">é›†ç¾¤æ”¯æŒ</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">çˆ¶/å­ä¾èµ–å…³ç³»</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">ä¼˜å…ˆçº§</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center">âœ“</td>
<td></td>
<td>âœ“</td>
</tr>
<tr>
<td style="text-align:left">å¹¶å‘æ€§</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center">âœ“</td>
<td>âœ“</td>
<td>âœ“</td>
</tr>
<tr>
<td style="text-align:left">æ¼”ç¤ºå·¥ä½œ</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center">âœ“</td>
<td></td>
<td>âœ“</td>
</tr>
<tr>
<td style="text-align:left">å…¨å±€äº‹ä»¶</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center">âœ“</td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">é€Ÿåº¦é™åˆ¶å™¨</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center"></td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">æš‚åœ/æ¢å¤</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center">âœ“</td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">æ²™ç®±å·¥äºº</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center"></td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">å¯é‡å¤çš„å·¥ä½œ</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center"></td>
<td></td>
<td>âœ“</td>
</tr>
<tr>
<td style="text-align:left">åŸå­æ“ä½œ</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center"></td>
<td>âœ“</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">æŒä¹…æ€§</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center">âœ“</td>
<td>âœ“</td>
<td>âœ“</td>
</tr>
<tr>
<td style="text-align:left">ç”¨æˆ·ç•Œé¢</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center">âœ“</td>
<td></td>
<td>âœ“</td>
</tr>
<tr>
<td style="text-align:left">ä¼˜åŒ–äº†</td>
<td style="text-align:center">Jobs / Messages</td>
<td style="text-align:center">Jobs / Messages</td>
<td style="text-align:center">Jobs / Messages</td>
<td style="text-align:center">Jobs</td>
<td>Messages</td>
<td>Jobs</td>
</tr>
</tbody>
</table>
<h3 id="å®‰è£…">å®‰è£…</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>npm install bull --save
</span></span></code></pre></div><p>æˆ–è€…</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yarn add bull
</span></span></code></pre></div><p><em><strong>è¦æ±‚:</strong> Bull éœ€è¦å¤§äºæˆ–ç­‰äº&rsquo; 2.8.18 &lsquo;çš„ Redis ç‰ˆæœ¬ã€‚</em></p>
<h3 id="typescript-å®šä¹‰">Typescript å®šä¹‰</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>npm install @types/bull --save-dev
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yarn add --dev @types/bull
</span></span></code></pre></div><p>å®šä¹‰ç›®å‰ç»´æŠ¤åœ¨<a href="https://github.com/DefinitelyTyped/DefinitelyTyped/tree/master/types/bull">DefinitelyTyped</a> repo ä¸­ã€‚</p>
<h3 id="å¿«é€ŸæŒ‡å—">å¿«é€ŸæŒ‡å—</h3>
<h4 id="åŸºæœ¬ç”¨æ³•">åŸºæœ¬ç”¨æ³•</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Queue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;bull&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">videoQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;video transcoding&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;redis://127.0.0.1:6379&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">audioQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;audio transcoding&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">redis</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">6379</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;foobared&#34;</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// Specify Redis connection using object
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">imageQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;image transcoding&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">pdfQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;pdf transcoding&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">videoQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">done</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// job.data contains the custom data passed when the job was created
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// job.id contains id of this job.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// transcode video asynchronously and report progress
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">progress</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">42</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// call done when finished
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">done</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// or give a error if error
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">done</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error transcoding&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// or pass it a result
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">done</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">framerate</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">29.5</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* etc...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// If the job throws an unhandled exception it is also handled correctly
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;some unexpected error&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">audioQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">done</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// transcode audio asynchronously and report progress
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">progress</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">42</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// call done when finished
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">done</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// or give a error if error
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">done</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error transcoding&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// or pass it a result
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">done</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">samplerate</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">48000</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* etc...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// If the job throws an unhandled exception it is also handled correctly
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;some unexpected error&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">imageQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">done</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// transcode image asynchronously and report progress
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">progress</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">42</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// call done when finished
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">done</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// or give a error if error
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">done</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error transcoding&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// or pass it a result
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">done</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1280</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">height</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">720</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* etc...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// If the job throws an unhandled exception it is also handled correctly
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;some unexpected error&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">pdfQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// Processors can also return promises instead of using the done callback
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">pdfAsyncProcessor</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">videoQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">video</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http://example.com/video1.mov&#34;</span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#000">audioQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">audio</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http://example.com/audio1.mp3&#34;</span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#000">imageQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">image</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http://example.com/image1.tiff&#34;</span> <span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><h4 id="ä½¿ç”¨æ‰¿è¯º">ä½¿ç”¨æ‰¿è¯º</h4>
<p>æˆ–è€…ï¼Œä½ å¯ä»¥ä½¿ç”¨ return promises æ¥ä»£æ›¿<code>done</code>å›è°ƒ:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#000">videoQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ä¸è¦å¿˜è®°åˆ é™¤doneå›è°ƒ!
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// ç®€å•åœ°å›æŠ¥ä¸€ä¸ªæ‰¿è¯º
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fetchVideo</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">url</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">transcodeVideo</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// å¤„ç†æ‰¿è¯ºæ‹’ç»
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reject</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error transcoding&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// å°†æ‰¿è¯ºè§£æçš„å€¼ä¼ é€’ç»™â€œcompletedâ€äº‹ä»¶
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resolve</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">framerate</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">29.5</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* etc...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// å¦‚æœä½œä¸šæŠ›å‡ºä¸€ä¸ªæœªå¤„ç†çš„å¼‚å¸¸ï¼Œå®ƒä¹Ÿä¼šå¾—åˆ°æ­£ç¡®çš„å¤„ç†
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;some unexpected error&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ä¸€æ ·
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reject</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;some unexpected error&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><h4 id="ç‹¬ç«‹çš„è¿›ç¨‹">ç‹¬ç«‹çš„è¿›ç¨‹</h4>
<p>è¿›ç¨‹å‡½æ•°ä¹Ÿå¯ä»¥åœ¨å•ç‹¬çš„è¿›ç¨‹ä¸­è¿è¡Œã€‚è¿™æœ‰å‡ ä¸ªå¥½å¤„:</p>
<ul>
<li>è¿™ä¸ªè¿›ç¨‹æ˜¯æ²™ç®±åŒ–çš„ï¼Œæ‰€ä»¥å³ä½¿å®ƒå´©æºƒäº†ï¼Œä¹Ÿä¸ä¼šå½±å“å·¥ä½œè¿›ç¨‹ã€‚</li>
<li>æ‚¨å¯ä»¥åœ¨ä¸å½±å“é˜Ÿåˆ—çš„æƒ…å†µä¸‹è¿è¡Œé˜»å¡ä»£ç (ä½œä¸šä¸ä¼šåœæ­¢)ã€‚</li>
<li>æ›´å¥½åœ°åˆ©ç”¨å¤šæ ¸ cpuã€‚</li>
<li>å‡å°‘ä¸ redis çš„è¿æ¥ã€‚</li>
</ul>
<p>ä¸ºäº†ä½¿ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œåªéœ€åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„å¤„ç†å™¨æ–‡ä»¶:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// processor.js
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">module</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">exports</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// åšä¸€äº›ç¹é‡çš„å·¥ä½œ
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resolve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>ç„¶ååƒè¿™æ ·å®šä¹‰å¤„ç†å™¨:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// å•æµç¨‹:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/path/to/my/processor.js&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨å¹¶å‘:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;/path/to/my/processor.js&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// å’ŒæŒ‡å®šçš„å¤„ç†å™¨:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;my processor&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;/path/to/my/processor.js&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><h4 id="é‡å¤çš„å·¥ä½œ">é‡å¤çš„å·¥ä½œ</h4>
<p>ä½œä¸šå¯ä»¥è¢«æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ï¼Œå¹¶æ ¹æ® cron è§„èŒƒé‡å¤å¤„ç†:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000">paymentsQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// Check payments
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Repeat payment job once every day at 3:15 (am)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">paymentsQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">paymentsData</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">repeat</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">cron</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;15 3 * * *&#34;</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>ä½œä¸ºæç¤ºï¼Œè¯·æ£€æŸ¥è¿™é‡Œçš„è¡¨è¾¾å¼ï¼Œä»¥éªŒè¯å®ƒä»¬æ˜¯æ­£ç¡®çš„:<a href="https://crontab.cronhub.io">cron è¡¨è¾¾å¼ç”Ÿæˆå™¨</a></p>
<h4 id="æš‚åœæ¢å¤">æš‚åœ/æ¢å¤</h4>
<p>ä¸€ä¸ªé˜Ÿåˆ—å¯ä»¥è¢«å…¨å±€æš‚åœå’Œæ¢å¤(ä¼ é€’ <code>true</code> æ¥æš‚åœè¿™ä¸ª worker çš„å¤„ç†):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pause</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// queue is paused now
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resume</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// queue is resumed now
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><h4 id="äº‹ä»¶">äº‹ä»¶</h4>
<p>é˜Ÿåˆ—ä¼šå‘å‡ºä¸€äº›æœ‰ç”¨çš„äº‹ä»¶ï¼Œä¾‹å¦‚â€¦</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;completed&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// Job completed with output result!
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">})</span>
</span></span></code></pre></div><p>æœ‰å…³äº‹ä»¶çš„æ›´å¤šä¿¡æ¯ï¼ŒåŒ…æ‹¬æ‰€è§¦å‘äº‹ä»¶çš„å®Œæ•´åˆ—è¡¨ï¼Œè¯·å‚é˜…<a href="./REFERENCE.md#events">äº‹ä»¶å‚è€ƒèµ„æ–™</a></p>
<h4 id="é˜Ÿåˆ—æ€§èƒ½">é˜Ÿåˆ—æ€§èƒ½</h4>
<p>é˜Ÿåˆ—å¾ˆä¾¿å®œï¼Œæ‰€ä»¥å¦‚æœä½ éœ€è¦å¾ˆå¤šé˜Ÿåˆ—ï¼Œåªéœ€åˆ›å»ºæ–°çš„ä¸åŒåç§°çš„é˜Ÿåˆ—:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">userJohn</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;john&#39;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">userLisa</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;lisa&#39;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span>
</span></span></code></pre></div><p>ç„¶è€Œï¼Œæ¯ä¸ªé˜Ÿåˆ—å®ä¾‹å°†éœ€è¦æ–°çš„ redis è¿æ¥ï¼Œæ£€æŸ¥å¦‚ä½•<a href="https://github.com/OptimalBits/bull/blob/master/PATTERNS.md#reusing-redis-connections">é‡ç”¨è¿æ¥</a>ï¼Œæˆ–è€…ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨<a href="https://github.com/OptimalBits/bull/blob/master/REFERENCE.md#queueprocess">å‘½åå¤„ç†å™¨</a>æ¥å®ç°ç±»ä¼¼çš„ç»“æœã€‚</p>
<h4 id="é›†ç¾¤çš„æ”¯æŒ">é›†ç¾¤çš„æ”¯æŒ</h4>
<blockquote>
<p>NOTE: ä» 3.2.0 åŠä»¥ä¸Šç‰ˆæœ¬å¼€å§‹ï¼Œå»ºè®®ä½¿ç”¨çº¿ç¨‹å¤„ç†å™¨ã€‚</p>
</blockquote>
<p>é˜Ÿåˆ—æ˜¯å¥å£®çš„ï¼Œå¯ä»¥åœ¨å‡ ä¸ªçº¿ç¨‹æˆ–è¿›ç¨‹ä¸­å¹¶è¡Œè¿è¡Œï¼Œæ²¡æœ‰ä»»ä½•å±é™©æˆ–é˜Ÿåˆ—æŸåçš„é£é™©ã€‚
æ£€æŸ¥è¿™ä¸ªç®€å•çš„ä¾‹å­ï¼Œä½¿ç”¨ cluster è·¨è¿›ç¨‹å¹¶è¡ŒåŒ–ä»»åŠ¡:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Queue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;bull&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">cluster</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;cluster&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">numWorkers</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">queue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;test concurrent queue&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cluster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isMaster</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">numWorkers</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cluster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">fork</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">cluster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;online&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">worker</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Let&#39;s create a few jobs for the queue workers
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">500</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;bar&#34;</span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">cluster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;exit&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">worker</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">code</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">signal</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;worker &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">worker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34; died&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">jobDone</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Job done by worker&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cluster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">worker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">jobDone</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><hr>
<h3 id="æ–‡æ¡£">æ–‡æ¡£</h3>
<p>è¦è·å–å®Œæ•´çš„æ–‡æ¡£ï¼Œè¯·æŸ¥çœ‹å‚è€ƒå’Œå¸¸ç”¨æ¨¡å¼:</p>
<ul>
<li><a href="https://optimalbits.github.io/bull/">æŒ‡å—</a> - ä½ ä½¿ç”¨ Bull å¼€å‘çš„èµ·ç‚¹ã€‚</li>
<li><a href="./REFERENCE.md">å‚è€ƒ</a> - åŒ…å«æ‰€æœ‰å¯ç”¨å¯¹è±¡å’Œæ–¹æ³•çš„å¼•ç”¨æ–‡æ¡£ã€‚</li>
<li><a href="./PATTERNS.md">æ¨¡å¼</a> - ä¸€ç»„å¸¸è§æ¨¡å¼çš„ç¤ºä¾‹ã€‚</li>
<li><a href="./LICENSE.md">è®¸å¯è¯</a> - Bull è®¸å¯è¯-éº»çœç†å·¥å­¦é™¢ã€‚</li>
</ul>
<p>å¦‚æœä½ çœ‹åˆ°ä»»ä½•å¯ä»¥ä½¿ç”¨æ›´å¤šæ–‡æ¡£çš„ä¸œè¥¿ï¼Œè¯·æäº¤ä¸€ä¸ª pull request!</p>
<hr>
<h3 id="é‡è¦çš„ç¬”è®°">é‡è¦çš„ç¬”è®°</h3>
<p>é˜Ÿåˆ—çš„ç›®æ ‡æ˜¯â€œè‡³å°‘ä¸€æ¬¡â€çš„å·¥ä½œç­–ç•¥ã€‚
è¿™æ„å‘³ç€åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¸€ä¸ªä½œä¸šå¯èƒ½ä¼šè¢«å¤šæ¬¡å¤„ç†ã€‚
è¿™ç§æƒ…å†µé€šå¸¸å‘ç”Ÿåœ¨ä¸€ä¸ª worker åœ¨æ•´ä¸ªå¤„ç†è¿‡ç¨‹ä¸­æ²¡æœ‰ä¸ºç»™å®šçš„ä½œä¸šä¿æŒé”çš„æ—¶å€™ã€‚</p>
<p>å½“ä¸€ä¸ªå·¥äººæ­£åœ¨å¤„ç†ä¸€é¡¹å·¥ä½œæ—¶ï¼Œå®ƒå°†ä½¿è¯¥å·¥ä½œä¿æŒâ€œé”å®šâ€ï¼Œä»¥ä¾¿å…¶ä»–å·¥äººä¸èƒ½å¤„ç†å®ƒã€‚</p>
<p>ç†è§£é”å®šæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œä»¥é˜²æ­¢æ‚¨çš„ä½œä¸šå¤±å»é”- becoming <em>stalled</em> - å¹¶å› æ­¤é‡æ–°å¯åŠ¨ï¼Œè¿™ä¸€ç‚¹å¾ˆé‡è¦ã€‚
é”æ˜¯é€šè¿‡åœ¨ <code>lockRenewTime</code> (é€šå¸¸æ˜¯ <code>lockDuration</code> çš„ä¸€åŠ)ä¸Šä¸º <code>lockDuration</code> åˆ›å»ºä¸€ä¸ªé”æ¥å®ç°çš„ã€‚
å¦‚æœ <code>lockDuration</code> åœ¨é”è¢«æ›´æ–°ä¹‹å‰è¿‡æœŸï¼Œåˆ™è¯¥ä½œä¸šå°†è¢«è§†ä¸ºæš‚åœå¹¶è‡ªåŠ¨é‡å¯;å®ƒå°†è¢«<strong>äºŒæ¬¡åŠ å·¥</strong>ã€‚</p>
<p>è¿™ç§æƒ…å†µå¯èƒ½å‘ç”Ÿåœ¨:</p>
<ol>
<li>è¿è¡Œä½œä¸šå¤„ç†å™¨çš„ Node è¿›ç¨‹æ„å¤–ç»ˆæ­¢ã€‚</li>
<li>æ‚¨çš„ä½œä¸šå¤„ç†å™¨ cpu è¿‡äºå¯†é›†ï¼Œå¯¼è‡´ Node äº‹ä»¶å¾ªç¯åœé¡¿ï¼Œç»“æœï¼ŒBull æ— æ³•æ›´æ–°ä½œä¸šé”(è¯·å‚é˜…<a href="https://github.com/OptimalBits/bull/issues/488">#488</a>äº†è§£å¦‚ä½•æ›´å¥½åœ°æ£€æµ‹æ­¤é—®é¢˜)ã€‚
æ‚¨å¯ä»¥é€šè¿‡å°†ä½œä¸šå¤„ç†å™¨åˆ†è§£ä¸ºæ›´å°çš„éƒ¨åˆ†æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè¿™æ ·å•ä¸ªéƒ¨åˆ†å°±ä¸ä¼šé˜»å¡ Node äº‹ä»¶å¾ªç¯ã€‚
æˆ–è€…ï¼Œæ‚¨å¯ä»¥ä¸º <code>lockDuration</code> è®¾ç½®ä¼ é€’ä¸€ä¸ªæ›´å¤§çš„å€¼(ä»£ä»·æ˜¯å®ƒå°†èŠ±è´¹æ›´é•¿çš„æ—¶é—´æ¥è¯†åˆ«çœŸæ­£çš„æš‚åœä½œä¸š)ã€‚</li>
</ol>
<p>å› æ­¤ï¼Œæ‚¨åº”è¯¥å§‹ç»ˆä¾¦å¬ <code>stopped</code> äº‹ä»¶å¹¶å°†å…¶è®°å½•åˆ°é”™è¯¯ç›‘è§†ç³»ç»Ÿä¸­ï¼Œå› ä¸ºè¿™æ„å‘³ç€æ‚¨çš„ä½œä¸šå¯èƒ½ä¼šè¢«é‡å¤å¤„ç†ã€‚</p>
<p>ä½œä¸ºä¸€ç§å®‰å…¨æªæ–½ï¼Œæœ‰é—®é¢˜çš„ä½œä¸šä¸ä¼šè¢«æ— é™æœŸé‡å¯(ä¾‹å¦‚ï¼Œå¦‚æœä½œä¸šå¤„ç†å™¨æ€»æ˜¯å´©æºƒå®ƒçš„ Node è¿›ç¨‹)ï¼Œä½œä¸šå°†ä»åœæ­¢çŠ¶æ€æ¢å¤ï¼Œæœ€å¤§æ¬¡æ•°ä¸º <code>maxStalledCount</code> (é»˜è®¤ä¸º <code>1</code>)ã€‚</p>
<h3 id="è°åœ¨ä½¿ç”¨">è°åœ¨ä½¿ç”¨</h3>
<p>Bull åœ¨å¤§å¤§å°å°çš„ç»„ç»‡ä¸­éƒ½å¾ˆå—æ¬¢è¿ï¼Œæ¯”å¦‚ä»¥ä¸‹è¿™äº›ç»„ç»‡:</p>
<table cellspacing="0" cellpadding="0">
  <tr>
    <td valign="center">
      <a href="https://github.com/atlassian/github-for-jira">
        <img
          src="https://876297641-files.gitbook.io/~/files/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-LUuDmt_xXMfG66Rn1GA%2Fuploads%2FevsJCF6F1tx1ScZwDQOd%2FAtlassian-horizontal-blue-rgb.webp?alt=media&token=2fcd0528-e8bb-4bdd-af35-9d20e313d1a8"
          width="150"
          alt="Atlassian"
      /></a>
    </td>
    <td valign="center">
      <a href="https://github.com/Autodesk">
        <img
          src="https://876297641-files.gitbook.io/~/files/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-LUuDmt_xXMfG66Rn1GA%2Fuploads%2FvpTe02RdOhUJBA8TdHEE%2Fautodesk-logo-white.png?alt=media&token=326961b4-ea4f-4ded-89a4-e05692eec8ee"
          width="150"
          alt="Autodesk"
      /></a>
    </td>
    <td valign="center">
      <a href="https://github.com/common-voice/common-voice">
        <img
          src="https://876297641-files.gitbook.io/~/files/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-LUuDmt_xXMfG66Rn1GA%2Fuploads%2F4zPSrubNJKViAzUIftIy%2Fmozilla-logo-bw-rgb.png?alt=media&token=9f93aae2-833f-4cc4-8df9-b7fea0ad5cb5"
          width="150"
          alt="Mozilla"
      /></a>
    </td>
    <td valign="center">
      <a href="https://github.com/nestjs/bull">
        <img
          src="https://876297641-files.gitbook.io/~/files/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-LUuDmt_xXMfG66Rn1GA%2Fuploads%2FfAcGye182utFUtPKdLqJ%2FScreenshot%202022-02-15%20at%2011.32.39.png?alt=media&token=29feb550-f0bc-467d-a290-f700701d7d15"
          width="150"
          alt="Nest"
      /></a>
    </td>
    <td valign="center">
      <a href="https://github.com/salesforce/refocus">
        <img
          src="https://876297641-files.gitbook.io/~/files/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-LUuDmt_xXMfG66Rn1GA%2Fuploads%2FZNnYNuL5qJ6ZoBh7JJEW%2Fsalesforce-logo.png?alt=media&token=ddcae63b-08c0-4dd4-8496-3b29a9bf977d"
          width="100"
          alt="Salesforce"
      /></a>
    </td>
  </tr>
</table>
<hr>
<h3 id="bullmq">BullMQ</h3>
<p>å¦‚æœä½ æƒ³å¼€å§‹ä½¿ç”¨å®Œå…¨ç”¨ Typescript ç¼–å†™çš„ä¸‹ä¸€ä¸ªä¸»è¦ç‰ˆæœ¬çš„ Bullï¼Œæ¬¢è¿ä½¿ç”¨æ–°çš„ repo<a href="https://github.com/taskforcesh/bullmq">è¿™é‡Œ</a>.
å¦åˆ™ï¼Œæˆ‘ä»¬éå¸¸æ¬¢è¿ä½ ä»ç„¶ä½¿ç”¨ Bullï¼Œè¿™æ˜¯ä¸€ä¸ªå®‰å…¨çš„ã€ç»è¿‡æˆ˜æ–—æµ‹è¯•çš„ä»£ç åº“ã€‚</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f5431b111661b3529e1ee10738caa3ad">2 - æŒ‡å—</h1>
    
	<p><img src="https://raw.githubusercontent.com/OptimalBits/bull/master/support/logo%402x.png" alt=""></p>
<ul>
<li><a href="#bull-%E6%98%AF%E4%BB%80%E4%B9%88">Bull æ˜¯ä»€ä¹ˆ?</a></li>
<li><a href="#%E5%BC%80%E5%A7%8B">å¼€å§‹</a></li>
<li><a href="#%E7%AE%80%E5%8D%95%E7%9A%84%E9%98%9F%E5%88%97">ç®€å•çš„é˜Ÿåˆ—</a>
<ul>
<li><a href="#%E7%94%9F%E4%BA%A7%E8%80%85">ç”Ÿäº§è€…</a></li>
<li><a href="#%E6%B6%88%E8%B4%B9%E8%80%85">æ¶ˆè´¹è€…</a></li>
<li><a href="#%E4%BE%A6%E5%90%AC%E5%99%A8">ä¾¦å¬å™¨</a></li>
<li><a href="#%E4%B8%80%E4%BB%BD%E5%B7%A5%E4%BD%9C%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F">ä¸€ä»½å·¥ä½œçš„ç”Ÿå‘½å‘¨æœŸ</a></li>
<li><a href="#%E5%81%9C%E6%BB%9E%E4%B8%8D%E5%89%8D%E7%9A%84%E5%B7%A5%E4%BD%9C">åœæ»ä¸å‰çš„å·¥ä½œ</a></li>
</ul>
</li>
<li><a href="#%E4%BA%8B%E4%BB%B6">äº‹ä»¶</a></li>
<li><a href="#%E9%98%9F%E5%88%97%E7%9A%84%E9%80%89%E9%A1%B9">é˜Ÿåˆ—çš„é€‰é¡¹</a>
<ul>
<li><a href="#%E9%80%9F%E5%BA%A6%E9%99%90%E5%88%B6%E5%99%A8">é€Ÿåº¦é™åˆ¶å™¨</a></li>
<li><a href="#%E5%91%BD%E5%90%8D%E5%B7%A5%E4%BD%9C">å‘½åå·¥ä½œ</a></li>
<li><a href="#%E6%B2%99%E7%AE%B1%E5%A4%84%E7%90%86%E5%99%A8">æ²™ç®±å¤„ç†å™¨</a></li>
</ul>
</li>
<li><a href="#%E4%BD%9C%E4%B8%9A%E7%B1%BB%E5%9E%8B">ä½œä¸šç±»å‹</a>
<ul>
<li><a href="#lifo">LIFO</a></li>
<li><a href="#%E5%BB%B6%E8%BF%9F">å»¶è¿Ÿ</a></li>
<li><a href="#%E4%BC%98%E5%85%88">ä¼˜å…ˆ</a></li>
<li><a href="#%E5%8F%AF%E9%87%8D%E5%A4%8D%E7%9A%84">å¯é‡å¤çš„</a></li>
</ul>
</li>
</ul>
<h2 id="bull-æ˜¯ä»€ä¹ˆ">Bull æ˜¯ä»€ä¹ˆ?</h2>
<p>Bull æ˜¯ä¸€ä¸ª Node åº“ï¼Œå®ƒå®ç°äº†ä¸€ä¸ªå¿«é€Ÿã€å¥å£®çš„åŸºäº<a href="https://redis.io">redis</a>çš„é˜Ÿåˆ—ç³»ç»Ÿã€‚</p>
<p>è™½ç„¶å¯ä»¥ç›´æ¥ä½¿ç”¨ Redis å‘½ä»¤æ¥å®ç°é˜Ÿåˆ—ï¼Œä½†è¿™ä¸ªåº“æä¾›äº†ä¸€ä¸ª API æ¥å¤„ç†æ‰€æœ‰åº•å±‚ç»†èŠ‚ï¼Œå¹¶ä¸°å¯Œäº† Redis çš„åŸºæœ¬åŠŸèƒ½ï¼Œè¿™æ ·æ›´å¤æ‚çš„ç”¨ä¾‹å°±å¯ä»¥è½»æ¾å¤„ç†ã€‚</p>
<p>å¦‚æœä½ ä¸ç†Ÿæ‚‰æ’é˜Ÿï¼Œä½ å¯èƒ½ä¼šæƒ³ä¸ºä»€ä¹ˆéœ€è¦æ’é˜Ÿã€‚
é˜Ÿåˆ—å¯ä»¥ä»¥ä¸€ç§ä¼˜é›…çš„æ–¹å¼è§£å†³è®¸å¤šä¸åŒçš„é—®é¢˜ï¼Œä»å¹³æ»‘å¤„ç†é«˜å³°åˆ°åœ¨å¾®æœåŠ¡ä¹‹é—´åˆ›å»ºå¥å£®çš„é€šä¿¡é€šé“ï¼Œæˆ–å°†ç¹é‡çš„å·¥ä½œä»ä¸€å°æœåŠ¡å™¨è½¬ç§»åˆ°è®¸å¤šè¾ƒå°çš„ workerï¼Œç­‰ç­‰ã€‚</p>
<h2 id="å¼€å§‹">å¼€å§‹</h2>
<p>Bull æ˜¯ä¸€ä¸ªå…¬å…±çš„ npm åŒ…ï¼Œå¯ä»¥ä½¿ç”¨ npm æˆ– yarn æ¥å®‰è£…:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ npm install bull --save
</span></span></code></pre></div><p>or</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ yarn add bull
</span></span></code></pre></div><p>ä¸ºäº†ä½¿ç”¨ Bullï¼Œä½ è¿˜éœ€è¦æœ‰ä¸€ä¸ªè¿è¡Œçš„ Redis æœåŠ¡å™¨ã€‚
å¯¹äºæœ¬åœ°å¼€å‘ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨<a href="https://hub.docker.com/_/redis/">docker</a>è½»æ¾å®‰è£…å®ƒã€‚</p>
<p>Bull å°†é»˜è®¤å°è¯•è¿æ¥åˆ°è¿è¡Œåœ¨&rsquo; localhost:6379 &lsquo;ä¸Šçš„ Redis æœåŠ¡å™¨</p>
<h2 id="ç®€å•çš„é˜Ÿåˆ—">ç®€å•çš„é˜Ÿåˆ—</h2>
<p>ä¸€ä¸ªé˜Ÿåˆ—å¯ä»¥é€šè¿‡å®ä¾‹åŒ–ä¸€ä¸ª Bull å®ä¾‹æ¥åˆ›å»º:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">myFirstQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Bull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;my-first-queue&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>ä¸€ä¸ªé˜Ÿåˆ—å®ä¾‹é€šå¸¸æœ‰ 3 ä¸ªä¸åŒçš„ä¸»è¦è§’è‰²:ä½œä¸šç”Ÿäº§è€…ã€ä½œä¸šä½¿ç”¨è€…æˆ–/å’Œäº‹ä»¶ä¾¦å¬å™¨ã€‚</p>
<p>è™½ç„¶ä¸€ä¸ªç»™å®šçš„å®ä¾‹å¯ä»¥ç”¨äºè¿™ 3 ä¸ªè§’è‰²ï¼Œä½†é€šå¸¸ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…è¢«åˆ’åˆ†ä¸ºå‡ ä¸ªå®ä¾‹ã€‚
ä¸€ä¸ªç»™å®šçš„é˜Ÿåˆ—ï¼Œæ€»æ˜¯é€šè¿‡å®ƒçš„å®ä¾‹åŒ–åç§°(åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­æ˜¯&rsquo; my-first-queue &lsquo;)å¼•ç”¨ï¼Œå¯ä»¥æœ‰è®¸å¤šç”Ÿäº§è€…ã€è®¸å¤šæ¶ˆè´¹è€…å’Œè®¸å¤šä¾¦å¬å™¨ã€‚
ä¸€ä¸ªé‡è¦çš„æ–¹é¢æ˜¯ï¼Œç”Ÿäº§è€…å¯ä»¥å°†ä½œä¸šæ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ï¼Œå³ä½¿æ­¤æ—¶æ²¡æœ‰å¯ç”¨çš„æ¶ˆè´¹è€…:é˜Ÿåˆ—æä¾›å¼‚æ­¥é€šä¿¡ï¼Œè¿™æ˜¯ä½¿å®ƒä»¬å¦‚æ­¤å¼ºå¤§çš„ç‰¹æ€§ä¹‹ä¸€ã€‚</p>
<p>ç›¸åï¼Œæ‚¨å¯ä»¥è®©ä¸€ä¸ªæˆ–å¤šä¸ª worker ä»é˜Ÿåˆ—ä¸­æ¶ˆè€—ä½œä¸šï¼Œå®ƒå°†æŒ‰ç…§ç»™å®šçš„é¡ºåºæ¶ˆè€—ä½œä¸š:FIFO(é»˜è®¤)ã€LIFO æˆ–æ ¹æ®ä¼˜å…ˆçº§ã€‚</p>
<p>è¯´åˆ° workerï¼Œå®ƒä»¬å¯ä»¥è¿è¡Œåœ¨ç›¸åŒæˆ–ä¸åŒçš„è¿›ç¨‹ä¸­ï¼Œåœ¨åŒä¸€å°æœºå™¨æˆ–é›†ç¾¤ä¸­ã€‚
Redis å°†å……å½“ä¸€ä¸ªå…¬å…±ç‚¹ï¼Œåªè¦æ¶ˆè´¹è€…æˆ–ç”Ÿäº§å•†èƒ½å¤Ÿè¿æ¥åˆ° Redisï¼Œä»–ä»¬å°±èƒ½å¤ŸååŒå¤„ç†å·¥ä½œã€‚</p>
<h3 id="ç”Ÿäº§è€…">ç”Ÿäº§è€…</h3>
<p>ä½œä¸šç”Ÿæˆå™¨æ˜¯ä¸€ä¸ªç®€å•çš„ Node ç¨‹åºï¼Œå®ƒå°†ä½œä¸šæ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ï¼Œåƒè¿™æ ·:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">myFirstQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Bull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;my-first-queue&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">job</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">myFirstQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>æ­£å¦‚æ‚¨æ‰€çœ‹åˆ°çš„ï¼Œä½œä¸šåªæ˜¯ä¸€ä¸ª javascript å¯¹è±¡ã€‚
è¿™ä¸ªå¯¹è±¡éœ€è¦æ˜¯å¯åºåˆ—åŒ–çš„ï¼Œæ›´å…·ä½“çš„æ˜¯ï¼Œå®ƒåº”è¯¥å¯ä»¥ JSON å­—ç¬¦ä¸²åŒ–ï¼Œå› ä¸ºè¿™æ˜¯å®ƒå°†å¦‚ä½•å­˜å‚¨åœ¨ Redisã€‚</p>
<p>ä¹Ÿå¯ä»¥åœ¨ä½œä¸šæ•°æ®ä¹‹åæä¾›ä¸€ä¸ª options å¯¹è±¡ï¼Œä½†æˆ‘ä»¬å°†åœ¨åé¢è®¨è®ºè¿™ä¸ªé—®é¢˜ã€‚</p>
<h3 id="æ¶ˆè´¹è€…">æ¶ˆè´¹è€…</h3>
<p>æ¶ˆè´¹è€…æˆ–å·¥ä½œè€…(æˆ‘ä»¬å°†åœ¨æœ¬æŒ‡å—ä¸­äº¤æ›¿ä½¿ç”¨è¿™ä¸¤ä¸ªæœ¯è¯­)åªä¸è¿‡æ˜¯ä¸€ä¸ª Node ç¨‹åº
å®ƒå®šä¹‰äº†åƒè¿™æ ·çš„è¿›ç¨‹å‡½æ•°:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">myFirstQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Bull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;my-first-queue&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">myFirstQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">doSomething</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>æ¯å½“å·¥ä½œçº¿ç¨‹å¤„äºç©ºé—²çŠ¶æ€ä¸”é˜Ÿåˆ—ä¸­æœ‰ä½œä¸šéœ€è¦å¤„ç†æ—¶ï¼Œ&rsquo; process &lsquo;å‡½æ•°å°±ä¼šè¢«è°ƒç”¨ã€‚
ç”±äºåœ¨æ·»åŠ ä½œä¸šæ—¶ï¼Œæ¶ˆè´¹è€…ä¸éœ€è¦åœ¨çº¿ï¼Œå› æ­¤é˜Ÿåˆ—ä¸­å¯èƒ½å·²ç»æœ‰è®¸å¤šä½œä¸šåœ¨ç­‰å¾…ï¼Œå› æ­¤è¿›ç¨‹å°†ä¿æŒå¿™ç¢Œï¼Œä¸€ä¸ªæ¥ä¸€ä¸ªåœ°å¤„ç†ä½œä¸šï¼Œç›´åˆ°æ‰€æœ‰ä½œä¸šéƒ½å®Œæˆã€‚</p>
<p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†è¿›ç¨‹å‡½æ•°å®šä¹‰ä¸º&rsquo; async &lsquo;ï¼Œè¿™æ˜¯å¼ºçƒˆæ¨èçš„å®šä¹‰å®ƒä»¬çš„æ–¹å¼ã€‚
å¦‚æœä½ çš„ Node è¿è¡Œæ—¶ä¸æ”¯æŒ async/awaitï¼Œé‚£ä¹ˆä½ å¯ä»¥åœ¨è¿›ç¨‹ç»“æŸæ—¶è¿”å›ä¸€ä¸ª promise
å‡½æ•°ï¼Œä»¥å¾—åˆ°ç±»ä¼¼çš„ç»“æœã€‚</p>
<p>è¿›ç¨‹å‡½æ•°è¿”å›çš„å€¼å°†å­˜å‚¨åœ¨ jobs å¯¹è±¡ä¸­ï¼Œç¨åå¯ä»¥è®¿é—®ï¼Œä¾‹å¦‚åœ¨â€œcompletedâ€äº‹ä»¶çš„ç›‘å¬å™¨ä¸­ã€‚</p>
<p>æœ‰æ—¶ä½ éœ€è¦å‘å¤–éƒ¨ç›‘å¬å™¨æä¾› job çš„<em>progress</em>ä¿¡æ¯ï¼Œè¿™å¯ä»¥é€šè¿‡åœ¨ job å¯¹è±¡ä¸Šä½¿ç”¨&rsquo; progress &lsquo;æ–¹æ³•è½»æ¾å®Œæˆ:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000">myFirstQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">progress</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">doSomething</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">progress</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">progress</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">progress</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><h3 id="ä¾¦å¬å™¨">ä¾¦å¬å™¨</h3>
<p>æœ€åï¼Œæ‚¨å¯ä»¥åªä¾¦å¬é˜Ÿåˆ—ä¸­å‘ç”Ÿçš„äº‹ä»¶ã€‚
ä¾¦å¬å™¨å¯ä»¥æ˜¯æœ¬åœ°çš„ï¼Œè¿™æ„å‘³ç€å®ƒä»¬åªæ¥æ”¶åœ¨<em>ç»™å®šé˜Ÿåˆ—å®ä¾‹</em>ä¸­äº§ç”Ÿçš„é€šçŸ¥ï¼Œä¹Ÿå¯ä»¥æ˜¯å…¨å±€çš„ï¼Œè¿™æ„å‘³ç€å®ƒä»¬ä¾¦å¬ç»™å®šé˜Ÿåˆ—çš„<em>æ‰€æœ‰</em>äº‹ä»¶ã€‚
å› æ­¤ï¼Œæ‚¨å¯ä»¥å°†ä¾¦å¬å™¨é™„åŠ åˆ°ä»»ä½•å®ä¾‹ï¼Œç”šè‡³å……å½“æ¶ˆè´¹è€…æˆ–ç”Ÿäº§è€…çš„å®ä¾‹ã€‚
ä½†æ˜¯è¯·æ³¨æ„ï¼Œå¦‚æœé˜Ÿåˆ—ä¸æ˜¯æ¶ˆè´¹è€…æˆ–ç”Ÿäº§è€…ï¼Œæœ¬åœ°äº‹ä»¶å°†æ°¸è¿œä¸ä¼šè§¦å‘ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å°†éœ€è¦ä½¿ç”¨å…¨å±€äº‹ä»¶ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">myFirstQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Bull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;my-first-queue&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Define a local completed event
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">myFirstQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;completed&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`Job completed with result </span><span style="color:#4e9a06">${</span><span style="color:#000">result</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><h3 id="ä¸€ä»½å·¥ä½œçš„ç”Ÿå‘½å‘¨æœŸ">ä¸€ä»½å·¥ä½œçš„ç”Ÿå‘½å‘¨æœŸ</h3>
<p>ä¸ºäº†å……åˆ†åˆ©ç”¨ Bull é˜Ÿåˆ—çš„æ½œåŠ›ï¼Œç†è§£ä½œä¸šçš„ç”Ÿå‘½å‘¨æœŸæ˜¯å¾ˆé‡è¦çš„ã€‚
ä»ç”Ÿäº§è€…å¯¹é˜Ÿåˆ—å®ä¾‹è°ƒç”¨â€œaddâ€æ–¹æ³•çš„é‚£ä¸€åˆ»èµ·ï¼Œä½œä¸šå°±è¿›å…¥äº†å®ƒéœ€è¦çš„ç”Ÿå‘½å‘¨æœŸ
å¤„äºä¸åŒçš„çŠ¶æ€ï¼Œç›´åˆ°å®ƒå®Œæˆæˆ–å¤±è´¥(å°½ç®¡æŠ€æœ¯ä¸Šå¤±è´¥çš„ä½œä¸šå¯ä»¥é‡è¯•å¹¶è·å¾—æ–°çš„ç”Ÿå‘½å‘¨æœŸ)ã€‚</p>
<p>æ˜¾ç¤ºä½œä¸šçŠ¶æ€çš„ç¤ºæ„å›¾(job-lifecycle.png)</p>
<p>å½“ä¸€ä¸ªä½œä¸šè¢«æ·»åŠ åˆ°ä¸€ä¸ªé˜Ÿåˆ—æ—¶ï¼Œå®ƒå¯ä»¥å¤„äºä¸¤ç§çŠ¶æ€ä¹‹ä¸€ï¼Œå®ƒå¯ä»¥å¤„äºâ€œç­‰å¾…â€çŠ¶æ€ï¼Œè¿™å®é™…ä¸Šæ˜¯ä¸€ä¸ªç­‰å¾…åˆ—è¡¨ï¼Œæ‰€æœ‰çš„ä½œä¸šéƒ½å¿…é¡»è¿›å…¥è¿™ä¸ªåˆ—è¡¨æ‰èƒ½è¢«å¤„ç†ï¼Œæˆ–è€…å®ƒå¯ä»¥å¤„äºâ€œå»¶è¿Ÿâ€çŠ¶æ€:å»¶è¿ŸçŠ¶æ€æ„å‘³ç€è¯¥ä½œä¸šæ­£åœ¨ç­‰å¾…è¶…æ—¶æˆ–ç­‰å¾…è¢«æå‡å¤„ç†ï¼Œä½†æ˜¯ï¼Œå»¶è¿Ÿçš„ä½œä¸šä¸ä¼šç›´æ¥è¢«å¤„ç†ï¼Œè€Œæ˜¯è¢«æ”¾ç½®åœ¨ç­‰å¾…åˆ—è¡¨çš„å¼€å¤´ï¼Œå½“ä¸€ä¸ª worker ç©ºé—²æ—¶å°±ä¼šè¢«å¤„ç†ã€‚</p>
<p>ä½œä¸šçš„ä¸‹ä¸€ä¸ªçŠ¶æ€æ˜¯â€œæ´»åŠ¨â€çŠ¶æ€ã€‚
æ´»åŠ¨çŠ¶æ€ç”±ä¸€ä¸ªé›†åˆè¡¨ç¤ºï¼Œæ˜¯å½“å‰æ­£åœ¨å¤„ç†çš„ä½œä¸šï¼Œå³ã€‚
å®ƒä»¬è¿è¡Œåœ¨ä¸Šä¸€ç« è§£é‡Šè¿‡çš„â€œprocessâ€å‡½æ•°ä¸­ã€‚
ä½œä¸šå¯ä»¥æ— é™é•¿æ—¶é—´å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œç›´åˆ°æµç¨‹å®Œæˆï¼Œæˆ–è€…æŠ›å‡ºå¼‚å¸¸ï¼Œä»¥ä¾¿ä½œä¸šä»¥â€œå®Œæˆâ€æˆ–â€œå¤±è´¥â€çŠ¶æ€ç»“æŸã€‚</p>
<h3 id="åœæ»ä¸å‰çš„å·¥ä½œ">åœæ»ä¸å‰çš„å·¥ä½œ</h3>
<p>åœ¨ Bull ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†åœæ»çš„å·¥ä½œçš„æ¦‚å¿µã€‚
åœæ»çš„ä½œä¸šæ˜¯æ­£åœ¨å¤„ç†çš„ä½œä¸šï¼Œä½† Bull æ€€ç–‘è¯¥ä½œä¸šçš„æµç¨‹åŠŸèƒ½å·²ç»æŒ‚èµ·ã€‚
è¿™ç§æƒ…å†µå‘ç”Ÿåœ¨è¿›ç¨‹å‡½æ•°æ­£åœ¨å¤„ç†ä¸€ä¸ªä»»åŠ¡ï¼Œå¹¶ä¸”ä½¿ CPU ä¸€ç›´å¤„äºç¹å¿™çŠ¶æ€ï¼Œä»¥è‡³äº worker æ— æ³•å‘Šè¯‰é˜Ÿåˆ—å®ƒä»ç„¶åœ¨å¤„ç†è¿™ä¸ªä»»åŠ¡ã€‚</p>
<p>å½“ä¸€ä¸ªä½œä¸šåœæ­¢æ—¶ï¼Œæ ¹æ®ä½œä¸šè®¾ç½®ï¼Œè¯¥ä½œä¸šå¯ä»¥ç”±å¦ä¸€ä¸ªç©ºé—²çš„ä½œä¸šé‡è¯•ï¼Œä¹Ÿå¯ä»¥è½¬ç§»åˆ°å¤±è´¥çŠ¶æ€ã€‚</p>
<p>å¯ä»¥é€šè¿‡ç¡®ä¿è¿›ç¨‹å‡½æ•°ä¸ä¼šè®© Node äº‹ä»¶å¾ªç¯å¤ªé•¿æ—¶é—´å¤„äºç¹å¿™çŠ¶æ€(Bull çš„é»˜è®¤é€‰é¡¹æ˜¯å‡ ç§’é’Ÿ)ï¼Œæˆ–è€…ä½¿ç”¨å•ç‹¬çš„[sandbox -processors](#sandbox -processors)æ¥é¿å…é™·å…¥åœé¡¿çš„ä½œä¸šã€‚</p>
<h2 id="äº‹ä»¶">äº‹ä»¶</h2>
<p>Bull ä¸­çš„é˜Ÿåˆ—ç”Ÿæˆä¸€äº›äº‹ä»¶ï¼Œè¿™äº›äº‹ä»¶åœ¨è®¸å¤šç”¨ä¾‹ä¸­éƒ½å¾ˆæœ‰ç”¨ã€‚
å¯¹äºç»™å®šçš„é˜Ÿåˆ—å®ä¾‹(ä¸€ä¸ª worker)ï¼Œäº‹ä»¶å¯ä»¥æ˜¯æœ¬åœ°çš„ï¼Œä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªä»»åŠ¡åœ¨ä¸€ä¸ªç»™å®šçš„ worker ä¸­å®Œæˆäº†ï¼Œåˆ™åªä¼šé’ˆå¯¹è¯¥å®ä¾‹å‘å‡ºæœ¬åœ°äº‹ä»¶ã€‚
ä½†æ˜¯ï¼Œå¯ä»¥é€šè¿‡åœ¨æœ¬åœ°äº‹ä»¶åç§°å‰åŠ ä¸Š&rsquo; global: &lsquo;æ¥ä¾¦å¬æ‰€æœ‰äº‹ä»¶ã€‚
ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥ä¾¦å¬ç»™å®šé˜Ÿåˆ—ä¸­æ‰€æœ‰å·¥äººäº§ç”Ÿçš„æ‰€æœ‰äº‹ä»¶ã€‚</p>
<p>æœ¬åœ°å®Œæ•´äº‹ä»¶:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;completed&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`Job with id </span><span style="color:#4e9a06">${</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> has been completed`</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>è€Œäº‹ä»¶çš„å…¨çƒç‰ˆæœ¬å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ¥æ”¶å¬:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;global:completed&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">jobId</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`Job with id </span><span style="color:#4e9a06">${</span><span style="color:#000">jobId</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> has been completed`</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>è¯·æ³¨æ„ï¼Œå…¨å±€äº‹ä»¶çš„ç­¾åä¸æœ¬åœ°äº‹ä»¶çš„ç­¾åç•¥æœ‰ä¸åŒï¼Œåœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œå®ƒåªå‘é€ä½œä¸š idï¼Œè€Œä¸æ˜¯ä½œä¸šæœ¬èº«çš„å®Œæ•´å®ä¾‹ï¼Œè¿™æ ·åšæ˜¯å‡ºäºæ€§èƒ½åŸå› ã€‚</p>
<p>å¯ç”¨äº‹ä»¶çš„åˆ—è¡¨å¯ä»¥åœ¨<a href="https://github.com/OptimalBits/bull/blob/master/REFERENCE.md#eventsk">reference</a>ä¸­æ‰¾åˆ°ã€‚</p>
<h2 id="é˜Ÿåˆ—çš„é€‰é¡¹">é˜Ÿåˆ—çš„é€‰é¡¹</h2>
<p>ä¸€ä¸ªé˜Ÿåˆ—å¯ä»¥å®ä¾‹åŒ–ä¸€äº›æœ‰ç”¨çš„é€‰é¡¹ï¼Œä¾‹å¦‚ï¼Œä½ å¯ä»¥æŒ‡å®šä½ çš„ Redis æœåŠ¡å™¨çš„ä½ç½®å’Œå¯†ç ï¼Œä»¥åŠå…¶ä»–ä¸€äº›æœ‰ç”¨çš„è®¾ç½®ã€‚
æ‰€æœ‰è¿™äº›è®¾ç½®åœ¨ Bull çš„<a href="https://github.com/OptimalBits/bull/blob/master/REFERENCE.md#queue">å‚è€ƒæ–‡çŒ®</a>ä¸­éƒ½æœ‰æè¿°ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œä¸é‡å¤å®ƒä»¬ï¼Œä½†æ˜¯ï¼Œæˆ‘ä»¬å°†è®¨è®ºä¸€äº›ç”¨ä¾‹ã€‚</p>
<h3 id="é€Ÿåº¦é™åˆ¶å™¨">é€Ÿåº¦é™åˆ¶å™¨</h3>
<p>å¯ä»¥åˆ›å»ºé™åˆ¶å•ä½æ—¶é—´å†…å¤„ç†çš„ä½œä¸šæ•°é‡çš„é˜Ÿåˆ—ã€‚
é™åˆ¶å™¨æ˜¯åœ¨æ¯ä¸ªé˜Ÿåˆ—ä¸­å®šä¹‰çš„ï¼Œä¸ worker çš„æ•°é‡æ— å…³ï¼Œæ‰€ä»¥ä½ å¯ä»¥æ°´å¹³æ‰©å±•ï¼Œå¹¶ä¸”ä»ç„¶å¯ä»¥è½»æ¾åœ°é™åˆ¶å¤„ç†é€Ÿç‡:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Limit queue to max 1000 jobs per 5000 milliseconds.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">myRateLimitedQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;rateLimited&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">limiter</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">max</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">duration</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">5000</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>å½“é˜Ÿåˆ—è¾¾åˆ°é€Ÿç‡é™åˆ¶æ—¶ï¼Œè¯·æ±‚çš„ä½œä¸šå°†åŠ å…¥â€œå»¶è¿Ÿâ€é˜Ÿåˆ—ã€‚</p>
<h3 id="å‘½åå·¥ä½œ">å‘½åå·¥ä½œ</h3>
<p>ç»™å·¥ä½œèµ·åå­—æ˜¯å¯èƒ½çš„ã€‚
è¿™ä¸ä¼šæ”¹å˜é˜Ÿåˆ—çš„ä»»ä½•æœºåˆ¶ï¼Œä½†å¯ä»¥åœ¨ UI å·¥å…·ä¸­ç”¨äºæ›´æ¸…æ™°çš„ä»£ç å’Œæ›´å¥½çš„å¯è§†åŒ–:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Jobs producer
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">myJob</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">transcoderQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;image&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">input</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;myimagefile&#34;</span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">myJob</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">transcoderQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;audio&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">input</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;myaudiofile&#34;</span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">myJob</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">transcoderQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;video&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">input</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;myvideofile&#34;</span> <span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Worker
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">transcoderQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;image&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">processImage</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">transcoderQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;audio&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">processAudio</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">transcoderQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;video&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">processVideo</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>è¯·è®°ä½ï¼Œæ¯ä¸ªé˜Ÿåˆ—å®ä¾‹éƒ½éœ€è¦ä¸ºæ¯ä¸ª<em>æŒ‡å®š</em>ä½œä¸šæä¾›ä¸€ä¸ªå¤„ç†å™¨ï¼Œå¦åˆ™å°†ä¼šå‡ºç°å¼‚å¸¸ã€‚</p>
<h3 id="æ²™ç®±å¤„ç†å™¨">æ²™ç®±å¤„ç†å™¨</h3>
<p>å¦‚ä¸Šæ‰€è¿°ï¼Œåœ¨å®šä¹‰æµç¨‹åŠŸèƒ½æ—¶ï¼Œè¿˜å¯ä»¥æä¾›å¹¶å‘è®¾ç½®ã€‚
æ­¤è®¾ç½®å…è®¸å·¥ä½œè€…å¹¶è¡Œå¤„ç†å¤šä¸ªä½œä¸šã€‚
è¿™äº›ä½œä¸šä»ç„¶åœ¨åŒä¸€ä¸ª Node è¿›ç¨‹ä¸­å¤„ç†ï¼Œå¦‚æœä½œä¸šçš„ IO å¯†é›†ï¼Œå®ƒä»¬å°†å¾—åˆ°å¾ˆå¥½çš„å¤„ç†ã€‚</p>
<p>æœ‰æ—¶ï¼Œä½œä¸šçš„ CPU å ç”¨æ›´å¤§ï¼Œè¿™å¯èƒ½ä¼šé”å®š Node äº‹ä»¶å¾ªç¯å¤ªé•¿æ—¶é—´ï¼ŒBull å¯èƒ½ä¼šè®¤ä¸ºä½œä¸šå·²ç»æš‚åœã€‚
ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œå¯ä»¥åœ¨å•ç‹¬çš„ Node è¿›ç¨‹ä¸­è¿è¡Œè¿›ç¨‹å‡½æ•°ã€‚
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¹¶å‘æ€§å‚æ•°å°†å†³å®šå…è®¸è¿è¡Œçš„æœ€å¤§å¹¶å‘è¿›ç¨‹æ•°ã€‚</p>
<p>æˆ‘ä»¬ç§°è¿™ç§è¿›ç¨‹ä¸ºâ€œæ²™ç®±â€è¿›ç¨‹ï¼Œå®ƒä»¬ä¹Ÿæœ‰è¿™æ ·çš„å±æ€§:å¦‚æœå´©æºƒï¼Œå®ƒä»¬ä¸ä¼šå½±å“ä»»ä½•å…¶ä»–è¿›ç¨‹ï¼Œå¹¶ä¸”ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªæ–°è¿›ç¨‹æ¥æ›¿æ¢å®ƒã€‚</p>
<h2 id="ä½œä¸šç±»å‹">ä½œä¸šç±»å‹</h2>
<p>Bull ä¸­çš„é»˜è®¤ä½œä¸šç±»å‹æ˜¯â€œFIFOâ€(å…ˆè¿›å…ˆå‡º)ï¼Œè¿™æ„å‘³ç€ä½œä¸šçš„å¤„ç†é¡ºåºä¸è¿›å…¥é˜Ÿåˆ—çš„é¡ºåºç›¸åŒã€‚
æœ‰æ—¶ï¼Œä»¥ä¸åŒçš„é¡ºåºå¤„ç†ä½œä¸šæ˜¯æœ‰ç”¨çš„ã€‚</p>
<h3 id="lifo">LIFO</h3>
<p>åè¿›å…ˆå‡º(LIFO)æ„å‘³ç€ä½œä¸šè¢«æ·»åŠ åˆ°é˜Ÿåˆ—çš„å¼€å¤´ï¼Œå› æ­¤å½“ worker ç©ºé—²æ—¶å°±ä¼šè¢«å¤„ç†ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">myJob</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">myqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;bar&#34;</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">lifo</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><h3 id="å»¶è¿Ÿ">å»¶è¿Ÿ</h3>
<p>è¿˜å¯ä»¥å°†ä½œä¸šæ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ï¼Œè¿™äº›ä½œä¸šåœ¨è¢«å¤„ç†ä¹‹å‰ä¼šå»¶è¿Ÿä¸€å®šçš„æ—¶é—´ã€‚
æ³¨æ„ï¼Œdelay å‚æ•°è¡¨ç¤ºä½œä¸šåœ¨è¢«å¤„ç†ä¹‹å‰ç­‰å¾…çš„æœ€å°æ—¶é—´ã€‚
å½“å»¶è¿Ÿæ—¶é—´è¿‡å»åï¼Œä½œä¸šå°†è¢«ç§»åŠ¨åˆ°é˜Ÿåˆ—çš„å¼€å¤´ï¼Œå¹¶åœ¨ä¸€ä¸ª worker ç©ºé—²æ—¶ç«‹å³å¤„ç†ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Delayed 5 seconds
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">myJob</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">myqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;bar&#34;</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">delay</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">5000</span> <span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><h3 id="ä¼˜å…ˆ">ä¼˜å…ˆ</h3>
<p>å¯ä»¥å°†ä½œä¸šæ·»åŠ åˆ°å…·æœ‰ä¼˜å…ˆçº§å€¼çš„é˜Ÿåˆ—ä¸­ã€‚
ä¼˜å…ˆçº§é«˜çš„ä½œä¸šå°†æ¯”ä¼˜å…ˆçº§ä½çš„ä½œä¸šä¼˜å…ˆå¤„ç†ã€‚
æœ€é«˜ä¼˜å…ˆçº§ä¸º 1ï¼Œå¹¶é™ä½æ‰€ä½¿ç”¨çš„è¾ƒå¤§æ•´æ•°ã€‚
è¯·è®°ä½ï¼Œä¼˜å…ˆçº§é˜Ÿåˆ—æ¯”æ ‡å‡†é˜Ÿåˆ—ç¨æ…¢(å½“å‰æ’å…¥æ—¶é—´ä¸º O(n)ï¼Œ n æ˜¯å½“å‰åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…çš„ä½œä¸šæ•°é‡ï¼Œè€Œæ ‡å‡†é˜Ÿåˆ—ä¸º O(1))ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">myJob</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">myqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;bar&#34;</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">priority</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><h3 id="å¯é‡å¤çš„">å¯é‡å¤çš„</h3>
<p>å¯é‡å¤ä½œä¸šæ˜¯ä¸€ç§ç‰¹æ®Šä½œä¸šï¼Œå¯ä»¥æ ¹æ® cron è§„èŒƒæˆ–æ—¶é—´é—´éš”æ— é™æœŸåœ°é‡å¤è‡ªå·±ï¼Œæˆ–è€…ç›´åˆ°è¾¾åˆ°ä¸€ä¸ªç»™å®šçš„æœ€å¤§æ—¥æœŸæˆ–é‡å¤æ¬¡æ•°ä¸ºæ­¢ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Repeat every 10 seconds for 100 times.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">myJob</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">myqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;bar&#34;</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">repeat</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">every</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">limit</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Repeat payment job once every day at 3:15 (am)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">paymentsQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">paymentsData</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">repeat</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">cron</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;15 3 * * *&#34;</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>å…³äºå¯é‡å¤å·¥ä½œæœ‰ä¸€äº›é‡è¦çš„è€ƒè™‘:</p>
<ul>
<li>å¦‚æœé‡å¤é€‰é¡¹ç›¸åŒï¼ŒBull è¶³å¤Ÿèªæ˜ï¼Œä¸ä¼šæ·»åŠ ç›¸åŒçš„å¯é‡å¤ä½œä¸šã€‚
(æ³¨æ„:ä½œä¸š id æ˜¯é‡å¤é€‰é¡¹çš„ä¸€éƒ¨åˆ†ï¼Œå› ä¸º:https://github.com/OptimalBits/bull/pull/603ï¼Œå› æ­¤ä¼ é€’ä½œä¸šidå°†å…è®¸åœ¨é˜Ÿåˆ—ä¸­æ’å…¥å…·æœ‰ç›¸åŒcronçš„ä½œä¸š)</li>
<li>å¦‚æœæ²¡æœ‰å·¥äººåœ¨è¿è¡Œï¼Œé‚£ä¹ˆä¸‹ä¸€æ¬¡å·¥äººåœ¨çº¿æ—¶ï¼Œå¯é‡å¤çš„å·¥ä½œå°†ä¸ä¼šç´¯ç§¯ã€‚</li>
<li>å¯ä»¥ä½¿ç”¨<a href="https://github.com/OptimalBits/bull/blob/master/REFERENCE.md#queueremoverepeatable">removeRepeatable</a>æ–¹æ³•åˆ é™¤å¯é‡å¤çš„ä½œä¸šã€‚</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b2b86a8b70578d701ade6f6cd94fede2">3 - å‚è€ƒ</h1>
    
	<ul>
<li><a href="#%E9%98%9F%E5%88%97">é˜Ÿåˆ—</a>
<ul>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%88%96%E5%85%B1%E4%BA%AB-ioredis-%E8%BF%9E%E6%8E%A5">è‡ªå®šä¹‰æˆ–å…±äº« IORedis è¿æ¥</a></li>
<li><a href="#%E9%AB%98%E7%BA%A7%E8%AE%BE%E7%BD%AE">é«˜çº§è®¾ç½®</a></li>
<li><a href="#queueprocess">Queue#process</a></li>
<li><a href="#queueadd">Queue#add</a>
<ul>
<li><a href="#keepjobs-%E9%80%89%E9%A1%B9">KeepJobs é€‰é¡¹</a></li>
<li><a href="#%E8%B6%85%E6%97%B6%E7%9A%84%E5%AE%9E%E7%8E%B0">è¶…æ—¶çš„å®ç°</a></li>
<li><a href="#%E9%87%8D%E5%A4%8D%E7%9A%84%E5%B7%A5%E4%BD%9C%E7%BB%86%E8%8A%82">é‡å¤çš„å·¥ä½œç»†èŠ‚</a></li>
<li><a href="#%E8%A1%A5%E5%81%BF%E9%80%89%E9%A1%B9">è¡¥å¿é€‰é¡¹</a></li>
</ul>
</li>
<li><a href="#queueaddbulk">Queue#addBulk</a></li>
<li><a href="#queuepause">Queue#pause</a></li>
<li><a href="#queueispaused">Queue#isPaused</a></li>
<li><a href="#queueresume">Queue#resume</a></li>
<li><a href="#queuewhencurrentjobsfinished">Queue#whenCurrentJobsFinished</a></li>
<li><a href="#queuecount">Queue#count</a></li>
<li><a href="#queueremovejobs">Queue#removeJobs</a></li>
<li><a href="#queueempty">Queue#empty</a></li>
<li><a href="#queueclose">Queue#close</a></li>
<li><a href="#queuegetjob">Queue#getJob</a></li>
<li><a href="#queuegetjobs">Queue#getJobs</a></li>
<li><a href="#queuegetjoblogs">Queue#getJobLogs</a></li>
<li><a href="#queuegetrepeatablejobs">Queue#getRepeatableJobs</a></li>
<li><a href="#queueremoverepeatable">Queue#removeRepeatable</a></li>
<li><a href="#queueremoverepeatablebykey">Queue#removeRepeatableByKey</a></li>
<li><a href="#queuegetjobcounts">Queue#getJobCounts</a></li>
<li><a href="#queuegetcompletedcount">Queue#getCompletedCount</a></li>
<li><a href="#queuegetfailedcount">Queue#getFailedCount</a></li>
<li><a href="#queuegetdelayedcount">Queue#getDelayedCount</a></li>
<li><a href="#queuegetactivecount">Queue#getActiveCount</a></li>
<li><a href="#queuegetwaitingcount">Queue#getWaitingCount</a></li>
<li><a href="#queuegetpausedcount">Queue#getPausedCount</a></li>
<li><a href="#getters">Getters</a></li>
<li><a href="#queuegetwaiting">Queue#getWaiting</a></li>
<li><a href="#queuegetactive">Queue#getActive</a></li>
<li><a href="#queuegetdelayed">Queue#getDelayed</a></li>
<li><a href="#queuegetcompleted">Queue#getCompleted</a></li>
<li><a href="#queuegetfailed">Queue#getFailed</a></li>
<li><a href="#queuegetworkers">Queue#getWorkers</a></li>
<li><a href="#queuegetmetrics">Queue#getMetrics</a></li>
<li><a href="#queueclean">Queue#clean</a>
<ul>
<li><a href="#example">Example</a></li>
</ul>
</li>
<li><a href="#queueobliterate">Queue#obliterate</a>
<ul>
<li><a href="#%E7%A4%BA%E4%BE%8B">ç¤ºä¾‹</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E5%B7%A5%E4%BD%9C">å·¥ä½œ</a>
<ul>
<li><a href="#jobprogress">Job#progress</a>
<ul>
<li><a href="#arguments">Arguments</a></li>
</ul>
</li>
<li><a href="#joblog">Job#log</a></li>
<li><a href="#jobgetstate">Job#getState</a></li>
<li><a href="#jobupdate">Job#update</a></li>
<li><a href="#jobremove">Job#remove</a></li>
<li><a href="#jobretry">Job#retry</a></li>
<li><a href="#jobdiscard">Job#discard</a></li>
<li><a href="#jobpromote">Job#promote</a></li>
<li><a href="#jobfinished">Job#finished</a></li>
<li><a href="#jobmovetocompleted">Job#moveToCompleted</a></li>
<li><a href="#jobmovetofailed">Job#moveToFailed</a></li>
</ul>
</li>
<li><a href="#%E6%B4%BB%E5%8A%A8">æ´»åŠ¨</a>
<ul>
<li><a href="#%E5%85%A8%E5%B1%80%E4%BA%8B%E4%BB%B6">å…¨å±€äº‹ä»¶</a></li>
</ul>
</li>
</ul>
<h2 id="é˜Ÿåˆ—">é˜Ÿåˆ—</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">queueName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">url?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">opts?</span>: <span style="color:#204a87;font-weight:bold">QueueOptions</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Queue</span>
</span></span></code></pre></div><p>è¿™æ˜¯ Queue æ„é€ å‡½æ•°ã€‚
å®ƒåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ Queue æŒä¹…åŒ–åœ¨ Redis ä¸­ã€‚
æ¯æ¬¡å®ä¾‹åŒ–åŒä¸€ä¸ªé˜Ÿåˆ—æ—¶ï¼Œå®ƒéƒ½ä¼šå°è¯•å¤„ç†ä»¥å‰æœªå®Œæˆä¼šè¯ä¸­å¯èƒ½å­˜åœ¨çš„æ‰€æœ‰æ—§ä½œä¸šã€‚</p>
<p>å¯é€‰çš„ <code>url</code> å‚æ•°ï¼Œå…è®¸æŒ‡å®šä¸€ä¸ª redis è¿æ¥å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚: <code>redis://mypassword@myredis.server.com:1234</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">QueueOptions</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">createClient</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;client&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;subscriber&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;bclient&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config?</span>: <span style="color:#204a87;font-weight:bold">Redis.RedisOptions</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Redis</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Cluster</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">limiter?</span>: <span style="color:#204a87;font-weight:bold">RateLimiter</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">redis?</span>: <span style="color:#204a87;font-weight:bold">RedisOpts</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">prefix?</span>: <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;bull&#34;</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// prefix for all queue keys.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">metrics?</span>: <span style="color:#204a87;font-weight:bold">MetricsOpts</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Configure metrics
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">defaultJobOptions?</span>: <span style="color:#204a87;font-weight:bold">JobOpts</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">settings?</span>: <span style="color:#204a87;font-weight:bold">AdvancedSettings</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">MetricsOpts</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">maxDataPoints?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">//  Max number of data points to collect, granularity is fixed at one minute.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">RateLimiter</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">max</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Max number of jobs processed
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">duration</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// per duration in milliseconds
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">bounceBack?</span>: <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// When jobs get rate limited, they stay in the waiting queue and are not moved to the delayed queue
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">groupKey?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// allows grouping of jobs with the specified key from the data object passed to the Queue#add (ex.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#4e9a06">&#34;network.handle&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>RedisOpts</code> ç›´æ¥ä¼ é€’ç»™ ioredis æ„é€ å‡½æ•°ï¼Œè¯·æŸ¥çœ‹<a href="https://github.com/luin/ioredis/blob/master/API.md">ioredis</a>äº†è§£è¯¦ç»†ä¿¡æ¯ã€‚
æˆ‘ä»¬åœ¨è¿™é‡Œåªè®°å½•æœ€é‡è¦çš„ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">RedisOpts</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">port?</span>: <span style="color:#204a87;font-weight:bold">number</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">6379</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">host?</span>: <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">localhost</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">db?</span>: <span style="color:#204a87;font-weight:bold">number</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">password?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">AdvancedSettings</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">lockDuration</span>: <span style="color:#204a87;font-weight:bold">number</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">30000</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Key expiration time for job locks.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">lockRenewTime</span>: <span style="color:#204a87;font-weight:bold">number</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">15000</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Interval on which to acquire the job lock
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">stalledInterval</span>: <span style="color:#204a87;font-weight:bold">number</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">30000</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// How often check for stalled jobs (use 0 for never checking).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">maxStalledCount</span>: <span style="color:#204a87;font-weight:bold">number</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Max amount of times a stalled job will be re-processed.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">guardInterval</span>: <span style="color:#204a87;font-weight:bold">number</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5000</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Poll interval for delayed jobs and added jobs.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">retryProcessDelay</span>: <span style="color:#204a87;font-weight:bold">number</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5000</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// delay before processing next job in case of internal error.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">backoffStrategies</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{};</span> <span style="color:#8f5902;font-style:italic">// A set of custom backoff strategies keyed by name.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">drainDelay</span>: <span style="color:#204a87;font-weight:bold">number</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// A timeout for when the queue is in drained state (empty waiting for jobs).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">isSharedChildPool</span>: <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// enables multiple queues on the same instance of child pool to share the same instance.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h4 id="è‡ªå®šä¹‰æˆ–å…±äº«-ioredis-è¿æ¥">è‡ªå®šä¹‰æˆ–å…±äº« IORedis è¿æ¥</h4>
<p><code>createClient</code> è¢«ä¼ é€’ä¸€ä¸ª <code>type</code> æ¥æŒ‡å®š Bull è¯•å›¾åˆ›å»ºçš„è¿æ¥çš„ç±»å‹ï¼Œä»¥åŠ <code>Bull</code> æƒ³è¦ä¸ºè¯¥è¿æ¥è®¾ç½®çš„ä¸€äº›é€‰é¡¹ã€‚</p>
<p>æ‚¨å¯ä»¥å°†æä¾›çš„é€‰é¡¹ä¸æ‚¨è‡ªå·±çš„ä¸€äº›é€‰é¡¹åˆå¹¶ï¼Œå¹¶åˆ›å»ºä¸€ä¸ª <code>ioredis</code> è¿æ¥ã€‚</p>
<p>å½“ type ä¸º <code>client</code> æˆ– <code>subscriber</code> æ—¶ï¼Œä½ å¯ä»¥ä¸ºå¤šä¸ªé˜Ÿåˆ—è¿”å›ç›¸åŒçš„è¿æ¥ï¼Œè¿™å¯ä»¥å‡å°‘ä½ æ‰“å¼€åˆ° redis æœåŠ¡å™¨çš„è¿æ¥æ•°ã€‚
å½“é˜Ÿåˆ—å…³é—­æ—¶ï¼ŒBull ä¸ä¼šå…³é—­æˆ–æ–­å¼€è¿™äº›è¿æ¥ï¼Œæ‰€ä»¥å¦‚æœä½ éœ€è¦è®©ä½ çš„åº”ç”¨ç¨‹åºåšä¸€ä¸ªä¼˜é›…çš„å…³é—­ï¼Œä½ éœ€è¦ä¿ç•™å¯¹è¿™äº›è¿æ¥çš„å¼•ç”¨
Redis åœ¨æŸä¸ªåœ°æ–¹è¿æ¥ï¼Œå¹¶åœ¨å…³é—­æ‰€æœ‰é˜Ÿåˆ—åæ–­å¼€è¿æ¥ã€‚</p>
<p>ç„¶è€Œï¼Œ <code>bclient</code> è¿æ¥æ˜¯ä¸€ä¸ª <code>é˜»å¡å®¢æˆ·ç«¯</code> ï¼Œç”¨äºæ¯æ¬¡ç­‰å¾…å•ä¸ªé˜Ÿåˆ—ä¸Šçš„æ–°ä½œä¸šã€‚
å› æ­¤ï¼Œå®ƒä¸èƒ½è¢«å…±äº«ï¼Œæ¯æ¬¡éƒ½åº”è¯¥è¿”å›ä¸€ä¸ªæ–°çš„è¿æ¥ã€‚</p>
<h4 id="é«˜çº§è®¾ç½®">é«˜çº§è®¾ç½®</h4>
<p><strong>è­¦å‘Š:</strong> ä¸è¦è¦†ç›–è¿™äº›é«˜çº§è®¾ç½®ï¼Œé™¤éä½ äº†è§£é˜Ÿåˆ—çš„å†…éƒ¨ã€‚</p>
<p><code>lockDuration</code> :è·å–ä½œä¸šé”çš„æ—¶é—´ï¼Œä»¥æ¯«ç§’ä¸ºå•ä½ã€‚
å¦‚æœæ‚¨å‘ç°æ‚¨çš„ä½œä¸šå› ä¸ºæ‚¨çš„ä½œä¸šå¤„ç†å™¨æ˜¯ cpu å¯†é›†å‹çš„å¹¶ä¸”é˜»å¡äº†äº‹ä»¶å¾ªç¯è€Œè¢«æš‚åœï¼Œé‚£ä¹ˆå°†è¿™ä¸ªå€¼è®¾ç½®ä¸ºä¸€ä¸ªæ›´é«˜çš„å€¼(è¯·å‚é˜…ä¸‹é¢å…³äºæš‚åœä½œä¸šçš„è¯´æ˜)ã€‚
å¦‚æœæ‚¨çš„ä½œä¸šå¯¹æ—¶é—´éå¸¸æ•æ„Ÿï¼Œåˆ™å°†æ­¤å€¼è®¾ç½®ä¸ºè¾ƒä½çš„å€¼ï¼Œå¹¶ä¸”å¦‚æœå®ƒä»¬è¢«é‡å¤å¤„ç†(å› ä¸ºå®ƒä»¬è¢«é”™è¯¯åœ°è®¤ä¸ºæ˜¯æš‚åœçš„)ï¼Œåˆ™æ­¤å€¼å¯èƒ½æ˜¯å¯ä»¥çš„ã€‚</p>
<p><code>lockRenewTime</code> :ä»¥æ¯«ç§’ä¸ºå•ä½çš„è·å–ä½œä¸šé”çš„æ—¶é—´é—´éš”ã€‚
é»˜è®¤è®¾ç½®ä¸º <code>lockDuration / 2</code> ï¼Œä»¥ä¾¿åœ¨æ¯æ¬¡ä½œä¸šé”åˆ°æœŸå‰æä¾›è¶³å¤Ÿçš„ç¼“å†²åŒºæ¥æ›´æ–°é”ã€‚
å®ƒä¸åº”è¯¥è®¾ç½®å¤§äº <code>lockDuration</code> çš„å€¼ã€‚
å¦‚æœå‘ç°ä½œä¸šç”±äº cpu å¯†é›†å‹ä½œä¸šå¤„ç†å™¨åŠŸèƒ½è€Œé™·å…¥åœé¡¿ï¼Œåˆ™å°†æ­¤å€¼è®¾ç½®ä¸ºè¾ƒä½çš„å€¼ã€‚
ä¸è¿‡ä¸€èˆ¬æ¥è¯´ï¼Œä½ ä¸åº”è¯¥æ”¹å˜è¿™ä¸ªã€‚</p>
<p><code>stalledInterval</code> :ä»¥æ¯«ç§’ä¸ºå•ä½çš„æ—¶é—´é—´éš”ï¼Œæ¯ä¸ª worker å°†åœ¨æ­¤æ—¶é—´é—´éš”å†…æ£€æŸ¥æš‚åœçš„ä½œä¸š(ä¾‹å¦‚:
å¤„äº <code>æ´»åŠ¨</code> çŠ¶æ€çš„æœªé”å®šä½œä¸š)ã€‚
è§ä¸‹é¢å…³äºåœæ»çš„å·¥ä½œçš„è¯´æ˜ã€‚
å¦‚æœæ‚¨çš„ä½œä¸šå¯¹æ—¶é—´éå¸¸æ•æ„Ÿï¼Œè¯·å°†æ­¤å€¼è®¾ç½®ä¸ºè¾ƒä½çš„å€¼ã€‚
å¦‚æœä½ çš„ Redis CPU ä½¿ç”¨ç‡å¾ˆé«˜ï¼Œè®¾ç½®ä¸€ä¸ªæ›´é«˜çš„å€¼ï¼Œå› ä¸ºè¿™ä¸ªæ£€æŸ¥å¯èƒ½ä¼šå¾ˆæ˜‚è´µã€‚
è¯·æ³¨æ„ï¼Œå› ä¸ºæ¯ä¸ª worker éƒ½åœ¨è‡ªå·±çš„æ—¶é—´é—´éš”å†…è¿è¡Œå®ƒï¼Œå¹¶æ£€æŸ¥æ•´ä¸ªé˜Ÿåˆ—ï¼Œæ‰€ä»¥è¢«æš‚åœçš„ä½œä¸šå®é™…è¿è¡Œçš„é¢‘ç‡è¦æ¯”è¿™ä¸ªå€¼æ‰€æš—ç¤ºçš„é«˜å¾—å¤šã€‚</p>
<p><code>maxStalledCount</code> :åœ¨å‡ºç° <code>ä½œä¸šåœæ­¢è¶…è¿‡å…è®¸é™åˆ¶</code> é”™è¯¯è€Œå¯¼è‡´ä½œä¸šæ°¸ä¹…å¤±è´¥ä¹‹å‰ï¼Œä½œä¸šå¯ä»¥é‡æ–°å¯åŠ¨çš„æœ€å¤§æ¬¡æ•°ã€‚
è¿™è¢«è®¾ç½®ä¸ºé»˜è®¤å€¼ <code>1</code> ï¼Œå‡è®¾æš‚åœçš„ä½œä¸šéå¸¸ç½•è§(åªç”±äºè¿›ç¨‹å´©æºƒ)ï¼Œå¹¶ä¸”æ‚¨å¸Œæœ›æ›´å®‰å…¨ä¸€ç‚¹ï¼Œä¸è¦é‡æ–°å¯åŠ¨ä½œä¸šã€‚
å¦‚æœä½œä¸šç»å¸¸å®•æœº(ä¾‹å¦‚è¿›ç¨‹ç»å¸¸å´©æºƒ)ï¼Œåˆ™è®¾ç½®æ›´é«˜çš„å€¼ï¼Œè¿™æ ·å°±å¯ä»¥å°†å¤„ç†ä½œä¸šåŠ å€ã€‚</p>
<p><code>guardInterval</code> :å»¶è¿Ÿä½œä¸š watchdog è¿è¡Œçš„æ—¶é—´é—´éš”(ä»¥æ¯«ç§’ä¸ºå•ä½)ã€‚
å½“è¿è¡Œå¤šä¸ªå…·æœ‰å»¶è¿Ÿä»»åŠ¡çš„å¹¶å‘ worker æ—¶ï¼Œ <code>guardInterval</code> çš„é»˜è®¤å€¼ä¼šå¯¼è‡´ç½‘ç»œå¸¦å®½ã€cpu å ç”¨ç‡å’Œå†…å­˜å ç”¨ç‡å‡ºç°å³°å€¼ã€‚
æ¯ä¸ªå¹¶å‘çš„å·¥äººå°†è¿è¡Œå»¶è¿Ÿçš„å·¥ä½œç›‘ç£ç¨‹åºã€‚
åœ¨æœ¬ä¾‹ä¸­ï¼Œå°†è¯¥å€¼è®¾ç½®ä¸ºæ›´é«˜çš„å€¼ã€‚ <code>guardInterval = numberOfWorkers * 5000</code> ã€‚
è®¾ç½®ä¸€ä¸ªè¾ƒä½çš„å€¼ï¼Œå¦‚æœä½ çš„ Redis è¿æ¥ä¸ç¨³å®šï¼Œå»¶è¿Ÿçš„å·¥ä½œæ²¡æœ‰è¢«åŠæ—¶å¤„ç†ã€‚</p>
<p><code>retryProcessDelay</code> :åœ¨é‡åˆ° Redis é”™è¯¯æ—¶ï¼Œåœ¨å°è¯•å¤„ç†ä»»åŠ¡ä¹‹å‰ç­‰å¾…çš„æ—¶é—´(ä»¥æ¯«ç§’ä¸ºå•ä½)ã€‚
åœ¨ä¸ç¨³å®šçš„ Redis è¿æ¥ä¸Šè®¾ç½®ä¸€ä¸ªè¾ƒä½çš„å€¼ã€‚</p>
<p><code>backoffStrategies</code> :ä¸€ä¸ªåŒ…å«è‡ªå®šä¹‰ backoffStrategies çš„å¯¹è±¡ã€‚
å¯¹è±¡ä¸­çš„é”®æ˜¯ç­–ç•¥çš„åç§°ï¼Œå€¼æ˜¯åº”è¯¥è¿”å›ä»¥æ¯«ç§’ä¸ºå•ä½çš„å»¶è¿Ÿçš„å‡½æ•°ã€‚
å®Œæ•´çš„ä¾‹å­å‚è§[Patterns](./ Patterns .md#custom-backoff-strategy)ã€‚</p>
<p><code>drainDelay</code> :é˜Ÿåˆ—å¤„äº <code>drain</code> çŠ¶æ€(ç©ºç­‰å¾…ä½œä¸š)æ—¶çš„è¶…æ—¶ã€‚
å®ƒåœ¨è°ƒç”¨ <code>queue.getNextJob()</code> æ—¶ä½¿ç”¨ï¼Œå®ƒå°†æŠŠå®ƒä¼ é€’ç»™<code>ã€‚brpoplpush</code> åœ¨ Redis å®¢æˆ·ç«¯ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000">backoffStrategies</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">jitter</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">5000</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87">Math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">random</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">500</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><hr>
<h3 id="queueprocess">Queue#process</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * å¯ä»¥å°†è¿™äº›å‡½æ•°è§†ä¸ºé‡è½½å‡½æ•°ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * ç”±äºæ–¹æ³•é‡è½½ä¸å­˜åœ¨äºæ–‡æœ¬ä¸­ï¼Œå…¬ç‰›é€šè¿‡æ£€æŸ¥å‚æ•°çš„ç±»å‹æ¥è¯†åˆ«æ‰€éœ€çš„å‡½æ•°è°ƒç”¨ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * ç¡®ä¿æ‚¨ç¬¦åˆä»¥ä¸‹å®šä¹‰çš„æ¨¡å¼ä¹‹ä¸€ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * æ³¨æ„:å¦‚æœæœªæŒ‡å®šï¼Œé»˜è®¤ä¸º1ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">processor</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">done</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">any</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">concurrency</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">processor</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">done</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">any</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">processor</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">done</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">any</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">concurrency</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">processor</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">done</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">any</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>å®šä¹‰ç»™å®šé˜Ÿåˆ—ä¸­çš„ä½œä¸šçš„å¤„ç†å‡½æ•°ã€‚</p>
<p>æ¯æ¬¡å°†ä½œä¸šæ”¾å…¥é˜Ÿåˆ—æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨å›è°ƒã€‚
å°†ä½œä¸šçš„ä¸€ä¸ªå®ä¾‹ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’ç»™å®ƒã€‚</p>
<p>å¦‚æœå›è°ƒç­¾ååŒ…å«ç¬¬äºŒä¸ªå¯é€‰çš„ <code>done</code> å‚æ•°ï¼Œåˆ™å›è°ƒå°†è¢«ä¼ é€’ä¸€ä¸ª <code>done</code> å›è°ƒï¼Œä»¥ä¾¿åœ¨ä½œä¸šå®Œæˆåè°ƒç”¨ã€‚
<code>done</code> å›è°ƒå‡½æ•°å¯ä»¥ä¸ Error å®ä¾‹ä¸€èµ·è°ƒç”¨ï¼Œè¡¨ç¤ºä½œä¸šæ²¡æœ‰æˆåŠŸå®Œæˆï¼Œæˆ–è€…å½“ä½œä¸šæˆåŠŸæ—¶ï¼Œå°†ç»“æœä½œä¸ºç¬¬äºŒä¸ªå‚æ•°(ä¾‹å¦‚: <code>done(null, result);</code> )ã€‚
é”™è¯¯å°†ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ä¼ é€’ç»™ <code>failed</code> äº‹ä»¶;ç»“æœå°†ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ä¼ é€’ç»™ <code>completed</code> äº‹ä»¶ã€‚</p>
<p>ä½†æ˜¯ï¼Œå¦‚æœå›è°ƒç­¾åä¸åŒ…å« <code>done</code> å‚æ•°ï¼Œåˆ™å¿…é¡»è¿”å›ä¸€ä¸ª promise æ¥è¡¨ç¤ºä½œä¸šå®Œæˆã€‚
å¦‚æœ promise è¢«æ‹’ç»ï¼Œåˆ™é”™è¯¯å°†ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ä¼ é€’ç»™ <code>failed</code> äº‹ä»¶ã€‚
å¦‚æœå®ƒè¢«è§£æï¼Œå®ƒçš„å€¼å°†æ˜¯ <code>å®Œæˆ</code> äº‹ä»¶çš„ç¬¬äºŒä¸ªå‚æ•°ã€‚</p>
<p>ä½ å¯ä»¥æŒ‡å®šä¸€ä¸ª<code>å¹¶å‘</code>å‚æ•°ã€‚
ç„¶åï¼ŒBull å°†æ ¹æ®è¿™ä¸ªæœ€å¤§å€¼å¹¶è¡Œè°ƒç”¨å¤„ç†ç¨‹åºã€‚</p>
<p>æµç¨‹åŠŸèƒ½ä¹Ÿå¯ä»¥å£°æ˜ä¸ºå•ç‹¬çš„æµç¨‹ã€‚
è¿™å°†æ›´å¥½åœ°åˆ©ç”¨å¯ç”¨çš„ CPU å†…æ ¸ï¼Œå¹¶å¹¶è¡Œè¿è¡Œä½œä¸šã€‚
è¿™æ˜¯è¿è¡Œé˜»å¡ä»£ç çš„å®Œç¾æ–¹å¼ã€‚
åªéœ€æŒ‡å®šåˆ°å¤„ç†å™¨æ¨¡å—çš„ç»å¯¹è·¯å¾„ã€‚
ä¾‹å¦‚ï¼Œä¸€ä¸ªåƒè¿™æ ·å¯¼å‡º process å‡½æ•°çš„æ–‡ä»¶:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// my-processor.js
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">module</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">exports</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// do some job
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>æ‚¨å¯ä»¥è¿”å›ä¸€ä¸ªå€¼æˆ–æ‰¿è¯ºæ¥è¡¨ç¤ºä½œä¸šå·²ç»å®Œæˆã€‚</p>
<p>å¯ä»¥æä¾›ä¸€ä¸ª <code>name</code> å‚æ•°ï¼Œä»¥ä¾¿æ¯ä¸ªé˜Ÿåˆ—å¯ä»¥å®šä¹‰å¤šä¸ªè¿›ç¨‹å‡½æ•°ã€‚
å‘½åè¿›ç¨‹å°†åªå¤„ç†ä¸ç»™å®šåç§°åŒ¹é…çš„ä½œä¸šã€‚
ä½†æ˜¯ï¼Œå¦‚æœåœ¨ä¸€ä¸ª Queue ä¸­å®šä¹‰äº†å¤šä¸ªå‘½åè¿›ç¨‹å‡½æ•°ï¼Œåˆ™æ¯ä¸ªè¿›ç¨‹å‡½æ•°å®šä¹‰çš„å¹¶å‘æ€§å°†å †å åˆ° Queue ä¸­ã€‚
è¯·çœ‹ä¸‹é¢çš„ä¾‹å­:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * å¯¹äºæ¯ä¸ªå‘½åçš„å¤„ç†å™¨ï¼Œå¹¶å‘æ€§å åŠ åœ¨ä¸€èµ·ï¼Œå› æ­¤è¿™ä¸‰ä¸ªè¿›ç¨‹å‡½æ•°ä¸­çš„ä»»ä½•ä¸€ä¸ªéƒ½å¯ä»¥ä»¥125å¹¶å‘æ€§è¿è¡Œã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * ä¸ºäº†é¿å…è¿™ç§è¡Œä¸ºï¼Œæ‚¨éœ€è¦ä¸ºæ¯ä¸ªè¿›ç¨‹å‡½æ•°åˆ›å»ºä¸€ä¸ªè‡ªå·±çš„é˜Ÿåˆ—ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">loadBalancerQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;loadbalancer&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">loadBalancerQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;requestProfile&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">requestProfile</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">loadBalancerQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;sendEmail&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">25</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sendEmail</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">loadBalancerQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;sendInvitation&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sendInvite</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">profileQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;profile&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Max concurrency for requestProfile is 100
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">profileQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;requestProfile&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">requestProfile</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">emailQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;email&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Max concurrency for sendEmail is 25
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">emailQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;sendEmail&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">25</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sendEmail</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>æŒ‡å®š <code>*</code> ä½œä¸ºè¿›ç¨‹åå°†ä½¿å…¶æˆä¸ºæ‰€æœ‰å·²å‘½åä½œä¸šçš„é»˜è®¤å¤„ç†å™¨ã€‚
å®ƒç»å¸¸ç”¨äºä»ä¸€ä¸ªè¿›ç¨‹å‡½æ•°ä¸­å¤„ç†æ‰€æœ‰å·²å‘½åçš„ä½œä¸š:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">differentJobsQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;differentJobsQueue&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">differentJobsQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;*&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">processFunction</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">differentJobsQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;jobA&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">opts</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">differentJobsQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;jobB&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">opts</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p><strong>æ³¨æ„:</strong> ä¸ºäº†ç¡®å®šæ˜¯å¦é€šè¿‡è¿”å› promise æˆ–è°ƒç”¨ <code>done</code> å›è°ƒæ¥é€šçŸ¥ä»»åŠ¡å®Œæˆï¼ŒBull ä¼šæŸ¥çœ‹ä½ ä¼ é€’ç»™å®ƒçš„å›è°ƒçš„é•¿åº¦å±æ€§ã€‚</p>
<p>æ‰€ä»¥è¦å°å¿ƒï¼Œå› ä¸ºä¸‹é¢çš„æ–¹æ³•æ˜¯è¡Œä¸é€šçš„:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// THIS WON&#39;T WORK!!
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">done</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// Oops! done callback here!
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resolve</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>This, however, will:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// No done callback here :)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resolve</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><hr>
<h3 id="queueadd">Queue#add</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span>: <span style="color:#204a87;font-weight:bold">object</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">opts?</span>: <span style="color:#204a87;font-weight:bold">JobOpts</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Job</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>åˆ›å»ºä¸€ä¸ªæ–°ä½œä¸šå¹¶å°†å…¶æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ã€‚
å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™ç›´æ¥æ‰§è¡Œä½œä¸šï¼Œå¦åˆ™å°†è¢«æ”¾å…¥é˜Ÿåˆ—å¹¶å°½å¿«æ‰§è¡Œã€‚</p>
<p>å¯ä»¥æ·»åŠ ä¸€ä¸ªå¯é€‰åç§°ï¼Œä»¥ä¾¿åªæœ‰ä¸ºè¯¥åç§°(ä¹Ÿç§°ä¸ºä½œä¸šç±»å‹)å®šä¹‰çš„æµç¨‹å‡½æ•°å°†å¤„ç†è¯¥ä½œä¸šã€‚</p>
<p><strong>æ³¨æ„:</strong> æ‚¨éœ€è¦ä¸ºæ·»åŠ åˆ°é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å·²å‘½åä½œä¸šå®šä¹‰<em>processors</em>ï¼Œå¦åˆ™é˜Ÿåˆ—å°†æŠ¥é”™ç»™å®šä½œä¸šç¼ºå°‘ä¸€ä¸ªå¤„ç†å™¨ï¼Œé™¤éæ‚¨åœ¨å®šä¹‰å¤„ç†å™¨æ—¶ä½¿ç”¨ <code>*</code> ä½œä¸ºä½œä¸šåç§°ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">JobOpts</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">priority</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Optional priority value.ranges from 1 (highest priority) to MAX_INT  (lowest priority).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Note that using priorities has a slight impact on performance, so do not use it if not required.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">delay</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// An amount of milliseconds to wait until this job can be processed.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Note that for accurate delays, both server and clients should have their clocks synchronized.[optional].
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">attempts</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// The total number of attempts to try the job until it completes.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">repeat</span>: <span style="color:#204a87;font-weight:bold">RepeatOpts</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Repeat job according to a cron specification, see below for details.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">backoff</span>: <span style="color:#204a87;font-weight:bold">number</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BackoffOpts</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Backoff setting for automatic retries if the job fails, default strategy: `fixed`.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Needs `attempts` to be set.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">lifo</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// if true, adds the job to the right of the queue instead of the left (default false)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">timeout</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// The number of milliseconds after which the job should fail with a timeout error [optional]
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">jobId</span>: <span style="color:#204a87;font-weight:bold">number</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Override the job ID - by default, the job ID is a unique integer, but you can use this setting to override it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// If you use this option, it is up to you to ensure the jobId is unique.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// If you attempt to add a job with an id that already exists, it will not be added (see caveat below about repeatable jobs).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">removeOnComplete</span>: <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">number</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">KeepJobs</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// If true, removes the job when it successfully completes.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// A number specified the amount of jobs to keep.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Default behavior is to keep the job in the completed set.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// See KeepJobs if using that interface instead.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">removeOnFail</span>: <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">number</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">KeepJobs</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// If true, removes the job when it fails after all attempts.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// A number specified the amount of jobs to keep, see KeepJobs if using that interface instead.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Default behavior is to keep the job in the failed set.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">stackTraceLimit</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Limits the amount of stack trace lines that will be recorded in the stacktrace.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h4 id="keepjobs-é€‰é¡¹">KeepJobs é€‰é¡¹</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * KeepJobs
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * Specify which jobs to keep after finishing.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * If both age and count are  * specified, then the jobs kept will be the ones that satisfies both properties.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">KeepJobs</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">   * Maximum age in *seconds* for job to be kept.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">   */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">age?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">   * Maximum count of jobs to be kept.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">   */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">count?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><hr>
<h4 id="è¶…æ—¶çš„å®ç°">è¶…æ—¶çš„å®ç°</h4>
<p>åŠ¡å¿…æ³¨æ„ï¼Œåœ¨ç»™å®šçš„ <code>è¶…æ—¶</code> ä¹‹åï¼Œä½œä¸šä¸ä¼šè¢«ä¸»åŠ¨åœæ­¢ã€‚
ä½œä¸šè¢«æ ‡è®°ä¸ºå¤±è´¥ï¼Œä½œä¸šçš„æ‰¿è¯ºè¢«æ‹’ç»ï¼Œä½†æ˜¯ Bull æ²¡æœ‰åŠæ³•ä»å¤–éƒ¨åœæ­¢å¤„ç†å™¨åŠŸèƒ½ã€‚</p>
<p>å¦‚æœæ‚¨éœ€è¦ä¸€ä¸ªä½œä¸šåœ¨è¶…æ—¶ååœæ­¢å¤„ç†ï¼Œè¿™é‡Œæœ‰ä¸€äº›å»ºè®®:</p>
<ul>
<li>è®©ä½œä¸šæœ¬èº«å®šæœŸæ£€æŸ¥ <code>job. getstatus()</code> ï¼Œå¦‚æœçŠ¶æ€å˜ä¸º <code>failed</code> åˆ™é€€å‡ºã€‚</li>
<li>å°†ä½œä¸šå®ç°ä¸ºä¸€ä¸ªå¯å–æ¶ˆæ‰¿è¯º_ã€‚
å¦‚æœå¤„ç†å™¨ promise æœ‰ä¸€ä¸ª <code>cancel()</code> æ–¹æ³•ï¼Œå®ƒå°†åœ¨ä½œä¸šè¶…æ—¶æ—¶è¢«è°ƒç”¨ï¼Œä½œä¸šå¯ä»¥ç›¸åº”åœ°å“åº”ã€‚
(æ³¨:ç›®å‰è¿™åªé€‚ç”¨äºåŸç”Ÿæ‰¿è¯ºï¼Œå‚è§<a href="https://github.com/OptimalBits/bull/issues/2203">#2203</a></li>
<li>å¦‚æœæ‚¨æœ‰ä¸€ç§ä»å¤–éƒ¨åœæ­¢ä½œä¸šçš„æ–¹æ³•ï¼Œé‚£ä¹ˆä¸º <code>failed</code> äº‹ä»¶æ·»åŠ ä¸€ä¸ªä¾¦å¬å™¨ï¼Œå¹¶åœ¨é‚£é‡Œæ‰§è¡Œè¯¥æ“ä½œã€‚</li>
</ul>
<h4 id="é‡å¤çš„å·¥ä½œç»†èŠ‚">é‡å¤çš„å·¥ä½œç»†èŠ‚</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">RepeatOpts</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">cron?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Cron string
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">tz?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Timezone
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">startDate?</span>: <span style="color:#204a87;font-weight:bold">Date</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Start date when the repeat job should start repeating (only with cron).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">endDate?</span>: <span style="color:#204a87;font-weight:bold">Date</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// End date when the repeat job should stop repeating.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">limit?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Number of times the job should repeat at max.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">every?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Repeat every millis (cron setting cannot be used together with this setting.)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">count?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// The start value for the repeat iteration count.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">key</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// The key for the repeatable job metadata in Redis.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>æ·»åŠ å¸¦æœ‰ <code>repeat</code> é€‰é¡¹é›†çš„ä½œä¸šå®é™…ä¸Šä¼šç«‹å³å®Œæˆä¸¤ä»¶äº‹æƒ…:åˆ›å»ºä¸€ä¸ª Repeatable job é…ç½®ï¼Œä»¥åŠåœ¨ä½œä¸šç¬¬ä¸€æ¬¡è¿è¡Œæ—¶è°ƒåº¦ä¸€ä¸ªå¸¸è§„çš„å»¶è¿Ÿä½œä¸šã€‚
ç¬¬ä¸€æ¬¡è¿è¡Œå°†è¢«å®‰æ’ä¸º <code>æŒ‰å°æ—¶</code> è¿è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæ‚¨åˆ›å»ºäº†ä¸€ä¸ªåœ¨ 4:07 æ¯ 15 åˆ†é’Ÿé‡å¤ä¸€æ¬¡çš„ä½œä¸šï¼Œé‚£ä¹ˆè¯¥ä½œä¸šå°†é¦–å…ˆåœ¨ 4:15 è¿è¡Œï¼Œç„¶åæ˜¯ 4:30ï¼Œä¾æ­¤ç±»æ¨ã€‚
å¦‚æœè®¾ç½®äº† <code>startDate</code> ï¼Œä½œä¸šå°†ä¸ä¼šåœ¨ <code>startDate</code> ä¹‹å‰è¿è¡Œï¼Œä½†ä»ç„¶ä¼šæŒ‰å°æ—¶è¿è¡Œã€‚
åœ¨å‰é¢çš„ç¤ºä¾‹ä¸­ï¼Œå¦‚æœå°† <code>startDate</code> è®¾ç½®ä¸ºæŸä¸€å¤©çš„ 6:05ï¼Œå³å½“å¤©ï¼Œç¬¬ä¸€ä¸ªä½œä¸šå°†åœ¨ 6:15 è¿è¡Œã€‚</p>
<p>cron è¡¨è¾¾å¼ä½¿ç”¨<a href="https://github.com/harrisiirak/cron-parser">cron-parser</a>åº“ï¼Œè¯·å‚é˜…å®ƒä»¬çš„æ–‡æ¡£ä»¥äº†è§£æ›´å¤šç»†èŠ‚ã€‚</p>
<p>å¯é‡å¤ä½œä¸šé…ç½®ä¸æ˜¯ä½œä¸šï¼Œå› æ­¤å®ƒä¸ä¼šå‡ºç°åœ¨ <code>getJobs()</code> ç­‰æ–¹æ³•ä¸­ã€‚
è¦ç®¡ç†å¯é‡å¤ä½œä¸šé…ç½®ï¼Œè¯·ä½¿ç”¨<a href="#queuegetrepeatablejobs"><code>getRepeatableJobs()</code></a>æˆ–ç±»ä¼¼çš„æ–¹æ³•ã€‚
è¿™ä¹Ÿæ„å‘³ç€é‡å¤ä½œä¸šä¸å‚ä¸è¯„ä¼° <code>jobId</code> çš„å”¯ä¸€æ€§â€”â€”ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªä¸å¯é‡å¤ä½œä¸šå¯ä»¥å…·æœ‰ä¸å¯é‡å¤ä½œä¸šé…ç½®ç›¸åŒçš„ <code>jobId</code> ï¼Œè€Œä¸¤ä¸ªå¯é‡å¤ä½œä¸šé…ç½®å¯ä»¥å…·æœ‰ç›¸åŒçš„ <code>jobId</code> ï¼Œåªè¦å®ƒä»¬å…·æœ‰ä¸åŒçš„é‡å¤é€‰é¡¹ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œä»¥ä¸‹ä»£ç å°†å¯¼è‡´åˆ›å»ºä¸‰ä¸ªä»»åŠ¡(ä¸€ä¸ªæ˜¯ç«‹å³çš„ï¼Œä¸¤ä¸ªæ˜¯å»¶è¿Ÿçš„):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">({},</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">jobId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;example&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">repeat</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">every</span>: <span style="color:#204a87;font-weight:bold">5</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">1000</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">({},</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">jobId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;example&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">repeat</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">every</span>: <span style="color:#204a87;font-weight:bold">5</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">1000</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// Will not be created, same repeat configuration
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">({},</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">jobId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;example&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">repeat</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">every</span>: <span style="color:#204a87;font-weight:bold">10</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">1000</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// Will be created, different repeat configuration
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">({},</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">jobId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;example&#34;</span> <span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// Will be created, no regular job with this id
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">({},</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">jobId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;example&#34;</span> <span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// Will not be created, conflicts with previous regular job
</span></span></span></code></pre></div><h4 id="è¡¥å¿é€‰é¡¹">è¡¥å¿é€‰é¡¹</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">BackoffOpts</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Backoff type, which can be either `fixed` or `exponential`.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// A custom backoff strategy can also be specified in `backoffStrategies` on the queue settings.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">delay</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Backoff delay, in milliseconds.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><hr>
<h3 id="queueaddbulk">Queue#addBulk</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">addBulk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">jobs</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">name?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span>: <span style="color:#204a87;font-weight:bold">object</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">opts?</span>: <span style="color:#204a87;font-weight:bold">JobOpts</span> <span style="color:#000;font-weight:bold">}[])</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Job</span><span style="color:#a40000">[]</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>åˆ›å»ºä½œä¸šæ•°ç»„å¹¶å°†å®ƒä»¬æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ã€‚
å®ƒä»¬çš„ç­¾åä¸<a href="#queueadd">Queue#add</a>ç›¸åŒã€‚</p>
<hr>
<h3 id="queuepause">Queue#pause</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">pause</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">isLocal?</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">doNotWaitActive?</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span>
</span></span></code></pre></div><p>è¿”å›ä¸€ä¸ªåœ¨é˜Ÿåˆ—æš‚åœæ—¶è§£æçš„æ‰¿è¯ºã€‚
æš‚åœçš„é˜Ÿåˆ—åœ¨æ¢å¤ä¹‹å‰ä¸ä¼šå¤„ç†æ–°ä½œä¸šï¼Œä½†æ­£åœ¨å¤„ç†çš„å½“å‰ä½œä¸šå°†ç»§ç»­ï¼Œç›´åˆ°å®Œæˆã€‚
æš‚åœå¯ä»¥æ˜¯å…¨å±€çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯å±€éƒ¨çš„ã€‚
å¦‚æœæ˜¯å…¨å±€çš„ï¼Œé‚£ä¹ˆç»™å®šé˜Ÿåˆ—çš„æ‰€æœ‰é˜Ÿåˆ—å®ä¾‹ä¸­çš„æ‰€æœ‰ worker éƒ½å°†è¢«æš‚åœã€‚
å¦‚æœæ˜¯æœ¬åœ°çš„ï¼Œåœ¨å½“å‰é”è¿‡æœŸåï¼Œåªæœ‰è¿™ä¸ª worker å°†åœæ­¢å¤„ç†æ–°ä½œä¸šã€‚
è¿™å¯¹äºé˜»æ­¢å·¥äººåœ¨å€’é—­å‰æ¥å—æ–°å·¥ä½œæ˜¯å¾ˆæœ‰ç”¨çš„ã€‚</p>
<p>å¦‚æœ <code>doNotWaitActive</code> ä¸º <code>true</code> ï¼Œ <code>pause</code> å°†ä¸ä¼šç­‰å¾…ä»»ä½•æ´»åŠ¨ä½œä¸šå®Œæˆåå†è§£æã€‚
å¦åˆ™ï¼Œ <code>pause </code>_å°†ç­‰å¾…æ´»åŠ¨çš„ä½œä¸šå®Œæˆã€‚
æ›´å¤šä¿¡æ¯è¯·å‚è§<a href="#queuewhencurrentjobsfinished">Queue#whenCurrentJobsFinished</a>ã€‚</p>
<p>æš‚åœå·²ç»æš‚åœçš„é˜Ÿåˆ—ä¸ä¼šåšä»»ä½•äº‹æƒ…ã€‚</p>
<hr>
<h3 id="queueispaused">Queue#isPaused</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">isPaused</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">isLocal?</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦è¢«æš‚åœã€‚
å¦‚æœéœ€è¦çŸ¥é“è¿™ä¸ªç‰¹å®šå®ä¾‹æ˜¯å¦æš‚åœï¼Œåˆ™ä¼ é€’ trueã€‚</p>
<hr>
<h3 id="queueresume">Queue#resume</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">resume</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">isLocal?</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span>
</span></span></code></pre></div><p>è¿”å›ä¸€ä¸ªæ‰¿è¯ºï¼Œè¯¥æ‰¿è¯ºåœ¨æš‚åœåæ¢å¤é˜Ÿåˆ—æ—¶è§£æã€‚
ç®€å†å¯ä»¥æ˜¯æœ¬åœ°çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯å…¨çƒçš„ã€‚
å¦‚æœæ˜¯å…¨å±€çš„ï¼Œé‚£ä¹ˆç»™å®šé˜Ÿåˆ—çš„æ‰€æœ‰é˜Ÿåˆ—å®ä¾‹ä¸­çš„æ‰€æœ‰ worker éƒ½å°†è¢«æ¢å¤ã€‚
å¦‚æœæ˜¯æœ¬åœ°çš„ï¼Œåªæœ‰è¿™ä¸ªå·¥äººå°†è¢«æ¢å¤ã€‚
æ³¨æ„å…¨å±€æ¢å¤é˜Ÿåˆ—ä¸ä¼šæ¢å¤å·²ç»åœ¨æœ¬åœ°æš‚åœçš„ worker;å¯¹äºè¿™äº›ï¼Œå¿…é¡»åœ¨å®ƒä»¬çš„å®ä¾‹ä¸Šç›´æ¥è°ƒç”¨ <code>resume(true)</code> ã€‚</p>
<p>æ¢å¤æœªæš‚åœçš„é˜Ÿåˆ—ä¸ä¼šæ‰§è¡Œä»»ä½•æ“ä½œã€‚</p>
<hr>
<h3 id="queuewhencurrentjobsfinished">Queue#whenCurrentJobsFinished</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">whenCurrentJobsFinished</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Void</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>è¿”å›ä¸€ä¸ªæ‰¿è¯ºï¼Œè¯¥æ‰¿è¯ºåœ¨å½“å‰ç”±è¯¥å·¥äººå¤„ç†çš„æ‰€æœ‰ä½œä¸šå®Œæˆæ—¶è§£å†³ã€‚</p>
<hr>
<h3 id="queuecount">Queue#count</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">count</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>è¿”å›ä¸€ä¸ª promiseï¼Œè¯¥ promise è¿”å›é˜Ÿåˆ—ä¸­ç­‰å¾…æˆ–å»¶è¿Ÿçš„ä½œä¸šæ•°é‡ã€‚
ç”±äºå¯èƒ½æœ‰å…¶ä»–è¿›ç¨‹æ·»åŠ æˆ–å¤„ç†ä½œä¸šï¼Œå› æ­¤è¯¥å€¼å¯èƒ½åªåœ¨éå¸¸çŸ­çš„æ—¶é—´å†…ä¸ºçœŸã€‚</p>
<hr>
<h3 id="queueremovejobs">Queue#removeJobs</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">removeJobs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pattern</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>åˆ é™¤ jobId åŒ¹é…ç»™å®šæ¨¡å¼çš„æ‰€æœ‰ä½œä¸šã€‚
æ¨¡å¼å¿…é¡»éµå¾ª redis å…¨å±€æ ·å¼æ¨¡å¼(è¯­æ³•)[https://redis.io/commands/keys]</p>
<p>ä¾‹å­:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000">myQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">removeJobs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;?oo*&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;done removing jobs&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>å°†åˆ é™¤ id ä¸º: <code>boo</code> ã€ <code>foofighter</code> ç­‰çš„å·¥ä½œã€‚</p>
<p>æ³¨æ„:æ­¤æ–¹æ³•ä¸å½±å“å¯é‡å¤ä½œä¸šé…ç½®ï¼Œè€Œæ˜¯ä½¿ç”¨<a href="#queueremoverepeatable"><code>removeRepeatable()</code></a>æˆ–<a href="#queueremoverepeatablebykey"><code>removeRepeatableByKey()</code></a></p>
<hr>
<h3 id="queueempty">Queue#empty</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">empty</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span>
</span></span></code></pre></div><p>æ¸…ç©ºä¸€ä¸ªé˜Ÿåˆ—ï¼Œåˆ é™¤æ‰€æœ‰<em>input</em>åˆ—è¡¨å’Œå…³è”çš„ä½œä¸šã€‚</p>
<p>æ³¨æ„:æ­¤å‡½æ•°åªåˆ é™¤æ­£åœ¨ç­‰å¾…é˜Ÿåˆ—å¤„ç†æˆ–è¢«å»¶è¿Ÿå¤„ç†çš„ä½œä¸šã€‚
å¤„äºå…¶ä»–çŠ¶æ€(æ´»åŠ¨ã€å¤±è´¥ã€å·²å®Œæˆ)çš„ä½œä¸šå’Œå¯é‡å¤ä½œä¸šé…ç½®å°†ä¿æŒä¸å˜ï¼Œå¯é‡å¤ä½œä¸šå°†ç»§ç»­æŒ‰è®¡åˆ’åˆ›å»ºã€‚</p>
<p>è¦åˆ é™¤å…¶ä»–ä½œä¸šçŠ¶æ€ï¼Œè¯·ä½¿ç”¨<a href="#queueobliterate"><code>clean()</code></a>ï¼Œè¦åˆ é™¤åŒ…æ‹¬ Repeatable job é…ç½®åœ¨å†…çš„æ‰€æœ‰é…ç½®ï¼Œè¯·ä½¿ç”¨<a href="#queueobliterate"><code>obliterate()</code></a>ã€‚</p>
<hr>
<h3 id="queueclose">Queue#close</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">doNotWaitJobs?</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span>
</span></span></code></pre></div><p>å…³é—­åº•å±‚ Redis å®¢æˆ·ç«¯ã€‚
ä½¿ç”¨å®ƒæ¥æ‰§è¡Œä¸€ä¸ªä¼˜é›…çš„å…³é—­ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Queue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;bull&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">queue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;example&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">after100</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">after</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">close</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;done&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;completed&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">after100</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p><code>close</code> å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹è°ƒç”¨ï¼Œä½†æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„:å¦‚æœåœ¨ä½œä¸šå¤„ç†ç¨‹åºå†…éƒ¨è°ƒç”¨ï¼Œåˆ™é˜Ÿåˆ—ç›´åˆ°ä½œä¸šå¤„ç†å®Œæ¯•æ‰ä¼šå…³é—­ï¼Œæ‰€ä»¥ä¸‹é¢çš„è¯­å¥ä¸èµ·ä½œç”¨:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">jobDone</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">handle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">close</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">jobDone</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>ç›¸å,è¿™æ ·åš:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">jobDone</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">handle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">close</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">jobDone</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>Or this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">close</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">handle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(...);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><hr>
<h3 id="queuegetjob">Queue#getJob</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getJob</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">jobId</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Job</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>è¿”å›ä¸€ä¸ª promiseï¼Œè¯¥ promise å°†è¿”å›ä¸ <code>jobId</code> å‚æ•°ç›¸å…³è”çš„ä½œä¸šå®ä¾‹ã€‚
å¦‚æœæŒ‡å®šçš„ä½œä¸šæ— æ³•æ‰¾åˆ°ï¼Œæ‰¿è¯ºå°†è¢«è§£æä¸º <code>null</code> ã€‚</p>
<p>æ³¨æ„: æ­¤æ–¹æ³•ä¸è¿”å›å¯é‡å¤ä½œä¸šé…ç½®ï¼Œå‚è§<a href="#queuegetrepeatablejobs"><code>getRepeatableJobs()</code></a></p>
<h3 id="queuegetjobs">Queue#getJobs</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getJobs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">types</span>: <span style="color:#204a87;font-weight:bold">JobStatus</span><span style="color:#000;font-weight:bold">[],</span> <span style="color:#000">start?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">asc?</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Job</span><span style="color:#a40000">[]</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>è¿”å›ä¸€ä¸ª promiseï¼Œè¯¥ promise å°†è¿”å›ç»™å®šä½œä¸šçŠ¶æ€çš„ä½œä¸šå®ä¾‹æ•°ç»„ã€‚
æä¾›äº†èŒƒå›´å’Œé¡ºåºçš„å¯é€‰å‚æ•°ã€‚</p>
<p>æ³¨æ„: <code>start</code> å’Œ <code>end</code> é€‰é¡¹é€‚ç”¨äºæ¯ä¸ª<strong>ä½œä¸šçŠ¶æ€</strong>ã€‚
ä¾‹å¦‚ï¼Œå¦‚æœæœ‰ 10 ä¸ªä½œä¸šå¤„äº<code>completed</code>çŠ¶æ€ï¼Œ10 ä¸ªä½œä¸šå¤„äº<code>active</code>çŠ¶æ€ï¼Œ <code>getJobs(['completed'ï¼Œ'active']ï¼Œ 0,4)</code> å°†ç”Ÿæˆä¸€ä¸ªåŒ…å« 10 ä¸ªæ¡ç›®çš„æ•°ç»„ï¼Œè¡¨ç¤ºå‰ 5 ä¸ªå·²å®Œæˆçš„ä½œä¸š(0 - 4)å’Œå‰ 5 ä¸ªæ´»åŠ¨çš„ä½œä¸š(0 - 4)ã€‚</p>
<p>æ­¤æ–¹æ³•ä¸è¿”å›å¯é‡å¤ä½œä¸šé…ç½®ï¼Œå‚è§<a href="#queuegetrepeatablejobs"><code>getRepeatableJobs()</code></a></p>
<hr>
<h3 id="queuegetjoblogs">Queue#getJobLogs</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getJobLogs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">jobId</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">logs</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">[],</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">count</span>: <span style="color:#204a87;font-weight:bold">number</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>æ ¹æ® start å’Œ end å‚æ•°è¿”å›å¸¦æœ‰æ—¥å¿—çš„å¯¹è±¡ã€‚
è¿”å›çš„è®¡æ•°å€¼æ˜¯æ—¥å¿—çš„æ€»é‡ï¼Œè¿™å¯¹äºå®ç°åˆ†é¡µå¾ˆæœ‰ç”¨ã€‚</p>
<hr>
<h3 id="queuegetrepeatablejobs">Queue#getRepeatableJobs</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getRepeatableJobs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">asc?</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">key</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">endDate</span>: <span style="color:#204a87;font-weight:bold">Date</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">tz</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">cron</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">every</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">next</span>: <span style="color:#204a87;font-weight:bold">number</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}[]</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>è¿”å›ä¸€ä¸ª promiseï¼Œè¯¥ promise å°†è¿”å›ä¸€ä¸ªå¯é‡å¤ä½œä¸šé…ç½®æ•°ç»„ã€‚
æä¾›äº†èŒƒå›´å’Œé¡ºåºçš„å¯é€‰å‚æ•°ã€‚</p>
<hr>
<h3 id="queueremoverepeatable">Queue#removeRepeatable</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">removeRepeatable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">repeat</span>: <span style="color:#204a87;font-weight:bold">RepeatOpts</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>åˆ é™¤ç»™å®šçš„å¯é‡å¤ä½œä¸šé…ç½®ã€‚
RepeatOpts éœ€è¦ä¸æ·»åŠ ä½œä¸šæ—¶ä½¿ç”¨çš„ç›¸åŒã€‚</p>
<hr>
<hr>
<h3 id="queueremoverepeatablebykey">Queue#removeRepeatableByKey</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">removeRepeatableByKey</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>é€šè¿‡é”®åˆ é™¤ç»™å®šçš„å¯é‡å¤ä½œä¸šé…ç½®ï¼Œä»¥ä¾¿ä¸å†ä¸ºè¯¥ç‰¹å®šé…ç½®å¤„ç†ä»»ä½•å¯é‡å¤ä½œä¸šã€‚</p>
<p>ç›®å‰æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥è·å¾—å¯é‡å¤å·¥ä½œçš„ <code>å…³é”®</code> ã€‚</p>
<p>å½“ç¬¬ä¸€æ¬¡åˆ›å»ºä½œä¸šæ—¶ï¼Œ <code>queue.add()</code> å°†è¿”å›ä¸€ä¸ªå¸¦æœ‰è¯¥ä½œä¸šé”®å€¼çš„ä½œä¸šå¯¹è±¡ï¼Œä½ å¯ä»¥å°†å…¶å­˜å‚¨èµ·æ¥ä¾›ä»¥åä½¿ç”¨:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">job</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;remove&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">example</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;data&#34;</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">repeat</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">every</span>: <span style="color:#204a87;font-weight:bold">1000</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// store job.opts.repeat.key somewhere...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">repeatableKey</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">repeat</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ...then later...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">removeRepeatableByKey</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">repeatableKey</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>å¦åˆ™ï¼Œä½ å¯ä»¥ä½¿ç”¨<a href="#queuegetrepeatablejobs"><code>getRepeatableJobs()</code></a>åˆ—å‡ºæ‰€æœ‰å¯é‡å¤çš„ä½œä¸šï¼Œåœ¨åˆ—è¡¨ä¸­æ‰¾åˆ°ä½ æƒ³è¦åˆ é™¤çš„ä½œä¸šï¼Œå¹¶ä½¿ç”¨é‚£é‡Œçš„é”®æ¥åˆ é™¤å®ƒ:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;remove&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">example</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;data&#34;</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">jobId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;findMe&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">repeat</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">every</span>: <span style="color:#204a87;font-weight:bold">1000</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">then</span> <span style="color:#000">later</span> <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">repeatableJobs</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getRepeatableJobs</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">foundJob</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">repeatableJobs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">find</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;findMe&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">removeRepeatableByKey</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">foundJob</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><hr>
<h3 id="queuegetjobcounts">Queue#getJobCounts</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getJobCounts</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">JobCounts</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>è¿”å›ä¸€ä¸ª promiseï¼Œè¯¥ promise å°†è¿”å›ç»™å®šé˜Ÿåˆ—çš„ä½œä¸šè®¡æ•°ã€‚</p>
<pre tabindex="0"><code class="language-typescript{" data-lang="typescript{">  interface JobCounts {
    waiting: number,
    active: number,
    completed: number,
    failed: number,
    delayed: number
  }
}
</code></pre><hr>
<h3 id="queuegetcompletedcount">Queue#getCompletedCount</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getCompletedCount</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>è¿”å›ä¸€ä¸ª promiseï¼Œè¯¥ promise å°†è¿”å›ç»™å®šé˜Ÿåˆ—ä¸­å·²å®Œæˆçš„ä½œä¸šè®¡æ•°ã€‚</p>
<h3 id="queuegetfailedcount">Queue#getFailedCount</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getFailedCount</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>è¿”å›ä¸€ä¸ª promiseï¼Œè¯¥ promise å°†è¿”å›ç»™å®šé˜Ÿåˆ—çš„å¤±è´¥ä½œä¸šè®¡æ•°ã€‚</p>
<h3 id="queuegetdelayedcount">Queue#getDelayedCount</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getDelayedCount</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>è¿”å›ä¸€ä¸ªæ‰¿è¯ºï¼Œè¯¥æ‰¿è¯ºå°†è¿”å›ç»™å®šé˜Ÿåˆ—çš„å»¶è¿Ÿä½œä¸šè®¡æ•°ã€‚</p>
<h3 id="queuegetactivecount">Queue#getActiveCount</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getActiveCount</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>è¿”å›ä¸€ä¸ªæ‰¿è¯ºï¼Œè¯¥æ‰¿è¯ºå°†è¿”å›ç»™å®šé˜Ÿåˆ—çš„æ´»åŠ¨ä½œä¸šè®¡æ•°ã€‚</p>
<h3 id="queuegetwaitingcount">Queue#getWaitingCount</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getWaitingCount</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>è¿”å›ä¸€ä¸ª promiseï¼Œè¯¥ promise å°†è¿”å›ç»™å®šé˜Ÿåˆ—çš„ç­‰å¾…ä½œä¸šè®¡æ•°ã€‚</p>
<h3 id="queuegetpausedcount">Queue#getPausedCount</h3>
<p><em>å¼ƒç”¨</em> å› ä¸ºåªæœ‰é˜Ÿåˆ—å¯ä»¥æš‚åœï¼Œæ‰€ä»¥ getWaitingCount ä¼šç»™å‡ºç›¸åŒçš„ç»“æœã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getPausedCount</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>è¿”å›ä¸€ä¸ªæ‰¿è¯ºï¼Œè¯¥æ‰¿è¯ºå°†è¿”å›ç»™å®šé˜Ÿåˆ—çš„æš‚åœä½œä¸šè®¡æ•°ã€‚</p>
<h3 id="getters">Getters</h3>
<p>ä¸‹é¢çš„æ–¹æ³•ç”¨äºè·å–å¤„äºç‰¹å®šçŠ¶æ€çš„ä½œä¸šã€‚</p>
<p>GetterOpts å¯ä»¥ç”¨äºä» getter ä¸­é…ç½®æŸäº›æ–¹é¢ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">GetterOpts</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">excludeData</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Exclude the data field of the jobs.
</span></span></span></code></pre></div><h3 id="queuegetwaiting">Queue#getWaiting</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getWaiting</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">opts?</span>: <span style="color:#204a87;font-weight:bold">GetterOpts</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Array</span><span style="color:#a40000">&lt;</span><span style="color:#c4a000">Job</span><span style="color:#000;font-weight:bold">&gt;</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>è¿”å›ä¸€ä¸ª promiseï¼Œè¯¥ promise å°†è¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œå…¶ä¸­åŒ…å«å¼€å§‹å’Œç»“æŸä¹‹é—´çš„ç­‰å¾…ä½œä¸šã€‚</p>
<h3 id="queuegetactive">Queue#getActive</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getActive</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">opts?</span>: <span style="color:#204a87;font-weight:bold">GetterOpts</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Array</span><span style="color:#a40000">&lt;</span><span style="color:#c4a000">Job</span><span style="color:#000;font-weight:bold">&gt;</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>è¿”å›ä¸€ä¸ª promiseï¼Œè¯¥ promise å°†è¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œå…¶ä¸­åŒ…å«å¼€å§‹å’Œç»“æŸä¹‹é—´çš„æ´»åŠ¨ä½œä¸šã€‚</p>
<h3 id="queuegetdelayed">Queue#getDelayed</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getDelayed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">opts?</span>: <span style="color:#204a87;font-weight:bold">GetterOpts</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Array</span><span style="color:#a40000">&lt;</span><span style="color:#c4a000">Job</span><span style="color:#000;font-weight:bold">&gt;</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>è¿”å›ä¸€ä¸ª promiseï¼Œè¯¥ promise å°†è¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œå…¶ä¸­åŒ…å«å¼€å§‹å’Œç»“æŸä¹‹é—´çš„å»¶è¿Ÿä½œä¸šã€‚</p>
<h3 id="queuegetcompleted">Queue#getCompleted</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getCompleted</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">opts?</span>: <span style="color:#204a87;font-weight:bold">GetterOpts</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Array</span><span style="color:#a40000">&lt;</span><span style="color:#c4a000">Job</span><span style="color:#000;font-weight:bold">&gt;</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>è¿”å›ä¸€ä¸ª promiseï¼Œè¯¥ promise å°†è¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œå…¶ä¸­åŒ…å«å¼€å§‹å’Œç»“æŸä¹‹é—´å·²å®Œæˆçš„ä½œä¸šã€‚</p>
<h3 id="queuegetfailed">Queue#getFailed</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getFailed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">opts?</span>: <span style="color:#204a87;font-weight:bold">GetterOpts</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Array</span><span style="color:#a40000">&lt;</span><span style="color:#c4a000">Job</span><span style="color:#000;font-weight:bold">&gt;</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>è¿”å›ä¸€ä¸ª promiseï¼Œè¯¥ promise å°†è¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œå…¶ä¸­åŒ…å«å¼€å§‹å’Œç»“æŸä¹‹é—´å¤±è´¥çš„ä½œä¸šã€‚</p>
<h3 id="queuegetworkers">Queue#getWorkers</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getWorkers</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Array</span><span style="color:#a40000">&lt;</span><span style="color:#c4a000">Object</span><span style="color:#000;font-weight:bold">&gt;</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>è¿”å›ä¸€ä¸ª promiseï¼Œè¯¥ promise å°†è§£æä¸ºå½“å‰æ­£åœ¨ä¾¦å¬æˆ–å¤„ç†ä½œä¸šçš„æ•°ç»„å·¥ä½œè€…ã€‚
è¯¥å¯¹è±¡åŒ…å«ä¸<a href="https://redis.io/commands/client-list">Redis CLIENT LIST</a>å‘½ä»¤ç›¸åŒçš„å­—æ®µã€‚</p>
<hr>
<h3 id="queuegetmetrics">Queue#getMetrics</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getMetrics</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;completed&#39;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#39;failed&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">meta</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">count</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">prevTS</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">prevCount</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">data</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">[];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">count</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>è¿”å›ä¸€ä¸ªè§£æä¸º Metrics å¯¹è±¡çš„æ‰¿è¯ºã€‚</p>
<h3 id="queueclean">Queue#clean</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">clean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">grace</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">status?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">limit?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">number</span><span style="color:#a40000">[]</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>é€šçŸ¥é˜Ÿåˆ—åˆ é™¤åœ¨å®½é™æœŸä¹‹å¤–åˆ›å»ºçš„ç‰¹å®šç±»å‹çš„ä½œä¸šã€‚</p>
<h4 id="example">Example</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;cleaned&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">jobs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">type</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Cleaned %s %s jobs&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">jobs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">type</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//cleans all jobs that completed over 5 seconds ago.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5000</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//clean all jobs that failed over 10 seconds ago.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;failed&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><h3 id="queueobliterate">Queue#obliterate</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">obliterate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ops</span><span style="color:#ce5c00;font-weight:bold">?:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">force</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">})</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>å®Œå…¨åˆ é™¤ä¸€ä¸ªé˜Ÿåˆ—åŠå…¶æ‰€æœ‰æ•°æ®ã€‚
ä¸ºäº†æ¶ˆé™¤é˜Ÿåˆ—ï¼Œä¸èƒ½æœ‰æ´»åŠ¨ä½œä¸šï¼Œä½†å¯ä»¥ä½¿ç”¨ <code>force</code> é€‰é¡¹è¦†ç›–è¿™ç§è¡Œä¸ºã€‚</p>
<p>æ³¨æ„:ç”±äºæ­¤æ“ä½œçš„æŒç»­æ—¶é—´å¯èƒ½ç›¸å½“é•¿ï¼Œè¿™å–å†³äºé˜Ÿåˆ—ä¸­æœ‰å¤šå°‘ä½œä¸šï¼Œå› æ­¤å®ƒä¸æ˜¯è‡ªåŠ¨æ‰§è¡Œçš„ï¼Œè€Œæ˜¯è¿­ä»£æ‰§è¡Œçš„ã€‚
ç„¶è€Œï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­é˜Ÿåˆ—æ€»æ˜¯æš‚åœï¼Œå¦‚æœé˜Ÿåˆ—åœ¨è¢«å¦ä¸€ä¸ªè„šæœ¬åˆ é™¤æœŸé—´å–æ¶ˆæš‚åœï¼Œåˆ™è°ƒç”¨å°†å¤±è´¥ï¼Œå®ƒè®¾æ³•åˆ é™¤çš„é¡¹ç›®å°†è¢«åˆ é™¤ï¼Œç›´åˆ°å¤±è´¥ã€‚</p>
<h4 id="ç¤ºä¾‹">ç¤ºä¾‹</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Removes everything but only if there are no active jobs
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">obliterate</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">obliterate</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">force</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><hr>
<h2 id="å·¥ä½œ">å·¥ä½œ</h2>
<p>ä½œä¸šåŒ…æ‹¬æ‰§è¡Œä½œä¸šæ‰€éœ€çš„æ‰€æœ‰æ•°æ®ï¼Œä»¥åŠæ›´æ–°ä½œä¸šè¿›åº¦æ‰€éœ€çš„è¿›åº¦æ–¹æ³•ã€‚</p>
<p>å¯¹äºç”¨æˆ·æ¥è¯´ï¼Œæœ€é‡è¦çš„å±æ€§æ˜¯ <code>Job#data</code> ï¼Œå®ƒåŒ…æ‹¬è¢«ä¼ é€’ç»™<a href="#queueadd"><code>Queue#add</code></a>çš„å¯¹è±¡ï¼Œé€šå¸¸ç”¨äºæ‰§è¡Œä½œä¸šã€‚</p>
<h3 id="jobprogress">Job#progress</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">progress</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">progress?</span>: <span style="color:#204a87;font-weight:bold">number</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">object</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span>
</span></span></code></pre></div><p>å¦‚æœä½¿ç”¨å‚æ•°è°ƒç”¨ï¼Œåˆ™æ›´æ–°ä½œä¸šè¿›åº¦ã€‚
å¦‚æœæ²¡æœ‰å‚æ•°è°ƒç”¨ï¼Œåˆ™è¿”å›ä¸€ä¸ªè§£æå½“å‰ä½œä¸šè¿›åº¦çš„ promiseã€‚</p>
<h4 id="arguments">Arguments</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>  <span style="color:#000">progress</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">Job</span> <span style="color:#000">progress</span> <span style="color:#000">number</span> <span style="color:#000">or</span> <span style="color:#000">any</span> <span style="color:#000">serializable</span> <span style="color:#000">object</span> <span style="color:#000">representing</span> <span style="color:#000">progress</span> <span style="color:#000">or</span> <span style="color:#000">similar</span><span style="color:#000;font-weight:bold">.</span>
</span></span></code></pre></div><hr>
<h3 id="joblog">Job#log</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">row</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span>
</span></span></code></pre></div><p>å‘æ­¤ä½œä¸šç‰¹å®šçš„ä½œä¸šæ·»åŠ æ—¥å¿—è¡Œã€‚
å¯ä»¥ä½¿ç”¨<a href="#queuegetjoblogs">Queue#getJobLogs</a>æ£€ç´¢æ—¥å¿—ã€‚</p>
<hr>
<h3 id="jobgetstate">Job#getState</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getState</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span>
</span></span></code></pre></div><p>è¿”å›ä¸€ä¸ªæ‰¿è¯ºï¼Œè§£æå½“å‰ä½œä¸šçš„çŠ¶æ€(å®Œæˆã€å¤±è´¥ã€å»¶è¿Ÿç­‰)ã€‚
å¯èƒ½çš„è¿”å›æœ‰:å®Œæˆçš„ã€å¤±è´¥çš„ã€å»¶è¿Ÿçš„ã€æ´»åŠ¨çš„ã€ç­‰å¾…çš„ã€æš‚åœçš„ã€å¡ä½çš„æˆ– nullã€‚</p>
<p>è¯·æ³¨æ„ï¼Œè¯¥æ–¹æ³•çš„å®ç°æ•ˆç‡ä¸æ˜¯å¾ˆé«˜ï¼Œä¹Ÿä¸æ˜¯åŸå­æ€§çš„ã€‚
å¦‚æœæ‚¨çš„é˜Ÿåˆ—ç¡®å®æœ‰å¤§é‡ä½œä¸šï¼Œæ‚¨å¯èƒ½å¸Œæœ›é¿å…ä½¿ç”¨æ­¤æ–¹æ³•ã€‚</p>
<hr>
<h3 id="jobupdate">Job#update</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span>: <span style="color:#204a87;font-weight:bold">object</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span>
</span></span></code></pre></div><p>ä½¿ç”¨ give data å¯¹è±¡æ›´æ–°äº†ä½œä¸šæ•°æ®å­—æ®µã€‚</p>
<h3 id="jobremove">Job#remove</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">remove</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span>
</span></span></code></pre></div><p>ä»é˜Ÿåˆ—å’Œå¯èƒ½åŒ…å«ä½œä¸šçš„ä»»ä½•åˆ—è¡¨ä¸­åˆ é™¤ä½œä¸šã€‚</p>
<h3 id="jobretry">Job#retry</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">retry</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span>
</span></span></code></pre></div><p>é‡æ–°è¿è¡Œå¤±è´¥çš„ä½œä¸šã€‚
è¿”å›ä¸€ä¸ªæ‰¿è¯ºï¼Œè¯¥æ‰¿è¯ºåœ¨ä½œä¸šè®¡åˆ’é‡è¯•æ—¶è§£å†³ã€‚</p>
<hr>
<h3 id="jobdiscard">Job#discard</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">discard</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span>
</span></span></code></pre></div><p>å³ä½¿ <code>attemptsMade</code> å°äº <code>job.attempts</code> ï¼Œä¹Ÿç¡®ä¿ä¸å†è¿è¡Œæ­¤ä½œä¸šã€‚</p>
<h3 id="jobpromote">Job#promote</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">promote</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span>
</span></span></code></pre></div><p>å°†å½“å‰è¢« <code>å»¶è¿Ÿ</code> çš„ä½œä¸šæå‡åˆ° <code>ç­‰å¾…</code> çŠ¶æ€ï¼Œå¹¶å°½å¿«æ‰§è¡Œã€‚</p>
<h3 id="jobfinished">Job#finished</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">finished</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span>
</span></span></code></pre></div><p>è¿”å›ä¸€ä¸ªæ‰¿è¯ºï¼Œè¯¥æ‰¿è¯ºåœ¨ä»»åŠ¡å®Œæˆæˆ–å¤±è´¥æ—¶è§£ææˆ–æ‹’ç»ã€‚</p>
<h3 id="jobmovetocompleted">Job#moveToCompleted</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">moveToCompleted</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">returnValue</span>: <span style="color:#204a87;font-weight:bold">any</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ignoreLock</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">notFetch?</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#a40000">[</span><span style="color:#c4a000">Jobdata</span><span style="color:#a40000">,</span> <span style="color:#c4a000">JobId</span><span style="color:#a40000">]</span> <span style="color:#a40000">|</span> <span style="color:#c4a000">null</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>å°†ä½œä¸šç§»åŠ¨åˆ° <code>å·²å®Œæˆ</code> é˜Ÿåˆ—ã€‚
å°†ä¸€ä¸ªä½œä¸šä»<code>waiting</code>æ‹‰åˆ°<code>active</code>ï¼Œå¹¶è¿”å›ä¸€ä¸ªåŒ…å«ä¸‹ä¸€ä¸ªä½œä¸šæ•°æ®å’Œ id çš„å…ƒç»„ã€‚
å¦‚æœ <code>ç­‰å¾…</code> é˜Ÿåˆ—ä¸­æ²¡æœ‰ä½œä¸šï¼Œåˆ™è¿”å› nullã€‚
è®¾ç½® <code>notFetch</code> ä¸º true ä»¥é¿å…é¢„å–é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªä½œä¸šã€‚</p>
<hr>
<h3 id="jobmovetofailed">Job#moveToFailed</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">moveToFailed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errorInfo</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#000;font-weight:bold">{</span> <span style="color:#000">message</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#000">ignoreLock?</span>:<span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#a40000">[</span><span style="color:#c4a000">Jobdata</span><span style="color:#a40000">,</span> <span style="color:#c4a000">JobId</span><span style="color:#a40000">]</span> <span style="color:#a40000">|</span> <span style="color:#c4a000">null</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>å°†ä½œä¸šç§»åŠ¨åˆ° <code>å¤±è´¥</code> é˜Ÿåˆ—ã€‚
å°†ä¸€ä¸ªä½œä¸šä»<code>waiting</code>æ‹‰åˆ°<code>active</code>ï¼Œå¹¶è¿”å›ä¸€ä¸ªåŒ…å«ä¸‹ä¸€ä¸ªä½œä¸šæ•°æ®å’Œ id çš„å…ƒç»„ã€‚
å¦‚æœ <code>ç­‰å¾…</code> é˜Ÿåˆ—ä¸­æ²¡æœ‰ä½œä¸šï¼Œåˆ™è¿”å› nullã€‚</p>
<hr>
<h2 id="æ´»åŠ¨">æ´»åŠ¨</h2>
<p>é˜Ÿåˆ—ä¹Ÿä¼šå‘å‡ºä¸€äº›æœ‰ç”¨çš„äº‹ä»¶:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;error&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// An error occured.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;waiting&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">jobId</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// A Job is waiting to be processed as soon as a worker is idling.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;active&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">jobPromise</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// A job has started.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// You can use `jobPromise.cancel()`` to abort it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;stalled&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// A job has been marked as stalled.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// This is useful for debugging job workers that crash or pause the event loop.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;lock-extension-failed&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// A job failed to extend lock.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// This will be useful to debug redis connection issues and jobs getting restarted because workers are not able to extend locks.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;progress&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">progress</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// A job&#39;s progress was updated!
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;completed&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// A job successfully completed with a `result`.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;failed&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// A job failed with reason `err`!
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;paused&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// The queue has been paused.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;resumed&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// The queue has been resumed.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;cleaned&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">jobs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">type</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// Old jobs have been cleaned from the queue.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#4e9a06">`jobs`</span> <span style="color:#000">is</span> <span style="color:#000">an</span> <span style="color:#000">array</span> <span style="color:#204a87;font-weight:bold">of</span> <span style="color:#000">cleaned</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// jobs, and `type` is the type of jobs cleaned.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;drained&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// Emitted every time the queue has processed all the waiting jobs (even if there can be some delayed jobs not yet processed)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;removed&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// A job successfully removed.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><h3 id="å…¨å±€äº‹ä»¶">å…¨å±€äº‹ä»¶</h3>
<p>äº‹ä»¶åœ¨é»˜è®¤æƒ…å†µä¸‹æ˜¯æœ¬åœ°çš„â€”â€”æ¢å¥è¯è¯´ï¼Œå®ƒä»¬åªè§¦å‘åœ¨ç»™å®š worker ä¸Šæ³¨å†Œçš„ä¾¦å¬å™¨ã€‚
å¦‚æœä½ éœ€è¦å…¨å±€ç›‘å¬äº‹ä»¶ï¼Œä¾‹å¦‚æ¥è‡ªå…¶ä»–æœåŠ¡å™¨çš„äº‹ä»¶ï¼Œåªéœ€åœ¨äº‹ä»¶å‰åŠ ä¸Š<code>global: ''</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Will listen locally, just to this queue...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;completed&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">listener</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Will listen globally, to instances of this queue...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;global:completed&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">listener</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>å½“å¤„ç†å…¨å±€äº‹ä»¶æ—¶ï¼Œå±€éƒ¨äº‹ä»¶å°†ä¸€ä¸ª <code>Job</code> å®ä¾‹ä¼ é€’ç»™äº‹ä»¶ç›‘å¬å™¨å›è°ƒï¼Œæ³¨æ„å…¨å±€äº‹ä»¶ä¼ é€’çš„æ˜¯ä½œä¸šçš„ IDã€‚</p>
<p>å¦‚æœä½ éœ€è¦åœ¨å…¨å±€ç›‘å¬å™¨ä¸­è®¿é—® <code>Job</code> å®ä¾‹ï¼Œä½¿ç”¨<a href="#queuegetjob">Queue#getJob</a>æ¥æ£€ç´¢å®ƒã€‚
ä½†æ˜¯ï¼Œè¯·è®°ä½ï¼Œå¦‚æœåœ¨æ·»åŠ ä½œä¸šæ—¶å¯ç”¨äº† <code>removeOnComplete</code> ï¼Œåˆ™ä½œä¸šåœ¨å®Œæˆåå°†ä¸å†å¯ç”¨ã€‚
å¦‚æœæ‚¨éœ€è¦è®¿é—®ä½œä¸šå¹¶åœ¨å®Œæˆååˆ é™¤å®ƒï¼Œæ‚¨å¯ä»¥ä½¿ç”¨<a href="#jobremove">job #remove</a>åœ¨ä¾¦å¬å™¨ä¸­åˆ é™¤å®ƒã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Local events pass the job instance...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;progress&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">progress</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`Job </span><span style="color:#4e9a06">${</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> is </span><span style="color:#4e9a06">${</span><span style="color:#000">progress</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">% ready!`</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;completed&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`Job </span><span style="color:#4e9a06">${</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> completed! Result: </span><span style="color:#4e9a06">${</span><span style="color:#000">result</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">remove</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ...whereas global events only pass the job ID:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;global:progress&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">jobId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">progress</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`Job </span><span style="color:#4e9a06">${</span><span style="color:#000">jobId</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> is </span><span style="color:#4e9a06">${</span><span style="color:#000">progress</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">% ready!`</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;global:completed&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">jobId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`Job </span><span style="color:#4e9a06">${</span><span style="color:#000">jobId</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> completed! Result: </span><span style="color:#4e9a06">${</span><span style="color:#000">result</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getJob</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">jobId</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">remove</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ad94521a760596fc6e71a48e245b8ae8">4 - æ¨¡å¼</h1>
    <div class="lead">ä¸‹é¢æ˜¯ä¸€äº›å¸¸ç”¨çš„ç”¨Bullå®ç°çš„æ¨¡å¼çš„ä¾‹å­</div>
	<ul>
<li><a href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97">æ¶ˆæ¯é˜Ÿåˆ—</a></li>
<li><a href="#%E8%BF%94%E5%9B%9E%E5%B7%A5%E4%BD%9C%E5%AE%8C%E6%88%90">è¿”å›å·¥ä½œå®Œæˆ</a></li>
<li><a href="#%E9%87%8D%E7%94%A8-redis-%E8%BF%9E%E6%8E%A5">é‡ç”¨ Redis è¿æ¥</a></li>
<li><a href="#redis-%E9%9B%86%E7%BE%A4">Redis é›†ç¾¤</a></li>
<li><a href="#%E8%B0%83%E8%AF%95">è°ƒè¯•</a></li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A1%A5%E5%81%BF%E7%AD%96%E7%95%A5">è‡ªå®šä¹‰è¡¥å¿ç­–ç•¥</a></li>
<li><a href="#%E6%89%8B%E5%8A%A8%E6%8A%93%E5%8F%96%E5%B7%A5%E4%BD%9C">æ‰‹åŠ¨æŠ“å–å·¥ä½œ</a></li>
</ul>
<p>å¦‚æœä½ æœ‰ä»»ä½•å…¶ä»–ä½ æƒ³è¦æ·»åŠ çš„å¸¸è§æ¨¡å¼ï¼Œæ‹‰è¯·æ±‚å®ƒä»¬!</p>
<h2 id="æ¶ˆæ¯é˜Ÿåˆ—">æ¶ˆæ¯é˜Ÿåˆ—</h2>
<p>Bull ä¹Ÿå¯ä»¥ç”¨äºæŒä¹…æ¶ˆæ¯é˜Ÿåˆ—ã€‚
åœ¨æŸäº›ç”¨ä¾‹ä¸­ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„ç‰¹æ€§ã€‚
ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥æœ‰ä¸¤ä¸ªéœ€è¦ç›¸äº’é€šä¿¡çš„æœåŠ¡å™¨ã€‚
é€šè¿‡ä½¿ç”¨é˜Ÿåˆ—ï¼ŒæœåŠ¡å™¨ä¸éœ€è¦åŒæ—¶åœ¨çº¿ï¼Œå› æ­¤è¿™åˆ›å»ºäº†ä¸€ä¸ªéå¸¸å¥å£®çš„é€šä¿¡é€šé“ã€‚
ä½ å¯ä»¥æŠŠ&rsquo; add &lsquo;å½“ä½œ<em>send</em>ï¼ŒæŠŠ&rsquo; process &lsquo;å½“ä½œ<em>receive</em>:</p>
<p>æœåŠ¡å™¨:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Queue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;bull&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">sendQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Server B&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">receiveQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Server A&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">receiveQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">done</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Received message&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">msg</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">done</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">sendQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Hello&#34;</span> <span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>Server B:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Queue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;bull&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">sendQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Server A&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">receiveQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Server B&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">receiveQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">done</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Received message&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">msg</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">done</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">sendQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;World&#34;</span> <span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><h2 id="è¿”å›å·¥ä½œå®Œæˆ">è¿”å›å·¥ä½œå®Œæˆ</h2>
<p>ä¸€ç§å¸¸è§çš„æ¨¡å¼æ˜¯ï¼Œæ‚¨æœ‰ä¸€ä¸ªé˜Ÿåˆ—å¤„ç†å™¨é›†ç¾¤ï¼Œä»¥å°½å¯èƒ½å¿«çš„é€Ÿåº¦å¤„ç†ä½œä¸šï¼Œè€Œå…¶ä»–ä¸€äº›æœåŠ¡éœ€è¦è·å–è¯¥å¤„ç†å™¨çš„ç»“æœå¹¶å¯¹å…¶è¿›è¡Œå¤„ç†ï¼Œå¯èƒ½ä¼šå°†ç»“æœå­˜å‚¨åœ¨æ•°æ®åº“ä¸­ã€‚</p>
<p>å®ç°è¿™ä¸€ç›®æ ‡çš„æœ€å¥å£®å’Œå¯ä¼¸ç¼©çš„æ–¹æ³•æ˜¯å°†æ ‡å‡†ä½œä¸šé˜Ÿåˆ—ä¸æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å¼ç»“åˆèµ·æ¥:æœåŠ¡åªéœ€æ‰“å¼€ä½œä¸šé˜Ÿåˆ—å¹¶å‘å…¶æ·»åŠ ä½œä¸šï¼Œå°±å¯ä»¥å°†ä½œä¸šå‘é€åˆ°é›†ç¾¤ï¼Œé›†ç¾¤å°†ä»¥å°½å¯èƒ½å¿«çš„é€Ÿåº¦å¼€å§‹å¤„ç†ã€‚
æ¯å½“åœ¨é›†ç¾¤ä¸­å®Œæˆä¸€ä¸ªä½œä¸šæ—¶ï¼Œä¸€æ¡æ¶ˆæ¯å°±ä¼šè¿åŒç»“æœæ•°æ®å‘é€åˆ°ä¸€ä¸ªç»“æœæ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¿™ä¸ªé˜Ÿåˆ—ç”±ä¸€äº›å­˜å‚¨ç»“æœåˆ°æ•°æ®åº“ä¸­çš„å…¶ä»–æœåŠ¡è¿›è¡Œä¾¦å¬ã€‚</p>
<h2 id="é‡ç”¨-redis-è¿æ¥">é‡ç”¨ Redis è¿æ¥</h2>
<p>ä¸€ä¸ªæ ‡å‡†çš„é˜Ÿåˆ—éœ€è¦ 3 ä¸ªè¿æ¥åˆ° Redis æœåŠ¡å™¨ã€‚
åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‚¨å¯èƒ½å¸Œæœ›é‡ç”¨è¿æ¥â€”ä¾‹å¦‚åœ¨ Heroku ä¸­ï¼Œè¿æ¥æ•°æ˜¯å—é™åˆ¶çš„ã€‚
ä½ å¯ä»¥é€šè¿‡&rsquo; Queue &lsquo;æ„é€ å‡½æ•°ä¸­çš„&rsquo; createClient &lsquo;é€‰é¡¹æ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚</p>
<p>æ³¨:</p>
<ul>
<li>bclient è¿æ¥<a href="https://github.com/OptimalBits/bull/issues/880">ä¸èƒ½è¢«é‡ç”¨</a>ï¼Œæ‰€ä»¥ä½ åº”è¯¥è¿”å›ä¸€ä¸ªæ–°çš„è¿æ¥æ¯æ¬¡è°ƒç”¨ã€‚</li>
<li>å®¢æˆ·ç«¯å’Œè®¢é˜…è€…è¿æ¥å¯ä»¥å…±äº«ï¼Œå½“é˜Ÿåˆ—å…³é—­æ—¶ä¸ä¼šå…³é—­ã€‚
å½“æ‚¨å…³é—­è¿›ç¨‹æ—¶ï¼Œé¦–å…ˆå…³é—­é˜Ÿåˆ—ï¼Œç„¶åå…³é—­å…±äº«è¿æ¥(å¦‚æœå®ƒä»¬æ˜¯å…±äº«çš„)ã€‚</li>
<li>å¦‚æœä½ ä¸å…±äº«è¿æ¥,ä½†ä»ä½¿ç”¨â€œcreateClientâ€åšä¸€äº›å®šåˆ¶çš„è¿æ¥é€»è¾‘,ä½ å¯èƒ½ä»ç„¶éœ€è¦æ‚¨åˆ›å»ºçš„æ‰€æœ‰è¿æ¥çš„åˆ—è¡¨,è¿™æ ·ä½ å°±å¯ä»¥æ‰‹åŠ¨å…³é—­å,é˜Ÿåˆ—å…³é—­,å¦‚æœä½ éœ€è¦ä¼˜é›…çš„å…³é—­è¿‡ç¨‹</li>
<li>ä¸è¦åœ¨ä½ åˆ›å»ºçš„è¿æ¥ä¸Šè®¾ç½®ä¸€ä¸ªâ€œkeyPrefixâ€ï¼Œå¦‚æœä½ éœ€è¦ä¸€ä¸ªé”®å‰ç¼€ï¼Œä½¿ç”¨ bull çš„å†…ç½®å‰ç¼€ç‰¹æ€§</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">REDIS_URL</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">process</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">env</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ioredis&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">subscriber</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">opts</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// redisOpts here will contain at least a property of connectionName which will identify the queue based on its name
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">createClient</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">redisOpts</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;client&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">client</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">REDIS_URL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">redisOpts</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;subscriber&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">subscriber</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">subscriber</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">REDIS_URL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">redisOpts</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">subscriber</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;bclient&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">REDIS_URL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">redisOpts</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">default</span><span style="color:#ce5c00;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Unexpected connection type: &#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">type</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">queueFoo</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foobar&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">opts</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">queueQux</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;quxbaz&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">opts</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><h2 id="redis-é›†ç¾¤">Redis é›†ç¾¤</h2>
<p>Bull å†…éƒ¨å‡½æ•°éœ€è¦è·¨ä¸åŒé”®çš„åŸå­æ“ä½œã€‚
è¿™ç§è¡Œä¸ºæ‰“ç ´äº† Redis çš„é›†ç¾¤é…ç½®è§„åˆ™ã€‚
ä½†æ˜¯ï¼Œä»ç„¶å¯ä»¥é€šè¿‡ä½¿ç”¨é€‚å½“çš„ Bull å‰ç¼€é€‰é¡¹ä½œä¸ºé›†ç¾¤â€œæ•£åˆ—æ ‡ç­¾â€æ¥ä½¿ç”¨é›†ç¾¤ç¯å¢ƒã€‚
å“ˆå¸Œæ ‡ç­¾æ˜¯ç”¨æ¥ä¿è¯æŸäº›é”®è¢«æ”¾ç½®åœ¨ç›¸åŒçš„å“ˆå¸Œæ§½ï¼Œé˜…è¯»æ›´å¤šå…³äºå“ˆå¸Œæ ‡ç­¾åœ¨<a href="https://redis.io/topics/cluster-tutorial">redis é›†ç¾¤æ•™ç¨‹</a>ã€‚
æ•£åˆ—æ ‡è®°ç”¨æ‹¬å·å®šä¹‰ã€‚
ä¾‹å¦‚ï¼Œä¸€ä¸ªé”®åœ¨æ‹¬å·å†…æœ‰ä¸€ä¸ªå­å­—ç¬¦ä¸²ï¼Œå°†ä½¿ç”¨è¯¥å­å­—ç¬¦ä¸²æ¥ç¡®å®šè¯¥é”®å°†è¢«æ”¾ç½®åœ¨å“ªä¸ªå“ˆå¸Œæ§½ä¸­ã€‚</p>
<p>æ€»ä¹‹ï¼Œä¸ºäº†ä½¿ Bull ä¸ Redis é›†ç¾¤å…¼å®¹ï¼Œåœ¨æ‹¬å·å†…ä½¿ç”¨é˜Ÿåˆ—å‰ç¼€ã€‚</p>
<p>ä¾‹å¦‚:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">queue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;cluster&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">prefix</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;{myprefix}&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>å¦‚æœåœ¨åŒä¸€ä¸ªé›†ç¾¤ä¸­ä½¿ç”¨å¤šä¸ªé˜Ÿåˆ—ï¼Œåˆ™åº”è¯¥ä½¿ç”¨ä¸åŒçš„å‰ç¼€ï¼Œä»¥ä¾¿å°†è¿™äº›é˜Ÿåˆ—å‡åŒ€åœ°æ”¾ç½®åœ¨é›†ç¾¤èŠ‚ç‚¹ä¸­ã€‚</p>
<h2 id="è°ƒè¯•">è°ƒè¯•</h2>
<p>è¦æŸ¥çœ‹è°ƒè¯•è¯­å¥ï¼Œè®¾ç½®æˆ–æ·»åŠ &rsquo; bull &lsquo;åˆ°&rsquo; NODE_DEBUG &lsquo;ç¯å¢ƒå˜é‡:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">NODE_DEBUG</span><span style="color:#ce5c00;font-weight:bold">=</span>bull
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">NODE_DEBUG</span><span style="color:#ce5c00;font-weight:bold">=</span>bull node ./your-script.js
</span></span></code></pre></div><h2 id="è‡ªå®šä¹‰è¡¥å¿ç­–ç•¥">è‡ªå®šä¹‰è¡¥å¿ç­–ç•¥</h2>
<p>å½“é‡è¯•æ—¶å†…ç½®çš„å›é€€ç­–ç•¥ä¸å¤Ÿç”¨æ—¶ï¼Œå¯ä»¥å®šä¹‰è‡ªå®šä¹‰ç­–ç•¥ã€‚
è‡ªå®šä¹‰å›é€€ç­–ç•¥ç”±é˜Ÿåˆ—ä¸Šçš„å‡½æ•°å®šä¹‰ã€‚
å·²å°è¯•å¤„ç†ä½œä¸šçš„æ¬¡æ•°ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’ç»™è¯¥å‡½æ•°ï¼Œä½œä¸šå¤±è´¥çš„é”™è¯¯ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ä¼ é€’ç»™è¯¥å‡½æ•°ã€‚
è¯¥å‡½æ•°è¿”å›å»¶è¿Ÿé‡è¯•çš„æ—¶é—´ï¼Œ0 è¡¨ç¤ºç«‹å³é‡è¯•ï¼Œ-1 è¡¨ç¤ºç«‹å³å¤±è´¥ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Queue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;bull&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">myQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Server B&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">settings</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">backoffStrategies</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">jitter</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">attemptsMade</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">5000</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87">Math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">random</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">500</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>ç„¶åï¼Œå¯ä»¥ä½¿ç”¨ä¸Šé¢å®šä¹‰çš„åç§°åœ¨ä½œä¸šä¸­æŒ‡å®šæ–°çš„å›é€€ç­–ç•¥:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000">myQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;bar&#34;</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">attempts</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">backoff</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;jitter&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>ä½ å¯ä»¥ä¸ºä½ çš„ç­–ç•¥æŒ‡å®šé€‰é¡¹:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Queue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;bull&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">myQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Server B&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">settings</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">backoffStrategies</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic">// truncated binary exponential backoff
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">binaryExponential</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">attemptsMade</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Options can be undefined, you need to handle it by yourself
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">options</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{};</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">delay</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">delay</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">truncate</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">truncate</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">attemptsMade</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">Math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">round</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">Math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">random</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">Math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">Math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">attemptsMade</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">truncate</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">delay</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">myQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;bar&#34;</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">attempts</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">backoff</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;binaryExponential&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">options</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">delay</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">500</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">truncate</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>ä½ å¯ä»¥æ ¹æ®å·¥ä½œä¸­å‡ºç°çš„é”™è¯¯æ¥åˆ¶å®šé€€æ­¥ç­–ç•¥:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Queue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;bull&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">MySpecificError</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">myQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Server C&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">settings</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">backoffStrategies</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">attemptsMade</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">instanceof</span> <span style="color:#000">MySpecificError</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">myQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">done</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">msg</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;Specific Error&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">MySpecificError</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">myQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Hello&#34;</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">attempts</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">backoff</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">myQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Specific Error&#34;</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">attempts</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">backoff</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><h2 id="æ‰‹åŠ¨æŠ“å–å·¥ä½œ">æ‰‹åŠ¨æŠ“å–å·¥ä½œ</h2>
<p>å¦‚æœæ‚¨å¸Œæœ›å®é™…çš„ä½œä¸šå¤„ç†åœ¨ä¸€ä¸ªå•ç‹¬çš„ repo/æœåŠ¡ä¸­å®Œæˆï¼Œè€Œä¸æ˜¯åœ¨è¿è¡Œ&rsquo; bull &lsquo;çš„åœ°æ–¹ï¼Œè¿™ä¸ªæ¨¡å¼å¯èƒ½é€‚åˆæ‚¨ã€‚</p>
<p>å¯ä»¥ä½¿ç”¨å‡ ä¸ªç®€å•çš„æ–¹æ³•æ¥æ‰‹åŠ¨è½¬æ¢ä½œä¸šçš„çŠ¶æ€ã€‚</p>
<ol>
<li>
<p>å‘&rsquo;waiting&rsquo;é˜Ÿåˆ—æ·»åŠ ä½œä¸šã€‚è·å–é˜Ÿåˆ—å¹¶è°ƒç”¨&rsquo; add &lsquo;ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">Queue</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;bull&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">queue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">limiter</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">max</span>: <span style="color:#204a87;font-weight:bold">5</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">duration</span>: <span style="color:#204a87;font-weight:bold">5000</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bounceBack</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// important
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">...</span><span style="color:#000">queueOptions</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">random_attr</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;random_value&#34;</span> <span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div></li>
<li>
<p>å°†ä»»åŠ¡ä»&rsquo;waiting&rsquo;ä¸­æ‹‰å‡ºå¹¶ç§»åŠ¨åˆ°&rsquo;active&rsquo;ä¸­ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">job</span>: <span style="color:#204a87;font-weight:bold">Job</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getNextJob</span><span style="color:#000;font-weight:bold">();</span>
</span></span></code></pre></div></li>
<li>
<p>å¦‚æœå‡ºç°é”™è¯¯ï¼Œå°†ä½œä¸šç§»åŠ¨åˆ°&rsquo;failed&rsquo;é˜Ÿåˆ—ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">nextJobData</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nextJobId</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">moveToFailed</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;Call to external service failed!&#39;</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div></li>
<li>
<p>å°†ä½œä¸šç§»åŠ¨åˆ°&rsquo;completed&rsquo;é˜Ÿåˆ—ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">nextJobData</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nextJobId</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">moveToCompleted</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;succeeded&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div></li>
<li>
<p>å¦‚æœæœ‰ä»»åŠ¡è¿”å›ï¼Œåˆ™è¿”å›ä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">nextJobdata</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">Job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">fromJSON</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nextJobData</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nextJobId</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div></li>
</ol>
<p><strong>æ³¨æ„</strong></p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œç”±&rsquo; getNextJob &lsquo;æˆ–&rsquo; moveToCompleted &lsquo;è¿”å›çš„ä½œä¸šçš„é”æŒç»­æ—¶é—´æ˜¯ 30 ç§’ï¼Œå¦‚æœå®ƒèŠ±è´¹çš„æ—¶é—´è¶…è¿‡ 30 ç§’ï¼Œä½œä¸šå°†è‡ªåŠ¨è¿”å›
æ ‡è®°ä¸ºæš‚åœï¼Œå¹¶æ ¹æ®æœ€å¤§æš‚åœé€‰é¡¹å°†ç§»åŠ¨å›ç­‰å¾…çŠ¶æ€æˆ–æ ‡è®°ä¸ºå¤±è´¥ã€‚
ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œæ‚¨å¿…é¡»ä½¿ç”¨&rsquo; job.extendLock(duration) &lsquo;ï¼Œä»¥ä¾¿åœ¨é”è¿‡æœŸå‰ç»™æ‚¨æ›´å¤šçš„æ—¶é—´ã€‚
å»ºè®®åœ¨é”æ—¶é—´è¿‡äº†ä¸€åŠåå»¶é•¿é”ã€‚</p>

</div>



    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="User mailing list" aria-label="User mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/mail" aria-label="User mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/twitter" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Stack Overflow" aria-label="Stack Overflow">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/stack" aria-label="Stack Overflow">
      <i class="fab fa-stack-overflow"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/google/docsy" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/slack" aria-label="Slack">
      <i class="fab fa-slack"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Developer mailing list" aria-label="Developer mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/mail" aria-label="Developer mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2022 kamilmysliwiec ä¿ç•™æ‰€æœ‰æƒåˆ©</small>
        <small class="ml-1"><a href="https://kamilmysliwiec.com/" target="_blank" rel="noopener">éšç§æ”¿ç­–</a></small>
	
		
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='/nestjs-docs/js/tabpane-persist.js'></script>


















<script src="/nestjs-docs/js/main.min.82227759f8f2ead5d4ac2028ff961235745a57120ee2f90ce8f820d05976f9bb.js" integrity="sha256-giJ3Wfjy6tXUrCAo/5YSNXRaVxIO4vkM6Pgg0Fl2&#43;bs=" crossorigin="anonymous"></script>




  </body>
</html>
