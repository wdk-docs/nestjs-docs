<!doctype html>
<html lang="zh-cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.88.1" />
<link rel="canonical" type="text/html" href="https://wdk-docs.github.io/nestjs-docs/docs/">
<link rel="alternate" type="application/rss&#43;xml" href="https://wdk-docs.github.io/nestjs-docs/docs/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/nestjs-docs/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/nestjs-docs/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/nestjs-docs/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/nestjs-docs/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/nestjs-docs/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/nestjs-docs/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/nestjs-docs/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/nestjs-docs/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/nestjs-docs/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/nestjs-docs/favicons/android-192x192.png" sizes="192x192">

<title>文档 | NestJS 文档</title>
<meta name="description" content="
https://wanago.io/courses/api-with-nestjs/


控制器、路由和模块结构
用 TypeORM 建立一个 PostgreSQL 数据库
使用 bcrypt、Passport、JWT 和 cookie 对用户进行身份验证
错误处理和数据验证
用拦截器序列化响应
 …">
<meta property="og:title" content="文档" />
<meta property="og:description" content="NestJs 文档" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://wdk-docs.github.io/nestjs-docs/docs/" /><meta property="og:site_name" content="NestJS 文档" />

<meta itemprop="name" content="文档">
<meta itemprop="description" content="NestJs 文档"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="文档"/>
<meta name="twitter:description" content="NestJs 文档"/>




<link rel="preload" href="/nestjs-docs/scss/main.min.90983698afafd407e6b72e83a2b749ff1726e8502277108f05bd66510938dec2.css" as="style">
<link href="/nestjs-docs/scss/main.min.90983698afafd407e6b72e83a2b749ff1726e8502277108f05bd66510938dec2.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-00000000-0', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/nestjs-docs/">
		<span class="navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="text-uppercase font-weight-bold">NestJS 文档</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="/nestjs-docs/docs/" ><span class="active">文档</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/nestjs-docs/blog/" ><span>博客</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"><input type="search" class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label="站内搜索…" autocomplete="off">
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href="#" onclick="print();return false;">点击此处打印</a>.
</p><p>
<a href="/nestjs-docs/docs/">返回本页常规视图</a>.
</p>
</div>



<h1 class="title">文档</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-7f305cdec2ded6dc7422877b33cadd3a">validator</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>1.1: <a href="#pg-fef1bcec9e28d82005af68a6958d6cba">class-validator</a></li>


    
  
    
    
	
<li>1.2: <a href="#pg-dc8d9bde5ab50bdea8564d5e73547fd5">class-transformer</a></li>


    
  

    </ul>
    
  
    
    
	
<li>2: <a href="#pg-90df5218158c4d01fc01a3fa3bcb9ad2">mongodb</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>2.1: <a href="#pg-ee82b5a9ba57222a5fbfd0b80a49cfa9">MongoDB概论</a></li>


    
  
    
    
	
<li>2.2: <a href="#pg-dcc33887b60b5620de8e60d4faae18bc">实现与MongoDB的关系</a></li>


    
  
    
    
	
<li>2.3: <a href="#pg-4451ab685262406c61d37462ff2cf30c">MongoDB和Mongoose的虚拟属性</a></li>


    
  
    
    
	
<li>2.4: <a href="#pg-d6a0d2e2730441d8a1bbcc80b1877247">与MongoDB和Mongoose管理事务</a></li>


    
  
    
    
	
<li>2.5: <a href="#pg-9dafda6a3ad4a457c936f5058f3f4460">使用MongoDB和Mongoose实现分页</a></li>


    
  
    
    
	
<li>2.6: <a href="#pg-9fc52bf385551b755df4c394152ea50c">使用MongoDB和Mongoose定义索引</a></li>


    
  
    
    
	
<li>2.7: <a href="#pg-87745293d49493ba2db7754c111a3568">用PUT和PATCH更新MongoDB和Mongoose</a></li>


    
  

    </ul>
    
  
    
    
	
<li>3: <a href="#pg-b64b7e1b4aa2d437b41e6919a564206e">files</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.1: <a href="#pg-a5ce0f5e673a67cd6c90e83f6e52b6e1">Uploading files to the server</a></li>


    
  

    </ul>
    
  
    
    
	
<li>4: <a href="#pg-72a7b9da75676e436dce77dd4f1befe5">awesome</a></li>


    
  
    
    
	
<li>5: <a href="#pg-02c29c90afd6cfbed2cfac0ea833a678">bull</a></li>


    
  
    
    
	
<li>6: <a href="#pg-c709471c70f27c6bb15b128d75977220">http</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>6.1: <a href="#pg-42a26675b19acc37e7dbc0e2c8d454d2">axios</a></li>


    
  
    
    
	
<li>6.2: <a href="#pg-dd26dd96b691f783eb7fff9d7bf21702">@narando/nest-axios-interceptor</a></li>


    
  
    
    
	
<li>6.3: <a href="#pg-bd61d63598630dbbb21d96e9ff9b7e80">axios-auth-refresh</a></li>


    
  
    
    
	
<li>6.4: <a href="#pg-ac7867d0efde557b312fc601141a570b">`node-cache-manager` - 灵活的NodeJS缓存模块</a></li>


    
  

    </ul>
    
  

    </ul>


<div class="content">
      <blockquote>
<p><a href="https://wanago.io/courses/api-with-nestjs/">https://wanago.io/courses/api-with-nestjs/</a></p>
</blockquote>
<ol>
<li>控制器、路由和模块结构</li>
<li>用 TypeORM 建立一个 PostgreSQL 数据库</li>
<li>使用 bcrypt、Passport、JWT 和 cookie 对用户进行身份验证</li>
<li>错误处理和数据验证</li>
<li>用拦截器序列化响应</li>
<li>研究依赖注入和模块</li>
<li>创建与 Postgres 和 TypeORM 的关系</li>
<li>编写单元测试</li>
<li>使用集成测试测试服务和控制器</li>
<li>上传公共文件到 Amazon S3</li>
<li>使用 Amazon S3 管理私有文件</li>
<li>介绍 Elasticsearch</li>
<li>使用 JWT 实现刷新令牌</li>
<li>使用索引提高 Postgres 数据库的性能</li>
<li>用 PostgreSQL 和 TypeORM 定义事务</li>
<li>使用数组数据类型与 PostgreSQL 和 TypeORM</li>
<li>使用 PostgreSQL 和 TypeORM 进行偏移和键集分页</li>
<li>探索微服务的理念</li>
<li>使用 RabbitMQ 与微服务通信</li>
<li>使用 gRPC 框架与微服务通信</li>
<li>CQRS 的介绍</li>
<li>用 PostgreSQL 和 TypeORM 存储 JSON</li>
<li>实现内存缓存以提高性能</li>
<li>缓存与复述。在 Node.js 集群中运行应用</li>
<li>使用 cron 和 Nodemailer 发送预定的电子邮件</li>
<li>与 WebSockets 的实时聊天</li>
<li>GraphQL 概论。查询、修改和身份验证</li>
<li>处理 GraphQL 中的 N + 1 问题</li>
<li>使用 GraphQL 订阅实现实时更新</li>
<li>GraphQL 中的标量类型</li>
<li>双因素身份验证</li>
<li>介绍 Prisma 与 PostgreSQL</li>
<li>管理 PostgreSQL 与 Prisma 的关系</li>
<li>使用队列处理 cpu 密集型任务</li>
<li>使用服务器端会话而不是 JSON Web 令牌</li>
<li>介绍带 React 的条纹</li>
<li>使用 Stripe 保存信用卡以备将来使用</li>
<li>通过订阅设置分期付款</li>
<li>用 webhook 对 Stripe 事件做出反应</li>
<li>确认邮箱地址</li>
<li>验证电话号码和发送短信与 Twilio</li>
<li>使用谷歌对用户进行认证</li>
<li>MongoDB 概论</li>
<li>与 MongoDB 实现关系</li>
<li>MongoDB 和 Mongoose 的虚拟财产</li>
<li>MongoDB 和 Mongoose 管理事务</li>
<li>用 MongoDB 和 Mongoose 实现分页</li>
<li>用 MongoDB 和 Mongoose 定义索引</li>
<li>MongoDB 和 Mongoose 的 PUT 和 PATCH 更新</li>
<li>介绍使用内置记录器和 TypeORM 进行日志记录</li>
<li>使用终端和数据狗进行运行状况检查</li>
<li>使用 Compodoc 和 JSDoc 生成文档</li>
<li>使用 PostgreSQL 和 TypeORM 实现软删除</li>
<li>在 PostgreSQL 数据库中存储文件</li>
<li>上传文件到服务器</li>
<li>使用角色和声明进行授权</li>
<li>使用 mixin 模式组合类</li>
<li>使用 ETag 实现缓存和节省带宽</li>
<li>介绍一个与 Lerna 和 Yarn 工作空间的单簧管</li>
<li>OpenAPI 规范和 Swagger</li>
<li>处理循环依赖关系</li>
</ol>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7f305cdec2ded6dc7422877b33cadd3a">1 - validator</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-fef1bcec9e28d82005af68a6958d6cba">1.1 - class-validator</h1>
    
	<p><img src="https://github.com/typestack/class-validator/workflows/CI/badge.svg" alt="Build Status">
<a href="https://codecov.io/gh/typestack/class-validator"><img src="https://codecov.io/gh/typestack/class-validator/branch/develop/graph/badge.svg" alt="codecov"></a>
<a href="https://badge.fury.io/js/class-validator"><img src="https://badge.fury.io/js/class-validator.svg" alt="npm version"></a>
<a href="https://packagephobia.now.sh/result?p=class-validator"><img src="https://packagephobia.now.sh/badge?p=class-validator" alt="install size"></a></p>
<p>允许使用基于装饰器和非装饰器的验证。
内部使用<a href="https://github.com/chriso/validator.js">validator.js</a>执行验证。
类验证器可以在浏览器和 node.js 平台上运行。</p>
<h2 id="安装">安装</h2>
<pre tabindex="0"><code>npm install class-validator --save
</code></pre><blockquote>
<p>Note: Please use at least npm@6 when using class-validator. From npm@6 the dependency tree is flattened, which is required by <code>class-validator</code> to function properly.</p>
</blockquote>
<h2 id="使用">使用</h2>
<p>Create your class and put some validation decorators on the properties you want to validate:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">validate</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">validateOrReject</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">Contains</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">IsInt</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">Length</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">IsEmail</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">IsFQDN</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">IsDate</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">Min</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">Max</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Contains</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;hello&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000">text</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@IsInt</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@Min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">@Max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000">rating</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@IsEmail</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@IsFQDN</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">site</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@IsDate</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">createDate</span>: <span style="color:#204a87;font-weight:bold">Date</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">post</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000">post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">title</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;Hello&#34;</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// should not pass
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">text</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;this is a great post about hell world&#34;</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// should not pass
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rating</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// should not pass
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">email</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;google.com&#34;</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// should not pass
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">site</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;googlecom&#34;</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// should not pass
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">errors</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// errors is an array of validation errors
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;validation failed. errors: &#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;validation succeed&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">validateOrReject</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">).</span><span style="color:#204a87;font-weight:bold">catch</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">errors</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Promise rejected (validation failed). Errors: &#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>
<span style="color:#8f5902;font-style:italic">// or
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">validateOrRejectExample</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">input</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">validateOrReject</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">input</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">errors</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Caught promise rejection (validation failed). Errors: &#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h3 id="传输选项">传输选项</h3>
<p><code>validate</code>函数的第二个参数是一个<code>ValidatorOptions</code>对象。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">ValidatorOptions</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">skipMissingProperties?</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">whitelist?</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">forbidNonWhitelisted?</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">groups?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">[];</span>
  <span style="color:#000">dismissDefaultMessages?</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">validationError</span><span style="color:#ce5c00;font-weight:bold">?:</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">target?</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000">value?</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">};</span>

  <span style="color:#000">forbidUnknownValues?</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">stopAtFirstError?</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p>It&rsquo;s highly advised to set <code>forbidUnknownValues: true</code> as it will prevent unknown objects from passing validation.</p>
</blockquote>
<h2 id="验证错误">验证错误</h2>
<p>' validate &lsquo;方法返回一个&rsquo; ValidationError &lsquo;对象数组。每个“ValidationError”是:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">target</span>: <span style="color:#204a87;font-weight:bold">Object</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Object that was validated.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">property</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Object&#39;s property that haven&#39;t pass validation.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">value</span>: <span style="color:#204a87;font-weight:bold">any</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Value that haven&#39;t pass a validation.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">constraints</span><span style="color:#ce5c00;font-weight:bold">?:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#8f5902;font-style:italic">// Constraints that failed validation with error messages.
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">};</span>
    <span style="color:#000">children?</span>: <span style="color:#204a87;font-weight:bold">ValidationError</span><span style="color:#000;font-weight:bold">[];</span> <span style="color:#8f5902;font-style:italic">// Contains all nested validation errors of the property
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>In our case, when we validated a Post object, we have such an array of <code>ValidationError</code> objects:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#000;font-weight:bold">[{</span>
    <span style="color:#000">target</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#8f5902;font-style:italic">/* post object */</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">property</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;title&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Hello&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">constraints</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">length</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;$property must be longer than or equal to 10 characters&#34;</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">target</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#8f5902;font-style:italic">/* post object */</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">property</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;text&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;this is a great post about hell world&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">constraints</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">contains</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;text must contain a hello string&#34;</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">},</span>
<span style="color:#8f5902;font-style:italic">// and other errors
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">]</span>
</code></pre></div><p>If you don&rsquo;t want a <code>target</code> to be exposed in validation errors, there is a special option when you use validator:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#000">validator</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">validationError</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">target</span>: <span style="color:#204a87;font-weight:bold">false</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>This is especially useful when you send errors back over http, and you most probably don&rsquo;t want to expose
the whole target object.</p>
<h2 id="验证消息">验证消息</h2>
<p>You can specify validation message in the decorator options and that message will be returned in the <code>ValidationError</code>
returned by the <code>validate</code> method (in the case that validation for this field fails).</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">MinLength</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">MaxLength</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@MinLength</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Title is too short&#34;</span> <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#204a87;font-weight:bold">@MaxLength</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">50</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Title is too long&#34;</span> <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>There are few special tokens you can use in your messages:</p>
<ul>
<li><code>$value</code> - the value that is being validated</li>
<li><code>$property</code> - name of the object&rsquo;s property being validated</li>
<li><code>$target</code> - name of the object&rsquo;s class being validated</li>
<li><code>$constraint1</code>, <code>$constraint2</code>, &hellip; <code>$constraintN</code> - constraints defined by specific validation type</li>
</ul>
<p>Example of usage:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">MinLength</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">MaxLength</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@MinLength</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// here, $constraint1 will be replaced with &#34;10&#34;, and $value with actual supplied value
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Title is too short. Minimal length is $constraint1 characters, but actual is $value&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#204a87;font-weight:bold">@MaxLength</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">50</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// here, $constraint1 will be replaced with &#34;50&#34;, and $value with actual supplied value
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Title is too long. Maximal length is $constraint1 characters, but actual is $value&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Also you can provide a function, that returns a message. This allows you to create more granular messages:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">MinLength</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">MaxLength</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ValidationArguments</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@MinLength</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span>: <span style="color:#204a87;font-weight:bold">ValidationArguments</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;Too short, minimum length is 1 character&#34;</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;Too short, minimum length is &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">constraints</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34; characters&#34;</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Message function accepts <code>ValidationArguments</code> which contains the following information:</p>
<ul>
<li><code>value</code> - the value that is being validated</li>
<li><code>constraints</code> - array of constraints defined by specific validation type</li>
<li><code>targetName</code> - name of the object&rsquo;s class being validated</li>
<li><code>object</code> - object that is being validated</li>
<li><code>property</code> - name of the object&rsquo;s property being validated</li>
</ul>
<h2 id="验证数组">验证数组</h2>
<p>If your field is an array and you want to perform validation of each item in the array you must specify a
special <code>each: true</code> decorator option:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">MinLength</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">MaxLength</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@MaxLength</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">each</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000">tags</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">[];</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>This will validate each item in <code>post.tags</code> array.</p>
<h2 id="验证集">验证集</h2>
<p>If your field is a set and you want to perform validation of each item in the set you must specify a
special <code>each: true</code> decorator option:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">MinLength</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">MaxLength</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@MaxLength</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">each</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000">tags</span>: <span style="color:#204a87;font-weight:bold">Set</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">&gt;;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>This will validate each item in <code>post.tags</code> set.</p>
<h2 id="验证图">验证图</h2>
<p>If your field is a map and you want to perform validation of each item in the map you must specify a
special <code>each: true</code> decorator option:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">MinLength</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">MaxLength</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@MaxLength</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">each</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000">tags</span>: <span style="color:#204a87;font-weight:bold">Map</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#a40000">,</span> <span style="color:#c4a000">string</span><span style="color:#000;font-weight:bold">&gt;;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>This will validate each item in <code>post.tags</code> map.</p>
<h2 id="验证嵌套对象">验证嵌套对象</h2>
<p>If your object contains nested objects and you want the validator to perform their validation too, then you need to
use the <code>@ValidateNested()</code> decorator:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ValidateNested</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@ValidateNested</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">user</span>: <span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Please note that nested object <em>must</em> be an instance of a class, otherwise <code>@ValidateNested</code> won&rsquo;t know what class is target of validation. Check also <a href="#validating-plain-objects">Validating plain objects</a>.</p>
<p>It also works with multi-dimensional array, like :</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ValidateNested</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Plan2D</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@ValidateNested</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">matrix</span>: <span style="color:#204a87;font-weight:bold">Point</span><span style="color:#000;font-weight:bold">[][];</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="验证承诺">验证承诺</h2>
<p>If your object contains property with <code>Promise</code>-returned value that should be validated, then you need to use the <code>@ValidatePromise()</code> decorator:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ValidatePromise</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Min</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">@ValidatePromise</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">userId</span>: <span style="color:#204a87;font-weight:bold">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">&gt;;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>It also works great with <code>@ValidateNested</code> decorator:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ValidateNested</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ValidatePromise</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@ValidateNested</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@ValidatePromise</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">user</span>: <span style="color:#204a87;font-weight:bold">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">&gt;;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="验证继承修饰符">验证继承修饰符</h2>
<p>When you define a subclass which extends from another one, the subclass will automatically inherit the parent&rsquo;s decorators. If a property is redefined in the descendant class decorators will be applied on it both from that and the base class.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">validate</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">BaseContent</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@IsEmail</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@IsString</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">password</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">BaseContent</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@MinLength</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">@MaxLength</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Contains</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;hello&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000">welcome</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@MinLength</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000">password</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">();</span>

<span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">email</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;invalid email&#34;</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// inherited property
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">password</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;too short&#34;</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// password wil be validated not only against IsString, but against MinLength as well
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;not valid&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">welcome</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;helo&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">errors</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// it will return errors for email, title and text properties
</span></code></pre></div><h2 id="有条件的验证">有条件的验证</h2>
<p>The conditional validation decorator (<code>@ValidateIf</code>) can be used to ignore the validators on a property when the provided condition function returns false. The condition function takes the object being validated and must return a <code>boolean</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ValidateIf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">IsNotEmpty</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">otherProperty</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@ValidateIf</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">o</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">otherProperty</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;value&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">@IsNotEmpty</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">example</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>In the example above, the validation rules applied to <code>example</code> won&rsquo;t be run unless the object&rsquo;s <code>otherProperty</code> is <code>&quot;value&quot;</code>.</p>
<p>Note that when the condition is false all validation decorators are ignored, including <code>isDefined</code>.</p>
<h2 id="白名单">白名单</h2>
<p>Even if your object is an instance of a validation class it can contain additional properties that are not defined.
If you do not want to have such properties on your object, pass special flag to <code>validate</code> method:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">validate</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">whitelist</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>This will strip all properties that don&rsquo;t have any decorators. If no other decorator is suitable for your property,
you can use @Allow decorator:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">validate</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Allow</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Min</span><span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>

    <span style="color:#204a87;font-weight:bold">@Allow</span><span style="color:#000;font-weight:bold">()</span>
    <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">@Min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000">views</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>

    <span style="color:#000">nonWhitelistedProperty</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">post</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000">post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">title</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;Hello world!&#39;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">views</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">420</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000">post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nonWhitelistedProperty</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">69</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">(</span><span style="color:#000">post</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#204a87;font-weight:bold">any</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">anotherNonWhitelistedProperty</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;something&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errors</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// post.nonWhitelistedProperty is not defined
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// (post as any).anotherNonWhitelistedProperty is not defined
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">...</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>If you would rather to have an error thrown when any non-whitelisted properties are present, pass another flag to
<code>validate</code> method:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">validate</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">whitelist</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">forbidNonWhitelisted</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><h2 id="将上下文传递给装饰器">将上下文传递给装饰器</h2>
<p>It&rsquo;s possible to pass a custom object to decorators which will be accessible on the <code>ValidationError</code> instance of the property if validation failed.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">validate</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">MyClass</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@MinLength</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;EIC code must be at least 32 characters&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">errorCode</span>: <span style="color:#204a87;font-weight:bold">1003</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">developerNote</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;The validated string must contain 32 or more characters.&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000">eicCode</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">model</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">MyClass</span><span style="color:#000;font-weight:bold">();</span>

<span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">model</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">errors</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">//errors[0].contexts[&#39;minLength&#39;].errorCode === 1003
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</code></pre></div><h2 id="跳过缺失的属性">跳过缺失的属性</h2>
<p>Sometimes you may want to skip validation of the properties that do not exist in the validating object. This is
usually desirable when you want to update some parts of the object, and want to validate only updated parts,
but skip everything else, e.g. skip missing properties.
In such situations you will need to pass a special flag to <code>validate</code> method:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">validate</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">skipMissingProperties</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>When skipping missing properties, sometimes you want not to skip all missing properties, some of them maybe required
for you, even if skipMissingProperties is set to true. For such cases you should use <code>@IsDefined()</code> decorator.
<code>@IsDefined()</code> is the only decorator that ignores <code>skipMissingProperties</code> option.</p>
<h2 id="验证组">验证组</h2>
<p>In different situations you may want to use different validation schemas of the same object.
In such cases you can use validation groups.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">validate</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Min</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Length</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">12</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">groups</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;registration&#34;</span><span style="color:#000;font-weight:bold">],</span>
  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000">age</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">groups</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;registration&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;admin&#34;</span><span style="color:#000;font-weight:bold">],</span>
  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">age</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;Alex&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">groups</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;registration&#34;</span><span style="color:#000;font-weight:bold">],</span>
<span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// this will not pass validation
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">groups</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;admin&#34;</span><span style="color:#000;font-weight:bold">],</span>
<span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// this will pass validation
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">groups</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;registration&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;admin&#34;</span><span style="color:#000;font-weight:bold">],</span>
<span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// this will not pass validation
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">groups</span>: <span style="color:#204a87;font-weight:bold">undefined</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// the default
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// this will not pass validation since all properties get validated regardless of their groups
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">groups</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[],</span>
<span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// this will not pass validation, (equivalent to &#39;groups: undefined&#39;, see above)
</span></code></pre></div><p>There is also a special flag <code>always: true</code> in validation options that you can use. This flag says that this validation
must be applied always no matter which group is used.</p>
<h2 id="自定义验证类">自定义验证类</h2>
<p>If you have custom validation logic you can create a <em>Constraint class</em>:</p>
<ol>
<li>
<p>First create a file, lets say <code>CustomTextLength.ts</code>, and define a new class:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ValidatorConstraint</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ValidatorConstraintInterface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ValidationArguments</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@ValidatorConstraint</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;customText&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">async</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span> <span style="color:#000;font-weight:bold">})</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">CustomTextLength</span> <span style="color:#204a87;font-weight:bold">implements</span> <span style="color:#000">ValidatorConstraintInterface</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">text</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span>: <span style="color:#204a87;font-weight:bold">ValidationArguments</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">text</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">text</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// for async validations you must return a Promise&lt;boolean&gt; here
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#000">defaultMessage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span>: <span style="color:#204a87;font-weight:bold">ValidationArguments</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// here you can provide default error message if validation failed
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;Text ($value) is too short or too long!&#34;</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>We marked our class with <code>@ValidatorConstraint</code> decorator.
You can also supply a validation constraint name - this name will be used as &ldquo;error type&rdquo; in ValidationError.
If you will not supply a constraint name - it will be auto-generated.</p>
<p>Our class must implement <code>ValidatorConstraintInterface</code> interface and its <code>validate</code> method,
which defines validation logic. If validation succeeds, method returns true, otherwise false.
Custom validator can be asynchronous, if you want to perform validation after some asynchronous
operations, simply return a promise with boolean inside in <code>validate</code> method.</p>
<p>Also we defined optional method <code>defaultMessage</code> which defines a default error message,
in the case that the decorator&rsquo;s implementation doesn&rsquo;t set an error message.</p>
</li>
</ol>
<ol start="2">
<li>
<p>Then you can use your new validation constraint in your class:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Validate</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">CustomTextLength</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./CustomTextLength&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">CustomTextLength</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Title is too short or long!&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Here we set our newly created <code>CustomTextLength</code> validation constraint for <code>Post.title</code>.</p>
</li>
<li>
<p>And use validator as usual:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">validate</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">errors</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</code></pre></div></li>
</ol>
<p>You can also pass constraints to your validator, like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Validate</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">CustomTextLength</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./CustomTextLength&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">CustomTextLength</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Wrong post title&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>And use them from <code>validationArguments</code> object:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ValidationArguments</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ValidatorConstraint</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ValidatorConstraintInterface</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@ValidatorConstraint</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">CustomTextLength</span> <span style="color:#204a87;font-weight:bold">implements</span> <span style="color:#000">ValidatorConstraintInterface</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">text</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">validationArguments</span>: <span style="color:#204a87;font-weight:bold">ValidationArguments</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">text</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">validationArguments</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">constraints</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">text</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">validationArguments</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">constraints</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="自定义验证修饰符">自定义验证修饰符</h2>
<p>You can also create a custom decorators. Its the most elegant way of using a custom validations.
Lets create a decorator called <code>@IsLongerThan</code>:</p>
<ol>
<li>
<p>Create a decorator itself:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">registerDecorator</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ValidationOptions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ValidationArguments</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">IsLongerThan</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">property</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">validationOptions?</span>: <span style="color:#204a87;font-weight:bold">ValidationOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">object</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87">Object</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">propertyName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">registerDecorator</span><span style="color:#000;font-weight:bold">({</span>
      <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;isLongerThan&#34;</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">target</span>: <span style="color:#204a87;font-weight:bold">object.constructor</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">propertyName</span>: <span style="color:#204a87;font-weight:bold">propertyName</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">constraints</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">property</span><span style="color:#000;font-weight:bold">],</span>
      <span style="color:#000">options</span>: <span style="color:#204a87;font-weight:bold">validationOptions</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">validator</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span>: <span style="color:#204a87;font-weight:bold">any</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span>: <span style="color:#204a87;font-weight:bold">ValidationArguments</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">relatedPropertyName</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">constraints</span><span style="color:#000;font-weight:bold">;</span>
          <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">relatedValue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">object</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#204a87;font-weight:bold">any</span><span style="color:#000;font-weight:bold">)[</span><span style="color:#000">relatedPropertyName</span><span style="color:#000;font-weight:bold">];</span>
          <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;string&#34;</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">relatedValue</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;string&#34;</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">relatedValue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// you can return a Promise&lt;boolean&gt; here as well, if you want to make async validation
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000;font-weight:bold">},</span>
      <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000;font-weight:bold">};</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div></li>
<li>
<p>Put it to use:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">IsLongerThan</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./IsLongerThan&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@IsLongerThan</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;title&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">/* you can also use additional validation options, like &#34;groups&#34; in your custom validation decorators. &#34;each&#34; is not supported */</span>
    <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Text must be longer than the title&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000">text</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div></li>
</ol>
<p>In your custom decorators you can also use <code>ValidationConstraint</code>.
Lets create another custom validation decorator called <code>IsUserAlreadyExist</code>:</p>
<ol>
<li>
<p>Create a ValidationConstraint and decorator:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">registerDecorator</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">ValidationOptions</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">ValidatorConstraint</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">ValidatorConstraintInterface</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">ValidationArguments</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@ValidatorConstraint</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#204a87;font-weight:bold">async</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">IsUserAlreadyExistConstraint</span> <span style="color:#204a87;font-weight:bold">implements</span> <span style="color:#000">ValidatorConstraintInterface</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userName</span>: <span style="color:#204a87;font-weight:bold">any</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span>: <span style="color:#204a87;font-weight:bold">ValidationArguments</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">UserRepository</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findOneByName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userName</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">IsUserAlreadyExist</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">validationOptions?</span>: <span style="color:#204a87;font-weight:bold">ValidationOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">object</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87">Object</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">propertyName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">registerDecorator</span><span style="color:#000;font-weight:bold">({</span>
      <span style="color:#000">target</span>: <span style="color:#204a87;font-weight:bold">object.constructor</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">propertyName</span>: <span style="color:#204a87;font-weight:bold">propertyName</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">options</span>: <span style="color:#204a87;font-weight:bold">validationOptions</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">constraints</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[],</span>
      <span style="color:#000">validator</span>: <span style="color:#204a87;font-weight:bold">IsUserAlreadyExistConstraint</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000;font-weight:bold">};</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>note that we marked our constraint that it will by async by adding <code>{ async: true }</code> in validation options.</p>
</li>
<li>
<p>And put it to use:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">IsUserAlreadyExist</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./IsUserAlreadyExist&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@IsUserAlreadyExist</span><span style="color:#000;font-weight:bold">({</span>
    <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;User $value already exists. Choose another name.&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div></li>
</ol>
<h2 id="使用服务容器">使用服务容器</h2>
<p>Validator supports service container in the case if want to inject dependencies into your custom validator constraint
classes. Here is example how to integrate it with <a href="https://github.com/pleerock/typedi">typedi</a>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Container</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;typedi&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">useContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Validator</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">// do this somewhere in the global application level:
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">useContainer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Container</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">validator</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Validator</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#8f5902;font-style:italic">// now everywhere you can inject Validator class which will go from the container
</span><span style="color:#8f5902;font-style:italic">// also you can inject classes using constructor injection into your custom ValidatorConstraint-s
</span></code></pre></div><h2 id="同步验证">同步验证</h2>
<p>If you want to perform a simple non async validation you can use <code>validateSync</code> method instead of regular <code>validate</code>
method. It has the same arguments as <code>validate</code> method. But note, this method <strong>ignores</strong> all async validations
you have.</p>
<h2 id="手动验证">手动验证</h2>
<p>There are several method exist in the Validator that allows to perform non-decorator based validation:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">isEmpty</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">isBoolean</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000">isEmpty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">isBoolean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><h2 id="验证修饰符">验证修饰符</h2>
<!-- Disable table formatting because Prettier messing it up. -->
<!-- prettier-ignore -->
<table>
<thead>
<tr>
<th>Decorator</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Common validation decorators</strong></td>
<td></td>
</tr>
<tr>
<td><code>@IsDefined(value: any)</code></td>
<td>Checks if value is defined (!== undefined, !== null). This is the only decorator that ignores skipMissingProperties option.</td>
</tr>
<tr>
<td><code>@IsOptional()</code></td>
<td>Checks if given value is empty (=== null, === undefined) and if so, ignores all the validators on the property.</td>
</tr>
<tr>
<td><code>@Equals(comparison: any)</code></td>
<td>Checks if value equals (&quot;===&quot;) comparison.</td>
</tr>
<tr>
<td><code>@NotEquals(comparison: any)</code></td>
<td>Checks if value not equal (&quot;!==&quot;) comparison.</td>
</tr>
<tr>
<td><code>@IsEmpty()</code></td>
<td>Checks if given value is empty (=== &lsquo;&rsquo;, === null, === undefined).</td>
</tr>
<tr>
<td><code>@IsNotEmpty()</code></td>
<td>Checks if given value is not empty (!== &lsquo;&rsquo;, !== null, !== undefined).</td>
</tr>
<tr>
<td><code>@IsIn(values: any[])</code></td>
<td>Checks if value is in a array of allowed values.</td>
</tr>
<tr>
<td><code>@IsNotIn(values: any[])</code></td>
<td>Checks if value is not in a array of disallowed values.</td>
</tr>
<tr>
<td><strong>Type validation decorators</strong></td>
<td></td>
</tr>
<tr>
<td><code>@IsBoolean()</code></td>
<td>Checks if a value is a boolean.</td>
</tr>
<tr>
<td><code>@IsDate()</code></td>
<td>Checks if the value is a date.</td>
</tr>
<tr>
<td><code>@IsString()</code></td>
<td>Checks if the string is a string.</td>
</tr>
<tr>
<td><code>@IsNumber(options: IsNumberOptions)</code></td>
<td>Checks if the value is a number.</td>
</tr>
<tr>
<td><code>@IsInt()</code></td>
<td>Checks if the value is an integer number.</td>
</tr>
<tr>
<td><code>@IsArray()</code></td>
<td>Checks if the value is an array</td>
</tr>
<tr>
<td><code>@IsEnum(entity: object)</code></td>
<td>Checks if the value is an valid enum</td>
</tr>
<tr>
<td><strong>Number validation decorators</strong></td>
<td></td>
</tr>
<tr>
<td><code>@IsDivisibleBy(num: number)</code></td>
<td>Checks if the value is a number that&rsquo;s divisible by another.</td>
</tr>
<tr>
<td><code>@IsPositive()</code></td>
<td>Checks if the value is a positive number greater than zero.</td>
</tr>
<tr>
<td><code>@IsNegative()</code></td>
<td>Checks if the value is a negative number smaller than zero.</td>
</tr>
<tr>
<td><code>@Min(min: number)</code></td>
<td>Checks if the given number is greater than or equal to given number.</td>
</tr>
<tr>
<td><code>@Max(max: number)</code></td>
<td>Checks if the given number is less than or equal to given number.</td>
</tr>
<tr>
<td><strong>Date validation decorators</strong></td>
<td></td>
</tr>
<tr>
<td><code>@MinDate(date: Date)</code></td>
<td>Checks if the value is a date that&rsquo;s after the specified date.</td>
</tr>
<tr>
<td><code>@MaxDate(date: Date)</code></td>
<td>Checks if the value is a date that&rsquo;s before the specified date.</td>
</tr>
<tr>
<td><strong>String-type validation decorators</strong></td>
<td></td>
</tr>
<tr>
<td><code>@IsBooleanString()</code></td>
<td>Checks if a string is a boolean (e.g. is &ldquo;true&rdquo; or &ldquo;false&rdquo;).</td>
</tr>
<tr>
<td><code>@IsDateString()</code></td>
<td>Alias for <code>@IsISO8601()</code>.</td>
</tr>
<tr>
<td><code>@IsNumberString(options?: IsNumericOptions)</code></td>
<td>Checks if a string is a number.</td>
</tr>
<tr>
<td><strong>String validation decorators</strong></td>
<td></td>
</tr>
<tr>
<td><code>@Contains(seed: string)</code></td>
<td>Checks if the string contains the seed.</td>
</tr>
<tr>
<td><code>@NotContains(seed: string)</code></td>
<td>Checks if the string not contains the seed.</td>
</tr>
<tr>
<td><code>@IsAlpha()</code></td>
<td>Checks if the string contains only letters (a-zA-Z).</td>
</tr>
<tr>
<td><code>@IsAlphanumeric()</code></td>
<td>Checks if the string contains only letters and numbers.</td>
</tr>
<tr>
<td><code>@IsDecimal(options?: IsDecimalOptions)</code></td>
<td>Checks if the string is a valid decimal value. Default IsDecimalOptions are <code>force_decimal=False</code>, <code>decimal_digits: '1,'</code>, <code>locale: 'en-US'</code></td>
</tr>
<tr>
<td><code>@IsAscii()</code></td>
<td>Checks if the string contains ASCII chars only.</td>
</tr>
<tr>
<td><code>@IsBase32()</code></td>
<td>Checks if a string is base32 encoded.</td>
</tr>
<tr>
<td><code>@IsBase64()</code></td>
<td>Checks if a string is base64 encoded.</td>
</tr>
<tr>
<td><code>@IsIBAN()</code></td>
<td>Checks if a string is a IBAN (International Bank Account Number).</td>
</tr>
<tr>
<td><code>@IsBIC()</code></td>
<td>Checks if a string is a BIC (Bank Identification Code) or SWIFT code.</td>
</tr>
<tr>
<td><code>@IsByteLength(min: number, max?: number)</code></td>
<td>Checks if the string&rsquo;s length (in bytes) falls in a range.</td>
</tr>
<tr>
<td><code>@IsCreditCard()</code></td>
<td>Checks if the string is a credit card.</td>
</tr>
<tr>
<td><code>@IsCurrency(options?: IsCurrencyOptions)</code></td>
<td>Checks if the string is a valid currency amount.</td>
</tr>
<tr>
<td><code>@IsEthereumAddress()</code></td>
<td>Checks if the string is an Ethereum address using basic regex. Does not validate address checksums.</td>
</tr>
<tr>
<td><code>@IsBtcAddress()</code></td>
<td>Checks if the string is a valid BTC address.</td>
</tr>
<tr>
<td><code>@IsDataURI()</code></td>
<td>Checks if the string is a data uri format.</td>
</tr>
<tr>
<td><code>@IsEmail(options?: IsEmailOptions)</code></td>
<td>Checks if the string is an email.</td>
</tr>
<tr>
<td><code>@IsFQDN(options?: IsFQDNOptions)</code></td>
<td>Checks if the string is a fully qualified domain name (e.g. domain.com).</td>
</tr>
<tr>
<td><code>@IsFullWidth()</code></td>
<td>Checks if the string contains any full-width chars.</td>
</tr>
<tr>
<td><code>@IsHalfWidth()</code></td>
<td>Checks if the string contains any half-width chars.</td>
</tr>
<tr>
<td><code>@IsVariableWidth()</code></td>
<td>Checks if the string contains a mixture of full and half-width chars.</td>
</tr>
<tr>
<td><code>@IsHexColor()</code></td>
<td>Checks if the string is a hexadecimal color.</td>
</tr>
<tr>
<td><code>@IsHSLColor()</code></td>
<td>Checks if the string is an HSL color based on <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/color_value">CSS Colors Level 4 specification</a>.</td>
</tr>
<tr>
<td><code>@IsRgbColor(options?: IsRgbOptions)</code></td>
<td>Checks if the string is a rgb or rgba color.</td>
</tr>
<tr>
<td><code>@IsIdentityCard(locale?: string)</code></td>
<td>Checks if the string is a valid identity card code.</td>
</tr>
<tr>
<td><code>@IsPassportNumber(countryCode?: string)</code></td>
<td>Checks if the string is a valid passport number relative to a specific country code.</td>
</tr>
<tr>
<td><code>@IsPostalCode(locale?: string)</code></td>
<td>Checks if the string is a postal code.</td>
</tr>
<tr>
<td><code>@IsHexadecimal()</code></td>
<td>Checks if the string is a hexadecimal number.</td>
</tr>
<tr>
<td><code>@IsOctal()</code></td>
<td>Checks if the string is a octal number.</td>
</tr>
<tr>
<td><code>@IsMACAddress(options?: IsMACAddressOptions)</code></td>
<td>Checks if the string is a MAC Address.</td>
</tr>
<tr>
<td><code>@IsIP(version?: &quot;4&quot;|&quot;6&quot;)</code></td>
<td>Checks if the string is an IP (version 4 or 6).</td>
</tr>
<tr>
<td><code>@IsPort()</code></td>
<td>Checks if the string is a valid port number.</td>
</tr>
<tr>
<td><code>@IsISBN(version?: &quot;10&quot;|&quot;13&quot;)</code></td>
<td>Checks if the string is an ISBN (version 10 or 13).</td>
</tr>
<tr>
<td><code>@IsEAN()</code></td>
<td>Checks if the string is an if the string is an EAN (European Article Number).</td>
</tr>
<tr>
<td><code>@IsISIN()</code></td>
<td>Checks if the string is an ISIN (stock/security identifier).</td>
</tr>
<tr>
<td><code>@IsISO8601(options?: IsISO8601Options)</code></td>
<td>Checks if the string is a valid ISO 8601 date format. Use the option strict = true for additional checks for a valid date.</td>
</tr>
<tr>
<td><code>@IsJSON()</code></td>
<td>Checks if the string is valid JSON.</td>
</tr>
<tr>
<td><code>@IsJWT()</code></td>
<td>Checks if the string is valid JWT.</td>
</tr>
<tr>
<td><code>@IsObject()</code></td>
<td>Checks if the object is valid Object (null, functions, arrays will return false).</td>
</tr>
<tr>
<td><code>@IsNotEmptyObject()</code></td>
<td>Checks if the object is not empty.</td>
</tr>
<tr>
<td><code>@IsLowercase()</code></td>
<td>Checks if the string is lowercase.</td>
</tr>
<tr>
<td><code>@IsLatLong()</code></td>
<td>Checks if the string is a valid latitude-longitude coordinate in the format lat, long.</td>
</tr>
<tr>
<td><code>@IsLatitude()</code></td>
<td>Checks if the string or number is a valid latitude coordinate.</td>
</tr>
<tr>
<td><code>@IsLongitude()</code></td>
<td>Checks if the string or number is a valid longitude coordinate.</td>
</tr>
<tr>
<td><code>@IsMobilePhone(locale: string)</code></td>
<td>Checks if the string is a mobile phone number.</td>
</tr>
<tr>
<td><code>@IsISO31661Alpha2()</code></td>
<td>Checks if the string is a valid ISO 3166-1 alpha-2 officially assigned country code.</td>
</tr>
<tr>
<td><code>@IsISO31661Alpha3()</code></td>
<td>Checks if the string is a valid ISO 3166-1 alpha-3 officially assigned country code.</td>
</tr>
<tr>
<td><code>@IsLocale()</code></td>
<td>Checks if the string is a locale.</td>
</tr>
<tr>
<td><code>@IsPhoneNumber(region: string)</code></td>
<td>Checks if the string is a valid phone numberusing libphonenumber-js.</td>
</tr>
<tr>
<td><code>@IsMongoId()</code></td>
<td>Checks if the string is a valid hex-encoded representation of a MongoDB ObjectId.</td>
</tr>
<tr>
<td><code>@IsMultibyte()</code></td>
<td>Checks if the string contains one or more multibyte chars.</td>
</tr>
<tr>
<td><code>@IsNumberString(options?: IsNumericOptions)</code></td>
<td>Checks if the string is numeric.</td>
</tr>
<tr>
<td><code>@IsSurrogatePair()</code></td>
<td>Checks if the string contains any surrogate pairs chars.</td>
</tr>
<tr>
<td><code>@IsUrl(options?: IsURLOptions)</code></td>
<td>Checks if the string is an url.</td>
</tr>
<tr>
<td><code>@IsMagnetURI()</code></td>
<td>Checks if the string is a <a href="https://en.wikipedia.org/wiki/Magnet_URI_scheme">magnet uri format</a>.</td>
</tr>
<tr>
<td><code>@IsUUID(version?: &quot;3&quot;|&quot;4&quot;|&quot;5&quot;|&quot;all&quot;)</code></td>
<td>Checks if the string is a UUID (version 3, 4, 5 or all ).</td>
</tr>
<tr>
<td><code>@IsFirebasePushId()</code></td>
<td>Checks if the string is a <a href="https://firebase.googleblog.com/2015/02/the-2120-ways-to-ensure-unique_68.html">Firebase Push ID</a></td>
</tr>
<tr>
<td><code>@IsUppercase()</code></td>
<td>Checks if the string is uppercase.</td>
</tr>
<tr>
<td><code>@Length(min: number, max?: number)</code></td>
<td>Checks if the string&rsquo;s length falls in a range.</td>
</tr>
<tr>
<td><code>@MinLength(min: number)</code></td>
<td>Checks if the string&rsquo;s length is not less than given number.</td>
</tr>
<tr>
<td><code>@MaxLength(max: number)</code></td>
<td>Checks if the string&rsquo;s length is not more than given number.</td>
</tr>
<tr>
<td><code>@Matches(pattern: RegExp, modifiers?: string)</code></td>
<td>Checks if string matches the pattern. Either matches(&lsquo;foo&rsquo;, /foo/i) or matches(&lsquo;foo&rsquo;, &lsquo;foo&rsquo;, &lsquo;i&rsquo;).</td>
</tr>
<tr>
<td><code>@IsMilitaryTime()</code></td>
<td>Checks if the string is a valid representation of military time in the format HH:MM.</td>
</tr>
<tr>
<td><code>@IsHash(algorithm: string)</code></td>
<td>Checks if the string is a hash The following types are supported:<code>md4</code>, <code>md5</code>, <code>sha1</code>, <code>sha256</code>, <code>sha384</code>, <code>sha512</code>, <code>ripemd128</code>, <code>ripemd160</code>, <code>tiger128</code>, <code>tiger160</code>, <code>tiger192</code>, <code>crc32</code>, <code>crc32b</code>.</td>
</tr>
<tr>
<td><code>@IsMimeType()</code></td>
<td>Checks if the string matches to a valid <a href="https://en.wikipedia.org/wiki/Media_type">MIME type</a> format</td>
</tr>
<tr>
<td><code>@IsSemVer()</code></td>
<td>Checks if the string is a Semantic Versioning Specification (SemVer).</td>
</tr>
<tr>
<td><code>@IsISSN(options?: IsISSNOptions)</code></td>
<td>Checks if the string is a ISSN.</td>
</tr>
<tr>
<td><code>@IsISRC()</code></td>
<td>Checks if the string is a <a href="https://en.wikipedia.org/wiki/International_Standard_Recording_Code">ISRC</a>.</td>
</tr>
<tr>
<td><code>@IsRFC3339()</code></td>
<td>Checks if the string is a valid <a href="https://tools.ietf.org/html/rfc3339">RFC 3339</a> date.</td>
</tr>
<tr>
<td><strong>Array validation decorators</strong></td>
<td></td>
</tr>
<tr>
<td><code>@ArrayContains(values: any[])</code></td>
<td>Checks if array contains all values from the given array of values.</td>
</tr>
<tr>
<td><code>@ArrayNotContains(values: any[])</code></td>
<td>Checks if array does not contain any of the given values.</td>
</tr>
<tr>
<td><code>@ArrayNotEmpty()</code></td>
<td>Checks if given array is not empty.</td>
</tr>
<tr>
<td><code>@ArrayMinSize(min: number)</code></td>
<td>Checks if the array&rsquo;s length is greater than or equal to the specified number.</td>
</tr>
<tr>
<td><code>@ArrayMaxSize(max: number)</code></td>
<td>Checks if the array&rsquo;s length is less or equal to the specified number.</td>
</tr>
<tr>
<td><code>@ArrayUnique(identifier?: (o) =&gt; any)</code></td>
<td>Checks if all array&rsquo;s values are unique. Comparison for objects is reference-based. Optional function can be speciefied which return value will be used for the comparsion.</td>
</tr>
<tr>
<td><strong>Object validation decorators</strong></td>
<td></td>
</tr>
<tr>
<td><code>@IsInstance(value: any)</code></td>
<td>Checks if the property is an instance of the passed value.</td>
</tr>
<tr>
<td><strong>Other decorators</strong></td>
<td></td>
</tr>
<tr>
<td><code>@Allow()</code></td>
<td>Prevent stripping off the property when no other constraint is specified for it.</td>
</tr>
</tbody>
</table>
<h2 id="定义没有装饰器的验证模式">定义没有装饰器的验证模式</h2>
<p>你可以在没有装饰器的情况下定义你的验证模式:</p>
<ul>
<li>you can define it in the separate object</li>
<li>you can define it in the <code>.json</code> file</li>
</ul>
<p>This feature maybe useful in the cases if:</p>
<ul>
<li>are using es5/es6 and don&rsquo;t have decorators available</li>
<li>you don&rsquo;t have a classes, and instead using interfaces</li>
<li>you don&rsquo;t want to use model at all</li>
<li>you want to have a validation schema separate of your model</li>
<li>you want beautiful json-schema based validation models</li>
<li>you simply hate decorators</li>
</ul>
<p>Here is an example of using it:</p>
<ol>
<li>
<p>Create a schema object:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ValidationSchema</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">UserValidationSchema</span>: <span style="color:#204a87;font-weight:bold">ValidationSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// using interface here is not required, its just for type-safety
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;myUserSchema&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// this is required, and must be unique
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">properties</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">firstName</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
      <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;minLength&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// validation type. All validation types are listed in ValidationTypes class.
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">constraints</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">],</span>
      <span style="color:#000;font-weight:bold">},</span>
      <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;maxLength&#34;</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000">constraints</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">],</span>
      <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000;font-weight:bold">],</span>
    <span style="color:#000">lastName</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
      <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;minLength&#34;</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000">constraints</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">],</span>
      <span style="color:#000;font-weight:bold">},</span>
      <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;maxLength&#34;</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000">constraints</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">],</span>
      <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000;font-weight:bold">],</span>
    <span style="color:#000">email</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
      <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;isEmail&#34;</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000;font-weight:bold">],</span>
  <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">};</span>
</code></pre></div><p>Same schema can be provided in <code>.json</code> file, depend on your wish.</p>
</li>
<li>
<p>Register your schema:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">registerSchema</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">UserValidationSchema</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./UserValidationSchema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">registerSchema</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">UserValidationSchema</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// if schema is in .json file, then you can simply do registerSchema(require(&#34;path-to-schema.json&#34;));
</span></code></pre></div><p>Better to put this code in a global place, maybe when you bootstrap your application, for example in <code>app.ts</code>.</p>
</li>
<li>
<p>Validate your object using validation schema:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">validate</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">firstName</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Johny&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">secondName</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Cage&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">email</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;johny@cage.com&#34;</span> <span style="color:#000;font-weight:bold">};</span>
<span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;myUserSchema&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">errors</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Validation failed: &#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Validation succeed.&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>That&rsquo;s it. Here <code>&quot;myUserSchema&quot;</code> is the name of our validation schema.
<code>validate</code> method will perform validation based on this schema</p>
</li>
</ol>
<h2 id="验证纯对象">验证纯对象</h2>
<p>由于装饰器的特性，验证过的对象必须使用<code>new Class()</code>语法进行实例化。
如果你用类验证器装饰器定义了你的类，并且你想验证普通的 JS 对象(文字对象或 JSON.parse 返回的对象)，你需要通过使用<a href="https://github.com/pleerock/class-transformer">class-transformer</a>将其转换为类实例。</p>
<h2 id="样品">样品</h2>
<p>请参阅<a href="https://github.com/pleerock/class-validator/tree/master/sample">./sample</a>中的示例以获得更多用法示例。</p>
<h2 id="扩展">扩展</h2>
<p>有几个扩展可以简化类验证器与其他模块的集成:</p>
<ul>
<li><a href="https://github.com/19majkel94/class-transformer-validator">class-validator integration</a> with <a href="https://github.com/pleerock/class-transformer">class-transformer</a></li>
<li><a href="https://github.com/yantrab/class-validator-rule">class-validator-rule</a></li>
<li><a href="https://github.com/EndyKaufman/ngx-dynamic-form-builder">ngx-dynamic-form-builder</a></li>
<li><a href="https://github.com/abarghoud/ngx-reactive-form-class-validator">abarghoud/ngx-reactive-form-class-validator</a></li>
</ul>
<h2 id="发布说明">发布说明</h2>
<p>查看关于中断更改和发布说明的信息<a href="CHANGELOG.md">在这里</a>。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-dc8d9bde5ab50bdea8564d5e73547fd5">1.2 - class-transformer</h1>
    
	<p><img src="https://github.com/typestack/class-transformer/workflows/CI/badge.svg" alt="Build Status">
<a href="https://codecov.io/gh/typestack/class-transformer"><img src="https://codecov.io/gh/typestack/class-transformer/branch/develop/graph/badge.svg" alt="codecov"></a>
<a href="https://badge.fury.io/js/class-transformer"><img src="https://badge.fury.io/js/class-transformer.svg" alt="npm version"></a></p>
<p>Its ES6 and Typescript era. Nowadays you are working with classes and constructor objects more than ever.
Class-transformer allows you to transform plain object to some instance of class and versa.
Also it allows to serialize / deserialize object based on criteria.
This tool is super useful on both frontend and backend.</p>
<p>Example how to use with angular 2 in <a href="http://plnkr.co/edit/Mja1ZYAjVySWASMHVB9R">plunker</a>.
Source code is available <a href="https://github.com/pleerock/class-transformer-demo">here</a>.</p>
<h2 id="什么是-class-transformer">什么是 class-transformer</h2>
<p>In JavaScript there are two types of objects:</p>
<ul>
<li>plain (literal) objects</li>
<li>class (constructor) objects</li>
</ul>
<p>Plain objects are objects that are instances of <code>Object</code> class.
Sometimes they are called <strong>literal</strong> objects, when created via <code>{}</code> notation.
Class objects are instances of classes with own defined constructor, properties and methods.
Usually you define them via <code>class</code> notation.</p>
<p>So, what is the problem?</p>
<p>Sometimes you want to transform plain javascript object to the ES6 <strong>classes</strong> you have.
For example, if you are loading a json from your backend, some api or from a json file,
and after you <code>JSON.parse</code> it you have a plain javascript object, not instance of class you have.</p>
<p>For example you have a list of users in your <code>users.json</code> that you are loading:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">[</span>
  <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">&#34;id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;firstName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Johny&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;lastName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Cage&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;age&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">27</span>
  <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">&#34;id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;firstName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Ismoil&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;lastName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Somoni&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;age&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">50</span>
  <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">&#34;id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;firstName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Luke&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;lastName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Dacascos&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;age&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">12</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">]</span>
</code></pre></div><p>And you have a <code>User</code> class:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">firstName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">lastName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">age</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#000">getName() {</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">firstName</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34; &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lastName</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#000">isAdult() {</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">age</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">36</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">age</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">60</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>You are assuming that you are downloading users of type <code>User</code> from <code>users.json</code> file and may want to write
following code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#000">fetch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users.json&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">users</span>: <span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">[])</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// you can use users here, and type hinting also will be available to you,
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">//  but users are not actually instances of User class
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// this means that you can&#39;t use methods of User class
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>In this code you can use <code>users[0].id</code>, you can also use <code>users[0].firstName</code> and <code>users[0].lastName</code>.
However you cannot use <code>users[0].getName()</code> or <code>users[0].isAdult()</code> because &ldquo;users&rdquo; actually is
array of plain javascript objects, not instances of User object.
You actually lied to compiler when you said that its <code>users: User[]</code>.</p>
<p>So what to do? How to make a <code>users</code> array of instances of <code>User</code> objects instead of plain javascript objects?
Solution is to create new instances of User object and manually copy all properties to new objects.
But things may go wrong very fast once you have a more complex object hierarchy.</p>
<p>Alternatives? Yes, you can use class-transformer. Purpose of this library is to help you to map your plain javascript
objects to the instances of classes you have.</p>
<p>This library also great for models exposed in your APIs,
because it provides a great tooling to control what your models are exposing in your API.
Here is an example how it will look like:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#000">fetch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users.json&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">users</span>: <span style="color:#204a87;font-weight:bold">Object</span><span style="color:#000;font-weight:bold">[])</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">realUsers</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">plainToClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">users</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#8f5902;font-style:italic">// now each user in realUsers is an instance of User class
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>Now you can use <code>users[0].getName()</code> and <code>users[0].isAdult()</code> methods.</p>
<h2 id="安装">安装</h2>
<h3 id="nodejs">Node.js</h3>
<ol>
<li>
<p>Install module:</p>
<p><code>npm install class-transformer --save</code></p>
</li>
<li>
<p><code>reflect-metadata</code> shim is required, install it too:</p>
<p><code>npm install reflect-metadata --save</code></p>
<p>and make sure to import it in a global place, like app.ts:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#4e9a06">&#34;reflect-metadata&#34;</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div></li>
<li>
<p>ES6 features are used, if you are using old version of node.js you may need to install es6-shim:</p>
<p><code>npm install es6-shim --save</code></p>
<p>and import it in a global place like app.ts:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#4e9a06">&#34;es6-shim&#34;</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div></li>
</ol>
<h3 id="浏览器">浏览器</h3>
<ol>
<li>
<p>Install module:</p>
<p><code>npm install class-transformer --save</code></p>
</li>
<li>
<p><code>reflect-metadata</code> shim is required, install it too:</p>
<p><code>npm install reflect-metadata --save</code></p>
<p>add <code>&lt;script&gt;</code> to reflect-metadata in the head of your <code>index.html</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html"><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">html</span><span style="color:#000;font-weight:bold">&gt;</span>
  <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">head</span><span style="color:#000;font-weight:bold">&gt;</span>
    <span style="color:#8f5902;font-style:italic">&lt;!-- ... --&gt;</span>
    <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">script</span> <span style="color:#c4a000">src</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;node_modules/reflect-metadata/Reflect.js&#34;</span><span style="color:#000;font-weight:bold">&gt;&lt;/</span><span style="color:#204a87;font-weight:bold">script</span><span style="color:#000;font-weight:bold">&gt;</span>
  <span style="color:#000;font-weight:bold">&lt;/</span><span style="color:#204a87;font-weight:bold">head</span><span style="color:#000;font-weight:bold">&gt;</span>
  <span style="color:#8f5902;font-style:italic">&lt;!-- ... --&gt;</span>
<span style="color:#000;font-weight:bold">&lt;/</span><span style="color:#204a87;font-weight:bold">html</span><span style="color:#000;font-weight:bold">&gt;</span>
</code></pre></div><p>If you are using angular 2 you should already have this shim installed.</p>
</li>
<li>
<p>If you are using system.js you may want to add this into <code>map</code> and <code>package</code> config:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">&#34;map&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;node_modules/class-transformer&#34;</span>
  <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#204a87;font-weight:bold">&#34;packages&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">&#34;main&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;index.js&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;defaultExtension&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;js&#34;</span> <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div></li>
</ol>
<h2 id="方法">方法</h2>
<h3 id="plaintoclass">plainToClass</h3>
<p>This method transforms a plain javascript object to instance of specific class.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">plainToClass</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">users</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">plainToClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">userJson</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// to convert user plain object a single user. also supports arrays
</span></code></pre></div><h3 id="plaintoclassfromexist">plainToClassFromExist</h3>
<p>This method transforms a plain object into an instance using an already filled Object which is an instance of the target class.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">defaultUser</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000">defaultUser</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">role</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;user&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">mixedUser</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">plainToClassFromExist</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">defaultUser</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// mixed user should have the value role = user when no value is set otherwise.
</span></code></pre></div><h3 id="classtoplain">classToPlain</h3>
<p>This method transforms your class object back to plain javascript object, that can be <code>JSON.stringify</code> later.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">classToPlain</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">photo</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">classToPlain</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">photo</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><h3 id="classtoclass">classToClass</h3>
<p>This method transforms your class object into a new instance of the class object.
This may be treated as deep clone of your objects.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">classToClass</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">photo</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">classToClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">photo</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>You can also use an <code>ignoreDecorators</code> option in transformation options to ignore all decorators you classes is using.</p>
<h3 id="serialize">serialize</h3>
<p>You can serialize your model right to json using <code>serialize</code> method:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">serialize</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">photo</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">serialize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">photo</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p><code>serialize</code> works with both arrays and non-arrays.</p>
<h3 id="deserialize-and-deserializearray">deserialize and deserializeArray</h3>
<p>You can deserialize your model from json using the <code>deserialize</code> method:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">deserialize</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">photo</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">deserialize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Photo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">photo</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>To make deserialization work with arrays, use the <code>deserializeArray</code> method:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">deserializeArray</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">photos</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">deserializeArray</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Photo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">photos</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><h2 id="执行类型安全的实例">执行类型安全的实例</h2>
<p>The default behaviour of the <code>plainToClass</code> method is to set <em>all</em> properties from the plain object,
even those which are not specified in the class.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">plainToClass</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">firstName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">lastName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">fromPlainUser</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">unkownProp</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;hello there&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">firstName</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Umed&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">lastName</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Khudoiberdiev&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">};</span>

<span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plainToClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fromPlainUser</span><span style="color:#000;font-weight:bold">));</span>

<span style="color:#8f5902;font-style:italic">// User {
</span><span style="color:#8f5902;font-style:italic">//   unkownProp: &#39;hello there&#39;,
</span><span style="color:#8f5902;font-style:italic">//   firstName: &#39;Umed&#39;,
</span><span style="color:#8f5902;font-style:italic">//   lastName: &#39;Khudoiberdiev&#39;,
</span><span style="color:#8f5902;font-style:italic">// }
</span></code></pre></div><p>If this behaviour does not suit your needs, you can use the <code>excludeExtraneousValues</code> option
in the <code>plainToClass</code> method while <em>exposing all your class properties</em> as a requirement.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Expose</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">plainToClass</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Expose</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#204a87;font-weight:bold">@Expose</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">firstName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#204a87;font-weight:bold">@Expose</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">lastName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">fromPlainUser</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">unkownProp</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;hello there&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">firstName</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Umed&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">lastName</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Khudoiberdiev&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">};</span>

<span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plainToClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fromPlainUser</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">excludeExtraneousValues</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">}));</span>

<span style="color:#8f5902;font-style:italic">// User {
</span><span style="color:#8f5902;font-style:italic">//   id: undefined,
</span><span style="color:#8f5902;font-style:italic">//   firstName: &#39;Umed&#39;,
</span><span style="color:#8f5902;font-style:italic">//   lastName: &#39;Khudoiberdiev&#39;
</span><span style="color:#8f5902;font-style:italic">// }
</span></code></pre></div><h2 id="使用嵌套对象">使用嵌套对象</h2>
<p>When you are trying to transform objects that have nested objects,
it&rsquo;s required to known what type of object you are trying to transform.
Since Typescript does not have good reflection abilities yet,
we should implicitly specify what type of object each property contain.
This is done using <code>@Type</code> decorator.</p>
<p>Lets say we have an album with photos.
And we are trying to convert album plain object to class object:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">plainToClass</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Album</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Photo</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000">photos</span>: <span style="color:#204a87;font-weight:bold">Photo</span><span style="color:#000;font-weight:bold">[];</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Photo</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">filename</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">album</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">plainToClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Album</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">albumJson</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#8f5902;font-style:italic">// now album is Album object with Photo objects inside
</span></code></pre></div><h3 id="提供多个类型选项">提供多个类型选项</h3>
<p>In case the nested object can be of different types, you can provide an additional options object,
that specifies a discriminator. The discriminator option must define a <code>property</code> that holds the subtype
name for the object and the possible <code>subTypes</code> that the nested object can converted to. A sub type
has a <code>value</code>, that holds the constructor of the Type and the <code>name</code>, that can match with the <code>property</code>
of the discriminator.</p>
<p>Lets say we have an album that has a top photo. But this photo can be of certain different types.
And we are trying to convert album plain object to class object. The plain object input has to define
the additional property <code>__type</code>. This property is removed during transformation by default:</p>
<p><strong>JSON input</strong>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">&#34;id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#204a87;font-weight:bold">&#34;topPhoto&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">&#34;id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;filename&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;cool_wale.jpg&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;depth&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1245</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;__type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;underwater&#34;</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">plainToClass</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">abstract</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Photo</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">filename</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Landscape</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">Photo</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">panorama</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Portrait</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">Photo</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">person</span>: <span style="color:#204a87;font-weight:bold">Person</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UnderWater</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">Photo</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">depth</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Album</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Photo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">discriminator</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">property</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;__type&#34;</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">subTypes</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
        <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">value</span>: <span style="color:#204a87;font-weight:bold">Landscape</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;landscape&#34;</span> <span style="color:#000;font-weight:bold">},</span>
        <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">value</span>: <span style="color:#204a87;font-weight:bold">Portrait</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;portrait&#34;</span> <span style="color:#000;font-weight:bold">},</span>
        <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">value</span>: <span style="color:#204a87;font-weight:bold">UnderWater</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;underwater&#34;</span> <span style="color:#000;font-weight:bold">},</span>
      <span style="color:#000;font-weight:bold">],</span>
    <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000">topPhoto</span>: <span style="color:#204a87;font-weight:bold">Landscape</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">Portrait</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">UnderWater</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">album</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">plainToClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Album</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">albumJson</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#8f5902;font-style:italic">// now album is Album object with a UnderWater object without `__type` property.
</span></code></pre></div><p>Hint: The same applies for arrays with different sub types. Moreover you can specify <code>keepDiscriminatorProperty: true</code>
in the options to keep the discriminator property also inside your resulting class.</p>
<h2 id="公开-getters-和方法返回值">公开 getters 和方法返回值</h2>
<p>You can expose what your getter or method return by setting an <code>@Expose()</code> decorator to those getters or methods:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Expose</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">firstName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">lastName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">password</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Expose</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">get</span> <span style="color:#000">name() {</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">firstName</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34; &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lastName</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#204a87;font-weight:bold">@Expose</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">getFullName() {</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">firstName</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34; &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lastName</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="公开具有不同名称的属性">公开具有不同名称的属性</h2>
<p>If you want to expose some of the properties with a different name,
you can do that by specifying a <code>name</code> option to <code>@Expose</code> decorator:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Expose</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Expose</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;uid&#34;</span> <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#000">firstName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#000">lastName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Expose</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;secretKey&#34;</span> <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000">password</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Expose</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;fullName&#34;</span> <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000">getFullName() {</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">firstName</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34; &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lastName</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="跳过特定属性">跳过特定属性</h2>
<p>Sometimes you want to skip some properties during transformation.
This can be done using <code>@Exclude</code> decorator:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Exclude</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Exclude</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">password</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Now when you transform a User, the <code>password</code> property will be skipped and not be included in the transformed result.</p>
<h2 id="操作的跳过依赖关系">操作的跳过依赖关系</h2>
<p>You can control on what operation you will exclude a property. Use <code>toClassOnly</code> or <code>toPlainOnly</code> options:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Exclude</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Exclude</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">toPlainOnly</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000">password</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Now <code>password</code> property will be excluded only during <code>classToPlain</code> operation. Vice versa, use the <code>toClassOnly</code> option.</p>
<h2 id="跳过类的所有属性">跳过类的所有属性</h2>
<p>You can skip all properties of the class, and expose only those are needed explicitly:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Exclude</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Expose</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Exclude</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Expose</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Expose</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#000">password</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Now <code>id</code> and <code>email</code> will be exposed, and password will be excluded during transformation.
Alternatively, you can set exclusion strategy during transformation:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">classToPlain</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">photo</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">classToPlain</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">photo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">strategy</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;excludeAll&#34;</span> <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>In this case you don&rsquo;t need to <code>@Exclude()</code> a whole class.</p>
<h2 id="跳过私有属性或某些前缀属性">跳过私有属性或某些前缀属性</h2>
<p>If you name your private properties with a prefix, lets say with <code>_</code>,
then you can exclude such properties from transformation too:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">classToPlain</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">photo</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">classToPlain</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">photo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">excludePrefixes</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;_&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>This will skip all properties that start with <code>_</code> prefix.
You can pass any number of prefixes and all properties that begin with these prefixes will be ignored.
For example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Expose</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">classToPlain</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">_firstName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">_lastName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">_password</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#000">setName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">firstName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lastName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">_firstName</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">firstName</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">_lastName</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">lastName</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#204a87;font-weight:bold">@Expose</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">get</span> <span style="color:#000">name() {</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">_firstName</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34; &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">_lastName</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">setName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Johny&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Cage&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">_password</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;123&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">plainUser</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">classToPlain</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">excludePrefixes</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;_&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#8f5902;font-style:italic">// here plainUser will be equal to
</span><span style="color:#8f5902;font-style:italic">// { id: 1, name: &#34;Johny Cage&#34; }
</span></code></pre></div><h2 id="使用组来控制排除的属性">使用组来控制排除的属性</h2>
<p>You can use groups to control what data will be exposed and what will not be:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Exclude</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Expose</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">classToPlain</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Expose</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">groups</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;user&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;admin&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#8f5902;font-style:italic">// this means that this data will be exposed only to users and admins
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Expose</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">groups</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;user&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#8f5902;font-style:italic">// this means that this data will be exposed only to users
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">password</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">user1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">classToPlain</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">groups</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;user&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// will contain id, name, email and password
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">user2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">classToPlain</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">groups</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;admin&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// will contain id, name and email
</span></code></pre></div><h2 id="使用版本控制来控制公开的和被排除的属性">使用版本控制来控制公开的和被排除的属性</h2>
<p>If you are building an API that has different versions, class-transformer has extremely useful tools for that.
You can control which properties of your model should be exposed or excluded in what version. Example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Exclude</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Expose</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">classToPlain</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Expose</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">since</span>: <span style="color:#204a87;font-weight:bold">0.7</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">until</span>: <span style="color:#204a87;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#8f5902;font-style:italic">// this means that this property will be exposed for version starting from 0.7 until 1
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Expose</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">since</span>: <span style="color:#204a87;font-weight:bold">2.1</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#8f5902;font-style:italic">// this means that this property will be exposed for version starting from 2.1
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">password</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">user1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">classToPlain</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">version</span>: <span style="color:#204a87;font-weight:bold">0.5</span> <span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// will contain id and name
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">user2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">classToPlain</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">version</span>: <span style="color:#204a87;font-weight:bold">0.7</span> <span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// will contain id, name and email
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">user3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">classToPlain</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">version</span>: <span style="color:#204a87;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// will contain id and name
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">user4</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">classToPlain</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">version</span>: <span style="color:#204a87;font-weight:bold">2</span> <span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// will contain id and name
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">user5</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">classToPlain</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">version</span>: <span style="color:#204a87;font-weight:bold">2.1</span> <span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// will contain id, name and password
</span></code></pre></div><h2 id="сonverting-日期字符串到日期对象">Сonverting 日期字符串到日期对象</h2>
<p>Sometimes you have a Date in your plain javascript object received in a string format.
And you want to create a real javascript Date object from it.
You can do it simply by passing a Date object to the <code>@Type</code> decorator:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#000">password</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#204a87">Date</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000">registrationDate</span>: <span style="color:#204a87;font-weight:bold">Date</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Same technique can be used with <code>Number</code>, <code>String</code>, <code>Boolean</code>
primitive types when you want to convert your values into these types.</p>
<h2 id="使用数组">使用数组</h2>
<p>When you are using arrays you must provide a type of the object that array contains.
This type, you specify in a <code>@Type()</code> decorator:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Photo</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Album</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000">albums</span>: <span style="color:#204a87;font-weight:bold">Album</span><span style="color:#000;font-weight:bold">[];</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>You can also use custom array types:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">AlbumCollection</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#204a87">Array</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Album</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// custom array functions ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Photo</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Album</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000">albums</span>: <span style="color:#204a87;font-weight:bold">AlbumCollection</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Library will handle proper transformation automatically.</p>
<p>ES6 collections <code>Set</code> and <code>Map</code> also require the <code>@Type</code> decorator:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Skill</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Weapon</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">range</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Player</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Skill</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000">skills</span>: <span style="color:#204a87;font-weight:bold">Set</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Skill</span><span style="color:#000;font-weight:bold">&gt;;</span>

  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Weapon</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000">weapons</span>: <span style="color:#204a87;font-weight:bold">Map</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#a40000">,</span> <span style="color:#c4a000">Weapon</span><span style="color:#000;font-weight:bold">&gt;;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="额外的数据转换">额外的数据转换</h2>
<h3 id="基本用法">基本用法</h3>
<p>You can perform additional data transformation using <code>@Transform</code> decorator.
For example, you want to make your <code>Date</code> object to be a <code>moment</code> object when you are
transforming object from plain to class:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Transform</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">moment</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;moment&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Moment</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;moment&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Photo</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#204a87">Date</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">moment</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">toClassOnly</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000">date</span>: <span style="color:#204a87;font-weight:bold">Moment</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Now when you call <code>plainToClass</code> and send a plain representation of the Photo object,
it will convert a date value in your photo object to moment date.
<code>@Transform</code> decorator also supports groups and versioning.</p>
<h3 id="高级用法">高级用法</h3>
<p>The <code>@Transform</code> decorator is given more arguments to let you configure how you want the transformation to be done.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span>
</code></pre></div><table>
<thead>
<tr>
<th>Argument</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>value</code></td>
<td>The property value before the transformation.</td>
</tr>
<tr>
<td><code>key</code></td>
<td>The name of the transformed property.</td>
</tr>
<tr>
<td><code>obj</code></td>
<td>The transformation source object.</td>
</tr>
<tr>
<td><code>type</code></td>
<td>The transformation type.</td>
</tr>
<tr>
<td><code>options</code></td>
<td>The options object passed to the transformation method.</td>
</tr>
</tbody>
</table>
<h2 id="其他修饰符">其他修饰符</h2>
<table>
<thead>
<tr>
<th>Signature</th>
<th>Example</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>@TransformClassToPlain</code></td>
<td><code>@TransformClassToPlain({ groups: [&quot;user&quot;] })</code></td>
<td>Transform the method return with classToPlain and expose the properties on the class.</td>
</tr>
<tr>
<td><code>@TransformClassToClass</code></td>
<td><code>@TransformClassToClass({ groups: [&quot;user&quot;] })</code></td>
<td>Transform the method return with classToClass and expose the properties on the class.</td>
</tr>
<tr>
<td><code>@TransformPlainToClass</code></td>
<td><code>@TransformPlainToClass(User, { groups: [&quot;user&quot;] })</code></td>
<td>Transform the method return with plainToClass and expose the properties on the class.</td>
</tr>
</tbody>
</table>
<p>The above decorators accept one optional argument:
ClassTransformOptions - The transform options like groups, version, name</p>
<p>An example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">@Exclude</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Expose</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">firstName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Expose</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">lastName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Expose</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">groups</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;user.email&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#000">password</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UserController</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@TransformClassToPlain</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">groups</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;user.email&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000">getUser() {</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">firstName</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;Snir&#34;</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lastName</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;Segal&#34;</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">password</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;imnosuperman&#34;</span><span style="color:#000;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">controller</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">UserController</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getUser</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div><p>the <code>user</code> variable will contain only firstName,lastName, email properties because they are
the exposed variables. email property is also exposed because we metioned the group &ldquo;user.email&rdquo;.</p>
<h2 id="使用泛型">使用泛型</h2>
<p>Generics are not supported because TypeScript does not have good reflection abilities yet.
Once TypeScript team provide us better runtime type reflection tools, generics will be implemented.
There are some tweaks however you can use, that maybe can solve your problem.
<a href="https://github.com/pleerock/class-transformer/tree/master/sample/sample4-generics">Checkout this example.</a></p>
<h2 id="隐式类型转换">隐式类型转换</h2>
<blockquote>
<p><strong>NOTE</strong> If you use class-validator together with class-transformer you propably DON&rsquo;T want to enable this function.</p>
</blockquote>
<p>Enables automatic conversion between built-in types based on type information provided by Typescript. Disabled by default.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">IsString</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">MyPayload</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@IsString</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">prop</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">result1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">plainToClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">MyPayload</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">prop</span>: <span style="color:#204a87;font-weight:bold">1234</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">enableImplicitConversion</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">result2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">plainToClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">MyPayload</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">prop</span>: <span style="color:#204a87;font-weight:bold">1234</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">enableImplicitConversion</span>: <span style="color:#204a87;font-weight:bold">false</span> <span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic"> *  result1 will be `{ prop: &#34;1234&#34; }` - notice how the prop value has been converted to string.
</span><span style="color:#8f5902;font-style:italic"> *  result2 will be `{ prop: 1234 }` - default behaviour
</span><span style="color:#8f5902;font-style:italic"> */</span>
</code></pre></div><h2 id="它如何处理循环引用">它如何处理循环引用?</h2>
<p>Circular references are ignored.
For example, if you are transforming class <code>User</code> that contains property <code>photos</code> with type of <code>Photo</code>,
and <code>Photo</code> contains link <code>user</code> to its parent <code>User</code>, then <code>user</code> will be ignored during transformation.
Circular references are not ignored only during <code>classToClass</code> operation.</p>
<h2 id="例子与-angular2">例子与 Angular2</h2>
<p>Lets say you want to download users and want them automatically to be mapped to the instances of <code>User</code> class.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">plainToClass</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">http</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users.json&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">json</span><span style="color:#000;font-weight:bold">())</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">plainToClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">res</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#204a87">Object</span><span style="color:#000;font-weight:bold">[]))</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">subscribe</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">users</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// now &#34;users&#34; is type of User[] and each user has getName() and isAdult() methods available
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">users</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>You can also inject a class <code>ClassTransformer</code> as a service in <code>providers</code>, and use its methods.</p>
<p>Example how to use with angular 2 in <a href="http://plnkr.co/edit/Mja1ZYAjVySWASMHVB9R">plunker</a>.
Source code is <a href="https://github.com/pleerock/class-transformer-demo">here</a>.</p>
<h2 id="样品">样品</h2>
<p>Take a look on samples in <a href="https://github.com/pleerock/class-transformer/tree/master/sample">./sample</a> for more examples of
usages.</p>
<h2 id="发布说明">发布说明</h2>
<p>See information about breaking changes and release notes <a href="https://github.com/typestack/class-transformer/blob/master/CHANGELOG.md">here</a>.</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-90df5218158c4d01fc01a3fa3bcb9ad2">2 - mongodb</h1>
    
	<blockquote>
<p><a href="https://wanago.io/courses/api-with-nestjs/">https://wanago.io/courses/api-with-nestjs/</a></p>
</blockquote>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-ee82b5a9ba57222a5fbfd0b80a49cfa9">2.1 - MongoDB概论</h1>
    
	<p>到目前为止，在本系列文章中，我们主要讨论如何使用 SQL 和 Postgres 数据库。
虽然 PostgreSQL 是一个很好的选择，但它值得一试。
在本文中，我们将了解 MongoDB 是如何工作的，以及它与 SQL 数据库的区别。
我们还使用 MongoDB 和 NestJS 创建了一个简单的应用程序。</p>
<p>您可以从下面的文章中在这个存储库中找到源代码。</p>
<h2 id="mongodb-vs-sql-databases">MongoDB vs. SQL Databases</h2>
<p>MongoDB 的设计原则与传统的 SQL 数据库有很大的不同。
MongoDB 没有使用表和行来表示数据，而是将其存储为类似 json 的文档。
因此，熟悉 JavaScript 的开发人员比较容易掌握。</p>
<p>MongoDB 中的文档由键和值对组成。
它们的重要方面是，在给定集合中的文档中键可以不同。
这是 MongoDB 和 SQL 数据库之间的一个很大的区别。
它使 MongoDB 更加灵活，结构更松散。
因此，它既可以被视为优点，也可以被视为缺点。</p>
<h2 id="mongodb-的优点和缺点">MongoDB 的优点和缺点</h2>
<p>Since MongoDB and SQL databases differ so much, choosing the right tool for a given job is crucial.
Since NoSQL databases put fewer restrictions on the data, it might be a good choice for an application evolving quickly.
We still might need to update our data as our schema changes.</p>
<p>For example, we might want to add a new property containing the user’s avatar URL.
When it happens, we still should deal with documents not containing our new property.
We can do that by writing a script that puts a default value for old documents.
Alternatively, we can assume that this field can be missing and handle it differently on the application level.</p>
<p>On the contrary, adding a new property to an existing SQL database requires writing a migration that explicitly handles the new property.
This might seem like a bit of a chore in a lot of cases.
However, with MongoDB, it is not required.
This might make the work easier and faster, but we need to watch out and not lose the integrity of our data.</p>
<p>If you want to know more about SQL migrations, check out The basics of migrations using TypeORM and Postgres</p>
<p>SQL databases such as Postgres keep the data in tables consisting of columns and rows.
A big part of the design process is defining relationships between the above tables.
For example, a user can be an author of an article.
On the other hand, MongoDB is a non-relational database.
Therefore, while we can mimic SQL-style relationships with MongoDB, they will not be as efficient and foolproof.</p>
<h2 id="using-mongodb-with-nestjs">Using MongoDB with NestJS</h2>
<p>So far, in this series, we’ve used Docker to set up the architecture for our project.
We can easily achieve that with MongoDB also.</p>
<p>docker-compose.yml</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;3&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">services</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">mongo</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mongo:latest</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">environment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">MONGO_INITDB_ROOT_USERNAME</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">${MONGO_USERNAME}</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">MONGO_INITDB_ROOT_PASSWORD</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">${MONGO_PASSWORD}</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">MONGO_INITDB_DATABASE</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">${MONGO_DATABASE}</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>- <span style="color:#4e9a06">&#39;27017:27017&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><p>Above, you can see that we refer to a few variables.
Let’s put them into our .env file:</p>
<p>.env</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-env" data-lang="env"><span style="color:#000">MONGO_USERNAME</span><span style="color:#ce5c00;font-weight:bold">=</span>admin
<span style="color:#000">MONGO_PASSWORD</span><span style="color:#ce5c00;font-weight:bold">=</span>admin
<span style="color:#000">MONGO_DATABASE</span><span style="color:#ce5c00;font-weight:bold">=</span>nestjs
<span style="color:#000">MONGO_HOST</span><span style="color:#ce5c00;font-weight:bold">=</span>localhost:27017
</code></pre></div><p>In the previous parts of this series, we’ve used TypeORM to connect to our PostgreSQL database and manage our data.
For MongoDB, the most popular library is Mongoose.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">npm install --save @nestjs/mongoose mongoose
</code></pre></div><p>Let’s use Mongoose to connect to our database.
To do that, we need to define a URI connection string:</p>
<p>app.module.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Module</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">MongooseModule</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ConfigModule</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ConfigService</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/config&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostsModule</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./posts/posts.module&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">Joi</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@hapi/joi&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Module</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">imports</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
    <span style="color:#000">ConfigModule</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">forRoot</span><span style="color:#000;font-weight:bold">({</span>
      <span style="color:#000">validationSchema</span>: <span style="color:#204a87;font-weight:bold">Joi.object</span><span style="color:#000;font-weight:bold">({</span>
        <span style="color:#000">MONGO_USERNAME</span>: <span style="color:#204a87;font-weight:bold">Joi.string</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">required</span><span style="color:#000;font-weight:bold">(),</span>
        <span style="color:#000">MONGO_PASSWORD</span>: <span style="color:#204a87;font-weight:bold">Joi.string</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">required</span><span style="color:#000;font-weight:bold">(),</span>
        <span style="color:#000">MONGO_DATABASE</span>: <span style="color:#204a87;font-weight:bold">Joi.string</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">required</span><span style="color:#000;font-weight:bold">(),</span>
        <span style="color:#000">MONGO_PATH</span>: <span style="color:#204a87;font-weight:bold">Joi.string</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">required</span><span style="color:#000;font-weight:bold">(),</span>
      <span style="color:#000;font-weight:bold">}),</span>
    <span style="color:#000;font-weight:bold">}),</span>
    <span style="color:#000">MongooseModule</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">forRootAsync</span><span style="color:#000;font-weight:bold">({</span>
      <span style="color:#000">imports</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">ConfigModule</span><span style="color:#000;font-weight:bold">],</span>
      <span style="color:#000">useFactory</span>: <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">configService</span>: <span style="color:#204a87;font-weight:bold">ConfigService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">username</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">configService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;MONGO_USERNAME&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">password</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">configService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;MONGO_PASSWORD&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">database</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">configService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;MONGO_DATABASE&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">host</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">configService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;MONGO_HOST&#34;</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">uri</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">`mongodb://</span><span style="color:#4e9a06">${</span><span style="color:#000">username</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">:</span><span style="color:#4e9a06">${</span><span style="color:#000">password</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">@</span><span style="color:#4e9a06">${</span><span style="color:#000">host</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dbName</span>: <span style="color:#204a87;font-weight:bold">database</span> <span style="color:#000;font-weight:bold">};</span>
      <span style="color:#000;font-weight:bold">},</span>
      <span style="color:#000">inject</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">ConfigService</span><span style="color:#000;font-weight:bold">],</span>
    <span style="color:#000;font-weight:bold">}),</span>
    <span style="color:#000">PostsModule</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">],</span>
  <span style="color:#000">controllers</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[],</span>
  <span style="color:#000">providers</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[],</span>
<span style="color:#000;font-weight:bold">})</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">AppModule</span> <span style="color:#000;font-weight:bold">{}</span>
</code></pre></div><h2 id="保存和检索数据">保存和检索数据</h2>
<p>With MongoDB, we operate on documents grouped into collections.
To start saving and retrieving data with MongoDB and Mongoose, we first need to define a schema.
This might seem surprising at first because MongoDB is considered schemaless.
Even though MongoDB is flexible, Mongoose uses schemas to operate on collections and define their shape.</p>
<h2 id="定义一个模式">定义一个模式</h2>
<p>每个模式映射到一个 MongoDB 集合。
它还定义了其中文档的形状。</p>
<p>post.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PostDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Post</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">content</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">PostSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>使用<code>@Schema()</code>装饰器，我们可以将类标记为模式定义，并将其映射到 MongoDB 集合。
我们使用<code>@Prop()</code>装饰器来确定文档的属性。
多亏了 TypeScript 元数据，我们的属性的模式类型是自动推断出来的。</p>
<p>我们将在后续文章中展开定义模式的主题。</p>
<h2 id="使用模型">使用模型</h2>
<p>Mongoose 将我们的模式包装成模型。
我们可以使用它们来创建和读取文档。
为了让我们的服务使用模型，我们需要将其添加到我们的模块中。</p>
<p>posts.module.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Module</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">MongooseModule</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostsController</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./posts.controller&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostsService</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./posts.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostSchema</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Module</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">imports</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">MongooseModule</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">forFeature</span><span style="color:#000;font-weight:bold">([{</span> <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">Post.name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">schema</span>: <span style="color:#204a87;font-weight:bold">PostSchema</span> <span style="color:#000;font-weight:bold">}])],</span>
  <span style="color:#000">controllers</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">PostsController</span><span style="color:#000;font-weight:bold">],</span>
  <span style="color:#000">providers</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">],</span>
<span style="color:#000;font-weight:bold">})</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsModule</span> <span style="color:#000;font-weight:bold">{}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostsModule</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>我们还需要将模型注入到我们的服务中:</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>一旦我们这样做了，我们就可以开始与我们的收藏进行交互了。</p>
<h2 id="获取所有实体">获取所有实体</h2>
<p>我们能做的最基本的事情是获取所有文档的列表。
为此，我们需要<code>find()</code>方法:</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">findAll() {</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">find</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="获取单个实体">获取单个实体</h2>
<p>Every document we create is assigned with a string id.
If we want to fetch a single document, we can use the findById method:</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">NotFoundException</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">findOne</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">post</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findById</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">NotFoundException</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">post</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="创建实体">创建实体</h2>
<p>In the fourth part of this series, we’ve tackled data validation.
Let’s create a Data Transfer Object for our entity.</p>
<p>post.dto.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">IsString</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">IsNotEmpty</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostDto</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@IsString</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@IsNotEmpty</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@IsString</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@IsNotEmpty</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">content</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostDto</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>We can now use it when creating a new instance of our model and saving it.</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostDto</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./dto/post.dto&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#000">create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">postData</span>: <span style="color:#204a87;font-weight:bold">PostDto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">createdPost</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">postData</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">createdPost</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">save</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="更新实体">更新实体</h2>
<p>We might also need to update an entity we’ve already created.
To do that, we can use the findByIdAndUpdate method:</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">NotFoundException</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostDto</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./dto/post.dto&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">postData</span>: <span style="color:#204a87;font-weight:bold">PostDto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">post</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findByIdAndUpdate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">postData</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">setOptions</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">overwrite</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">new</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">NotFoundException</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">post</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Above, a few important things are happening.
Thanks to using the new: true parameter, the findByIdAndUpdate method returns an updated version of our entity.</p>
<p>By using overwrite: true, we indicate that we want to replace a whole document instead of performing a partial update.
This is what differentiates the PUT and PATCH HTTP methods.</p>
<p>If you want to know more, check out TypeScript Express tutorial #15.
Using PUT vs PATCH in MongoDB with Mongoose.</p>
<h2 id="删除实体">删除实体</h2>
<p>To delete an existing entity, we need to use the findByIdAndDelete method:</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">NotFoundException</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">postId</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findByIdAndDelete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">postId</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">NotFoundException</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="定义一个控制器">定义一个控制器</h2>
<p>一旦我们的服务启动并运行，我们就可以在控制器中使用它:</p>
<p>posts.controller.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Body</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Get</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Param</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Put</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostsService</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./posts.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">ParamsWithId</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../utils/paramsWithId&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostDto</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./dto/post.dto&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Controller</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;posts&#34;</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsController</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">postsService</span>: <span style="color:#204a87;font-weight:bold">PostsService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">@Get</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">getAllPosts() {</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findAll</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#204a87;font-weight:bold">@Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;:id&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">getPost</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Param</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span> <span style="color:#000;font-weight:bold">}</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">ParamsWithId</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findOne</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#204a87;font-weight:bold">@Post</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">createPost</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Body</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">post</span>: <span style="color:#204a87;font-weight:bold">PostDto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#204a87;font-weight:bold">@Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;:id&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">deletePost</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Param</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span> <span style="color:#000;font-weight:bold">}</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">ParamsWithId</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#204a87;font-weight:bold">@Put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;:id&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">updatePost</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Param</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span> <span style="color:#000;font-weight:bold">}</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">ParamsWithId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">@Body</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">post</span>: <span style="color:#204a87;font-weight:bold">PostDto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">post</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>上面的关键部分是我们已经定义了 ParamsWithId 类。
使用它，我们可以验证提供的字符串是否是一个有效的 MongoDB id:</p>
<p>paramsWithId.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">IsMongoId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">ParamsWithId</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@IsMongoId</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">ParamsWithId</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><h2 id="summary">Summary</h2>
<p>In this article, we’ve learned the very basics of how to use MongoDB with NestJS.
To do that, we’ve created a local MongoDB database using Docker Compose and connected it with NestJS and Mongoose.
To better grasp MongoDB, we’ve also compared it to SQL databases such as Postgres.
There are still a lot of things to cover when it comes to MongoDB, so stay tuned!</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-dcc33887b60b5620de8e60d4faae18bc">2.2 - 实现与MongoDB的关系</h1>
    
	<p>An essential thing about MongoDB is that it is non-relational. Therefore, it might not be the best fit if relationships are a big part of our database design. That being said, we definitely can mimic SQL-style relations by using references of embedding documents directly.</p>
<p>You can get all of the code from this article in this repository.</p>
<h2 id="定义初始模式">定义初始模式</h2>
<p>In this article, we base the code on many of the functionalities we’ve implemented in the previous parts of this series. If you want to know how we register and authenticate users, check out API with NestJS #3. Authenticating users with bcrypt, Passport, JWT, and cookies.</p>
<p>Let’s start by defining a schema for our users.</p>
<p>user.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Exclude</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Transform</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">UserDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">User</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">())</span>
  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#204a87;font-weight:bold">unique</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@Exclude</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">password</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">UserSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>A few significant things are happening above. We use unique: true above to make sure that all users have unique emails. It sets up unique indexes under the hood and deserves a separate article.</p>
<p>The @Exclude and @Transform decorators come from the class-transformer library. We cover serialization in more detail in API with NestJS #5. Serializing the response with interceptors. There is a significant catch here with MongoDB and Mongoose, though.</p>
<p>The Mongoose library that we use for connecting to MongoDB and fetching entities does not return instances of our User class. Therefore, the ClassSerializerInterceptor won’t work out of the box. Let’s change it a bit using the mixin pattern.</p>
<p>mongooseClassSerializer.interceptor.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ClassSerializerInterceptor</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PlainLiteralObject</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ClassTransformOptions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">plainToClass</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">MongooseClassSerializerInterceptor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">classToIntercept</span>: <span style="color:#204a87;font-weight:bold">Type</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">ClassSerializerInterceptor</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Interceptor</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">ClassSerializerInterceptor</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">changePlainObjectToClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">document</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">PlainLiteralObject</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">document</span> <span style="color:#204a87;font-weight:bold">instanceof</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">document</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#000;font-weight:bold">}</span>

      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">plainToClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">classToIntercept</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">document</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toJSON</span><span style="color:#000;font-weight:bold">());</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">prepareResponse</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span>: <span style="color:#204a87;font-weight:bold">PlainLiteralObject</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">PlainLiteralObject</span><span style="color:#000;font-weight:bold">[])</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">Array</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isArray</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">changePlainObjectToClass</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span>

      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">changePlainObjectToClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#000">serialize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span>: <span style="color:#204a87;font-weight:bold">PlainLiteralObject</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">PlainLiteralObject</span><span style="color:#000;font-weight:bold">[],</span> <span style="color:#000">options</span>: <span style="color:#204a87;font-weight:bold">ClassTransformOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">super</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serialize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">prepareResponse</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">};</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">MongooseClassSerializerInterceptor</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>I wrote the above code with the help of Jay McDoniel. The official NestJS discord is a great place to ask for tips.</p>
<p>Above, we change MongoDB documents into instances of the provided class. Let’s use it with our controller:</p>
<p>authentication.controller.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Body</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UseInterceptors</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AuthenticationService</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./authentication.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">RegisterDto</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./dto/register.dto&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../users/user.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">MongooseClassSerializerInterceptor</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../utils/mongooseClassSerializer.interceptor&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Controller</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;authentication&#34;</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">@UseInterceptors</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">MongooseClassSerializerInterceptor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">))</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">AuthenticationController</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">authenticationService</span>: <span style="color:#204a87;font-weight:bold">AuthenticationService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">@Post</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;register&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">register</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Body</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">registrationData</span>: <span style="color:#204a87;font-weight:bold">RegisterDto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">authenticationService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">register</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">registrationData</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Thanks to doing the above, we exclude the password when returning the data of the user.</p>
<h2 id="一对一">一对一</h2>
<p>With the one-to-one relationship, the document in the first collection has just one matching document in the second collection and vice versa. Let’s create a schema for the address:</p>
<p>address.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Transform</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">AddressDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Address</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Address</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">())</span>
  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">city</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">street</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">AddressSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Address</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>There is a big chance that just one user is assigned to a particular address in our application. Therefore, it is a good example of a one-to-one relationship. Because of that, we can take advantage of embedding documents, which is an approach very good performance-wise.</p>
<p>For it to work properly, we need to explicitly pass AddressSchema to the @Prop decorator:</p>
<p>user.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ObjectId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Exclude</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Transform</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Address</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">AddressSchema</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./address.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">UserDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">User</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">())</span>
  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">ObjectId</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#204a87;font-weight:bold">unique</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@Exclude</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">password</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">AddressSchema</span> <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Address</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000">address</span>: <span style="color:#204a87;font-weight:bold">Address</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">UserSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>We use @Type(() =&gt; Address) above to make sure that the class-transformer transforms the Address object too.</p>
<p>When we create the document for the user, MongoDB also creates the document for the address. It also gives it a distinct id.</p>
<p>In our one-to-one relationship example, the user has just one address. Also, one address belongs to only one user. Since that’s the case, it makes sense to embed the user straight into the user’s document. This way, MongoDB can return it fast. Let’s use MongoDB Compass to make sure that this is the case here.</p>
<h2 id="一对多">一对多</h2>
<p>We implement the one-to-many and many-to-one relationships when a document from the first collection can be linked to multiple documents from the second collection. Documents from the second collection can be linked to just one document from the first collection.</p>
<p>Great examples are posts and authors where the user can be an author of multiple posts. In our implementation, the post can only have one author, though.</p>
<p>post.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ObjectId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">mongoose</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../users/user.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Transform</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PostDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Post</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">())</span>
  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">ObjectId</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">content</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">mongoose</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ref</span>: <span style="color:#204a87;font-weight:bold">User.name</span> <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000">author</span>: <span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">PostSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>Thanks to defining the above reference, we can now assign the user to the author property in the post.</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostDto</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./dto/post.dto&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../users/user.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#000">create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">postData</span>: <span style="color:#204a87;font-weight:bold">PostDto</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">author</span>: <span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">createdPost</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">({</span>
      <span style="color:#000;font-weight:bold">...</span><span style="color:#000">postData</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">author</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000;font-weight:bold">});</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">createdPost</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">save</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><h3 id="使用-mongoose-填充数据">使用 Mongoose 填充数据</h3>
<p>Saving the posts like that results in storing the id of the author in the database.</p>
<p>A great thing about it is that we can easily replace the id with the actual data using the populate function Mongoose provides.</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">findAll() {</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">find</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;author&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>Doing the above results in Mongoose returning the data of the author along with the post.</p>
<h3 id="参考点的方向">参考点的方向</h3>
<p>In the code above, we store the id of the author in the document of the post.
We could do that the other way around and store the posts’ id in the author’s document.
When deciding that, we need to take a few factors into account.</p>
<p>First, we need to think of how many references we want to store.
Imagine a situation where we want to store logs for different machines in our server room. We need to remember that the maximum size of a MongoDB document is 16MB.
If we store an array of the ids of the Log document in the Machine document, in theory, we could run out of space at some point. We can store a single id of the machine in the Log document instead.</p>
<p>The other thing to think through is what queries we will run most often.
For example, in our implementation of posts and authors, it is effortless to retrieve the author’s data if we have the post.
This is thanks to the fact that we store the author’s id in the document of the post. On the other hand, it would be more time-consuming to retrieve a list of posts by a single user.
To do that, we would need to query all of the posts and check the author’s id.</p>
<p>We could implement two-way referencing and store the reference on both sides to deal with the above issue.
The above would speed up some of the queries but require us to put more effort into keeping our data consistent.</p>
<h3 id="嵌入">嵌入</h3>
<p>We could also embed the document of the posts into the document of the user. The advantage of doing that would be not performing additional queries to the database to get the missing information. But, unfortunately, this would make getting a particular post more difficult.</p>
<h2 id="多对多">多对多</h2>
<p>Another important relationship to consider is many-to-many. A document from the first collection can refer to multiple documents from the second collection and the other way around.</p>
<p>A good example would be posts that can belong to multiple categories. Also, a single category can belong to multiple posts. First, let’s define the schema of our category.</p>
<p>category.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ObjectId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Transform</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">CategoryDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Category</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Category</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">())</span>
  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">ObjectId</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">CategorySchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Category</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>Now we can use it in the schema of the user.</p>
<p>user.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ObjectId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">mongoose</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../users/user.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Transform</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Category</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../categories/category.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PostDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Post</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">())</span>
  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">ObjectId</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">content</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">mongoose</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ref</span>: <span style="color:#204a87;font-weight:bold">User.name</span> <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000">author</span>: <span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span>
    <span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[{</span> <span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">mongoose</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ref</span>: <span style="color:#204a87;font-weight:bold">Category.name</span> <span style="color:#000;font-weight:bold">}],</span>
  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Category</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000">categories</span>: <span style="color:#204a87;font-weight:bold">Category</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">PostSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>A thing worth knowing is that we can also use the populate method right after saving our document.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostDto</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./dto/post.dto&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../users/user.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">postData</span>: <span style="color:#204a87;font-weight:bold">PostDto</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">author</span>: <span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">createdPost</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">({</span>
      <span style="color:#000;font-weight:bold">...</span><span style="color:#000">postData</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">author</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000;font-weight:bold">});</span>
    <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">createdPost</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;categories&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">execPopulate</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">createdPost</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">save</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>上面的一件重要的事情是，我们在 MongoDB 文档的一个实例上调用 populate 方法。
由于是这种情况，我们还需要调用 execPopulate 来运行它。
在我们的其余示例中，我们在 MongoDB 查询的一个实例上调用 populate，这是不需要的。</p>
<h2 id="总结">总结</h2>
<p>在本文中，我们介绍了使用 NestJS 在 MongoDB 中定义文档之间的关系。
我们已经学习了各种类型的关系，并考虑了如何存储引用以提高性能。
我们还讨论了如何用 NestJS 和 MongoDB 实现序列化。
还有很多东西要学，所以请继续关注!</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4451ab685262406c61d37462ff2cf30c">2.3 - MongoDB和Mongoose的虚拟属性</h1>
    
	<p>在本系列中，我们使用 Mongoose 在模式中定义属性，并使用文档的模型。
我们还定义了集合之间的各种关系。
使用 Mongoose，我们还可以利用没有存储在 MongoDB 中的虚拟属性。
要理解它们，我们首先要掌握 <code>getter</code> 和 <code>setter</code> 的概念。</p>
<p>您可以在这个存储库中找到本文中的代码。</p>
<h2 id="mongoose-的-getters-和-setters">Mongoose 的 Getters 和 setters</h2>
<p>当使用 <code>getter</code> 和 <code>setter</code> 在文档中获取和设置属性时，可以执行自定义逻辑。</p>
<h3 id="getters">Getters</h3>
<p>通过使用 <code>getter</code> ，我们可以在检索文档数据时修改文档数据。
让我们创建一个示例，当用户有一个信用卡号码时，我们希望在响应 API 请求时对其进行混淆。</p>
<p>user.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">UserDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">User</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">toJSON</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">getters</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">})</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#204a87;font-weight:bold">unique</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span>
    <span style="color:#204a87;font-weight:bold">get</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">creditCardNumber</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">creditCardNumber</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">lastFourDigits</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">creditCardNumber</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">slice</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">creditCardNumber</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">`****-****-****-</span><span style="color:#4e9a06">${</span><span style="color:#000">lastFourDigits</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000">creditCardNumber?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">UserSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>当我们从 API 返回文档时，NestJS 将我们的数据字符串化。
当这种情况发生时， <code>toJSON</code> 方法就会在我们的 Mongoose 模型上被调用。
因此，如果我们想要考虑我们的 <code>getter</code> ，我们需要在配置中显式地添加 <code>getter:true</code>。</p>
<p>文档也有 tobject 方法，我们可以用类似的方式自定义它。</p>
<p>我们也在 mongoosecasserializerinterceptor 中使用 toJSON。
要了解更多细节，请查看 NestJS #44 中的 API。
实现与 MongoDB 的关系</p>
<p>在上面的代码中，每次从 API 返回用户文档时，都会混淆信用卡号。</p>
<p>Mongoose 为我们的模式分配一个 id 字段的虚 <code>getter</code> 。
它现在出现在响应中，因为我们通过 <code>getters:true</code> 打开了 getters。
稍后会有更多关于虚拟的内容。</p>
<p>有时，我们希望访问原始的、未修改的属性。
为此，我们可以使用 <code>Document.prototype.get()</code> 函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">usersService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getByEmail</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">email</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">creditCardNumber</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">usersService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getByEmail</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">email</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><h3 id="setters">Setters</h3>
<p>使用 <code>setter</code> ，我们可以在将数据保存到数据库之前修改数据。</p>
<p>post.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ObjectId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Transform</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PostDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Post</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">())</span>
  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">ObjectId</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span>
    <span style="color:#204a87;font-weight:bold">set</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">content</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">content</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">trim</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000">content</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">PostSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>由于做了上述操作，我们现在从内容字符串的两端删除空白。</p>
<p>虽然<code>setter</code>是一种有效的技术，但是为了提高可读性，您可能更愿意将此逻辑放在服务中。
然而，即使是这样，<code>setter</code>也是值得了解的。</p>
<h2 id="虚拟属性">虚拟属性</h2>
<p><code>virtual</code> 是我们可以获取和设置的属性，但它不存储在数据库中。
让我们定义一个简单的用例示例。</p>
<p>user.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">UserDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">User</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">firstName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">lastName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">fullName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">UserSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>不幸的是，上述方法是有缺陷的。
如果我们将 <code>fullName</code> 属性持久化到 MongoDB 中，我们将复制信息，因为我们已经有了 firstName 和 lastName。
更合适的方法是基于其他属性动态创建 <code>fullName</code> 。</p>
<h3 id="getters-1">Getters</h3>
<p>我们可以通过虚拟财产实现上述目的。
让我们创建它和 <code>getter</code> 。</p>
<p>user.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">UserDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">User</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">toJSON</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">virtuals</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">})</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">firstName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">lastName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#000">fullName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">UserSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">UserSchema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">virtual</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;fullName&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">UserDocument</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">`</span><span style="color:#4e9a06">${</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">firstName</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> </span><span style="color:#4e9a06">${</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lastName</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">UserSchema</span> <span style="color:#000;font-weight:bold">};</span>
</code></pre></div><p>请注意，我们没有在<code>fullName</code>属性上使用<code>@Prop()</code>装饰器。
相反，我们调用文件底部的<code>UserSchema.virtual</code>函数。</p>
<p>由于添加了<code>virtuals:true</code>，我们的虚拟属性在将文档转换为 <code>JSON</code> 时是可见的。
尽管我们可以在上面的响应中看到 <code>fullName</code> ，但它并没有保存到数据库中。</p>
<h3 id="setters-1">Setters</h3>
<p>使用 <code>virtual</code> ，我们还可以创建 <code>setter</code> 。
例如，我们可以使用它们一次设置多个属性。</p>
<p>user.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ObjectId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Transform</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">UserDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">User</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">toJSON</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">getters</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">virtuals</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">})</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">firstName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">lastName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#000">fullName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">UserSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">UserSchema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">virtual</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;fullName&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">UserDocument</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">`</span><span style="color:#4e9a06">${</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">firstName</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> </span><span style="color:#4e9a06">${</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lastName</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">UserDocument</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fullName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">firstName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lastName</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fullName</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">split</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34; &#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">firstName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lastName</span> <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">UserSchema</span> <span style="color:#000;font-weight:bold">};</span>
</code></pre></div><p>上面，我们基于 <code>fullName</code> 设置了 <code>firstName</code> 和 <code>lastName</code> 属性。</p>
<h2 id="填充虚拟属性">填充虚拟属性</h2>
<p>虚拟属性的一个便利特性是使用它们来填充来自另一个集合的文档。</p>
<p>我们学习了使用 NestJS 在 API 中填充特性的基础知识 <a href="">#44.使用 MongoDB 实现关系</a></p>
<p>在上一篇文章的示例中，我们为一篇文章创建了一个模式，使用它来存储对作者的引用。</p>
<p>post.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ObjectId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">mongoose</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../users/user.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Transform</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PostDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Post</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">())</span>
  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">ObjectId</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">content</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">mongoose</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ref</span>: <span style="color:#204a87;font-weight:bold">User.name</span> <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000">author</span>: <span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">PostSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>因此，当我们获取 <code>User</code> 文档时，我们没有任何帖子的信息。
我们可以使用虚拟属性来解决这个问题。</p>
<p>user.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../posts/post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">UserDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">User</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">toJSON</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">getters</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">virtuals</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">})</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#204a87;font-weight:bold">unique</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000">posts</span>: <span style="color:#204a87;font-weight:bold">Post</span><span style="color:#000;font-weight:bold">[];</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">UserSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">UserSchema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">virtual</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;posts&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ref</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">localField</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;_id&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">foreignField</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;author&#34;</span> <span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">UserSchema</span> <span style="color:#000;font-weight:bold">};</span>
</code></pre></div><p>最后一步是调用 <code>populate</code> 函数以及用户的文档。
同时，我们还可以填充嵌套的 <code>categories</code> 属性。</p>
<p>users.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NotFoundException</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">UserDocument</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./user.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UsersService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">userModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">UserDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">getById</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">userModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findById</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;posts&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">populate</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;categories&#34;</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">});</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">NotFoundException</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="总结">总结</h2>
<p>在本文中，我们学习了什么是虚拟属性以及它们如何有用。
我们已经使用它们来添加简单的属性和填充来自其他集合的文档。
为了更好地掌握 <code>virtual</code> 的概念，我们还研究了 <code>getter</code> 和 <code>setter</code> 。
当使用 <code>Mongoose</code> 来定义 <code>MongoDB</code> 模式时，上述所有内容肯定会派上用场。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d6a0d2e2730441d8a1bbcc80b1877247">2.4 - 与MongoDB和Mongoose管理事务</h1>
    
	<p>在使用数据库时，保持数据的完整性至关重要。
例如，想象一下把钱从一个银行账户转到另一个。
为此，我们需要执行两个独立的操作。
首先，我们从第一个银行账户中提取金额。
然后，我们将相同的金额添加到第二个帐户。</p>
<p>如果由于某种原因第二次操作失败，而第一次操作成功，则会导致数据库的状态无效。
我们需要上述所有操作的成功或失败。
我们可以通过事务来实现这一点。</p>
<h2 id="acid-properties">ACID properties</h2>
<p>A transaction to be valid needs to have the following properties.
Together, they form the ACID acronym:</p>
<h2 id="atomicity">Atomicity</h2>
<p>Operations in the transaction are a single unit.
Therefore, it either fully succeeds or fails together.</p>
<h2 id="consistency">Consistency</h2>
<p>The transaction moves the database from one valid state to the next.</p>
<h2 id="isolation">Isolation</h2>
<p>The isolation property ensures that multiple transactions can occur concurrently, resulting in a valid database state.
To better understand that, let’s continue the example with the banking transaction from above.
Another transaction should see the funds in one account or the other, but not in both.</p>
<h2 id="durability">Durability</h2>
<p>Once the changes from a transaction are committed, they should survive permanently.</p>
<h2 id="transactions-in-mongodb-and-mongoose">Transactions in MongoDB and Mongoose</h2>
<p>Fortunately, MongoDB is equipped with support for multi-document transactions since version 4.0.
We can tell the database that we do a transaction, and it keeps track of every update we make.
If something fails, then the database rolls back all our updates.
The above requires the database to do extra work making notes of our updates and locking the involved resources.
Other clients trying to perform operations on the data might be stuck waiting for the transaction to complete.
Therefore, this is something to watch out for.</p>
<h2 id="running-a-replica-set">Running a replica set</h2>
<p>Transactions with MongoDB only work with a replica set, a group of MongoDB processes that maintain the same data set.
In this series, we’ve been using docker-compose to run MongoDB for us.
We can either run a replica set locally with docker or use MongoDB atlas.
For this article, I’m doing the latter.</p>
<p>If you want to run a replica set, check out this page on Stackoverflow.</p>
<h2 id="deleting-a-user">Deleting a user</h2>
<p>Let’s implement a feature of deleting a user.
When we remove users from the database, we also want to delete all posts they wrote.</p>
<p>users.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NotFoundException</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">UserDocument</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./user.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostsService</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../posts/posts.service&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UsersService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span>
    <span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">userModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">UserDocument</span><span style="color:#000;font-weight:bold">&gt;,</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">postsService</span>: <span style="color:#204a87;font-weight:bold">PostsService</span>
  <span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">userModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findByIdAndDelete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;posts&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">NotFoundException</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">posts</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">posts</span><span style="color:#000;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deleteMany</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">posts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">_id</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">()));</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">UsersService</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>To do the above, we also need to define the deleteMany in our PostsService.</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">deleteMany</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ids</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">[])</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deleteMany</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">ids</span> <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>The shortcoming of the above code is that the delete method might succeed partially.
When this happens, we delete the user, but the posts are left in the database without the author.
We can deal with the above issue by defining a transaction.</p>
<p>To start a transaction, we need to access the connection we’ve established with MongoDB.
To do that, we can use the @InjectConnection decorator:</p>
<p>users.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">UserDocument</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./user.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostsService</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../posts/posts.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectConnection</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">mongoose</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UsersService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span>
    <span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">userModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">UserDocument</span><span style="color:#000;font-weight:bold">&gt;,</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">postsService</span>: <span style="color:#204a87;font-weight:bold">PostsService</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">@InjectConnection</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">connection</span>: <span style="color:#204a87;font-weight:bold">mongoose.Connection</span>
  <span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">UsersService</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><h2 id="控制事务">控制事务</h2>
<p>There are two ways of working with transactions with Mongoose.
To have full control over it, we can call the startTransaction method:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">session</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">connection</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startSession</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startTransaction</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div><p>When we indicate that everything worked fine, we need to call session.commitTransaction().
This writes our changes to the database.</p>
<p>If we encounter an error, we need to call session.abortTransaction() to indicate that we want to discard the operations we’ve performed so far.
Once we’re done with the transaction, we need to call the session.endSession() method.</p>
<p>To indicate that we want to perform an operation within a given session, we need to use the session() method.</p>
<p>users.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UsersService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">session</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">connection</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startSession</span><span style="color:#000;font-weight:bold">();</span>

    <span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startTransaction</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">userModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findByIdAndDelete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;posts&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">);</span>

      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">NotFoundException</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">posts</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">posts</span><span style="color:#000;font-weight:bold">;</span>

      <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deleteMany</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">posts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">_id</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">()));</span>
      <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">commitTransaction</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">abortTransaction</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#000">error</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">finally</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">endSession</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Still, there is an important issue with the above code.
Although we’ve deleted the user within a transaction, we didn’t do that when removing posts.
To delete posts within a session, we need to modify the postsService.deleteMany function:</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">mongoose</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">deleteMany</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ids</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">[],</span> <span style="color:#000">session</span>: <span style="color:#204a87;font-weight:bold">mongoose.ClientSession</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">null</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deleteMany</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">ids</span> <span style="color:#000;font-weight:bold">}).</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>By adding the optional session argument to the deleteMany method, we can delete posts within a transaction.
Let’s use it:</p>
<p>users.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UsersService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">session</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">connection</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startSession</span><span style="color:#000;font-weight:bold">();</span>

    <span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startTransaction</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">userModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findByIdAndDelete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;posts&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">);</span>

      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">NotFoundException</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">posts</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">posts</span><span style="color:#000;font-weight:bold">;</span>

      <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deleteMany</span><span style="color:#000;font-weight:bold">(</span>
        <span style="color:#000">posts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">_id</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">()),</span>
        <span style="color:#000">session</span>
      <span style="color:#000;font-weight:bold">);</span>
      <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">commitTransaction</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">abortTransaction</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#000">error</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">finally</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">endSession</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>If removing the posts fail for some reason, the user is not deleted from the database either.
Thanks to that, the whole operation either succeeds as a whole or fails completely.</p>
<p>A simpler way of using transactions
Instead of controlling every step of the transaction manually, we can use the session.withTransaction() helper.</p>
<p>users.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">session</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">connection</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startSession</span><span style="color:#000;font-weight:bold">();</span>

<span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">withTransaction</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">userModel</span>
<span style="color:#000;font-weight:bold">.</span><span style="color:#000">findByIdAndDelete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;posts&#39;</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">.</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">);</span>

    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">NotFoundException</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">posts</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">posts</span><span style="color:#000;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deleteMany</span><span style="color:#000;font-weight:bold">(</span>
      <span style="color:#000">posts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">_id</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">()),</span>
      <span style="color:#000">session</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000;font-weight:bold">);</span>

<span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">endSession</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Please notice that we no longer need to call startTransaction(), commitTransaction(), and abortTransaction().
We still are required to end the session with the endSession method, though.</p>
<h2 id="summary">Summary</h2>
<p>In this article, we’ve gone through transactions in MongoDB by describing their principles and use-cases.
We’ve also implemented them into our application with Mongoose.
It is definitely worth it to understand transactions because they can increase the reliability of our application quite a lot.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9dafda6a3ad4a457c936f5058f3f4460">2.5 - 使用MongoDB和Mongoose实现分页</h1>
    
	<p>当我们的应用程序增长时，数据库也会增长。
在某些情况下，我们可能会从端点返回大量数据。
例如，对于我们的前端应用程序来说，这可能会被证明是太多了。
因此，我们可能需要通过返回记录的一部分来对记录进行分页。
本文探讨了使用 MongoDB 和 Mongoose 实现这一目标的不同方法，并考虑了它们的优缺点。</p>
<p>您可以在这个存储库中找到本文中的代码。</p>
<h2 id="使用-skip-和-limit">使用 skip 和 limit</h2>
<p>最直接的分页形式是期望用户提供他们想要跳过的文档数量。
此外，他们还可以声明希望接收多少文件。</p>
<p>为了成功实现分页，我们需要一个可预测的文档顺序。
为了实现这一点，我们必须对它们进行排序:</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">findAll() {</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">find</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">sort</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">}).</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;author&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;categories&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>通过执行<code>sort({ _id: 1 })</code>，我们按升序排序。</p>
<p>上面，我们在 MongoDB 中使用了 id 的一个重要特性。
MongoDB 中的 id 由 12 个字节组成，其中 4 个字节是时间戳。
在这样做的同时，我们需要意识到一些缺点:</p>
<p>时间戳的值以秒为单位，在同一秒内创建的文档没有保证有效的顺序，
id 由可能具有不同系统时钟的客户端生成。
根据<code>_id</code>进行排序有一个显著的优势，因为 MongoDB 在<code>_id</code>字段上创建了一个唯一的索引。
这增加了按<code>_id</code>对文档进行排序的性能。</p>
<h3 id="实现分页">实现分页</h3>
<p>实现上述方法的第一步是允许用户通过查询参数提供偏移量和限制。
为此，让我们使用类验证器和类转换器。</p>
<p>paginationParams.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">IsNumber</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Min</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">IsOptional</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PaginationParams</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#204a87">Number</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">@IsNumber</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@Min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000">skip?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#204a87">Number</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">@IsNumber</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@Min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000">limit?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>如果您想了解更多关于类验证器和类转换器的信息，请参阅错误处理和数据验证以及使用拦截器序列化响应。</p>
<p>我们现在可以在控制器中使用上述参数:</p>
<p>posts.controller.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Get</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Query</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UseInterceptors</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostsService</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./posts.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">MongooseClassSerializerInterceptor</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../utils/mongooseClassSerializer.interceptor&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">PostModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">PaginationParams</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../utils/paginationParams&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Controller</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;posts&#34;</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">@UseInterceptors</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">MongooseClassSerializerInterceptor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PostModel</span><span style="color:#000;font-weight:bold">))</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsController</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">postsService</span>: <span style="color:#204a87;font-weight:bold">PostsService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">@Get</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">getAllPosts</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Query</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">skip</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">limit</span> <span style="color:#000;font-weight:bold">}</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">PaginationParams</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skip</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">limit</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>现在我们可以在 findAll 方法中使用上述参数。</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">findAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">documentsToSkip</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">limitOfDocuments?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">query</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">find</span><span style="color:#000;font-weight:bold">()</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">sort</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">})</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">skip</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">documentsToSkip</span><span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;author&#34;</span><span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;categories&#34;</span><span style="color:#000;font-weight:bold">);</span>

    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">limitOfDocuments</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">query</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">limit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">limitOfDocuments</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">query</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>通过这样做，用户现在可以指定他们想要获取多少篇文章以及要跳过多少篇文章。
例如，请求<code>/posts?skip=20&amp;limit=10</code>在省略前 20 个文档的同时产生 10 个帖子。</p>
<h3 id="计算文件">计算文件</h3>
<p>一种常见的方法是显示我们有多少页面的文章。
为此，我们需要计算数据库中有多少个文档。
为此，我们需要使用聚合框架或执行两个单独的查询。</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">findAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">documentsToSkip</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">limitOfDocuments?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">findQuery</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">find</span><span style="color:#000;font-weight:bold">()</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">sort</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">})</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">skip</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">documentsToSkip</span><span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;author&#34;</span><span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;categories&#34;</span><span style="color:#000;font-weight:bold">);</span>

    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">limitOfDocuments</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">findQuery</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">limit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">limitOfDocuments</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">results</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">findQuery</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">count</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">count</span><span style="color:#000;font-weight:bold">();</span>

    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">results</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">count</span> <span style="color:#000;font-weight:bold">};</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>现在，在我们的响应中，我们得到了结果和文档的总数。</p>
<h3 id="缺点">缺点</h3>
<p>使用限制和偏移量的解决方案在 SQL 数据库和 MongoDB 中都被广泛使用。
不幸的是，它的性能还有改进的空间。
使用 <code>skip()</code> 方法仍然需要数据库从收集的开始进行扫描。
首先，数据库根据 id 对所有文档进行排序。
然后，MongoDB 丢弃指定数量的文档。
对于大的集合来说，这可能是相当多的工作。</p>
<p>除了性能问题，我们还需要考虑一致性。
理想情况下，文档应该只出现在结果中一次。
事实可能并非如此:</p>
<p>第一个用户获取带有文章的第 1 页，
在这之后，第二个用户创建了一个新的帖子——在排序之后，它结束在第 1 页，
第一个用户获取第二个页面。
用户在第二个页面上再次看到第一个页面的最后一个元素。
不幸的是，用户还错过了添加到第一个页面的元素，这更糟糕。</p>
<h3 id="优势">优势</h3>
<p>带有限制和偏移量的方法是常见的，并且易于实现。
它的最大优点是可以直接跳过多个页面的文档。
此外，更改用于排序的列也很简单，包括按多个列排序。
因此，如果期望偏移量不太大，且不一致是可以接受的，那么它是一个可行的解决方案。</p>
<h2 id="键集分页">键集分页</h2>
<p>如果我们非常关心性能，我们可能希望寻找上述方法的替代方法。
其中之一是键集分页。
在这里，我们使用了 MongoDB 中的 id 由时间戳组成的事实，可以进行比较:</p>
<p>我们从 API 中获取一页文档，
我们检查最后一个文档的 id，
然后，请求 id 大于上一个文档 id 的文档。
由于采用了上述方法，数据库不再需要处理不必要的文档。
首先，让我们为用户创建一种方式来提供起始 id。</p>
<p>paginationParams.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">IsNumber</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">IsMongoId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Min</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">IsOptional</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PaginationParams</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@IsMongoId</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">startId?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#204a87">Number</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">@IsNumber</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@Min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000">skip?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#204a87">Number</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">@IsNumber</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@Min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000">limit?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>现在，我们需要在服务中使用 <code>startId</code> 属性。</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">findAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">documentsToSkip</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">limitOfDocuments?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">startId?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">findQuery</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">find</span><span style="color:#000;font-weight:bold">({</span><span style="color:#000">_id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">$gt</span>: <span style="color:#204a87;font-weight:bold">startId</span><span style="color:#000;font-weight:bold">}}).</span><span style="color:#000">sort</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">}).</span><span style="color:#000">skip</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">documentsToSkip</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;author&#39;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;categories&#39;</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">limitOfDocuments</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">findQuery</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">limit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">limitOfDocuments</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">results</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">findQuery</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">count</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">count</span><span style="color:#000;font-weight:bold">();</span>

  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">results</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">count</span> <span style="color:#000;font-weight:bold">};</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>由于执行了<code>$gt: startId</code>，用户只接收到使用提供的 id 的帖子之后创建的帖子。</p>
<h3 id="缺点-1">缺点</h3>
<p>键集分页的一个很大的缺点是需要知道我们想要开始的确切文档。
我们可以通过将其与基于偏移量的分页相结合来克服这个问题。
这种方法的另一个问题是，用户很难一次跳过多个数据页面。</p>
<h3 id="优点">优点</h3>
<p>与基于偏移量的方法相比，键集分页最显著的优点是性能提高。
此外，它还有助于解决用户在获取页面之间添加或删除元素时不一致的问题。</p>
<h2 id="总结">总结</h2>
<p>在本文中，我们比较了 MongoDB 和 Mongoose 两种类型的分页。
我们已经考虑了键集分页和基于偏移量的方法的优缺点。
它们都不是完美的，但将它们结合起来可以涵盖很多不同的情况。
为特定的工作选择合适的工具是至关重要的。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9fc52bf385551b755df4c394152ea50c">2.6 - 使用MongoDB和Mongoose定义索引</h1>
    
	<p>The bigger our database is, the more demanding our queries become in terms of computing power.
A common way of tackling this problem is by creating indexes.
In this article, we explore this concept and create indexes with MongoDB and Mongoose.</p>
<p>When performing a MongoDB query, the database must scan every document in a given collection to find matching documents.
MongoDB can limit the number of records to inspect if we have an appropriate index in our database.
Since it makes it easier to search for the documents in the database, indexes can speed up finding, updating, and deleting.</p>
<p>Under the hood, indexes are data structures that store a small part of the collection’s data in an easy-to-traverse way.
It includes the ordered values of a particular field of the documents.
It makes MongoDB indexes similar to indexes in databases such as PostgreSQL.</p>
<p>When we define indexes, MongoDB needs to store additional data to speed up our queries.
But, unfortunately, it slows down our write queries.
It also takes up more memory.
Therefore, we need to create indexes sparingly.</p>
<h2 id="唯一索引">唯一索引</h2>
<p>The unique index makes sure that we don’t store duplicate values.
We can create it by passing unique: true to the @Prop decorator.</p>
<p>user.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ObjectId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Transform</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">UserDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">User</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">toJSON</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">getters</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">virtuals</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">})</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">())</span>
  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">ObjectId</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#204a87;font-weight:bold">unique</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">UserSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>It is important to know that MongoDB creates a unique index on the _id field when creating a collection.
Therefore, we sometimes refer to it as the primary index.
We take advantage of the above in the last part of this series, where we implement pagination and sort documents by the _id field.</p>
<p>When we sort documents using a field without an index, MongoDB performs sorting at query time.
It takes time and resources to do that and makes our app response slower.
However, having the right index can help us avoid sorting results at query time because the results are already sorted in the index.
Therefore, we can return them immediately.</p>
<p>We need to keep in mind that making a property unique creates an index and slows down our write queries.</p>
<h2 id="使用-mongoose-实现索引">使用 Mongoose 实现索引</h2>
<p>With MongoDB, we can also define secondary indexes that don’t make properties unique.</p>
<p>post.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ObjectId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Transform</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PostDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Post</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">())</span>
  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">ObjectId</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">index</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">PostSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>By doing the above, we speed up queries, such as when we look for a post with a specific title, for example.
We also speed up queries where we sort posts by the title alphabetically.</p>
<h2 id="文本索引">文本索引</h2>
<p>MongoDB 还实现了文本索引，支持对字符串内容的搜索查询。
要定义文本索引，需要使用<code>index()</code>方法。</p>
<p>post.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ObjectId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Transform</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PostDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Post</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">())</span>
  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">ObjectId</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">PostSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">PostSchema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">title</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;text&#34;</span> <span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">PostSchema</span> <span style="color:#000;font-weight:bold">};</span>
</code></pre></div><p>设置文本索引时，可以利用 <code>$text</code> 操作符。
它对用文本索引索引的字段的内容执行文本搜索。</p>
<p>一个集合不能有一个以上的文本索引。</p>
<p>让我们通过添加一个新的查询参数来实现搜索帖子的功能。</p>
<p>post.controller.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Get</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Query</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UseInterceptors</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostsService</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./posts.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">MongooseClassSerializerInterceptor</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../utils/mongooseClassSerializer.interceptor&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">PostModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">PaginationParams</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../utils/paginationParams&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Controller</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;posts&#34;</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">@UseInterceptors</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">MongooseClassSerializerInterceptor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PostModel</span><span style="color:#000;font-weight:bold">))</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsController</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">postsService</span>: <span style="color:#204a87;font-weight:bold">PostsService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">@Get</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">getAllPosts</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Query</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">skip</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">limit</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">startId</span> <span style="color:#000;font-weight:bold">}</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">PaginationParams</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">@Query</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;searchQuery&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">searchQuery</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skip</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">limit</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">startId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">searchQuery</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">//...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>我们还需要将 <code>$text</code> 查询添加到服务中。</p>
<p>post.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">FilterQuery</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">findAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">documentsToSkip</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">limitOfDocuments?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">startId?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">searchQuery?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">filters</span>: <span style="color:#204a87;font-weight:bold">FilterQuery</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">startId</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">_id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$gt</span>: <span style="color:#204a87;font-weight:bold">startId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{};</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">searchQuery</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">filters</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">$text</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$search</span>: <span style="color:#204a87;font-weight:bold">searchQuery</span> <span style="color:#000;font-weight:bold">};</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">findQuery</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">find</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filters</span><span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">sort</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">})</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">skip</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">documentsToSkip</span><span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;author&#34;</span><span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;categories&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">limitOfDocuments</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">findQuery</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">limit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">limitOfDocuments</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">results</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">findQuery</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">count</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">count</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">results</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">count</span> <span style="color:#000;font-weight:bold">};</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>感谢以上，MongoDB 可以搜索我们的文章标题。</p>
<p><code>$text</code>查询有更多的参数，比如 <code>$caseSensitive</code> 布尔值。
更多信息，请查看官方文档。</p>
<h2 id="复合索引">复合索引</h2>
<p>The $text query searches through all of the fields indexed with the text index.
With MongoDB, we can create compound indexes where the index structure holds references to multiple fields.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#000">PostSchema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">title</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;text&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">content</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;text&#34;</span> <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>Thanks to doing the above, the $text query will search both through the titles and contents of posts.</p>
<p>Besides the text indexes, we can also create regular compound indexes.</p>
<p>user.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ObjectId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Transform</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">UserDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">User</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">toJSON</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">getters</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">virtuals</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">})</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">())</span>
  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">ObjectId</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">firstName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">lastName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">UserSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">UserSchema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">firstName</span>: <span style="color:#204a87;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lastName</span>: <span style="color:#204a87;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">UserSchema</span> <span style="color:#000;font-weight:bold">};</span>
</code></pre></div><p>Doing the above creates a compound index on the firstName and lastName fields.
It can speed queries such as the ones where we look for a user with a specific first name and last name.</p>
<p>By using 1, we create an ascending index.
When we use -1, we create a descending index.
The direction doesn’t matter for single key indexes because MongoDB can traverse the index in either direction.
It can be significant for compound indexes, though.
The official documentation and this Stackoverflow page provide a good explanation.</p>
<p><code>@Prop({ index: true })</code> 装饰器创建了一个升序索引。</p>
<h2 id="总结">总结</h2>
<p>在本文中，我们讨论了 MongoDB 中的索引问题。
我们已经解释了不同类型的索引，例如惟一索引、单字段索引和复合索引。
我们还学习了文本索引并使用它们实现了搜索功能。
我们还了解到，创造优势可以加快某些查询的速度，同时降低其他查询的速度。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-87745293d49493ba2db7754c111a3568">2.7 - 用PUT和PATCH更新MongoDB和Mongoose</h1>
    
	<p>When we develop a REST API, there is a set of HTTP methods that we can choose from, such as GET, POST, and DELETE. A crucial thing to understand is that HTTP methods are largely conventional. It is our job to make them work in a way that’s consistent with the specification. For example, in theory, we could delete entities with the GET method. However, we should make our API predictable to make it easy to understand both to developers working on our backend and the users.</p>
<p>A lot of HTTP methods are very straightforward. However, the PUT and PATCH methods are worth digging into a bit more. In this article, we compare both of them and implement them with NestJS and Mongoose.</p>
<p>PUT
The PUT method is responsible for modifying an existing entity. The crucial part about it is that it is supposed to replace an entity. Therefore, if we don’t send a field of an entity when performing a PUT request, the missing field should be removed from the document.</p>
<p>GET /posts/613e2dcbe2b947c10b669292</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">&#34;categories&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[],</span>
  <span style="color:#204a87;font-weight:bold">&#34;_id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;614fa87e4027d3141f28e9e7&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#204a87;font-weight:bold">&#34;title&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;API with NestJS #49. PUT vs PATCH with MongoDB and Mongoose&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#204a87;font-weight:bold">&#34;content&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;...&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#204a87;font-weight:bold">&#34;series&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">&#34;_id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;614fa8364027d3141f28e9e2&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;API with NestJS&#34;</span>
  <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#204a87;font-weight:bold">&#34;author&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">&#34;_id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;61350362017a80b8d443b012&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;email&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;marcin@wanago.io&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;firstName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Marcin&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;lastName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Wanago&#34;</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Above, we can see the properties our post contains. Let’s make a PUT request now.</p>
<p>PUT /posts/614fa87e4027d3141f28e9e7</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">&#34;_id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;614fa87e4027d3141f28e9e7&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#204a87;font-weight:bold">&#34;categories&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[],</span>
  <span style="color:#204a87;font-weight:bold">&#34;title&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;API with NestJS #49. PUT vs PATCH with MongoDB and Mongoose&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#204a87;font-weight:bold">&#34;content&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;...&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#204a87;font-weight:bold">&#34;author&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">&#34;_id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;61350362017a80b8d443b012&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;email&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;marcin@wanago.io&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;firstName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Marcin&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;lastName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Wanago&#34;</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>The crucial thing above is that we didn’t send the series property in the body of our request. Because the PUT method is supposed to replace a whole entity, we’ve deleted the series property.</p>
<p>Implementing the PUT method with MongoDB and Mongoose
There are quite a few ways of implementing a proper PUT method with MongoDB and Mongoose. The findByIdAndUpdate and findOneAndUpdate methods are common, but they don’t replace the whole document by default. Instead, they perform a partial update on it. Because of that, not including a property in the body of the request does not remove it. We can fix that with the overwrite: true option.</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">NotFoundException</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostDto</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./dto/post.dto&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">postData</span>: <span style="color:#204a87;font-weight:bold">PostDto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">post</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">findByIdAndUpdate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">postData</span><span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">setOptions</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">overwrite</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">new</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;author&#34;</span><span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;categories&#34;</span><span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;series&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">NotFoundException</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">post</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>By setting new: true, we indicate that we want the findByIdAndUpdate method to return the modified version of the document.</p>
<p>posts.controller.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Body</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Param</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Put</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UseInterceptors</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostsService</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./posts.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">ParamsWithId</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../utils/paramsWithId&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">MongooseClassSerializerInterceptor</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../utils/mongooseClassSerializer.interceptor&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">PostModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">UpdatePostDto</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./dto/updatePost.dto&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Controller</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;posts&#34;</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">@UseInterceptors</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">MongooseClassSerializerInterceptor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PostModel</span><span style="color:#000;font-weight:bold">))</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsController</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">postsService</span>: <span style="color:#204a87;font-weight:bold">PostsService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">@Put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;:id&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">updatePost</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Param</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span> <span style="color:#000;font-weight:bold">}</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">ParamsWithId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">@Body</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">post</span>: <span style="color:#204a87;font-weight:bold">UpdatePostDto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">post</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Thanks to doing the above, when we update a document, we replace it as a whole and remove not included fields.</p>
<p>We could also use the findOneAndReplace method. Not so long back, it wasn’t included with the TypeScript definitions shipped with the @types/mongoose, unfortunately. Thankfully, the Mongoose team started working on official TypeScript definitions. They released it in version v5.11.0.</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">NotFoundException</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">UpdatePostDto</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./dto/updatePost.dto&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">postData</span>: <span style="color:#204a87;font-weight:bold">UpdatePostDto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">post</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">findOneAndReplace</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">id</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#000">postData</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">new</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;author&#34;</span><span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;categories&#34;</span><span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;series&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">NotFoundException</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">post</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>createPost.dto.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">IsString</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">IsNotEmpty</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">IsMongoId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">IsOptional</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../../users/user.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Category</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../../categories/category.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Series</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../../series/series.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UpdatePostDto</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@IsMongoId</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@IsNotEmpty</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@IsString</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@IsNotEmpty</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@IsString</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@IsNotEmpty</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">content</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Category</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000">categories</span>: <span style="color:#204a87;font-weight:bold">Category</span><span style="color:#000;font-weight:bold">[];</span>

  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">@IsNotEmpty</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">author</span>: <span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Series</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">series?</span>: <span style="color:#204a87;font-weight:bold">Series</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">UpdatePostDto</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>Preventing the id from being updated
Since we expect the users to send the whole document, they also send the _id property. The above doesn’t cause any issues as long as the user doesn’t alter the id. That’s because doing that can cause an unexpected error:</p>
<p>MongoError: Plan executor error during findAndModify :: caused by :: After applying the update, the (immutable) field ‘_id’ was found to have been altered</p>
<p>We can deal with the above error by excluding the _id property from the body of our PUT request.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">IsOptional</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Exclude</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UpdatePostDto</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@Exclude</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">UpdatePostDto</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>Even if the user provides the _id property in the request, we exclude it and don’t pass it to the findOneAndReplace or the findByIdAndUpdate methods. Rest assured, because MongoDB won’t remove the _id property in such a case, even though we are implementing the PUT method here.</p>
<p>PATCH
While the PUT method is a common and valid choice, it might not fit every situation. For example, when implementing the PUT method, we assume that the API users know all of the details of a particular entity. Since omitting single property results in removing it, they need to be careful. A solution to this issue can be the PATCH method.</p>
<p>The PATCH method was introduced to the HTTP protocol in 2010 and aimed to apply a partial modification to an entity. The specification describes it as a set of instructions describing how a resource should be modified. The most straightforward way of implementing the PATCH method is to handle a body with a partial document.</p>
<p>PATCH /posts/614fa87e4027d3141f28e9e7</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">&#34;title&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;A new title&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#204a87;font-weight:bold">&#34;series&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>The above request modifies the post by changing the title and removing the series property. Please note that to delete a field, we need to send the null value explicitly. Thanks to this, no fields are deleted by accident.</p>
<p>Implementing PATCH with MongoDB and Mongoose
To implement a PATCH handler using Mongoose, we can use the findByIdAndUpdate method without the overwrite: true option. First, let’s use the @Patch decorator in our controller:</p>
<p>posts.controller.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Body</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Param</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Patch</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UseInterceptors</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostsService</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./posts.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">ParamsWithId</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../utils/paramsWithId&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">MongooseClassSerializerInterceptor</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../utils/mongooseClassSerializer.interceptor&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">PostModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">UpdatePostDto</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./dto/updatePost.dto&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Controller</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;posts&#34;</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">@UseInterceptors</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">MongooseClassSerializerInterceptor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PostModel</span><span style="color:#000;font-weight:bold">))</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsController</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">postsService</span>: <span style="color:#204a87;font-weight:bold">PostsService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">@Patch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;:id&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">updatePost</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Param</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span> <span style="color:#000;font-weight:bold">}</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">ParamsWithId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">@Body</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">post</span>: <span style="color:#204a87;font-weight:bold">UpdatePostDto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">post</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Now, let’s modify the service:</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">NotFoundException</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">UpdatePostDto</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./dto/updatePost.dto&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">postData</span>: <span style="color:#204a87;font-weight:bold">UpdatePostDto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">post</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">findByIdAndUpdate</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">id</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#000">postData</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">new</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;author&#34;</span><span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;categories&#34;</span><span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;series&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">NotFoundException</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">post</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>For the above to work correctly, we also need to modify our DTO by adding the @IsOptional decorators:</p>
<p>updatePost.dto.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">IsString</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">IsNotEmpty</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">IsOptional</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../../users/user.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Exclude</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Category</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../../categories/category.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Series</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../../series/series.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UpdatePostDto</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@Exclude</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">_id?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@IsString</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@IsNotEmpty</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">title?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@IsString</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@IsNotEmpty</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">content?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Category</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">categories?</span>: <span style="color:#204a87;font-weight:bold">Category</span><span style="color:#000;font-weight:bold">[];</span>

  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@IsNotEmpty</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">author?</span>: <span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Series</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">series?</span>: <span style="color:#204a87;font-weight:bold">Series</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">UpdatePostDto</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>Thanks to adding the @IsOptional decorators, the user no longer has to provide all of the document’s properties.</p>
<p>JSON Patch
An alternative approach to our implementation is to quite literally send a set of instructions on how to modify an object. A way to do that is to use the JSON Patch format.</p>
<p>PATCH /posts/614fa87e4027d3141f28e9e7</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">[</span>
  <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#a40000">op:</span> <span style="color:#204a87;font-weight:bold">&#34;replace&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#a40000">path:</span> <span style="color:#204a87;font-weight:bold">&#34;/content&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#a40000">value:</span> <span style="color:#204a87;font-weight:bold">&#34;A brand new content&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">]</span><span style="color:#a40000">;</span>
</code></pre></div><p>If you want to know more, check out the jsonpatch.com website. Additionally, the fast-json-patch library might come in handy when implementing the above format into your application.</p>
<h2 id="summary">Summary</h2>
<p>In this article, we’ve learned about various ways of implementing the update functionality. Thanks to getting to know both about PUT and PATCH, we can choose the best approach for a particular case. When selecting one of the above, we should follow the specification and implement our API predictably and transparently. If we do that, we will make the life of our teammates and API users easier.</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b64b7e1b4aa2d437b41e6919a564206e">3 - files</h1>
    
	<blockquote>
<p><a href="https://wanago.io/courses/api-with-nestjs/">https://wanago.io/courses/api-with-nestjs/</a></p>
</blockquote>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-a5ce0f5e673a67cd6c90e83f6e52b6e1">3.1 - Uploading files to the server</h1>
    
	<p>到目前为止，在本系列中，我们已经描述了在服务器上存储文件的两种方法。
在第 10 篇文章中，我们向 Amazon S3 上传了文件。
虽然它的可伸缩性很强，但出于各种原因，我们可能不希望使用 AWS 等云服务。
因此，在本系列的第 54 部分中，我们学习了如何直接在 PostgreSQL 数据库中存储文件。
虽然它有一些优势，但它可能被认为在性能方面不够理想。</p>
<p>在本文中，我们将研究如何使用 NestJS 在服务器上存储上传的文件。
同样，我们将一些信息持久化到数据库中，但这一次只是元数据。</p>
<h2 id="在服务器上保存文件">在服务器上保存文件</h2>
<p>幸运的是，NestJS 使得在服务器上存储文件变得非常容易。
我们需要向 FileInterceptor 传递额外的参数。</p>
<p>users.service.ts;</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">UsersService</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./users.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Req</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UploadedFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UseGuards</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UseInterceptors</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">JwtAuthenticationGuard</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../authentication/jwt-authentication.guard&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">RequestWithUser</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../authentication/requestWithUser.interface&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Express</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;express&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">FileInterceptor</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/platform-express&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">diskStorage</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;multer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Controller</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users&#34;</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UsersController</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">usersService</span>: <span style="color:#204a87;font-weight:bold">UsersService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">@Post</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;avatar&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">@UseGuards</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">JwtAuthenticationGuard</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">@UseInterceptors</span><span style="color:#000;font-weight:bold">(</span>
    <span style="color:#000">FileInterceptor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;file&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">storage</span>: <span style="color:#204a87;font-weight:bold">diskStorage</span><span style="color:#000;font-weight:bold">({</span>
        <span style="color:#000">destination</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;./uploadedFiles/avatars&#34;</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000;font-weight:bold">}),</span>
    <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">addAvatar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Req</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">request</span>: <span style="color:#204a87;font-weight:bold">RequestWithUser</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">@UploadedFile</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">file</span>: <span style="color:#204a87;font-weight:bold">Express.Multer.File</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">usersService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">addAvatar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">path</span>: <span style="color:#204a87;font-weight:bold">file.path</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">filename</span>: <span style="color:#204a87;font-weight:bold">file.originalname</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">mimetype</span>: <span style="color:#204a87;font-weight:bold">file.mimetype</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>当我们执行上述操作时，NestJS 将上传的文件存储在<code>./uploadefiles/avatars</code>目录中。</p>
<p>不过，上述方法存在一些问题。
首先，我们可能需要多个端点来接受文件。
在这种情况下，我们需要为它们每个重复配置的某些部分。
此外，我们应该将目标的。<code>/uploaddfiles</code> 部分放在一个环境变量中，以根据应用程序运行的环境来更改它。</p>
<h2 id="扩展-fileinterceptor">扩展 FileInterceptor</h2>
<p>实现上述目标的一种方法是扩展 FileInterceptor。
在查看了 NestJS 的底层之后，我们可以看到它使用了 mixin 模式。
因为 FileInterceptor 不是类，所以不能使用 extend 关键字。</p>
<p>我们想要扩展 FileInterceptor 的功能，当:</p>
<ul>
<li>使用依赖注入来注入 <code>ConfigService</code> ，</li>
<li>能够从控制器传递额外的属性。</li>
</ul>
<p>为此，我们可以创建我们的 mixin:</p>
<p>localFiles.interceptor.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">FileInterceptor</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/platform-express&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mixin</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NestInterceptor</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ConfigService</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/config&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">MulterOptions</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/platform-express/multer/interfaces/multer-options.interface&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">diskStorage</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;multer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">LocalFilesInterceptorOptions</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">fieldName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">path?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">LocalFilesInterceptor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span>: <span style="color:#204a87;font-weight:bold">LocalFilesInterceptorOptions</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Type</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">NestInterceptor</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Interceptor</span> <span style="color:#204a87;font-weight:bold">implements</span> <span style="color:#000">NestInterceptor</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">fileInterceptor</span>: <span style="color:#204a87;font-weight:bold">NestInterceptor</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">configService</span>: <span style="color:#204a87;font-weight:bold">ConfigService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">filesDestination</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">configService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;UPLOADED_FILES_DESTINATION&#34;</span><span style="color:#000;font-weight:bold">);</span>

      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">destination</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">`</span><span style="color:#4e9a06">${</span><span style="color:#000">filesDestination</span><span style="color:#4e9a06">}${</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">path</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">;</span>

      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">multerOptions</span>: <span style="color:#204a87;font-weight:bold">MulterOptions</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">storage</span>: <span style="color:#204a87;font-weight:bold">diskStorage</span><span style="color:#000;font-weight:bold">({</span>
          <span style="color:#000">destination</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000;font-weight:bold">}),</span>
      <span style="color:#000;font-weight:bold">};</span>

      <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">fileInterceptor</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">FileInterceptor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">fieldName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">multerOptions</span><span style="color:#000;font-weight:bold">))();</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#000">intercept</span><span style="color:#000;font-weight:bold">(...</span><span style="color:#000">args</span>: <span style="color:#204a87;font-weight:bold">Parameters</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">NestInterceptor</span><span style="color:#a40000">[&#34;</span><span style="color:#c4a000">intercept</span><span style="color:#a40000">&#34;]</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">fileInterceptor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">intercept</span><span style="color:#000;font-weight:bold">(...</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">mixin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Interceptor</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">LocalFilesInterceptor</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>在上面，我们使用 <code>UPLOADED_FILES_DESTINATION</code> 变量，并将其与提供的路径连接起来。
为此，让我们定义必要的环境变量。</p>
<p>app.module.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Module</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ConfigModule</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/config&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">Joi</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@hapi/joi&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Module</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">imports</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
    <span style="color:#000">ConfigModule</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">forRoot</span><span style="color:#000;font-weight:bold">({</span>
      <span style="color:#000">validationSchema</span>: <span style="color:#204a87;font-weight:bold">Joi.object</span><span style="color:#000;font-weight:bold">({</span>
        <span style="color:#000">UPLOADED_FILES_DESTINATION</span>: <span style="color:#204a87;font-weight:bold">Joi.string</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">required</span><span style="color:#000;font-weight:bold">(),</span>
        <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000;font-weight:bold">}),</span>
    <span style="color:#000;font-weight:bold">}),</span>
    <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">],</span>
  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">})</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">AppModule</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>.env</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-env" data-lang="env"><span style="color:#000">UPLOADED_FILES_DESTINATION</span><span style="color:#ce5c00;font-weight:bold">=</span>./uploadedFiles
<span style="color:#8f5902;font-style:italic"># ...</span>
</code></pre></div><p>当上面所有的准备就绪，我们可以在控制器中使用 LocalFilesInterceptor:</p>
<p>users.controller.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">UsersService</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./users.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Req</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UploadedFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UseGuards</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UseInterceptors</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">JwtAuthenticationGuard</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../authentication/jwt-authentication.guard&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">RequestWithUser</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../authentication/requestWithUser.interface&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Express</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;express&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">LocalFilesInterceptor</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../localFiles/localFiles.interceptor&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Controller</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users&#34;</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UsersController</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">usersService</span>: <span style="color:#204a87;font-weight:bold">UsersService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">@Post</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;avatar&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">@UseGuards</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">JwtAuthenticationGuard</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">@UseInterceptors</span><span style="color:#000;font-weight:bold">(</span>
    <span style="color:#000">LocalFilesInterceptor</span><span style="color:#000;font-weight:bold">({</span>
      <span style="color:#000">fieldName</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;file&#34;</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;/avatars&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">addAvatar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Req</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">request</span>: <span style="color:#204a87;font-weight:bold">RequestWithUser</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">@UploadedFile</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">file</span>: <span style="color:#204a87;font-weight:bold">Express.Multer.File</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">usersService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">addAvatar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">path</span>: <span style="color:#204a87;font-weight:bold">file.path</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">filename</span>: <span style="color:#204a87;font-weight:bold">file.originalname</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">mimetype</span>: <span style="color:#204a87;font-weight:bold">file.mimetype</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="将元数据保存在数据库中">将元数据保存在数据库中</h2>
<p>除了将文件存储在服务器上，我们还需要将文件的元数据保存在数据库中。
由于 NestJS 为上传的文件生成一个随机的文件名，我们还想存储原始的文件名。
要完成上述所有工作，我们需要为元数据创建一个实体。</p>
<p>localFile.entity.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Column</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Entity</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PrimaryGeneratedColumn</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;typeorm&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Entity</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">LocalFile</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@PrimaryGeneratedColumn</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Column</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">filename</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Column</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">path</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Column</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">mimetype</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">LocalFile</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">localFile</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dto</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ts</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">LocalFileDto</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">filename</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">path</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">mimetype</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>我们还需要在用户和文件之间创建一个关系。</p>
<p>user.entity.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Column</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Entity</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">JoinColumn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">OneToOne</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PrimaryGeneratedColumn</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;typeorm&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">LocalFile</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../localFiles/localFile.entity&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Entity</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@PrimaryGeneratedColumn</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@JoinColumn</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;avatarId&#34;</span> <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#204a87;font-weight:bold">@OneToOne</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">LocalFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">nullable</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">avatar?</span>: <span style="color:#204a87;font-weight:bold">LocalFile</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Column</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">nullable</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">avatarId?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>我们在上面添加了 avatarId 列，这样用户的实体就可以保存角色的 id，而不用连接角色的所有数据。</p>
<p>同时，我们还需要创建 LocalFilesService 的基础:</p>
<p>localFiles.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectRepository</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/typeorm&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Repository</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;typeorm&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">LocalFile</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./localFile.entity&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">LocalFilesService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span>
    <span style="color:#204a87;font-weight:bold">@InjectRepository</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">LocalFile</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">localFilesRepository</span>: <span style="color:#204a87;font-weight:bold">Repository</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">LocalFile</span><span style="color:#000;font-weight:bold">&gt;</span>
  <span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">saveLocalFileData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fileData</span>: <span style="color:#204a87;font-weight:bold">LocalFileDto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">newFile</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">localFilesRepository</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fileData</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">localFilesRepository</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">save</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">newFile</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">newFile</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">LocalFilesService</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>最后一步是在 UsersService 中使用 saveLocalFileData 方法:</p>
<p>users.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectRepository</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/typeorm&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Repository</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Connection</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">In</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;typeorm&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">User</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./user.entity&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">LocalFilesService</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../localFiles/localFiles.service&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UsersService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span>
    <span style="color:#204a87;font-weight:bold">@InjectRepository</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">usersRepository</span>: <span style="color:#204a87;font-weight:bold">Repository</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">&gt;,</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">localFilesService</span>: <span style="color:#204a87;font-weight:bold">LocalFilesService</span>
  <span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">addAvatar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fileData</span>: <span style="color:#204a87;font-weight:bold">LocalFileDto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">avatar</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">localFilesService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">saveLocalFileData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fileData</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">usersRepository</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">avatarId</span>: <span style="color:#204a87;font-weight:bold">avatar.id</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="检索文件">检索文件</h2>
<p>现在，用户可以检索他们化身的 id。</p>
<p>要下载具有给定 id 的文件，我们可以创建一个传输内容的控制器。</p>
<p>实现上述功能的第一步是扩展 LocalFilesService:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NotFoundException</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectRepository</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/typeorm&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Repository</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;typeorm&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">LocalFile</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./localFile.entity&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">LocalFilesService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span>
    <span style="color:#204a87;font-weight:bold">@InjectRepository</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">LocalFile</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">localFilesRepository</span>: <span style="color:#204a87;font-weight:bold">Repository</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">LocalFile</span><span style="color:#000;font-weight:bold">&gt;</span>
  <span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">getFileById</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fileId</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">localFilesRepository</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findOne</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fileId</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">file</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">NotFoundException</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">file</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">LocalFilesService</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>我们还需要创建一个使用上述方法的控制器:</p>
<p>localFiles.controller.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">Get</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">Param</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">UseInterceptors</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">ClassSerializerInterceptor</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">StreamableFile</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">Res</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">ParseIntPipe</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">LocalFilesService</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./localFiles.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Response</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;express&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">createReadStream</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;fs&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">join</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;path&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Controller</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;local-files&#34;</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">@UseInterceptors</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ClassSerializerInterceptor</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">LocalFilesController</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">localFilesService</span>: <span style="color:#204a87;font-weight:bold">LocalFilesService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">@Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;:id&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">getDatabaseFileById</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Param</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;id&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ParseIntPipe</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">@Res</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">passthrough</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#000">response</span>: <span style="color:#204a87;font-weight:bold">Response</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">localFilesService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getFileById</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span>

    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">stream</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">createReadStream</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cwd</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">file</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">path</span><span style="color:#000;font-weight:bold">));</span>

    <span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#000;font-weight:bold">({</span>
      <span style="color:#4e9a06">&#34;Content-Disposition&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">`inline; filename=&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">file</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">filename</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;`</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#4e9a06">&#34;Content-Type&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">file</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mimetype</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000;font-weight:bold">});</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">StreamableFile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stream</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>我们在本系列的前一部分中了解了 StreamableFile 类和 Content-Disposition 头文件。</p>
<p>执行上述操作允许用户检索具有给定 id 的文件。</p>
<h2 id="过滤传入的文件">过滤传入的文件</h2>
<p>我们不应该总是相信用户上传的文件。
幸运的是，我们可以很容易地使用 filfilter 过滤它们，并限制 multer 支持的属性。</p>
<p>localFiles.interceptor.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">FileInterceptor</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/platform-express&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mixin</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NestInterceptor</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ConfigService</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/config&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">MulterOptions</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/platform-express/multer/interfaces/multer-options.interface&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">diskStorage</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;multer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">LocalFilesInterceptorOptions</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">fieldName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">path?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">fileFilter?</span>: <span style="color:#204a87;font-weight:bold">MulterOptions</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;fileFilter&#34;</span><span style="color:#000;font-weight:bold">];</span>
  <span style="color:#000">limits?</span>: <span style="color:#204a87;font-weight:bold">MulterOptions</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;limits&#34;</span><span style="color:#000;font-weight:bold">];</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">LocalFilesInterceptor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span>: <span style="color:#204a87;font-weight:bold">LocalFilesInterceptorOptions</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Type</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">NestInterceptor</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Interceptor</span> <span style="color:#204a87;font-weight:bold">implements</span> <span style="color:#000">NestInterceptor</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">fileInterceptor</span>: <span style="color:#204a87;font-weight:bold">NestInterceptor</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">configService</span>: <span style="color:#204a87;font-weight:bold">ConfigService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">filesDestination</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">configService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;UPLOADED_FILES_DESTINATION&#34;</span><span style="color:#000;font-weight:bold">);</span>

      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">destination</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">`</span><span style="color:#4e9a06">${</span><span style="color:#000">filesDestination</span><span style="color:#4e9a06">}${</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">path</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">;</span>

      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">multerOptions</span>: <span style="color:#204a87;font-weight:bold">MulterOptions</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">storage</span>: <span style="color:#204a87;font-weight:bold">diskStorage</span><span style="color:#000;font-weight:bold">({</span>
          <span style="color:#000">destination</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000;font-weight:bold">}),</span>
        <span style="color:#000">fileFilter</span>: <span style="color:#204a87;font-weight:bold">options.fileFilter</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000">limits</span>: <span style="color:#204a87;font-weight:bold">options.limits</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000;font-weight:bold">};</span>

      <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">fileInterceptor</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">FileInterceptor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">fieldName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">multerOptions</span><span style="color:#000;font-weight:bold">))();</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#000">intercept</span><span style="color:#000;font-weight:bold">(...</span><span style="color:#000">args</span>: <span style="color:#204a87;font-weight:bold">Parameters</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">NestInterceptor</span><span style="color:#a40000">[&#34;</span><span style="color:#c4a000">intercept</span><span style="color:#a40000">&#34;]</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">fileInterceptor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">intercept</span><span style="color:#000;font-weight:bold">(...</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">mixin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Interceptor</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">LocalFilesInterceptor</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>让我们只允许在 mimetype 中包含“image”且小于 1MB 的文件。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">UsersService</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./users.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">BadRequestException</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Req</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UploadedFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UseGuards</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UseInterceptors</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">JwtAuthenticationGuard</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../authentication/jwt-authentication.guard&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">RequestWithUser</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../authentication/requestWithUser.interface&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Express</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;express&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">LocalFilesInterceptor</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../localFiles/localFiles.interceptor&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Controller</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users&#34;</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UsersController</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">usersService</span>: <span style="color:#204a87;font-weight:bold">UsersService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">@Post</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;avatar&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">@UseGuards</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">JwtAuthenticationGuard</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">@UseInterceptors</span><span style="color:#000;font-weight:bold">(</span>
    <span style="color:#000">LocalFilesInterceptor</span><span style="color:#000;font-weight:bold">({</span>
      <span style="color:#000">fieldName</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;file&#34;</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;/avatars&#34;</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">fileFilter</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">file</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">callback</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">file</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mimetype</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">includes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;image&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">callback</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">BadRequestException</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Provide a valid image&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000">callback</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">},</span>
      <span style="color:#000">limits</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">fileSize</span>: <span style="color:#204a87;font-weight:bold">Math.pow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#8f5902;font-style:italic">// 1MB
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">addAvatar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Req</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">request</span>: <span style="color:#204a87;font-weight:bold">RequestWithUser</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">@UploadedFile</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">file</span>: <span style="color:#204a87;font-weight:bold">Express.Multer.File</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">usersService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">addAvatar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">path</span>: <span style="color:#204a87;font-weight:bold">file.path</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">filename</span>: <span style="color:#204a87;font-weight:bold">file.originalname</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">mimetype</span>: <span style="color:#204a87;font-weight:bold">file.mimetype</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>如果文件不满足大小要求，NestJS 抛出 413 Payload Too Large。
不只是检查 mimetype 和使用文件类型库可能是一个好主意。</p>
<h2 id="总结">总结</h2>
<p>在本文中，我们介绍了通过 NestJS 管理服务器上文件的基础知识。
我们已经学习了如何将它们存储在服务器上并返回给用户。
当这样做时，我们扩展了内置的 FileInterceptor 并实现了过滤。
仍然有一些方法可以扩展本文中的代码。
如本系列第 15 部分所述，您可以自由地实现文件删除和使用事务。</p>
<p>通过学习各种存储文件的方法，您现在可以自由地比较其优缺点，并使用最适合自己需求的方法。</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-72a7b9da75676e436dce77dd4f1befe5">4 - awesome</h1>
    
	<blockquote>
<p><a href="https://github.com/nestjs/awesome-nestjs/blob/master/README.md">https://github.com/nestjs/awesome-nestjs/blob/master/README.md</a></p>
</blockquote>
<h2 id="资源">资源</h2>
<h4 id="官方资源">官方资源</h4>
<ul>
<li><a href="https://nestjs.com">Website</a></li>
<li><a href="https://docs.nestjs.com">Official Guide</a></li>
<li><a href="https://github.com/nestjs/nest">GitHub Repo</a></li>
<li>Examples
<ul>
<li><a href="https://github.com/nestjs/typescript-starter">Nest Starter</a> - Nest framework TypeScript starter.</li>
<li><a href="https://github.com/nestjs/javascript-starter">JavaScript Starter</a> - Nest framework JavaScript (ES6 / ES7 / ES8) starter.</li>
</ul>
</li>
</ul>
<h4 id="社区">社区</h4>
<ul>
<li><a href="https://gitter.im/nestjs/">Gitter</a></li>
<li><a href="https://discord.gg/G7Qnnhy">Discord</a></li>
<li><a href="https://t.me/nestjs">Telegram (community maintained)</a></li>
<li><a href="https://t.me/nestjsbr">Telegram (Brazilian Portuguese speak community)</a></li>
<li><a href="https://t.me/nest_ru">Telegram (Russian speak community)</a></li>
<li><a href="https://nestjs.slack.com">Slack (Korean speak community)</a></li>
<li><a href="https://www.reddit.com/r/Nestjs_framework">Reddit (community maintained)</a></li>
<li><a href="https://www.facebook.com/groups/606785643208589">Facebook (Polish speak community)</a></li>
</ul>
<h4 id="会谈">会谈</h4>
<ul>
<li><a href="https://www.youtube.com/watch?v=jo-1EUxMmxc">Revealing framework fundamentals: NestJS behind the curtain by Kamil Myśliwiec</a></li>
</ul>
<h4 id="教程">教程</h4>
<ul>
<li><a href="https://kamilmysliwiec.com/nest-release-canditate-is-here-introduction-modern-node-js-framework">Introduction to modern Node.js framework</a></li>
<li><a href="https://auth0.com/blog/nestjs-brings-typescript-to-nodejs-and-express">NestJS Node Express</a> - Teach how to use NestJS step by step.</li>
<li><a href="https://kamilmysliwiec.com/build-modern-scalable-node-js-web-applications-with-nest">Build web applications with Nest</a></li>
<li><a href="https://github.com/m24927605/Nestjs30Days">NestJS30Days</a> - Learn the NestJS framework in 30 days.</li>
<li><a href="https://pusher.com/tutorials/geofencing-nestjs-googlemaps">Build a geofencing web app using NestJS and the Google Maps API</a></li>
<li><a href="https://pusher.com/tutorials/live-comments-sentiment-analysis-nestjs">Build live comments with sentiment analysis using NestJS</a></li>
<li><a href="https://pusher.com/tutorials/chat-sentiment-analysis-nestjs">Build a chat app with sentiment analysis using NestJS</a></li>
<li><a href="https://pusher.com/tutorials/realtime-graph-nestjs">Create a realtime graph using NestJS</a></li>
<li><a href="https://pusher.com/tutorials/realtime-table-datatables-nestjs">Build a realtime table with DataTables and NestJS</a></li>
<li><a href="https://blog.exceptionfound.com/index.php/2018/06/07/nestjs-basic-auth-and-sessions/">NestJS Basic Auth and Sessions</a></li>
<li><a href="https://blog.exceptionfound.com/2020/12/03/nestjs-hasura-integration-via-schema-stitching/">NestJS Hasura Integration via Schema Stitching And JWT Auth</a></li>
<li><a href="https://medium.com/@ctran2428/mean-stack-with-nestjs-and-swagger-9d8d14862d6b">MEAN Stack with NestJS and Swagger</a></li>
<li><a href="https://www.youtube.com/watch?v=NF9Xn4g5MJY&amp;list=PLBeQxJQNprbiJm55q7nTAfhMmzIC8MWxc">NestJS Ideas API</a></li>
<li><a href="https://hackernoon.com/building-real-time-web-applications-using-nest-js-and-ably-d85887e81f06">Building a real time web applications using NestJS and Ably</a></li>
<li><a href="https://www.youtube.com/watch?v=nz6yFTyLbAQ&amp;list=PLq1kZ5GbKd4qyDcK3IHGSi4FDAL6fRZeL">Video Tutorials</a> - Building a full-stack blog with NestJS, Angular and Angular Material.</li>
<li><a href="https://www.udemy.com/course/the-complete-nestjs-developer-enterprise-nodejs-framework/">Free Video Course</a> - The complete NestJS developer. Enterprise Node.js framework.</li>
</ul>
<h4 id="例子">例子</h4>
<ul>
<li><a href="https://github.com/Pinedo11/nestDemo-ChatServer">ChatServer</a> - Server side of Chat App implemented using NestJS.</li>
<li><a href="https://github.com/Sikora00/ddd-by-examples-library-nestjs">Domain Driven Design - Library</a> - Example of an application that follows Domain Driven Design.</li>
<li><a href="https://github.com/lujakob/nestjs-realworld-example-app">Realworld Example App</a> - Exemplary real world backend API built with NestJS + TypeORM.</li>
<li><a href="https://github.com/vladotesanovic/mant">Mant</a> - New Stack on the Market to beat them all :ring: MANT.</li>
<li><a href="https://github.com/crudjs/rest-nestjs-postgres">REST NestJS Postgres</a> - CrudJS implemented as a REST API, using NestJS and Postgres.</li>
<li><a href="https://github.com/EndyKaufman/nest-permissions-seed">Nest Permissions Seed</a> - A simple application demonstrating the basic usage of permissions with NestJS.</li>
<li><a href="https://github.com/Innovic-io/angular-nestjs-rendering">Angular NestJS Rendering</a> - Angular 5+ server side rendering using NestJS.</li>
<li><a href="https://github.com/Abdallah-khalil/ContactManagerApp">Angular Contact Manager App</a> - A Contact Manager App using Angular, NestJS, Mongoose, Passport, JWT.</li>
<li><a href="https://github.com/Abdallah-khalil/Books-Library-API">Books Library API</a> - A restful API with NestJS and mongoose.</li>
<li><a href="https://github.com/Abdallah-khalil/NodeJsWithPassport">Passport Auth NestJS</a> - Passport strategies and oauth integration built with NestJS.</li>
<li><a href="https://github.com/jajaperson/nestjs-auth0">NestJS Auth0</a> - An example NestJS application that uses Auth0 via Passport for authentication.</li>
<li><a href="https://github.com/kelvin-mai/nest-ideas-api">Nest Ideas API</a> - An implementation of a REST and GraphQL server built with NestJS, PostgresQL and TypeORM.</li>
<li><a href="https://github.com/nest-cloud/nestcloud-starter">Nestcloud Starter</a> - Quickly start a micro-service app use nestcloud.</li>
<li><a href="https://github.com/surmon-china/nodepress">Nodepress</a> - A RESTful API server application for Blog CMS.</li>
<li><a href="https://github.com/International-Slackline-Association/Rankings-Backend">Serverless-Lambda-DynamoDB</a> - A fully SERVERLESS in-production application with AWS Lambda, DynamoDB, DynamoDB Streams.</li>
<li><a href="https://github.com/mamori-i-japan/mamori-i-japan-api">Serverless-Lambda-FirestoreDB</a> - A fully SERVERLESS in-production application with AWS Lambda, FirestoreDB, Firebase Auth, Winston Logger, Swagger. Also implements admin role authorization.</li>
<li><a href="https://github.com/kop7/serverless-nestjs-typeorm">Serverless NestJS TypeOrm</a> - Example how to NestJS using the serverless framework with TypeORM.</li>
<li><a href="https://github.com/marcomelilli/nestjs-email-authentication">Passport Email Auth</a> - Starter project that includes API for user email authentication with MongoDB and PassportJs.</li>
<li><a href="https://github.com/CatsMiaow/node-nestjs-structure">NestJS Project Structure</a> - Example of constructing a project structure with NestJS.</li>
<li><a href="https://github.com/kop7/nest-elasticsearch-vue">NestJS Elasticsearch Vue</a> - Autocomplete search with NestJS, Elasticsearch and Vue.</li>
<li><a href="https://github.com/pvarentsov/typescript-clean-architecture">TypeScript Clean Architecture</a> - Clean Architecture based application with NestJS, PostgreSQL and TypeORM.</li>
<li><a href="https://github.com/Tony133/nestjs-api-mongoose">NestJS Api Mongoose</a> - Simple example Api Rest with Nestjs 8.x and Mongoose</li>
</ul>
<h4 id="样板">样板</h4>
<ul>
<li><a href="https://github.com/VincentJouanne/nest-clean-architecture-ddd-example">🧪 Fully tested NestJS Prisma Clean Architecture Boilerplate</a> - This boilerplate shows how to test your NestJS API with unit, integration and e2e tests. Use-cases are written in functionnal programming with FP-TS.</li>
<li><a href="https://github.com/Ferdysd96/nestjs-permission-boilerplate">NestJS Permission Boilerplate</a> - This is a basic NestJS boilerplate project built on the more powerful Node.js framework. The main purpose of this project is to dynamically handle roles and permissions assigned to the user.</li>
<li><a href="https://github.com/squareboat/nestjs-boilerplate">SQB NestJS Boilerplate</a> - A production-ready 🏭 NestJS boilerplate with batteries 🔋 included. No Kidding!.</li>
<li><a href="https://github.com/ahrnee/nestjs-bff">Nest BFF</a> - A boilerplate <a href="https://samnewman.io/patterns/architectural/bff/">BFF</a> web application starter-project using NestJS. Includes CLI, and MongoDB migrations features.</li>
<li><a href="https://github.com/Saluki/nestjs-template">NestJS Template</a> - Scaffold your next TypeScript API with this production-ready NestJS template crafted for Docker environments.</li>
<li><a href="https://github.com/nartc/nest-mean">MEAN Todo with NestJS</a> - A simple Todo application with NestJS and Swagger. Included Authorization/Authentication.</li>
<li><a href="https://github.com/Vivify-Ideas/nestjs-boilerplate">NestJS Boilerplate</a> - Boilerplate with available authentication, typeorm, env configuration and swagger. Everything you need to start making great things.</li>
<li><a href="https://github.com/NarHakobyan/awesome-nest-boilerplate">Awesome Nest Boilerplate</a> - Typescript, Postgresql, TypeORM, Swagger for Api documentation, Role base access control, and best application architecture.</li>
<li><a href="https://github.com/notiz-dev/nestjs-prisma-starter">NestJS Prisma Starter</a> - Starter project for NestJS includes Graphql with Prisma Client, Passport-JWT authentication, Swagger Api and Docker.</li>
<li><a href="https://github.com/adrien2p/teanjs">TeanJS</a> - TeanJS is a starter that provides you all the keys to be able to start writing your code as quickly as possible.</li>
<li><a href="https://github.com/pezzetti/base-app-nestjs">NestJS DDD Boilerplate</a> - Domain Driven Design Base app with NestJS, Class Validator and TypeORM. SOLID principles applied to create fully testable applications.</li>
<li><a href="https://github.com/benawad/nest-mongo-graphql/">Nest Mongo Graphql</a> - Starter Kit using NestJS MongoDB Graphql and type-graphql <a href="https://typegraphql.ml/">https://typegraphql.ml/</a> inspired the type schema first approach.</li>
<li><a href="https://github.com/juicycleff/ultimate-backend">Ultimate Backend</a> - Enterprise multi-tenant SaaS starter kit with CQRS GraphQL microservice architecture, apollo federation, event source and authentication.</li>
<li><a href="https://github.com/fernandohenriques/nestjs-graphql-boilerplate">NestJS GraphQL Boilerplate</a> - Dockerized API boilerplate with NestJS, TypeORM, TypeGraphQL, MongoDB, GraphQL and automated tasks with Makefile. Code first approach.</li>
<li><a href="https://github.com/tomanagle/NextJS-NestJS-GraphQL-Starter">NextJS &amp; NestJS GraphQL Starter</a> - GraphQL NestJS with NextJS boilerplace. Includes GitHub, Reddit &amp; Google OAuth.</li>
<li><a href="https://github.com/tudorconstantin/knests/">The Knests Stack</a> - Full stack/end starter with: PostgreSQL, Knex.js, NestJS, Next.js, GraphQL, React, Material-UI, Docker multistage images for, Docker compose and a GitLab CI/CD pipeline fully configured.</li>
<li><a href="https://github.com/ahmetuysal/nest-hackathon-starter">Nest Hackathon Starter</a> - Hackathon starter project for NestJS. Includes Prisma, email verification, Passport-JWT authentication, Swagger and more.</li>
<li><a href="https://github.com/chocolat-chaud-io/stator">Stator</a> - A full-stack boilerplate that does it all - automatic releases, deployments, enforced conventions.</li>
<li><a href="https://github.com/monstar-lab-oss/nestjs-starter-rest-api">NestJS REST Starter Kit - By MonstarLab</a> - Features: JWT Auth, RBAC Authorization, TypeORM, winston logger, Pagination, Auto-generated Swagger. Other: prettier, commit-linting husky hooks, SonarCloud, docker-compose.</li>
<li><a href="https://github.com/Tony133/nestjs-api-boilerplate-jwt">NestJS Api Boilerplate JWT</a> - An API Boilerplate to create a ready-to-use REST API in seconds with NestJS + TypeORM and Passport Auth JWT.</li>
<li><a href="https://github.com/brocoders/nestjs-boilerplate">NestJS REST API boilerplate for typical project</a> - Boilerplate with Auth, TypeORM, PostgreSQL, Mailing, I18N, Docker, File uploads (support local and Amazon S3 drivers), Swagger, Tests, CI.</li>
<li><a href="https://github.com/alitnk/nest-prisma-monorepo">NestJS and Prisma Yarn Monorepo Starter Template</a> - Full-stack monorepo starter (Yarn workspaces) with Prisma, GraphQL, CI and more.</li>
<li><a href="https://github.com/gobeam/truthy">Truthy NestJS Headless CMS</a> - Open source headless CMS API written using NestJS, that has built-in modules like User Management, Role Management, Permission Management, Email Module, Account Settings, 2FA settings, Throttling, RBAC support, Localization, frontend application written with ReactJS &amp; Redux Saga, UI built with Ant design and many more. Other: unit test using Jest, prettier, commit-linting husky hooks, PostgreSQL, Redis, docker etc.</li>
<li><a href="https://github.com/mokuteki225/nest-websockets-chat-boilerplate">NestJS Realtime Chat</a> - Boilerplate for a realtime chat based on Websockets, TypeORM, PostgreSQL, REST, Docker which includes PassportJS/JWT auth, rooms, kick/ban user functionality</li>
</ul>
<h2 id="项目使用-nestjs">项目使用 NestJS</h2>
<h4 id="开源">开源</h4>
<ul>
<li><a href="https://github.com/ever-co/ever">Ever®</a> - Open-Source Commerce Platform for On-Demand Economy and Digital Marketplaces.</li>
<li><a href="https://github.com/feednext/feednext">Feednext</a> - Open-Source Social Media Application.</li>
<li><a href="https://github.com/ever-co/gauzy">Gauzy</a> - Open-Source Profits Sharing Platform for modern agencies and studios.</li>
<li><a href="https://github.com/Roche/lxdhub">LXDhub</a> - Management system for Linux Containers (LXC).</li>
<li><a href="https://github.com/notadd/notadd">Notadd</a> - Microservice development architecture.</li>
<li><a href="https://github.com/valueadd-poland/pimp-my-pr">Pimp My PR</a> - Open-Source platform for statistics and pull request management.</li>
<li><a href="https://tooljet.io/">ToolJet</a> - ToolJet is the open-source low-code framework alternative to Retool &amp; Mendix to build &amp; deploy internal tools with minimal engineering effort. (<a href="https://github.com/ToolJet/ToolJet">Source Code</a>) <code>GPL-3.0</code></li>
<li><a href="https://github.com/vendure-ecommerce/vendure">Vendure</a> - Open-Source headless GraphQL ecommerce framework built on NestJS, with a focus on developer productivity and ease of customization.</li>
<li><a href="https://github.com/pvarentsov/iola">iola</a> - Socket client with Rest API.</li>
<li><a href="https://github.com/amplication/amplication">Amplication</a> - Amplication is an open-source low-code devtool that auto-generates backend apps built with TypeScript and Node.js, and a client built with React.</li>
</ul>
<h2 id="组件和库">组件和库</h2>
<h4 id="实用程序">实用程序</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/nestjs/cqrs.svg?style=flat-square" alt=""> <a href="https://github.com/nestjs/cqrs">Nest CQRS</a> - A lightweight CQRS module for Nest framework.</li>
<li><img src="https://img.shields.io/github/stars/valueadd-poland/nestjs-packages.svg?style=flat-square" alt=""> <a href="https://github.com/valueadd-poland/nestjs-packages/tree/master/packages/typed-cqrs">Typed CQRS</a> - A wrapper for the Nest CQRS library for better typing of query and command results.</li>
<li><img src="https://img.shields.io/github/stars/nestjsx/nestjs-config.svg?style=flat-square" alt=""> <a href="https://github.com/nestjsx/nestjs-config">Nest Config</a> - A Great module to handle project configurations.</li>
<li><img src="https://img.shields.io/github/stars/Nikaple/nest-typed-config.svg?style=flat-square" alt=""> <a href="https://github.com/Nikaple/nest-typed-config">Nest Typed Config</a> - Intuitive, type-safe configuration module for Nest framework.</li>
<li><img src="https://img.shields.io/github/stars/nest-cloud/nestcloud.svg?style=flat-square" alt=""> <a href="https://github.com/nest-cloud/nestcloud">Nest Consul Service</a> - A Node.js micro-service solution based on Consul, writing by Typescript language and NestJS framework.</li>
<li><img src="https://img.shields.io/github/stars/rubiin/nestjs-easyconfig.svg?style=flat-square" alt=""> <a href="https://github.com/rubiin/nestjs-easyconfig">Nest Easy Config</a> - A NestJS module for managing configs that provides some sleek features.</li>
<li><img src="https://img.shields.io/github/stars/miaowing/nest-schedule.svg?style=flat-square" alt=""> <a href="https://github.com/miaowing/nest-schedule">Nest Schedule</a> - Schedule job easier by decorator.</li>
<li><img src="https://img.shields.io/github/stars/owl1n/nest-queue.svg?style=flat-square" alt=""> <a href="https://github.com/owl1n/nest-queue">Nest Queue</a> - Easy queue management based on Redis for your application.</li>
<li><img src="https://img.shields.io/github/stars/lupu60/nestjs-toolbox.svg?style=flat-square" alt=""> <a href="https://github.com/lupu60/nestjs-toolbox">Nest Toolbox</a> - The repository contains a suite of components and modules for NestJS.</li>
<li><img src="https://img.shields.io/github/stars/jeffminsungkim/nestjs-multer-extended.svg?style=flat-square" alt=""> <a href="https://github.com/jeffminsungkim/nestjs-multer-extended">Nest Multer Extended</a> - Extended MulterModule for NestJS framework with flexible Amazon S3 upload and helpful features.</li>
<li><img src="https://img.shields.io/github/stars/Papooch/nestjs-cls.svg?style=flat-square" alt=""> <a href="https://github.com/Papooch/nestjs-cls">Nest CLS</a> - A continuation-local storage module for Nest (using <code>async_hooks</code>)</li>
<li><img src="https://img.shields.io/github/stars/benhason1/nestjs-http-promise.svg?style=flat-square" alt=""> <a href="https://github.com/benhason1/nestjs-http-promise">NestJS HTTP Promise</a> - A Promise-based alternative to <code>@nestjs/axios</code>, with retries feature using <code>axios-retry</code> and <code>axios</code>.</li>
</ul>
<h4 id="状态管理">状态管理</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/derekkite/ngrx-nest.svg?style=flat-square" alt=""> <a href="https://github.com/derekkite/ngrx-nest">Ngrx Nest</a> - Ngrx/store and ngrx/effects on the server using the nest framework.</li>
</ul>
<h4 id="代码风格">代码风格</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/basarat/typescript-book.svg?style=flat-square" alt=""> <a href="https://github.com/basarat/typescript-book/blob/master/docs/styleguide/styleguide.md">StyleGuide and Coding Conventions</a> - An unofficial TypeScript StyleGuide.</li>
</ul>
<h4 id="web-sockets">Web Sockets</h4>
<ul>
<li><a href="https://docs.nestjs.com/websockets/gateways">Official</a></li>
</ul>
<h4 id="redis">Redis</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/nest-modules/ioredis.svg?style=flat-square" alt=""> <a href="https://github.com/nest-modules/ioredis">Nest Ioredis</a> - A ioredis module for Nest framework.</li>
<li><img src="https://img.shields.io/github/stars/liaoliaots/nestjs-redis.svg?style=flat-square" alt=""> <a href="https://github.com/liaoliaots/nestjs-redis">Nest Redis Cluster</a> - Redis(ioredis) module for NestJS framework.</li>
</ul>
<h4 id="mail">Mail</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/squareboat/nest-mailman.svg?style=flat-square" alt=""> <a href="https://github.com/squareboat/nest-mailman">Mailman</a> - The only 📮 mailer package you need for your NestJS Applications.</li>
<li><img src="https://img.shields.io/github/stars/partyka95/nest-mailer.svg?style=flat-square" alt=""> <a href="https://github.com/partyka95/nest-mailer">Nest Mailer</a> - A mailer module for Nest framework.</li>
</ul>
<h4 id="api">API</h4>
<ul>
<li><a href="https://github.com/nestjs/swagger">Swagger</a> - This&rsquo;s an OpenAPI (Swagger) module for Nest. <em>[<a href="https://docs.nestjs.com/recipes/swagger">Tutorial</a>]</em>.</li>
<li><img src="https://img.shields.io/github/stars/flamewow/nestjs-asyncapi.svg?style=flat-square" alt=""> <a href="https://github.com/flamewow/nestjs-asyncapi">AsyncAPI</a> - AsyncAPI module for NestJS.</li>
<li><img src="https://img.shields.io/github/stars/doug-martin/nestjs-query.svg?style=flat-square" alt=""> <a href="https://github.com/doug-martin/nestjs-query">Nest-Query</a> - Nest CRUD for GraphQL APIs.</li>
<li><img src="https://img.shields.io/github/stars/samchon/nestia.svg?style=flat-square" alt=""> <a href="https://github.com/samchon/nestia">Nestia</a> - Automatic SDK generator for the clients.</li>
</ul>
<h4 id="中间件">中间件</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/wbhob/nest-middlewares.svg?style=flat-square" alt=""> <a href="https://github.com/wbhob/nest-middlewares">Nest Middlewares</a> - Common, injectable middlewares for NestJS.</li>
</ul>
<h4 id="错误">错误</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/squareboat/nest-eyewitness.svg?style=flat-square" alt=""> <a href="https://github.com/squareboat/nest-eyewitness">Eyewitness</a> - Receive error reports directly to your inbox whenever any exception is witnessed 👀 in your NestJS application.</li>
<li><img src="https://img.shields.io/github/stars/shekohex/nestjs-flub.svg?style=flat-square" alt=""> <a href="https://github.com/shekohex/nestjs-flub">Nest Flub</a> - Pretty Error :tired_face: Stack Viewer for NestJS Framework :hammer_and_wrench:.</li>
<li><img src="https://img.shields.io/github/stars/ozkanonur/nestjs-enlighten.svg?style=flat-square" alt=""> <a href="https://github.com/ozkanonur/nestjs-enlighten">Nest Enlighten</a> - A laravel-ignition like error page for NestJS Framework.</li>
<li><img src="https://img.shields.io/github/stars/ozkanonur/nestjs-rate-limiter.svg?style=flat-square" alt=""> <a href="https://github.com/ozkanonur/nestjs-rate-limiter">Nest Rate Limiter</a> - A highly configurable rate limiter library.</li>
<li><img src="https://img.shields.io/github/stars/mentos1386/nest-raven.svg?style=flat-square" alt=""> <a href="https://github.com/mentos1386/nest-raven">Nest Raven</a> - Sentry Raven Module for NestJS Framework.</li>
</ul>
<h4 id="lint">Lint</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/unlight/eslint-plugin-nestjs.svg?style=flat-square" alt=""> <a href="https://github.com/unlight/eslint-plugin-nestjs">Eslint Plugin NestJS</a> - ESLint rules for NestJS framework.</li>
<li><img src="https://img.shields.io/github/stars/darraghoriordan/eslint-plugin-nestjs-typed.svg?style=flat-square" alt=""> <a href="https://github.com/darraghoriordan/eslint-plugin-nestjs-typed">Typescript-Eslint Plugin NestJS</a> - ESLint rules for NestJS framework.</li>
</ul>
<h4 id="路由器-">路由器 🚦</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/shekohex/nest-router.svg?style=flat-square" alt=""> <a href="https://github.com/shekohex/nest-router">Nest Router</a> - Router Module For NestJS Framework 🚦 🚀
for organizing your Routes, creating a routes tree, and more.</li>
</ul>
<h4 id="satellite">:satellite:</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/adrien2p/nestjs-dialogflow.svg?style=flat-square" alt=""> <a href="https://github.com/adrien2p/nestjs-dialogflow">NestJS Dialogflow</a> - Dialog flow module that simplify the web hook handling for your NLP application using NestJS.</li>
</ul>
<h4 id="日志记录">日志记录</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/gremo/nest-winston.svg?style=flat-square" alt=""> <a href="https://github.com/gremo/nest-winston">Nest Winston</a> - Winston module for NestJS.</li>
<li><img src="https://img.shields.io/github/stars/iamolegga/nestjs-pino.svg?style=flat-square" alt=""> <a href="https://github.com/iamolegga/nestjs-pino">Nest Pino</a> - Pino module for NestJS Log with request context in any place.</li>
<li><img src="https://img.shields.io/github/stars/jmcdo29/ogma.svg?style=flat-square" alt=""> <a href="https://github.com/jmcdo29/ogma">Ogma</a> - A monorepo for the Ogma logger and related packages.</li>
</ul>
<h4 id="监控">监控</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/MetinSeylan/Nestjs-OpenTelemetry.svg?style=flat-square" alt=""> <a href="https://github.com/MetinSeylan/Nestjs-OpenTelemetry">Nest OpenTelemetry</a> - Deeply integrated NestJS OpenTelemetry module with auto instrumentations.</li>
<li><img src="https://img.shields.io/github/stars/GenFirst/nest-status-monitor.svg?style=flat-square" alt=""> <a href="https://github.com/GenFirst/nest-status-monitor">Nest Status Monitor</a> - Simple, self-hosted module based on Socket.io and Chart.js to report realtime server metrics for NestJS based node servers.</li>
<li><img src="https://img.shields.io/github/stars/nestjs/terminus.svg?style=flat-square" alt=""> <a href="https://github.com/nestjs/terminus">Nest Terminus</a> - Integrated healthchecks, based on <a href="https://github.com/godaddy/terminus">Terminus</a> package.</li>
<li><img src="https://img.shields.io/github/stars/narando/nest-xray.svg?style=flat-square" alt=""> <a href="https://github.com/narando/nest-xray">Nest X-Ray</a> - Record incoming and outgoing request for <a href="https://aws.amazon.com/xray/">AWS X-Ray</a>, also supports custom instrumentation.</li>
<li><img src="https://img.shields.io/github/stars/pragmaticivan/nestjs-otel.svg?style=flat-square" alt=""> <a href="https://github.com/pragmaticivan/nestjs-otel">Nest OpenTelemetry (OTEL)</a> - OpenTelemetry module for NestJS.</li>
</ul>
<h4 id="国际化-i18n">国际化 (i18n)</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/ToonvanStrijp/nestjs-i18n.svg?style=flat-square" alt=""> <a href="https://github.com/ToonvanStrijp/nestjs-i18n">Nest i18n</a> - Adds i18n support easily to your server, with a rich formatting api build in.</li>
</ul>
<h4 id="货币">货币</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/vahidvdn/nestjs-cashify.svg?style=flat-square" alt=""> <a href="https://github.com/vahidvdn/nestjs-cashify">Nestjs Cashify</a> - Currency conversion module for NestJS.</li>
</ul>
<h4 id="事件">事件</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/yak0/nest-event.svg?style=flat-square" alt=""> <a href="https://github.com/yak0/nest-event">Nest Event</a> - Event handling with decorators for NestJS Framework.</li>
</ul>
<h4 id="身份验证">身份验证</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/iamolegga/nestjs-session.svg?style=flat-square" alt=""> <a href="https://github.com/iamolegga/nestjs-session">NestJS Session</a> - Idiomatic Session Module for NestJS. Built on top of <a href="https://npm.im/express-session">express-session</a>.</li>
</ul>
<h4 id="rbac-基于角色的访问控制">RBAC (基于角色的访问控制)</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/sergey-telpuk/nestjs-rbac.svg?style=flat-square" alt=""> <a href="https://github.com/sergey-telpuk/nestjs-rbac">Nest RBAC</a> - RBAC module for NestJS, with a dynamic storage and cache.</li>
<li><img src="https://img.shields.io/github/stars/relevantfruit/nestjs-keycloak-admin.svg?style=flat-square" alt=""> <a href="https://github.com/relevantfruit/nestjs-keycloak-admin">Nest Keycloak Admin</a> - Keycloak Admin Client with support for User Managed Access protocol.</li>
<li><img src="https://img.shields.io/github/stars/bjerkio/nestjs-oso.svg?style=flat-square" alt=""> <a href="https://github.com/bjerkio/nestjs-oso">NestJS OSO</a> - Library that simplifies the implementation of OSO (open-source policy engine for authorization).</li>
</ul>
<h4 id="多租赁">多租赁</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/AlexanderC/nestjs-mtenant.svg?style=flat-square" alt=""> <a href="https://github.com/AlexanderC/nestjs-mtenant">Nestjs MTenant</a> - A module for NestJS to enable multitenancy support with deep integration into the system as whole (based on <code>async_hooks</code>).</li>
</ul>
<h4 id="微服务">微服务</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/pvarentsov/nestjs-pg-notify.svg?style=flat-square" alt=""> <a href="https://github.com/pvarentsov/nestjs-pg-notify">NestJS PG Notify</a> - NestJS custom transport strategy for PostgreSQL Pub/Sub.</li>
<li><img src="https://img.shields.io/github/stars/sergey-telpuk/nestjs-transport-eventbus.svg?style=flat-square" alt=""> <a href="https://github.com/sergey-telpuk/nestjs-transport-eventbus">Nestjs Transport Eventbus</a> - The module for Nest to allow broadcasting events via variety of nestjs trasports in easy way</li>
<li><img src="https://img.shields.io/github/stars/p-fedyukovich/nestjs-google-pubsub-microservice.svg?style=flat-square" alt=""> <a href="https://github.com/p-fedyukovich/nestjs-google-pubsub-microservice">NestJS Google Cloud Pub/Sub Microservice Transport</a> - Custom Google Cloud Pub/Sub microservice transport</li>
</ul>
<h4 id="数据库">数据库</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/notiz-dev/nestjs-prisma.svg?style=flat-square" alt=""> <a href="https://github.com/notiz-dev/nestjs-prisma">NestJS Prisma</a> - Library and schematics adding Prisma integration to a NestJS application</li>
</ul>
<h2 id="测试">测试</h2>
<h4 id="集合的例子">集合的例子</h4>
<ul>
<li><a href="https://github.com/jmcdo29/testing-nestjs">Testing Nestjs</a> - A repository to show off to the community methods of testing NestJS including Unit Tests, Integration Tests, E2E Tests, pipes, filters, interceptors, GraphQL, Mongo, TypeORM, and more!</li>
</ul>
<h4 id="使用工具">使用工具</h4>
<ul>
<li><a href="https://www.npmjs.com/package/@golevelup/ts-jest">GoLevelUp utilities for Jest</a> - Utilities for making testing NestJS applications easier. Currently supports Jest.</li>
<li><a href="https://www.npmjs.com/package/mockingbird">Mockingbird</a> - A library to create typed tests fixtures/mocks using decorators and built-in faker support</li>
<li><a href="https://www.npmjs.com/package/nestjs-pact">NestJS + Pact</a> - Injectable Pact.js Consumer/Provider for NestJS</li>
</ul>
<h2 id="集成">集成</h2>
<h4 id="认证">认证</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/cdiaz/nestjs-auth0.svg?style=flat-square" alt=""> <a href="https://github.com/cdiaz/nestjs-auth0">Nest + Auth0</a> - NestJS Framework web application with Auth0.</li>
<li><img src="https://img.shields.io/github/stars/tfarras/nestjs-firebase-auth.svg?style=flat-square" alt=""> <a href="https://github.com/tfarras/nestjs-firebase-auth">Nest Firebase Auth</a> - NestJS Passport Strategy for Firebase Auth using Firebase Admin SDK</li>
</ul>
<h4 id="数据库-1">数据库</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/nestjs/typeorm.svg?style=flat-square" alt=""> <a href="https://github.com/nestjs/typeorm">Typeorm</a> - A TypeORM module for Nest framework [<a href="http://docs.nestjs.com/recipes/sql-typeorm">Tutorial</a>].</li>
<li><img src="https://img.shields.io/github/stars/owl1n/typeorm-factories.svg?style=flat-square" alt=""> <a href="https://github.com/owl1n/typeorm-factories">Nest Typeorm Factories</a> - A TypeORM Entities factories. Useful for NestJS unit testing.</li>
<li><img src="https://img.shields.io/github/stars/alphamikle/nest_transact.svg?style=flat-square" alt=""> <a href="https://github.com/alphamikle/nest_transact">Nest Transact</a> - The simplest transactions using with Nest and TypeORM</li>
<li><img src="https://img.shields.io/github/stars/nestjs/mongoose.svg?style=flat-square" alt=""> <a href="https://github.com/nestjs/mongoose">Nest Mongoose</a> - A Mongoose module for Nest framework.</li>
<li><img src="https://img.shields.io/github/stars/kpfromer/nestjs-typegoose.svg?style=flat-square" alt=""> <a href="https://github.com/kpfromer/nestjs-typegoose">Nest Typegoose</a> - A <a href="https://github.com/typegoose/typegoose">Typegoose</a> module for Nest framework.</li>
<li><img src="https://img.shields.io/github/stars/mikro-orm/nestjs.svg?style=flat-square" alt=""> <a href="https://github.com/mikro-orm/nestjs">Nest MikroORM</a> - A <a href="https://mikro-orm.io/">MikroORM</a> module for Nest Framework.</li>
<li><img src="https://img.shields.io/github/stars/adrien2p/nest-js-sequelize-jwt.svg?style=flat-square" alt=""> <a href="https://github.com/adrien2p/nest-js-sequelize-jwt">Nest Sequelize JWT</a> - Starter kit Nest + Sequelize + jwt.</li>
<li><img src="https://img.shields.io/github/stars/kentloog/nestjs-sequelize-typescript.svg?style=flat-square" alt=""> <a href="https://github.com/kentloog/nestjs-sequelize-typescript">Nest sequelize-typescript</a> - Nest + sequelize-typescript + JWT + Jest + Swagger.</li>
<li><a href="https://www.prisma.io/nestjs">Nest Prisma</a> - A Fully Type-Safe ORM for <a href="https://docs.nestjs.com/recipes/prisma">NestJS</a>.</li>
</ul>
<h4 id="graphql">GraphQL</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/golevelup/nestjs.svg?style=flat-square" alt=""> <a href="https://github.com/golevelup/nestjs/tree/master/packages/graphql-request">GoLevelUp NestJS GraphQL Request</a> - Easily inject and work with GraphQLClient instances from server side NestJS code. Useful for interacting with third party GraphQL APIs.</li>
<li><img src="https://img.shields.io/github/stars/golevelup/nestjs.svg?style=flat-square" alt=""> <a href="https://github.com/golevelup/nestjs/tree/master/packages/hasura">GoLevelUp NestJS Hasura</a> - NestJS integrations for working with <a href="https://hasura.io/">Hasura</a> which provides realtime GraphQL APIs over your Postgres Database.</li>
</ul>
<h4 id="模式">模式</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/nestjsx/nestjs-typeorm-paginate.svg?style=flat-square" alt=""> <a href="https://github.com/nestjsx/nestjs-typeorm-paginate">Nest typeorm paginate</a> - A simple function and interfaces for pagination.</li>
<li><img src="https://img.shields.io/github/stars/Insidexa/nestjs-rpc.svg?style=flat-square" alt=""> <a href="https://github.com/Insidexa/nestjs-rpc">Nest JSON RPC Transport</a> - JSON RPC transport layer for the NestJS framework.</li>
</ul>
<h4 id="编辑器">编辑器</h4>
<ul>
<li>VSCode
<ul>
<li><a href="https://marketplace.visualstudio.com/items?itemName=AbhijoyBasak.nestjs-files">NestJS Files</a> - Quickly create NestJS Files.</li>
<li><a href="https://github.com/ashinzekene/vscode-nestjs-snippets">NestJS Snippets</a> - Vscode NestJS code Snippets.</li>
</ul>
</li>
</ul>
<h4 id="amqp">AMQP</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/nestjsx/nestjs-amqp.svg?style=flat-square" alt=""> <a href="https://github.com/nestjsx/nestjs-amqp">Nest AMQP</a> - An amqp connection manager.</li>
<li><img src="https://img.shields.io/github/stars/AlariCode/nestjs-rmq.svg?style=flat-square" alt=""> <a href="https://github.com/AlariCode/nestjs-rmq">Nest RabbitMQ</a> - A custom library for NestJS microservice. It allows you to use RabbitMQ or AMQP.</li>
<li><img src="https://img.shields.io/github/stars/golevelup/nestjs.svg?style=flat-square" alt=""> <a href="https://github.com/golevelup/nestjs/tree/master/packages/rabbitmq">GoLevelUp NestJS RabbitMQ</a> - Flexible AMQP integrations for NestJS that supports multiple messaging patterns and intuitive decorators.</li>
</ul>
<h4 id="eventstore">EventStore</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/juicycleff/nestjs-event-store.svg?style=flat-square" alt=""> <a href="https://github.com/juicycleff/nestjs-event-store">Nest EventStore</a> - An evenstore.org module for NestJS CQRS with adapter support to persist lastcheckpoint for Catchup subscription.</li>
</ul>
<h4 id="支付网关">支付网关</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/nestjsx/nestjs-braintree.svg?style=flat-square" alt=""> <a href="https://github.com/nestjsx/nestjs-braintree">Nest Braintree</a> - A module for webhooks and transactions.</li>
<li><img src="https://img.shields.io/github/stars/dhaspden/nestjs-stripe.svg?style=flat-square" alt=""> <a href="https://github.com/dhaspden/nestjs-stripe">Nest Stripe</a> - A module for injecting a configured Stripe client into your services.</li>
<li><img src="https://img.shields.io/github/stars/golevelup/nestjs.svg?style=flat-square" alt=""> <a href="https://github.com/golevelup/nestjs/tree/master/packages/stripe">GoLevelUp Nest Stripe</a> - Injectable client plus autowired Stripe webhook handling for deeper integrations.</li>
</ul>
<h4 id="frontend">Frontend</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/FusionWorks/react-admin-nestjsx-crud-dataprovider.svg?style=flat-square" alt=""> <a href="https://github.com/FusionWorks/react-admin-nestjsx-crud-dataprovider">Nest CRUD React Admin</a> - A React Admin data provider for <a href="https://github.com/nestjsx/crud">NextJS CRUD</a>.</li>
<li><img src="https://img.shields.io/github/stars/SoftwareBrothers/admin-bro-nestjs.svg?style=flat-square" alt=""> <a href="https://github.com/SoftwareBrothers/admin-bro-nestjs">Nest AdminBro</a> - NestJS plugin for <a href="https://github.com/SoftwareBrothers/admin-bro">AdminBro</a>, an automatic admin interface which can be plugged into your application.</li>
</ul>
<h4 id="调度">调度</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/nestjsx/nest-bull.svg?style=flat-square" alt=""> <a href="https://github.com/nestjsx/nest-bull">Nest Bull</a> - A Bull module for Nest framework.</li>
</ul>
<h4 id="工作流自动化">工作流自动化</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/camunda-community-hub/nestjs-zeebe.svg?style=flat-square" alt=""> <a href="https://github.com/camunda-community-hub/nestjs-zeebe">Zeebe microservices</a></li>
</ul>
<h4 id="聊天机器人">聊天机器人</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/bukhalo/nestjs-telegraf.svg?style=flat-square" alt=""> <a href="https://github.com/bukhalo/nestjs-telegraf">Nest Telegraf</a> - A module for creating Telegram bots using NestJS, based on <a href="https://github.com/telegraf/telegraf">Telegraf</a>.</li>
<li><img src="https://img.shields.io/github/stars/SocketSomeone/necord.svg?style=flat-square" alt=""> <a href="https://github.com/SocketSomeone/necord">Necord</a> - A module for creating Discord bots using NestJS, based on <a href="https://github.com/discordjs/discord.js">Discord.js</a>.</li>
</ul>
<h4 id="文件存储">文件存储</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/codebrewlab/nestjs-storage.svg?style=flat-square" alt=""> <a href="https://github.com/codebrewlab/nestjs-storage">Nest Storage</a> - A manage file storage module(<a href="https://github.com/Slynova-Org/flydrive">flydrive</a>) for NestJS Framework.</li>
</ul>
<h4 id="云管理配置">云管理配置</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/nonfig/nestjs-config.svg?style=flat-square" alt=""> <a href="https://github.com/nonfig/nestjs-config">Nonfig Config</a> - A module for <a href="https://www.nonfig.com">Nonfig</a> Configuration Management Service. Nonfig combines Configurations and Features. So you change features, and release swiftly, and measure to digital impact.</li>
</ul>
<h4 id="sdk">SDK</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/tfarras/nestjs-firebase-admin.svg?style=flat-square" alt=""> <a href="https://github.com/tfarras/nestjs-firebase-admin">Nest Firebase Admin</a> - NestJS Module for <a href="https://firebase.google.com/">Firebase Admin SDK</a>.</li>
</ul>
<h2 id="运行时">运行时</h2>
<h4 id="命令行终端">命令行/终端</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/jmcdo29/nest-commander.svg?style=flat-square" alt=""> <a href="https://github.com/jmcdo29/nest-commander">Nest Commander</a> - A module for using NestJS to build up CLI applications</li>
<li><img src="https://img.shields.io/github/stars/nestjs/nest-cli.svg?style=flat-square" alt=""> <a href="https://github.com/nestjs/nest-cli">CLI</a> - CLI tool for NestJS applications.</li>
<li><img src="https://img.shields.io/github/stars/ashinzekene/generator-nestjs-app.svg?style=flat-square" alt=""> <a href="https://github.com/ashinzekene/generator-nestjs-app">Yeoman Generator</a> - A yeoman generator for NestJS apps.</li>
<li><img src="https://img.shields.io/github/stars/Pop-Code/nestjs-console.svg?style=flat-square" alt=""> <a href="https://github.com/Pop-Code/nestjs-console">NestJS Console</a> - A NestJS module that provide a cli to application.</li>
<li><img src="https://img.shields.io/github/stars/LoneStone/nest-sdk-generator.svg?style=flat-square" alt=""> <a href="https://github.com/lonestone/nest-sdk-generator">Typescript SDK Generator</a> - A command-line utility to generate a fully typed SDK from a Nest.js REST API</li>
</ul>
<h2 id="meetups">Meetups</h2>
<p>None at the moment.<br>
Why not create a meetup and make a PR?</p>
<h2 id="贡献">贡献</h2>
<p>Contributions welcome! Read the <a href="CONTRIBUTING.md">contribution guidelines</a> first.</p>
<h2 id="许可证">许可证</h2>
<p><a href="http://creativecommons.org/publicdomain/zero/1.0"><img src="http://mirrors.creativecommons.org/presskit/buttons/88x31/svg/cc-zero.svg" alt="CC0"></a></p>
<p>To the extent possible under law, <code>juliandavidmr</code> has waived all copyright and
related or neighboring rights to this work.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-02c29c90afd6cfbed2cfac0ea833a678">5 - bull</h1>
    <div class="lead">最快、最可靠、基于redis的Node队列。 仔细写的岩石固体的稳定性和原子性。</div>
	<blockquote>
<p><a href="https://github.com/OptimalBits/bull">https://github.com/OptimalBits/bull</a></p>
</blockquote>
<p>请在<a href="http://twitter.com/manast">📻Twitter</a>上关注我，了解重要的新闻和更新。
你可以在这个博客中找到教程和新闻: <a href="https://blog.taskforce.sh/">🛠 教程</a></p>
<h3 id="官方的前端">官方的前端</h3>
<p><a href="https://taskforce.sh"><img src="/assets/images/logo_square.png" width="100" alt="Taskforce.sh, Inc" style="padding: 100px"/></a></p>
<p>用专业前端增压你的队列:</p>
<ul>
<li>获得所有队列的完整概览。</li>
<li>检查作业、搜索、重试或提升被延迟的作业。</li>
<li>指标和统计数据。</li>
<li>还有更多的功能。</li>
</ul>
<p>登录<a href="https://taskforce.sh">Taskforce.sh</a></p>
<hr>
<h3 id="bull-特性">Bull 特性</h3>
<ul>
<li><input checked="" disabled="" type="checkbox"> 最小的 CPU 使用率，由于无轮询设计。</li>
<li><input checked="" disabled="" type="checkbox"> 基于 Redis 的稳健设计。</li>
<li><input checked="" disabled="" type="checkbox"> 延迟的工作。</li>
<li><input checked="" disabled="" type="checkbox"> 根据 cron 规范安排和重复作业。</li>
<li><input checked="" disabled="" type="checkbox"> 对工作的率限制。</li>
<li><input checked="" disabled="" type="checkbox"> 重试。</li>
<li><input checked="" disabled="" type="checkbox"> 优先级。</li>
<li><input checked="" disabled="" type="checkbox"> 并发性。</li>
<li><input checked="" disabled="" type="checkbox"> 暂停/恢复-全局或本地。</li>
<li><input checked="" disabled="" type="checkbox"> 每个队列有多个作业类型。</li>
<li><input checked="" disabled="" type="checkbox"> 线程(沙盒)处理函数。</li>
<li><input checked="" disabled="" type="checkbox"> 从进程崩溃中自动恢复。</li>
</ul>
<p>接下来是路线图…</p>
<ul>
<li><input disabled="" type="checkbox"> 作业完成确认(同时可以使用消息队列<a href="https://github.com/OptimalBits/bull/blob/develop/PATTERNS.md#returning-job-completions">pattern</a>)。</li>
<li><input disabled="" type="checkbox"> 父子的工作关系。</li>
</ul>
<hr>
<h3 id="uis">UIs</h3>
<p>你可以使用一些第三方 ui 来进行监控:</p>
<p><strong>BullMQ</strong></p>
<ul>
<li><a href="https://taskforce.sh">Taskforce</a></li>
</ul>
<p><strong>Bull v3</strong></p>
<ul>
<li><a href="https://taskforce.sh">Taskforce</a></li>
<li><a href="https://github.com/vcapretz/bull-board">bull-board</a></li>
<li><a href="https://github.com/darky/bull-repl">bull-repl</a></li>
<li><a href="https://github.com/s-r-x/bull-monitor">bull-monitor</a></li>
<li><a href="https://github.com/AbhilashJN/monitoro">Monitoro</a></li>
</ul>
<p><strong>Bull &lt;= v2</strong></p>
<ul>
<li><a href="https://github.com/ShaneK/Matador">Matador</a></li>
<li><a href="https://github.com/kfatehi/react-bull">react-bull</a></li>
<li><a href="https://github.com/Epharmix/Toureiro">Toureiro</a></li>
</ul>
<hr>
<h3 id="监测和报警">监测和报警</h3>
<ul>
<li>With Prometheus <a href="https://github.com/UpHabit/bull_exporter">Bull Queue Exporter</a></li>
</ul>
<hr>
<h3 id="特征比较">特征比较</h3>
<p>Since there are a few job queue solutions, here is a table comparing them:</p>
<table>
<thead>
<tr>
<th style="text-align:left">Feature</th>
<th style="text-align:center">Bullmq-Pro</th>
<th style="text-align:center">Bullmq</th>
<th style="text-align:center">Bull</th>
<th style="text-align:center">Kue</th>
<th>Bee</th>
<th>Agenda</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Backend</td>
<td style="text-align:center">redis</td>
<td style="text-align:center">redis</td>
<td style="text-align:center">redis</td>
<td style="text-align:center">redis</td>
<td>redis</td>
<td>mongo</td>
</tr>
<tr>
<td style="text-align:left">Observables</td>
<td style="text-align:center">✓</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">Group Rate Limit</td>
<td style="text-align:center">✓</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">Group Support</td>
<td style="text-align:center">✓</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">Parent/Child Dependencies</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">Priorities</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td></td>
<td>✓</td>
</tr>
<tr>
<td style="text-align:left">Concurrency</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td>✓</td>
<td>✓</td>
</tr>
<tr>
<td style="text-align:left">Delayed jobs</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td></td>
<td>✓</td>
</tr>
<tr>
<td style="text-align:left">Global events</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">Rate Limiter</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center"></td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">Pause/Resume</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">Sandboxed worker</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center"></td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">Repeatable jobs</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center"></td>
<td></td>
<td>✓</td>
</tr>
<tr>
<td style="text-align:left">Atomic ops</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center"></td>
<td>✓</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">Persistence</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td>✓</td>
<td>✓</td>
</tr>
<tr>
<td style="text-align:left">UI</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td></td>
<td>✓</td>
</tr>
<tr>
<td style="text-align:left">Optimized for</td>
<td style="text-align:center">Jobs / Messages</td>
<td style="text-align:center">Jobs / Messages</td>
<td style="text-align:center">Jobs / Messages</td>
<td style="text-align:center">Jobs</td>
<td>Messages</td>
<td>Jobs</td>
</tr>
</tbody>
</table>
<h3 id="安装">安装</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">npm install bull --save
</code></pre></div><p>or</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">yarn add bull
</code></pre></div><p><em><strong>Requirements:</strong> Bull requires a Redis version greater than or equal to <code>2.8.18</code>.</em></p>
<h3 id="typescript-定义">Typescript 定义</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">npm install @types/bull --save-dev
</code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">yarn add --dev @types/bull
</code></pre></div><p>Definitions are currently maintained in the <a href="https://github.com/DefinitelyTyped/DefinitelyTyped/tree/master/types/bull">DefinitelyTyped</a> repo.</p>
<h3 id="贡献">贡献</h3>
<p>我们欢迎所有类型的贡献，无论是代码修复、新特性还是文档改进。
代码格式由<a href="https://prettier.io/">prettier</a>强制执行。
对于提交，请遵循常规<a href="https://www.conventionalcommits.org/en/v1.0.0-beta.2/">commits convention</a>。
所有代码都必须通过 lint 规则和测试套件，然后才能合并到 development 中。</p>
<hr>
<h3 id="快速指南">快速指南</h3>
<h4 id="基本用法">基本用法</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Queue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;bull&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">videoQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;video transcoding&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;redis://127.0.0.1:6379&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">audioQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;audio transcoding&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">redis</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">6379</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;foobared&#34;</span> <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// Specify Redis connection using object
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">imageQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;image transcoding&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">pdfQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;pdf transcoding&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">videoQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">done</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// job.data contains the custom data passed when the job was created
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// job.id contains id of this job.
</span><span style="color:#8f5902;font-style:italic"></span>
  <span style="color:#8f5902;font-style:italic">// transcode video asynchronously and report progress
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">progress</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">42</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#8f5902;font-style:italic">// call done when finished
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">done</span><span style="color:#000;font-weight:bold">();</span>

  <span style="color:#8f5902;font-style:italic">// or give a error if error
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">done</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error transcoding&#34;</span><span style="color:#000;font-weight:bold">));</span>

  <span style="color:#8f5902;font-style:italic">// or pass it a result
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">done</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">framerate</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">29.5</span> <span style="color:#8f5902;font-style:italic">/* etc... */</span> <span style="color:#000;font-weight:bold">});</span>

  <span style="color:#8f5902;font-style:italic">// If the job throws an unhandled exception it is also handled correctly
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;some unexpected error&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">audioQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">done</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// transcode audio asynchronously and report progress
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">progress</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">42</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#8f5902;font-style:italic">// call done when finished
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">done</span><span style="color:#000;font-weight:bold">();</span>

  <span style="color:#8f5902;font-style:italic">// or give a error if error
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">done</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error transcoding&#34;</span><span style="color:#000;font-weight:bold">));</span>

  <span style="color:#8f5902;font-style:italic">// or pass it a result
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">done</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">samplerate</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">48000</span> <span style="color:#8f5902;font-style:italic">/* etc... */</span> <span style="color:#000;font-weight:bold">});</span>

  <span style="color:#8f5902;font-style:italic">// If the job throws an unhandled exception it is also handled correctly
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;some unexpected error&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">imageQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">done</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// transcode image asynchronously and report progress
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">progress</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">42</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#8f5902;font-style:italic">// call done when finished
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">done</span><span style="color:#000;font-weight:bold">();</span>

  <span style="color:#8f5902;font-style:italic">// or give a error if error
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">done</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error transcoding&#34;</span><span style="color:#000;font-weight:bold">));</span>

  <span style="color:#8f5902;font-style:italic">// or pass it a result
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">done</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1280</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">height</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">720</span> <span style="color:#8f5902;font-style:italic">/* etc... */</span> <span style="color:#000;font-weight:bold">});</span>

  <span style="color:#8f5902;font-style:italic">// If the job throws an unhandled exception it is also handled correctly
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;some unexpected error&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">pdfQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// Processors can also return promises instead of using the done callback
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">pdfAsyncProcessor</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">videoQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">video</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http://example.com/video1.mov&#34;</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000">audioQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">audio</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http://example.com/audio1.mp3&#34;</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000">imageQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">image</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http://example.com/image1.tiff&#34;</span> <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><h4 id="使用承诺">使用承诺</h4>
<p>或者，你可以使用 return promises 来代替<code>done</code>回调:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000">videoQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// 不要忘记删除done回调!
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// 简单地回报一个承诺
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fetchVideo</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">url</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">transcodeVideo</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#8f5902;font-style:italic">// 处理承诺拒绝
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reject</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error transcoding&#34;</span><span style="color:#000;font-weight:bold">));</span>

  <span style="color:#8f5902;font-style:italic">// 将承诺解析的值传递给“completed”事件
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resolve</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">framerate</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">29.5</span> <span style="color:#8f5902;font-style:italic">/* etc... */</span> <span style="color:#000;font-weight:bold">});</span>

  <span style="color:#8f5902;font-style:italic">// 如果作业抛出一个未处理的异常，它也会得到正确的处理
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;some unexpected error&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#8f5902;font-style:italic">// 一样
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reject</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;some unexpected error&#34;</span><span style="color:#000;font-weight:bold">));</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><h4 id="独立的进程">独立的进程</h4>
<p>进程函数也可以在单独的进程中运行。这有几个好处:</p>
<ul>
<li>这个进程是沙箱化的，所以即使它崩溃了，也不会影响工作进程。</li>
<li>您可以在不影响队列的情况下运行阻塞代码(作业不会停止)。</li>
<li>更好地利用多核 cpu。</li>
<li>减少与 redis 的连接。</li>
</ul>
<p>为了使用这个特性，只需创建一个单独的处理器文件:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#8f5902;font-style:italic">// processor.js
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">module</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">exports</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// 做一些繁重的工作
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resolve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">};</span>
</code></pre></div><p>然后像这样定义处理器:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#8f5902;font-style:italic">// 单流程:
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/path/to/my/processor.js&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#8f5902;font-style:italic">// 你也可以使用并发:
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;/path/to/my/processor.js&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#8f5902;font-style:italic">// 和指定的处理器:
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;my processor&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;/path/to/my/processor.js&#34;</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><h4 id="重复的工作">重复的工作</h4>
<p>A job can be added to a queue and processed repeatedly according to a cron specification:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000">paymentsQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// Check payments
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// Repeat payment job once every day at 3:15 (am)
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">paymentsQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">paymentsData</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">repeat</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">cron</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;15 3 * * *&#34;</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>As a tip, check your expressions here to verify they are correct:
<a href="https://crontab.cronhub.io">cron expression generator</a></p>
<h4 id="暂停恢复">暂停/恢复</h4>
<p>A queue can be paused and resumed globally (pass <code>true</code> to pause processing for
just this worker):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pause</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// queue is paused now
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resume</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// queue is resumed now
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</code></pre></div><h4 id="事件">事件</h4>
<p>队列会发出一些有用的事件，例如…</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;completed&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// Job completed with output result!
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">})</span>
</code></pre></div><p>For more information on events, including the full list of events that are fired, check out the <a href="./REFERENCE.md#events">Events reference</a></p>
<h4 id="队列性能">队列性能</h4>
<p>队列很便宜，所以如果你需要很多队列，只需创建新的不同名称的队列:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">userJohn</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;john&#39;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">userLisa</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;lisa&#39;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">.</span>
<span style="color:#000;font-weight:bold">.</span>
<span style="color:#000;font-weight:bold">.</span>
</code></pre></div><p>However every queue instance will require new redis connections, check how to <a href="https://github.com/OptimalBits/bull/blob/master/PATTERNS.md#reusing-redis-connections">reuse connections</a> or you can also use <a href="https://github.com/OptimalBits/bull/blob/master/REFERENCE.md#queueprocess">named processors</a> to achieve a similar result.</p>
<h4 id="集群的支持">集群的支持</h4>
<p>NOTE: From version 3.2.0 and above it is recommended to use threaded processors instead.</p>
<p>Queues are robust and can be run in parallel in several threads or processes
without any risk of hazards or queue corruption. Check this simple example
using cluster to parallelize jobs across processes:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Queue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;bull&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">cluster</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;cluster&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">numWorkers</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">queue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;test concurrent queue&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cluster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isMaster</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">numWorkers</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">cluster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">fork</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#000">cluster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;online&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">worker</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// Let&#39;s create a few jobs for the queue workers
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">500</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;bar&#34;</span> <span style="color:#000;font-weight:bold">});</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">});</span>

  <span style="color:#000">cluster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;exit&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">worker</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">code</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">signal</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;worker &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">worker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34; died&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">jobDone</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Job done by worker&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cluster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">worker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000">jobDone</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><hr>
<h3 id="文档">文档</h3>
<p>要获取完整的文档，请查看参考和常用模式:</p>
<ul>
<li><a href="https://optimalbits.github.io/bull/">Guide</a> — Your starting point for developing with Bull.</li>
<li><a href="./REFERENCE.md">Reference</a> — Reference document with all objects and methods available.</li>
<li><a href="./PATTERNS.md">Patterns</a> — a set of examples for common patterns.</li>
<li><a href="./LICENSE.md">License</a> — the Bull license—it&rsquo;s MIT.</li>
</ul>
<p>如果你看到任何可以使用更多文档的东西，请提交一个 pull request!</p>
<hr>
<h3 id="重要的笔记">重要的笔记</h3>
<p>The queue aims for an &ldquo;at least once&rdquo; working strategy. This means that in some situations, a job
could be processed more than once. This mostly happens when a worker fails to keep a lock
for a given job during the total duration of the processing.</p>
<p>When a worker is processing a job it will keep the job &ldquo;locked&rdquo; so other workers can&rsquo;t process it.</p>
<p>It&rsquo;s important to understand how locking works to prevent your jobs from losing their lock - becoming <em>stalled</em> -
and being restarted as a result. Locking is implemented internally by creating a lock for <code>lockDuration</code> on interval
<code>lockRenewTime</code> (which is usually half <code>lockDuration</code>). If <code>lockDuration</code> elapses before the lock can be renewed,
the job will be considered stalled and is automatically restarted; it will be <strong>double processed</strong>. This can happen when:</p>
<ol>
<li>The Node process running your job processor unexpectedly terminates.</li>
<li>Your job processor was too CPU-intensive and stalled the Node event loop, and as a result, Bull couldn&rsquo;t renew the job lock (see <a href="https://github.com/OptimalBits/bull/issues/488">#488</a> for how we might better detect this). You can fix this by breaking your job processor into smaller parts so that no single part can block the Node event loop. Alternatively, you can pass a larger value for the <code>lockDuration</code> setting (with the tradeoff being that it will take longer to recognize a real stalled job).</li>
</ol>
<p>As such, you should always listen for the <code>stalled</code> event and log this to your error monitoring system, as this means your jobs are likely getting double-processed.</p>
<p>As a safeguard so problematic jobs won&rsquo;t get restarted indefinitely (e.g. if the job processor always crashes its Node process), jobs will be recovered from a stalled state a maximum of <code>maxStalledCount</code> times (default: <code>1</code>).</p>
<h3 id="所使用的">所使用的</h3>
<p>Bull 在大大小小的组织中都很受欢迎，比如以下这些组织:</p>
<table cellspacing="0" cellpadding="0">
  <tr>
    <td valign="center">
      <a href="https://github.com/atlassian/github-for-jira">
        <img
          src="https://876297641-files.gitbook.io/~/files/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-LUuDmt_xXMfG66Rn1GA%2Fuploads%2FevsJCF6F1tx1ScZwDQOd%2FAtlassian-horizontal-blue-rgb.webp?alt=media&token=2fcd0528-e8bb-4bdd-af35-9d20e313d1a8"
          width="150"
          alt="Atlassian"
      /></a>
    </td>
    <td valign="center">
      <a href="https://github.com/Autodesk">
        <img
          src="https://876297641-files.gitbook.io/~/files/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-LUuDmt_xXMfG66Rn1GA%2Fuploads%2FvpTe02RdOhUJBA8TdHEE%2Fautodesk-logo-white.png?alt=media&token=326961b4-ea4f-4ded-89a4-e05692eec8ee"
          width="150"
          alt="Autodesk"
      /></a>
    </td>
    <td valign="center">
      <a href="https://github.com/common-voice/common-voice">
        <img
          src="https://876297641-files.gitbook.io/~/files/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-LUuDmt_xXMfG66Rn1GA%2Fuploads%2F4zPSrubNJKViAzUIftIy%2Fmozilla-logo-bw-rgb.png?alt=media&token=9f93aae2-833f-4cc4-8df9-b7fea0ad5cb5"
          width="150"
          alt="Mozilla"
      /></a>
    </td>
    <td valign="center">
      <a href="https://github.com/nestjs/bull">
        <img
          src="https://876297641-files.gitbook.io/~/files/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-LUuDmt_xXMfG66Rn1GA%2Fuploads%2FfAcGye182utFUtPKdLqJ%2FScreenshot%202022-02-15%20at%2011.32.39.png?alt=media&token=29feb550-f0bc-467d-a290-f700701d7d15"
          width="150"
          alt="Nest"
      /></a>
    </td>
    <td valign="center">
      <a href="https://github.com/salesforce/refocus">
        <img
          src="https://876297641-files.gitbook.io/~/files/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-LUuDmt_xXMfG66Rn1GA%2Fuploads%2FZNnYNuL5qJ6ZoBh7JJEW%2Fsalesforce-logo.png?alt=media&token=ddcae63b-08c0-4dd4-8496-3b29a9bf977d"
          width="100"
          alt="Salesforce"
      /></a>
    </td>
  </tr>
</table>
<hr>
<h3 id="bullmq">BullMQ</h3>
<p>如果你想开始使用完全用 Typescript 编写的下一个主要版本的 Bull，欢迎使用新的 repo<a href="https://github.com/taskforcesh/bullmq">这里</a>.
否则，我们非常欢迎你仍然使用 Bull，这是一个安全的、经过战斗测试的代码库。</p>
<hr>
<h3 id="-赞助商-">🚀 赞助商 🚀</h3>
<p><a href="https://dashboard.redisgreen.net/new?utm_campaign=BULLMQ"><img src="/assets/images/redisgreen_transparent_240x48.png" width="150" alt="RedisGreen" style="padding: 100px"/></a></p>
<p>如果您需要高质量的生产 Redis 实例为您的 Bull 项目，请考虑订阅<a href="https://dashboard.redisgreen.net/new?utm_campaign=BULLMQ">RedisGreen</a>,Redis 的领导者们与 Bull 完美地合作。
注册时请使用促销代码“BULLMQ”，以帮助我们赞助 Bull 的发展!</p>
<hr>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c709471c70f27c6bb15b128d75977220">6 - http</h1>
    
	<blockquote>
<p><a href="https://github.com/axios/axios">https://github.com/axios/axios</a></p>
</blockquote>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-42a26675b19acc37e7dbc0e2c8d454d2">6.1 - axios</h1>
    
	<p><a href="https://www.npmjs.org/package/axios"><img src="https://img.shields.io/npm/v/axios.svg?style=flat-square" alt="npm version"></a>
<a href="https://cdnjs.com/libraries/axios"><img src="https://img.shields.io/cdnjs/v/axios.svg?style=flat-square" alt="CDNJS"></a>
<img src="https://github.com/axios/axios/actions/workflows/ci.yml/badge.svg" alt="Build status">
<a href="https://gitpod.io/#https://github.com/axios/axios"><img src="https://img.shields.io/badge/Gitpod-Ready--to--Code-blue?logo=gitpod" alt="Gitpod Ready-to-Code"></a>
<a href="https://coveralls.io/r/mzabriskie/axios"><img src="https://img.shields.io/coveralls/mzabriskie/axios.svg?style=flat-square" alt="code coverage"></a>
<a href="https://packagephobia.now.sh/result?p=axios"><img src="https://packagephobia.now.sh/badge?p=axios" alt="install size"></a>
<a href="http://npm-stat.com/charts.html?package=axios"><img src="https://img.shields.io/npm/dm/axios.svg?style=flat-square" alt="npm downloads"></a>
<a href="https://gitter.im/mzabriskie/axios"><img src="https://img.shields.io/gitter/room/mzabriskie/axios.svg?style=flat-square" alt="gitter chat"></a>
<a href="https://www.codetriage.com/axios/axios"><img src="https://www.codetriage.com/axios/axios/badges/users.svg" alt="code helpers"></a>
<a href="https://snyk.io/test/npm/axios"><img src="https://snyk.io/test/npm/axios/badge.svg" alt="Known Vulnerabilities"></a></p>
<p>Promise based HTTP client for the browser and node.js</p>
<blockquote>
<p>New axios docs website: <a href="https://axios-http.com/">click here</a></p>
</blockquote>
<h2 id="功能">功能</h2>
<ul>
<li>Make <a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest">XMLHttpRequests</a> from the browser</li>
<li>Make <a href="http://nodejs.org/api/http.html">http</a> requests from node.js</li>
<li>Supports the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promise</a> API</li>
<li>Intercept request and response</li>
<li>Transform request and response data</li>
<li>Cancel requests</li>
<li>Automatic transforms for JSON data</li>
<li>Client side support for protecting against <a href="http://en.wikipedia.org/wiki/Cross-site_request_forgery">XSRF</a></li>
</ul>
<h2 id="浏览器支持">浏览器支持</h2>
<table>
<thead>
<tr>
<th><img src="https://raw.github.com/alrra/browser-logos/master/src/chrome/chrome_48x48.png" alt="Chrome"></th>
<th><img src="https://raw.github.com/alrra/browser-logos/master/src/firefox/firefox_48x48.png" alt="Firefox"></th>
<th><img src="https://raw.github.com/alrra/browser-logos/master/src/safari/safari_48x48.png" alt="Safari"></th>
<th><img src="https://raw.github.com/alrra/browser-logos/master/src/opera/opera_48x48.png" alt="Opera"></th>
<th><img src="https://raw.github.com/alrra/browser-logos/master/src/edge/edge_48x48.png" alt="Edge"></th>
<th><img src="https://raw.github.com/alrra/browser-logos/master/src/archive/internet-explorer_9-11/internet-explorer_9-11_48x48.png" alt="IE"></th>
</tr>
</thead>
<tbody>
<tr>
<td>Latest ✔</td>
<td>Latest ✔</td>
<td>Latest ✔</td>
<td>Latest ✔</td>
<td>Latest ✔</td>
<td>11 ✔</td>
</tr>
</tbody>
</table>
<p><a href="https://saucelabs.com/u/axios"><img src="https://saucelabs.com/open_sauce/build_matrix/axios.svg" alt="Browser Matrix"></a></p>
<h2 id="安装">安装</h2>
<p>Using npm:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ npm install axios
</code></pre></div><p>Using bower:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ bower install axios
</code></pre></div><p>Using yarn:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ yarn add axios
</code></pre></div><p>Using jsDelivr CDN:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html"><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">script</span> <span style="color:#c4a000">src</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js&#34;</span><span style="color:#000;font-weight:bold">&gt;&lt;/</span><span style="color:#204a87;font-weight:bold">script</span><span style="color:#000;font-weight:bold">&gt;</span>
</code></pre></div><p>Using unpkg CDN:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html"><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">script</span> <span style="color:#c4a000">src</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;https://unpkg.com/axios/dist/axios.min.js&#34;</span><span style="color:#000;font-weight:bold">&gt;&lt;/</span><span style="color:#204a87;font-weight:bold">script</span><span style="color:#000;font-weight:bold">&gt;</span>
</code></pre></div><h2 id="示例">示例</h2>
<h3 id="note-commonjs-usage">note: CommonJS usage</h3>
<p>In order to gain the TypeScript typings (for intellisense / autocomplete) while using CommonJS imports with <code>require()</code> use the following approach:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">axios</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;axios&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">// axios.&lt;method&gt; will now provide autocomplete and parameter typings
</span></code></pre></div><p>Performing a <code>GET</code> request</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">axios</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;axios&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">// Make a request for a user with a given ID
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">axios</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/user?ID=12345&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// handle success
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">catch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// handle error
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// always executed
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// Optionally the request above could also be done as
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">axios</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/user&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">params</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">ID</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">12345</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">catch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// always executed
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// Want to use async/await? Add the `async` keyword to your outer function/method.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">getUser</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">response</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/user?ID=12345&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p><strong>NOTE:</strong> <code>async/await</code> is part of ECMAScript 2017 and is not supported in Internet
Explorer and older browsers, so use with caution.</p>
</blockquote>
<p>Performing a <code>POST</code> request</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000">axios</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/user&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">firstName</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Fred&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">lastName</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Flintstone&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">catch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>Performing multiple concurrent requests</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">getUserAccount</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/user/12345&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">getUserPermissions</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/user/12345/permissions&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">all</span><span style="color:#000;font-weight:bold">([</span><span style="color:#000">getUserAccount</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">getUserPermissions</span><span style="color:#000;font-weight:bold">()]).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">results</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">acct</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">results</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">];</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">perm</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">results</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><h2 id="axios-api">axios API</h2>
<p>Requests can be made by passing the relevant config to <code>axios</code>.</p>
<h5 id="axiosconfig">axios(config)</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#8f5902;font-style:italic">// Send a POST request
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">method</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;post&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">url</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;/user/12345&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">firstName</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Fred&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">lastName</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Flintstone&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#8f5902;font-style:italic">// GET request for remote image in node.js
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">method</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;get&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">url</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http://bit.ly/2mTM3nY&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">responseType</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;stream&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">}).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pipe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createWriteStream</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ada_lovelace.jpg&#34;</span><span style="color:#000;font-weight:bold">));</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><h5 id="axiosurl-config">axios(url[, config])</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#8f5902;font-style:italic">// Send a GET request (default method)
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/user/12345&#34;</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><h3 id="请求方法的别名">请求方法的别名</h3>
<p>For convenience, aliases have been provided for all common request methods.</p>
<h5 id="axiosrequestconfig">axios.request(config)</h5>
<h5 id="axiosgeturl-config">axios.get(url[, config])</h5>
<h5 id="axiosdeleteurl-config">axios.delete(url[, config])</h5>
<h5 id="axiosheadurl-config">axios.head(url[, config])</h5>
<h5 id="axiosoptionsurl-config">axios.options(url[, config])</h5>
<h5 id="axiosposturl-data-config">axios.post(url[, data[, config]])</h5>
<h5 id="axiosputurl-data-config">axios.put(url[, data[, config]])</h5>
<h5 id="axiospatchurl-data-config">axios.patch(url[, data[, config]])</h5>
<h6 id="note">NOTE</h6>
<p>When using the alias methods <code>url</code>, <code>method</code>, and <code>data</code> properties don&rsquo;t need to be specified in config.</p>
<h3 id="并发性弃用">并发性(弃用)</h3>
<p>Please use <code>Promise.all</code> to replace the below functions.</p>
<p>Helper functions for dealing with concurrent requests.</p>
<p>axios.all(iterable)
axios.spread(callback)</p>
<h3 id="创建一个实例">创建一个实例</h3>
<p>You can create a new instance of axios with a custom config.</p>
<h5 id="axioscreateconfig">axios.create([config])</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">instance</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">create</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">baseURL</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;https://some-domain.com/api/&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">timeout</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">headers</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#4e9a06">&#34;X-Custom-Header&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;foobar&#34;</span> <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><h3 id="实例方法">实例方法</h3>
<p>The available instance methods are listed below. The specified config will be merged with the instance config.</p>
<h5 id="axiosrequestconfig-1">axios#request(config)</h5>
<h5 id="axiosgeturl-config-1">axios#get(url[, config])</h5>
<h5 id="axiosdeleteurl-config-1">axios#delete(url[, config])</h5>
<h5 id="axiosheadurl-config-1">axios#head(url[, config])</h5>
<h5 id="axiosoptionsurl-config-1">axios#options(url[, config])</h5>
<h5 id="axiosposturl-data-config-1">axios#post(url[, data[, config]])</h5>
<h5 id="axiosputurl-data-config-1">axios#put(url[, data[, config]])</h5>
<h5 id="axiospatchurl-data-config-1">axios#patch(url[, data[, config]])</h5>
<h5 id="axiosgeturiconfig">axios#getUri([config])</h5>
<h2 id="请求配置">请求配置</h2>
<p>These are the available config options for making requests. Only the <code>url</code> is required. Requests will default to <code>GET</code> if <code>method</code> is not specified.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// `url` is the server URL that will be used for the request
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">url</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;/user&#39;</span><span style="color:#000;font-weight:bold">,</span>

  <span style="color:#8f5902;font-style:italic">// `method` is the request method to be used when making the request
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">method</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;get&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// default
</span><span style="color:#8f5902;font-style:italic"></span>
  <span style="color:#8f5902;font-style:italic">// `baseURL` will be prepended to `url` unless `url` is absolute.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// It can be convenient to set `baseURL` for an instance of axios to pass relative URLs
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// to methods of that instance.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">baseURL</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;https://some-domain.com/api/&#39;</span><span style="color:#000;font-weight:bold">,</span>

  <span style="color:#8f5902;font-style:italic">// `transformRequest` allows changes to the request data before it is sent to the server
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// This is only applicable for request methods &#39;PUT&#39;, &#39;POST&#39;, &#39;PATCH&#39; and &#39;DELETE&#39;
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// The last function in the array must return a string or an instance of Buffer, ArrayBuffer,
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// FormData or Stream
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// You may modify the headers object.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">transformRequest</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">headers</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// Do whatever you want to transform the data
</span><span style="color:#8f5902;font-style:italic"></span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}],</span>

  <span style="color:#8f5902;font-style:italic">// `transformResponse` allows changes to the response data to be made before
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// it is passed to then/catch
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">transformResponse</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// Do whatever you want to transform the data
</span><span style="color:#8f5902;font-style:italic"></span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}],</span>

  <span style="color:#8f5902;font-style:italic">// `headers` are custom headers to be sent
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">headers</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#39;X-Requested-With&#39;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;XMLHttpRequest&#39;</span><span style="color:#000;font-weight:bold">},</span>

  <span style="color:#8f5902;font-style:italic">// `params` are the URL parameters to be sent with the request
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Must be a plain object or a URLSearchParams object
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">params</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">ID</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">12345</span>
  <span style="color:#000;font-weight:bold">},</span>

  <span style="color:#8f5902;font-style:italic">// `paramsSerializer` is an optional function in charge of serializing `params`
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// (e.g. https://www.npmjs.com/package/qs, http://api.jquery.com/jquery.param/)
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">paramsSerializer</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">params</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">Qs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stringify</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">params</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">arrayFormat</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;brackets&#39;</span><span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000;font-weight:bold">},</span>

  <span style="color:#8f5902;font-style:italic">// `data` is the data to be sent as the request body
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Only applicable for request methods &#39;PUT&#39;, &#39;POST&#39;, &#39;DELETE , and &#39;PATCH&#39;
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// When no `transformRequest` is set, must be of one of the following types:
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// - string, plain object, ArrayBuffer, ArrayBufferView, URLSearchParams
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// - Browser only: FormData, File, Blob
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// - Node only: Stream, Buffer
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">firstName</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;Fred&#39;</span>
  <span style="color:#000;font-weight:bold">},</span>

  <span style="color:#8f5902;font-style:italic">// syntax alternative to send data into the body
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// method post
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// only the value is sent, not the key
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;Country=Brasil&amp;City=Belo Horizonte&#39;</span><span style="color:#000;font-weight:bold">,</span>

  <span style="color:#8f5902;font-style:italic">// `timeout` specifies the number of milliseconds before the request times out.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// If the request takes longer than `timeout`, the request will be aborted.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">timeout</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// default is `0` (no timeout)
</span><span style="color:#8f5902;font-style:italic"></span>
  <span style="color:#8f5902;font-style:italic">// `withCredentials` indicates whether or not cross-site Access-Control requests
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// should be made using credentials
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">withCredentials</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// default
</span><span style="color:#8f5902;font-style:italic"></span>
  <span style="color:#8f5902;font-style:italic">// `adapter` allows custom handling of requests which makes testing easier.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Return a promise and supply a valid response (see lib/adapters/README.md).
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">adapter</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">/* ... */</span>
  <span style="color:#000;font-weight:bold">},</span>

  <span style="color:#8f5902;font-style:italic">// `auth` indicates that HTTP Basic auth should be used, and supplies credentials.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// This will set an `Authorization` header, overwriting any existing
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// `Authorization` custom headers you have set using `headers`.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Please note that only HTTP Basic auth is configurable through this parameter.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// For Bearer tokens and such, use `Authorization` custom headers instead.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">auth</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">username</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;janedoe&#39;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;s00pers3cret&#39;</span>
  <span style="color:#000;font-weight:bold">},</span>

  <span style="color:#8f5902;font-style:italic">// `responseType` indicates the type of data that the server will respond with
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// options are: &#39;arraybuffer&#39;, &#39;document&#39;, &#39;json&#39;, &#39;text&#39;, &#39;stream&#39;
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">//   browser only: &#39;blob&#39;
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">responseType</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;json&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// default
</span><span style="color:#8f5902;font-style:italic"></span>
  <span style="color:#8f5902;font-style:italic">// `responseEncoding` indicates encoding to use for decoding responses (Node.js only)
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Note: Ignored for `responseType` of &#39;stream&#39; or client-side requests
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">responseEncoding</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;utf8&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// default
</span><span style="color:#8f5902;font-style:italic"></span>
  <span style="color:#8f5902;font-style:italic">// `xsrfCookieName` is the name of the cookie to use as a value for xsrf token
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">xsrfCookieName</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;XSRF-TOKEN&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// default
</span><span style="color:#8f5902;font-style:italic"></span>
  <span style="color:#8f5902;font-style:italic">// `xsrfHeaderName` is the name of the http header that carries the xsrf token value
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">xsrfHeaderName</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;X-XSRF-TOKEN&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// default
</span><span style="color:#8f5902;font-style:italic"></span>
  <span style="color:#8f5902;font-style:italic">// `onUploadProgress` allows handling of progress events for uploads
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// browser only
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">onUploadProgress</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">progressEvent</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// Do whatever you want with the native progress event
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">},</span>

  <span style="color:#8f5902;font-style:italic">// `onDownloadProgress` allows handling of progress events for downloads
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// browser only
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">onDownloadProgress</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">progressEvent</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// Do whatever you want with the native progress event
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">},</span>

  <span style="color:#8f5902;font-style:italic">// `maxContentLength` defines the max size of the http response content in bytes allowed in node.js
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">maxContentLength</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2000</span><span style="color:#000;font-weight:bold">,</span>

  <span style="color:#8f5902;font-style:italic">// `maxBodyLength` (Node only option) defines the max size of the http request content in bytes allowed
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">maxBodyLength</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2000</span><span style="color:#000;font-weight:bold">,</span>

  <span style="color:#8f5902;font-style:italic">// `validateStatus` defines whether to resolve or reject the promise for a given
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// HTTP response status code. If `validateStatus` returns `true` (or is set to `null`
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// or `undefined`), the promise will be resolved; otherwise, the promise will be
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// rejected.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">validateStatus</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">status</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">status</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">200</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">status</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">300</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// default
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">},</span>

  <span style="color:#8f5902;font-style:italic">// `maxRedirects` defines the maximum number of redirects to follow in node.js.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// If set to 0, no redirects will be followed.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">maxRedirects</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">21</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// default
</span><span style="color:#8f5902;font-style:italic"></span>
  <span style="color:#8f5902;font-style:italic">// `beforeRedirect` defines a function that will be called before redirect.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Use this to adjust the request options upon redirecting,
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// to inspect the latest response headers,
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// or to cancel the request by throwing an error
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// If maxRedirects is set to 0, `beforeRedirect` is not used.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">beforeRedirect</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">headers</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">hostname</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;example.com&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">auth</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;user:password&#34;</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">};</span>

  <span style="color:#8f5902;font-style:italic">// `socketPath` defines a UNIX Socket to be used in node.js.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// e.g. &#39;/var/run/docker.sock&#39; to send requests to the docker daemon.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Only either `socketPath` or `proxy` can be specified.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// If both are specified, `socketPath` is used.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">socketPath</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// default
</span><span style="color:#8f5902;font-style:italic"></span>
  <span style="color:#8f5902;font-style:italic">// `httpAgent` and `httpsAgent` define a custom agent to be used when performing http
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// and https requests, respectively, in node.js. This allows options to be added like
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// `keepAlive` that are not enabled by default.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">httpAgent</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Agent</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">keepAlive</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">}),</span>
  <span style="color:#000">httpsAgent</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">https</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Agent</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">keepAlive</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">}),</span>

  <span style="color:#8f5902;font-style:italic">// `proxy` defines the hostname, port, and protocol of the proxy server.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// You can also define your proxy using the conventional `http_proxy` and
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// `https_proxy` environment variables. If you are using environment variables
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// for your proxy configuration, you can also define a `no_proxy` environment
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// variable as a comma-separated list of domains that should not be proxied.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Use `false` to disable proxies, ignoring environment variables.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// `auth` indicates that HTTP Basic auth should be used to connect to the proxy, and
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// supplies credentials.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// This will set an `Proxy-Authorization` header, overwriting any existing
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// `Proxy-Authorization` custom headers you have set using `headers`.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// If the proxy server uses HTTPS, then you must set the protocol to `https`.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">proxy</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">protocol</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;https&#39;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;127.0.0.1&#39;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">9000</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">auth</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">username</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;mikeymike&#39;</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;rapunz3l&#39;</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">},</span>

  <span style="color:#8f5902;font-style:italic">// `cancelToken` specifies a cancel token that can be used to cancel the request
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// (see Cancellation section below for details)
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">cancelToken</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">CancelToken</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cancel</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">}),</span>

  <span style="color:#8f5902;font-style:italic">// an alternative way to cancel Axios requests using AbortController
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">signal</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbortController</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">signal</span><span style="color:#000;font-weight:bold">,</span>

  <span style="color:#8f5902;font-style:italic">// `decompress` indicates whether or not the response body should be decompressed
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// automatically. If set to `true` will also remove the &#39;content-encoding&#39; header
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// from the responses objects of all decompressed responses
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// - Node only (XHR cannot turn off decompression)
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">decompress</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#8f5902;font-style:italic">// default
</span><span style="color:#8f5902;font-style:italic"></span>
  <span style="color:#8f5902;font-style:italic">// `insecureHTTPParser` boolean.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Indicates where to use an insecure HTTP parser that accepts invalid HTTP headers.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// This may allow interoperability with non-conformant HTTP implementations.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Using the insecure parser should be avoided.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// see options https://nodejs.org/dist/latest-v12.x/docs/api/http.html#http_http_request_url_options_callback
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// see also https://nodejs.org/en/blog/vulnerability/february-2020-security-releases/#strict-http-header-parsing-none
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">insecureHTTPParser</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">undefined</span> <span style="color:#8f5902;font-style:italic">// default
</span><span style="color:#8f5902;font-style:italic"></span>
  <span style="color:#8f5902;font-style:italic">// transitional options for backward compatibility that may be removed in the newer versions
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">transitional</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// silent JSON parsing mode
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// `true`  - ignore JSON parsing errors and set response.data to null if parsing failed (old behaviour)
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// `false` - throw SyntaxError if JSON parsing failed (Note: responseType must be set to &#39;json&#39;)
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">silentJSONParsing</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// default value for the current Axios version
</span><span style="color:#8f5902;font-style:italic"></span>
    <span style="color:#8f5902;font-style:italic">// try to parse the response string as JSON even if `responseType` is not &#39;json&#39;
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">forcedJSONParsing</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>

    <span style="color:#8f5902;font-style:italic">// throw ETIMEDOUT error instead of generic ECONNABORTED on request timeouts
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">clarifyTimeoutError</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">},</span>

  <span style="color:#000">env</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// The FormData class to be used to automatically serialize the payload into a FormData object
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">FormData</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87">window</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FormData</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">global</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FormData</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="响应模式">响应模式</h2>
<p>The response for a request contains the following information.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// `data` is the response that was provided by the server
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{},</span>

  <span style="color:#8f5902;font-style:italic">// `status` is the HTTP status code from the server response
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">status</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">,</span>

  <span style="color:#8f5902;font-style:italic">// `statusText` is the HTTP status message from the server response
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">statusText</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;OK&#39;</span><span style="color:#000;font-weight:bold">,</span>

  <span style="color:#8f5902;font-style:italic">// `headers` the HTTP headers that the server responded with
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// All header names are lower cased and can be accessed using the bracket notation.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Example: `response.headers[&#39;content-type&#39;]`
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">headers</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{},</span>

  <span style="color:#8f5902;font-style:italic">// `config` is the config that was provided to `axios` for the request
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">config</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{},</span>

  <span style="color:#8f5902;font-style:italic">// `request` is the request that generated this response
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// It is the last ClientRequest instance in node.js (in redirects)
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// and an XMLHttpRequest instance in the browser
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>When using <code>then</code>, you will receive the response as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/user/12345&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">status</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">statusText</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">headers</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>When using <code>catch</code>, or passing a <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/then">rejection callback</a> as second parameter of <code>then</code>, the response will be available through the <code>error</code> object as explained in the <a href="#handling-errors">Handling Errors</a> section.</p>
<h2 id="配置默认">配置默认</h2>
<p>您可以指定将应用于每个请求的默认配置。</p>
<h3 id="全局-axios-默认">全局 axios 默认</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">defaults</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">baseURL</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;https://api.example.com&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">// Important: If axios is used with multiple domains, the AUTH_TOKEN will be sent to all of them.
</span><span style="color:#8f5902;font-style:italic">// See below for an example using Custom instance defaults instead.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">defaults</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">headers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">common</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;Authorization&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">AUTH_TOKEN</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">defaults</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">headers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;Content-Type&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;application/x-www-form-urlencoded&#34;</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><h3 id="自定义实例默认">自定义实例默认</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#8f5902;font-style:italic">// Set config defaults when creating the instance
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">instance</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">create</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">baseURL</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;https://api.example.com&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// Alter defaults after instance has been created
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">instance</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">defaults</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">headers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">common</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;Authorization&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">AUTH_TOKEN</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><h3 id="配置优先顺序">配置优先顺序</h3>
<p>Config will be merged with an order of precedence. The order is library defaults found in <a href="https://github.com/axios/axios/blob/master/lib/defaults.js#L28">lib/defaults.js</a>, then <code>defaults</code> property of the instance, and finally <code>config</code> argument for the request. The latter will take precedence over the former. Here&rsquo;s an example.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#8f5902;font-style:italic">// Create an instance using the config defaults provided by the library
</span><span style="color:#8f5902;font-style:italic">// At this point the timeout config value is `0` as is the default for the library
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">instance</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">create</span><span style="color:#000;font-weight:bold">();</span>

<span style="color:#8f5902;font-style:italic">// Override timeout default for the library
</span><span style="color:#8f5902;font-style:italic">// Now all requests using this instance will wait 2.5 seconds before timing out
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">instance</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">defaults</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">timeout</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2500</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">// Override timeout for this request as it&#39;s known to take a long time
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">instance</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/longRequest&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">timeout</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">5000</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><h2 id="拦截器">拦截器</h2>
<p>You can intercept requests or responses before they are handled by <code>then</code> or <code>catch</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#8f5902;font-style:italic">// Add a request interceptor
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">interceptors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">use</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// Do something before request is sent
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// Do something with request error
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reject</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">);</span>

<span style="color:#8f5902;font-style:italic">// Add a response interceptor
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">interceptors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">use</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// Any status code that lie within the range of 2xx cause this function to trigger
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Do something with response data
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">response</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// Any status codes that falls outside the range of 2xx cause this function to trigger
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Do something with response error
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reject</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>If you need to remove an interceptor later you can.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">myInterceptor</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">interceptors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">use</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">/*...*/</span>
<span style="color:#000;font-weight:bold">});</span>
<span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">interceptors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">eject</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">myInterceptor</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>You can add interceptors to a custom instance of axios.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">instance</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">create</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000">instance</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">interceptors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">use</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">/*...*/</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>When you add request interceptors, they are presumed to be asynchronous by default. This can cause a delay
in the execution of your axios request when the main thread is blocked (a promise is created under the hood for
the interceptor and your request gets put on the bottom of the call stack). If your request interceptors are synchronous you can add a flag
to the options object that will tell axios to run the code synchronously and avoid any delays in request execution.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">interceptors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">use</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">headers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">test</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;I am only a header!&#34;</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">synchronous</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>If you want to execute a particular interceptor based on a runtime check,
you can add a <code>runWhen</code> function to the options object. The interceptor will not be executed <strong>if and only if</strong> the return
of <code>runWhen</code> is <code>false</code>. The function will be called with the config
object (don&rsquo;t forget that you can bind your own arguments to it as well.) This can be handy when you have an
asynchronous request interceptor that only needs to run at certain times.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">onGetCall</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">method</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;get&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">interceptors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">use</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">headers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">test</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;special get headers&#34;</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">runWhen</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">onGetCall</span> <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">);</span>
</code></pre></div><h3 id="多个拦截器">多个拦截器</h3>
<p>Given you add multiple response interceptors
and when the response was fulfilled</p>
<ul>
<li>then each interceptor is executed</li>
<li>then they are executed in the order they were added</li>
<li>then only the last interceptor&rsquo;s result is returned</li>
<li>then every interceptor receives the result of it&rsquo;s predecessor</li>
<li>and when the fulfillment-interceptor throws
<ul>
<li>then the following fulfillment-interceptor is not called</li>
<li>then the following rejection-interceptor is called</li>
<li>once caught, another following fulfill-interceptor is called again (just like in a promise chain).</li>
</ul>
</li>
</ul>
<p>Read <a href="./test/specs/interceptors.spec.js">the interceptor tests</a> for seeing all this in code.</p>
<h2 id="处理错误">处理错误</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/user/12345&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#204a87;font-weight:bold">catch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// The request was made and the server responded with a status code
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// that falls out of the range of 2xx
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">status</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">headers</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// The request was made but no response was received
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// `error.request` is an instance of XMLHttpRequest in the browser and an instance of
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// http.ClientRequest in node.js
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// Something happened in setting up the request that triggered an Error
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Error&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">error</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>Using the <code>validateStatus</code> config option, you can define HTTP code(s) that should throw an error.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/user/12345&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">validateStatus</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">status</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">status</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">500</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Resolve only if the status code is less than 500
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>Using <code>toJSON</code> you get an object with more information about the HTTP error.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/user/12345&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#204a87;font-weight:bold">catch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toJSON</span><span style="color:#000;font-weight:bold">());</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><h2 id="取消">取消</h2>
<h3 id="abortcontroller">AbortController</h3>
<p>Starting from <code>v0.22.0</code> Axios supports AbortController to cancel requests in fetch API way:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">controller</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbortController</span><span style="color:#000;font-weight:bold">();</span>

<span style="color:#000">axios</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo/bar&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">signal</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">signal</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">//...
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">});</span>
<span style="color:#8f5902;font-style:italic">// cancel the request
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">abort</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div><h3 id="canceltoken-deprecated">CancelToken <code>👎deprecated</code></h3>
<p>You can also cancel a request using a <em>CancelToken</em>.</p>
<blockquote>
<p>The axios cancel token API is based on the withdrawn <a href="https://github.com/tc39/proposal-cancelable-promises">cancelable promises proposal</a>.</p>
</blockquote>
<blockquote>
<p>This API is deprecated since v0.22.0 and shouldn&rsquo;t be used in new projects</p>
</blockquote>
<p>You can create a cancel token using the <code>CancelToken.source</code> factory as shown below:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">CancelToken</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CancelToken</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">source</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">CancelToken</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">source</span><span style="color:#000;font-weight:bold">();</span>

<span style="color:#000">axios</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/user/12345&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">cancelToken</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">source</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">token</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">catch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrown</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isCancel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrown</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Request canceled&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">thrown</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#8f5902;font-style:italic">// handle error
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#4e9a06">&#34;/user/12345&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;new name&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">cancelToken</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">source</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">token</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">);</span>

<span style="color:#8f5902;font-style:italic">// cancel the request (the message parameter is optional)
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">source</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cancel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Operation canceled by the user.&#34;</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>You can also create a cancel token by passing an executor function to the <code>CancelToken</code> constructor:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">CancelToken</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CancelToken</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">cancel</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/user/12345&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">cancelToken</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">CancelToken</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">executor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// An executor function receives a cancel function as a parameter
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">cancel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}),</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// cancel the request
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">cancel</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div><blockquote>
<p>Note: you can cancel several requests with the same cancel token/abort controller.
If a cancellation token is already cancelled at the moment of starting an Axios request, then the request is cancelled immediately, without any attempts to make real request.</p>
</blockquote>
<blockquote>
<p>During the transition period, you can use both cancellation APIs, even for the same request:</p>
</blockquote>
<h2 id="使用-applicationx-www-form-urlencoded-格式">使用 application/x-www-form-urlencoded 格式</h2>
<p>By default, axios serializes JavaScript objects to <code>JSON</code>. To send data in the <code>application/x-www-form-urlencoded</code> format instead, you can use one of the following options.</p>
<h3 id="浏览器">浏览器</h3>
<p>In a browser, you can use the <a href="https://developer.mozilla.org/en-US/docs/Web/API/URLSearchParams"><code>URLSearchParams</code></a> API as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">params</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">URLSearchParams</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000">params</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;param1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;value1&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">params</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;param2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;value2&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">params</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><blockquote>
<p>Note that <code>URLSearchParams</code> is not supported by all browsers (see <a href="http://www.caniuse.com/#feat=urlsearchparams">caniuse.com</a>), but there is a <a href="https://github.com/WebReflection/url-search-params">polyfill</a> available (make sure to polyfill the global environment).</p>
</blockquote>
<p>Alternatively, you can encode data using the <a href="https://github.com/ljharb/qs"><code>qs</code></a> library:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">qs</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;qs&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">qs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stringify</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">bar</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">123</span> <span style="color:#000;font-weight:bold">}));</span>
</code></pre></div><p>Or in another way (ES6),</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">qs</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;qs&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">bar</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">123</span> <span style="color:#000;font-weight:bold">};</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">options</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">method</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;POST&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">headers</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#4e9a06">&#34;content-type&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;application/x-www-form-urlencoded&#34;</span> <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">qs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stringify</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">),</span>
  <span style="color:#000">url</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">};</span>
<span style="color:#000">axios</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><h3 id="nodejs">Node.js</h3>
<h4 id="查询字符串">查询字符串</h4>
<p>In node.js, you can use the <a href="https://nodejs.org/api/querystring.html"><code>querystring</code></a> module as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">querystring</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;querystring&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;http://something.com/&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">querystring</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stringify</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;bar&#34;</span> <span style="color:#000;font-weight:bold">}));</span>
</code></pre></div><p>or <a href="https://nodejs.org/api/url.html#url_class_urlsearchparams">&lsquo;URLSearchParams&rsquo;</a> from <a href="https://nodejs.org/api/url.html">&lsquo;url module&rsquo;</a> as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">url</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;url&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">params</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">url</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">URLSearchParams</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;bar&#34;</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;http://something.com/&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">params</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">());</span>
</code></pre></div><p>You can also use the <a href="https://github.com/ljharb/qs"><code>qs</code></a> library.</p>
<blockquote>
<p>NOTE:
The <code>qs</code> library is preferable if you need to stringify nested objects, as the <code>querystring</code> method has <a href="https://github.com/nodejs/node-v0.x-archive/issues/1665">known issues</a> with that use case.</p>
</blockquote>
<h4 id="表单数据">表单数据</h4>
<h5 id="-自动序列化">🆕 自动序列化</h5>
<p>Starting from <code>v0.27.0</code>, Axios supports automatic object serialization to a FormData object if the request <code>Content-Type</code>
header is set to <code>multipart/form-data</code>.</p>
<p>The following request will submit the data in a FormData format (Browser &amp; Node.js):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">axios</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;axios&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000">axios</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">(</span>
    <span style="color:#4e9a06">&#34;https://httpbin.org/post&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">headers</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#4e9a06">&#34;Content-Type&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;multipart/form-data&#34;</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">data</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">));</span>
</code></pre></div><p>In the <code>node.js</code> build, the (<a href="https://github.com/form-data/form-data"><code>form-data</code></a>) polyfill is used by default.</p>
<p>You can overload the FormData class by setting the <code>env.FormData</code> config variable,
but you probably won&rsquo;t need it in most cases:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">axios</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;axios&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">FormData</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;form-data&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">axios</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">(</span>
    <span style="color:#4e9a06">&#34;https://httpbin.org/post&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">buf</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Buffer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">headers</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#4e9a06">&#34;Content-Type&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;multipart/form-data&#34;</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">data</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">));</span>
</code></pre></div><p>Axios FormData serializer supports some special endings to perform the following operations:</p>
<ul>
<li><code>{}</code> - serialize the value with JSON.stringify</li>
<li><code>[]</code> - unwrap the array like object as separate fields with the same key</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">axios</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;axios&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">axios</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">(</span>
    <span style="color:#4e9a06">&#34;https://httpbin.org/post&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#4e9a06">&#34;myObj{}&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;foo&#34;</span> <span style="color:#000;font-weight:bold">},</span>
      <span style="color:#4e9a06">&#34;files[]&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87">document</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">querySelector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;#fileInput&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">files</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">headers</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#4e9a06">&#34;Content-Type&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;multipart/form-data&#34;</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">data</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">));</span>
</code></pre></div><p>Axios supports the following shortcut methods: <code>postForm</code>, <code>putForm</code>, <code>patchForm</code>
which are just the corresponding http methods with a header preset: <code>Content-Type</code>: <code>multipart/form-data</code>.</p>
<p>FileList object can be passed directly:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postForm</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;https://httpbin.org/post&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">document</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">querySelector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;#fileInput&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">files</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>All files will be sent with the same field names: <code>files[]</code>;</p>
<h5 id="手动-formdata-传递">手动 FormData 传递</h5>
<p>In node.js, you can use the <a href="https://github.com/form-data/form-data"><code>form-data</code></a> library as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">FormData</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;form-data&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">form</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">FormData</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000">form</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;my_field&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;my value&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">form</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;my_buffer&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Buffer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">));</span>
<span style="color:#000">form</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;my_file&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createReadStream</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo/bar.jpg&#34;</span><span style="color:#000;font-weight:bold">));</span>

<span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;https://example.com&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">form</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><h2 id="semver">Semver</h2>
<p>Until axios reaches a <code>1.0</code> release, breaking changes will be released with a new minor version. For example <code>0.5.1</code>, and <code>0.5.4</code> will have the same API, but <code>0.6.0</code> will have breaking changes.</p>
<h2 id="promises">Promises</h2>
<p>axios depends on a native ES6 Promise implementation to be <a href="http://caniuse.com/promises">supported</a>.
If your environment doesn&rsquo;t support ES6 Promises, you can <a href="https://github.com/jakearchibald/es6-promise">polyfill</a>.</p>
<h2 id="typescript">TypeScript</h2>
<p>axios includes <a href="http://typescriptlang.org">TypeScript</a> definitions and a type guard for axios errors.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">user</span>: <span style="color:#204a87;font-weight:bold">User</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">data</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/user?ID=12345&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">userDetails</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isAxiosError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">handleAxiosError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">handleUnexpectedError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="在线一键设置">在线一键设置</h2>
<p>您可以使用 Gitpod 作为一个在线 IDE(对于开放源码是免费的)来在线贡献或运行示例。</p>
<p><a href="https://gitpod.io/#https://github.com/axios/axios/blob/master/examples/server.js"><img src="https://gitpod.io/button/open-in-gitpod.svg" alt="Open in Gitpod"></a></p>
<h2 id="资源">资源</h2>
<ul>
<li><a href="https://github.com/axios/axios/blob/master/CHANGELOG.md">Changelog</a></li>
<li><a href="https://github.com/axios/axios/blob/master/UPGRADE_GUIDE.md">Upgrade Guide</a></li>
<li><a href="https://github.com/axios/axios/blob/master/ECOSYSTEM.md">Ecosystem</a></li>
<li><a href="https://github.com/axios/axios/blob/master/CONTRIBUTING.md">Contributing Guide</a></li>
<li><a href="https://github.com/axios/axios/blob/master/CODE_OF_CONDUCT.md">Code of Conduct</a></li>
</ul>
<h2 id="功劳">功劳</h2>
<p>axios 很大程度上受到了<a href="https://angularjs.org/">AngularJS</a>中提供的<a href="https://docs.angularjs.org/api/ng/service/$http">$http 服务</a>的启发。
最终，axios 致力于提供一个独立的、类似于“$http”的服务，以便在 AngularJS 之外使用。</p>
<h2 id="证书">证书</h2>
<p><a href="LICENSE">MIT</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-dd26dd96b691f783eb7fff9d7bf21702">6.2 - @narando/nest-axios-interceptor</h1>
    
	<blockquote>
<p><a href="https://github.com/narando/nest-axios-interceptor">https://github.com/narando/nest-axios-interceptor</a></p>
</blockquote>
<p>为 NestJS <a href="https://docs.nestjs.com/techniques/http-module">HttpModule/HttpService</a>轻松构建和配置<a href="https://github.com/axios/axios#interceptors">axios 拦截器</a>。</p>
<p align="center">
    <a href="https://www.npmjs.com/package/@narando/nest-axios-interceptor" target="_blank"><img src="https://img.shields.io/npm/v/@narando/nest-axios-interceptor.svg" alt="NPM Version"/></a>
    <a href="https://www.npmjs.com/package/@narando/nest-axios-interceptor" target="_blank"><img src="https://img.shields.io/npm/l/@narando/nest-axios-interceptor.svg" alt="Package License"/></a>
    <a href="https://www.npmjs.com/package/@narando/nest-axios-interceptor" target="_blank"><img src="https://img.shields.io/npm/dm/@narando/nest-axios-interceptor.svg" alt="NPM Downloads"/></a>
    <a href="https://github.com/narando/nest-axios-interceptor/actions?query=workflow%3A%22CI%22" target="_blank"><img src="https://img.shields.io/github/workflow/status/narando/nest-axios-interceptor/CI/master" alt="Travis"/></a>
</p>
<h2 id="特性">特性</h2>
<ul>
<li>定义 axios 拦截器</li>
<li><code>HttpService.axiosRef</code> 上的注册拦截器</li>
<li>请求配置中自定义选项的类型安全处理</li>
</ul>
<h2 id="使用">使用</h2>
<blockquote>
<p>⚠️ 如果你想在 NestJS 版本 6 或 7 中使用@narando/nest-axios-interceptor，请使用 v1 版本。
v2 版本只兼容 NestJS Version 8 和@nestjs/axios 包。</p>
</blockquote>
<h3 id="安装">安装</h3>
<p>安装这个模块:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ npm i @narando/nest-axios-interceptor
</code></pre></div><h3 id="创建一个-axiosinterceptor">创建一个 <code>AxiosInterceptor</code></h3>
<p>创建一个新模块并导入 <code>HttpModule</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#8f5902;font-style:italic">// cats.module.ts
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">HttpModule</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">HttpService</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/axios&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Module</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">imports</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">HttpModule</span><span style="color:#000;font-weight:bold">],</span>
  <span style="color:#000">providers</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">HttpService</span><span style="color:#000;font-weight:bold">],</span>
<span style="color:#000;font-weight:bold">})</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">CatsModule</span> <span style="color:#000;font-weight:bold">{}</span>
</code></pre></div><p>用这个样板文件引导你的新拦截器:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#8f5902;font-style:italic">// logging.axios-interceptor.ts
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">HttpService</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/axios&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AxiosRequestConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">AxiosResponse</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;axios&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AxiosInterceptor</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">AxiosFulfilledInterceptor</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">AxiosRejectedInterceptor</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@narando/nest-axios-interceptor&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">LoggingAxiosInterceptor</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">AxiosInterceptor</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">httpService</span>: <span style="color:#204a87;font-weight:bold">HttpService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">super</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">httpService</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// requestFulfilled(): AxiosFulfilledInterceptor&lt;AxiosRequestConfig&gt; {}
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// requestRejected(): AxiosRejectedInterceptor {}
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// responseFulfilled(): AxiosFulfilledInterceptor&lt;AxiosResponse&gt; {}
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// responseRejected(): AxiosRejectedInterceptor {}
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>默认情况下，拦截器为所有 4 个可能的事件使用标识函数(no-op)。</p>
<p>要添加您的行为，覆盖您想要处理的事件的类方法，并返回一个将在拦截器中使用的函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#8f5902;font-style:italic">// logging.axios-interceptor.ts
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">LoggingAxiosInterceptor</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">AxiosInterceptor</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">httpService</span>: <span style="color:#204a87;font-weight:bold">HttpService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">super</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">httpService</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#000">requestFulfilled</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">AxiosFulfilledInterceptor</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">AxiosRequestConfig</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#8f5902;font-style:italic">// Log outgoing request
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`Request: </span><span style="color:#4e9a06">${</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">method</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> </span><span style="color:#4e9a06">${</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">path</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">);</span>

      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">};</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// requestRejected(): AxiosRejectedInterceptor {}
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// responseFulfilled(): AxiosFulfilledInterceptor&lt;AxiosResponse&gt; {}
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// responseRejected(): AxiosRejectedInterceptor {}
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h3 id="为请求配置设置自定义选项">为请求配置设置自定义选项</h3>
<p>如果你想把数据从一个拦截器传递到另一个拦截器，把它添加到请求配置对象中。</p>
<p>首先，定义新的请求配置类型。为了避免与其他拦截器的冲突，我们将定义一个 Symbol，并将其用作 object 的键:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#8f5902;font-style:italic">// logging.axios-interceptor.ts
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">LOGGING_CONFIG_KEY</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Symbol</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kLoggingAxiosInterceptor&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#8f5902;font-style:italic">// Merging our custom properties with the base config
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">LoggingConfig</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">AxiosRequestConfig</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">[</span><span style="color:#000">LOGGING_CONFIG_KEY</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">};</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>现在我们必须更新拦截器来使用这个新的配置:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">  // logging.axios-interceptor.ts
  @Injectable()
<span style="color:#a40000">- export class LoggingAxiosInterceptor extends AxiosInterceptor {
</span><span style="color:#a40000"></span><span style="color:#00a000">+ export class LoggingAxiosInterceptor extends AxiosInterceptor&lt;LoggingConfig&gt; {
</span><span style="color:#00a000"></span>    constructor(httpService: HttpService) {
      super(httpService);
    }

<span style="color:#a40000">-   requestFulfilled(): AxiosFulfilledInterceptor&lt;AxiosRequestConfig&gt; {
</span><span style="color:#a40000"></span><span style="color:#00a000">+   requestFulfilled(): AxiosFulfilledInterceptor&lt;LoggingConfig&gt; {
</span><span style="color:#00a000"></span>      return (config) =&gt; {
        // Log outgoing request
        console.log(`Request: ${config.method} ${config.path}`);

        return config;
      };
    }

    // requestRejected(): AxiosRejectedInterceptor {}
<span style="color:#a40000">-   // responseFulfilled(): AxiosFulfilledInterceptor&lt;AxiosResponse&gt; {}
</span><span style="color:#a40000"></span><span style="color:#00a000">+   // responseFulfilled(): AxiosFulfilledInterceptor&lt;AxiosResponseCustomConfig&lt;LoggingConfig&gt;&gt; {}
</span><span style="color:#00a000"></span>    // responseRejected(): AxiosRejectedInterceptor {}
  }
</code></pre></div><p>有了更新的类型，你现在可以使用扩展配置:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#8f5902;font-style:italic">// logging.axios-interceptor.ts
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">LOGGING_CONFIG_KEY</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Symbol</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kLoggingAxiosInterceptor&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">LoggingAxiosInterceptor</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">AxiosInterceptor</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">LoggingConfig</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">httpService</span>: <span style="color:#204a87;font-weight:bold">HttpService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">super</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">httpService</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#000">requestFulfilled</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">AxiosFulfilledInterceptor</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">LoggingConfig</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">requestId</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1234</span><span style="color:#000;font-weight:bold">;</span>

      <span style="color:#000">config</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">LOGGING_CONFIG_KEY</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">requestId</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000;font-weight:bold">};</span>
      <span style="color:#8f5902;font-style:italic">// Log outgoing request
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`Request(ID=</span><span style="color:#4e9a06">${</span><span style="color:#000">requestId</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">): </span><span style="color:#4e9a06">${</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">method</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> </span><span style="color:#4e9a06">${</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">path</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">);</span>

      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">};</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// requestRejected(): AxiosRejectedInterceptor {}
</span><span style="color:#8f5902;font-style:italic"></span>
  <span style="color:#000">responseFulfilled</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">AxiosFulfilledInterceptor</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">AxiosResponseCustomConfig</span><span style="color:#a40000">&lt;</span><span style="color:#c4a000">LoggingConfig</span><span style="color:#000;font-weight:bold">&gt;</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">requestId</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">LOGGING_CONFIG_KEY</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#8f5902;font-style:italic">// Log response
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`Response(ID=</span><span style="color:#4e9a06">${</span><span style="color:#000">requestId</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">): </span><span style="color:#4e9a06">${</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">status</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">);</span>

      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">response</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">};</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// responseRejected(): AxiosRejectedInterceptor {}
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h3 id="处理错误">处理错误</h3>
<p>默认情况下，axios error (rejected)拦截器传递类型为<code>any</code>的错误。这并不是很有用，因为我们不能用它做任何事情。</p>
<p>在内部， <code>axios</code> 将所有错误封装在一个自定义对象<code>AxiosError</code>中。我们可以使用类方法 <code>isAxiosError</code> 来断言传递的错误确实是 <code>AxiosError</code> 类型的，然后按我们想要的方式处理它:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#8f5902;font-style:italic">// logging.axios-interceptor.ts
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">LoggingAxiosInterceptor</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">AxiosInterceptor</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">httpService</span>: <span style="color:#204a87;font-weight:bold">HttpService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">super</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">httpService</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// requestFulfilled(): AxiosFulfilledInterceptor&lt;AxiosRequestConfig&gt; {}
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// requestRejected(): AxiosRejectedInterceptor {}
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// responseFulfilled(): AxiosFulfilledInterceptor&lt;AxiosResponse&gt; {}
</span><span style="color:#8f5902;font-style:italic"></span>
  <span style="color:#000">responseRejected</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">AxiosRejectedInterceptor</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isAxiosError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">response</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>

        <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`Error </span><span style="color:#4e9a06">${</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">status</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> in request &#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">method</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> </span><span style="color:#4e9a06">${</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">path</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Unexpected generic error&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span>

      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">};</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="许可证">许可证</h2>
<p>此存储库是在<a href="./License">MIT License</a>下发布的。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-bd61d63598630dbbb21d96e9ff9b7e80">6.3 - axios-auth-refresh</h1>
    
	<blockquote>
<p><a href="https://github.com/Flyrell/axios-auth-refresh">https://github.com/Flyrell/axios-auth-refresh</a></p>
</blockquote>
<p><img src="https://img.shields.io/npm/v/axios-auth-refresh?label=version" alt="Package version">
<img src="https://img.shields.io/bundlephobia/min/axios-auth-refresh" alt="Package size">
<img src="https://img.shields.io/npm/dm/axios-auth-refresh" alt="Package downloads">
<img src="https://img.shields.io/npm/types/axios-auth-refresh" alt="Package types definitions"></p>
<p>帮助您通过 axios <a href="https://github.com/axios/axios#interceptors">interceptors</a>实现自动刷新授权的库。
当原始请求失败时，您可以轻松地拦截它，刷新授权并继续原始请求，而不需要任何用户交互。</p>
<p>当请求由于授权而失败时，将发生什么完全取决于您。
您可以为新的授权令牌运行刷新调用，也可以运行自定义逻辑。</p>
<p>在等待新的授权令牌时，插件将暂停已进入的其他请求，并在新令牌可用时解析它们。</p>
<h2 id="安装">安装</h2>
<p>使用<a href="https://www.npmjs.com/get-npm">npm</a>或<a href="https://yarnpkg.com/en/docs/install">yarn</a>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">npm install axios-auth-refresh --save
<span style="color:#8f5902;font-style:italic"># or</span>
yarn add axios-auth-refresh
</code></pre></div><h2 id="语法">语法</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#000">createAuthRefreshInterceptor</span><span style="color:#000;font-weight:bold">(</span>
    <span style="color:#000">axios</span>: <span style="color:#204a87;font-weight:bold">AxiosInstance</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">refreshAuthLogic</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">failedRequest</span>: <span style="color:#204a87;font-weight:bold">any</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">any</span><span style="color:#000;font-weight:bold">&gt;,</span>
    <span style="color:#000">options</span>: <span style="color:#204a87;font-weight:bold">AxiosAuthRefreshOptions</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{}</span>
<span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><h4 id="参数">参数</h4>
<ul>
<li><code>axios</code> - Axios 的实例</li>
<li><code>refreshAuthLogic</code> - 一个用于刷新授权的函数(<strong>必须返回一个承诺</strong>)。
只接受一个参数，即原始调用返回的' failedRequest &lsquo;。</li>
<li><code>options</code> - 对象的拦截器设置(参见<a href="#available-options">可用选项</a>)</li>
</ul>
<h4 id="返回">返回</h4>
<p>拦截器<code>id</code>，以防你想手动拒绝它。</p>
<h2 id="使用">使用</h2>
<p>为了激活拦截器，您需要从<em>默认导出</em>的<code>axios-auth-refresh</code>导入一个函数，并使用想要拦截器的<strong>axios 实例</strong>调用它，以及需要编写刷新授权逻辑的<strong>刷新授权函数</strong>。</p>
<p>然后拦截器将被绑定到 axios 实例上，当从服务器(或您在选项中提供的任何其他状态代码)返回<a href="https://httpstatuses.com/401">401 (Unauthorized)</a>状态代码时，指定的逻辑就会运行。
在 refreshAuthLogic 处理期间创建的所有新请求都将被绑定到从 refreshAuthLogic 函数返回的 Promise 上。这意味着当获取新的访问令牌或刷新逻辑失败时，请求将得到解决。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">axios</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;axios&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">createAuthRefreshInterceptor</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;axios-auth-refresh&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">// Function that will be called to refresh authorization
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">refreshAuthLogic</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">failedRequest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span>
  <span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;https://www.example.com/auth/token/refresh&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">tokenRefreshResponse</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">localStorage</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">setItem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;token&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tokenRefreshResponse</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">token</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000">failedRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">headers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;Authorization&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;Bearer &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">tokenRefreshResponse</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">token</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resolve</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// Instantiate the interceptor
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">createAuthRefreshInterceptor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">refreshAuthLogic</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#8f5902;font-style:italic">// Make a call. If it returns a 401 error, the refreshAuthLogic will be run,
</span><span style="color:#8f5902;font-style:italic">// and the request retried with the new token
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;https://www.example.com/restricted/area&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#8f5902;font-style:italic">/* ... */</span><span style="color:#000;font-weight:bold">).</span><span style="color:#204a87;font-weight:bold">catch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#8f5902;font-style:italic">/* ... */</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><h4 id="跳过拦截器">跳过拦截器</h4>
<p>:warning: 由于错误<a href="https://github.com/axios/axios/issues/2295">axios#2295</a>不支持 v0.19.0。 :warning:</p>
<p>:white_check_mark: 这个问题已经修复，将在 axios v0.19.1 中发布</p>
<p>对于特定的调用，有可能跳过拦截器的逻辑。
要做到这一点，你需要为每个你不想拦截的请求传递<code>skipAuthRefresh</code>选项到请求配置。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;https://www.example.com/&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">skipAuthRefresh</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>如果你使用的是 TypeScript，你可以从<code>axios-auth-refresh</code>中导入自定义请求配置接口。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AxiosAuthRefreshRequestConfig</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;axios-auth-refresh&#34;</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><h4 id="请求拦截器">请求拦截器</h4>
<p>由于这个插件会在刷新令牌的同时自动停止其他请求，所以将请求逻辑<strong>包装在一个函数中</strong>是一个好主意，以确保暂停的请求使用了新获取的数据(比如令牌)。</p>
<p>发送令牌的示例:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#8f5902;font-style:italic">// Obtain the fresh token each time the function is called
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">getAccessToken</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">localStorage</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getItem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;token&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#8f5902;font-style:italic">// Use interceptor to inject the token to requests
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">interceptors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">use</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">headers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;Authorization&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">`Bearer </span><span style="color:#4e9a06">${</span><span style="color:#000">getAccessToken</span><span style="color:#000;font-weight:bold">()</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><h2 id="可用选项">可用选项</h2>
<h4 id="要拦截的状态代码">要拦截的状态代码</h4>
<p>您可以指定多个希望拦截器运行的状态代码。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">statusCodes</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">401</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">403</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#8f5902;font-style:italic">// default: [ 401 ]
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h4 id="自定义拦截逻辑">自定义拦截逻辑</h4>
<p>您可以指定多个希望拦截器运行的状态代码。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">shouldRefresh</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000">error</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">business_error_code</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#0000cf;font-weight:bold">100385</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h4 id="停止请求的重试实例">停止请求的重试实例</h4>
<p>您可以指定用于重试停止的请求的实例。
默认值为<code>undefined</code>，并使用传递给<code>createAuthRefreshInterceptor</code>函数的实例。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">retryInstance</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">someAxiosInstance</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// default: undefined
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h4 id="onretry-在发送停止的请求之前回调"><code>onRetry</code> 在发送停止的请求之前回调</h4>
<p>你可以指定<code>onRetry</code>回调，它将在每个暂停的请求被调用之前，使用请求配置对象调用。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">onRetry</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">requestConfig</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">({</span> <span style="color:#000;font-weight:bold">...</span><span style="color:#000">requestConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">baseURL</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// default: undefined
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h4 id="在刷新逻辑运行时暂停实例">在“刷新逻辑”运行时暂停实例</h4>
<p>当您的刷新逻辑运行时，拦截器将为每个返回指定的<code>options.statusCodes</code>之一的请求(默认为 HTTP 401)触发。</p>
<p>为了防止拦截器循环(当你的刷新逻辑由于<code>options.statusCodes</code>中指定的任何状态代码而失败时)，你需要在<code>refreshAuthLogic</code>函数内的刷新调用中使用<a href="#skip-the-interceptor"><code>skipAuthRefresh</code></a>标志。</p>
<p>如果您的刷新逻辑不进行任何调用，您应该考虑在初始化拦截器时使用以下标志，以便在刷新挂起时暂停整个 axios 实例。
这将防止拦截器对每个失败的请求运行。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">pauseInstanceWhileRefreshing</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// default: false
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h4 id="拦截网络错误">拦截网络错误</h4>
<p>当返回一个 HTTP 401 Unauthorized 响应时，一些 CORS api 可能不会返回 CORS 响应头。
在这种情况下，浏览器将无法读取响应头来确定响应状态代码。</p>
<p>要拦截<em>any</em>网络错误，启用<code>interceptNetworkError</code>选项。</p>
<p>CAUTION: 这应该作为最后的手段。如果此方法用于处理带有 HTTP 401 响应的不支持 CORS 的 API，则重试逻辑可以测试尝试刷新身份验证的网络连通性。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">interceptNetworkError</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// default: undefined
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h3 id="库的其他用途">库的其他用途</h3>
<p>这个库还被用于:</p>
<ul>
<li>自动请求节流<a href="https://github.com/amcsi">@amcsi</a></li>
<li>Google2FA 的 OTP 挑战<a href="https://github.com/LeoniePhiline">@LeoniePhiline</a></li>
</ul>
<p>你把它用在别的地方了吗?用你的用例创建一个公共关系来分享它。</p>
<hr>
<h3 id="更新日志">更新日志</h3>
<ul>
<li>
<p><strong>v3.1.0</strong></p>
<ul>
<li>axios v0.21.1 支持</li>
<li><code>interceptNetworkError</code> . See <a href="https://github.com/Flyrell/axios-auth-refresh/issues/133">#133</a>.</li>
</ul>
</li>
<li>
<p><strong>v3.0.0</strong></p>
<ul>
<li><code>skipWhileRefresh</code> flag has been deprecated due to its unclear name and its logic has been moved to <code>pauseInstanceWhileRefreshing</code> flag</li>
<li><code>pauseInstanceWhileRefreshing</code> is set to <code>false</code> by default</li>
</ul>
</li>
</ul>
<hr>
<h4 id="想要帮助吗">想要帮助吗?</h4>
<p>查看<a href="CONTRIBUTING.md">贡献指南</a>或我的<a href="https://www.patreon.com/dawidzbinski">patreon page!</a></p>
<hr>
<h4 id="特别感谢jetbrainshttpswwwjetbrainscomfromaxios-auth-refresh为我们的库提供了-ide">特别感谢<a href="https://www.jetbrains.com/?from=axios-auth-refresh">JetBrains</a>为我们的库提供了 IDE</h4>
<p><a href="https://www.jetbrains.com/?from=axios-auth-refresh" title="Link to JetBrains"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/1a/JetBrains_Logo_2016.svg/128px-JetBrains_Logo_2016.svg.png" alt="JetBrains"></a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ac7867d0efde557b312fc601141a570b">6.4 - `node-cache-manager` - 灵活的NodeJS缓存模块</h1>
    
	<blockquote>
<p><a href="https://github.com/BryanDonovan/node-cache-manager">https://github.com/BryanDonovan/node-cache-manager</a></p>
</blockquote>
<p><a href="http://travis-ci.org/BryanDonovan/node-cache-manager"><img src="https://secure.travis-ci.org/BryanDonovan/node-cache-manager.svg" alt="build status"></a>
<a href="https://coveralls.io/r/BryanDonovan/node-cache-manager?branch=master"><img src="https://coveralls.io/repos/BryanDonovan/node-cache-manager/badge.svg?branch=master" alt="Coverage Status"></a></p>
<p>一个用于 nodejs 的缓存模块，允许在缓存、分级缓存和一致的接口中轻松包装函数。</p>
<h2 id="特性">特性</h2>
<ul>
<li>在缓存中包装任何函数的简单方法。</li>
<li>分级缓存——数据存储在每个缓存中，并首先从最高优先级的缓存中获取。</li>
<li>使用任何你想要的缓存，只要它有相同的 API。</li>
<li>通过<a href="https://github.com/visionmedia/mocha">mocha</a>， <a href="https://github.com/yahoo/istanbul">istanbul</a>和<a href="http://sinonjs.org">sinon</a>实现 100%的测试覆盖率。</li>
</ul>
<h2 id="expressjs-例子">Express.js 例子</h2>
<p>参见<a href="https://github.com/BryanDonovan/node-cache-manager-express-example">Express.js cache-manager 示例应用</a>了解如何在你的应用中使用 <code>node-cache-manager</code>。</p>
<h2 id="安装">安装</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">npm install cache-manager
</code></pre></div><h2 id="存储引擎">存储引擎</h2>
<ul>
<li>
<p><a href="https://github.com/dial-once/node-cache-manager-redis">node-cache-manager-redis</a> (uses <a href="https://github.com/joshuah/sol-redis-pool">sol-redis-pool</a>)</p>
</li>
<li>
<p><a href="https://github.com/dabroek/node-cache-manager-redis-store">node-cache-manager-redis-store</a> (uses <a href="https://github.com/NodeRedis/node_redis">node_redis</a>)</p>
</li>
<li>
<p><a href="https://github.com/dabroek/node-cache-manager-ioredis">node-cache-manager-ioredis</a> (uses <a href="https://github.com/luin/ioredis">ioredis</a>)</p>
</li>
<li>
<p><a href="https://github.com/v4l3r10/node-cache-manager-mongodb">node-cache-manager-mongodb</a></p>
</li>
<li>
<p><a href="https://github.com/disjunction/node-cache-manager-mongoose">node-cache-manager-mongoose</a></p>
</li>
<li>
<p><a href="https://github.com/sheershoff/node-cache-manager-fs-binary">node-cache-manager-fs-binary</a></p>
</li>
<li>
<p><a href="https://github.com/rolandstarke/node-cache-manager-fs-hash">node-cache-manager-fs-hash</a></p>
</li>
<li>
<p><a href="https://github.com/marudor/node-cache-manager-hazelcast">node-cache-manager-hazelcast</a></p>
</li>
<li>
<p><a href="https://github.com/theogravity/node-cache-manager-memcached-store">node-cache-manager-memcached-store</a></p>
</li>
<li>
<p><a href="https://github.com/theogravity/node-cache-manager-memory-store">node-cache-manager-memory-store</a></p>
</li>
<li>
<p><a href="https://github.com/davidepellegatta/node-cache-manager-couchbase">node-cache-manager-couchbase</a></p>
</li>
</ul>
<h2 id="概述">概述</h2>
<h3 id="wrap-函数"><code>wrap</code> 函数</h3>
<p><strong>首先</strong>，它包含一个 <code>wrap</code> 函数，可以让你在缓存中包装任何函数。
(注意，这是受到<a href="https://github.com/mape/node-caching">node-caching</a>的启发。)
这可能就是您正在寻找的功能。举个例子，你可能需要这样做:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">getCachedUser</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">memoryCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#000">getUser</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000">memoryCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>&hellip; 你可以使用<code>wrap</code>函数:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">getCachedUser</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">memoryCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">wrap</span><span style="color:#000;font-weight:bold">(</span>
    <span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cacheCallback</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">getUser</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cacheCallback</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ttl</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">ttl</span> <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000">cb</span>
  <span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h3 id="内存缓存">内存缓存</h3>
<p><strong>第二</strong>，<code>node-cache-manager</code> 具有内置的内存缓存(使用<a href="https://github.com/isaacs/node-lru-cache">node-lru-cache</a>)，与你期望在大多数缓存中的标准函数:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua">    <span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">val</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">ttl</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">ttl</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">//</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">see</span> <span style="color:#000">note</span> <span style="color:#000">below</span>
    <span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000">del</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000">mset</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">val1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">val2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">ttl</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">ttl</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">//</span> <span style="color:#000">set</span> <span style="color:#000">several</span> <span style="color:#000">keys</span> <span style="color:#000">at</span> <span style="color:#000">once</span>
    <span style="color:#000">mget</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">//</span> <span style="color:#000">get</span> <span style="color:#000">several</span> <span style="color:#000">keys</span> <span style="color:#000">at</span> <span style="color:#000">once</span>
    <span style="color:#ce5c00;font-weight:bold">//</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">Note</span> <span style="color:#000">that</span> <span style="color:#000">depending</span> <span style="color:#000">on</span> <span style="color:#000">the</span> <span style="color:#000">underlying</span> <span style="color:#000">store</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">you</span> <span style="color:#000">may</span> <span style="color:#000">be</span> <span style="color:#000">able</span> <span style="color:#000">to</span> <span style="color:#000">pass</span> <span style="color:#000">the</span>
    <span style="color:#ce5c00;font-weight:bold">//</span> <span style="color:#000">ttl</span> <span style="color:#000">as</span> <span style="color:#000">the</span> <span style="color:#000">third</span> <span style="color:#000">param</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">like</span> <span style="color:#000">this</span><span style="color:#000;font-weight:bold">:</span>
    <span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">val</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ttl</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#ce5c00;font-weight:bold">//</span> <span style="color:#000;font-weight:bold">...</span> <span style="color:#204a87;font-weight:bold">or</span> <span style="color:#000">pass</span> <span style="color:#000">no</span> <span style="color:#000">ttl</span> <span style="color:#000">at</span> <span style="color:#000">all</span><span style="color:#000;font-weight:bold">:</span>
    <span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">val</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">)</span>
</code></pre></div><h3 id="分级缓存">分级缓存</h3>
<p><strong>第三</strong>，<code>node-cache-manager</code> 允许你设置分级缓存策略。
在大多数情况下，这可能是有限的使用，但想象一下这样一个场景:你期望大量的流量，并不想每次请求都冲击你的主缓存(如 Redis)。
您决定将最常见的请求数据存储在内存缓存中，可能具有非常短的超时时间和/或较小的数据大小限制。
但你还是想把数据存储在 Redis 中，以备备份，以及处理那些不像你想存储在内存中的请求那样常见的请求。
这是 <code>node-cache-manager</code> 可以轻松且透明地处理的。</p>
<h3 id="设置多个键">设置多个键</h3>
<p><strong>第四</strong>，它允许你获得和设置多个键，一次为缓存存储，支持它。
这意味着当获得多个键时，它将从最高优先级的开始通过不同的缓存(见下面的多存储)，并合并它在每个级别上找到的值。</p>
<h2 id="用法示例">用法示例</h2>
<p>参见下面的示例和示例目录中的示例。
参见 <code>examples/redis_example</code> ，了解如何使用连接池实现 Redis 缓存存储。</p>
<h3 id="单一的存储">单一的存储</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">cacheManager</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;cache-manager&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">memoryCache</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cacheManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">caching</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">store</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;memory&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">max</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ttl</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">10</span> <span style="color:#8f5902;font-style:italic">/*seconds*/</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">ttl</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#8f5902;font-style:italic">// Note: callback is optional in set() and del().
</span><span style="color:#8f5902;font-style:italic">// Note: memory cache clones values before setting them unless `shouldCloneBeforeSet` is set to false
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#000">memoryCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ttl</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">ttl</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#000">memoryCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#8f5902;font-style:italic">// &gt;&gt; &#39;bar&#39;
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">memoryCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">del</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{});</span>
  <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">getUser</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">setTimeout</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Returning user from slow database.&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Bob&#34;</span> <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000;font-weight:bold">},</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">userId</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">123</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;user_&#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">userId</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">// Note: ttl is optional in wrap()
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">memoryCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">wrap</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">getUser</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ttl</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">ttl</span> <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">);</span>

    <span style="color:#8f5902;font-style:italic">// Second time fetches user from memoryCache
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">memoryCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">wrap</span><span style="color:#000;font-weight:bold">(</span>
      <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">getUser</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">},</span>
      <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">);</span>

<span style="color:#8f5902;font-style:italic">// Outputs:
</span><span style="color:#8f5902;font-style:italic">// Returning user from slow database.
</span><span style="color:#8f5902;font-style:italic">// { id: 123, name: &#39;Bob&#39; }
</span><span style="color:#8f5902;font-style:italic">// { id: 123, name: &#39;Bob&#39; }
</span></code></pre></div><p><code>ttl</code> 也可以通过传入一个函数来动态计算。例如,</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">opts</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">ttl</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0.1</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0.5</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">};</span>

<span style="color:#000">memoryCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">wrap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">getUser</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">},</span> <span style="color:#000">opts</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>你可以一次拿几个键。
请注意，这将返回它在缓存中找到的任何记录，由用户根据所提供的键检查结果，并调用底层数据存储来填充缺失的记录。
在实践中，如果你只是使用<code>wrap</code>函数在缓存中设置这些记录，这应该不是一个大问题。</p>
<blockquote>
<p>附注: 理想情况下， <code>wrap</code> 函数将从缓存中获得它所能得到的，并从数据存储中填充缺失的记录，但我无法想到一种适用于所有情况的方法来做到这一点。
另一种选择是，如果找到了所有记录，则只返回缓存中的数据，但这将破坏多缓存。</p>
</blockquote>
<p>更多信息请参见<code>caching.unit.js</code>中的单元测试。</p>
<p>例子:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">key1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;user_1&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">key2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;user_1&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000">memoryCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">wrap</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#000">key1</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">key2</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">getManyUser</span><span style="color:#000;font-weight:bold">([</span><span style="color:#000">key1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key2</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">users</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">users</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]);</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">users</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">);</span>
</code></pre></div><h4 id="使用-mset和-mget设置获取几个键的示例">使用 mset()和 mget()设置/获取几个键的示例</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000">memoryCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mset</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;foo2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ttl</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">ttl</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#000">memoryCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mget</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;foo2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#8f5902;font-style:italic">// &gt;&gt; [&#39;bar&#39;, &#39;bar2&#39;]
</span><span style="color:#8f5902;font-style:italic"></span>
    <span style="color:#8f5902;font-style:italic">// Delete keys with del() passing arguments...
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">memoryCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">del</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;foo2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{});</span>

    <span style="color:#8f5902;font-style:italic">// ...passing an Array of keys
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">memoryCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">del</span><span style="color:#000;font-weight:bold">([</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;foo2&#34;</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{});</span>
  <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><h4 id="例子中使用的承诺">例子中使用的承诺</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000">memoryCache</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">wrap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">getUserPromise</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;User:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>如果您使用的 Node 版本不包括本机承诺，您可以在传递给缓存模块的选项中指定承诺依赖项。例如,</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#204a87">Promise</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;es6-promise&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">cache</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">caching</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">store</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">store</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">promiseDependency</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87">Promise</span> <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><h4 id="使用异步等待示例">使用异步/等待示例</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">memoryCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">wrap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">getUserPromise</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// error handling
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p>提示:应该用<code>try</code> - <code>catch</code>封装<code>await</code>调用来处理<code>promise</code>错误。</p>
</blockquote>
<h4 id="express-应用使用示例">Express 应用使用示例</h4>
<p>(参见<a href="https://github.com/BryanDonovan/node-cache-manager-express-example">Express.js 缓存管理器示例应用</a>).</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">respond</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">json</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">500</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">json</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo/bar&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">res</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">cacheKey</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;foo-bar:&#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">JSON</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stringify</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">query</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">ttl</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">memoryCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">wrap</span><span style="color:#000;font-weight:bold">(</span>
    <span style="color:#000">cacheKey</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cacheCallback</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">DB</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">find</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">query</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cacheCallback</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ttl</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">ttl</span> <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">respond</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><h4 id="定制店">定制店</h4>
<p>你可以通过创建一个与内置内存存储相同的 API(如 redis 或 memcached 存储)来使用自己的自定义存储。
要使用自己的存储，只需传入它的一个实例。</p>
<p>E.g.,</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">myStore</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;your-homemade-store&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">cache</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cacheManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">caching</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">store</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">myStore</span> <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><h3 id="multi-store">Multi-Store</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">multiCache</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cacheManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">multiCaching</span><span style="color:#000;font-weight:bold">([</span><span style="color:#000">memoryCache</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">someOtherCache</span><span style="color:#000;font-weight:bold">]);</span>
<span style="color:#000">userId2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">456</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">key2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;user_&#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">userId</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">ttl</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">// Sets in all caches.
</span><span style="color:#8f5902;font-style:italic">// The &#34;ttl&#34; option can also be a function (see example below)
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">multiCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ttl</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">ttl</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// Fetches from highest priority cache that has the key.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">multiCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#8f5902;font-style:italic">// &gt;&gt; &#39;bar2&#39;
</span><span style="color:#8f5902;font-style:italic"></span>
    <span style="color:#8f5902;font-style:italic">// Delete from all caches
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">multiCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">del</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo2&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// Set the ttl value by context depending on the store.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">getTTL</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">store</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">store</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;redis&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">6000</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">3000</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#8f5902;font-style:italic">// Sets multiple keys in all caches.
</span><span style="color:#8f5902;font-style:italic">// You can pass as many key,value pair as you want
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">multiCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mset</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;key&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;value&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;key2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;value2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ttl</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">getTTL</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// mget() fetches from highest priority cache.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// If the first cache does not return all the keys,
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// the next cache is fetched with the keys that were not found.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// This is done recursively until either:
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// - all have been found
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// - all caches has been fetched
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">multiCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mget</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;key&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;key2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]);</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]);</span>
    <span style="color:#8f5902;font-style:italic">// &gt;&gt; &#39;bar2&#39;
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// &gt;&gt; &#39;bar3&#39;
</span><span style="color:#8f5902;font-style:italic"></span>
    <span style="color:#8f5902;font-style:italic">// Delete from all caches
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">multiCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">del</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;key&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;key2&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#8f5902;font-style:italic">// ...or with an Array
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">multiCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">del</span><span style="color:#000;font-weight:bold">([</span><span style="color:#4e9a06">&#34;key&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;key2&#34;</span><span style="color:#000;font-weight:bold">]);</span>
  <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// Note: options with ttl are optional in wrap()
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">multiCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">wrap</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#000">key2</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">getUser</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ttl</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">ttl</span> <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">);</span>

    <span style="color:#8f5902;font-style:italic">// Second time fetches user from memoryCache, since it&#39;s highest priority.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// If the data expires in the memory cache, the next fetch would pull it from
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// the &#39;someOtherCache&#39;, and set the data in memory again.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">multiCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">wrap</span><span style="color:#000;font-weight:bold">(</span>
      <span style="color:#000">key2</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">getUser</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">},</span>
      <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">);</span>

<span style="color:#8f5902;font-style:italic">// Multiple keys
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">multiCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">wrap</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#4e9a06">&#34;key1&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#4e9a06">&#34;key2&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">getManyUser</span><span style="color:#000;font-weight:bold">([</span><span style="color:#4e9a06">&#34;key1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;key2&#34;</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ttl</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">ttl</span> <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">users</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">users</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]);</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">users</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">);</span>
</code></pre></div><h3 id="指定在wrap函数中缓存什么">指定在<code>wrap</code>函数中缓存什么</h3>
<p><code>caching</code>和<code>multicaching</code>模块都允许你传入一个名为<code>isCacheableValue</code>的回调函数，<code>wrap</code>函数会根据从缓存或包装函数返回的每个值来调用这个回调函数。
这让你可以通过<code>wrap</code>来指定哪些值应该缓存，哪些值不应该缓存。
如果函数返回 <code>true</code> ，它将被存储在缓存中。
默认情况下，缓存会缓存除<code>undefined</code>之外的所有内容。</p>
<blockquote>
<p>注意:<code>caching</code>和<code>multicaching</code>中的<code>set</code>函数不使用<code>isCacheableValue</code>。</p>
</blockquote>
<p>例如，如果你不想缓存<code>false</code>和<code>null</code>，你可以像这样传入一个函数:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">isCacheableValue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">!==</span> <span style="color:#204a87;font-weight:bold">null</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">!==</span> <span style="color:#204a87;font-weight:bold">false</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">!==</span> <span style="color:#204a87;font-weight:bold">undefined</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">};</span>
</code></pre></div><p>然后像这样将它传递给' caching &lsquo;:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">memoryCache</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cacheManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">caching</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">store</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;memory&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">isCacheableValue</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">isCacheableValue</span> <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>然后像这样将它传递给“multicaching”:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">multiCache</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cacheManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">multiCaching</span><span style="color:#000;font-weight:bold">([</span><span style="color:#000">memoryCache</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">someOtherCache</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">isCacheableValue</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">isCacheableValue</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><h3 id="在后台刷新缓存键">在后台刷新缓存键</h3>
<p><code>caching</code>和<code>multicaching</code>模块都支持在使用<code>wrap</code>函数时在后台刷新过期缓存键的机制。
这可以通过在创建缓存存储时添加“refreshThreshold”属性来实现。</p>
<p>如果设置了<code>refreshThreshold</code>并且<code>ttl</code>方法对已用存储区可用，则从缓存中获取一个值后将检查 <code>ttl</code> 。
如果剩余的 <code>TTL</code> 小于<code>refreshThreshold</code>，系统将生成一个后台 worker 来更新该值，遵循与标准抓取相同的规则。
同时，系统将返回旧值，直到过期。</p>
<p>在多缓存的情况下，用于刷新的存储区是首先找到键的存储区(优先级最高)。
然后将在所有存储中设置该值。</p>
<p>NOTES:</p>
<ul>
<li>在多缓存的情况下，将被检查刷新的存储是一个键将被首先找到(最高优先级)。</li>
<li>如果阈值很低，工作函数很慢，键可能会过期，你可能会遇到一个更新值的竞赛条件。</li>
<li>后台刷新机制目前不支持提供多键 <code>wrap</code> 功能。</li>
<li>缓存存储需要提供<code>ttl</code>方法。</li>
</ul>
<p>例如，像这样将 <code>refreshThreshold</code> 传递给<code>caching</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">redisStore</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;cache-manager-ioredis&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">redisCache</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cacheManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">caching</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">store</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">redisStore</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">refreshThreshold</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">isCacheableValue</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">isCacheableValue</span> <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>当从 Redis 中检索到一个剩余 TTL &lt; 3sec 的值时，该值将在后台更新。</p>
<h3 id="开发环境">开发环境</h3>
<p>你可以禁用真正的缓存，但仍然可以通过设置“none”存储来实现所有的回调功能。</p>
<h2 id="文档">文档</h2>
<p>生成 JSDOC 3 文档:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">make docs
</code></pre></div><h2 id="测试">测试</h2>
<p>要运行测试，请首先运行:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">npm install -d
</code></pre></div><p>运行测试和 JShint:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">make
</code></pre></div><h2 id="贡献">贡献</h2>
<p>如果你想为项目做出贡献，请分叉它，并向我们发送一个拉请求。
请为任何新功能或 bug 修复添加测试。
同样在提交 pull 请求之前运行&rsquo; make &lsquo;。</p>
<h2 id="许可证">许可证</h2>
<p><code>node-cache-manager</code> 是在 <code>MIT</code> 许可证下授权的。</p>

</div>



    
	
  

    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="User mailing list" aria-label="User mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/mail" aria-label="User mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/twitter" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Stack Overflow" aria-label="Stack Overflow">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/stack" aria-label="Stack Overflow">
      <i class="fab fa-stack-overflow"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/google/docsy" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/slack" aria-label="Slack">
      <i class="fab fa-slack"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Developer mailing list" aria-label="Developer mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/mail" aria-label="Developer mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2022 kamilmysliwiec 保留所有权利</small>
        <small class="ml-1"><a href="https://kamilmysliwiec.com/" target="_blank" rel="noopener">隐私政策</a></small>
	
		
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='/nestjs-docs/js/tabpane-persist.js'></script>


















<script src="/nestjs-docs/js/main.min.5f8acc65da891d70878ed44429f6a9dd7fab27a5cf9a7ceaa139c4059e89cfdc.js" integrity="sha256-X4rMZdqJHXCHjtREKfap3X&#43;rJ6XPmnzqoTnEBZ6Jz9w=" crossorigin="anonymous"></script>




  </body>
</html>
