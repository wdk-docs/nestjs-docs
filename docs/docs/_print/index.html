<!doctype html>
<html lang="zh-cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.97.3" />
<link rel="canonical" type="text/html" href="https://wdk-docs.github.io/nestjs-docs/docs/">
<link rel="alternate" type="application/rss&#43;xml" href="https://wdk-docs.github.io/nestjs-docs/docs/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/nestjs-docs/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/nestjs-docs/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/nestjs-docs/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/nestjs-docs/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/nestjs-docs/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/nestjs-docs/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/nestjs-docs/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/nestjs-docs/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/nestjs-docs/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/nestjs-docs/favicons/android-192x192.png" sizes="192x192">

<title>文档 | NestJS 文档</title>
<meta name="description" content="
https://wanago.io/courses/api-with-nestjs/


控制器、路由和模块结构
用 TypeORM 建立一个 PostgreSQL 数据库
使用 bcrypt、Passport、JWT 和 cookie 对用户进行身份验证
错误处理和数据验证
用拦截器序列化响应
 …">
<meta property="og:title" content="文档" />
<meta property="og:description" content="NestJs 文档" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://wdk-docs.github.io/nestjs-docs/docs/" /><meta property="og:site_name" content="NestJS 文档" />

<meta itemprop="name" content="文档">
<meta itemprop="description" content="NestJs 文档"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="文档"/>
<meta name="twitter:description" content="NestJs 文档"/>




<link rel="preload" href="/nestjs-docs/scss/main.min.90983698afafd407e6b72e83a2b749ff1726e8502277108f05bd66510938dec2.css" as="style">
<link href="/nestjs-docs/scss/main.min.90983698afafd407e6b72e83a2b749ff1726e8502277108f05bd66510938dec2.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK"
  crossorigin="anonymous"></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-00000000-0', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/nestjs-docs/">
		<span class="navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="font-weight-bold">NestJS 文档</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="/nestjs-docs/docs/" ><span class="active">文档</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/nestjs-docs/blog/" ><span>博客</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"><input type="search" class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label="站内搜索…" autocomplete="off">
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href="#" onclick="print();return false;">点击此处打印</a>.
</p><p>
<a href="/nestjs-docs/docs/">返回本页常规视图</a>.
</p>
</div>



<h1 class="title">文档</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-7f305cdec2ded6dc7422877b33cadd3a">validator</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>1.1: <a href="#pg-fef1bcec9e28d82005af68a6958d6cba">class-validator</a></li>


    
  
    
    
	
<li>1.2: <a href="#pg-dc8d9bde5ab50bdea8564d5e73547fd5">class-transformer</a></li>


    
  

    </ul>
    
  
    
    
	
<li>2: <a href="#pg-90df5218158c4d01fc01a3fa3bcb9ad2">mongodb</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>2.1: <a href="#pg-01b5b2f53d9dc7fe8db92e39696e08bb">MongoDB与Mongoose使用PUT vs PATCH</a></li>


    
  
    
    
	
<li>2.2: <a href="#pg-ee82b5a9ba57222a5fbfd0b80a49cfa9">MongoDB概论</a></li>


    
  
    
    
	
<li>2.3: <a href="#pg-dcc33887b60b5620de8e60d4faae18bc">实现与MongoDB的关系</a></li>


    
  
    
    
	
<li>2.4: <a href="#pg-4451ab685262406c61d37462ff2cf30c">MongoDB和Mongoose的虚拟属性</a></li>


    
  
    
    
	
<li>2.5: <a href="#pg-d6a0d2e2730441d8a1bbcc80b1877247">与MongoDB和Mongoose管理事务</a></li>


    
  
    
    
	
<li>2.6: <a href="#pg-9dafda6a3ad4a457c936f5058f3f4460">使用MongoDB和Mongoose实现分页</a></li>


    
  
    
    
	
<li>2.7: <a href="#pg-9fc52bf385551b755df4c394152ea50c">使用MongoDB和Mongoose定义索引</a></li>


    
  
    
    
	
<li>2.8: <a href="#pg-87745293d49493ba2db7754c111a3568">用PUT和PATCH更新MongoDB和Mongoose</a></li>


    
  

    </ul>
    
  
    
    
	
<li>3: <a href="#pg-b64b7e1b4aa2d437b41e6919a564206e">files</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.1: <a href="#pg-a5ce0f5e673a67cd6c90e83f6e52b6e1">Uploading files to the server</a></li>


    
  

    </ul>
    
  
    
    
	
<li>4: <a href="#pg-c709471c70f27c6bb15b128d75977220">http</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>4.1: <a href="#pg-42a26675b19acc37e7dbc0e2c8d454d2">axios</a></li>


    
  
    
    
	
<li>4.2: <a href="#pg-dd26dd96b691f783eb7fff9d7bf21702">@narando/nest-axios-interceptor</a></li>


    
  
    
    
	
<li>4.3: <a href="#pg-bd61d63598630dbbb21d96e9ff9b7e80">axios-auth-refresh</a></li>


    
  
    
    
	
<li>4.4: <a href="#pg-521bdc42e36a3e9034f654fddd1b3aa2">错误处理和数据验证</a></li>


    
  
    
    
	
<li>4.5: <a href="#pg-ac7867d0efde557b312fc601141a570b">node-cache-manager - 灵活的NodeJS缓存模块</a></li>


    
  
    
    
	
<li>4.6: <a href="#pg-08ab14ce67216c8fad409a2cd3c71ef6">用webhook对Stripe事件做出反应</a></li>


    
  

    </ul>
    
  
    
    
	
<li>5: <a href="#pg-b80c626cd4fc7152e0fe4830e68b5d80">logs</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>5.1: <a href="#pg-d97193c8d36b121e97575fff2ca94e4e">介绍使用内置记录器和TypeORM进行日志记录</a></li>


    
  

    </ul>
    
  
    
    
	
<li>6: <a href="#pg-d7ec5a6830ec344ca6306585c35ffdcf">队列</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>6.1: <a href="#pg-0434ba7f30f49cc3172e991b753c1e82">bull</a></li>


    
  
    
    
	
<li>6.2: <a href="#pg-f5431b111661b3529e1ee10738caa3ad">指南</a></li>


    
  
    
    
	
<li>6.3: <a href="#pg-b2b86a8b70578d701ade6f6cd94fede2">参考</a></li>


    
  
    
    
	
<li>6.4: <a href="#pg-ad94521a760596fc6e71a48e245b8ae8">模式</a></li>


    
  

    </ul>
    
  
    
    
	
<li>7: <a href="#pg-435587bcc45d824e4ef8cc4a14b58ca4">OpenAPI-swagger</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>7.1: <a href="#pg-ded90509c1cc7827e36c53eac5c262b5">OpenAPI规范和Swagger</a></li>


    
  

    </ul>
    
  
    
    
	
<li>8: <a href="#pg-72a7b9da75676e436dce77dd4f1befe5">awesome</a></li>


    
  

    </ul>


<div class="content">
      <blockquote>
<p><a href="https://wanago.io/courses/api-with-nestjs/">https://wanago.io/courses/api-with-nestjs/</a></p>
</blockquote>
<ol>
<li>控制器、路由和模块结构</li>
<li>用 TypeORM 建立一个 PostgreSQL 数据库</li>
<li>使用 bcrypt、Passport、JWT 和 cookie 对用户进行身份验证</li>
<li>错误处理和数据验证</li>
<li>用拦截器序列化响应</li>
<li>研究依赖注入和模块</li>
<li>创建与 Postgres 和 TypeORM 的关系</li>
<li>编写单元测试</li>
<li>使用集成测试测试服务和控制器</li>
<li>上传公共文件到 Amazon S3</li>
<li>使用 Amazon S3 管理私有文件</li>
<li>介绍 Elasticsearch</li>
<li>使用 JWT 实现刷新令牌</li>
<li>使用索引提高 Postgres 数据库的性能</li>
<li>用 PostgreSQL 和 TypeORM 定义事务</li>
<li>使用数组数据类型与 PostgreSQL 和 TypeORM</li>
<li>使用 PostgreSQL 和 TypeORM 进行偏移和键集分页</li>
<li>探索微服务的理念</li>
<li>使用 RabbitMQ 与微服务通信</li>
<li>使用 gRPC 框架与微服务通信</li>
<li>CQRS 的介绍</li>
<li>用 PostgreSQL 和 TypeORM 存储 JSON</li>
<li>实现内存缓存以提高性能</li>
<li>缓存与复述。在 Node.js 集群中运行应用</li>
<li>使用 cron 和 Nodemailer 发送预定的电子邮件</li>
<li>与 WebSockets 的实时聊天</li>
<li>GraphQL 概论。查询、修改和身份验证</li>
<li>处理 GraphQL 中的 N + 1 问题</li>
<li>使用 GraphQL 订阅实现实时更新</li>
<li>GraphQL 中的标量类型</li>
<li>双因素身份验证</li>
<li>介绍 Prisma 与 PostgreSQL</li>
<li>管理 PostgreSQL 与 Prisma 的关系</li>
<li>使用队列处理 cpu 密集型任务</li>
<li>使用服务器端会话而不是 JSON Web 令牌</li>
<li>介绍带 React 的条纹</li>
<li>使用 Stripe 保存信用卡以备将来使用</li>
<li>通过订阅设置分期付款</li>
<li>用 webhook 对 Stripe 事件做出反应</li>
<li>确认邮箱地址</li>
<li>验证电话号码和发送短信与 Twilio</li>
<li>使用谷歌对用户进行认证</li>
<li>MongoDB 概论</li>
<li>与 MongoDB 实现关系</li>
<li>MongoDB 和 Mongoose 的虚拟财产</li>
<li>MongoDB 和 Mongoose 管理事务</li>
<li>用 MongoDB 和 Mongoose 实现分页</li>
<li>用 MongoDB 和 Mongoose 定义索引</li>
<li>MongoDB 和 Mongoose 的 PUT 和 PATCH 更新</li>
<li>介绍使用内置记录器和 TypeORM 进行日志记录</li>
<li>使用终端和数据狗进行运行状况检查</li>
<li>使用 Compodoc 和 JSDoc 生成文档</li>
<li>使用 PostgreSQL 和 TypeORM 实现软删除</li>
<li>在 PostgreSQL 数据库中存储文件</li>
<li>上传文件到服务器</li>
<li>使用角色和声明进行授权</li>
<li>使用 mixin 模式组合类</li>
<li>使用 ETag 实现缓存和节省带宽</li>
<li>介绍一个与 Lerna 和 Yarn 工作空间的单簧管</li>
<li>OpenAPI 规范和 Swagger</li>
<li>处理循环依赖关系</li>
</ol>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7f305cdec2ded6dc7422877b33cadd3a">1 - validator</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-fef1bcec9e28d82005af68a6958d6cba">1.1 - class-validator</h1>
    
	<p><img src="https://github.com/typestack/class-validator/workflows/CI/badge.svg" alt="Build Status">
<a href="https://codecov.io/gh/typestack/class-validator"><img src="https://codecov.io/gh/typestack/class-validator/branch/develop/graph/badge.svg" alt="codecov"></a>
<a href="https://badge.fury.io/js/class-validator"><img src="https://badge.fury.io/js/class-validator.svg" alt="npm version"></a>
<a href="https://packagephobia.now.sh/result?p=class-validator"><img src="https://packagephobia.now.sh/badge?p=class-validator" alt="install size"></a></p>
<p>允许使用基于装饰器和非装饰器的验证。
内部使用<a href="https://github.com/chriso/validator.js">validator.js</a>执行验证。
类验证器可以在浏览器和 node.js 平台上运行。</p>
<h2 id="安装">安装</h2>
<pre tabindex="0"><code>npm install class-validator --save
</code></pre><blockquote>
<p>Note: Please use at least npm@6 when using class-validator. From npm@6 the dependency tree is flattened, which is required by <code>class-validator</code> to function properly.</p>
</blockquote>
<h2 id="使用">使用</h2>
<p>Create your class and put some validation decorators on the properties you want to validate:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">validate</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">validateOrReject</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Contains</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">IsInt</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Length</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">IsEmail</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">IsFQDN</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">IsDate</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Min</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Max</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Contains</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;hello&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">text</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsInt</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">rating</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsEmail</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsFQDN</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">site</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsDate</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">createDate</span>: <span style="color:#204a87;font-weight:bold">Date</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">post</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">title</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;Hello&#34;</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// should not pass
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">text</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;this is a great post about hell world&#34;</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// should not pass
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rating</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// should not pass
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">email</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;google.com&#34;</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// should not pass
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">site</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;googlecom&#34;</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// should not pass
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">errors</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// errors is an array of validation errors
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;validation failed. errors: &#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;validation succeed&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">validateOrReject</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">).</span><span style="color:#204a87;font-weight:bold">catch</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">errors</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Promise rejected (validation failed). Errors: &#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// or
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">validateOrRejectExample</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">input</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">validateOrReject</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">input</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">errors</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Caught promise rejection (validation failed). Errors: &#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="传输选项">传输选项</h3>
<p><code>validate</code>函数的第二个参数是一个<code>ValidatorOptions</code>对象。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">ValidatorOptions</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">skipMissingProperties?</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">whitelist?</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">forbidNonWhitelisted?</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">groups?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">[];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">dismissDefaultMessages?</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">validationError</span><span style="color:#ce5c00;font-weight:bold">?:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">target?</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">value?</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">forbidUnknownValues?</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">stopAtFirstError?</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><blockquote>
<p>It&rsquo;s highly advised to set <code>forbidUnknownValues: true</code> as it will prevent unknown objects from passing validation.</p>
</blockquote>
<h2 id="验证错误">验证错误</h2>
<p>&rsquo; validate &lsquo;方法返回一个&rsquo; ValidationError &lsquo;对象数组。每个“ValidationError”是:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">target</span>: <span style="color:#204a87;font-weight:bold">Object</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Object that was validated.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">property</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Object&#39;s property that haven&#39;t pass validation.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">value</span>: <span style="color:#204a87;font-weight:bold">any</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Value that haven&#39;t pass a validation.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">constraints</span><span style="color:#ce5c00;font-weight:bold">?:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#8f5902;font-style:italic">// Constraints that failed validation with error messages.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">children?</span>: <span style="color:#204a87;font-weight:bold">ValidationError</span><span style="color:#000;font-weight:bold">[];</span> <span style="color:#8f5902;font-style:italic">// Contains all nested validation errors of the property
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>In our case, when we validated a Post object, we have such an array of <code>ValidationError</code> objects:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">target</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#8f5902;font-style:italic">/* post object */</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">property</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;title&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Hello&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">constraints</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">length</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;$property must be longer than or equal to 10 characters&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">target</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#8f5902;font-style:italic">/* post object */</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">property</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;text&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;this is a great post about hell world&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">constraints</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">contains</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;text must contain a hello string&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// and other errors
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">]</span>
</span></span></code></pre></div><p>If you don&rsquo;t want a <code>target</code> to be exposed in validation errors, there is a special option when you use validator:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#000">validator</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">validationError</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">target</span>: <span style="color:#204a87;font-weight:bold">false</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>This is especially useful when you send errors back over http, and you most probably don&rsquo;t want to expose
the whole target object.</p>
<h2 id="验证消息">验证消息</h2>
<p>You can specify validation message in the decorator options and that message will be returned in the <code>ValidationError</code>
returned by the <code>validate</code> method (in the case that validation for this field fails).</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">MinLength</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">MaxLength</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@MinLength</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Title is too short&#34;</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@MaxLength</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">50</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Title is too long&#34;</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>There are few special tokens you can use in your messages:</p>
<ul>
<li><code>$value</code> - the value that is being validated</li>
<li><code>$property</code> - name of the object&rsquo;s property being validated</li>
<li><code>$target</code> - name of the object&rsquo;s class being validated</li>
<li><code>$constraint1</code>, <code>$constraint2</code>, &hellip; <code>$constraintN</code> - constraints defined by specific validation type</li>
</ul>
<p>Example of usage:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">MinLength</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">MaxLength</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@MinLength</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// here, $constraint1 will be replaced with &#34;10&#34;, and $value with actual supplied value
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Title is too short. Minimal length is $constraint1 characters, but actual is $value&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@MaxLength</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">50</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// here, $constraint1 will be replaced with &#34;50&#34;, and $value with actual supplied value
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Title is too long. Maximal length is $constraint1 characters, but actual is $value&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Also you can provide a function, that returns a message. This allows you to create more granular messages:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">MinLength</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">MaxLength</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ValidationArguments</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@MinLength</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span>: <span style="color:#204a87;font-weight:bold">ValidationArguments</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;Too short, minimum length is 1 character&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;Too short, minimum length is &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">constraints</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34; characters&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Message function accepts <code>ValidationArguments</code> which contains the following information:</p>
<ul>
<li><code>value</code> - the value that is being validated</li>
<li><code>constraints</code> - array of constraints defined by specific validation type</li>
<li><code>targetName</code> - name of the object&rsquo;s class being validated</li>
<li><code>object</code> - object that is being validated</li>
<li><code>property</code> - name of the object&rsquo;s property being validated</li>
</ul>
<h2 id="验证数组">验证数组</h2>
<p>If your field is an array and you want to perform validation of each item in the array you must specify a
special <code>each: true</code> decorator option:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">MinLength</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">MaxLength</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@MaxLength</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">each</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">tags</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">[];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>This will validate each item in <code>post.tags</code> array.</p>
<h2 id="验证集">验证集</h2>
<p>If your field is a set and you want to perform validation of each item in the set you must specify a
special <code>each: true</code> decorator option:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">MinLength</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">MaxLength</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@MaxLength</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">each</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">tags</span>: <span style="color:#204a87;font-weight:bold">Set</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">&gt;;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>This will validate each item in <code>post.tags</code> set.</p>
<h2 id="验证图">验证图</h2>
<p>If your field is a map and you want to perform validation of each item in the map you must specify a
special <code>each: true</code> decorator option:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">MinLength</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">MaxLength</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@MaxLength</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">each</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">tags</span>: <span style="color:#204a87;font-weight:bold">Map</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#a40000">,</span> <span style="color:#c4a000">string</span><span style="color:#000;font-weight:bold">&gt;;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>This will validate each item in <code>post.tags</code> map.</p>
<h2 id="验证嵌套对象">验证嵌套对象</h2>
<p>If your object contains nested objects and you want the validator to perform their validation too, then you need to
use the <code>@ValidateNested()</code> decorator:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ValidateNested</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@ValidateNested</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">user</span>: <span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Please note that nested object <em>must</em> be an instance of a class, otherwise <code>@ValidateNested</code> won&rsquo;t know what class is target of validation. Check also <a href="#validating-plain-objects">Validating plain objects</a>.</p>
<p>It also works with multi-dimensional array, like :</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ValidateNested</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Plan2D</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@ValidateNested</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">matrix</span>: <span style="color:#204a87;font-weight:bold">Point</span><span style="color:#000;font-weight:bold">[][];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="验证承诺">验证承诺</h2>
<p>If your object contains property with <code>Promise</code>-returned value that should be validated, then you need to use the <code>@ValidatePromise()</code> decorator:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ValidatePromise</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Min</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@ValidatePromise</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">userId</span>: <span style="color:#204a87;font-weight:bold">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">&gt;;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>It also works great with <code>@ValidateNested</code> decorator:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ValidateNested</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ValidatePromise</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@ValidateNested</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@ValidatePromise</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">user</span>: <span style="color:#204a87;font-weight:bold">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">&gt;;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="验证继承修饰符">验证继承修饰符</h2>
<p>When you define a subclass which extends from another one, the subclass will automatically inherit the parent&rsquo;s decorators. If a property is redefined in the descendant class decorators will be applied on it both from that and the base class.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">validate</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">BaseContent</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsEmail</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsString</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">password</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">BaseContent</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@MinLength</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@MaxLength</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Contains</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;hello&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">welcome</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@MinLength</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">password</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">email</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;invalid email&#34;</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// inherited property
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">password</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;too short&#34;</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// password wil be validated not only against IsString, but against MinLength as well
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;not valid&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">welcome</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;helo&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">errors</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// it will return errors for email, title and text properties
</span></span></span></code></pre></div><h2 id="有条件的验证">有条件的验证</h2>
<p>The conditional validation decorator (<code>@ValidateIf</code>) can be used to ignore the validators on a property when the provided condition function returns false. The condition function takes the object being validated and must return a <code>boolean</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ValidateIf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">IsNotEmpty</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">otherProperty</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@ValidateIf</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">o</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">otherProperty</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;value&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsNotEmpty</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">example</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>In the example above, the validation rules applied to <code>example</code> won&rsquo;t be run unless the object&rsquo;s <code>otherProperty</code> is <code>&quot;value&quot;</code>.</p>
<p>Note that when the condition is false all validation decorators are ignored, including <code>isDefined</code>.</p>
<h2 id="白名单">白名单</h2>
<p>Even if your object is an instance of a validation class it can contain additional properties that are not defined.
If you do not want to have such properties on your object, pass special flag to <code>validate</code> method:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">validate</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">whitelist</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>This will strip all properties that don&rsquo;t have any decorators. If no other decorator is suitable for your property,
you can use @Allow decorator:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">validate</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Allow</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Min</span><span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">@Allow</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">@Min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">views</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">nonWhitelistedProperty</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">post</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">title</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;Hello world!&#39;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">views</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">420</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nonWhitelistedProperty</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">69</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">post</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#204a87;font-weight:bold">any</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">anotherNonWhitelistedProperty</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;something&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errors</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// post.nonWhitelistedProperty is not defined
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// (post as any).anotherNonWhitelistedProperty is not defined
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>If you would rather to have an error thrown when any non-whitelisted properties are present, pass another flag to
<code>validate</code> method:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">validate</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">whitelist</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">forbidNonWhitelisted</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><h2 id="将上下文传递给装饰器">将上下文传递给装饰器</h2>
<p>It&rsquo;s possible to pass a custom object to decorators which will be accessible on the <code>ValidationError</code> instance of the property if validation failed.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">validate</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">MyClass</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@MinLength</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;EIC code must be at least 32 characters&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">errorCode</span>: <span style="color:#204a87;font-weight:bold">1003</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">developerNote</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;The validated string must contain 32 or more characters.&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">eicCode</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">model</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">MyClass</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">model</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">errors</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">//errors[0].contexts[&#39;minLength&#39;].errorCode === 1003
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><h2 id="跳过缺失的属性">跳过缺失的属性</h2>
<p>Sometimes you may want to skip validation of the properties that do not exist in the validating object. This is
usually desirable when you want to update some parts of the object, and want to validate only updated parts,
but skip everything else, e.g. skip missing properties.
In such situations you will need to pass a special flag to <code>validate</code> method:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">validate</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">skipMissingProperties</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>When skipping missing properties, sometimes you want not to skip all missing properties, some of them maybe required
for you, even if skipMissingProperties is set to true. For such cases you should use <code>@IsDefined()</code> decorator.
<code>@IsDefined()</code> is the only decorator that ignores <code>skipMissingProperties</code> option.</p>
<h2 id="验证组">验证组</h2>
<p>In different situations you may want to use different validation schemas of the same object.
In such cases you can use validation groups.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">validate</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Min</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Length</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">12</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">groups</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;registration&#34;</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">age</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">groups</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;registration&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;admin&#34;</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">age</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;Alex&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">groups</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;registration&#34;</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// this will not pass validation
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">groups</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;admin&#34;</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// this will pass validation
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">groups</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;registration&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;admin&#34;</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// this will not pass validation
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">groups</span>: <span style="color:#204a87;font-weight:bold">undefined</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// the default
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// this will not pass validation since all properties get validated regardless of their groups
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">groups</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[],</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// this will not pass validation, (equivalent to &#39;groups: undefined&#39;, see above)
</span></span></span></code></pre></div><p>There is also a special flag <code>always: true</code> in validation options that you can use. This flag says that this validation
must be applied always no matter which group is used.</p>
<h2 id="自定义验证类">自定义验证类</h2>
<p>If you have custom validation logic you can create a <em>Constraint class</em>:</p>
<ol>
<li>
<p>First create a file, lets say <code>CustomTextLength.ts</code>, and define a new class:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ValidatorConstraint</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ValidatorConstraintInterface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ValidationArguments</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@ValidatorConstraint</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;customText&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">async</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">CustomTextLength</span> <span style="color:#204a87;font-weight:bold">implements</span> <span style="color:#000">ValidatorConstraintInterface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">text</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span>: <span style="color:#204a87;font-weight:bold">ValidationArguments</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">text</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">text</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// for async validations you must return a Promise&lt;boolean&gt; here
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">defaultMessage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span>: <span style="color:#204a87;font-weight:bold">ValidationArguments</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// here you can provide default error message if validation failed
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;Text ($value) is too short or too long!&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>We marked our class with <code>@ValidatorConstraint</code> decorator.
You can also supply a validation constraint name - this name will be used as &ldquo;error type&rdquo; in ValidationError.
If you will not supply a constraint name - it will be auto-generated.</p>
<p>Our class must implement <code>ValidatorConstraintInterface</code> interface and its <code>validate</code> method,
which defines validation logic. If validation succeeds, method returns true, otherwise false.
Custom validator can be asynchronous, if you want to perform validation after some asynchronous
operations, simply return a promise with boolean inside in <code>validate</code> method.</p>
<p>Also we defined optional method <code>defaultMessage</code> which defines a default error message,
in the case that the decorator&rsquo;s implementation doesn&rsquo;t set an error message.</p>
</li>
</ol>
<ol start="2">
<li>
<p>Then you can use your new validation constraint in your class:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Validate</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">CustomTextLength</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./CustomTextLength&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">CustomTextLength</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Title is too short or long!&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Here we set our newly created <code>CustomTextLength</code> validation constraint for <code>Post.title</code>.</p>
</li>
<li>
<p>And use validator as usual:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">validate</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">errors</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div></li>
</ol>
<p>You can also pass constraints to your validator, like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Validate</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">CustomTextLength</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./CustomTextLength&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">CustomTextLength</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Wrong post title&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>And use them from <code>validationArguments</code> object:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ValidationArguments</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ValidatorConstraint</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ValidatorConstraintInterface</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@ValidatorConstraint</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">CustomTextLength</span> <span style="color:#204a87;font-weight:bold">implements</span> <span style="color:#000">ValidatorConstraintInterface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">text</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">validationArguments</span>: <span style="color:#204a87;font-weight:bold">ValidationArguments</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">text</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">validationArguments</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">constraints</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">text</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">validationArguments</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">constraints</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="自定义验证修饰符">自定义验证修饰符</h2>
<p>You can also create a custom decorators. Its the most elegant way of using a custom validations.
Lets create a decorator called <code>@IsLongerThan</code>:</p>
<ol>
<li>
<p>Create a decorator itself:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">registerDecorator</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ValidationOptions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ValidationArguments</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">IsLongerThan</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">property</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">validationOptions?</span>: <span style="color:#204a87;font-weight:bold">ValidationOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">object</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87">Object</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">propertyName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">registerDecorator</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;isLongerThan&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">target</span>: <span style="color:#204a87;font-weight:bold">object.constructor</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">propertyName</span>: <span style="color:#204a87;font-weight:bold">propertyName</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">constraints</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">property</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">options</span>: <span style="color:#204a87;font-weight:bold">validationOptions</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">validator</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span>: <span style="color:#204a87;font-weight:bold">any</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span>: <span style="color:#204a87;font-weight:bold">ValidationArguments</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">relatedPropertyName</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">constraints</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">relatedValue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">object</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#204a87;font-weight:bold">any</span><span style="color:#000;font-weight:bold">)[</span><span style="color:#000">relatedPropertyName</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>          <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;string&#34;</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">relatedValue</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;string&#34;</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">relatedValue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// you can return a Promise&lt;boolean&gt; here as well, if you want to make async validation
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div></li>
<li>
<p>Put it to use:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">IsLongerThan</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./IsLongerThan&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsLongerThan</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;title&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* you can also use additional validation options, like &#34;groups&#34; in your custom validation decorators. &#34;each&#34; is not supported */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Text must be longer than the title&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">text</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div></li>
</ol>
<p>In your custom decorators you can also use <code>ValidationConstraint</code>.
Lets create another custom validation decorator called <code>IsUserAlreadyExist</code>:</p>
<ol>
<li>
<p>Create a ValidationConstraint and decorator:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">registerDecorator</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">ValidationOptions</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">ValidatorConstraint</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">ValidatorConstraintInterface</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">ValidationArguments</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@ValidatorConstraint</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#204a87;font-weight:bold">async</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">IsUserAlreadyExistConstraint</span> <span style="color:#204a87;font-weight:bold">implements</span> <span style="color:#000">ValidatorConstraintInterface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userName</span>: <span style="color:#204a87;font-weight:bold">any</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span>: <span style="color:#204a87;font-weight:bold">ValidationArguments</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">UserRepository</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findOneByName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userName</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">IsUserAlreadyExist</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">validationOptions?</span>: <span style="color:#204a87;font-weight:bold">ValidationOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">object</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87">Object</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">propertyName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">registerDecorator</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">target</span>: <span style="color:#204a87;font-weight:bold">object.constructor</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">propertyName</span>: <span style="color:#204a87;font-weight:bold">propertyName</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">options</span>: <span style="color:#204a87;font-weight:bold">validationOptions</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">constraints</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[],</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">validator</span>: <span style="color:#204a87;font-weight:bold">IsUserAlreadyExistConstraint</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>note that we marked our constraint that it will by async by adding <code>{ async: true }</code> in validation options.</p>
</li>
<li>
<p>And put it to use:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">IsUserAlreadyExist</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./IsUserAlreadyExist&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsUserAlreadyExist</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;User $value already exists. Choose another name.&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div></li>
</ol>
<h2 id="使用服务容器">使用服务容器</h2>
<p>Validator supports service container in the case if want to inject dependencies into your custom validator constraint
classes. Here is example how to integrate it with <a href="https://github.com/pleerock/typedi">typedi</a>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Container</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;typedi&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">useContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Validator</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// do this somewhere in the global application level:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">useContainer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Container</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">validator</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Validator</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// now everywhere you can inject Validator class which will go from the container
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// also you can inject classes using constructor injection into your custom ValidatorConstraint-s
</span></span></span></code></pre></div><h2 id="同步验证">同步验证</h2>
<p>If you want to perform a simple non async validation you can use <code>validateSync</code> method instead of regular <code>validate</code>
method. It has the same arguments as <code>validate</code> method. But note, this method <strong>ignores</strong> all async validations
you have.</p>
<h2 id="手动验证">手动验证</h2>
<p>There are several method exist in the Validator that allows to perform non-decorator based validation:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">isEmpty</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">isBoolean</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">isEmpty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">isBoolean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><h2 id="验证修饰符">验证修饰符</h2>
<!-- Disable table formatting because Prettier messing it up. -->
<!-- prettier-ignore -->
<table>
<thead>
<tr>
<th>Decorator</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Common validation decorators</strong></td>
<td></td>
</tr>
<tr>
<td><code>@IsDefined(value: any)</code></td>
<td>Checks if value is defined (!== undefined, !== null). This is the only decorator that ignores skipMissingProperties option.</td>
</tr>
<tr>
<td><code>@IsOptional()</code></td>
<td>Checks if given value is empty (=== null, === undefined) and if so, ignores all the validators on the property.</td>
</tr>
<tr>
<td><code>@Equals(comparison: any)</code></td>
<td>Checks if value equals (&quot;===&quot;) comparison.</td>
</tr>
<tr>
<td><code>@NotEquals(comparison: any)</code></td>
<td>Checks if value not equal (&quot;!==&quot;) comparison.</td>
</tr>
<tr>
<td><code>@IsEmpty()</code></td>
<td>Checks if given value is empty (=== &lsquo;&rsquo;, === null, === undefined).</td>
</tr>
<tr>
<td><code>@IsNotEmpty()</code></td>
<td>Checks if given value is not empty (!== &lsquo;&rsquo;, !== null, !== undefined).</td>
</tr>
<tr>
<td><code>@IsIn(values: any[])</code></td>
<td>Checks if value is in a array of allowed values.</td>
</tr>
<tr>
<td><code>@IsNotIn(values: any[])</code></td>
<td>Checks if value is not in a array of disallowed values.</td>
</tr>
<tr>
<td><strong>Type validation decorators</strong></td>
<td></td>
</tr>
<tr>
<td><code>@IsBoolean()</code></td>
<td>Checks if a value is a boolean.</td>
</tr>
<tr>
<td><code>@IsDate()</code></td>
<td>Checks if the value is a date.</td>
</tr>
<tr>
<td><code>@IsString()</code></td>
<td>Checks if the string is a string.</td>
</tr>
<tr>
<td><code>@IsNumber(options: IsNumberOptions)</code></td>
<td>Checks if the value is a number.</td>
</tr>
<tr>
<td><code>@IsInt()</code></td>
<td>Checks if the value is an integer number.</td>
</tr>
<tr>
<td><code>@IsArray()</code></td>
<td>Checks if the value is an array</td>
</tr>
<tr>
<td><code>@IsEnum(entity: object)</code></td>
<td>Checks if the value is an valid enum</td>
</tr>
<tr>
<td><strong>Number validation decorators</strong></td>
<td></td>
</tr>
<tr>
<td><code>@IsDivisibleBy(num: number)</code></td>
<td>Checks if the value is a number that&rsquo;s divisible by another.</td>
</tr>
<tr>
<td><code>@IsPositive()</code></td>
<td>Checks if the value is a positive number greater than zero.</td>
</tr>
<tr>
<td><code>@IsNegative()</code></td>
<td>Checks if the value is a negative number smaller than zero.</td>
</tr>
<tr>
<td><code>@Min(min: number)</code></td>
<td>Checks if the given number is greater than or equal to given number.</td>
</tr>
<tr>
<td><code>@Max(max: number)</code></td>
<td>Checks if the given number is less than or equal to given number.</td>
</tr>
<tr>
<td><strong>Date validation decorators</strong></td>
<td></td>
</tr>
<tr>
<td><code>@MinDate(date: Date)</code></td>
<td>Checks if the value is a date that&rsquo;s after the specified date.</td>
</tr>
<tr>
<td><code>@MaxDate(date: Date)</code></td>
<td>Checks if the value is a date that&rsquo;s before the specified date.</td>
</tr>
<tr>
<td><strong>String-type validation decorators</strong></td>
<td></td>
</tr>
<tr>
<td><code>@IsBooleanString()</code></td>
<td>Checks if a string is a boolean (e.g. is &ldquo;true&rdquo; or &ldquo;false&rdquo;).</td>
</tr>
<tr>
<td><code>@IsDateString()</code></td>
<td>Alias for <code>@IsISO8601()</code>.</td>
</tr>
<tr>
<td><code>@IsNumberString(options?: IsNumericOptions)</code></td>
<td>Checks if a string is a number.</td>
</tr>
<tr>
<td><strong>String validation decorators</strong></td>
<td></td>
</tr>
<tr>
<td><code>@Contains(seed: string)</code></td>
<td>Checks if the string contains the seed.</td>
</tr>
<tr>
<td><code>@NotContains(seed: string)</code></td>
<td>Checks if the string not contains the seed.</td>
</tr>
<tr>
<td><code>@IsAlpha()</code></td>
<td>Checks if the string contains only letters (a-zA-Z).</td>
</tr>
<tr>
<td><code>@IsAlphanumeric()</code></td>
<td>Checks if the string contains only letters and numbers.</td>
</tr>
<tr>
<td><code>@IsDecimal(options?: IsDecimalOptions)</code></td>
<td>Checks if the string is a valid decimal value. Default IsDecimalOptions are <code>force_decimal=False</code>, <code>decimal_digits: '1,'</code>, <code>locale: 'en-US'</code></td>
</tr>
<tr>
<td><code>@IsAscii()</code></td>
<td>Checks if the string contains ASCII chars only.</td>
</tr>
<tr>
<td><code>@IsBase32()</code></td>
<td>Checks if a string is base32 encoded.</td>
</tr>
<tr>
<td><code>@IsBase64()</code></td>
<td>Checks if a string is base64 encoded.</td>
</tr>
<tr>
<td><code>@IsIBAN()</code></td>
<td>Checks if a string is a IBAN (International Bank Account Number).</td>
</tr>
<tr>
<td><code>@IsBIC()</code></td>
<td>Checks if a string is a BIC (Bank Identification Code) or SWIFT code.</td>
</tr>
<tr>
<td><code>@IsByteLength(min: number, max?: number)</code></td>
<td>Checks if the string&rsquo;s length (in bytes) falls in a range.</td>
</tr>
<tr>
<td><code>@IsCreditCard()</code></td>
<td>Checks if the string is a credit card.</td>
</tr>
<tr>
<td><code>@IsCurrency(options?: IsCurrencyOptions)</code></td>
<td>Checks if the string is a valid currency amount.</td>
</tr>
<tr>
<td><code>@IsEthereumAddress()</code></td>
<td>Checks if the string is an Ethereum address using basic regex. Does not validate address checksums.</td>
</tr>
<tr>
<td><code>@IsBtcAddress()</code></td>
<td>Checks if the string is a valid BTC address.</td>
</tr>
<tr>
<td><code>@IsDataURI()</code></td>
<td>Checks if the string is a data uri format.</td>
</tr>
<tr>
<td><code>@IsEmail(options?: IsEmailOptions)</code></td>
<td>Checks if the string is an email.</td>
</tr>
<tr>
<td><code>@IsFQDN(options?: IsFQDNOptions)</code></td>
<td>Checks if the string is a fully qualified domain name (e.g. domain.com).</td>
</tr>
<tr>
<td><code>@IsFullWidth()</code></td>
<td>Checks if the string contains any full-width chars.</td>
</tr>
<tr>
<td><code>@IsHalfWidth()</code></td>
<td>Checks if the string contains any half-width chars.</td>
</tr>
<tr>
<td><code>@IsVariableWidth()</code></td>
<td>Checks if the string contains a mixture of full and half-width chars.</td>
</tr>
<tr>
<td><code>@IsHexColor()</code></td>
<td>Checks if the string is a hexadecimal color.</td>
</tr>
<tr>
<td><code>@IsHSLColor()</code></td>
<td>Checks if the string is an HSL color based on <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/color_value">CSS Colors Level 4 specification</a>.</td>
</tr>
<tr>
<td><code>@IsRgbColor(options?: IsRgbOptions)</code></td>
<td>Checks if the string is a rgb or rgba color.</td>
</tr>
<tr>
<td><code>@IsIdentityCard(locale?: string)</code></td>
<td>Checks if the string is a valid identity card code.</td>
</tr>
<tr>
<td><code>@IsPassportNumber(countryCode?: string)</code></td>
<td>Checks if the string is a valid passport number relative to a specific country code.</td>
</tr>
<tr>
<td><code>@IsPostalCode(locale?: string)</code></td>
<td>Checks if the string is a postal code.</td>
</tr>
<tr>
<td><code>@IsHexadecimal()</code></td>
<td>Checks if the string is a hexadecimal number.</td>
</tr>
<tr>
<td><code>@IsOctal()</code></td>
<td>Checks if the string is a octal number.</td>
</tr>
<tr>
<td><code>@IsMACAddress(options?: IsMACAddressOptions)</code></td>
<td>Checks if the string is a MAC Address.</td>
</tr>
<tr>
<td><code>@IsIP(version?: &quot;4&quot;|&quot;6&quot;)</code></td>
<td>Checks if the string is an IP (version 4 or 6).</td>
</tr>
<tr>
<td><code>@IsPort()</code></td>
<td>Checks if the string is a valid port number.</td>
</tr>
<tr>
<td><code>@IsISBN(version?: &quot;10&quot;|&quot;13&quot;)</code></td>
<td>Checks if the string is an ISBN (version 10 or 13).</td>
</tr>
<tr>
<td><code>@IsEAN()</code></td>
<td>Checks if the string is an if the string is an EAN (European Article Number).</td>
</tr>
<tr>
<td><code>@IsISIN()</code></td>
<td>Checks if the string is an ISIN (stock/security identifier).</td>
</tr>
<tr>
<td><code>@IsISO8601(options?: IsISO8601Options)</code></td>
<td>Checks if the string is a valid ISO 8601 date format. Use the option strict = true for additional checks for a valid date.</td>
</tr>
<tr>
<td><code>@IsJSON()</code></td>
<td>Checks if the string is valid JSON.</td>
</tr>
<tr>
<td><code>@IsJWT()</code></td>
<td>Checks if the string is valid JWT.</td>
</tr>
<tr>
<td><code>@IsObject()</code></td>
<td>Checks if the object is valid Object (null, functions, arrays will return false).</td>
</tr>
<tr>
<td><code>@IsNotEmptyObject()</code></td>
<td>Checks if the object is not empty.</td>
</tr>
<tr>
<td><code>@IsLowercase()</code></td>
<td>Checks if the string is lowercase.</td>
</tr>
<tr>
<td><code>@IsLatLong()</code></td>
<td>Checks if the string is a valid latitude-longitude coordinate in the format lat, long.</td>
</tr>
<tr>
<td><code>@IsLatitude()</code></td>
<td>Checks if the string or number is a valid latitude coordinate.</td>
</tr>
<tr>
<td><code>@IsLongitude()</code></td>
<td>Checks if the string or number is a valid longitude coordinate.</td>
</tr>
<tr>
<td><code>@IsMobilePhone(locale: string)</code></td>
<td>Checks if the string is a mobile phone number.</td>
</tr>
<tr>
<td><code>@IsISO31661Alpha2()</code></td>
<td>Checks if the string is a valid ISO 3166-1 alpha-2 officially assigned country code.</td>
</tr>
<tr>
<td><code>@IsISO31661Alpha3()</code></td>
<td>Checks if the string is a valid ISO 3166-1 alpha-3 officially assigned country code.</td>
</tr>
<tr>
<td><code>@IsLocale()</code></td>
<td>Checks if the string is a locale.</td>
</tr>
<tr>
<td><code>@IsPhoneNumber(region: string)</code></td>
<td>Checks if the string is a valid phone numberusing libphonenumber-js.</td>
</tr>
<tr>
<td><code>@IsMongoId()</code></td>
<td>Checks if the string is a valid hex-encoded representation of a MongoDB ObjectId.</td>
</tr>
<tr>
<td><code>@IsMultibyte()</code></td>
<td>Checks if the string contains one or more multibyte chars.</td>
</tr>
<tr>
<td><code>@IsNumberString(options?: IsNumericOptions)</code></td>
<td>Checks if the string is numeric.</td>
</tr>
<tr>
<td><code>@IsSurrogatePair()</code></td>
<td>Checks if the string contains any surrogate pairs chars.</td>
</tr>
<tr>
<td><code>@IsUrl(options?: IsURLOptions)</code></td>
<td>Checks if the string is an url.</td>
</tr>
<tr>
<td><code>@IsMagnetURI()</code></td>
<td>Checks if the string is a <a href="https://en.wikipedia.org/wiki/Magnet_URI_scheme">magnet uri format</a>.</td>
</tr>
<tr>
<td><code>@IsUUID(version?: &quot;3&quot;|&quot;4&quot;|&quot;5&quot;|&quot;all&quot;)</code></td>
<td>Checks if the string is a UUID (version 3, 4, 5 or all ).</td>
</tr>
<tr>
<td><code>@IsFirebasePushId()</code></td>
<td>Checks if the string is a <a href="https://firebase.googleblog.com/2015/02/the-2120-ways-to-ensure-unique_68.html">Firebase Push ID</a></td>
</tr>
<tr>
<td><code>@IsUppercase()</code></td>
<td>Checks if the string is uppercase.</td>
</tr>
<tr>
<td><code>@Length(min: number, max?: number)</code></td>
<td>Checks if the string&rsquo;s length falls in a range.</td>
</tr>
<tr>
<td><code>@MinLength(min: number)</code></td>
<td>Checks if the string&rsquo;s length is not less than given number.</td>
</tr>
<tr>
<td><code>@MaxLength(max: number)</code></td>
<td>Checks if the string&rsquo;s length is not more than given number.</td>
</tr>
<tr>
<td><code>@Matches(pattern: RegExp, modifiers?: string)</code></td>
<td>Checks if string matches the pattern. Either matches(&lsquo;foo&rsquo;, /foo/i) or matches(&lsquo;foo&rsquo;, &lsquo;foo&rsquo;, &lsquo;i&rsquo;).</td>
</tr>
<tr>
<td><code>@IsMilitaryTime()</code></td>
<td>Checks if the string is a valid representation of military time in the format HH:MM.</td>
</tr>
<tr>
<td><code>@IsHash(algorithm: string)</code></td>
<td>Checks if the string is a hash The following types are supported:<code>md4</code>, <code>md5</code>, <code>sha1</code>, <code>sha256</code>, <code>sha384</code>, <code>sha512</code>, <code>ripemd128</code>, <code>ripemd160</code>, <code>tiger128</code>, <code>tiger160</code>, <code>tiger192</code>, <code>crc32</code>, <code>crc32b</code>.</td>
</tr>
<tr>
<td><code>@IsMimeType()</code></td>
<td>Checks if the string matches to a valid <a href="https://en.wikipedia.org/wiki/Media_type">MIME type</a> format</td>
</tr>
<tr>
<td><code>@IsSemVer()</code></td>
<td>Checks if the string is a Semantic Versioning Specification (SemVer).</td>
</tr>
<tr>
<td><code>@IsISSN(options?: IsISSNOptions)</code></td>
<td>Checks if the string is a ISSN.</td>
</tr>
<tr>
<td><code>@IsISRC()</code></td>
<td>Checks if the string is a <a href="https://en.wikipedia.org/wiki/International_Standard_Recording_Code">ISRC</a>.</td>
</tr>
<tr>
<td><code>@IsRFC3339()</code></td>
<td>Checks if the string is a valid <a href="https://tools.ietf.org/html/rfc3339">RFC 3339</a> date.</td>
</tr>
<tr>
<td><strong>Array validation decorators</strong></td>
<td></td>
</tr>
<tr>
<td><code>@ArrayContains(values: any[])</code></td>
<td>Checks if array contains all values from the given array of values.</td>
</tr>
<tr>
<td><code>@ArrayNotContains(values: any[])</code></td>
<td>Checks if array does not contain any of the given values.</td>
</tr>
<tr>
<td><code>@ArrayNotEmpty()</code></td>
<td>Checks if given array is not empty.</td>
</tr>
<tr>
<td><code>@ArrayMinSize(min: number)</code></td>
<td>Checks if the array&rsquo;s length is greater than or equal to the specified number.</td>
</tr>
<tr>
<td><code>@ArrayMaxSize(max: number)</code></td>
<td>Checks if the array&rsquo;s length is less or equal to the specified number.</td>
</tr>
<tr>
<td><code>@ArrayUnique(identifier?: (o) =&gt; any)</code></td>
<td>Checks if all array&rsquo;s values are unique. Comparison for objects is reference-based. Optional function can be speciefied which return value will be used for the comparsion.</td>
</tr>
<tr>
<td><strong>Object validation decorators</strong></td>
<td></td>
</tr>
<tr>
<td><code>@IsInstance(value: any)</code></td>
<td>Checks if the property is an instance of the passed value.</td>
</tr>
<tr>
<td><strong>Other decorators</strong></td>
<td></td>
</tr>
<tr>
<td><code>@Allow()</code></td>
<td>Prevent stripping off the property when no other constraint is specified for it.</td>
</tr>
</tbody>
</table>
<h2 id="定义没有装饰器的验证模式">定义没有装饰器的验证模式</h2>
<p>你可以在没有装饰器的情况下定义你的验证模式:</p>
<ul>
<li>you can define it in the separate object</li>
<li>you can define it in the <code>.json</code> file</li>
</ul>
<p>This feature maybe useful in the cases if:</p>
<ul>
<li>are using es5/es6 and don&rsquo;t have decorators available</li>
<li>you don&rsquo;t have a classes, and instead using interfaces</li>
<li>you don&rsquo;t want to use model at all</li>
<li>you want to have a validation schema separate of your model</li>
<li>you want beautiful json-schema based validation models</li>
<li>you simply hate decorators</li>
</ul>
<p>Here is an example of using it:</p>
<ol>
<li>
<p>Create a schema object:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ValidationSchema</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">UserValidationSchema</span>: <span style="color:#204a87;font-weight:bold">ValidationSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// using interface here is not required, its just for type-safety
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;myUserSchema&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// this is required, and must be unique
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">properties</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">firstName</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;minLength&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// validation type. All validation types are listed in ValidationTypes class.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">constraints</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;maxLength&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">constraints</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">lastName</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;minLength&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">constraints</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;maxLength&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">constraints</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">email</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;isEmail&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>Same schema can be provided in <code>.json</code> file, depend on your wish.</p>
</li>
<li>
<p>Register your schema:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">registerSchema</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">UserValidationSchema</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./UserValidationSchema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">registerSchema</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">UserValidationSchema</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// if schema is in .json file, then you can simply do registerSchema(require(&#34;path-to-schema.json&#34;));
</span></span></span></code></pre></div><p>Better to put this code in a global place, maybe when you bootstrap your application, for example in <code>app.ts</code>.</p>
</li>
<li>
<p>Validate your object using validation schema:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">validate</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">firstName</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Johny&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">secondName</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Cage&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">email</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;johny@cage.com&#34;</span> <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span><span style="color:#000">validate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;myUserSchema&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">errors</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Validation failed: &#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Validation succeed.&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>That&rsquo;s it. Here <code>&quot;myUserSchema&quot;</code> is the name of our validation schema.
<code>validate</code> method will perform validation based on this schema</p>
</li>
</ol>
<h2 id="验证纯对象">验证纯对象</h2>
<p>由于装饰器的特性，验证过的对象必须使用<code>new Class()</code>语法进行实例化。
如果你用类验证器装饰器定义了你的类，并且你想验证普通的 JS 对象(文字对象或 JSON.parse 返回的对象)，你需要通过使用<a href="https://github.com/pleerock/class-transformer">class-transformer</a>将其转换为类实例。</p>
<h2 id="样品">样品</h2>
<p>请参阅<a href="https://github.com/pleerock/class-validator/tree/master/sample">./sample</a>中的示例以获得更多用法示例。</p>
<h2 id="扩展">扩展</h2>
<p>有几个扩展可以简化类验证器与其他模块的集成:</p>
<ul>
<li><a href="https://github.com/19majkel94/class-transformer-validator">class-validator integration</a> with <a href="https://github.com/pleerock/class-transformer">class-transformer</a></li>
<li><a href="https://github.com/yantrab/class-validator-rule">class-validator-rule</a></li>
<li><a href="https://github.com/EndyKaufman/ngx-dynamic-form-builder">ngx-dynamic-form-builder</a></li>
<li><a href="https://github.com/abarghoud/ngx-reactive-form-class-validator">abarghoud/ngx-reactive-form-class-validator</a></li>
</ul>
<h2 id="发布说明">发布说明</h2>
<p>查看关于中断更改和发布说明的信息<a href="CHANGELOG.md">在这里</a>。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-dc8d9bde5ab50bdea8564d5e73547fd5">1.2 - class-transformer</h1>
    
	<p><img src="https://github.com/typestack/class-transformer/workflows/CI/badge.svg" alt="Build Status">
<a href="https://codecov.io/gh/typestack/class-transformer"><img src="https://codecov.io/gh/typestack/class-transformer/branch/develop/graph/badge.svg" alt="codecov"></a>
<a href="https://badge.fury.io/js/class-transformer"><img src="https://badge.fury.io/js/class-transformer.svg" alt="npm version"></a></p>
<p>Its ES6 and Typescript era. Nowadays you are working with classes and constructor objects more than ever.
Class-transformer allows you to transform plain object to some instance of class and versa.
Also it allows to serialize / deserialize object based on criteria.
This tool is super useful on both frontend and backend.</p>
<p>Example how to use with angular 2 in <a href="http://plnkr.co/edit/Mja1ZYAjVySWASMHVB9R">plunker</a>.
Source code is available <a href="https://github.com/pleerock/class-transformer-demo">here</a>.</p>
<h2 id="什么是-class-transformer">什么是 class-transformer</h2>
<p>In JavaScript there are two types of objects:</p>
<ul>
<li>plain (literal) objects</li>
<li>class (constructor) objects</li>
</ul>
<p>Plain objects are objects that are instances of <code>Object</code> class.
Sometimes they are called <strong>literal</strong> objects, when created via <code>{}</code> notation.
Class objects are instances of classes with own defined constructor, properties and methods.
Usually you define them via <code>class</code> notation.</p>
<p>So, what is the problem?</p>
<p>Sometimes you want to transform plain javascript object to the ES6 <strong>classes</strong> you have.
For example, if you are loading a json from your backend, some api or from a json file,
and after you <code>JSON.parse</code> it you have a plain javascript object, not instance of class you have.</p>
<p>For example you have a list of users in your <code>users.json</code> that you are loading:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;firstName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Johny&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;lastName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Cage&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;age&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">27</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;firstName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Ismoil&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;lastName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Somoni&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;age&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">50</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;firstName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Luke&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;lastName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Dacascos&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;age&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">12</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">]</span>
</span></span></code></pre></div><p>And you have a <code>User</code> class:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">firstName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">lastName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">age</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">getName() {</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">firstName</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34; &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lastName</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">isAdult() {</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">age</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">36</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">age</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">60</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>You are assuming that you are downloading users of type <code>User</code> from <code>users.json</code> file and may want to write
following code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#000">fetch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users.json&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">users</span>: <span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">[])</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// you can use users here, and type hinting also will be available to you,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">//  but users are not actually instances of User class
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// this means that you can&#39;t use methods of User class
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>In this code you can use <code>users[0].id</code>, you can also use <code>users[0].firstName</code> and <code>users[0].lastName</code>.
However you cannot use <code>users[0].getName()</code> or <code>users[0].isAdult()</code> because &ldquo;users&rdquo; actually is
array of plain javascript objects, not instances of User object.
You actually lied to compiler when you said that its <code>users: User[]</code>.</p>
<p>So what to do? How to make a <code>users</code> array of instances of <code>User</code> objects instead of plain javascript objects?
Solution is to create new instances of User object and manually copy all properties to new objects.
But things may go wrong very fast once you have a more complex object hierarchy.</p>
<p>Alternatives? Yes, you can use class-transformer. Purpose of this library is to help you to map your plain javascript
objects to the instances of classes you have.</p>
<p>This library also great for models exposed in your APIs,
because it provides a great tooling to control what your models are exposing in your API.
Here is an example how it will look like:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#000">fetch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users.json&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">users</span>: <span style="color:#204a87;font-weight:bold">Object</span><span style="color:#000;font-weight:bold">[])</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">realUsers</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">plainToClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">users</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// now each user in realUsers is an instance of User class
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>Now you can use <code>users[0].getName()</code> and <code>users[0].isAdult()</code> methods.</p>
<h2 id="安装">安装</h2>
<h3 id="nodejs">Node.js</h3>
<ol>
<li>
<p>Install module:</p>
<p><code>npm install class-transformer --save</code></p>
</li>
<li>
<p><code>reflect-metadata</code> shim is required, install it too:</p>
<p><code>npm install reflect-metadata --save</code></p>
<p>and make sure to import it in a global place, like app.ts:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#4e9a06">&#34;reflect-metadata&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div></li>
<li>
<p>ES6 features are used, if you are using old version of node.js you may need to install es6-shim:</p>
<p><code>npm install es6-shim --save</code></p>
<p>and import it in a global place like app.ts:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#4e9a06">&#34;es6-shim&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div></li>
</ol>
<h3 id="浏览器">浏览器</h3>
<ol>
<li>
<p>Install module:</p>
<p><code>npm install class-transformer --save</code></p>
</li>
<li>
<p><code>reflect-metadata</code> shim is required, install it too:</p>
<p><code>npm install reflect-metadata --save</code></p>
<p>add <code>&lt;script&gt;</code> to reflect-metadata in the head of your <code>index.html</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">html</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">head</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">&lt;!-- ... --&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">script</span> <span style="color:#c4a000">src</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;node_modules/reflect-metadata/Reflect.js&#34;</span><span style="color:#000;font-weight:bold">&gt;&lt;/</span><span style="color:#204a87;font-weight:bold">script</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">&lt;/</span><span style="color:#204a87;font-weight:bold">head</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">&lt;!-- ... --&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;/</span><span style="color:#204a87;font-weight:bold">html</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>If you are using angular 2 you should already have this shim installed.</p>
</li>
<li>
<p>If you are using system.js you may want to add this into <code>map</code> and <code>package</code> config:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;map&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;node_modules/class-transformer&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;packages&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">&#34;main&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;index.js&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;defaultExtension&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;js&#34;</span> <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div></li>
</ol>
<h2 id="方法">方法</h2>
<h3 id="plaintoclass">plainToClass</h3>
<p>This method transforms a plain javascript object to instance of specific class.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">plainToClass</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">users</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">plainToClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">userJson</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// to convert user plain object a single user. also supports arrays
</span></span></span></code></pre></div><h3 id="plaintoclassfromexist">plainToClassFromExist</h3>
<p>This method transforms a plain object into an instance using an already filled Object which is an instance of the target class.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">defaultUser</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000">defaultUser</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">role</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;user&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">mixedUser</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">plainToClassFromExist</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">defaultUser</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// mixed user should have the value role = user when no value is set otherwise.
</span></span></span></code></pre></div><h3 id="classtoplain">classToPlain</h3>
<p>This method transforms your class object back to plain javascript object, that can be <code>JSON.stringify</code> later.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">classToPlain</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">photo</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">classToPlain</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">photo</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><h3 id="classtoclass">classToClass</h3>
<p>This method transforms your class object into a new instance of the class object.
This may be treated as deep clone of your objects.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">classToClass</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">photo</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">classToClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">photo</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>You can also use an <code>ignoreDecorators</code> option in transformation options to ignore all decorators you classes is using.</p>
<h3 id="serialize">serialize</h3>
<p>You can serialize your model right to json using <code>serialize</code> method:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">serialize</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">photo</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">serialize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">photo</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p><code>serialize</code> works with both arrays and non-arrays.</p>
<h3 id="deserialize-and-deserializearray">deserialize and deserializeArray</h3>
<p>You can deserialize your model from json using the <code>deserialize</code> method:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">deserialize</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">photo</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">deserialize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Photo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">photo</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>To make deserialization work with arrays, use the <code>deserializeArray</code> method:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">deserializeArray</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">photos</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">deserializeArray</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Photo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">photos</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><h2 id="执行类型安全的实例">执行类型安全的实例</h2>
<p>The default behaviour of the <code>plainToClass</code> method is to set <em>all</em> properties from the plain object,
even those which are not specified in the class.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">plainToClass</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">firstName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">lastName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">fromPlainUser</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">unkownProp</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;hello there&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">firstName</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Umed&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">lastName</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Khudoiberdiev&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plainToClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fromPlainUser</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// User {
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//   unkownProp: &#39;hello there&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//   firstName: &#39;Umed&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//   lastName: &#39;Khudoiberdiev&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// }
</span></span></span></code></pre></div><p>If this behaviour does not suit your needs, you can use the <code>excludeExtraneousValues</code> option
in the <code>plainToClass</code> method while <em>exposing all your class properties</em> as a requirement.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Expose</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">plainToClass</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Expose</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Expose</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">firstName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Expose</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">lastName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">fromPlainUser</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">unkownProp</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;hello there&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">firstName</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Umed&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">lastName</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Khudoiberdiev&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plainToClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fromPlainUser</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">excludeExtraneousValues</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">}));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// User {
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//   id: undefined,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//   firstName: &#39;Umed&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//   lastName: &#39;Khudoiberdiev&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// }
</span></span></span></code></pre></div><h2 id="使用嵌套对象">使用嵌套对象</h2>
<p>When you are trying to transform objects that have nested objects,
it&rsquo;s required to known what type of object you are trying to transform.
Since Typescript does not have good reflection abilities yet,
we should implicitly specify what type of object each property contain.
This is done using <code>@Type</code> decorator.</p>
<p>Lets say we have an album with photos.
And we are trying to convert album plain object to class object:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">plainToClass</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Album</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Photo</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">photos</span>: <span style="color:#204a87;font-weight:bold">Photo</span><span style="color:#000;font-weight:bold">[];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Photo</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">filename</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">album</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">plainToClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Album</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">albumJson</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// now album is Album object with Photo objects inside
</span></span></span></code></pre></div><h3 id="提供多个类型选项">提供多个类型选项</h3>
<p>In case the nested object can be of different types, you can provide an additional options object,
that specifies a discriminator. The discriminator option must define a <code>property</code> that holds the subtype
name for the object and the possible <code>subTypes</code> that the nested object can converted to. A sub type
has a <code>value</code>, that holds the constructor of the Type and the <code>name</code>, that can match with the <code>property</code>
of the discriminator.</p>
<p>Lets say we have an album that has a top photo. But this photo can be of certain different types.
And we are trying to convert album plain object to class object. The plain object input has to define
the additional property <code>__type</code>. This property is removed during transformation by default:</p>
<p><strong>JSON input</strong>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;topPhoto&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;filename&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;cool_wale.jpg&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;depth&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1245</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;__type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;underwater&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">plainToClass</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">abstract</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Photo</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">filename</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Landscape</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">Photo</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">panorama</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Portrait</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">Photo</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">person</span>: <span style="color:#204a87;font-weight:bold">Person</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UnderWater</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">Photo</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">depth</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Album</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Photo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">discriminator</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">property</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;__type&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">subTypes</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">value</span>: <span style="color:#204a87;font-weight:bold">Landscape</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;landscape&#34;</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">value</span>: <span style="color:#204a87;font-weight:bold">Portrait</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;portrait&#34;</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">value</span>: <span style="color:#204a87;font-weight:bold">UnderWater</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;underwater&#34;</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">topPhoto</span>: <span style="color:#204a87;font-weight:bold">Landscape</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">Portrait</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">UnderWater</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">album</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">plainToClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Album</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">albumJson</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// now album is Album object with a UnderWater object without `__type` property.
</span></span></span></code></pre></div><p>Hint: The same applies for arrays with different sub types. Moreover you can specify <code>keepDiscriminatorProperty: true</code>
in the options to keep the discriminator property also inside your resulting class.</p>
<h2 id="公开-getters-和方法返回值">公开 getters 和方法返回值</h2>
<p>You can expose what your getter or method return by setting an <code>@Expose()</code> decorator to those getters or methods:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Expose</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">firstName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">lastName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">password</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Expose</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">get</span> <span style="color:#000">name() {</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">firstName</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34; &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lastName</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Expose</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">getFullName() {</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">firstName</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34; &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lastName</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="公开具有不同名称的属性">公开具有不同名称的属性</h2>
<p>If you want to expose some of the properties with a different name,
you can do that by specifying a <code>name</code> option to <code>@Expose</code> decorator:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Expose</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Expose</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;uid&#34;</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">firstName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">lastName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Expose</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;secretKey&#34;</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">password</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Expose</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;fullName&#34;</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">getFullName() {</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">firstName</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34; &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lastName</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="跳过特定属性">跳过特定属性</h2>
<p>Sometimes you want to skip some properties during transformation.
This can be done using <code>@Exclude</code> decorator:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Exclude</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Exclude</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">password</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Now when you transform a User, the <code>password</code> property will be skipped and not be included in the transformed result.</p>
<h2 id="操作的跳过依赖关系">操作的跳过依赖关系</h2>
<p>You can control on what operation you will exclude a property. Use <code>toClassOnly</code> or <code>toPlainOnly</code> options:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Exclude</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Exclude</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">toPlainOnly</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">password</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Now <code>password</code> property will be excluded only during <code>classToPlain</code> operation. Vice versa, use the <code>toClassOnly</code> option.</p>
<h2 id="跳过类的所有属性">跳过类的所有属性</h2>
<p>You can skip all properties of the class, and expose only those are needed explicitly:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Exclude</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Expose</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Exclude</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Expose</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Expose</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">password</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Now <code>id</code> and <code>email</code> will be exposed, and password will be excluded during transformation.
Alternatively, you can set exclusion strategy during transformation:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">classToPlain</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">photo</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">classToPlain</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">photo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">strategy</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;excludeAll&#34;</span> <span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>In this case you don&rsquo;t need to <code>@Exclude()</code> a whole class.</p>
<h2 id="跳过私有属性或某些前缀属性">跳过私有属性或某些前缀属性</h2>
<p>If you name your private properties with a prefix, lets say with <code>_</code>,
then you can exclude such properties from transformation too:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">classToPlain</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">photo</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">classToPlain</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">photo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">excludePrefixes</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;_&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>This will skip all properties that start with <code>_</code> prefix.
You can pass any number of prefixes and all properties that begin with these prefixes will be ignored.
For example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Expose</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">classToPlain</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">_firstName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">_lastName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">_password</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">setName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">firstName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lastName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">_firstName</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">firstName</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">_lastName</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">lastName</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Expose</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">get</span> <span style="color:#000">name() {</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">_firstName</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34; &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">_lastName</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">setName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Johny&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Cage&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">_password</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;123&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">plainUser</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">classToPlain</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">excludePrefixes</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;_&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// here plainUser will be equal to
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// { id: 1, name: &#34;Johny Cage&#34; }
</span></span></span></code></pre></div><h2 id="使用组来控制排除的属性">使用组来控制排除的属性</h2>
<p>You can use groups to control what data will be exposed and what will not be:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Exclude</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Expose</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">classToPlain</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Expose</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">groups</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;user&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;admin&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#8f5902;font-style:italic">// this means that this data will be exposed only to users and admins
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Expose</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">groups</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;user&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#8f5902;font-style:italic">// this means that this data will be exposed only to users
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">password</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">user1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">classToPlain</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">groups</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;user&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// will contain id, name, email and password
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">user2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">classToPlain</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">groups</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;admin&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// will contain id, name and email
</span></span></span></code></pre></div><h2 id="使用版本控制来控制公开的和被排除的属性">使用版本控制来控制公开的和被排除的属性</h2>
<p>If you are building an API that has different versions, class-transformer has extremely useful tools for that.
You can control which properties of your model should be exposed or excluded in what version. Example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Exclude</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Expose</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">classToPlain</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Expose</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">since</span>: <span style="color:#204a87;font-weight:bold">0.7</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">until</span>: <span style="color:#204a87;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#8f5902;font-style:italic">// this means that this property will be exposed for version starting from 0.7 until 1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Expose</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">since</span>: <span style="color:#204a87;font-weight:bold">2.1</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#8f5902;font-style:italic">// this means that this property will be exposed for version starting from 2.1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">password</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">user1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">classToPlain</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">version</span>: <span style="color:#204a87;font-weight:bold">0.5</span> <span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// will contain id and name
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">user2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">classToPlain</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">version</span>: <span style="color:#204a87;font-weight:bold">0.7</span> <span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// will contain id, name and email
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">user3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">classToPlain</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">version</span>: <span style="color:#204a87;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// will contain id and name
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">user4</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">classToPlain</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">version</span>: <span style="color:#204a87;font-weight:bold">2</span> <span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// will contain id and name
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">user5</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">classToPlain</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">version</span>: <span style="color:#204a87;font-weight:bold">2.1</span> <span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// will contain id, name and password
</span></span></span></code></pre></div><h2 id="сonverting-日期字符串到日期对象">Сonverting 日期字符串到日期对象</h2>
<p>Sometimes you have a Date in your plain javascript object received in a string format.
And you want to create a real javascript Date object from it.
You can do it simply by passing a Date object to the <code>@Type</code> decorator:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">password</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#204a87">Date</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">registrationDate</span>: <span style="color:#204a87;font-weight:bold">Date</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Same technique can be used with <code>Number</code>, <code>String</code>, <code>Boolean</code>
primitive types when you want to convert your values into these types.</p>
<h2 id="使用数组">使用数组</h2>
<p>When you are using arrays you must provide a type of the object that array contains.
This type, you specify in a <code>@Type()</code> decorator:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Photo</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Album</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">albums</span>: <span style="color:#204a87;font-weight:bold">Album</span><span style="color:#000;font-weight:bold">[];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>You can also use custom array types:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">AlbumCollection</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#204a87">Array</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Album</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// custom array functions ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Photo</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Album</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">albums</span>: <span style="color:#204a87;font-weight:bold">AlbumCollection</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Library will handle proper transformation automatically.</p>
<p>ES6 collections <code>Set</code> and <code>Map</code> also require the <code>@Type</code> decorator:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Skill</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Weapon</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">range</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Player</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Skill</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">skills</span>: <span style="color:#204a87;font-weight:bold">Set</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Skill</span><span style="color:#000;font-weight:bold">&gt;;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Weapon</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">weapons</span>: <span style="color:#204a87;font-weight:bold">Map</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#a40000">,</span> <span style="color:#c4a000">Weapon</span><span style="color:#000;font-weight:bold">&gt;;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="额外的数据转换">额外的数据转换</h2>
<h3 id="基本用法">基本用法</h3>
<p>You can perform additional data transformation using <code>@Transform</code> decorator.
For example, you want to make your <code>Date</code> object to be a <code>moment</code> object when you are
transforming object from plain to class:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Transform</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">moment</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;moment&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Moment</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;moment&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Photo</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#204a87">Date</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">moment</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">toClassOnly</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">date</span>: <span style="color:#204a87;font-weight:bold">Moment</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Now when you call <code>plainToClass</code> and send a plain representation of the Photo object,
it will convert a date value in your photo object to moment date.
<code>@Transform</code> decorator also supports groups and versioning.</p>
<h3 id="高级用法">高级用法</h3>
<p>The <code>@Transform</code> decorator is given more arguments to let you configure how you want the transformation to be done.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><table>
<thead>
<tr>
<th>Argument</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>value</code></td>
<td>The property value before the transformation.</td>
</tr>
<tr>
<td><code>key</code></td>
<td>The name of the transformed property.</td>
</tr>
<tr>
<td><code>obj</code></td>
<td>The transformation source object.</td>
</tr>
<tr>
<td><code>type</code></td>
<td>The transformation type.</td>
</tr>
<tr>
<td><code>options</code></td>
<td>The options object passed to the transformation method.</td>
</tr>
</tbody>
</table>
<h2 id="其他修饰符">其他修饰符</h2>
<table>
<thead>
<tr>
<th>Signature</th>
<th>Example</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>@TransformClassToPlain</code></td>
<td><code>@TransformClassToPlain({ groups: [&quot;user&quot;] })</code></td>
<td>Transform the method return with classToPlain and expose the properties on the class.</td>
</tr>
<tr>
<td><code>@TransformClassToClass</code></td>
<td><code>@TransformClassToClass({ groups: [&quot;user&quot;] })</code></td>
<td>Transform the method return with classToClass and expose the properties on the class.</td>
</tr>
<tr>
<td><code>@TransformPlainToClass</code></td>
<td><code>@TransformPlainToClass(User, { groups: [&quot;user&quot;] })</code></td>
<td>Transform the method return with plainToClass and expose the properties on the class.</td>
</tr>
</tbody>
</table>
<p>The above decorators accept one optional argument:
ClassTransformOptions - The transform options like groups, version, name</p>
<p>An example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Exclude</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Expose</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">firstName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Expose</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">lastName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Expose</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">groups</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;user.email&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">password</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UserController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@TransformClassToPlain</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">groups</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;user.email&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">getUser() {</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">firstName</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;Snir&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lastName</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;Segal&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">password</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;imnosuperman&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">controller</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">UserController</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getUser</span><span style="color:#000;font-weight:bold">();</span>
</span></span></code></pre></div><p>the <code>user</code> variable will contain only firstName,lastName, email properties because they are
the exposed variables. email property is also exposed because we metioned the group &ldquo;user.email&rdquo;.</p>
<h2 id="使用泛型">使用泛型</h2>
<p>Generics are not supported because TypeScript does not have good reflection abilities yet.
Once TypeScript team provide us better runtime type reflection tools, generics will be implemented.
There are some tweaks however you can use, that maybe can solve your problem.
<a href="https://github.com/pleerock/class-transformer/tree/master/sample/sample4-generics">Checkout this example.</a></p>
<h2 id="隐式类型转换">隐式类型转换</h2>
<blockquote>
<p><strong>NOTE</strong> If you use class-validator together with class-transformer you propably DON&rsquo;T want to enable this function.</p>
</blockquote>
<p>Enables automatic conversion between built-in types based on type information provided by Typescript. Disabled by default.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">IsString</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">MyPayload</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsString</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">prop</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">result1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">plainToClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">MyPayload</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">prop</span>: <span style="color:#204a87;font-weight:bold">1234</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">enableImplicitConversion</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">result2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">plainToClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">MyPayload</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">prop</span>: <span style="color:#204a87;font-weight:bold">1234</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">enableImplicitConversion</span>: <span style="color:#204a87;font-weight:bold">false</span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *  result1 will be `{ prop: &#34;1234&#34; }` - notice how the prop value has been converted to string.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *  result2 will be `{ prop: 1234 }` - default behaviour
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> */</span>
</span></span></code></pre></div><h2 id="它如何处理循环引用">它如何处理循环引用?</h2>
<p>Circular references are ignored.
For example, if you are transforming class <code>User</code> that contains property <code>photos</code> with type of <code>Photo</code>,
and <code>Photo</code> contains link <code>user</code> to its parent <code>User</code>, then <code>user</code> will be ignored during transformation.
Circular references are not ignored only during <code>classToClass</code> operation.</p>
<h2 id="例子与-angular2">例子与 Angular2</h2>
<p>Lets say you want to download users and want them automatically to be mapped to the instances of <code>User</code> class.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">plainToClass</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">http</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users.json&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">json</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">plainToClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">res</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#204a87">Object</span><span style="color:#000;font-weight:bold">[]))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">subscribe</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">users</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// now &#34;users&#34; is type of User[] and each user has getName() and isAdult() methods available
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">users</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>You can also inject a class <code>ClassTransformer</code> as a service in <code>providers</code>, and use its methods.</p>
<p>Example how to use with angular 2 in <a href="http://plnkr.co/edit/Mja1ZYAjVySWASMHVB9R">plunker</a>.
Source code is <a href="https://github.com/pleerock/class-transformer-demo">here</a>.</p>
<h2 id="样品">样品</h2>
<p>Take a look on samples in <a href="https://github.com/pleerock/class-transformer/tree/master/sample">./sample</a> for more examples of
usages.</p>
<h2 id="发布说明">发布说明</h2>
<p>See information about breaking changes and release notes <a href="https://github.com/typestack/class-transformer/blob/master/CHANGELOG.md">here</a>.</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-90df5218158c4d01fc01a3fa3bcb9ad2">2 - mongodb</h1>
    
	<blockquote>
<p><a href="https://wanago.io/courses/api-with-nestjs/">https://wanago.io/courses/api-with-nestjs/</a></p>
</blockquote>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-01b5b2f53d9dc7fe8db92e39696e08bb">2.1 - MongoDB与Mongoose使用PUT vs PATCH</h1>
    
	<blockquote>
<p><a href="https://wanago.io/2020/04/27/typescript-express-put-vs-patch-mongodb-mongoose/">https://wanago.io/2020/04/27/typescript-express-put-vs-patch-mongodb-mongoose/</a></p>
</blockquote>
<p>当我们开发 REST API 时，我们有一组可以选择的 HTTP 方法。
需要理解的一件重要事情是，HTTP 方法在很大程度上是动作的指示器。
因此，让它们正常工作是我们的工作。
从理论上讲，没有太多东西阻止我们使用 GET 方法删除实体。
通过注意保持约定，我们提高了 API 的可读性，并使其可预测。</p>
<p>大多数 HTTP 方法相当简单。
不过，在 Mongoose with Express 中，PUT 和 PATCH 方法可能会造成一些误解。
在这篇文章中，我们比较它们，并检查如何在 MongoDB 与 Mongoose 中实现它们。</p>
<p>本系列文章的结果就是这个<a href="https://github.com/mwanago/express-typescript">存储库</a>。
给它打个星吧。</p>
<h2 id="put">PUT</h2>
<p>PUT 方法在 HTTP 协议中已经存在很长时间了。
它的主要职责是修改现有实体。</p>
<p>关于 PUT 最重要的一点是，它替换了实体。
如果我们不包含实体包含的属性，则应该删除它</p>
<p>GET /posts/5cf96275ff8ecf065c510468</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;_id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;5cf96275ff8ecf065c510468&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;title&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Lorem ipsum&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;content&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Dolor sit amet&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;author&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;5cf96217ff8ecf065c510467&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>正如您在上面看到的，这篇文章包含了相当多的属性。
让我们发送一个 PUT 请求的示例:</p>
<p>PUT /posts/5cf96275ff8ecf065c510468</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;_id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;5cf96275ff8ecf065c510468&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;title&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;A brand new title&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;content&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Dolor sit amet&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;author&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;5cf96217ff8ecf065c510467&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>如您所见，我们已经更改了 title 属性。
我们还包括了所有其他字段，比如内容和作者。
让我们发送另一个 PUT 请求:</p>
<p>PUT /posts/5cf96275ff8ecf065c510468</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;content&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;A brand new content&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>这个请求应该删除所有其他属性，只留下内容。</p>
<h3 id="mongodb-和-mongoose-使用-put">MongoDB 和 Mongoose 使用 PUT</h3>
<p>上述情况与 MongoDB 和 Mongoose 并不完全相同。
它不允许我们删除或更改<code>_id</code>。</p>
<p>为了用 MongoDB 和 Mongoose 实现一个正确的 PUT，我们需要一种方法来替换文档而不是更新它。
最常用的修改实体的方法之一是 <code>findByIdAndUpdate</code> 和 <code>findOneAndUpdate</code> 。
不幸的是，它们的默认行为不是替换文档，而是对文档执行部分更新。
因此，如果我们不传递属性，它就不会从实体中移除它。</p>
<p>实现所需行为的一种方法是使用 <code>replaceOne</code> 方法。
顾名思义，它取代了整个文档—这正是我们所需要的。</p>
<p>replaceOne 方法的结果包含 <code>n</code> 属性，该属性描述匹配过滤器的文档数量。
如果没有找到，则可以假定具有给定 <code>id</code> 的实体不存在。</p>
<p>不幸的是，结果不包含修改后的文档，因此我们需要使用 <code>findById</code> 函数查找文档并将其发送回来。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">demo</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">initializeRoutes() {</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">router</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`</span><span style="color:#4e9a06">${</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">path</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">/:id`</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">modifyPost</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">modifyPost</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span>: <span style="color:#204a87;font-weight:bold">Request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">response</span>: <span style="color:#204a87;font-weight:bold">Response</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">next</span>: <span style="color:#204a87;font-weight:bold">NextFunction</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">id</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">params</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">postData</span>: <span style="color:#204a87;font-weight:bold">Post</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">body</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">modificationResult</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">replaceOne</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">id</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#000">postData</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">modificationResult</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">modifiedPost</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findById</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">send</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">modifiedPost</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">next</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">PostNotFoundException</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>使用 <code>findOneAndReplace</code> 函数可以解决上述困难。
不幸的是，<code>@types/mongoose</code> 包缺少 <code>findOneAndReplace</code> 方法的 TypeScript 定义。</p>
<p>不过，我们还是做了一些努力来添加它。
如果最后定稿，我将更新这篇文章。</p>
<p>尽管文档目前没有提到这一点，但我们也可以将 <code>overwrite: true</code> 选项传递给 <code>findByIdAndUpdate</code> 和 <code>findOneAndUpdate。</code>
因此，它将替换整个文档，而不是执行部分更新。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">demo</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">modifyPost</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span>: <span style="color:#204a87;font-weight:bold">Request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">response</span>: <span style="color:#204a87;font-weight:bold">Response</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">next</span>: <span style="color:#204a87;font-weight:bold">NextFunction</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">id</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">params</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">postData</span>: <span style="color:#204a87;font-weight:bold">Post</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">body</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">post</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findByIdAndUpdate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">postData</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">setOptions</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#204a87;font-weight:bold">new</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">overwrite</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">send</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">next</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">PostNotFoundException</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="使用-put-创建新实体">使用 PUT 创建新实体</h3>
<p>该规范还提到，如果没有找到所需的实体，我们可以使用 PUT 创建一个新实体。
我们将这种行为称为 upsert。</p>
<p>Mongoose 通过允许我们将 upsert 选项传递给 replaceOne 查询来支持它。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">demo</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">modifyPost</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span>: <span style="color:#204a87;font-weight:bold">Request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">response</span>: <span style="color:#204a87;font-weight:bold">Response</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">next</span>: <span style="color:#204a87;font-weight:bold">NextFunction</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">id</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">params</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">postData</span>: <span style="color:#204a87;font-weight:bold">Post</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">body</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">modificationResult</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">replaceOne</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">id</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#000">postData</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">setOptions</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">upsert</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">modificationResult</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">resultId</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">modificationResult</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">upserted</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">.[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">_id</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">modifiedPost</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findById</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resultId</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">send</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">modifiedPost</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">next</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">PostNotFoundException</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>如果 <code>modiationresult.upserted</code> 数组中有一个元素，我们将查找具有新 id 的实体。
否则，我们使用用户提供的标识符。</p>
<h2 id="patch">PATCH</h2>
<p>PUT 方法可能并不总是更新实体的最佳选择。
它假设用户知道特定实体的所有细节，但情况并非总是如此。
解决这个问题的方法可能是 PATCH 方法。</p>
<p>PATCH 在 2010 年的 RFC 5789 中被引入到 HTTP 协议中。
它的目的是对资源应用部分修改。
我们应该将 PATCH 视为一组关于如何修改资源的指令。</p>
<p>为 PATCH 方法实现处理程序的最直接方法是期望一个包含部分实体的主体。</p>
<p>PATCH /posts/5cf96275ff8ecf065c510468</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;content&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;A brand new content&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>上面的代码应该用新的内容修改实体。
与 PUT 相反，我们不应该删除其余的属性。</p>
<h3 id="mongodb-和-mongoose-使用-patch">MongoDB 和 Mongoose 使用 PATCH</h3>
<p><code>findByIdAndUpdate</code> 方法非常适合实现 <code>PATCH</code> 方法。
我们将在本系列的第二部分中提到它。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">demo</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">initializeRoutes() {</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">router</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">patch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`</span><span style="color:#4e9a06">${</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">path</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">/:id`</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">modifyPost</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">modifyPost</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span>: <span style="color:#204a87;font-weight:bold">Request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">response</span>: <span style="color:#204a87;font-weight:bold">Response</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">next</span>: <span style="color:#204a87;font-weight:bold">NextFunction</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">id</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">params</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">postData</span>: <span style="color:#204a87;font-weight:bold">Post</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">body</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">post</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findByIdAndUpdate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">postData</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">new</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">send</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">next</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">PostNotFoundException</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>由于传递了 <code>new:true</code> 选项，我们的查询会得到实体的更新版本。
因此，我们可以在响应中毫不费力地将其发送回。</p>
<p>如果在传递给 <code>findByIdAndUpdate</code> 函数的数据中，我们包括一个不同的<code>_id</code>, Mongoose 抛出一个错误。</p>
<p>如果我们在使用 <code>findByIdAndUpdate</code> 执行 <code>PATCH</code> 时想要删除属性，我们必须显式地发送 null。</p>
<h3 id="json-patch">JSON Patch</h3>
<p>实现 PATCH 方法的另一种方法是发送一组关于如何修改资源的指令。
您可以使用 JSON Patch 格式来定义一个 Patch 操作数组。</p>
<p>PATCH /posts/5cf96275ff8ecf065c510468</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;op&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;replace&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;path&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;/content&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;value&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;A brand new content&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">]</span>
</span></span></code></pre></div><p>我们可以在这里找到 JSON Patch 格式的文档。
还有 <code>fastjson -patch</code> 实用程序，可以帮助您创建和读取此类 Patch。</p>
<h2 id="总结">总结</h2>
<p>在本文中，我们介绍了实现更新功能的可能方法。
在选择 PUT 和 PATCH 时，我们需要考虑在你的具体情况下，什么是最好的选择。
无论我们决定什么，一旦我们决定了一种方法，我们就需要对它们进行适当的编码。
在这样做时，我们需要考虑规范中如何定义 PATCH 和 PUT 方法，并相应地实现它们。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ee82b5a9ba57222a5fbfd0b80a49cfa9">2.2 - MongoDB概论</h1>
    
	<p>到目前为止，在本系列文章中，我们主要讨论如何使用 SQL 和 Postgres 数据库。
虽然 PostgreSQL 是一个很好的选择，但它值得一试。
在本文中，我们将了解 MongoDB 是如何工作的，以及它与 SQL 数据库的区别。
我们还使用 MongoDB 和 NestJS 创建了一个简单的应用程序。</p>
<p>您可以从下面的文章中在这个存储库中找到源代码。</p>
<h2 id="mongodb-vs-sql-databases">MongoDB vs. SQL Databases</h2>
<p>MongoDB 的设计原则与传统的 SQL 数据库有很大的不同。
MongoDB 没有使用表和行来表示数据，而是将其存储为类似 json 的文档。
因此，熟悉 JavaScript 的开发人员比较容易掌握。</p>
<p>MongoDB 中的文档由键和值对组成。
它们的重要方面是，在给定集合中的文档中键可以不同。
这是 MongoDB 和 SQL 数据库之间的一个很大的区别。
它使 MongoDB 更加灵活，结构更松散。
因此，它既可以被视为优点，也可以被视为缺点。</p>
<h2 id="mongodb-的优点和缺点">MongoDB 的优点和缺点</h2>
<p>Since MongoDB and SQL databases differ so much, choosing the right tool for a given job is crucial.
Since NoSQL databases put fewer restrictions on the data, it might be a good choice for an application evolving quickly.
We still might need to update our data as our schema changes.</p>
<p>For example, we might want to add a new property containing the user’s avatar URL.
When it happens, we still should deal with documents not containing our new property.
We can do that by writing a script that puts a default value for old documents.
Alternatively, we can assume that this field can be missing and handle it differently on the application level.</p>
<p>On the contrary, adding a new property to an existing SQL database requires writing a migration that explicitly handles the new property.
This might seem like a bit of a chore in a lot of cases.
However, with MongoDB, it is not required.
This might make the work easier and faster, but we need to watch out and not lose the integrity of our data.</p>
<p>If you want to know more about SQL migrations, check out The basics of migrations using TypeORM and Postgres</p>
<p>SQL databases such as Postgres keep the data in tables consisting of columns and rows.
A big part of the design process is defining relationships between the above tables.
For example, a user can be an author of an article.
On the other hand, MongoDB is a non-relational database.
Therefore, while we can mimic SQL-style relationships with MongoDB, they will not be as efficient and foolproof.</p>
<h2 id="using-mongodb-with-nestjs">Using MongoDB with NestJS</h2>
<p>So far, in this series, we’ve used Docker to set up the architecture for our project.
We can easily achieve that with MongoDB also.</p>
<p>docker-compose.yml</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;3&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">services</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">mongo</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mongo:latest</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">environment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">MONGO_INITDB_ROOT_USERNAME</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">${MONGO_USERNAME}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">MONGO_INITDB_ROOT_PASSWORD</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">${MONGO_PASSWORD}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">MONGO_INITDB_DATABASE</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">${MONGO_DATABASE}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>- <span style="color:#4e9a06">&#39;27017:27017&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Above, you can see that we refer to a few variables.
Let’s put them into our .env file:</p>
<p>.env</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-env" data-lang="env"><span style="display:flex;"><span><span style="color:#000">MONGO_USERNAME</span><span style="color:#ce5c00;font-weight:bold">=</span>admin
</span></span><span style="display:flex;"><span><span style="color:#000">MONGO_PASSWORD</span><span style="color:#ce5c00;font-weight:bold">=</span>admin
</span></span><span style="display:flex;"><span><span style="color:#000">MONGO_DATABASE</span><span style="color:#ce5c00;font-weight:bold">=</span>nestjs
</span></span><span style="display:flex;"><span><span style="color:#000">MONGO_HOST</span><span style="color:#ce5c00;font-weight:bold">=</span>localhost:27017
</span></span></code></pre></div><p>In the previous parts of this series, we’ve used TypeORM to connect to our PostgreSQL database and manage our data.
For MongoDB, the most popular library is Mongoose.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>npm install --save @nestjs/mongoose mongoose
</span></span></code></pre></div><p>Let’s use Mongoose to connect to our database.
To do that, we need to define a URI connection string:</p>
<p>app.module.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Module</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">MongooseModule</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ConfigModule</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ConfigService</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/config&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostsModule</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./posts/posts.module&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">Joi</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@hapi/joi&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Module</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">imports</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ConfigModule</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">forRoot</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">validationSchema</span>: <span style="color:#204a87;font-weight:bold">Joi.object</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">MONGO_USERNAME</span>: <span style="color:#204a87;font-weight:bold">Joi.string</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">required</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">MONGO_PASSWORD</span>: <span style="color:#204a87;font-weight:bold">Joi.string</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">required</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">MONGO_DATABASE</span>: <span style="color:#204a87;font-weight:bold">Joi.string</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">required</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">MONGO_PATH</span>: <span style="color:#204a87;font-weight:bold">Joi.string</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">required</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">MongooseModule</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">forRootAsync</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">imports</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">ConfigModule</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">useFactory</span>: <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">configService</span>: <span style="color:#204a87;font-weight:bold">ConfigService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">username</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">configService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;MONGO_USERNAME&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">password</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">configService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;MONGO_PASSWORD&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">database</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">configService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;MONGO_DATABASE&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">host</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">configService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;MONGO_HOST&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">uri</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">`mongodb://</span><span style="color:#4e9a06">${</span><span style="color:#000">username</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">:</span><span style="color:#4e9a06">${</span><span style="color:#000">password</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">@</span><span style="color:#4e9a06">${</span><span style="color:#000">host</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dbName</span>: <span style="color:#204a87;font-weight:bold">database</span> <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">inject</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">ConfigService</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">PostsModule</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">controllers</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[],</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">providers</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[],</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">AppModule</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span></code></pre></div><h2 id="保存和检索数据">保存和检索数据</h2>
<p>With MongoDB, we operate on documents grouped into collections.
To start saving and retrieving data with MongoDB and Mongoose, we first need to define a schema.
This might seem surprising at first because MongoDB is considered schemaless.
Even though MongoDB is flexible, Mongoose uses schemas to operate on collections and define their shape.</p>
<h2 id="定义一个模式">定义一个模式</h2>
<p>每个模式映射到一个 MongoDB 集合。
它还定义了其中文档的形状。</p>
<p>post.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PostDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Post</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">content</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">PostSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>使用<code>@Schema()</code>装饰器，我们可以将类标记为模式定义，并将其映射到 MongoDB 集合。
我们使用<code>@Prop()</code>装饰器来确定文档的属性。
多亏了 TypeScript 元数据，我们的属性的模式类型是自动推断出来的。</p>
<p>我们将在后续文章中展开定义模式的主题。</p>
<h2 id="使用模型">使用模型</h2>
<p>Mongoose 将我们的模式包装成模型。
我们可以使用它们来创建和读取文档。
为了让我们的服务使用模型，我们需要将其添加到我们的模块中。</p>
<p>posts.module.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Module</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">MongooseModule</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostsController</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./posts.controller&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostsService</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./posts.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostSchema</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Module</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">imports</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">MongooseModule</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">forFeature</span><span style="color:#000;font-weight:bold">([{</span> <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">Post.name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">schema</span>: <span style="color:#204a87;font-weight:bold">PostSchema</span> <span style="color:#000;font-weight:bold">}])],</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">controllers</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">PostsController</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">providers</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsModule</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostsModule</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>我们还需要将模型注入到我们的服务中:</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>一旦我们这样做了，我们就可以开始与我们的收藏进行交互了。</p>
<h2 id="获取所有实体">获取所有实体</h2>
<p>我们能做的最基本的事情是获取所有文档的列表。
为此，我们需要<code>find()</code>方法:</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">findAll() {</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">find</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="获取单个实体">获取单个实体</h2>
<p>Every document we create is assigned with a string id.
If we want to fetch a single document, we can use the findById method:</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">NotFoundException</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">findOne</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">post</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findById</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">NotFoundException</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">post</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="创建实体">创建实体</h2>
<p>In the fourth part of this series, we’ve tackled data validation.
Let’s create a Data Transfer Object for our entity.</p>
<p>post.dto.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">IsString</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">IsNotEmpty</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostDto</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsString</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsNotEmpty</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsString</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsNotEmpty</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">content</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostDto</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>We can now use it when creating a new instance of our model and saving it.</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostDto</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./dto/post.dto&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">postData</span>: <span style="color:#204a87;font-weight:bold">PostDto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">createdPost</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">postData</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">createdPost</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">save</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="更新实体">更新实体</h2>
<p>We might also need to update an entity we’ve already created.
To do that, we can use the findByIdAndUpdate method:</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">NotFoundException</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostDto</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./dto/post.dto&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">postData</span>: <span style="color:#204a87;font-weight:bold">PostDto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">post</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findByIdAndUpdate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">postData</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">setOptions</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">overwrite</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">new</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">NotFoundException</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">post</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Above, a few important things are happening.
Thanks to using the new: true parameter, the findByIdAndUpdate method returns an updated version of our entity.</p>
<p>By using overwrite: true, we indicate that we want to replace a whole document instead of performing a partial update.
This is what differentiates the PUT and PATCH HTTP methods.</p>
<p>If you want to know more, check out TypeScript Express tutorial #15.
Using PUT vs PATCH in MongoDB with Mongoose.</p>
<h2 id="删除实体">删除实体</h2>
<p>To delete an existing entity, we need to use the findByIdAndDelete method:</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">NotFoundException</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">postId</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findByIdAndDelete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">postId</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">NotFoundException</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="定义一个控制器">定义一个控制器</h2>
<p>一旦我们的服务启动并运行，我们就可以在控制器中使用它:</p>
<p>posts.controller.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Body</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Get</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Param</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Put</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostsService</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./posts.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">ParamsWithId</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../utils/paramsWithId&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostDto</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./dto/post.dto&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Controller</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;posts&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">postsService</span>: <span style="color:#204a87;font-weight:bold">PostsService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Get</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">getAllPosts() {</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findAll</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;:id&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">getPost</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Param</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span> <span style="color:#000;font-weight:bold">}</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">ParamsWithId</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findOne</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Post</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">createPost</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Body</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">post</span>: <span style="color:#204a87;font-weight:bold">PostDto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;:id&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">deletePost</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Param</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span> <span style="color:#000;font-weight:bold">}</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">ParamsWithId</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;:id&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">updatePost</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Param</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span> <span style="color:#000;font-weight:bold">}</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">ParamsWithId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">@Body</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">post</span>: <span style="color:#204a87;font-weight:bold">PostDto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">post</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>上面的关键部分是我们已经定义了 ParamsWithId 类。
使用它，我们可以验证提供的字符串是否是一个有效的 MongoDB id:</p>
<p>paramsWithId.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">IsMongoId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">ParamsWithId</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsMongoId</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">ParamsWithId</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><h2 id="summary">Summary</h2>
<p>In this article, we’ve learned the very basics of how to use MongoDB with NestJS.
To do that, we’ve created a local MongoDB database using Docker Compose and connected it with NestJS and Mongoose.
To better grasp MongoDB, we’ve also compared it to SQL databases such as Postgres.
There are still a lot of things to cover when it comes to MongoDB, so stay tuned!</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-dcc33887b60b5620de8e60d4faae18bc">2.3 - 实现与MongoDB的关系</h1>
    
	<p>An essential thing about MongoDB is that it is non-relational. Therefore, it might not be the best fit if relationships are a big part of our database design. That being said, we definitely can mimic SQL-style relations by using references of embedding documents directly.</p>
<p>You can get all of the code from this article in this repository.</p>
<h2 id="定义初始模式">定义初始模式</h2>
<p>In this article, we base the code on many of the functionalities we’ve implemented in the previous parts of this series. If you want to know how we register and authenticate users, check out API with NestJS #3. Authenticating users with bcrypt, Passport, JWT, and cookies.</p>
<p>Let’s start by defining a schema for our users.</p>
<p>user.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Exclude</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Transform</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">UserDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">User</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#204a87;font-weight:bold">unique</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Exclude</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">password</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">UserSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>A few significant things are happening above. We use unique: true above to make sure that all users have unique emails. It sets up unique indexes under the hood and deserves a separate article.</p>
<p>The @Exclude and @Transform decorators come from the class-transformer library. We cover serialization in more detail in API with NestJS #5. Serializing the response with interceptors. There is a significant catch here with MongoDB and Mongoose, though.</p>
<p>The Mongoose library that we use for connecting to MongoDB and fetching entities does not return instances of our User class. Therefore, the ClassSerializerInterceptor won’t work out of the box. Let’s change it a bit using the mixin pattern.</p>
<p>mongooseClassSerializer.interceptor.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ClassSerializerInterceptor</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PlainLiteralObject</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ClassTransformOptions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">plainToClass</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">MongooseClassSerializerInterceptor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">classToIntercept</span>: <span style="color:#204a87;font-weight:bold">Type</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">ClassSerializerInterceptor</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Interceptor</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">ClassSerializerInterceptor</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">changePlainObjectToClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">document</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">PlainLiteralObject</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">document</span> <span style="color:#204a87;font-weight:bold">instanceof</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">document</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">plainToClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">classToIntercept</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">document</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toJSON</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">prepareResponse</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span>: <span style="color:#204a87;font-weight:bold">PlainLiteralObject</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">PlainLiteralObject</span><span style="color:#000;font-weight:bold">[])</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">Array</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isArray</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">changePlainObjectToClass</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">changePlainObjectToClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">serialize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span>: <span style="color:#204a87;font-weight:bold">PlainLiteralObject</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">PlainLiteralObject</span><span style="color:#000;font-weight:bold">[],</span> <span style="color:#000">options</span>: <span style="color:#204a87;font-weight:bold">ClassTransformOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">super</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serialize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">prepareResponse</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">MongooseClassSerializerInterceptor</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>I wrote the above code with the help of Jay McDoniel. The official NestJS discord is a great place to ask for tips.</p>
<p>Above, we change MongoDB documents into instances of the provided class. Let’s use it with our controller:</p>
<p>authentication.controller.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Body</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UseInterceptors</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AuthenticationService</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./authentication.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">RegisterDto</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./dto/register.dto&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../users/user.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">MongooseClassSerializerInterceptor</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../utils/mongooseClassSerializer.interceptor&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Controller</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;authentication&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@UseInterceptors</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">MongooseClassSerializerInterceptor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">AuthenticationController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">authenticationService</span>: <span style="color:#204a87;font-weight:bold">AuthenticationService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Post</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;register&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">register</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Body</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">registrationData</span>: <span style="color:#204a87;font-weight:bold">RegisterDto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">authenticationService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">register</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">registrationData</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Thanks to doing the above, we exclude the password when returning the data of the user.</p>
<h2 id="一对一">一对一</h2>
<p>With the one-to-one relationship, the document in the first collection has just one matching document in the second collection and vice versa. Let’s create a schema for the address:</p>
<p>address.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Transform</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">AddressDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Address</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Address</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">city</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">street</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">AddressSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Address</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>There is a big chance that just one user is assigned to a particular address in our application. Therefore, it is a good example of a one-to-one relationship. Because of that, we can take advantage of embedding documents, which is an approach very good performance-wise.</p>
<p>For it to work properly, we need to explicitly pass AddressSchema to the @Prop decorator:</p>
<p>user.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ObjectId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Exclude</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Transform</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Address</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">AddressSchema</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./address.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">UserDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">User</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">ObjectId</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#204a87;font-weight:bold">unique</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Exclude</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">password</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">AddressSchema</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Address</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">address</span>: <span style="color:#204a87;font-weight:bold">Address</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">UserSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>We use @Type(() =&gt; Address) above to make sure that the class-transformer transforms the Address object too.</p>
<p>When we create the document for the user, MongoDB also creates the document for the address. It also gives it a distinct id.</p>
<p>In our one-to-one relationship example, the user has just one address. Also, one address belongs to only one user. Since that’s the case, it makes sense to embed the user straight into the user’s document. This way, MongoDB can return it fast. Let’s use MongoDB Compass to make sure that this is the case here.</p>
<h2 id="一对多">一对多</h2>
<p>We implement the one-to-many and many-to-one relationships when a document from the first collection can be linked to multiple documents from the second collection. Documents from the second collection can be linked to just one document from the first collection.</p>
<p>Great examples are posts and authors where the user can be an author of multiple posts. In our implementation, the post can only have one author, though.</p>
<p>post.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ObjectId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">mongoose</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../users/user.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Transform</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PostDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Post</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">ObjectId</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">content</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">mongoose</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ref</span>: <span style="color:#204a87;font-weight:bold">User.name</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">author</span>: <span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">PostSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>Thanks to defining the above reference, we can now assign the user to the author property in the post.</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostDto</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./dto/post.dto&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../users/user.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">postData</span>: <span style="color:#204a87;font-weight:bold">PostDto</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">author</span>: <span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">createdPost</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">...</span><span style="color:#000">postData</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">author</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">createdPost</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">save</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><h3 id="使用-mongoose-填充数据">使用 Mongoose 填充数据</h3>
<p>Saving the posts like that results in storing the id of the author in the database.</p>
<p>A great thing about it is that we can easily replace the id with the actual data using the populate function Mongoose provides.</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">findAll() {</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">find</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;author&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>Doing the above results in Mongoose returning the data of the author along with the post.</p>
<h3 id="参考点的方向">参考点的方向</h3>
<p>In the code above, we store the id of the author in the document of the post.
We could do that the other way around and store the posts’ id in the author’s document.
When deciding that, we need to take a few factors into account.</p>
<p>First, we need to think of how many references we want to store.
Imagine a situation where we want to store logs for different machines in our server room. We need to remember that the maximum size of a MongoDB document is 16MB.
If we store an array of the ids of the Log document in the Machine document, in theory, we could run out of space at some point. We can store a single id of the machine in the Log document instead.</p>
<p>The other thing to think through is what queries we will run most often.
For example, in our implementation of posts and authors, it is effortless to retrieve the author’s data if we have the post.
This is thanks to the fact that we store the author’s id in the document of the post. On the other hand, it would be more time-consuming to retrieve a list of posts by a single user.
To do that, we would need to query all of the posts and check the author’s id.</p>
<p>We could implement two-way referencing and store the reference on both sides to deal with the above issue.
The above would speed up some of the queries but require us to put more effort into keeping our data consistent.</p>
<h3 id="嵌入">嵌入</h3>
<p>We could also embed the document of the posts into the document of the user. The advantage of doing that would be not performing additional queries to the database to get the missing information. But, unfortunately, this would make getting a particular post more difficult.</p>
<h2 id="多对多">多对多</h2>
<p>Another important relationship to consider is many-to-many. A document from the first collection can refer to multiple documents from the second collection and the other way around.</p>
<p>A good example would be posts that can belong to multiple categories. Also, a single category can belong to multiple posts. First, let’s define the schema of our category.</p>
<p>category.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ObjectId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Transform</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">CategoryDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Category</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Category</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">ObjectId</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">CategorySchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Category</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>Now we can use it in the schema of the user.</p>
<p>user.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ObjectId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">mongoose</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../users/user.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Transform</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Category</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../categories/category.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PostDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Post</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">ObjectId</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">content</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">mongoose</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ref</span>: <span style="color:#204a87;font-weight:bold">User.name</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">author</span>: <span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[{</span> <span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">mongoose</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ref</span>: <span style="color:#204a87;font-weight:bold">Category.name</span> <span style="color:#000;font-weight:bold">}],</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Category</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">categories</span>: <span style="color:#204a87;font-weight:bold">Category</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">PostSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>A thing worth knowing is that we can also use the populate method right after saving our document.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostDto</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./dto/post.dto&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../users/user.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">postData</span>: <span style="color:#204a87;font-weight:bold">PostDto</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">author</span>: <span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">createdPost</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">...</span><span style="color:#000">postData</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">author</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">createdPost</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;categories&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">execPopulate</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">createdPost</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">save</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>上面的一件重要的事情是，我们在 MongoDB 文档的一个实例上调用 populate 方法。
由于是这种情况，我们还需要调用 execPopulate 来运行它。
在我们的其余示例中，我们在 MongoDB 查询的一个实例上调用 populate，这是不需要的。</p>
<h2 id="总结">总结</h2>
<p>在本文中，我们介绍了使用 NestJS 在 MongoDB 中定义文档之间的关系。
我们已经学习了各种类型的关系，并考虑了如何存储引用以提高性能。
我们还讨论了如何用 NestJS 和 MongoDB 实现序列化。
还有很多东西要学，所以请继续关注!</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4451ab685262406c61d37462ff2cf30c">2.4 - MongoDB和Mongoose的虚拟属性</h1>
    
	<p>在本系列中，我们使用 Mongoose 在模式中定义属性，并使用文档的模型。
我们还定义了集合之间的各种关系。
使用 Mongoose，我们还可以利用没有存储在 MongoDB 中的虚拟属性。
要理解它们，我们首先要掌握 <code>getter</code> 和 <code>setter</code> 的概念。</p>
<p>您可以在这个存储库中找到本文中的代码。</p>
<h2 id="mongoose-的-getters-和-setters">Mongoose 的 Getters 和 setters</h2>
<p>当使用 <code>getter</code> 和 <code>setter</code> 在文档中获取和设置属性时，可以执行自定义逻辑。</p>
<h3 id="getters">Getters</h3>
<p>通过使用 <code>getter</code> ，我们可以在检索文档数据时修改文档数据。
让我们创建一个示例，当用户有一个信用卡号码时，我们希望在响应 API 请求时对其进行混淆。</p>
<p>user.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">UserDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">User</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">toJSON</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">getters</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#204a87;font-weight:bold">unique</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">get</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">creditCardNumber</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">creditCardNumber</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">lastFourDigits</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">creditCardNumber</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">slice</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">creditCardNumber</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">`****-****-****-</span><span style="color:#4e9a06">${</span><span style="color:#000">lastFourDigits</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">creditCardNumber?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">UserSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>当我们从 API 返回文档时，NestJS 将我们的数据字符串化。
当这种情况发生时， <code>toJSON</code> 方法就会在我们的 Mongoose 模型上被调用。
因此，如果我们想要考虑我们的 <code>getter</code> ，我们需要在配置中显式地添加 <code>getter:true</code>。</p>
<p>文档也有 tobject 方法，我们可以用类似的方式自定义它。</p>
<p>我们也在 mongoosecasserializerinterceptor 中使用 toJSON。
要了解更多细节，请查看 NestJS #44 中的 API。
实现与 MongoDB 的关系</p>
<p>在上面的代码中，每次从 API 返回用户文档时，都会混淆信用卡号。</p>
<p>Mongoose 为我们的模式分配一个 id 字段的虚 <code>getter</code> 。
它现在出现在响应中，因为我们通过 <code>getters:true</code> 打开了 getters。
稍后会有更多关于虚拟的内容。</p>
<p>有时，我们希望访问原始的、未修改的属性。
为此，我们可以使用 <code>Document.prototype.get()</code> 函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">usersService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getByEmail</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">email</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">creditCardNumber</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">usersService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getByEmail</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">email</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><h3 id="setters">Setters</h3>
<p>使用 <code>setter</code> ，我们可以在将数据保存到数据库之前修改数据。</p>
<p>post.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ObjectId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Transform</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PostDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Post</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">ObjectId</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">set</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">content</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">content</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">trim</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">content</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">PostSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>由于做了上述操作，我们现在从内容字符串的两端删除空白。</p>
<p>虽然<code>setter</code>是一种有效的技术，但是为了提高可读性，您可能更愿意将此逻辑放在服务中。
然而，即使是这样，<code>setter</code>也是值得了解的。</p>
<h2 id="虚拟属性">虚拟属性</h2>
<p><code>virtual</code> 是我们可以获取和设置的属性，但它不存储在数据库中。
让我们定义一个简单的用例示例。</p>
<p>user.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">UserDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">User</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">firstName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">lastName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">fullName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">UserSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>不幸的是，上述方法是有缺陷的。
如果我们将 <code>fullName</code> 属性持久化到 MongoDB 中，我们将复制信息，因为我们已经有了 firstName 和 lastName。
更合适的方法是基于其他属性动态创建 <code>fullName</code> 。</p>
<h3 id="getters-1">Getters</h3>
<p>我们可以通过虚拟财产实现上述目的。
让我们创建它和 <code>getter</code> 。</p>
<p>user.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">UserDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">User</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">toJSON</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">virtuals</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">firstName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">lastName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">fullName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">UserSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">UserSchema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">virtual</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;fullName&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">UserDocument</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">`</span><span style="color:#4e9a06">${</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">firstName</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> </span><span style="color:#4e9a06">${</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lastName</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">UserSchema</span> <span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>请注意，我们没有在<code>fullName</code>属性上使用<code>@Prop()</code>装饰器。
相反，我们调用文件底部的<code>UserSchema.virtual</code>函数。</p>
<p>由于添加了<code>virtuals:true</code>，我们的虚拟属性在将文档转换为 <code>JSON</code> 时是可见的。
尽管我们可以在上面的响应中看到 <code>fullName</code> ，但它并没有保存到数据库中。</p>
<h3 id="setters-1">Setters</h3>
<p>使用 <code>virtual</code> ，我们还可以创建 <code>setter</code> 。
例如，我们可以使用它们一次设置多个属性。</p>
<p>user.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ObjectId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Transform</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">UserDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">User</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">toJSON</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">getters</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">virtuals</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">firstName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">lastName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">fullName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">UserSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">UserSchema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">virtual</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;fullName&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">UserDocument</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">`</span><span style="color:#4e9a06">${</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">firstName</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> </span><span style="color:#4e9a06">${</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lastName</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">UserDocument</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fullName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">firstName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lastName</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fullName</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">split</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34; &#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">firstName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lastName</span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">UserSchema</span> <span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>上面，我们基于 <code>fullName</code> 设置了 <code>firstName</code> 和 <code>lastName</code> 属性。</p>
<h2 id="填充虚拟属性">填充虚拟属性</h2>
<p>虚拟属性的一个便利特性是使用它们来填充来自另一个集合的文档。</p>
<p>我们学习了使用 NestJS 在 API 中填充特性的基础知识 <a href="">#44.使用 MongoDB 实现关系</a></p>
<p>在上一篇文章的示例中，我们为一篇文章创建了一个模式，使用它来存储对作者的引用。</p>
<p>post.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ObjectId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">mongoose</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../users/user.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Transform</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PostDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Post</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">ObjectId</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">content</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">mongoose</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ref</span>: <span style="color:#204a87;font-weight:bold">User.name</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">author</span>: <span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">PostSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>因此，当我们获取 <code>User</code> 文档时，我们没有任何帖子的信息。
我们可以使用虚拟属性来解决这个问题。</p>
<p>user.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../posts/post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">UserDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">User</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">toJSON</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">getters</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">virtuals</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#204a87;font-weight:bold">unique</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">posts</span>: <span style="color:#204a87;font-weight:bold">Post</span><span style="color:#000;font-weight:bold">[];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">UserSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">UserSchema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">virtual</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;posts&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ref</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">localField</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;_id&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">foreignField</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;author&#34;</span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">UserSchema</span> <span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>最后一步是调用 <code>populate</code> 函数以及用户的文档。
同时，我们还可以填充嵌套的 <code>categories</code> 属性。</p>
<p>users.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NotFoundException</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">UserDocument</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./user.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UsersService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">userModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">UserDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">getById</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">userModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findById</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;posts&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">populate</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;categories&#34;</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">NotFoundException</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="总结">总结</h2>
<p>在本文中，我们学习了什么是虚拟属性以及它们如何有用。
我们已经使用它们来添加简单的属性和填充来自其他集合的文档。
为了更好地掌握 <code>virtual</code> 的概念，我们还研究了 <code>getter</code> 和 <code>setter</code> 。
当使用 <code>Mongoose</code> 来定义 <code>MongoDB</code> 模式时，上述所有内容肯定会派上用场。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d6a0d2e2730441d8a1bbcc80b1877247">2.5 - 与MongoDB和Mongoose管理事务</h1>
    
	<p>在使用数据库时，保持数据的完整性至关重要。
例如，想象一下把钱从一个银行账户转到另一个。
为此，我们需要执行两个独立的操作。
首先，我们从第一个银行账户中提取金额。
然后，我们将相同的金额添加到第二个帐户。</p>
<p>如果由于某种原因第二次操作失败，而第一次操作成功，则会导致数据库的状态无效。
我们需要上述所有操作的成功或失败。
我们可以通过事务来实现这一点。</p>
<h2 id="acid-properties">ACID properties</h2>
<p>A transaction to be valid needs to have the following properties.
Together, they form the ACID acronym:</p>
<h2 id="atomicity">Atomicity</h2>
<p>Operations in the transaction are a single unit.
Therefore, it either fully succeeds or fails together.</p>
<h2 id="consistency">Consistency</h2>
<p>The transaction moves the database from one valid state to the next.</p>
<h2 id="isolation">Isolation</h2>
<p>The isolation property ensures that multiple transactions can occur concurrently, resulting in a valid database state.
To better understand that, let’s continue the example with the banking transaction from above.
Another transaction should see the funds in one account or the other, but not in both.</p>
<h2 id="durability">Durability</h2>
<p>Once the changes from a transaction are committed, they should survive permanently.</p>
<h2 id="transactions-in-mongodb-and-mongoose">Transactions in MongoDB and Mongoose</h2>
<p>Fortunately, MongoDB is equipped with support for multi-document transactions since version 4.0.
We can tell the database that we do a transaction, and it keeps track of every update we make.
If something fails, then the database rolls back all our updates.
The above requires the database to do extra work making notes of our updates and locking the involved resources.
Other clients trying to perform operations on the data might be stuck waiting for the transaction to complete.
Therefore, this is something to watch out for.</p>
<h2 id="running-a-replica-set">Running a replica set</h2>
<p>Transactions with MongoDB only work with a replica set, a group of MongoDB processes that maintain the same data set.
In this series, we’ve been using docker-compose to run MongoDB for us.
We can either run a replica set locally with docker or use MongoDB atlas.
For this article, I’m doing the latter.</p>
<p>If you want to run a replica set, check out this page on Stackoverflow.</p>
<h2 id="deleting-a-user">Deleting a user</h2>
<p>Let’s implement a feature of deleting a user.
When we remove users from the database, we also want to delete all posts they wrote.</p>
<p>users.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NotFoundException</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">UserDocument</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./user.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostsService</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../posts/posts.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UsersService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">userModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">UserDocument</span><span style="color:#000;font-weight:bold">&gt;,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">postsService</span>: <span style="color:#204a87;font-weight:bold">PostsService</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">userModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findByIdAndDelete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;posts&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">NotFoundException</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">posts</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">posts</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deleteMany</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">posts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">_id</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">()));</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">UsersService</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>To do the above, we also need to define the deleteMany in our PostsService.</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">deleteMany</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ids</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">[])</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deleteMany</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">ids</span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>The shortcoming of the above code is that the delete method might succeed partially.
When this happens, we delete the user, but the posts are left in the database without the author.
We can deal with the above issue by defining a transaction.</p>
<p>To start a transaction, we need to access the connection we’ve established with MongoDB.
To do that, we can use the @InjectConnection decorator:</p>
<p>users.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">UserDocument</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./user.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostsService</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../posts/posts.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectConnection</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">mongoose</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UsersService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">userModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">UserDocument</span><span style="color:#000;font-weight:bold">&gt;,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">postsService</span>: <span style="color:#204a87;font-weight:bold">PostsService</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">@InjectConnection</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">connection</span>: <span style="color:#204a87;font-weight:bold">mongoose.Connection</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">UsersService</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><h2 id="控制事务">控制事务</h2>
<p>There are two ways of working with transactions with Mongoose.
To have full control over it, we can call the startTransaction method:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">session</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">connection</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startSession</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startTransaction</span><span style="color:#000;font-weight:bold">();</span>
</span></span></code></pre></div><p>When we indicate that everything worked fine, we need to call session.commitTransaction().
This writes our changes to the database.</p>
<p>If we encounter an error, we need to call session.abortTransaction() to indicate that we want to discard the operations we’ve performed so far.
Once we’re done with the transaction, we need to call the session.endSession() method.</p>
<p>To indicate that we want to perform an operation within a given session, we need to use the session() method.</p>
<p>users.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UsersService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">session</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">connection</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startSession</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startTransaction</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">userModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findByIdAndDelete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;posts&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">NotFoundException</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">posts</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">posts</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deleteMany</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">posts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">_id</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">()));</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">commitTransaction</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">abortTransaction</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#000">error</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">finally</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">endSession</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Still, there is an important issue with the above code.
Although we’ve deleted the user within a transaction, we didn’t do that when removing posts.
To delete posts within a session, we need to modify the postsService.deleteMany function:</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">mongoose</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">deleteMany</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ids</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">[],</span> <span style="color:#000">session</span>: <span style="color:#204a87;font-weight:bold">mongoose.ClientSession</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">null</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deleteMany</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">ids</span> <span style="color:#000;font-weight:bold">}).</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>By adding the optional session argument to the deleteMany method, we can delete posts within a transaction.
Let’s use it:</p>
<p>users.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UsersService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">session</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">connection</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startSession</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startTransaction</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">userModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findByIdAndDelete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;posts&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">NotFoundException</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">posts</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">posts</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deleteMany</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">posts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">_id</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">()),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">session</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">commitTransaction</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">abortTransaction</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#000">error</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">finally</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">endSession</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>If removing the posts fail for some reason, the user is not deleted from the database either.
Thanks to that, the whole operation either succeeds as a whole or fails completely.</p>
<p>A simpler way of using transactions
Instead of controlling every step of the transaction manually, we can use the session.withTransaction() helper.</p>
<p>users.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">session</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">connection</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startSession</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">withTransaction</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">userModel</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findByIdAndDelete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;posts&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">NotFoundException</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">posts</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">posts</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deleteMany</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">posts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">_id</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">()),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">session</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">endSession</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Please notice that we no longer need to call startTransaction(), commitTransaction(), and abortTransaction().
We still are required to end the session with the endSession method, though.</p>
<h2 id="summary">Summary</h2>
<p>In this article, we’ve gone through transactions in MongoDB by describing their principles and use-cases.
We’ve also implemented them into our application with Mongoose.
It is definitely worth it to understand transactions because they can increase the reliability of our application quite a lot.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9dafda6a3ad4a457c936f5058f3f4460">2.6 - 使用MongoDB和Mongoose实现分页</h1>
    
	<p>当我们的应用程序增长时，数据库也会增长。
在某些情况下，我们可能会从端点返回大量数据。
例如，对于我们的前端应用程序来说，这可能会被证明是太多了。
因此，我们可能需要通过返回记录的一部分来对记录进行分页。
本文探讨了使用 MongoDB 和 Mongoose 实现这一目标的不同方法，并考虑了它们的优缺点。</p>
<p>您可以在这个存储库中找到本文中的代码。</p>
<h2 id="使用-skip-和-limit">使用 skip 和 limit</h2>
<p>最直接的分页形式是期望用户提供他们想要跳过的文档数量。
此外，他们还可以声明希望接收多少文件。</p>
<p>为了成功实现分页，我们需要一个可预测的文档顺序。
为了实现这一点，我们必须对它们进行排序:</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">findAll() {</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">find</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">sort</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">}).</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;author&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;categories&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>通过执行<code>sort({ _id: 1 })</code>，我们按升序排序。</p>
<p>上面，我们在 MongoDB 中使用了 id 的一个重要特性。
MongoDB 中的 id 由 12 个字节组成，其中 4 个字节是时间戳。
在这样做的同时，我们需要意识到一些缺点:</p>
<p>时间戳的值以秒为单位，在同一秒内创建的文档没有保证有效的顺序，
id 由可能具有不同系统时钟的客户端生成。
根据<code>_id</code>进行排序有一个显著的优势，因为 MongoDB 在<code>_id</code>字段上创建了一个唯一的索引。
这增加了按<code>_id</code>对文档进行排序的性能。</p>
<h3 id="实现分页">实现分页</h3>
<p>实现上述方法的第一步是允许用户通过查询参数提供偏移量和限制。
为此，让我们使用类验证器和类转换器。</p>
<p>paginationParams.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">IsNumber</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Min</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">IsOptional</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PaginationParams</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#204a87">Number</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsNumber</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">skip?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#204a87">Number</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsNumber</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">limit?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>如果您想了解更多关于类验证器和类转换器的信息，请参阅错误处理和数据验证以及使用拦截器序列化响应。</p>
<p>我们现在可以在控制器中使用上述参数:</p>
<p>posts.controller.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Get</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Query</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UseInterceptors</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostsService</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./posts.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">MongooseClassSerializerInterceptor</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../utils/mongooseClassSerializer.interceptor&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">PostModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">PaginationParams</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../utils/paginationParams&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Controller</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;posts&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@UseInterceptors</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">MongooseClassSerializerInterceptor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PostModel</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">postsService</span>: <span style="color:#204a87;font-weight:bold">PostsService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Get</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">getAllPosts</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Query</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">skip</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">limit</span> <span style="color:#000;font-weight:bold">}</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">PaginationParams</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skip</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">limit</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>现在我们可以在 findAll 方法中使用上述参数。</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">findAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">documentsToSkip</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">limitOfDocuments?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">query</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">find</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">sort</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">skip</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">documentsToSkip</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;author&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;categories&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">limitOfDocuments</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">query</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">limit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">limitOfDocuments</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">query</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>通过这样做，用户现在可以指定他们想要获取多少篇文章以及要跳过多少篇文章。
例如，请求<code>/posts?skip=20&amp;limit=10</code>在省略前 20 个文档的同时产生 10 个帖子。</p>
<h3 id="计算文件">计算文件</h3>
<p>一种常见的方法是显示我们有多少页面的文章。
为此，我们需要计算数据库中有多少个文档。
为此，我们需要使用聚合框架或执行两个单独的查询。</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">findAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">documentsToSkip</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">limitOfDocuments?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">findQuery</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">find</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">sort</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">skip</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">documentsToSkip</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;author&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;categories&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">limitOfDocuments</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">findQuery</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">limit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">limitOfDocuments</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">results</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">findQuery</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">count</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">count</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">results</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">count</span> <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>现在，在我们的响应中，我们得到了结果和文档的总数。</p>
<h3 id="缺点">缺点</h3>
<p>使用限制和偏移量的解决方案在 SQL 数据库和 MongoDB 中都被广泛使用。
不幸的是，它的性能还有改进的空间。
使用 <code>skip()</code> 方法仍然需要数据库从收集的开始进行扫描。
首先，数据库根据 id 对所有文档进行排序。
然后，MongoDB 丢弃指定数量的文档。
对于大的集合来说，这可能是相当多的工作。</p>
<p>除了性能问题，我们还需要考虑一致性。
理想情况下，文档应该只出现在结果中一次。
事实可能并非如此:</p>
<p>第一个用户获取带有文章的第 1 页，
在这之后，第二个用户创建了一个新的帖子——在排序之后，它结束在第 1 页，
第一个用户获取第二个页面。
用户在第二个页面上再次看到第一个页面的最后一个元素。
不幸的是，用户还错过了添加到第一个页面的元素，这更糟糕。</p>
<h3 id="优势">优势</h3>
<p>带有限制和偏移量的方法是常见的，并且易于实现。
它的最大优点是可以直接跳过多个页面的文档。
此外，更改用于排序的列也很简单，包括按多个列排序。
因此，如果期望偏移量不太大，且不一致是可以接受的，那么它是一个可行的解决方案。</p>
<h2 id="键集分页">键集分页</h2>
<p>如果我们非常关心性能，我们可能希望寻找上述方法的替代方法。
其中之一是键集分页。
在这里，我们使用了 MongoDB 中的 id 由时间戳组成的事实，可以进行比较:</p>
<p>我们从 API 中获取一页文档，
我们检查最后一个文档的 id，
然后，请求 id 大于上一个文档 id 的文档。
由于采用了上述方法，数据库不再需要处理不必要的文档。
首先，让我们为用户创建一种方式来提供起始 id。</p>
<p>paginationParams.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">IsNumber</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">IsMongoId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Min</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">IsOptional</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PaginationParams</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsMongoId</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">startId?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#204a87">Number</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsNumber</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">skip?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#204a87">Number</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsNumber</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">limit?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>现在，我们需要在服务中使用 <code>startId</code> 属性。</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">findAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">documentsToSkip</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">limitOfDocuments?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">startId?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">findQuery</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">find</span><span style="color:#000;font-weight:bold">({</span><span style="color:#000">_id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">$gt</span>: <span style="color:#204a87;font-weight:bold">startId</span><span style="color:#000;font-weight:bold">}}).</span><span style="color:#000">sort</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">}).</span><span style="color:#000">skip</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">documentsToSkip</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;author&#39;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;categories&#39;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">limitOfDocuments</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">findQuery</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">limit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">limitOfDocuments</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">results</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">findQuery</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">count</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">count</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">results</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">count</span> <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>由于执行了<code>$gt: startId</code>，用户只接收到使用提供的 id 的帖子之后创建的帖子。</p>
<h3 id="缺点-1">缺点</h3>
<p>键集分页的一个很大的缺点是需要知道我们想要开始的确切文档。
我们可以通过将其与基于偏移量的分页相结合来克服这个问题。
这种方法的另一个问题是，用户很难一次跳过多个数据页面。</p>
<h3 id="优点">优点</h3>
<p>与基于偏移量的方法相比，键集分页最显著的优点是性能提高。
此外，它还有助于解决用户在获取页面之间添加或删除元素时不一致的问题。</p>
<h2 id="总结">总结</h2>
<p>在本文中，我们比较了 MongoDB 和 Mongoose 两种类型的分页。
我们已经考虑了键集分页和基于偏移量的方法的优缺点。
它们都不是完美的，但将它们结合起来可以涵盖很多不同的情况。
为特定的工作选择合适的工具是至关重要的。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9fc52bf385551b755df4c394152ea50c">2.7 - 使用MongoDB和Mongoose定义索引</h1>
    
	<p>The bigger our database is, the more demanding our queries become in terms of computing power.
A common way of tackling this problem is by creating indexes.
In this article, we explore this concept and create indexes with MongoDB and Mongoose.</p>
<p>When performing a MongoDB query, the database must scan every document in a given collection to find matching documents.
MongoDB can limit the number of records to inspect if we have an appropriate index in our database.
Since it makes it easier to search for the documents in the database, indexes can speed up finding, updating, and deleting.</p>
<p>Under the hood, indexes are data structures that store a small part of the collection’s data in an easy-to-traverse way.
It includes the ordered values of a particular field of the documents.
It makes MongoDB indexes similar to indexes in databases such as PostgreSQL.</p>
<p>When we define indexes, MongoDB needs to store additional data to speed up our queries.
But, unfortunately, it slows down our write queries.
It also takes up more memory.
Therefore, we need to create indexes sparingly.</p>
<h2 id="唯一索引">唯一索引</h2>
<p>The unique index makes sure that we don’t store duplicate values.
We can create it by passing unique: true to the @Prop decorator.</p>
<p>user.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ObjectId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Transform</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">UserDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">User</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">toJSON</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">getters</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">virtuals</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">ObjectId</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#204a87;font-weight:bold">unique</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">UserSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>It is important to know that MongoDB creates a unique index on the _id field when creating a collection.
Therefore, we sometimes refer to it as the primary index.
We take advantage of the above in the last part of this series, where we implement pagination and sort documents by the _id field.</p>
<p>When we sort documents using a field without an index, MongoDB performs sorting at query time.
It takes time and resources to do that and makes our app response slower.
However, having the right index can help us avoid sorting results at query time because the results are already sorted in the index.
Therefore, we can return them immediately.</p>
<p>We need to keep in mind that making a property unique creates an index and slows down our write queries.</p>
<h2 id="使用-mongoose-实现索引">使用 Mongoose 实现索引</h2>
<p>With MongoDB, we can also define secondary indexes that don’t make properties unique.</p>
<p>post.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ObjectId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Transform</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PostDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Post</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">ObjectId</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">index</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">PostSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>By doing the above, we speed up queries, such as when we look for a post with a specific title, for example.
We also speed up queries where we sort posts by the title alphabetically.</p>
<h2 id="文本索引">文本索引</h2>
<p>MongoDB 还实现了文本索引，支持对字符串内容的搜索查询。
要定义文本索引，需要使用<code>index()</code>方法。</p>
<p>post.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ObjectId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Transform</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PostDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Post</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">ObjectId</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">PostSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">PostSchema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">title</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;text&#34;</span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">PostSchema</span> <span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>设置文本索引时，可以利用 <code>$text</code> 操作符。
它对用文本索引索引的字段的内容执行文本搜索。</p>
<p>一个集合不能有一个以上的文本索引。</p>
<p>让我们通过添加一个新的查询参数来实现搜索帖子的功能。</p>
<p>post.controller.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Get</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Query</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UseInterceptors</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostsService</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./posts.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">MongooseClassSerializerInterceptor</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../utils/mongooseClassSerializer.interceptor&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">PostModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">PaginationParams</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../utils/paginationParams&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Controller</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;posts&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@UseInterceptors</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">MongooseClassSerializerInterceptor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PostModel</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">postsService</span>: <span style="color:#204a87;font-weight:bold">PostsService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Get</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">getAllPosts</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Query</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">skip</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">limit</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">startId</span> <span style="color:#000;font-weight:bold">}</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">PaginationParams</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">@Query</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;searchQuery&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">searchQuery</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skip</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">limit</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">startId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">searchQuery</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">//...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>我们还需要将 <code>$text</code> 查询添加到服务中。</p>
<p>post.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">FilterQuery</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">findAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">documentsToSkip</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">limitOfDocuments?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">startId?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">searchQuery?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">filters</span>: <span style="color:#204a87;font-weight:bold">FilterQuery</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">startId</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">_id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$gt</span>: <span style="color:#204a87;font-weight:bold">startId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">searchQuery</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">filters</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">$text</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$search</span>: <span style="color:#204a87;font-weight:bold">searchQuery</span> <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">findQuery</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">find</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filters</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">sort</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">skip</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">documentsToSkip</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;author&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;categories&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">limitOfDocuments</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">findQuery</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">limit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">limitOfDocuments</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">results</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">findQuery</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">count</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">count</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">results</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">count</span> <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>感谢以上，MongoDB 可以搜索我们的文章标题。</p>
<p><code>$text</code>查询有更多的参数，比如 <code>$caseSensitive</code> 布尔值。
更多信息，请查看官方文档。</p>
<h2 id="复合索引">复合索引</h2>
<p>The $text query searches through all of the fields indexed with the text index.
With MongoDB, we can create compound indexes where the index structure holds references to multiple fields.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">PostSchema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">title</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;text&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">content</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;text&#34;</span> <span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>Thanks to doing the above, the $text query will search both through the titles and contents of posts.</p>
<p>Besides the text indexes, we can also create regular compound indexes.</p>
<p>user.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ObjectId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Transform</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">UserDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">User</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">toJSON</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">getters</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">virtuals</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">ObjectId</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">firstName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">lastName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">UserSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">UserSchema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">firstName</span>: <span style="color:#204a87;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lastName</span>: <span style="color:#204a87;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">UserSchema</span> <span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>Doing the above creates a compound index on the firstName and lastName fields.
It can speed queries such as the ones where we look for a user with a specific first name and last name.</p>
<p>By using 1, we create an ascending index.
When we use -1, we create a descending index.
The direction doesn’t matter for single key indexes because MongoDB can traverse the index in either direction.
It can be significant for compound indexes, though.
The official documentation and this Stackoverflow page provide a good explanation.</p>
<p><code>@Prop({ index: true })</code> 装饰器创建了一个升序索引。</p>
<h2 id="总结">总结</h2>
<p>在本文中，我们讨论了 MongoDB 中的索引问题。
我们已经解释了不同类型的索引，例如惟一索引、单字段索引和复合索引。
我们还学习了文本索引并使用它们实现了搜索功能。
我们还了解到，创造优势可以加快某些查询的速度，同时降低其他查询的速度。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-87745293d49493ba2db7754c111a3568">2.8 - 用PUT和PATCH更新MongoDB和Mongoose</h1>
    
	<p>When we develop a REST API, there is a set of HTTP methods that we can choose from, such as GET, POST, and DELETE. A crucial thing to understand is that HTTP methods are largely conventional. It is our job to make them work in a way that’s consistent with the specification. For example, in theory, we could delete entities with the GET method. However, we should make our API predictable to make it easy to understand both to developers working on our backend and the users.</p>
<p>A lot of HTTP methods are very straightforward. However, the PUT and PATCH methods are worth digging into a bit more. In this article, we compare both of them and implement them with NestJS and Mongoose.</p>
<p>PUT
The PUT method is responsible for modifying an existing entity. The crucial part about it is that it is supposed to replace an entity. Therefore, if we don’t send a field of an entity when performing a PUT request, the missing field should be removed from the document.</p>
<p>GET /posts/613e2dcbe2b947c10b669292</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;categories&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[],</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;_id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;614fa87e4027d3141f28e9e7&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;title&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;API with NestJS #49. PUT vs PATCH with MongoDB and Mongoose&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;content&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;...&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;series&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;_id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;614fa8364027d3141f28e9e2&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;API with NestJS&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;author&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;_id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;61350362017a80b8d443b012&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;email&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;marcin@wanago.io&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;firstName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Marcin&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;lastName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Wanago&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Above, we can see the properties our post contains. Let’s make a PUT request now.</p>
<p>PUT /posts/614fa87e4027d3141f28e9e7</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;_id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;614fa87e4027d3141f28e9e7&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;categories&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[],</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;title&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;API with NestJS #49. PUT vs PATCH with MongoDB and Mongoose&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;content&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;...&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;author&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;_id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;61350362017a80b8d443b012&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;email&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;marcin@wanago.io&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;firstName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Marcin&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;lastName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Wanago&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>The crucial thing above is that we didn’t send the series property in the body of our request. Because the PUT method is supposed to replace a whole entity, we’ve deleted the series property.</p>
<p>Implementing the PUT method with MongoDB and Mongoose
There are quite a few ways of implementing a proper PUT method with MongoDB and Mongoose. The findByIdAndUpdate and findOneAndUpdate methods are common, but they don’t replace the whole document by default. Instead, they perform a partial update on it. Because of that, not including a property in the body of the request does not remove it. We can fix that with the overwrite: true option.</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">NotFoundException</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostDto</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./dto/post.dto&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">postData</span>: <span style="color:#204a87;font-weight:bold">PostDto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">post</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">findByIdAndUpdate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">postData</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">setOptions</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">overwrite</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">new</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;author&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;categories&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;series&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">NotFoundException</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">post</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>By setting new: true, we indicate that we want the findByIdAndUpdate method to return the modified version of the document.</p>
<p>posts.controller.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Body</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Param</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Put</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UseInterceptors</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostsService</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./posts.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">ParamsWithId</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../utils/paramsWithId&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">MongooseClassSerializerInterceptor</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../utils/mongooseClassSerializer.interceptor&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">PostModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">UpdatePostDto</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./dto/updatePost.dto&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Controller</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;posts&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@UseInterceptors</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">MongooseClassSerializerInterceptor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PostModel</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">postsService</span>: <span style="color:#204a87;font-weight:bold">PostsService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;:id&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">updatePost</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Param</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span> <span style="color:#000;font-weight:bold">}</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">ParamsWithId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">@Body</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">post</span>: <span style="color:#204a87;font-weight:bold">UpdatePostDto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">post</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Thanks to doing the above, when we update a document, we replace it as a whole and remove not included fields.</p>
<p>We could also use the findOneAndReplace method. Not so long back, it wasn’t included with the TypeScript definitions shipped with the @types/mongoose, unfortunately. Thankfully, the Mongoose team started working on official TypeScript definitions. They released it in version v5.11.0.</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">NotFoundException</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">UpdatePostDto</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./dto/updatePost.dto&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">postData</span>: <span style="color:#204a87;font-weight:bold">UpdatePostDto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">post</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">findOneAndReplace</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">id</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#000">postData</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">new</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;author&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;categories&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;series&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">NotFoundException</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">post</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>createPost.dto.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">IsString</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">IsNotEmpty</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">IsMongoId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">IsOptional</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../../users/user.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Category</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../../categories/category.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Series</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../../series/series.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UpdatePostDto</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsMongoId</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsNotEmpty</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsString</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsNotEmpty</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsString</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsNotEmpty</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">content</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Category</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">categories</span>: <span style="color:#204a87;font-weight:bold">Category</span><span style="color:#000;font-weight:bold">[];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsNotEmpty</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">author</span>: <span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Series</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">series?</span>: <span style="color:#204a87;font-weight:bold">Series</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">UpdatePostDto</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>Preventing the id from being updated
Since we expect the users to send the whole document, they also send the _id property. The above doesn’t cause any issues as long as the user doesn’t alter the id. That’s because doing that can cause an unexpected error:</p>
<p>MongoError: Plan executor error during findAndModify :: caused by :: After applying the update, the (immutable) field ‘_id’ was found to have been altered</p>
<p>We can deal with the above error by excluding the _id property from the body of our PUT request.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">IsOptional</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Exclude</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UpdatePostDto</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Exclude</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">UpdatePostDto</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>Even if the user provides the _id property in the request, we exclude it and don’t pass it to the findOneAndReplace or the findByIdAndUpdate methods. Rest assured, because MongoDB won’t remove the _id property in such a case, even though we are implementing the PUT method here.</p>
<p>PATCH
While the PUT method is a common and valid choice, it might not fit every situation. For example, when implementing the PUT method, we assume that the API users know all of the details of a particular entity. Since omitting single property results in removing it, they need to be careful. A solution to this issue can be the PATCH method.</p>
<p>The PATCH method was introduced to the HTTP protocol in 2010 and aimed to apply a partial modification to an entity. The specification describes it as a set of instructions describing how a resource should be modified. The most straightforward way of implementing the PATCH method is to handle a body with a partial document.</p>
<p>PATCH /posts/614fa87e4027d3141f28e9e7</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;title&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;A new title&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;series&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>The above request modifies the post by changing the title and removing the series property. Please note that to delete a field, we need to send the null value explicitly. Thanks to this, no fields are deleted by accident.</p>
<p>Implementing PATCH with MongoDB and Mongoose
To implement a PATCH handler using Mongoose, we can use the findByIdAndUpdate method without the overwrite: true option. First, let’s use the @Patch decorator in our controller:</p>
<p>posts.controller.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Body</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Param</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Patch</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UseInterceptors</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostsService</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./posts.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">ParamsWithId</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../utils/paramsWithId&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">MongooseClassSerializerInterceptor</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../utils/mongooseClassSerializer.interceptor&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">PostModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">UpdatePostDto</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./dto/updatePost.dto&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Controller</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;posts&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@UseInterceptors</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">MongooseClassSerializerInterceptor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PostModel</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">postsService</span>: <span style="color:#204a87;font-weight:bold">PostsService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Patch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;:id&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">updatePost</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Param</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span> <span style="color:#000;font-weight:bold">}</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">ParamsWithId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">@Body</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">post</span>: <span style="color:#204a87;font-weight:bold">UpdatePostDto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">post</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Now, let’s modify the service:</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">NotFoundException</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">UpdatePostDto</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./dto/updatePost.dto&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">postData</span>: <span style="color:#204a87;font-weight:bold">UpdatePostDto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">post</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">findByIdAndUpdate</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">id</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#000">postData</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">new</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;author&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;categories&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;series&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">NotFoundException</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">post</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>For the above to work correctly, we also need to modify our DTO by adding the @IsOptional decorators:</p>
<p>updatePost.dto.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">IsString</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">IsNotEmpty</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">IsOptional</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../../users/user.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Exclude</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Category</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../../categories/category.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Series</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../../series/series.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UpdatePostDto</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Exclude</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">_id?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsString</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsNotEmpty</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">title?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsString</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsNotEmpty</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">content?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Category</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">categories?</span>: <span style="color:#204a87;font-weight:bold">Category</span><span style="color:#000;font-weight:bold">[];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsNotEmpty</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">author?</span>: <span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Series</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">series?</span>: <span style="color:#204a87;font-weight:bold">Series</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">UpdatePostDto</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>Thanks to adding the @IsOptional decorators, the user no longer has to provide all of the document’s properties.</p>
<p>JSON Patch
An alternative approach to our implementation is to quite literally send a set of instructions on how to modify an object. A way to do that is to use the JSON Patch format.</p>
<p>PATCH /posts/614fa87e4027d3141f28e9e7</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a40000">op:</span> <span style="color:#204a87;font-weight:bold">&#34;replace&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a40000">path:</span> <span style="color:#204a87;font-weight:bold">&#34;/content&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a40000">value:</span> <span style="color:#204a87;font-weight:bold">&#34;A brand new content&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">]</span><span style="color:#a40000">;</span>
</span></span></code></pre></div><p>If you want to know more, check out the jsonpatch.com website. Additionally, the fast-json-patch library might come in handy when implementing the above format into your application.</p>
<h2 id="summary">Summary</h2>
<p>In this article, we’ve learned about various ways of implementing the update functionality. Thanks to getting to know both about PUT and PATCH, we can choose the best approach for a particular case. When selecting one of the above, we should follow the specification and implement our API predictably and transparently. If we do that, we will make the life of our teammates and API users easier.</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b64b7e1b4aa2d437b41e6919a564206e">3 - files</h1>
    
	<blockquote>
<p><a href="https://wanago.io/courses/api-with-nestjs/">https://wanago.io/courses/api-with-nestjs/</a></p>
</blockquote>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-a5ce0f5e673a67cd6c90e83f6e52b6e1">3.1 - Uploading files to the server</h1>
    
	<p>到目前为止，在本系列中，我们已经描述了在服务器上存储文件的两种方法。
在第 10 篇文章中，我们向 Amazon S3 上传了文件。
虽然它的可伸缩性很强，但出于各种原因，我们可能不希望使用 AWS 等云服务。
因此，在本系列的第 54 部分中，我们学习了如何直接在 PostgreSQL 数据库中存储文件。
虽然它有一些优势，但它可能被认为在性能方面不够理想。</p>
<p>在本文中，我们将研究如何使用 NestJS 在服务器上存储上传的文件。
同样，我们将一些信息持久化到数据库中，但这一次只是元数据。</p>
<h2 id="在服务器上保存文件">在服务器上保存文件</h2>
<p>幸运的是，NestJS 使得在服务器上存储文件变得非常容易。
我们需要向 FileInterceptor 传递额外的参数。</p>
<p>users.service.ts;</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">UsersService</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./users.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Req</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UploadedFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UseGuards</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UseInterceptors</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">JwtAuthenticationGuard</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../authentication/jwt-authentication.guard&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">RequestWithUser</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../authentication/requestWithUser.interface&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Express</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;express&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">FileInterceptor</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/platform-express&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">diskStorage</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;multer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Controller</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UsersController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">usersService</span>: <span style="color:#204a87;font-weight:bold">UsersService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Post</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;avatar&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@UseGuards</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">JwtAuthenticationGuard</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@UseInterceptors</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">FileInterceptor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;file&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">storage</span>: <span style="color:#204a87;font-weight:bold">diskStorage</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">destination</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;./uploadedFiles/avatars&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">addAvatar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Req</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">request</span>: <span style="color:#204a87;font-weight:bold">RequestWithUser</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">@UploadedFile</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">file</span>: <span style="color:#204a87;font-weight:bold">Express.Multer.File</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">usersService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">addAvatar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">path</span>: <span style="color:#204a87;font-weight:bold">file.path</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">filename</span>: <span style="color:#204a87;font-weight:bold">file.originalname</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">mimetype</span>: <span style="color:#204a87;font-weight:bold">file.mimetype</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>当我们执行上述操作时，NestJS 将上传的文件存储在<code>./uploadefiles/avatars</code>目录中。</p>
<p>不过，上述方法存在一些问题。
首先，我们可能需要多个端点来接受文件。
在这种情况下，我们需要为它们每个重复配置的某些部分。
此外，我们应该将目标的。<code>/uploaddfiles</code> 部分放在一个环境变量中，以根据应用程序运行的环境来更改它。</p>
<h2 id="扩展-fileinterceptor">扩展 FileInterceptor</h2>
<p>实现上述目标的一种方法是扩展 FileInterceptor。
在查看了 NestJS 的底层之后，我们可以看到它使用了 mixin 模式。
因为 FileInterceptor 不是类，所以不能使用 extend 关键字。</p>
<p>我们想要扩展 FileInterceptor 的功能，当:</p>
<ul>
<li>使用依赖注入来注入 <code>ConfigService</code> ，</li>
<li>能够从控制器传递额外的属性。</li>
</ul>
<p>为此，我们可以创建我们的 mixin:</p>
<p>localFiles.interceptor.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">FileInterceptor</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/platform-express&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mixin</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NestInterceptor</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ConfigService</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/config&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">MulterOptions</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/platform-express/multer/interfaces/multer-options.interface&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">diskStorage</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;multer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">LocalFilesInterceptorOptions</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">fieldName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">path?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">LocalFilesInterceptor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span>: <span style="color:#204a87;font-weight:bold">LocalFilesInterceptorOptions</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Type</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">NestInterceptor</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Interceptor</span> <span style="color:#204a87;font-weight:bold">implements</span> <span style="color:#000">NestInterceptor</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fileInterceptor</span>: <span style="color:#204a87;font-weight:bold">NestInterceptor</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">configService</span>: <span style="color:#204a87;font-weight:bold">ConfigService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">filesDestination</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">configService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;UPLOADED_FILES_DESTINATION&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">destination</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">`</span><span style="color:#4e9a06">${</span><span style="color:#000">filesDestination</span><span style="color:#4e9a06">}${</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">path</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">multerOptions</span>: <span style="color:#204a87;font-weight:bold">MulterOptions</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">storage</span>: <span style="color:#204a87;font-weight:bold">diskStorage</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">destination</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">fileInterceptor</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">FileInterceptor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">fieldName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">multerOptions</span><span style="color:#000;font-weight:bold">))();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">intercept</span><span style="color:#000;font-weight:bold">(...</span><span style="color:#000">args</span>: <span style="color:#204a87;font-weight:bold">Parameters</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">NestInterceptor</span><span style="color:#a40000">[&#34;</span><span style="color:#c4a000">intercept</span><span style="color:#a40000">&#34;]</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">fileInterceptor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">intercept</span><span style="color:#000;font-weight:bold">(...</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">mixin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Interceptor</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">LocalFilesInterceptor</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>在上面，我们使用 <code>UPLOADED_FILES_DESTINATION</code> 变量，并将其与提供的路径连接起来。
为此，让我们定义必要的环境变量。</p>
<p>app.module.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Module</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ConfigModule</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/config&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">Joi</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@hapi/joi&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Module</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">imports</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ConfigModule</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">forRoot</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">validationSchema</span>: <span style="color:#204a87;font-weight:bold">Joi.object</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">UPLOADED_FILES_DESTINATION</span>: <span style="color:#204a87;font-weight:bold">Joi.string</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">required</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000;font-weight:bold">}),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">AppModule</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>.env</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-env" data-lang="env"><span style="display:flex;"><span><span style="color:#000">UPLOADED_FILES_DESTINATION</span><span style="color:#ce5c00;font-weight:bold">=</span>./uploadedFiles
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ...</span>
</span></span></code></pre></div><p>当上面所有的准备就绪，我们可以在控制器中使用 LocalFilesInterceptor:</p>
<p>users.controller.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">UsersService</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./users.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Req</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UploadedFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UseGuards</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UseInterceptors</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">JwtAuthenticationGuard</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../authentication/jwt-authentication.guard&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">RequestWithUser</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../authentication/requestWithUser.interface&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Express</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;express&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">LocalFilesInterceptor</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../localFiles/localFiles.interceptor&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Controller</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UsersController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">usersService</span>: <span style="color:#204a87;font-weight:bold">UsersService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Post</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;avatar&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@UseGuards</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">JwtAuthenticationGuard</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@UseInterceptors</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">LocalFilesInterceptor</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">fieldName</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;file&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;/avatars&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">addAvatar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Req</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">request</span>: <span style="color:#204a87;font-weight:bold">RequestWithUser</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">@UploadedFile</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">file</span>: <span style="color:#204a87;font-weight:bold">Express.Multer.File</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">usersService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">addAvatar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">path</span>: <span style="color:#204a87;font-weight:bold">file.path</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">filename</span>: <span style="color:#204a87;font-weight:bold">file.originalname</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">mimetype</span>: <span style="color:#204a87;font-weight:bold">file.mimetype</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="将元数据保存在数据库中">将元数据保存在数据库中</h2>
<p>除了将文件存储在服务器上，我们还需要将文件的元数据保存在数据库中。
由于 NestJS 为上传的文件生成一个随机的文件名，我们还想存储原始的文件名。
要完成上述所有工作，我们需要为元数据创建一个实体。</p>
<p>localFile.entity.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Column</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Entity</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PrimaryGeneratedColumn</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;typeorm&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Entity</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">LocalFile</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@PrimaryGeneratedColumn</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Column</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">filename</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Column</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">path</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Column</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">mimetype</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">LocalFile</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">localFile</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dto</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ts</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">LocalFileDto</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">filename</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">path</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">mimetype</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>我们还需要在用户和文件之间创建一个关系。</p>
<p>user.entity.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Column</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Entity</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">JoinColumn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">OneToOne</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PrimaryGeneratedColumn</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;typeorm&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">LocalFile</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../localFiles/localFile.entity&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Entity</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@PrimaryGeneratedColumn</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@JoinColumn</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;avatarId&#34;</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@OneToOne</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">LocalFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">nullable</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">avatar?</span>: <span style="color:#204a87;font-weight:bold">LocalFile</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Column</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">nullable</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">avatarId?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>我们在上面添加了 avatarId 列，这样用户的实体就可以保存角色的 id，而不用连接角色的所有数据。</p>
<p>同时，我们还需要创建 LocalFilesService 的基础:</p>
<p>localFiles.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectRepository</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/typeorm&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Repository</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;typeorm&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">LocalFile</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./localFile.entity&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">LocalFilesService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">@InjectRepository</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">LocalFile</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">localFilesRepository</span>: <span style="color:#204a87;font-weight:bold">Repository</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">LocalFile</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">saveLocalFileData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fileData</span>: <span style="color:#204a87;font-weight:bold">LocalFileDto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">newFile</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">localFilesRepository</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fileData</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">localFilesRepository</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">save</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">newFile</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">newFile</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">LocalFilesService</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>最后一步是在 UsersService 中使用 saveLocalFileData 方法:</p>
<p>users.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectRepository</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/typeorm&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Repository</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Connection</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">In</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;typeorm&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">User</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./user.entity&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">LocalFilesService</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../localFiles/localFiles.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UsersService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">@InjectRepository</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">usersRepository</span>: <span style="color:#204a87;font-weight:bold">Repository</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">&gt;,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">localFilesService</span>: <span style="color:#204a87;font-weight:bold">LocalFilesService</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">addAvatar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fileData</span>: <span style="color:#204a87;font-weight:bold">LocalFileDto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">avatar</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">localFilesService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">saveLocalFileData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fileData</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">usersRepository</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">avatarId</span>: <span style="color:#204a87;font-weight:bold">avatar.id</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="检索文件">检索文件</h2>
<p>现在，用户可以检索他们化身的 id。</p>
<p>要下载具有给定 id 的文件，我们可以创建一个传输内容的控制器。</p>
<p>实现上述功能的第一步是扩展 LocalFilesService:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NotFoundException</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectRepository</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/typeorm&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Repository</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;typeorm&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">LocalFile</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./localFile.entity&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">LocalFilesService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">@InjectRepository</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">LocalFile</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">localFilesRepository</span>: <span style="color:#204a87;font-weight:bold">Repository</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">LocalFile</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">getFileById</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fileId</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">localFilesRepository</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findOne</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fileId</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">file</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">NotFoundException</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">file</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">LocalFilesService</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>我们还需要创建一个使用上述方法的控制器:</p>
<p>localFiles.controller.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Get</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Param</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">UseInterceptors</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">ClassSerializerInterceptor</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">StreamableFile</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Res</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">ParseIntPipe</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">LocalFilesService</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./localFiles.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Response</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;express&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">createReadStream</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;fs&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">join</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;path&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Controller</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;local-files&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@UseInterceptors</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ClassSerializerInterceptor</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">LocalFilesController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">localFilesService</span>: <span style="color:#204a87;font-weight:bold">LocalFilesService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;:id&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">getDatabaseFileById</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Param</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;id&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ParseIntPipe</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">@Res</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">passthrough</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#000">response</span>: <span style="color:#204a87;font-weight:bold">Response</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">localFilesService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getFileById</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">stream</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">createReadStream</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cwd</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">file</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">path</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;Content-Disposition&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">`inline; filename=&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">file</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">filename</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;`</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;Content-Type&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">file</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mimetype</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">StreamableFile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stream</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>我们在本系列的前一部分中了解了 StreamableFile 类和 Content-Disposition 头文件。</p>
<p>执行上述操作允许用户检索具有给定 id 的文件。</p>
<h2 id="过滤传入的文件">过滤传入的文件</h2>
<p>我们不应该总是相信用户上传的文件。
幸运的是，我们可以很容易地使用 filfilter 过滤它们，并限制 multer 支持的属性。</p>
<p>localFiles.interceptor.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">FileInterceptor</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/platform-express&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mixin</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NestInterceptor</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ConfigService</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/config&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">MulterOptions</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/platform-express/multer/interfaces/multer-options.interface&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">diskStorage</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;multer&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">LocalFilesInterceptorOptions</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">fieldName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">path?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">fileFilter?</span>: <span style="color:#204a87;font-weight:bold">MulterOptions</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;fileFilter&#34;</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">limits?</span>: <span style="color:#204a87;font-weight:bold">MulterOptions</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;limits&#34;</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">LocalFilesInterceptor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span>: <span style="color:#204a87;font-weight:bold">LocalFilesInterceptorOptions</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Type</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">NestInterceptor</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Interceptor</span> <span style="color:#204a87;font-weight:bold">implements</span> <span style="color:#000">NestInterceptor</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fileInterceptor</span>: <span style="color:#204a87;font-weight:bold">NestInterceptor</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">configService</span>: <span style="color:#204a87;font-weight:bold">ConfigService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">filesDestination</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">configService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;UPLOADED_FILES_DESTINATION&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">destination</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">`</span><span style="color:#4e9a06">${</span><span style="color:#000">filesDestination</span><span style="color:#4e9a06">}${</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">path</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">multerOptions</span>: <span style="color:#204a87;font-weight:bold">MulterOptions</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">storage</span>: <span style="color:#204a87;font-weight:bold">diskStorage</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">destination</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fileFilter</span>: <span style="color:#204a87;font-weight:bold">options.fileFilter</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">limits</span>: <span style="color:#204a87;font-weight:bold">options.limits</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">fileInterceptor</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">FileInterceptor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">fieldName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">multerOptions</span><span style="color:#000;font-weight:bold">))();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">intercept</span><span style="color:#000;font-weight:bold">(...</span><span style="color:#000">args</span>: <span style="color:#204a87;font-weight:bold">Parameters</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">NestInterceptor</span><span style="color:#a40000">[&#34;</span><span style="color:#c4a000">intercept</span><span style="color:#a40000">&#34;]</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">fileInterceptor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">intercept</span><span style="color:#000;font-weight:bold">(...</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">mixin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Interceptor</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">LocalFilesInterceptor</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>让我们只允许在 mimetype 中包含“image”且小于 1MB 的文件。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">UsersService</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./users.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">BadRequestException</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Req</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UploadedFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UseGuards</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UseInterceptors</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">JwtAuthenticationGuard</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../authentication/jwt-authentication.guard&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">RequestWithUser</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../authentication/requestWithUser.interface&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Express</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;express&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">LocalFilesInterceptor</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../localFiles/localFiles.interceptor&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Controller</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UsersController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">usersService</span>: <span style="color:#204a87;font-weight:bold">UsersService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Post</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;avatar&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@UseGuards</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">JwtAuthenticationGuard</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@UseInterceptors</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">LocalFilesInterceptor</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">fieldName</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;file&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;/avatars&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">fileFilter</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">file</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">callback</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">file</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mimetype</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">includes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;image&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">callback</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">BadRequestException</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Provide a valid image&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">callback</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">limits</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fileSize</span>: <span style="color:#204a87;font-weight:bold">Math.pow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#8f5902;font-style:italic">// 1MB
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">addAvatar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Req</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">request</span>: <span style="color:#204a87;font-weight:bold">RequestWithUser</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">@UploadedFile</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">file</span>: <span style="color:#204a87;font-weight:bold">Express.Multer.File</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">usersService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">addAvatar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">path</span>: <span style="color:#204a87;font-weight:bold">file.path</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">filename</span>: <span style="color:#204a87;font-weight:bold">file.originalname</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">mimetype</span>: <span style="color:#204a87;font-weight:bold">file.mimetype</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>如果文件不满足大小要求，NestJS 抛出 413 Payload Too Large。
不只是检查 mimetype 和使用文件类型库可能是一个好主意。</p>
<h2 id="总结">总结</h2>
<p>在本文中，我们介绍了通过 NestJS 管理服务器上文件的基础知识。
我们已经学习了如何将它们存储在服务器上并返回给用户。
当这样做时，我们扩展了内置的 FileInterceptor 并实现了过滤。
仍然有一些方法可以扩展本文中的代码。
如本系列第 15 部分所述，您可以自由地实现文件删除和使用事务。</p>
<p>通过学习各种存储文件的方法，您现在可以自由地比较其优缺点，并使用最适合自己需求的方法。</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c709471c70f27c6bb15b128d75977220">4 - http</h1>
    
	<blockquote>
<p><a href="https://github.com/axios/axios">https://github.com/axios/axios</a></p>
</blockquote>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-42a26675b19acc37e7dbc0e2c8d454d2">4.1 - axios</h1>
    
	<p><a href="https://www.npmjs.org/package/axios"><img src="https://img.shields.io/npm/v/axios.svg?style=flat-square" alt="npm version"></a>
<a href="https://cdnjs.com/libraries/axios"><img src="https://img.shields.io/cdnjs/v/axios.svg?style=flat-square" alt="CDNJS"></a>
<img src="https://github.com/axios/axios/actions/workflows/ci.yml/badge.svg" alt="Build status">
<a href="https://gitpod.io/#https://github.com/axios/axios"><img src="https://img.shields.io/badge/Gitpod-Ready--to--Code-blue?logo=gitpod" alt="Gitpod Ready-to-Code"></a>
<a href="https://coveralls.io/r/mzabriskie/axios"><img src="https://img.shields.io/coveralls/mzabriskie/axios.svg?style=flat-square" alt="code coverage"></a>
<a href="https://packagephobia.now.sh/result?p=axios"><img src="https://packagephobia.now.sh/badge?p=axios" alt="install size"></a>
<a href="http://npm-stat.com/charts.html?package=axios"><img src="https://img.shields.io/npm/dm/axios.svg?style=flat-square" alt="npm downloads"></a>
<a href="https://gitter.im/mzabriskie/axios"><img src="https://img.shields.io/gitter/room/mzabriskie/axios.svg?style=flat-square" alt="gitter chat"></a>
<a href="https://www.codetriage.com/axios/axios"><img src="https://www.codetriage.com/axios/axios/badges/users.svg" alt="code helpers"></a>
<a href="https://snyk.io/test/npm/axios"><img src="https://snyk.io/test/npm/axios/badge.svg" alt="Known Vulnerabilities"></a></p>
<p>Promise based HTTP client for the browser and node.js</p>
<blockquote>
<p>New axios docs website: <a href="https://axios-http.com/">click here</a></p>
</blockquote>
<h2 id="功能">功能</h2>
<ul>
<li>Make <a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest">XMLHttpRequests</a> from the browser</li>
<li>Make <a href="http://nodejs.org/api/http.html">http</a> requests from node.js</li>
<li>Supports the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promise</a> API</li>
<li>Intercept request and response</li>
<li>Transform request and response data</li>
<li>Cancel requests</li>
<li>Automatic transforms for JSON data</li>
<li>Client side support for protecting against <a href="http://en.wikipedia.org/wiki/Cross-site_request_forgery">XSRF</a></li>
</ul>
<h2 id="浏览器支持">浏览器支持</h2>
<table>
<thead>
<tr>
<th><img src="https://raw.github.com/alrra/browser-logos/master/src/chrome/chrome_48x48.png" alt="Chrome"></th>
<th><img src="https://raw.github.com/alrra/browser-logos/master/src/firefox/firefox_48x48.png" alt="Firefox"></th>
<th><img src="https://raw.github.com/alrra/browser-logos/master/src/safari/safari_48x48.png" alt="Safari"></th>
<th><img src="https://raw.github.com/alrra/browser-logos/master/src/opera/opera_48x48.png" alt="Opera"></th>
<th><img src="https://raw.github.com/alrra/browser-logos/master/src/edge/edge_48x48.png" alt="Edge"></th>
<th><img src="https://raw.github.com/alrra/browser-logos/master/src/archive/internet-explorer_9-11/internet-explorer_9-11_48x48.png" alt="IE"></th>
</tr>
</thead>
<tbody>
<tr>
<td>Latest ✔</td>
<td>Latest ✔</td>
<td>Latest ✔</td>
<td>Latest ✔</td>
<td>Latest ✔</td>
<td>11 ✔</td>
</tr>
</tbody>
</table>
<p><a href="https://saucelabs.com/u/axios"><img src="https://saucelabs.com/open_sauce/build_matrix/axios.svg" alt="Browser Matrix"></a></p>
<h2 id="安装">安装</h2>
<p>Using npm:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ npm install axios
</span></span></code></pre></div><p>Using bower:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ bower install axios
</span></span></code></pre></div><p>Using yarn:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ yarn add axios
</span></span></code></pre></div><p>Using jsDelivr CDN:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">script</span> <span style="color:#c4a000">src</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js&#34;</span><span style="color:#000;font-weight:bold">&gt;&lt;/</span><span style="color:#204a87;font-weight:bold">script</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>Using unpkg CDN:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">script</span> <span style="color:#c4a000">src</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;https://unpkg.com/axios/dist/axios.min.js&#34;</span><span style="color:#000;font-weight:bold">&gt;&lt;/</span><span style="color:#204a87;font-weight:bold">script</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><h2 id="示例">示例</h2>
<h3 id="note-commonjs-usage">note: CommonJS usage</h3>
<p>In order to gain the TypeScript typings (for intellisense / autocomplete) while using CommonJS imports with <code>require()</code> use the following approach:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">axios</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;axios&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// axios.&lt;method&gt; will now provide autocomplete and parameter typings
</span></span></span></code></pre></div><p>Performing a <code>GET</code> request</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">axios</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;axios&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Make a request for a user with a given ID
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">axios</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/user?ID=12345&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// handle success
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">catch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// handle error
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// always executed
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Optionally the request above could also be done as
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">axios</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/user&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">params</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">ID</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">12345</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">catch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// always executed
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Want to use async/await? Add the `async` keyword to your outer function/method.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">getUser</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">response</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/user?ID=12345&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><blockquote>
<p><strong>NOTE:</strong> <code>async/await</code> is part of ECMAScript 2017 and is not supported in Internet
Explorer and older browsers, so use with caution.</p>
</blockquote>
<p>Performing a <code>POST</code> request</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000">axios</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/user&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">firstName</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Fred&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">lastName</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Flintstone&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">catch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>Performing multiple concurrent requests</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">getUserAccount</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/user/12345&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">getUserPermissions</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/user/12345/permissions&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">all</span><span style="color:#000;font-weight:bold">([</span><span style="color:#000">getUserAccount</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">getUserPermissions</span><span style="color:#000;font-weight:bold">()]).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">results</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">acct</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">results</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">perm</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">results</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><h2 id="axios-api">axios API</h2>
<p>Requests can be made by passing the relevant config to <code>axios</code>.</p>
<h5 id="axiosconfig">axios(config)</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Send a POST request
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">method</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;post&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">url</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;/user/12345&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">firstName</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Fred&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">lastName</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Flintstone&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// GET request for remote image in node.js
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">method</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;get&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">url</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http://bit.ly/2mTM3nY&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">responseType</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;stream&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pipe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createWriteStream</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ada_lovelace.jpg&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><h5 id="axiosurl-config">axios(url[, config])</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Send a GET request (default method)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/user/12345&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><h3 id="请求方法的别名">请求方法的别名</h3>
<p>For convenience, aliases have been provided for all common request methods.</p>
<h5 id="axiosrequestconfig">axios.request(config)</h5>
<h5 id="axiosgeturl-config">axios.get(url[, config])</h5>
<h5 id="axiosdeleteurl-config">axios.delete(url[, config])</h5>
<h5 id="axiosheadurl-config">axios.head(url[, config])</h5>
<h5 id="axiosoptionsurl-config">axios.options(url[, config])</h5>
<h5 id="axiosposturl-data-config">axios.post(url[, data[, config]])</h5>
<h5 id="axiosputurl-data-config">axios.put(url[, data[, config]])</h5>
<h5 id="axiospatchurl-data-config">axios.patch(url[, data[, config]])</h5>
<h6 id="note">NOTE</h6>
<p>When using the alias methods <code>url</code>, <code>method</code>, and <code>data</code> properties don&rsquo;t need to be specified in config.</p>
<h3 id="并发性弃用">并发性(弃用)</h3>
<p>Please use <code>Promise.all</code> to replace the below functions.</p>
<p>Helper functions for dealing with concurrent requests.</p>
<p>axios.all(iterable)
axios.spread(callback)</p>
<h3 id="创建一个实例">创建一个实例</h3>
<p>You can create a new instance of axios with a custom config.</p>
<h5 id="axioscreateconfig">axios.create([config])</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">instance</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">create</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">baseURL</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;https://some-domain.com/api/&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">timeout</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">headers</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#4e9a06">&#34;X-Custom-Header&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;foobar&#34;</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><h3 id="实例方法">实例方法</h3>
<p>The available instance methods are listed below. The specified config will be merged with the instance config.</p>
<h5 id="axiosrequestconfig-1">axios#request(config)</h5>
<h5 id="axiosgeturl-config-1">axios#get(url[, config])</h5>
<h5 id="axiosdeleteurl-config-1">axios#delete(url[, config])</h5>
<h5 id="axiosheadurl-config-1">axios#head(url[, config])</h5>
<h5 id="axiosoptionsurl-config-1">axios#options(url[, config])</h5>
<h5 id="axiosposturl-data-config-1">axios#post(url[, data[, config]])</h5>
<h5 id="axiosputurl-data-config-1">axios#put(url[, data[, config]])</h5>
<h5 id="axiospatchurl-data-config-1">axios#patch(url[, data[, config]])</h5>
<h5 id="axiosgeturiconfig">axios#getUri([config])</h5>
<h2 id="请求配置">请求配置</h2>
<p>These are the available config options for making requests. Only the <code>url</code> is required. Requests will default to <code>GET</code> if <code>method</code> is not specified.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// `url` is the server URL that will be used for the request
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">url</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;/user&#39;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// `method` is the request method to be used when making the request
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">method</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;get&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// default
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// `baseURL` will be prepended to `url` unless `url` is absolute.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// It can be convenient to set `baseURL` for an instance of axios to pass relative URLs
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// to methods of that instance.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">baseURL</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;https://some-domain.com/api/&#39;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// `transformRequest` allows changes to the request data before it is sent to the server
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// This is only applicable for request methods &#39;PUT&#39;, &#39;POST&#39;, &#39;PATCH&#39; and &#39;DELETE&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// The last function in the array must return a string or an instance of Buffer, ArrayBuffer,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// FormData or Stream
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// You may modify the headers object.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">transformRequest</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">headers</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Do whatever you want to transform the data
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}],</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// `transformResponse` allows changes to the response data to be made before
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// it is passed to then/catch
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">transformResponse</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Do whatever you want to transform the data
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}],</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// `headers` are custom headers to be sent
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">headers</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#39;X-Requested-With&#39;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;XMLHttpRequest&#39;</span><span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// `params` are the URL parameters to be sent with the request
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Must be a plain object or a URLSearchParams object
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">params</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ID</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">12345</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// `paramsSerializer` is an optional function in charge of serializing `params`
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// (e.g. https://www.npmjs.com/package/qs, http://api.jquery.com/jquery.param/)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">paramsSerializer</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">params</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">Qs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stringify</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">params</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">arrayFormat</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;brackets&#39;</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// `data` is the data to be sent as the request body
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Only applicable for request methods &#39;PUT&#39;, &#39;POST&#39;, &#39;DELETE , and &#39;PATCH&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// When no `transformRequest` is set, must be of one of the following types:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// - string, plain object, ArrayBuffer, ArrayBufferView, URLSearchParams
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// - Browser only: FormData, File, Blob
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// - Node only: Stream, Buffer
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">firstName</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;Fred&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// syntax alternative to send data into the body
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// method post
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// only the value is sent, not the key
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;Country=Brasil&amp;City=Belo Horizonte&#39;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// `timeout` specifies the number of milliseconds before the request times out.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// If the request takes longer than `timeout`, the request will be aborted.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">timeout</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// default is `0` (no timeout)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// `withCredentials` indicates whether or not cross-site Access-Control requests
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// should be made using credentials
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">withCredentials</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// default
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// `adapter` allows custom handling of requests which makes testing easier.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Return a promise and supply a valid response (see lib/adapters/README.md).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">adapter</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* ... */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// `auth` indicates that HTTP Basic auth should be used, and supplies credentials.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// This will set an `Authorization` header, overwriting any existing
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// `Authorization` custom headers you have set using `headers`.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Please note that only HTTP Basic auth is configurable through this parameter.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// For Bearer tokens and such, use `Authorization` custom headers instead.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">auth</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">username</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;janedoe&#39;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;s00pers3cret&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// `responseType` indicates the type of data that the server will respond with
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// options are: &#39;arraybuffer&#39;, &#39;document&#39;, &#39;json&#39;, &#39;text&#39;, &#39;stream&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">//   browser only: &#39;blob&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">responseType</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;json&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// default
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// `responseEncoding` indicates encoding to use for decoding responses (Node.js only)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Note: Ignored for `responseType` of &#39;stream&#39; or client-side requests
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">responseEncoding</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;utf8&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// default
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// `xsrfCookieName` is the name of the cookie to use as a value for xsrf token
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">xsrfCookieName</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;XSRF-TOKEN&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// default
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// `xsrfHeaderName` is the name of the http header that carries the xsrf token value
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">xsrfHeaderName</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;X-XSRF-TOKEN&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// default
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// `onUploadProgress` allows handling of progress events for uploads
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// browser only
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">onUploadProgress</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">progressEvent</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Do whatever you want with the native progress event
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// `onDownloadProgress` allows handling of progress events for downloads
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// browser only
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">onDownloadProgress</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">progressEvent</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Do whatever you want with the native progress event
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// `maxContentLength` defines the max size of the http response content in bytes allowed in node.js
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">maxContentLength</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2000</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// `maxBodyLength` (Node only option) defines the max size of the http request content in bytes allowed
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">maxBodyLength</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2000</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// `validateStatus` defines whether to resolve or reject the promise for a given
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// HTTP response status code. If `validateStatus` returns `true` (or is set to `null`
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// or `undefined`), the promise will be resolved; otherwise, the promise will be
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// rejected.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">validateStatus</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">status</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">status</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">200</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">status</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">300</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// default
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// `maxRedirects` defines the maximum number of redirects to follow in node.js.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// If set to 0, no redirects will be followed.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">maxRedirects</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">21</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// default
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// `beforeRedirect` defines a function that will be called before redirect.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Use this to adjust the request options upon redirecting,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// to inspect the latest response headers,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// or to cancel the request by throwing an error
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// If maxRedirects is set to 0, `beforeRedirect` is not used.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">beforeRedirect</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">headers</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">hostname</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;example.com&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">auth</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;user:password&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// `socketPath` defines a UNIX Socket to be used in node.js.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// e.g. &#39;/var/run/docker.sock&#39; to send requests to the docker daemon.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Only either `socketPath` or `proxy` can be specified.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// If both are specified, `socketPath` is used.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">socketPath</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// default
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// `httpAgent` and `httpsAgent` define a custom agent to be used when performing http
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// and https requests, respectively, in node.js. This allows options to be added like
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// `keepAlive` that are not enabled by default.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">httpAgent</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Agent</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">keepAlive</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">}),</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">httpsAgent</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">https</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Agent</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">keepAlive</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">}),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// `proxy` defines the hostname, port, and protocol of the proxy server.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// You can also define your proxy using the conventional `http_proxy` and
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// `https_proxy` environment variables. If you are using environment variables
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// for your proxy configuration, you can also define a `no_proxy` environment
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// variable as a comma-separated list of domains that should not be proxied.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Use `false` to disable proxies, ignoring environment variables.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// `auth` indicates that HTTP Basic auth should be used to connect to the proxy, and
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// supplies credentials.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// This will set an `Proxy-Authorization` header, overwriting any existing
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// `Proxy-Authorization` custom headers you have set using `headers`.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// If the proxy server uses HTTPS, then you must set the protocol to `https`.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">proxy</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">protocol</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;https&#39;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;127.0.0.1&#39;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">9000</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auth</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">username</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;mikeymike&#39;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;rapunz3l&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// `cancelToken` specifies a cancel token that can be used to cancel the request
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// (see Cancellation section below for details)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">cancelToken</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">CancelToken</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cancel</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// an alternative way to cancel Axios requests using AbortController
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">signal</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbortController</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">signal</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// `decompress` indicates whether or not the response body should be decompressed
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// automatically. If set to `true` will also remove the &#39;content-encoding&#39; header
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// from the responses objects of all decompressed responses
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// - Node only (XHR cannot turn off decompression)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">decompress</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#8f5902;font-style:italic">// default
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// `insecureHTTPParser` boolean.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Indicates where to use an insecure HTTP parser that accepts invalid HTTP headers.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// This may allow interoperability with non-conformant HTTP implementations.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Using the insecure parser should be avoided.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// see options https://nodejs.org/dist/latest-v12.x/docs/api/http.html#http_http_request_url_options_callback
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// see also https://nodejs.org/en/blog/vulnerability/february-2020-security-releases/#strict-http-header-parsing-none
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">insecureHTTPParser</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">undefined</span> <span style="color:#8f5902;font-style:italic">// default
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// transitional options for backward compatibility that may be removed in the newer versions
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">transitional</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// silent JSON parsing mode
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// `true`  - ignore JSON parsing errors and set response.data to null if parsing failed (old behaviour)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// `false` - throw SyntaxError if JSON parsing failed (Note: responseType must be set to &#39;json&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">silentJSONParsing</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// default value for the current Axios version
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// try to parse the response string as JSON even if `responseType` is not &#39;json&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">forcedJSONParsing</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// throw ETIMEDOUT error instead of generic ECONNABORTED on request timeouts
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">clarifyTimeoutError</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">env</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// The FormData class to be used to automatically serialize the payload into a FormData object
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">FormData</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87">window</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FormData</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">global</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FormData</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="响应模式">响应模式</h2>
<p>The response for a request contains the following information.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// `data` is the response that was provided by the server
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{},</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// `status` is the HTTP status code from the server response
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">status</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// `statusText` is the HTTP status message from the server response
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">statusText</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;OK&#39;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// `headers` the HTTP headers that the server responded with
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// All header names are lower cased and can be accessed using the bracket notation.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Example: `response.headers[&#39;content-type&#39;]`
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">headers</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{},</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// `config` is the config that was provided to `axios` for the request
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">config</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{},</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// `request` is the request that generated this response
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// It is the last ClientRequest instance in node.js (in redirects)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// and an XMLHttpRequest instance in the browser
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>When using <code>then</code>, you will receive the response as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/user/12345&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">status</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">statusText</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">headers</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>When using <code>catch</code>, or passing a <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/then">rejection callback</a> as second parameter of <code>then</code>, the response will be available through the <code>error</code> object as explained in the <a href="#handling-errors">Handling Errors</a> section.</p>
<h2 id="配置默认">配置默认</h2>
<p>您可以指定将应用于每个请求的默认配置。</p>
<h3 id="全局-axios-默认">全局 axios 默认</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">defaults</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">baseURL</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;https://api.example.com&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Important: If axios is used with multiple domains, the AUTH_TOKEN will be sent to all of them.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// See below for an example using Custom instance defaults instead.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">defaults</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">headers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">common</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;Authorization&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">AUTH_TOKEN</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">defaults</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">headers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;Content-Type&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;application/x-www-form-urlencoded&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><h3 id="自定义实例默认">自定义实例默认</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Set config defaults when creating the instance
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">instance</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">create</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">baseURL</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;https://api.example.com&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Alter defaults after instance has been created
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">instance</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">defaults</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">headers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">common</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;Authorization&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">AUTH_TOKEN</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><h3 id="配置优先顺序">配置优先顺序</h3>
<p>Config will be merged with an order of precedence. The order is library defaults found in <a href="https://github.com/axios/axios/blob/master/lib/defaults.js#L28">lib/defaults.js</a>, then <code>defaults</code> property of the instance, and finally <code>config</code> argument for the request. The latter will take precedence over the former. Here&rsquo;s an example.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Create an instance using the config defaults provided by the library
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// At this point the timeout config value is `0` as is the default for the library
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">instance</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">create</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Override timeout default for the library
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Now all requests using this instance will wait 2.5 seconds before timing out
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">instance</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">defaults</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">timeout</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2500</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Override timeout for this request as it&#39;s known to take a long time
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">instance</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/longRequest&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">timeout</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">5000</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><h2 id="拦截器">拦截器</h2>
<p>You can intercept requests or responses before they are handled by <code>then</code> or <code>catch</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Add a request interceptor
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">interceptors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">use</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Do something before request is sent
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Do something with request error
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reject</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Add a response interceptor
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">interceptors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">use</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Any status code that lie within the range of 2xx cause this function to trigger
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Do something with response data
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">response</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Any status codes that falls outside the range of 2xx cause this function to trigger
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Do something with response error
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reject</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>If you need to remove an interceptor later you can.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">myInterceptor</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">interceptors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">use</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">/*...*/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">interceptors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">eject</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">myInterceptor</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>You can add interceptors to a custom instance of axios.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">instance</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">create</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000">instance</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">interceptors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">use</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">/*...*/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>When you add request interceptors, they are presumed to be asynchronous by default. This can cause a delay
in the execution of your axios request when the main thread is blocked (a promise is created under the hood for
the interceptor and your request gets put on the bottom of the call stack). If your request interceptors are synchronous you can add a flag
to the options object that will tell axios to run the code synchronously and avoid any delays in request execution.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">interceptors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">use</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">headers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">test</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;I am only a header!&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">synchronous</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>If you want to execute a particular interceptor based on a runtime check,
you can add a <code>runWhen</code> function to the options object. The interceptor will not be executed <strong>if and only if</strong> the return
of <code>runWhen</code> is <code>false</code>. The function will be called with the config
object (don&rsquo;t forget that you can bind your own arguments to it as well.) This can be handy when you have an
asynchronous request interceptor that only needs to run at certain times.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">onGetCall</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">method</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;get&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">interceptors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">use</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">headers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">test</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;special get headers&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">runWhen</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">onGetCall</span> <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><h3 id="多个拦截器">多个拦截器</h3>
<p>Given you add multiple response interceptors
and when the response was fulfilled</p>
<ul>
<li>then each interceptor is executed</li>
<li>then they are executed in the order they were added</li>
<li>then only the last interceptor&rsquo;s result is returned</li>
<li>then every interceptor receives the result of it&rsquo;s predecessor</li>
<li>and when the fulfillment-interceptor throws
<ul>
<li>then the following fulfillment-interceptor is not called</li>
<li>then the following rejection-interceptor is called</li>
<li>once caught, another following fulfill-interceptor is called again (just like in a promise chain).</li>
</ul>
</li>
</ul>
<p>Read <a href="./test/specs/interceptors.spec.js">the interceptor tests</a> for seeing all this in code.</p>
<h2 id="处理错误">处理错误</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/user/12345&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#204a87;font-weight:bold">catch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// The request was made and the server responded with a status code
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// that falls out of the range of 2xx
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">status</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">headers</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// The request was made but no response was received
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// `error.request` is an instance of XMLHttpRequest in the browser and an instance of
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// http.ClientRequest in node.js
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Something happened in setting up the request that triggered an Error
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Error&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">error</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>Using the <code>validateStatus</code> config option, you can define HTTP code(s) that should throw an error.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/user/12345&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">validateStatus</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">status</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">status</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">500</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Resolve only if the status code is less than 500
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>Using <code>toJSON</code> you get an object with more information about the HTTP error.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/user/12345&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#204a87;font-weight:bold">catch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toJSON</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><h2 id="取消">取消</h2>
<h3 id="abortcontroller">AbortController</h3>
<p>Starting from <code>v0.22.0</code> Axios supports AbortController to cancel requests in fetch API way:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">controller</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbortController</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">axios</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo/bar&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">signal</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">signal</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">//...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// cancel the request
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">abort</span><span style="color:#000;font-weight:bold">();</span>
</span></span></code></pre></div><h3 id="canceltoken-deprecated">CancelToken <code>👎deprecated</code></h3>
<p>You can also cancel a request using a <em>CancelToken</em>.</p>
<blockquote>
<p>The axios cancel token API is based on the withdrawn <a href="https://github.com/tc39/proposal-cancelable-promises">cancelable promises proposal</a>.</p>
</blockquote>
<blockquote>
<p>This API is deprecated since v0.22.0 and shouldn&rsquo;t be used in new projects</p>
</blockquote>
<p>You can create a cancel token using the <code>CancelToken.source</code> factory as shown below:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">CancelToken</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CancelToken</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">source</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">CancelToken</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">source</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">axios</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/user/12345&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cancelToken</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">source</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">token</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">catch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrown</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isCancel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrown</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Request canceled&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">thrown</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic">// handle error
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;/user/12345&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;new name&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cancelToken</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">source</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">token</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// cancel the request (the message parameter is optional)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">source</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cancel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Operation canceled by the user.&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>You can also create a cancel token by passing an executor function to the <code>CancelToken</code> constructor:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">CancelToken</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CancelToken</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">cancel</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/user/12345&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">cancelToken</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">CancelToken</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">executor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// An executor function receives a cancel function as a parameter
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">cancel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}),</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// cancel the request
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">cancel</span><span style="color:#000;font-weight:bold">();</span>
</span></span></code></pre></div><blockquote>
<p>Note: you can cancel several requests with the same cancel token/abort controller.
If a cancellation token is already cancelled at the moment of starting an Axios request, then the request is cancelled immediately, without any attempts to make real request.</p>
</blockquote>
<blockquote>
<p>During the transition period, you can use both cancellation APIs, even for the same request:</p>
</blockquote>
<h2 id="使用-applicationx-www-form-urlencoded-格式">使用 application/x-www-form-urlencoded 格式</h2>
<p>By default, axios serializes JavaScript objects to <code>JSON</code>. To send data in the <code>application/x-www-form-urlencoded</code> format instead, you can use one of the following options.</p>
<h3 id="浏览器">浏览器</h3>
<p>In a browser, you can use the <a href="https://developer.mozilla.org/en-US/docs/Web/API/URLSearchParams"><code>URLSearchParams</code></a> API as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">params</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">URLSearchParams</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000">params</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;param1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;value1&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">params</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;param2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;value2&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">params</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><blockquote>
<p>Note that <code>URLSearchParams</code> is not supported by all browsers (see <a href="http://www.caniuse.com/#feat=urlsearchparams">caniuse.com</a>), but there is a <a href="https://github.com/WebReflection/url-search-params">polyfill</a> available (make sure to polyfill the global environment).</p>
</blockquote>
<p>Alternatively, you can encode data using the <a href="https://github.com/ljharb/qs"><code>qs</code></a> library:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">qs</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;qs&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">qs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stringify</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">bar</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">123</span> <span style="color:#000;font-weight:bold">}));</span>
</span></span></code></pre></div><p>Or in another way (ES6),</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">qs</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;qs&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">bar</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">123</span> <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">options</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">method</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;POST&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">headers</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#4e9a06">&#34;content-type&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;application/x-www-form-urlencoded&#34;</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">qs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stringify</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">url</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><h3 id="nodejs">Node.js</h3>
<h4 id="查询字符串">查询字符串</h4>
<p>In node.js, you can use the <a href="https://nodejs.org/api/querystring.html"><code>querystring</code></a> module as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">querystring</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;querystring&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;http://something.com/&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">querystring</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stringify</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;bar&#34;</span> <span style="color:#000;font-weight:bold">}));</span>
</span></span></code></pre></div><p>or <a href="https://nodejs.org/api/url.html#url_class_urlsearchparams">&lsquo;URLSearchParams&rsquo;</a> from <a href="https://nodejs.org/api/url.html">&lsquo;url module&rsquo;</a> as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">url</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;url&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">params</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">url</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">URLSearchParams</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;bar&#34;</span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;http://something.com/&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">params</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">());</span>
</span></span></code></pre></div><p>You can also use the <a href="https://github.com/ljharb/qs"><code>qs</code></a> library.</p>
<blockquote>
<p>NOTE:
The <code>qs</code> library is preferable if you need to stringify nested objects, as the <code>querystring</code> method has <a href="https://github.com/nodejs/node-v0.x-archive/issues/1665">known issues</a> with that use case.</p>
</blockquote>
<h4 id="表单数据">表单数据</h4>
<h5 id="-自动序列化">🆕 自动序列化</h5>
<p>Starting from <code>v0.27.0</code>, Axios supports automatic object serialization to a FormData object if the request <code>Content-Type</code>
header is set to <code>multipart/form-data</code>.</p>
<p>The following request will submit the data in a FormData format (Browser &amp; Node.js):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">axios</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;axios&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">axios</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;https://httpbin.org/post&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">headers</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;Content-Type&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;multipart/form-data&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">data</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">));</span>
</span></span></code></pre></div><p>In the <code>node.js</code> build, the (<a href="https://github.com/form-data/form-data"><code>form-data</code></a>) polyfill is used by default.</p>
<p>You can overload the FormData class by setting the <code>env.FormData</code> config variable,
but you probably won&rsquo;t need it in most cases:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">axios</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;axios&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">FormData</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;form-data&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">axios</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;https://httpbin.org/post&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">buf</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Buffer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">headers</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;Content-Type&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;multipart/form-data&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">data</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">));</span>
</span></span></code></pre></div><p>Axios FormData serializer supports some special endings to perform the following operations:</p>
<ul>
<li><code>{}</code> - serialize the value with JSON.stringify</li>
<li><code>[]</code> - unwrap the array like object as separate fields with the same key</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">axios</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;axios&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">axios</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;https://httpbin.org/post&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;myObj{}&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;foo&#34;</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;files[]&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87">document</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">querySelector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;#fileInput&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">files</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">headers</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;Content-Type&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;multipart/form-data&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">data</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">));</span>
</span></span></code></pre></div><p>Axios supports the following shortcut methods: <code>postForm</code>, <code>putForm</code>, <code>patchForm</code>
which are just the corresponding http methods with a header preset: <code>Content-Type</code>: <code>multipart/form-data</code>.</p>
<p>FileList object can be passed directly:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postForm</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;https://httpbin.org/post&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">document</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">querySelector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;#fileInput&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">files</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>All files will be sent with the same field names: <code>files[]</code>;</p>
<h5 id="手动-formdata-传递">手动 FormData 传递</h5>
<p>In node.js, you can use the <a href="https://github.com/form-data/form-data"><code>form-data</code></a> library as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">FormData</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;form-data&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">form</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">FormData</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000">form</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;my_field&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;my value&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">form</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;my_buffer&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Buffer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span><span style="color:#000">form</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;my_file&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createReadStream</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo/bar.jpg&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;https://example.com&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">form</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><h2 id="semver">Semver</h2>
<p>Until axios reaches a <code>1.0</code> release, breaking changes will be released with a new minor version. For example <code>0.5.1</code>, and <code>0.5.4</code> will have the same API, but <code>0.6.0</code> will have breaking changes.</p>
<h2 id="promises">Promises</h2>
<p>axios depends on a native ES6 Promise implementation to be <a href="http://caniuse.com/promises">supported</a>.
If your environment doesn&rsquo;t support ES6 Promises, you can <a href="https://github.com/jakearchibald/es6-promise">polyfill</a>.</p>
<h2 id="typescript">TypeScript</h2>
<p>axios includes <a href="http://typescriptlang.org">TypeScript</a> definitions and a type guard for axios errors.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">user</span>: <span style="color:#204a87;font-weight:bold">User</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">data</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/user?ID=12345&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">userDetails</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isAxiosError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">handleAxiosError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">handleUnexpectedError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="在线一键设置">在线一键设置</h2>
<p>您可以使用 Gitpod 作为一个在线 IDE(对于开放源码是免费的)来在线贡献或运行示例。</p>
<p><a href="https://gitpod.io/#https://github.com/axios/axios/blob/master/examples/server.js"><img src="https://gitpod.io/button/open-in-gitpod.svg" alt="Open in Gitpod"></a></p>
<h2 id="资源">资源</h2>
<ul>
<li><a href="https://github.com/axios/axios/blob/master/CHANGELOG.md">Changelog</a></li>
<li><a href="https://github.com/axios/axios/blob/master/UPGRADE_GUIDE.md">Upgrade Guide</a></li>
<li><a href="https://github.com/axios/axios/blob/master/ECOSYSTEM.md">Ecosystem</a></li>
<li><a href="https://github.com/axios/axios/blob/master/CONTRIBUTING.md">Contributing Guide</a></li>
<li><a href="https://github.com/axios/axios/blob/master/CODE_OF_CONDUCT.md">Code of Conduct</a></li>
</ul>
<h2 id="功劳">功劳</h2>
<p>axios 很大程度上受到了<a href="https://angularjs.org/">AngularJS</a>中提供的<a href="https://docs.angularjs.org/api/ng/service/$http">$http 服务</a>的启发。
最终，axios 致力于提供一个独立的、类似于“$http”的服务，以便在 AngularJS 之外使用。</p>
<h2 id="证书">证书</h2>
<p><a href="LICENSE">MIT</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-dd26dd96b691f783eb7fff9d7bf21702">4.2 - @narando/nest-axios-interceptor</h1>
    
	<blockquote>
<p><a href="https://github.com/narando/nest-axios-interceptor">https://github.com/narando/nest-axios-interceptor</a></p>
</blockquote>
<p>为 NestJS <a href="https://docs.nestjs.com/techniques/http-module">HttpModule/HttpService</a>轻松构建和配置<a href="https://github.com/axios/axios#interceptors">axios 拦截器</a>。</p>
<p align="center">
    <a href="https://www.npmjs.com/package/@narando/nest-axios-interceptor" target="_blank"><img src="https://img.shields.io/npm/v/@narando/nest-axios-interceptor.svg" alt="NPM Version"/></a>
    <a href="https://www.npmjs.com/package/@narando/nest-axios-interceptor" target="_blank"><img src="https://img.shields.io/npm/l/@narando/nest-axios-interceptor.svg" alt="Package License"/></a>
    <a href="https://www.npmjs.com/package/@narando/nest-axios-interceptor" target="_blank"><img src="https://img.shields.io/npm/dm/@narando/nest-axios-interceptor.svg" alt="NPM Downloads"/></a>
    <a href="https://github.com/narando/nest-axios-interceptor/actions?query=workflow%3A%22CI%22" target="_blank"><img src="https://img.shields.io/github/workflow/status/narando/nest-axios-interceptor/CI/master" alt="Travis"/></a>
</p>
<h2 id="特性">特性</h2>
<ul>
<li>定义 axios 拦截器</li>
<li><code>HttpService.axiosRef</code> 上的注册拦截器</li>
<li>请求配置中自定义选项的类型安全处理</li>
</ul>
<h2 id="使用">使用</h2>
<blockquote>
<p>⚠️ 如果你想在 NestJS 版本 6 或 7 中使用@narando/nest-axios-interceptor，请使用 v1 版本。
v2 版本只兼容 NestJS Version 8 和@nestjs/axios 包。</p>
</blockquote>
<h3 id="安装">安装</h3>
<p>安装这个模块:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ npm i @narando/nest-axios-interceptor
</span></span></code></pre></div><h3 id="创建一个-axiosinterceptor">创建一个 <code>AxiosInterceptor</code></h3>
<p>创建一个新模块并导入 <code>HttpModule</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// cats.module.ts
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">HttpModule</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">HttpService</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/axios&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Module</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">imports</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">HttpModule</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">providers</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">HttpService</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">CatsModule</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span></code></pre></div><p>用这个样板文件引导你的新拦截器:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// logging.axios-interceptor.ts
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">HttpService</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/axios&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AxiosRequestConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">AxiosResponse</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;axios&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AxiosInterceptor</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">AxiosFulfilledInterceptor</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">AxiosRejectedInterceptor</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@narando/nest-axios-interceptor&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">LoggingAxiosInterceptor</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">AxiosInterceptor</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">httpService</span>: <span style="color:#204a87;font-weight:bold">HttpService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">super</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">httpService</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// requestFulfilled(): AxiosFulfilledInterceptor&lt;AxiosRequestConfig&gt; {}
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// requestRejected(): AxiosRejectedInterceptor {}
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// responseFulfilled(): AxiosFulfilledInterceptor&lt;AxiosResponse&gt; {}
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// responseRejected(): AxiosRejectedInterceptor {}
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>默认情况下，拦截器为所有 4 个可能的事件使用标识函数(no-op)。</p>
<p>要添加您的行为，覆盖您想要处理的事件的类方法，并返回一个将在拦截器中使用的函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// logging.axios-interceptor.ts
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">LoggingAxiosInterceptor</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">AxiosInterceptor</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">httpService</span>: <span style="color:#204a87;font-weight:bold">HttpService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">super</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">httpService</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">requestFulfilled</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">AxiosFulfilledInterceptor</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">AxiosRequestConfig</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic">// Log outgoing request
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`Request: </span><span style="color:#4e9a06">${</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">method</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> </span><span style="color:#4e9a06">${</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">path</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// requestRejected(): AxiosRejectedInterceptor {}
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// responseFulfilled(): AxiosFulfilledInterceptor&lt;AxiosResponse&gt; {}
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// responseRejected(): AxiosRejectedInterceptor {}
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="为请求配置设置自定义选项">为请求配置设置自定义选项</h3>
<p>如果你想把数据从一个拦截器传递到另一个拦截器，把它添加到请求配置对象中。</p>
<p>首先，定义新的请求配置类型。为了避免与其他拦截器的冲突，我们将定义一个 Symbol，并将其用作 object 的键:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// logging.axios-interceptor.ts
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">LOGGING_CONFIG_KEY</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Symbol</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kLoggingAxiosInterceptor&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Merging our custom properties with the base config
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">LoggingConfig</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">AxiosRequestConfig</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">[</span><span style="color:#000">LOGGING_CONFIG_KEY</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>现在我们必须更新拦截器来使用这个新的配置:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span>  // logging.axios-interceptor.ts
</span></span><span style="display:flex;"><span>  @Injectable()
</span></span><span style="display:flex;"><span><span style="color:#a40000">- export class LoggingAxiosInterceptor extends AxiosInterceptor {
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#00a000">+ export class LoggingAxiosInterceptor extends AxiosInterceptor&lt;LoggingConfig&gt; {
</span></span></span><span style="display:flex;"><span><span style="color:#00a000"></span>    constructor(httpService: HttpService) {
</span></span><span style="display:flex;"><span>      super(httpService);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">-   requestFulfilled(): AxiosFulfilledInterceptor&lt;AxiosRequestConfig&gt; {
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#00a000">+   requestFulfilled(): AxiosFulfilledInterceptor&lt;LoggingConfig&gt; {
</span></span></span><span style="display:flex;"><span><span style="color:#00a000"></span>      return (config) =&gt; {
</span></span><span style="display:flex;"><span>        // Log outgoing request
</span></span><span style="display:flex;"><span>        console.log(`Request: ${config.method} ${config.path}`);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        return config;
</span></span><span style="display:flex;"><span>      };
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    // requestRejected(): AxiosRejectedInterceptor {}
</span></span><span style="display:flex;"><span><span style="color:#a40000">-   // responseFulfilled(): AxiosFulfilledInterceptor&lt;AxiosResponse&gt; {}
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#00a000">+   // responseFulfilled(): AxiosFulfilledInterceptor&lt;AxiosResponseCustomConfig&lt;LoggingConfig&gt;&gt; {}
</span></span></span><span style="display:flex;"><span><span style="color:#00a000"></span>    // responseRejected(): AxiosRejectedInterceptor {}
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>有了更新的类型，你现在可以使用扩展配置:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// logging.axios-interceptor.ts
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">LOGGING_CONFIG_KEY</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Symbol</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kLoggingAxiosInterceptor&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">LoggingAxiosInterceptor</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">AxiosInterceptor</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">LoggingConfig</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">httpService</span>: <span style="color:#204a87;font-weight:bold">HttpService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">super</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">httpService</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">requestFulfilled</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">AxiosFulfilledInterceptor</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">LoggingConfig</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">requestId</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1234</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">config</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">LOGGING_CONFIG_KEY</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">requestId</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic">// Log outgoing request
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`Request(ID=</span><span style="color:#4e9a06">${</span><span style="color:#000">requestId</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">): </span><span style="color:#4e9a06">${</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">method</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> </span><span style="color:#4e9a06">${</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">path</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// requestRejected(): AxiosRejectedInterceptor {}
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">responseFulfilled</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">AxiosFulfilledInterceptor</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">AxiosResponseCustomConfig</span><span style="color:#a40000">&lt;</span><span style="color:#c4a000">LoggingConfig</span><span style="color:#000;font-weight:bold">&gt;</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">requestId</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">LOGGING_CONFIG_KEY</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic">// Log response
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`Response(ID=</span><span style="color:#4e9a06">${</span><span style="color:#000">requestId</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">): </span><span style="color:#4e9a06">${</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">status</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">response</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// responseRejected(): AxiosRejectedInterceptor {}
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="处理错误">处理错误</h3>
<p>默认情况下，axios error (rejected)拦截器传递类型为<code>any</code>的错误。这并不是很有用，因为我们不能用它做任何事情。</p>
<p>在内部， <code>axios</code> 将所有错误封装在一个自定义对象<code>AxiosError</code>中。我们可以使用类方法 <code>isAxiosError</code> 来断言传递的错误确实是 <code>AxiosError</code> 类型的，然后按我们想要的方式处理它:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// logging.axios-interceptor.ts
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">LoggingAxiosInterceptor</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">AxiosInterceptor</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">httpService</span>: <span style="color:#204a87;font-weight:bold">HttpService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">super</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">httpService</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// requestFulfilled(): AxiosFulfilledInterceptor&lt;AxiosRequestConfig&gt; {}
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// requestRejected(): AxiosRejectedInterceptor {}
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// responseFulfilled(): AxiosFulfilledInterceptor&lt;AxiosResponse&gt; {}
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">responseRejected</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">AxiosRejectedInterceptor</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isAxiosError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">response</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`Error </span><span style="color:#4e9a06">${</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">status</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> in request &#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">method</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> </span><span style="color:#4e9a06">${</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">path</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Unexpected generic error&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="许可证">许可证</h2>
<p>此存储库是在<a href="./License">MIT License</a>下发布的。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-bd61d63598630dbbb21d96e9ff9b7e80">4.3 - axios-auth-refresh</h1>
    
	<blockquote>
<p><a href="https://github.com/Flyrell/axios-auth-refresh">https://github.com/Flyrell/axios-auth-refresh</a></p>
</blockquote>
<p><img src="https://img.shields.io/npm/v/axios-auth-refresh?label=version" alt="Package version">
<img src="https://img.shields.io/bundlephobia/min/axios-auth-refresh" alt="Package size">
<img src="https://img.shields.io/npm/dm/axios-auth-refresh" alt="Package downloads">
<img src="https://img.shields.io/npm/types/axios-auth-refresh" alt="Package types definitions"></p>
<p>帮助您通过 axios <a href="https://github.com/axios/axios#interceptors">interceptors</a>实现自动刷新授权的库。
当原始请求失败时，您可以轻松地拦截它，刷新授权并继续原始请求，而不需要任何用户交互。</p>
<p>当请求由于授权而失败时，将发生什么完全取决于您。
您可以为新的授权令牌运行刷新调用，也可以运行自定义逻辑。</p>
<p>在等待新的授权令牌时，插件将暂停已进入的其他请求，并在新令牌可用时解析它们。</p>
<h2 id="安装">安装</h2>
<p>使用<a href="https://www.npmjs.com/get-npm">npm</a>或<a href="https://yarnpkg.com/en/docs/install">yarn</a>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>npm install axios-auth-refresh --save
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># or</span>
</span></span><span style="display:flex;"><span>yarn add axios-auth-refresh
</span></span></code></pre></div><h2 id="语法">语法</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#000">createAuthRefreshInterceptor</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">axios</span>: <span style="color:#204a87;font-weight:bold">AxiosInstance</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">refreshAuthLogic</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">failedRequest</span>: <span style="color:#204a87;font-weight:bold">any</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">any</span><span style="color:#000;font-weight:bold">&gt;,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">options</span>: <span style="color:#204a87;font-weight:bold">AxiosAuthRefreshOptions</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><h4 id="参数">参数</h4>
<ul>
<li><code>axios</code> - Axios 的实例</li>
<li><code>refreshAuthLogic</code> - 一个用于刷新授权的函数(<strong>必须返回一个承诺</strong>)。
只接受一个参数，即原始调用返回的&rsquo; failedRequest &lsquo;。</li>
<li><code>options</code> - 对象的拦截器设置(参见<a href="#available-options">可用选项</a>)</li>
</ul>
<h4 id="返回">返回</h4>
<p>拦截器<code>id</code>，以防你想手动拒绝它。</p>
<h2 id="使用">使用</h2>
<p>为了激活拦截器，您需要从<em>默认导出</em>的<code>axios-auth-refresh</code>导入一个函数，并使用想要拦截器的<strong>axios 实例</strong>调用它，以及需要编写刷新授权逻辑的<strong>刷新授权函数</strong>。</p>
<p>然后拦截器将被绑定到 axios 实例上，当从服务器(或您在选项中提供的任何其他状态代码)返回<a href="https://httpstatuses.com/401">401 (Unauthorized)</a>状态代码时，指定的逻辑就会运行。
在 refreshAuthLogic 处理期间创建的所有新请求都将被绑定到从 refreshAuthLogic 函数返回的 Promise 上。这意味着当获取新的访问令牌或刷新逻辑失败时，请求将得到解决。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">axios</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;axios&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">createAuthRefreshInterceptor</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;axios-auth-refresh&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Function that will be called to refresh authorization
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">refreshAuthLogic</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">failedRequest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;https://www.example.com/auth/token/refresh&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">tokenRefreshResponse</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">localStorage</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">setItem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;token&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tokenRefreshResponse</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">token</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">failedRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">headers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;Authorization&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;Bearer &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">tokenRefreshResponse</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">token</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resolve</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Instantiate the interceptor
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">createAuthRefreshInterceptor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">refreshAuthLogic</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Make a call. If it returns a 401 error, the refreshAuthLogic will be run,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// and the request retried with the new token
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;https://www.example.com/restricted/area&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#8f5902;font-style:italic">/* ... */</span><span style="color:#000;font-weight:bold">).</span><span style="color:#204a87;font-weight:bold">catch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#8f5902;font-style:italic">/* ... */</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><h4 id="跳过拦截器">跳过拦截器</h4>
<p>:warning: 由于错误<a href="https://github.com/axios/axios/issues/2295">axios#2295</a>不支持 v0.19.0。 :warning:</p>
<p>:white_check_mark: 这个问题已经修复，将在 axios v0.19.1 中发布</p>
<p>对于特定的调用，有可能跳过拦截器的逻辑。
要做到这一点，你需要为每个你不想拦截的请求传递<code>skipAuthRefresh</code>选项到请求配置。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;https://www.example.com/&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">skipAuthRefresh</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>如果你使用的是 TypeScript，你可以从<code>axios-auth-refresh</code>中导入自定义请求配置接口。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AxiosAuthRefreshRequestConfig</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;axios-auth-refresh&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><h4 id="请求拦截器">请求拦截器</h4>
<p>由于这个插件会在刷新令牌的同时自动停止其他请求，所以将请求逻辑<strong>包装在一个函数中</strong>是一个好主意，以确保暂停的请求使用了新获取的数据(比如令牌)。</p>
<p>发送令牌的示例:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Obtain the fresh token each time the function is called
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">getAccessToken</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">localStorage</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getItem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;token&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Use interceptor to inject the token to requests
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">interceptors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">use</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">headers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;Authorization&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">`Bearer </span><span style="color:#4e9a06">${</span><span style="color:#000">getAccessToken</span><span style="color:#000;font-weight:bold">()</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><h2 id="可用选项">可用选项</h2>
<h4 id="要拦截的状态代码">要拦截的状态代码</h4>
<p>您可以指定多个希望拦截器运行的状态代码。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">statusCodes</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">401</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">403</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#8f5902;font-style:italic">// default: [ 401 ]
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h4 id="自定义拦截逻辑">自定义拦截逻辑</h4>
<p>您可以指定多个希望拦截器运行的状态代码。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">shouldRefresh</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000">error</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">business_error_code</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#0000cf;font-weight:bold">100385</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h4 id="停止请求的重试实例">停止请求的重试实例</h4>
<p>您可以指定用于重试停止的请求的实例。
默认值为<code>undefined</code>，并使用传递给<code>createAuthRefreshInterceptor</code>函数的实例。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">retryInstance</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">someAxiosInstance</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// default: undefined
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h4 id="onretry-在发送停止的请求之前回调"><code>onRetry</code> 在发送停止的请求之前回调</h4>
<p>你可以指定<code>onRetry</code>回调，它将在每个暂停的请求被调用之前，使用请求配置对象调用。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">onRetry</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">requestConfig</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">({</span> <span style="color:#000;font-weight:bold">...</span><span style="color:#000">requestConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">baseURL</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// default: undefined
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h4 id="在刷新逻辑运行时暂停实例">在“刷新逻辑”运行时暂停实例</h4>
<p>当您的刷新逻辑运行时，拦截器将为每个返回指定的<code>options.statusCodes</code>之一的请求(默认为 HTTP 401)触发。</p>
<p>为了防止拦截器循环(当你的刷新逻辑由于<code>options.statusCodes</code>中指定的任何状态代码而失败时)，你需要在<code>refreshAuthLogic</code>函数内的刷新调用中使用<a href="#skip-the-interceptor"><code>skipAuthRefresh</code></a>标志。</p>
<p>如果您的刷新逻辑不进行任何调用，您应该考虑在初始化拦截器时使用以下标志，以便在刷新挂起时暂停整个 axios 实例。
这将防止拦截器对每个失败的请求运行。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">pauseInstanceWhileRefreshing</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// default: false
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h4 id="拦截网络错误">拦截网络错误</h4>
<p>当返回一个 HTTP 401 Unauthorized 响应时，一些 CORS api 可能不会返回 CORS 响应头。
在这种情况下，浏览器将无法读取响应头来确定响应状态代码。</p>
<p>要拦截<em>any</em>网络错误，启用<code>interceptNetworkError</code>选项。</p>
<p>CAUTION: 这应该作为最后的手段。如果此方法用于处理带有 HTTP 401 响应的不支持 CORS 的 API，则重试逻辑可以测试尝试刷新身份验证的网络连通性。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">interceptNetworkError</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// default: undefined
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="库的其他用途">库的其他用途</h3>
<p>这个库还被用于:</p>
<ul>
<li>自动请求节流<a href="https://github.com/amcsi">@amcsi</a></li>
<li>Google2FA 的 OTP 挑战<a href="https://github.com/LeoniePhiline">@LeoniePhiline</a></li>
</ul>
<p>你把它用在别的地方了吗?用你的用例创建一个公共关系来分享它。</p>
<hr>
<h3 id="更新日志">更新日志</h3>
<ul>
<li>
<p><strong>v3.1.0</strong></p>
<ul>
<li>axios v0.21.1 支持</li>
<li><code>interceptNetworkError</code> . See <a href="https://github.com/Flyrell/axios-auth-refresh/issues/133">#133</a>.</li>
</ul>
</li>
<li>
<p><strong>v3.0.0</strong></p>
<ul>
<li><code>skipWhileRefresh</code> flag has been deprecated due to its unclear name and its logic has been moved to <code>pauseInstanceWhileRefreshing</code> flag</li>
<li><code>pauseInstanceWhileRefreshing</code> is set to <code>false</code> by default</li>
</ul>
</li>
</ul>
<hr>
<h4 id="想要帮助吗">想要帮助吗?</h4>
<p>查看<a href="CONTRIBUTING.md">贡献指南</a>或我的<a href="https://www.patreon.com/dawidzbinski">patreon page!</a></p>
<hr>
<h4 id="特别感谢jetbrainshttpswwwjetbrainscomfromaxios-auth-refresh为我们的库提供了-ide">特别感谢<a href="https://www.jetbrains.com/?from=axios-auth-refresh">JetBrains</a>为我们的库提供了 IDE</h4>
<p><a href="https://www.jetbrains.com/?from=axios-auth-refresh" title="Link to JetBrains"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/1a/JetBrains_Logo_2016.svg/128px-JetBrains_Logo_2016.svg.png" alt="JetBrains"></a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-521bdc42e36a3e9034f654fddd1b3aa2">4.4 - 错误处理和数据验证</h1>
    
	<blockquote>
<p><a href="https://wanago.io/2020/06/01/api-nestjs-error-handling-validation/">https://wanago.io/2020/06/01/api-nestjs-error-handling-validation/</a></p>
</blockquote>
<p>在处理错误和验证数据方面， <code>NestJS</code> 非常出色。
这在很大程度上要归功于使用装饰器。
在本文中，我们将介绍 <code>NestJS</code> 提供的特性，例如异常过滤器和验证管道。</p>
<p>本系列的代码生成了这个<a href="https://github.com/mwanago/nestjs-typescript">存储库</a>。
它的目标是成为<a href="https://github.com/nestjs/typescript-starter">官方 <code>Nest</code> 框架 <code>TypeScript</code> 入门</a>版的扩展版本。</p>
<h2 id="异常过滤器">异常过滤器</h2>
<p><code>Nest</code> 有一个异常过滤器，负责处理应用程序中的错误。
每当我们自己不处理异常时，异常过滤器就会替我们处理。
它处理异常并以用户友好的格式将其发送到响应中。</p>
<p>默认的异常过滤器名为 <code>BaseExceptionFilter</code> 。
我们可以查看 <code>NestJS</code> 的源代码并检查它的行为。</p>
<p>nest/packages/core/exceptions/base-exception-filter.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">BaseExceptionFilter</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">T</span> <span style="color:#a40000">=</span> <span style="color:#c4a000">any</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#204a87;font-weight:bold">implements</span> <span style="color:#000">ExceptionFilter</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">T</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">catch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">exception</span>: <span style="color:#204a87;font-weight:bold">T</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">host</span>: <span style="color:#204a87;font-weight:bold">ArgumentsHost</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">exception</span> <span style="color:#204a87;font-weight:bold">instanceof</span> <span style="color:#000">HttpException</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">handleUnknownError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">exception</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">host</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">applicationRef</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">res</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">exception</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getResponse</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">message</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">isObject</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000">res</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">statusCode</span>: <span style="color:#204a87;font-weight:bold">exception.getStatus</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">message</span>: <span style="color:#204a87;font-weight:bold">res</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">handleUnknownError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">exception</span>: <span style="color:#204a87;font-weight:bold">T</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">host</span>: <span style="color:#204a87;font-weight:bold">ArgumentsHost</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">applicationRef</span>: <span style="color:#204a87;font-weight:bold">AbstractHttpAdapter</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">HttpServer</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">body</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">statusCode</span>: <span style="color:#204a87;font-weight:bold">HttpStatus.INTERNAL_SERVER_ERROR</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">message</span>: <span style="color:#204a87;font-weight:bold">MESSAGES.UNKNOWN_EXCEPTION_MESSAGE</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>每当应用程序中出现错误时， <code>catch</code> 方法就会运行。
我们可以从上述代码中获得一些基本信息。</p>
<h3 id="httpexception">HttpException</h3>
<p>Nest 希望我们使用 <code>HttpException</code> 类。
如果我们不这样做，它将错误解释为无意的，并以 <code>500</code> 内部服务器错误响应。</p>
<p>在本系列的前几部分中，我们已经多次使用了 <code>HttpException</code>:</p>
<p>抛出新的 <code>HttpException('Post not found'， HttpStatus.NOT_FOUND)</code>;
构造函数接受两个必需的参数:响应体和状态代码。
对于后者，我们可以使用提供的 HttpStatus enum。</p>
<p>如果我们提供一个字符串作为响应的定义，NestJS 将其序列化为一个包含两个属性的对象:</p>
<ul>
<li>statusCode:包含我们选择的 HTTP 代码</li>
<li>message:我们提供的描述</li>
</ul>
<p><img src="https://wanago.io/wp-content/uploads/2020/05/Screenshot-from-2020-05-31-15-01-51.png" alt=""></p>
<blockquote>
<p>我们可以通过提供一个对象作为 <code>HttpException</code> 构造函数的第一个参数来重写上述行为。</p>
</blockquote>
<p>我们经常发现自己不止一次地抛出类似的异常。
为了避免代码重复，我们可以创建自定义异常。
为此，我们需要扩展 <code>HttpException</code> 类。</p>
<p>posts/exception/postNotFund.exception.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">HttpException</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">HttpStatus</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostNotFoundException</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">HttpException</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">postId</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">super</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`Post with id </span><span style="color:#4e9a06">${</span><span style="color:#000">postId</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> not found`</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">HttpStatus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NOT_FOUND</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>我们的自定义 <code>PostNotFoundException</code> 调用 <code>HttpException</code> 的构造函数。
因此，我们可以通过不必在每次想要抛出错误时都定义消息来清理代码。</p>
<p>NestJS 有一组扩展 HttpException 的异常。
其中一个是 <code>NotFoundException。</code>
我们可以重构上面的代码并使用它。</p>
<blockquote>
<p>我们可以在文档中找到完整的内置 <code>HTTP</code> 异常列表。</p>
</blockquote>
<p>posts/exception/postNotFund.exception.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">NotFoundException</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostNotFoundException</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">NotFoundException</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">postId</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">super</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`Post with id </span><span style="color:#4e9a06">${</span><span style="color:#000">postId</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> not found`</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>NotFoundException</code> 类的第一个参数是一个附加的错误属性。
这样，我们的消息就由 <code>NotFoundException</code> 定义，并且是基于状态的。</p>
<p><img src="https://wanago.io/wp-content/uploads/2020/05/Screenshot-from-2020-05-31-15-37-16.png" alt=""></p>
<h3 id="扩展-baseexceptionfilter">扩展 <code>BaseExceptionFilter</code></h3>
<p>默认的 <code>BaseExceptionFilter</code> 可以处理大多数常规情况。
然而，我们可能想要以某种方式修改它。
最简单的方法是创建一个扩展它的过滤器。</p>
<p>utils/exceptionsLogger.filter.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Catch</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ArgumentsHost</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">BaseExceptionFilter</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/core&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Catch</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">ExceptionsLoggerFilter</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">BaseExceptionFilter</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">catch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">exception</span>: <span style="color:#204a87;font-weight:bold">unknown</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">host</span>: <span style="color:#204a87;font-weight:bold">ArgumentsHost</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Exception thrown&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exception</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">super</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">catch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">exception</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">host</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>@Catch()</code>装饰器意味着我们希望过滤器捕获所有异常。
我们可以向它提供一个异常类型或一个列表。</p>
<p><code>ArgumentsHost</code> 使我们无法访问应用程序的执行上下文。
我们将在本系列的后续部分对此进行探讨。</p>
<p>我们可以以三种方式使用我们的新过滤器。
第一个是通过 <code>app.useGlobalFilters</code> 在所有路由中全局使用它。</p>
<p>main.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">HttpAdapterHost</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NestFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/core&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AppModule</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./app.module&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">cookieParser</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;cookie-parser&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ExceptionsLoggerFilter</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./utils/exceptionsLogger.filter&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">bootstrap() {</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">app</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">NestFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">AppModule</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">httpAdapter</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">HttpAdapterHost</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">useGlobalFilters</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">ExceptionsLoggerFilter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">httpAdapter</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">use</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cookieParser</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">listen</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3000</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">bootstrap</span><span style="color:#000;font-weight:bold">();</span>
</span></span></code></pre></div><p>更好的全局注入过滤器的方法是将它添加到 <code>AppModule</code> 中。
因此，我们可以向过滤器中注入额外的依赖项。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Module</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ExceptionsLoggerFilter</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./utils/exceptionsLogger.filter&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">APP_FILTER</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/core&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Module</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">providers</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">provide</span>: <span style="color:#204a87;font-weight:bold">APP_FILTER</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">useClass</span>: <span style="color:#204a87;font-weight:bold">ExceptionsLoggerFilter</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">AppModule</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span></code></pre></div><p>绑定过滤器的第三种方法是附加 <code>@UseFilters</code> 装饰器。
我们可以为它提供单个过滤器，或多个过滤器。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;:id&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@UseFilters</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ExceptionsLoggerFilter</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">getPostById</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Param</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;id&#39;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getPostById</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">Number</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>上面的方法并不是记录异常的最佳方法。
<code>NestJS</code> 有一个内置的 <code>Logger</code> ，我们将在本系列接下来的部分中介绍它。</p>
<h3 id="实现-exceptionfilter-接口">实现 <code>ExceptionFilter</code> 接口</h3>
<p>如果我们需要一个完全定制的错误行为，我们可以从头构建过滤器。
它需要实现 <code>ExceptionFilter</code> 接口。
让我们来看一个例子:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ExceptionFilter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Catch</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ArgumentsHost</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NotFoundException</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Response</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;express&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Catch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">NotFoundException</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">HttpExceptionFilter</span> <span style="color:#204a87;font-weight:bold">implements</span> <span style="color:#000">ExceptionFilter</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">catch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">exception</span>: <span style="color:#204a87;font-weight:bold">NotFoundException</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">host</span>: <span style="color:#204a87;font-weight:bold">ArgumentsHost</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">context</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">host</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">switchToHttp</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">response</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getResponse</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Response</span><span style="color:#000;font-weight:bold">&gt;();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">request</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getRequest</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Request</span><span style="color:#000;font-weight:bold">&gt;();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">status</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">exception</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getStatus</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">message</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">exception</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getMessage</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">status</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">status</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">json</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">message</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">statusCode</span>: <span style="color:#204a87;font-weight:bold">status</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">time</span>: <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Date</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">toISOString</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>上面有一些值得注意的事情。
因为我们使用了<code>@Catch(NotFoundException)</code>，所以这个过滤器只对 <code>NotFoundException</code> 运行。</p>
<p><code>host.switchToHttp</code> 方法返回带有 <code>HTTP</code> 上下文信息的 <code>HttpArgumentsHost</code> 对象。
在本系列的后续部分中，当讨论执行上下文时，我们将对它进行大量探讨。</p>
<h2 id="验证">验证</h2>
<p>我们肯定应该验证即将到来的数据。
在 <code>TypeScript Express</code> 系列中，我们使用了类验证器库。
<code>NestJS</code> 也合并了它。</p>
<p><code>NestJS</code> 附带了一组内置管道。
管道通常用于转换输入数据或验证数据。
今天我们只使用预定义的管道，但在本系列的后续部分中，我们可能会研究如何创建自定义管道。</p>
<p>要开始验证数据，我们需要 <code>ValidationPipe。</code></p>
<p>main.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">NestFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/core&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AppModule</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./app.module&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">cookieParser</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;cookie-parser&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ValidationPipe</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">bootstrap() {</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">app</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">NestFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">AppModule</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">useGlobalPipes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">ValidationPipe</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">use</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cookieParser</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">listen</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3000</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">bootstrap</span><span style="color:#000;font-weight:bold">();</span>
</span></span></code></pre></div><p>在本系列的第一部分中，我们已经创建了数据传输对象。
它们定义在请求中发送的数据的格式。
它们是附加验证的完美地方。</p>
<p>NPM 安装类验证器类转换器
为了让 <code>ValidationPipe</code> 工作，我们还需要类转换器库</p>
<p>auth/dto/register.dto.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">IsEmail</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">IsString</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">IsNotEmpty</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">MinLength</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">RegisterDto</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsEmail</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsString</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsNotEmpty</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsString</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsNotEmpty</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@MinLength</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">password</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">RegisterDto</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>由于我们使用了上面的 <code>RegisterDto</code> 和<code>@Body()</code>装饰器， <code>ValidationPipe</code> 现在检查数据。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Post</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;register&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">register</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Body</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">registrationData</span>: <span style="color:#204a87;font-weight:bold">RegisterDto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">authenticationService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">register</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">registrationData</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><img src="https://wanago.io/wp-content/uploads/2020/05/Screenshot-from-2020-05-31-18-56-58.png" alt=""></p>
<p>我们可以使用的装饰器还有很多。
要获得完整列表，请查看<a href="https://github.com/typestack/class-validator">类验证器</a>文档。
您还可以<a href="https://github.com/typestack/class-validator#custom-validation-decorators">创建自定义验证装饰器</a>。</p>
<h3 id="验证参数">验证参数</h3>
<p>我们也可以使用类验证器库来验证参数。</p>
<p>utils/findOneParams.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">IsNumberString</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#39;class-validator&#39;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">FindOneParams</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsNumberString</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;:id&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">getPostById</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Param</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span> <span style="color:#000;font-weight:bold">}</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">FindOneParams</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getPostById</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">Number</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>请注意我们在这里不再使用<code>@Param('id')</code>。
相反，我们分解整个 <code>params</code> 对象。</p>
<p>如果你使用 <code>MongoDB</code> 而不是 <code>Postgres，</code> <code>@IsMongoId()</code>装饰器可能会对你有用</p>
<h2 id="处理-patch">处理 Patch</h2>
<p>在 <a href="https://wanago.io/2020/04/27/typescript-express-put-vs-patch-mongodb-mongoose/">TypeScript Express 系列</a>中，我们讨论了 PUT 和 PATCH 方法的区别。
总而言之，PUT 替换实体，而 PATCH 应用部分修改。
在执行部分更改时，我们需要跳过缺失的属性。</p>
<p>处理 PATCH 最直接的方法是将 skipMissingProperties 传递给我们的 ValidationPipe。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">useGlobalPipes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">ValidationPipe</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">skipMissingProperties</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">}));</span>
</span></span></code></pre></div><p>不幸的是，这将跳过我们所有 <code>dto</code> 中缺少的属性。
我们在发布数据时不想这样做。
相反，我们可以在更新数据时向所有属性添加 <code>IsOptional</code> 。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">IsString</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">IsNotEmpty</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">IsNumber</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">IsOptional</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UpdatePostDto</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsNumber</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsString</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsNotEmpty</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">content</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsString</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsNotEmpty</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>不幸的是，上面的解决方案不是很干净。
<a href="https://github.com/nestjs/nest/issues/2390">这里</a>提供了一些解决方案来覆盖 <code>ValidationPipe</code> 的默认行为。</p>
<blockquote>
<p>在本系列的后续部分中，我们将研究如何实现 PUT 而不是 PATCH</p>
</blockquote>
<h2 id="总结">总结</h2>
<p>在本文中，我们研究了错误处理和验证在 <code>NestJS</code> 中是如何工作的。
由于了解了默认 <code>BaseExceptionFilter</code> 在底层是如何工作的，我们现在知道了如何正确地处理各种异常。
我们也知道如果有这样的需要，如何改变默认行为。
我们还学习了如何使用 <code>ValidationPipe</code> 和类验证器库来验证传入的数据。</p>
<p>在 NestJS 框架中还有很多内容需要涉及，所以请继续关注!</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ac7867d0efde557b312fc601141a570b">4.5 - node-cache-manager - 灵活的NodeJS缓存模块</h1>
    
	<blockquote>
<p><a href="https://github.com/BryanDonovan/node-cache-manager">https://github.com/BryanDonovan/node-cache-manager</a></p>
</blockquote>
<p><a href="http://travis-ci.org/BryanDonovan/node-cache-manager"><img src="https://secure.travis-ci.org/BryanDonovan/node-cache-manager.svg" alt="build status"></a>
<a href="https://coveralls.io/r/BryanDonovan/node-cache-manager?branch=master"><img src="https://coveralls.io/repos/BryanDonovan/node-cache-manager/badge.svg?branch=master" alt="Coverage Status"></a></p>
<p>一个用于 nodejs 的缓存模块，允许在缓存、分级缓存和一致的接口中轻松包装函数。</p>
<h2 id="特性">特性</h2>
<ul>
<li>在缓存中包装任何函数的简单方法。</li>
<li>分级缓存——数据存储在每个缓存中，并首先从最高优先级的缓存中获取。</li>
<li>使用任何你想要的缓存，只要它有相同的 API。</li>
<li>通过<a href="https://github.com/visionmedia/mocha">mocha</a>， <a href="https://github.com/yahoo/istanbul">istanbul</a>和<a href="http://sinonjs.org">sinon</a>实现 100%的测试覆盖率。</li>
</ul>
<h2 id="expressjs-例子">Express.js 例子</h2>
<p>参见<a href="https://github.com/BryanDonovan/node-cache-manager-express-example">Express.js cache-manager 示例应用</a>了解如何在你的应用中使用 <code>node-cache-manager</code>。</p>
<h2 id="安装">安装</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>npm install cache-manager
</span></span></code></pre></div><h2 id="存储引擎">存储引擎</h2>
<ul>
<li>
<p><a href="https://github.com/dial-once/node-cache-manager-redis">node-cache-manager-redis</a> (uses <a href="https://github.com/joshuah/sol-redis-pool">sol-redis-pool</a>)</p>
</li>
<li>
<p><a href="https://github.com/dabroek/node-cache-manager-redis-store">node-cache-manager-redis-store</a> (uses <a href="https://github.com/NodeRedis/node_redis">node_redis</a>)</p>
</li>
<li>
<p><a href="https://github.com/dabroek/node-cache-manager-ioredis">node-cache-manager-ioredis</a> (uses <a href="https://github.com/luin/ioredis">ioredis</a>)</p>
</li>
<li>
<p><a href="https://github.com/v4l3r10/node-cache-manager-mongodb">node-cache-manager-mongodb</a></p>
</li>
<li>
<p><a href="https://github.com/disjunction/node-cache-manager-mongoose">node-cache-manager-mongoose</a></p>
</li>
<li>
<p><a href="https://github.com/sheershoff/node-cache-manager-fs-binary">node-cache-manager-fs-binary</a></p>
</li>
<li>
<p><a href="https://github.com/rolandstarke/node-cache-manager-fs-hash">node-cache-manager-fs-hash</a></p>
</li>
<li>
<p><a href="https://github.com/marudor/node-cache-manager-hazelcast">node-cache-manager-hazelcast</a></p>
</li>
<li>
<p><a href="https://github.com/theogravity/node-cache-manager-memcached-store">node-cache-manager-memcached-store</a></p>
</li>
<li>
<p><a href="https://github.com/theogravity/node-cache-manager-memory-store">node-cache-manager-memory-store</a></p>
</li>
<li>
<p><a href="https://github.com/davidepellegatta/node-cache-manager-couchbase">node-cache-manager-couchbase</a></p>
</li>
</ul>
<h2 id="概述">概述</h2>
<h3 id="wrap-函数"><code>wrap</code> 函数</h3>
<p><strong>首先</strong>，它包含一个 <code>wrap</code> 函数，可以让你在缓存中包装任何函数。
(注意，这是受到<a href="https://github.com/mape/node-caching">node-caching</a>的启发。)
这可能就是您正在寻找的功能。举个例子，你可能需要这样做:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">getCachedUser</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">memoryCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">getUser</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">memoryCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>&hellip; 你可以使用<code>wrap</code>函数:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">getCachedUser</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">memoryCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">wrap</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cacheCallback</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">getUser</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cacheCallback</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ttl</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">ttl</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cb</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="内存缓存">内存缓存</h3>
<p><strong>第二</strong>，<code>node-cache-manager</code> 具有内置的内存缓存(使用<a href="https://github.com/isaacs/node-lru-cache">node-lru-cache</a>)，与你期望在大多数缓存中的标准函数:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>    <span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">val</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">ttl</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">ttl</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">//</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">see</span> <span style="color:#000">note</span> <span style="color:#000">below</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">del</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">mset</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">val1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">val2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">ttl</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">ttl</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">//</span> <span style="color:#000">set</span> <span style="color:#000">several</span> <span style="color:#000">keys</span> <span style="color:#000">at</span> <span style="color:#000">once</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">mget</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">//</span> <span style="color:#000">get</span> <span style="color:#000">several</span> <span style="color:#000">keys</span> <span style="color:#000">at</span> <span style="color:#000">once</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">//</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">Note</span> <span style="color:#000">that</span> <span style="color:#000">depending</span> <span style="color:#000">on</span> <span style="color:#000">the</span> <span style="color:#000">underlying</span> <span style="color:#000">store</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">you</span> <span style="color:#000">may</span> <span style="color:#000">be</span> <span style="color:#000">able</span> <span style="color:#000">to</span> <span style="color:#000">pass</span> <span style="color:#000">the</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">//</span> <span style="color:#000">ttl</span> <span style="color:#000">as</span> <span style="color:#000">the</span> <span style="color:#000">third</span> <span style="color:#000">param</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">like</span> <span style="color:#000">this</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">val</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ttl</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">//</span> <span style="color:#000;font-weight:bold">...</span> <span style="color:#204a87;font-weight:bold">or</span> <span style="color:#000">pass</span> <span style="color:#000">no</span> <span style="color:#000">ttl</span> <span style="color:#000">at</span> <span style="color:#000">all</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">val</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="分级缓存">分级缓存</h3>
<p><strong>第三</strong>，<code>node-cache-manager</code> 允许你设置分级缓存策略。
在大多数情况下，这可能是有限的使用，但想象一下这样一个场景:你期望大量的流量，并不想每次请求都冲击你的主缓存(如 Redis)。
您决定将最常见的请求数据存储在内存缓存中，可能具有非常短的超时时间和/或较小的数据大小限制。
但你还是想把数据存储在 Redis 中，以备备份，以及处理那些不像你想存储在内存中的请求那样常见的请求。
这是 <code>node-cache-manager</code> 可以轻松且透明地处理的。</p>
<h3 id="设置多个键">设置多个键</h3>
<p><strong>第四</strong>，它允许你获得和设置多个键，一次为缓存存储，支持它。
这意味着当获得多个键时，它将从最高优先级的开始通过不同的缓存(见下面的多存储)，并合并它在每个级别上找到的值。</p>
<h2 id="用法示例">用法示例</h2>
<p>参见下面的示例和示例目录中的示例。
参见 <code>examples/redis_example</code> ，了解如何使用连接池实现 Redis 缓存存储。</p>
<h3 id="单一的存储">单一的存储</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">cacheManager</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;cache-manager&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">memoryCache</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cacheManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">caching</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">store</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;memory&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">max</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ttl</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">10</span> <span style="color:#8f5902;font-style:italic">/*seconds*/</span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">ttl</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Note: callback is optional in set() and del().
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Note: memory cache clones values before setting them unless `shouldCloneBeforeSet` is set to false
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#000">memoryCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ttl</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">ttl</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">memoryCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// &gt;&gt; &#39;bar&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">memoryCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">del</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{});</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">getUser</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">setTimeout</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Returning user from slow database.&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Bob&#34;</span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">userId</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">123</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;user_&#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">userId</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Note: ttl is optional in wrap()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">memoryCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">wrap</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">getUser</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ttl</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">ttl</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Second time fetches user from memoryCache
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">memoryCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">wrap</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">getUser</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Outputs:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Returning user from slow database.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// { id: 123, name: &#39;Bob&#39; }
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// { id: 123, name: &#39;Bob&#39; }
</span></span></span></code></pre></div><p><code>ttl</code> 也可以通过传入一个函数来动态计算。例如,</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">opts</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ttl</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0.1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0.5</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">memoryCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">wrap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">getUser</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">},</span> <span style="color:#000">opts</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>你可以一次拿几个键。
请注意，这将返回它在缓存中找到的任何记录，由用户根据所提供的键检查结果，并调用底层数据存储来填充缺失的记录。
在实践中，如果你只是使用<code>wrap</code>函数在缓存中设置这些记录，这应该不是一个大问题。</p>
<blockquote>
<p>附注: 理想情况下， <code>wrap</code> 函数将从缓存中获得它所能得到的，并从数据存储中填充缺失的记录，但我无法想到一种适用于所有情况的方法来做到这一点。
另一种选择是，如果找到了所有记录，则只返回缓存中的数据，但这将破坏多缓存。</p>
</blockquote>
<p>更多信息请参见<code>caching.unit.js</code>中的单元测试。</p>
<p>例子:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">key1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;user_1&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">key2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;user_1&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">memoryCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">wrap</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">key1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">key2</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">getManyUser</span><span style="color:#000;font-weight:bold">([</span><span style="color:#000">key1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key2</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">users</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">users</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">users</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><h4 id="使用-mset和-mget设置获取几个键的示例">使用 mset()和 mget()设置/获取几个键的示例</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000">memoryCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mset</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;foo2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ttl</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">ttl</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">memoryCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mget</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;foo2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// &gt;&gt; [&#39;bar&#39;, &#39;bar2&#39;]
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Delete keys with del() passing arguments...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">memoryCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">del</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;foo2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// ...passing an Array of keys
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">memoryCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">del</span><span style="color:#000;font-weight:bold">([</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;foo2&#34;</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{});</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><h4 id="例子中使用的承诺">例子中使用的承诺</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#000">memoryCache</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">wrap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">getUserPromise</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;User:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>如果您使用的 Node 版本不包括本机承诺，您可以在传递给缓存模块的选项中指定承诺依赖项。例如,</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#204a87">Promise</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;es6-promise&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">cache</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">caching</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">store</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">store</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">promiseDependency</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87">Promise</span> <span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><h4 id="使用异步等待示例">使用异步/等待示例</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">memoryCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">wrap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">getUserPromise</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// error handling
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><blockquote>
<p>提示:应该用<code>try</code> - <code>catch</code>封装<code>await</code>调用来处理<code>promise</code>错误。</p>
</blockquote>
<h4 id="express-应用使用示例">Express 应用使用示例</h4>
<p>(参见<a href="https://github.com/BryanDonovan/node-cache-manager-express-example">Express.js 缓存管理器示例应用</a>).</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">respond</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">json</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">500</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">json</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/foo/bar&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">res</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">cacheKey</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;foo-bar:&#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">JSON</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stringify</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">query</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">ttl</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">memoryCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">wrap</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cacheKey</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cacheCallback</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">DB</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">find</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">query</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cacheCallback</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ttl</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">ttl</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">respond</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><h4 id="定制店">定制店</h4>
<p>你可以通过创建一个与内置内存存储相同的 API(如 redis 或 memcached 存储)来使用自己的自定义存储。
要使用自己的存储，只需传入它的一个实例。</p>
<p>E.g.,</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">myStore</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;your-homemade-store&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">cache</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cacheManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">caching</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">store</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">myStore</span> <span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><h3 id="multi-store">Multi-Store</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">multiCache</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cacheManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">multiCaching</span><span style="color:#000;font-weight:bold">([</span><span style="color:#000">memoryCache</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">someOtherCache</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">userId2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">456</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">key2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;user_&#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">userId</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ttl</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Sets in all caches.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// The &#34;ttl&#34; option can also be a function (see example below)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">multiCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ttl</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">ttl</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// Fetches from highest priority cache that has the key.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">multiCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// &gt;&gt; &#39;bar2&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Delete from all caches
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">multiCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">del</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo2&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Set the ttl value by context depending on the store.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">getTTL</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">store</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">store</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;redis&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">6000</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">3000</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Sets multiple keys in all caches.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// You can pass as many key,value pair as you want
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">multiCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mset</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;key&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;value&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;key2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;value2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ttl</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">getTTL</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// mget() fetches from highest priority cache.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// If the first cache does not return all the keys,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// the next cache is fetched with the keys that were not found.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// This is done recursively until either:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// - all have been found
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// - all caches has been fetched
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">multiCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mget</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;key&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;key2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// &gt;&gt; &#39;bar2&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// &gt;&gt; &#39;bar3&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Delete from all caches
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">multiCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">del</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;key&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;key2&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// ...or with an Array
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">multiCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">del</span><span style="color:#000;font-weight:bold">([</span><span style="color:#4e9a06">&#34;key&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;key2&#34;</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Note: options with ttl are optional in wrap()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">multiCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">wrap</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">key2</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">getUser</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ttl</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">ttl</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Second time fetches user from memoryCache, since it&#39;s highest priority.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// If the data expires in the memory cache, the next fetch would pull it from
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// the &#39;someOtherCache&#39;, and set the data in memory again.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">multiCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">wrap</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">key2</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">getUser</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Multiple keys
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">multiCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">wrap</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;key1&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;key2&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">getManyUser</span><span style="color:#000;font-weight:bold">([</span><span style="color:#4e9a06">&#34;key1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;key2&#34;</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ttl</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">ttl</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">users</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">users</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">users</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><h3 id="指定在wrap函数中缓存什么">指定在<code>wrap</code>函数中缓存什么</h3>
<p><code>caching</code>和<code>multicaching</code>模块都允许你传入一个名为<code>isCacheableValue</code>的回调函数，<code>wrap</code>函数会根据从缓存或包装函数返回的每个值来调用这个回调函数。
这让你可以通过<code>wrap</code>来指定哪些值应该缓存，哪些值不应该缓存。
如果函数返回 <code>true</code> ，它将被存储在缓存中。
默认情况下，缓存会缓存除<code>undefined</code>之外的所有内容。</p>
<blockquote>
<p>注意:<code>caching</code>和<code>multicaching</code>中的<code>set</code>函数不使用<code>isCacheableValue</code>。</p>
</blockquote>
<p>例如，如果你不想缓存<code>false</code>和<code>null</code>，你可以像这样传入一个函数:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">isCacheableValue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">!==</span> <span style="color:#204a87;font-weight:bold">null</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">!==</span> <span style="color:#204a87;font-weight:bold">false</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">!==</span> <span style="color:#204a87;font-weight:bold">undefined</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>然后像这样将它传递给&rsquo; caching &lsquo;:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">memoryCache</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cacheManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">caching</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">store</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;memory&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">isCacheableValue</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">isCacheableValue</span> <span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>然后像这样将它传递给“multicaching”:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">multiCache</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cacheManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">multiCaching</span><span style="color:#000;font-weight:bold">([</span><span style="color:#000">memoryCache</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">someOtherCache</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">isCacheableValue</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">isCacheableValue</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><h3 id="在后台刷新缓存键">在后台刷新缓存键</h3>
<p><code>caching</code>和<code>multicaching</code>模块都支持在使用<code>wrap</code>函数时在后台刷新过期缓存键的机制。
这可以通过在创建缓存存储时添加“refreshThreshold”属性来实现。</p>
<p>如果设置了<code>refreshThreshold</code>并且<code>ttl</code>方法对已用存储区可用，则从缓存中获取一个值后将检查 <code>ttl</code> 。
如果剩余的 <code>TTL</code> 小于<code>refreshThreshold</code>，系统将生成一个后台 worker 来更新该值，遵循与标准抓取相同的规则。
同时，系统将返回旧值，直到过期。</p>
<p>在多缓存的情况下，用于刷新的存储区是首先找到键的存储区(优先级最高)。
然后将在所有存储中设置该值。</p>
<p>NOTES:</p>
<ul>
<li>在多缓存的情况下，将被检查刷新的存储是一个键将被首先找到(最高优先级)。</li>
<li>如果阈值很低，工作函数很慢，键可能会过期，你可能会遇到一个更新值的竞赛条件。</li>
<li>后台刷新机制目前不支持提供多键 <code>wrap</code> 功能。</li>
<li>缓存存储需要提供<code>ttl</code>方法。</li>
</ul>
<p>例如，像这样将 <code>refreshThreshold</code> 传递给<code>caching</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">redisStore</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;cache-manager-ioredis&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">redisCache</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cacheManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">caching</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">store</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">redisStore</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">refreshThreshold</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">isCacheableValue</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">isCacheableValue</span> <span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>当从 Redis 中检索到一个剩余 TTL &lt; 3sec 的值时，该值将在后台更新。</p>
<h3 id="开发环境">开发环境</h3>
<p>你可以禁用真正的缓存，但仍然可以通过设置“none”存储来实现所有的回调功能。</p>
<h2 id="文档">文档</h2>
<p>生成 JSDOC 3 文档:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>make docs
</span></span></code></pre></div><h2 id="测试">测试</h2>
<p>要运行测试，请首先运行:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>npm install -d
</span></span></code></pre></div><p>运行测试和 JShint:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>make
</span></span></code></pre></div><h2 id="贡献">贡献</h2>
<p>如果你想为项目做出贡献，请分叉它，并向我们发送一个拉请求。
请为任何新功能或 bug 修复添加测试。
同样在提交 pull 请求之前运行&rsquo; make &lsquo;。</p>
<h2 id="许可证">许可证</h2>
<p><code>node-cache-manager</code> 是在 <code>MIT</code> 许可证下授权的。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-08ab14ce67216c8fad409a2cd3c71ef6">4.6 - 用webhook对Stripe事件做出反应</h1>
    
	<blockquote>
<p><a href="https://wanago.io/2021/07/05/api-nestjs-stripe-events-webhooks/">https://wanago.io/2021/07/05/api-nestjs-stripe-events-webhooks/</a></p>
</blockquote>
<p>到目前为止，在本系列中，我们已经通过发送请求与 Stripe 进行了交互。
它要么是直接在前端请求 Stripe API，要么是在后端请求。
有了网钩，Stripe 可以用另一种方式与我们交流。</p>
<p>Webhook 是我们 API 中的一个 URL, Stripe 可以请求它向我们发送各种事件，如付款信息或客户更新信息。
在本文中，我们将探讨 webhook 的思想，并将其实现到我们的应用程序中，以避免向 Stripe 询问用户订阅状态。
通过这样做，我们旨在提高应用程序的性能并避免超过速率限制。</p>
<h2 id="在-nestjs-中使用-stripe-webhook">在 NestJS 中使用 Stripe webhook</h2>
<p>We aim to develop with Stripe webhooks while running the application on localhost.
When working with webhooks, we expect Stripe to make requests to our API.
By default, our app can’t be accessed from outside while running locally.
Because of that, we need an additional step to test webhooks.
To perform it, we need Stripe CLI.
We can download it here.</p>
<p>We need to forward received events to our local API.
To do it, we need to run the following:</p>
<p>stripe listen &ndash;forward-to localhost:3000/webhook</p>
<h3 id="处理-webhook-签名秘密">处理 webhook 签名秘密</h3>
<p>In response, we receive the webhook signing secret.
We will need it in our API to validate requests made to our /webhook endpoint.</p>
<p>A valid approach is to keep the webhook secret in our environment variables.</p>
<p>app.module.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Module</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ConfigModule</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/config&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">Joi</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@hapi/joi&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Module</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">imports</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ConfigModule</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">forRoot</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">validationSchema</span>: <span style="color:#204a87;font-weight:bold">Joi.object</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">STRIPE_WEBHOOK_SECRET</span>: <span style="color:#204a87;font-weight:bold">Joi.string</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000;font-weight:bold">}),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">controllers</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[],</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">providers</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[],</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">AppModule</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span></code></pre></div><p>.env</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">STRIPE_WEBHOOK_SECRET</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">whsec_</span><span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">#</span> <span style="color:#000;font-weight:bold">...</span>
</span></span></code></pre></div><h3 id="访问请求的原始主体">访问请求的原始主体</h3>
<p>NestJS 使用 body-parser 库来解析传入的请求体。
正因为如此，我们不能直接访问原始的主体。
不过，我们需要使用的处理 webhook 的 Stripe 包需要它。</p>
<p>为了处理上述问题，我们可以创建一个中间件，将原始主体附加到请求中。</p>
<p>rawBody.middleware.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Response</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;express&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">json</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;body-parser&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">RequestWithRawBody</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../stripeWebhook/requestWithRawBody.interface&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">rawBodyMiddleware() {</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">json</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">verify</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span>: <span style="color:#204a87;font-weight:bold">RequestWithRawBody</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">response</span>: <span style="color:#204a87;font-weight:bold">Response</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">buffer</span>: <span style="color:#204a87;font-weight:bold">Buffer</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">url</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;/webhook&#34;</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">Buffer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isBuffer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buffer</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rawBody</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Buffer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buffer</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">rawBodyMiddleware</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>如果你想了解更多关于中间件的知识，请查看 TypeScript Express 教程#1。
中间件、路由和控制器</p>
<p>上面，我们使用了 RequestWithRawBody 接口。
我们需要定义它。</p>
<p>requestWithRawBody.interface.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Request</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;express&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">RequestWithRawBody</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">Request</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">rawBody</span>: <span style="color:#204a87;font-weight:bold">Buffer</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">RequestWithRawBody</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>为了让中间件工作，我们需要在 bootstrap 函数中使用它。</p>
<p>main.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">NestFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/core&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AppModule</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./app.module&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">rawBodyMiddleware</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./utils/rawBody.middleware&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">bootstrap() {</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">app</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">NestFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">AppModule</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">use</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rawBodyMiddleware</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">listen</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3000</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">bootstrap</span><span style="color:#000;font-weight:bold">();</span>
</span></span></code></pre></div><h3 id="解析-webhook-请求">解析 webhook 请求</h3>
<p>当 Stripe 请求我们的 webhook 路由时，我们需要解析请求。
要成功做到这一点，我们需要三件事:</p>
<p>webhook 的密钥，原始的请求负载，Stripe 签名的请求头。
通过 Stripe 签名头，我们可以验证事件是由 Stripe 发送的，而不是由第三方发送的。</p>
<p>当我们拥有了上述所有内容时，我们可以使用 Stripe 库来构造事件数据。</p>
<p>stripe.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ConfigService</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/config&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">Stripe</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;stripe&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">StripeService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">stripe</span>: <span style="color:#204a87;font-weight:bold">Stripe</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">configService</span>: <span style="color:#204a87;font-weight:bold">ConfigService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stripe</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Stripe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">configService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;STRIPE_SECRET_KEY&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">apiVersion</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;2020-08-27&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">constructEventFromPayload</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">signature</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">payload</span>: <span style="color:#204a87;font-weight:bold">Buffer</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">webhookSecret</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">configService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;STRIPE_WEBHOOK_SECRET&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stripe</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">webhooks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">constructEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">payload</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">signature</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">webhookSecret</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>使用 NestJS 管理 Stripe webhook 的最后一步是用<code>/webhook</code>路由创建一个控制器。</p>
<p>stripeWebhook.controller.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Headers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Req</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BadRequestException</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">StripeService</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../stripe/stripe.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">RequestWithRawBody</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./requestWithRawBody.interface&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Controller</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;webhook&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">StripeWebhookController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">stripeService</span>: <span style="color:#204a87;font-weight:bold">StripeService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Post</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">handleIncomingEvents</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Headers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;stripe-signature&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">signature</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">@Req</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">request</span>: <span style="color:#204a87;font-weight:bold">RequestWithRawBody</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">signature</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">BadRequestException</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Missing stripe-signature header&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">event</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stripeService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">constructEventFromPayload</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">signature</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rawBody</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="跟踪订阅的状态">跟踪订阅的状态</h2>
<p>我们可以用 webhook 做的一件事就是跟踪订阅的状态。
为此，让我们展开 User 实体。</p>
<p>user.entity.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Column</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Entity</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PrimaryGeneratedColumn</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;typeorm&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Entity</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@PrimaryGeneratedColumn</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Column</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#204a87;font-weight:bold">unique</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Column</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">nullable</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">monthlySubscriptionStatus?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>We also need a way to set the monthlySubscriptionStatus property.
To do that, we need a new method in our UsersService:</p>
<p>users.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectRepository</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/typeorm&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Repository</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Connection</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">In</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;typeorm&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">User</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./user.entity&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">FilesService</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../files/files.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">StripeService</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../stripe/stripe.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UsersService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">@InjectRepository</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">usersRepository</span>: <span style="color:#204a87;font-weight:bold">Repository</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">updateMonthlySubscriptionStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stripeCustomerId</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">monthlySubscriptionStatus</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">usersRepository</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">stripeCustomerId</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">monthlySubscriptionStatus</span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>To use the above logic, we need to expand our StripeWebhookController:</p>
<p>stripeWebhook.controller.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Headers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Req</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BadRequestException</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">StripeService</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../stripe/stripe.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">RequestWithRawBody</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./requestWithRawBody.interface&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">UsersService</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../users/users.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">Stripe</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;stripe&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Controller</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;webhook&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">StripeWebhookController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">stripeService</span>: <span style="color:#204a87;font-weight:bold">StripeService</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">usersService</span>: <span style="color:#204a87;font-weight:bold">UsersService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Post</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">handleIncomingEvents</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Headers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;stripe-signature&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">signature</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">@Req</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">request</span>: <span style="color:#204a87;font-weight:bold">RequestWithRawBody</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">signature</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">BadRequestException</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Missing stripe-signature header&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">event</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stripeService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">constructEventFromPayload</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">signature</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rawBody</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;customer.subscription.updated&#34;</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">event</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;customer.subscription.created&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">event</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">object</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">Stripe</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Subscription</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">customerId</span>: <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">customer</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">subscriptionStatus</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">status</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">usersService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">updateMonthlySubscriptionStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">customerId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subscriptionStatus</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Above, we had to sort out some TypeScript issues.
Currently, Stripe recommends casting to deal with them.</p>
<p>In our flow, Stripe calls our /webhook endpoint and sends us events.
We check if they are connected to subscriptions by checking the event.type property.
If that’s the case, we can assume that the event.data.object property is a subscription.
With that knowledge, we can update the monthlySubscriptionStatus property of a user.</p>
<h2 id="webhook-幂等性">Webhook 幂等性</h2>
<p>According to the Stripe documentation, Stripe might occasionally send the same event more than once.
They advise us to create a mechanism to guard the application against processing the same event multiple times and making our event processing idempotent.</p>
<p>One way of doing so would be to keep the id of every processed event in the database.</p>
<p>stripeEvent.entity.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Entity</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PrimaryColumn</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#39;typeorm&#39;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Entity</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">StripeEvent</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@PrimaryColumn</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">StripeEvent</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Please</span> <span style="color:#000">notice</span> <span style="color:#000">that</span> <span style="color:#000">above</span> <span style="color:#000">we</span> <span style="color:#000">define</span> <span style="color:#000">a</span> <span style="color:#000">primary</span> <span style="color:#000">column</span> <span style="color:#000">that</span> <span style="color:#204a87;font-weight:bold">is</span> <span style="color:#000">not</span> <span style="color:#000">auto</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">generated</span><span style="color:#000;font-weight:bold">.</span>
</span></span><span style="display:flex;"><span><span style="color:#000">We</span> <span style="color:#000">aim</span> <span style="color:#000">to</span> <span style="color:#000">use</span> <span style="color:#000">the</span> <span style="color:#000">event</span> <span style="color:#000">id</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">Stripe</span> <span style="color:#000">to</span> <span style="color:#000">populate</span> <span style="color:#204a87;font-weight:bold">this</span> <span style="color:#000">column</span><span style="color:#000;font-weight:bold">.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">stripeWebhook</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">service</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ts</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#39;@nestjs/common&#39;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectRepository</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#39;@nestjs/typeorm&#39;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">StripeEvent</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#39;./StripeEvent.entity&#39;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Repository</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#39;typeorm&#39;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">StripeWebhookService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">@InjectRepository</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">StripeEvent</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">eventsRepository</span>: <span style="color:#204a87;font-weight:bold">Repository</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">StripeEvent</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">createEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">eventsRepository</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">insert</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">id</span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">A</span> <span style="color:#000">crucial</span> <span style="color:#000">thing</span> <span style="color:#000">to</span> <span style="color:#000">notice</span> <span style="color:#204a87;font-weight:bold">is</span> <span style="color:#000">that</span> <span style="color:#000">the</span> <span style="color:#000">createEvent</span> <span style="color:#000">throws</span> <span style="color:#000">an</span> <span style="color:#000">error</span> <span style="color:#000">when</span> <span style="color:#000">we</span> <span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000">to</span> <span style="color:#000">use</span> <span style="color:#000">an</span> <span style="color:#000">id</span> <span style="color:#000">that</span> <span style="color:#000">already</span> <span style="color:#000">exists</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000">the</span> <span style="color:#000">database</span><span style="color:#000;font-weight:bold">.</span>
</span></span><span style="display:flex;"><span><span style="color:#000">We</span> <span style="color:#000">can</span> <span style="color:#000">use</span> <span style="color:#000">it</span> <span style="color:#000">to</span> <span style="color:#000">improve</span> <span style="color:#000">our</span> <span style="color:#000">StripeWebhookController</span><span style="color:#000;font-weight:bold">.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">stripeWebhook</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ts</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Headers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Req</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BadRequestException</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#39;@nestjs/common&#39;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">StripeService</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#39;../stripe/stripe.service&#39;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">RequestWithRawBody</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#39;./requestWithRawBody.interface&#39;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">UsersService</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#39;../users/users.service&#39;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">StripeWebhookService</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#39;./stripeWebhook.service&#39;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Controller</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;webhook&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">StripeWebhookController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">stripeService</span>: <span style="color:#204a87;font-weight:bold">StripeService</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">usersService</span>: <span style="color:#204a87;font-weight:bold">UsersService</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">stripeWebhookService</span>: <span style="color:#204a87;font-weight:bold">StripeWebhookService</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Post</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">handleIncomingEvents</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">@Headers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;stripe-signature&#39;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">signature</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">@Req</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">request</span>: <span style="color:#204a87;font-weight:bold">RequestWithRawBody</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">signature</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">BadRequestException</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;Missing stripe-signature header&#39;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">event</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stripeService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">constructEventFromPayload</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">signature</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rawBody</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#39;customer.subscription.updated&#39;</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">event</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#39;customer.subscription.created&#39;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stripeWebhookService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">processSubscriptionUpdate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Since our controller keeps growing, let’s move part of the logic to our StripeWebhookService.</p>
<p>stripeWebhook.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">BadRequestException</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectRepository</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/typeorm&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">StripeEvent</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./StripeEvent.entity&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Repository</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;typeorm&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">Stripe</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;stripe&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostgresErrorCode</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../database/postgresErrorCode.enum&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">UsersService</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../users/users.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">StripeWebhookService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">@InjectRepository</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">StripeEvent</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">eventsRepository</span>: <span style="color:#204a87;font-weight:bold">Repository</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">StripeEvent</span><span style="color:#000;font-weight:bold">&gt;,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">usersService</span>: <span style="color:#204a87;font-weight:bold">UsersService</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">createEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">eventsRepository</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">insert</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">id</span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">processSubscriptionUpdate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">event</span>: <span style="color:#204a87;font-weight:bold">Stripe.Event</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">code</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#000">PostgresErrorCode</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UniqueViolation</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">BadRequestException</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;This event was already processed&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">event</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">object</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">Stripe</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Subscription</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">customerId</span>: <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">customer</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">subscriptionStatus</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">status</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">usersService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">updateMonthlySubscriptionStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">customerId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subscriptionStatus</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>With the above code, our endpoint throws an error when Stripe sends the same event again.</p>
<p>Deleting old events with cron might be a good idea.
If you want to do that, check out API with NestJS #25.
Sending scheduled emails with cron and Nodemailer</p>
<h2 id="总结">总结</h2>
<p>在本文中，我们了解了更多关于 Stripe 的知识，并通过响应 Stripe 事件改进了应用程序。
为了做到这一点，我们必须实现一个接受来自 Stripe 请求的 webhook。
这样做时，我们已经开始跟踪订阅状态的变化。
我们还确保不会对同一个事件进行多次解析。</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b80c626cd4fc7152e0fe4830e68b5d80">5 - logs</h1>
    
	<blockquote>
<p><a href="https://github.com/axios/axios">https://github.com/axios/axios</a></p>
</blockquote>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-d97193c8d36b121e97575fff2ca94e4e">5.1 - 介绍使用内置记录器和TypeORM进行日志记录</h1>
    
	<p>随着应用程序的发展，越来越多的人开始依赖它。
在这样的时刻，确保我们的 API 正常工作是至关重要的。
为此，我们可以使用一种方法对应用程序进行故障排除，以检测异常，并能够找到异常的来源。
本文介绍了如何记录应用程序中发生的事情。</p>
<h2 id="内置到-nestjs-中的-logger">内置到 NestJS 中的 Logger</h2>
<p>幸运的是，NestJS 自带了一个内置的日志记录器。
在使用它之前，我们应该创建它的实例。</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Logger</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">logger</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Logger</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>虽然我们可以直接使用从<code>@nestjs/common</code>导入的 Logger，但为每个服务创建一个全新的实例是一个很好的实践，它允许我们为 Logger 的构造函数提供服务的名称。</p>
<h3 id="日志级别">日志级别</h3>
<p>Logger 的一个关键之处在于它带有一些方法:</p>
<ul>
<li>error</li>
<li>warn</li>
<li>log</li>
<li>verbose</li>
<li>debug</li>
</ul>
<p>上述方法对应于我们可以为应用程序配置的日志级别。</p>
<p>main.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">NestFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/core&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AppModule</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./app.module&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">getLogLevels</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./utils/getLogLevels&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">bootstrap() {</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">app</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">NestFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">AppModule</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">logger</span>: <span style="color:#204a87;font-weight:bold">getLogLevels</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">env</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NODE_ENV</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;production&#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">bootstrap</span><span style="color:#000;font-weight:bold">();</span>
</span></span></code></pre></div><blockquote>
<p>我们没有使用上面的 <code>ConfigService</code> 来读取环境变量，因为它还没有初始化。</p>
</blockquote>
<p>getLogLevels.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">LogLevel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common/services/logger.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">getLogLevels</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">isProduction</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">LogLevel</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">isProduction</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;log&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;warn&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;error&#34;</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;error&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;warn&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;log&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;verbose&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;debug&#34;</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">getLogLevels</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>由于上述设置，调试和详细方法不会在生产环境中产生日志。</p>
<blockquote>
<p>如果我们看一下 <a href="https://github.com/nestjs/nest/blob/90ebd6825754fbd9d007ed3b873da782c75e9be7/packages/common/services/utils/is-log-level-enabled.util.ts">isLogLevelEnabled</a> 函数，我们会注意到提供<code>['debug']</code>会打开所有日志级别，而不仅仅是详细日志级别。
这是因为 NestJS 假设，如果要显示详细日志，还需要显示所有较低级别的日志。
因此，<code>['debug']</code>与<code>['error', 'warn', 'log', 'verbose', 'debug']</code>相同。</p>
<p>我们可以在<a href="https://github.com/nestjs/nest/blob/90ebd6825754fbd9d007ed3b873da782c75e9be7/packages/common/services/console-logger.service.ts#L19">这里</a>找到每个日志级别的重要性。</p>
</blockquote>
<p>在完成上述所有工作之后，让我们开始使用记录器。</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Logger</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">Post</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.entity&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectRepository</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/typeorm&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Repository</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;typeorm&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostNotFoundException</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./exceptions/postNotFound.exception&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">logger</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Logger</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">@InjectRepository</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postsRepository</span>: <span style="color:#204a87;font-weight:bold">Repository</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Post</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">getPostById</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">post</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsRepository</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findOne</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">relations</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;author&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">post</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">warn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Tried to access a post that does not exist&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">PostNotFoundException</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><img src="https://wanago.io/wp-content/uploads/2021/10/Screenshot-from-2021-10-02-17-48-20.png" alt=""></p>
<p>现在我们可以看到，传递 <code>PostsService.name</code> 导致 <code>PostService</code> 作为日志消息的前缀出现。</p>
<h2 id="在中间件中使用日志记录器">在中间件中使用日志记录器</h2>
<p>尽管上述方法可能很方便，但手动编写日志消息可能很麻烦。
幸运的是，我们可以从中间件生成日志。</p>
<p>logs.middleware.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Logger</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NestMiddleware</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Response</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NextFunction</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;express&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">LogsMiddleware</span> <span style="color:#204a87;font-weight:bold">implements</span> <span style="color:#000">NestMiddleware</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">logger</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Logger</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;HTTP&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">use</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span>: <span style="color:#204a87;font-weight:bold">Request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">response</span>: <span style="color:#204a87;font-weight:bold">Response</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">next</span>: <span style="color:#204a87;font-weight:bold">NextFunction</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;finish&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">method</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">originalUrl</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">statusCode</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">statusMessage</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">response</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">message</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">`</span><span style="color:#4e9a06">${</span><span style="color:#000">method</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> </span><span style="color:#4e9a06">${</span><span style="color:#000">originalUrl</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> </span><span style="color:#4e9a06">${</span><span style="color:#000">statusCode</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> </span><span style="color:#4e9a06">${</span><span style="color:#000">statusMessage</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">statusCode</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">500</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">statusCode</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">400</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">warn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">next</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">LogsMiddleware</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><blockquote>
<p>查看 <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status">MDN</a> 文档以阅读更多关于 HTTP 响应状态码的信息。</p>
</blockquote>
<p>在上面，我们收集了关于请求和响应的信息，并根据状态代码对其进行日志记录。
当然，请求和响应对象包含更多有用的信息，所以您可以随意编写更详细的日志。</p>
<p>最后一步是为我们所有的路由应用我们的中间件。</p>
<p>app.module.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">MiddlewareConsumer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Module</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">PostsModule</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./posts/posts.module&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">DatabaseModule</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./database/database.module&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">LogsMiddleware</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./utils/logs.middleware&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Module</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">imports</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">PostsModule</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">DatabaseModule</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">AppModule</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">configure</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">consumer</span>: <span style="color:#204a87;font-weight:bold">MiddlewareConsumer</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">consumer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">apply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">LogsMiddleware</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">forRoutes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;*&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><img src="https://wanago.io/wp-content/uploads/2021/10/Screenshot-from-2021-10-03-17-44-35.png" alt=""></p>
<h2 id="使用-typeorm-记录器">使用 TypeORM 记录器</h2>
<p>我们可以做的另一件有用的事情是记录应用程序中发生的所有 SQL 查询。
为了实现 TypeORM，我们需要实现 Logger 接口:</p>
<p>databaseLogger.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Logger</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">TypeOrmLogger</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;typeorm&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Logger</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">NestLogger</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">DatabaseLogger</span> <span style="color:#204a87;font-weight:bold">implements</span> <span style="color:#000">TypeOrmLogger</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">logger</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">NestLogger</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;SQL&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">logQuery</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">query</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">parameters?</span>: <span style="color:#204a87;font-weight:bold">unknown</span><span style="color:#000;font-weight:bold">[])</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`</span><span style="color:#4e9a06">${</span><span style="color:#000">query</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> -- Parameters: </span><span style="color:#4e9a06">${</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stringifyParameters</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">parameters</span><span style="color:#000;font-weight:bold">)</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">logQueryError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">query</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">parameters?</span>: <span style="color:#204a87;font-weight:bold">unknown</span><span style="color:#000;font-weight:bold">[])</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`</span><span style="color:#4e9a06">${</span><span style="color:#000">query</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> -- Parameters: </span><span style="color:#4e9a06">${</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stringifyParameters</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">parameters</span><span style="color:#000;font-weight:bold">)</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> -- </span><span style="color:#4e9a06">${</span><span style="color:#000">error</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">logQuerySlow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">query</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">parameters?</span>: <span style="color:#204a87;font-weight:bold">unknown</span><span style="color:#000;font-weight:bold">[])</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">warn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`Time: </span><span style="color:#4e9a06">${</span><span style="color:#000">time</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> -- Parameters: </span><span style="color:#4e9a06">${</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stringifyParameters</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">parameters</span><span style="color:#000;font-weight:bold">)</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> -- </span><span style="color:#4e9a06">${</span><span style="color:#000">query</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">logMigration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">logSchemaBuild</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">level</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;log&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;info&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;warn&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">message</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">level</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;log&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">level</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;info&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">debug</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">level</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;warn&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">warn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">stringifyParameters</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">parameters?</span>: <span style="color:#204a87;font-weight:bold">unknown</span><span style="color:#000;font-weight:bold">[])</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">JSON</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stringify</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">parameters</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">DatabaseLogger</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>The last step is to use the above class in our TypeORM configuration:</p>
<p>database.module.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Module</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">TypeOrmModule</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/typeorm&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ConfigModule</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ConfigService</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/config&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">DatabaseLogger</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./databaseLogger&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Module</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">imports</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">TypeOrmModule</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">forRootAsync</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">imports</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">ConfigModule</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">inject</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">ConfigService</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">useFactory</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">configService</span>: <span style="color:#204a87;font-weight:bold">ConfigService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;postgres&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">logger</span>: <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">DatabaseLogger</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">host</span>: <span style="color:#204a87;font-weight:bold">configService.get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;POSTGRES_HOST&#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000;font-weight:bold">}),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}),</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">DatabaseModule</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span></code></pre></div><p>当我们开始查看来自 TypeORM 的日志时，我们注意到它经常产生相当长的查询。
例如，当我们检索试图登录的用户的数据时，会发生下面的查询:</p>
<h2 id="将日志保存到-postgresql-数据库中">将日志保存到 PostgreSQL 数据库中</h2>
<p>到目前为止，我们只将所有消息记录到控制台。
虽然在我们的机器上开发应用程序时，这可能工作得很好，但在已部署的应用程序中，这没有多大意义。
有很多服务可以帮助我们收集和管理日志，比如 DataDog 和 Loggly。
不过，它们不是免费的。
因此，在本文中，我们将日志保存到 PostgreSQL 数据库中。</p>
<p>首先，让我们为我们的日志创建一个实体:</p>
<p>log.entity.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Column</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">CreateDateColumn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Entity</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PrimaryGeneratedColumn</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;typeorm&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Entity</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Log</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@PrimaryGeneratedColumn</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Column</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">context</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Column</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">message</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Column</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">level</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@CreateDateColumn</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">creationDate</span>: <span style="color:#204a87;font-weight:bold">Date</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">Log</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>Above, we use the <code>@CreateDateColum</code> decorator.
If you want to know more about dates in PostgreSQL, check out Managing date and time with PostgreSQL and TypeORM</p>
<p>Once we’ve got the above done, let’s create a service that allows us to create logs:</p>
<p>logs.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectRepository</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/typeorm&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Repository</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;typeorm&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">Log</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./log.entity&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">CreateLogDto</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./dto/createLog.dto&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">LogsService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">@InjectRepository</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Log</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">logsRepository</span>: <span style="color:#204a87;font-weight:bold">Repository</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Log</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">createLog</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">log</span>: <span style="color:#204a87;font-weight:bold">CreateLogDto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">newLog</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">logsRepository</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">logsRepository</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">save</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">newLog</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">isCreatingLogs</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">newLog</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Above, you can notice that we pass isCreatingLogs: true when saving our logs to the database.
The above is because we need to overcome the issue of an infinite loop.
When we store logs in the database, it causes SQL queries to be logged.
When we log SQL queries, they are saved to the database, causing an infinite loop.
Because of that, we need to adjust our DatabaseLogger slightly:</p>
<p>databaseLogger.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Logger</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">TypeOrmLogger</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">QueryRunner</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;typeorm&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Logger</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">NestLogger</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">DatabaseLogger</span> <span style="color:#204a87;font-weight:bold">implements</span> <span style="color:#000">TypeOrmLogger</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">logger</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">NestLogger</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;SQL&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">logQuery</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">query</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">parameters?</span>: <span style="color:#204a87;font-weight:bold">unknown</span><span style="color:#000;font-weight:bold">[],</span> <span style="color:#000">queryRunner?</span>: <span style="color:#204a87;font-weight:bold">QueryRunner</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">queryRunner</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isCreatingLogs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`</span><span style="color:#4e9a06">${</span><span style="color:#000">query</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> -- Parameters: </span><span style="color:#4e9a06">${</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stringifyParameters</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">parameters</span><span style="color:#000;font-weight:bold">)</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">logQueryError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">query</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">parameters?</span>: <span style="color:#204a87;font-weight:bold">unknown</span><span style="color:#000;font-weight:bold">[],</span> <span style="color:#000">queryRunner?</span>: <span style="color:#204a87;font-weight:bold">QueryRunner</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">queryRunner</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isCreatingLogs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`</span><span style="color:#4e9a06">${</span><span style="color:#000">query</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> -- Parameters: </span><span style="color:#4e9a06">${</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stringifyParameters</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">parameters</span><span style="color:#000;font-weight:bold">)</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> -- </span><span style="color:#4e9a06">${</span><span style="color:#000">error</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">logQuerySlow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">query</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">parameters?</span>: <span style="color:#204a87;font-weight:bold">unknown</span><span style="color:#000;font-weight:bold">[],</span> <span style="color:#000">queryRunner?</span>: <span style="color:#204a87;font-weight:bold">QueryRunner</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">queryRunner</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isCreatingLogs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">warn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`Time: </span><span style="color:#4e9a06">${</span><span style="color:#000">time</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> -- Parameters: </span><span style="color:#4e9a06">${</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stringifyParameters</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">parameters</span><span style="color:#000;font-weight:bold">)</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> -- </span><span style="color:#4e9a06">${</span><span style="color:#000">query</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">logMigration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">logSchemaBuild</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">level</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;log&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;info&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;warn&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">message</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">queryRunner?</span>: <span style="color:#204a87;font-weight:bold">QueryRunner</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">queryRunner</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isCreatingLogs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">level</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;log&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">level</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;info&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">debug</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">level</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;warn&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">warn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">stringifyParameters</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">parameters?</span>: <span style="color:#204a87;font-weight:bold">unknown</span><span style="color:#000;font-weight:bold">[])</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">JSON</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stringify</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">parameters</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">DatabaseLogger</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>Above, we don’t log SQL queries if they are involved in creating logs.</p>
<p>Now we need to extend the logger built into NestJS and use the LogsService:</p>
<p>customLogger.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ConsoleLogger</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ConsoleLoggerOptions</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common/services/console-logger.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ConfigService</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/config&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">getLogLevels</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../utils/getLogLevels&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">LogsService</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./logs.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">CustomLogger</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">ConsoleLogger</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">logsService</span>: <span style="color:#204a87;font-weight:bold">LogsService</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">context</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span>: <span style="color:#204a87;font-weight:bold">ConsoleLoggerOptions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">configService</span>: <span style="color:#204a87;font-weight:bold">ConfigService</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">logsService</span>: <span style="color:#204a87;font-weight:bold">LogsService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">environment</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">configService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;NODE_ENV&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">super</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">...</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">logLevels</span>: <span style="color:#204a87;font-weight:bold">getLogLevels</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">environment</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;production&#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">logsService</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">logsService</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">context?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">super</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">apply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">logsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createLog</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">message</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">context</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;log&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stack?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">context?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">super</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">apply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stack</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">logsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createLog</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">message</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">context</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;error&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">warn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">context?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">super</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">warn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">apply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">logsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createLog</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">message</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">context</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;error&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">debug</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">context?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">super</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">debug</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">apply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">logsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createLog</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">message</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">context</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;error&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">verbose</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">context?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">super</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">debug</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">apply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">logsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createLog</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">message</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">context</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;error&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">CustomLogger</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>We also need to create the LoggerModule so that we can add it into our AppModule:</p>
<p>logger.module.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Module</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">CustomLogger</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./customLogger&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ConfigModule</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/config&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">LogsService</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./logs.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">TypeOrmModule</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/typeorm&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">Log</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./log.entity&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Module</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">imports</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">ConfigModule</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">TypeOrmModule</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">forFeature</span><span style="color:#000;font-weight:bold">([</span><span style="color:#000">Log</span><span style="color:#000;font-weight:bold">])],</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">providers</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">CustomLogger</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">LogsService</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">exports</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">CustomLogger</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">LoggerModule</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span></code></pre></div><p>最后一步是调用 useLogger 方法，将我们的自定义记录器注入到应用程序中:</p>
<p>main.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">NestFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/core&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AppModule</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./app.module&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">CustomLogger</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./logger/customLogger&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">bootstrap() {</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">app</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">NestFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">AppModule</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bufferLogs</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">useLogger</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">CustomLogger</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">bootstrap</span><span style="color:#000;font-weight:bold">();</span>
</span></span></code></pre></div><p>我们可以将一些数据存储在单独的列中。
例如，我们可以使用 HTTP 方法来查询日志，只查找 POST 请求。</p>
<h2 id="总结">总结</h2>
<p>在本文中，我们已经了解了使用 NestJS 和 TypeORM 进行日志记录的基础知识。
我们已经了解了各种日志级别，以及如何直接和通过中间件记录消息。
我们还学习了如何将日志保存到 SQL 数据库中。
这样做有一些好处。
例如，我们可以在单独的列中存储更多的数据，并在查询数据时使用它们。</p>
<p>即使将日志保存到 SQL 数据库中有一些优势，但如果日志很多，性能可能不是最好的。
此外，它可能会填满我们数据库的可用空间。
因此，研究诸如 DataDog 和 Loggly 这样的服务可能是个好主意。
不过，这是另一篇文章的主题，请继续关注!</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d7ec5a6830ec344ca6306585c35ffdcf">6 - 队列</h1>
    
	<blockquote>
<p><a href="https://github.com/axios/axios">https://github.com/axios/axios</a></p>
</blockquote>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-0434ba7f30f49cc3172e991b753c1e82">6.1 - bull</h1>
    <div class="lead">最快、最可靠、基于redis的Node队列。 仔细写的岩石固体的稳定性和原子性。</div>
	<blockquote>
<p><a href="https://github.com/OptimalBits/bull">https://github.com/OptimalBits/bull</a></p>
</blockquote>
<p>请在<a href="http://twitter.com/manast">📻Twitter</a>上关注我，了解重要的新闻和更新。
你可以在这个博客中找到教程和新闻: <a href="https://blog.taskforce.sh/">🛠 教程</a></p>
<h3 id="bull-特性">Bull 特性</h3>
<ul>
<li><input checked="" disabled="" type="checkbox"> 最小的 CPU 使用率，由于无轮询设计。</li>
<li><input checked="" disabled="" type="checkbox"> 基于 Redis 的稳健设计。</li>
<li><input checked="" disabled="" type="checkbox"> 延迟的工作。</li>
<li><input checked="" disabled="" type="checkbox"> 根据 cron 规范安排和重复作业。</li>
<li><input checked="" disabled="" type="checkbox"> 对工作的率限制。</li>
<li><input checked="" disabled="" type="checkbox"> 重试。</li>
<li><input checked="" disabled="" type="checkbox"> 优先级。</li>
<li><input checked="" disabled="" type="checkbox"> 并发性。</li>
<li><input checked="" disabled="" type="checkbox"> 暂停/恢复-全局或本地。</li>
<li><input checked="" disabled="" type="checkbox"> 每个队列有多个作业类型。</li>
<li><input checked="" disabled="" type="checkbox"> 线程(沙盒)处理函数。</li>
<li><input checked="" disabled="" type="checkbox"> 从进程崩溃中自动恢复。</li>
</ul>
<p>接下来是路线图…</p>
<ul>
<li><input disabled="" type="checkbox"> 作业完成确认(同时可以使用消息队列<a href="https://github.com/OptimalBits/bull/blob/develop/PATTERNS.md#returning-job-completions">pattern</a>)。</li>
<li><input disabled="" type="checkbox"> 父子的工作关系。</li>
</ul>
<hr>
<h3 id="uis">UIs</h3>
<p>你可以使用一些第三方 ui 来进行监控:</p>
<p><strong>BullMQ</strong></p>
<ul>
<li><a href="https://taskforce.sh">Taskforce</a></li>
</ul>
<p><strong>Bull v3</strong></p>
<ul>
<li><a href="https://taskforce.sh">Taskforce</a></li>
<li><a href="https://github.com/vcapretz/bull-board">bull-board</a></li>
<li><a href="https://github.com/darky/bull-repl">bull-repl</a></li>
<li><a href="https://github.com/s-r-x/bull-monitor">bull-monitor</a></li>
<li><a href="https://github.com/AbhilashJN/monitoro">Monitoro</a></li>
</ul>
<p><strong>Bull &lt;= v2</strong></p>
<ul>
<li><a href="https://github.com/ShaneK/Matador">Matador</a></li>
<li><a href="https://github.com/kfatehi/react-bull">react-bull</a></li>
<li><a href="https://github.com/Epharmix/Toureiro">Toureiro</a></li>
</ul>
<hr>
<h3 id="监测和报警">监测和报警</h3>
<ul>
<li>使用 Prometheus <a href="https://github.com/UpHabit/bull_exporter">Bull Queue Exporter</a></li>
</ul>
<hr>
<h3 id="特征比较">特征比较</h3>
<p>由于有一些作业队列解决方案，这里有一个表比较它们:</p>
<table>
<thead>
<tr>
<th style="text-align:left">Feature</th>
<th style="text-align:center">Bullmq-Pro</th>
<th style="text-align:center">Bullmq</th>
<th style="text-align:center">Bull</th>
<th style="text-align:center">Kue</th>
<th>Bee</th>
<th>Agenda</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">后端</td>
<td style="text-align:center">redis</td>
<td style="text-align:center">redis</td>
<td style="text-align:center">redis</td>
<td style="text-align:center">redis</td>
<td>redis</td>
<td>mongo</td>
</tr>
<tr>
<td style="text-align:left">观察</td>
<td style="text-align:center">✓</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">组速率限制</td>
<td style="text-align:center">✓</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">集群支持</td>
<td style="text-align:center">✓</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">父/子依赖关系</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">优先级</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td></td>
<td>✓</td>
</tr>
<tr>
<td style="text-align:left">并发性</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td>✓</td>
<td>✓</td>
</tr>
<tr>
<td style="text-align:left">演示工作</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td></td>
<td>✓</td>
</tr>
<tr>
<td style="text-align:left">全局事件</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">速度限制器</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center"></td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">暂停/恢复</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">沙箱工人</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center"></td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">可重复的工作</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center"></td>
<td></td>
<td>✓</td>
</tr>
<tr>
<td style="text-align:left">原子操作</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center"></td>
<td>✓</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">持久性</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td>✓</td>
<td>✓</td>
</tr>
<tr>
<td style="text-align:left">用户界面</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td></td>
<td>✓</td>
</tr>
<tr>
<td style="text-align:left">优化了</td>
<td style="text-align:center">Jobs / Messages</td>
<td style="text-align:center">Jobs / Messages</td>
<td style="text-align:center">Jobs / Messages</td>
<td style="text-align:center">Jobs</td>
<td>Messages</td>
<td>Jobs</td>
</tr>
</tbody>
</table>
<h3 id="安装">安装</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>npm install bull --save
</span></span></code></pre></div><p>或者</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yarn add bull
</span></span></code></pre></div><p><em><strong>要求:</strong> Bull 需要大于或等于&rsquo; 2.8.18 &lsquo;的 Redis 版本。</em></p>
<h3 id="typescript-定义">Typescript 定义</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>npm install @types/bull --save-dev
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yarn add --dev @types/bull
</span></span></code></pre></div><p>定义目前维护在<a href="https://github.com/DefinitelyTyped/DefinitelyTyped/tree/master/types/bull">DefinitelyTyped</a> repo 中。</p>
<h3 id="快速指南">快速指南</h3>
<h4 id="基本用法">基本用法</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Queue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;bull&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">videoQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;video transcoding&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;redis://127.0.0.1:6379&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">audioQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;audio transcoding&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">redis</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">6379</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;foobared&#34;</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// Specify Redis connection using object
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">imageQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;image transcoding&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">pdfQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;pdf transcoding&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">videoQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">done</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// job.data contains the custom data passed when the job was created
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// job.id contains id of this job.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// transcode video asynchronously and report progress
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">progress</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">42</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// call done when finished
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">done</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// or give a error if error
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">done</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error transcoding&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// or pass it a result
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">done</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">framerate</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">29.5</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* etc...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// If the job throws an unhandled exception it is also handled correctly
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;some unexpected error&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">audioQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">done</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// transcode audio asynchronously and report progress
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">progress</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">42</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// call done when finished
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">done</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// or give a error if error
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">done</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error transcoding&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// or pass it a result
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">done</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">samplerate</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">48000</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* etc...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// If the job throws an unhandled exception it is also handled correctly
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;some unexpected error&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">imageQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">done</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// transcode image asynchronously and report progress
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">progress</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">42</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// call done when finished
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">done</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// or give a error if error
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">done</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error transcoding&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// or pass it a result
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">done</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1280</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">height</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">720</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* etc...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// If the job throws an unhandled exception it is also handled correctly
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;some unexpected error&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">pdfQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// Processors can also return promises instead of using the done callback
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">pdfAsyncProcessor</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">videoQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">video</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http://example.com/video1.mov&#34;</span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#000">audioQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">audio</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http://example.com/audio1.mp3&#34;</span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#000">imageQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">image</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http://example.com/image1.tiff&#34;</span> <span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><h4 id="使用承诺">使用承诺</h4>
<p>或者，你可以使用 return promises 来代替<code>done</code>回调:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#000">videoQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 不要忘记删除done回调!
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// 简单地回报一个承诺
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fetchVideo</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">url</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">transcodeVideo</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 处理承诺拒绝
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reject</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error transcoding&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 将承诺解析的值传递给“completed”事件
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resolve</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">framerate</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">29.5</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* etc...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 如果作业抛出一个未处理的异常，它也会得到正确的处理
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;some unexpected error&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 一样
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reject</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;some unexpected error&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><h4 id="独立的进程">独立的进程</h4>
<p>进程函数也可以在单独的进程中运行。这有几个好处:</p>
<ul>
<li>这个进程是沙箱化的，所以即使它崩溃了，也不会影响工作进程。</li>
<li>您可以在不影响队列的情况下运行阻塞代码(作业不会停止)。</li>
<li>更好地利用多核 cpu。</li>
<li>减少与 redis 的连接。</li>
</ul>
<p>为了使用这个特性，只需创建一个单独的处理器文件:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// processor.js
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">module</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">exports</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 做一些繁重的工作
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resolve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>然后像这样定义处理器:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 单流程:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/path/to/my/processor.js&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 你也可以使用并发:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;/path/to/my/processor.js&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 和指定的处理器:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;my processor&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;/path/to/my/processor.js&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><h4 id="重复的工作">重复的工作</h4>
<p>作业可以被添加到队列中，并根据 cron 规范重复处理:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000">paymentsQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// Check payments
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Repeat payment job once every day at 3:15 (am)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">paymentsQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">paymentsData</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">repeat</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">cron</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;15 3 * * *&#34;</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>作为提示，请检查这里的表达式，以验证它们是正确的:<a href="https://crontab.cronhub.io">cron 表达式生成器</a></p>
<h4 id="暂停恢复">暂停/恢复</h4>
<p>一个队列可以被全局暂停和恢复(传递 <code>true</code> 来暂停这个 worker 的处理):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pause</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// queue is paused now
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resume</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// queue is resumed now
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><h4 id="事件">事件</h4>
<p>队列会发出一些有用的事件，例如…</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;completed&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// Job completed with output result!
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">})</span>
</span></span></code></pre></div><p>有关事件的更多信息，包括所触发事件的完整列表，请参阅<a href="./REFERENCE.md#events">事件参考资料</a></p>
<h4 id="队列性能">队列性能</h4>
<p>队列很便宜，所以如果你需要很多队列，只需创建新的不同名称的队列:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">userJohn</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;john&#39;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">userLisa</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;lisa&#39;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span>
</span></span></code></pre></div><p>然而，每个队列实例将需要新的 redis 连接，检查如何<a href="https://github.com/OptimalBits/bull/blob/master/PATTERNS.md#reusing-redis-connections">重用连接</a>，或者你也可以使用<a href="https://github.com/OptimalBits/bull/blob/master/REFERENCE.md#queueprocess">命名处理器</a>来实现类似的结果。</p>
<h4 id="集群的支持">集群的支持</h4>
<blockquote>
<p>NOTE: 从 3.2.0 及以上版本开始，建议使用线程处理器。</p>
</blockquote>
<p>队列是健壮的，可以在几个线程或进程中并行运行，没有任何危险或队列损坏的风险。
检查这个简单的例子，使用 cluster 跨进程并行化任务:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Queue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;bull&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">cluster</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;cluster&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">numWorkers</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">queue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;test concurrent queue&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cluster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isMaster</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">numWorkers</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cluster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">fork</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">cluster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;online&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">worker</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Let&#39;s create a few jobs for the queue workers
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">500</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;bar&#34;</span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">cluster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;exit&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">worker</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">code</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">signal</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;worker &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">worker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34; died&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">jobDone</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Job done by worker&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cluster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">worker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">jobDone</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><hr>
<h3 id="文档">文档</h3>
<p>要获取完整的文档，请查看参考和常用模式:</p>
<ul>
<li><a href="https://optimalbits.github.io/bull/">指南</a> - 你使用 Bull 开发的起点。</li>
<li><a href="./REFERENCE.md">参考</a> - 包含所有可用对象和方法的引用文档。</li>
<li><a href="./PATTERNS.md">模式</a> - 一组常见模式的示例。</li>
<li><a href="./LICENSE.md">许可证</a> - Bull 许可证-麻省理工学院。</li>
</ul>
<p>如果你看到任何可以使用更多文档的东西，请提交一个 pull request!</p>
<hr>
<h3 id="重要的笔记">重要的笔记</h3>
<p>队列的目标是“至少一次”的工作策略。
这意味着在某些情况下，一个作业可能会被多次处理。
这种情况通常发生在一个 worker 在整个处理过程中没有为给定的作业保持锁的时候。</p>
<p>当一个工人正在处理一项工作时，它将使该工作保持“锁定”，以便其他工人不能处理它。</p>
<p>理解锁定是如何工作的，以防止您的作业失去锁- becoming <em>stalled</em> - 并因此重新启动，这一点很重要。
锁是通过在 <code>lockRenewTime</code> (通常是 <code>lockDuration</code> 的一半)上为 <code>lockDuration</code> 创建一个锁来实现的。
如果 <code>lockDuration</code> 在锁被更新之前过期，则该作业将被视为暂停并自动重启;它将被<strong>二次加工</strong>。</p>
<p>这种情况可能发生在:</p>
<ol>
<li>运行作业处理器的 Node 进程意外终止。</li>
<li>您的作业处理器 cpu 过于密集，导致 Node 事件循环停顿，结果，Bull 无法更新作业锁(请参阅<a href="https://github.com/OptimalBits/bull/issues/488">#488</a>了解如何更好地检测此问题)。
您可以通过将作业处理器分解为更小的部分来解决这个问题，这样单个部分就不会阻塞 Node 事件循环。
或者，您可以为 <code>lockDuration</code> 设置传递一个更大的值(代价是它将花费更长的时间来识别真正的暂停作业)。</li>
</ol>
<p>因此，您应该始终侦听 <code>stopped</code> 事件并将其记录到错误监视系统中，因为这意味着您的作业可能会被重复处理。</p>
<p>作为一种安全措施，有问题的作业不会被无限期重启(例如，如果作业处理器总是崩溃它的 Node 进程)，作业将从停止状态恢复，最大次数为 <code>maxStalledCount</code> (默认为 <code>1</code>)。</p>
<h3 id="谁在使用">谁在使用</h3>
<p>Bull 在大大小小的组织中都很受欢迎，比如以下这些组织:</p>
<table cellspacing="0" cellpadding="0">
  <tr>
    <td valign="center">
      <a href="https://github.com/atlassian/github-for-jira">
        <img
          src="https://876297641-files.gitbook.io/~/files/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-LUuDmt_xXMfG66Rn1GA%2Fuploads%2FevsJCF6F1tx1ScZwDQOd%2FAtlassian-horizontal-blue-rgb.webp?alt=media&token=2fcd0528-e8bb-4bdd-af35-9d20e313d1a8"
          width="150"
          alt="Atlassian"
      /></a>
    </td>
    <td valign="center">
      <a href="https://github.com/Autodesk">
        <img
          src="https://876297641-files.gitbook.io/~/files/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-LUuDmt_xXMfG66Rn1GA%2Fuploads%2FvpTe02RdOhUJBA8TdHEE%2Fautodesk-logo-white.png?alt=media&token=326961b4-ea4f-4ded-89a4-e05692eec8ee"
          width="150"
          alt="Autodesk"
      /></a>
    </td>
    <td valign="center">
      <a href="https://github.com/common-voice/common-voice">
        <img
          src="https://876297641-files.gitbook.io/~/files/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-LUuDmt_xXMfG66Rn1GA%2Fuploads%2F4zPSrubNJKViAzUIftIy%2Fmozilla-logo-bw-rgb.png?alt=media&token=9f93aae2-833f-4cc4-8df9-b7fea0ad5cb5"
          width="150"
          alt="Mozilla"
      /></a>
    </td>
    <td valign="center">
      <a href="https://github.com/nestjs/bull">
        <img
          src="https://876297641-files.gitbook.io/~/files/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-LUuDmt_xXMfG66Rn1GA%2Fuploads%2FfAcGye182utFUtPKdLqJ%2FScreenshot%202022-02-15%20at%2011.32.39.png?alt=media&token=29feb550-f0bc-467d-a290-f700701d7d15"
          width="150"
          alt="Nest"
      /></a>
    </td>
    <td valign="center">
      <a href="https://github.com/salesforce/refocus">
        <img
          src="https://876297641-files.gitbook.io/~/files/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-LUuDmt_xXMfG66Rn1GA%2Fuploads%2FZNnYNuL5qJ6ZoBh7JJEW%2Fsalesforce-logo.png?alt=media&token=ddcae63b-08c0-4dd4-8496-3b29a9bf977d"
          width="100"
          alt="Salesforce"
      /></a>
    </td>
  </tr>
</table>
<hr>
<h3 id="bullmq">BullMQ</h3>
<p>如果你想开始使用完全用 Typescript 编写的下一个主要版本的 Bull，欢迎使用新的 repo<a href="https://github.com/taskforcesh/bullmq">这里</a>.
否则，我们非常欢迎你仍然使用 Bull，这是一个安全的、经过战斗测试的代码库。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f5431b111661b3529e1ee10738caa3ad">6.2 - 指南</h1>
    
	<p><img src="https://raw.githubusercontent.com/OptimalBits/bull/master/support/logo%402x.png" alt=""></p>
<ul>
<li><a href="#bull-%E6%98%AF%E4%BB%80%E4%B9%88">Bull 是什么?</a></li>
<li><a href="#%E5%BC%80%E5%A7%8B">开始</a></li>
<li><a href="#%E7%AE%80%E5%8D%95%E7%9A%84%E9%98%9F%E5%88%97">简单的队列</a>
<ul>
<li><a href="#%E7%94%9F%E4%BA%A7%E8%80%85">生产者</a></li>
<li><a href="#%E6%B6%88%E8%B4%B9%E8%80%85">消费者</a></li>
<li><a href="#%E4%BE%A6%E5%90%AC%E5%99%A8">侦听器</a></li>
<li><a href="#%E4%B8%80%E4%BB%BD%E5%B7%A5%E4%BD%9C%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F">一份工作的生命周期</a></li>
<li><a href="#%E5%81%9C%E6%BB%9E%E4%B8%8D%E5%89%8D%E7%9A%84%E5%B7%A5%E4%BD%9C">停滞不前的工作</a></li>
</ul>
</li>
<li><a href="#%E4%BA%8B%E4%BB%B6">事件</a></li>
<li><a href="#%E9%98%9F%E5%88%97%E7%9A%84%E9%80%89%E9%A1%B9">队列的选项</a>
<ul>
<li><a href="#%E9%80%9F%E5%BA%A6%E9%99%90%E5%88%B6%E5%99%A8">速度限制器</a></li>
<li><a href="#%E5%91%BD%E5%90%8D%E5%B7%A5%E4%BD%9C">命名工作</a></li>
<li><a href="#%E6%B2%99%E7%AE%B1%E5%A4%84%E7%90%86%E5%99%A8">沙箱处理器</a></li>
</ul>
</li>
<li><a href="#%E4%BD%9C%E4%B8%9A%E7%B1%BB%E5%9E%8B">作业类型</a>
<ul>
<li><a href="#lifo">LIFO</a></li>
<li><a href="#%E5%BB%B6%E8%BF%9F">延迟</a></li>
<li><a href="#%E4%BC%98%E5%85%88">优先</a></li>
<li><a href="#%E5%8F%AF%E9%87%8D%E5%A4%8D%E7%9A%84">可重复的</a></li>
</ul>
</li>
</ul>
<h2 id="bull-是什么">Bull 是什么?</h2>
<p>Bull 是一个 Node 库，它实现了一个快速、健壮的基于<a href="https://redis.io">redis</a>的队列系统。</p>
<p>虽然可以直接使用 Redis 命令来实现队列，但这个库提供了一个 API 来处理所有底层细节，并丰富了 Redis 的基本功能，这样更复杂的用例就可以轻松处理。</p>
<p>如果你不熟悉排队，你可能会想为什么需要排队。
队列可以以一种优雅的方式解决许多不同的问题，从平滑处理高峰到在微服务之间创建健壮的通信通道，或将繁重的工作从一台服务器转移到许多较小的 worker，等等。</p>
<h2 id="开始">开始</h2>
<p>Bull 是一个公共的 npm 包，可以使用 npm 或 yarn 来安装:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ npm install bull --save
</span></span></code></pre></div><p>or</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ yarn add bull
</span></span></code></pre></div><p>为了使用 Bull，你还需要有一个运行的 Redis 服务器。
对于本地开发，您可以使用<a href="https://hub.docker.com/_/redis/">docker</a>轻松安装它。</p>
<p>Bull 将默认尝试连接到运行在&rsquo; localhost:6379 &lsquo;上的 Redis 服务器</p>
<h2 id="简单的队列">简单的队列</h2>
<p>一个队列可以通过实例化一个 Bull 实例来创建:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">myFirstQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Bull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;my-first-queue&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>一个队列实例通常有 3 个不同的主要角色:作业生产者、作业使用者或/和事件侦听器。</p>
<p>虽然一个给定的实例可以用于这 3 个角色，但通常生产者和消费者被划分为几个实例。
一个给定的队列，总是通过它的实例化名称(在上面的示例中是&rsquo; my-first-queue &lsquo;)引用，可以有许多生产者、许多消费者和许多侦听器。
一个重要的方面是，生产者可以将作业添加到队列中，即使此时没有可用的消费者:队列提供异步通信，这是使它们如此强大的特性之一。</p>
<p>相反，您可以让一个或多个 worker 从队列中消耗作业，它将按照给定的顺序消耗作业:FIFO(默认)、LIFO 或根据优先级。</p>
<p>说到 worker，它们可以运行在相同或不同的进程中，在同一台机器或集群中。
Redis 将充当一个公共点，只要消费者或生产商能够连接到 Redis，他们就能够协同处理工作。</p>
<h3 id="生产者">生产者</h3>
<p>作业生成器是一个简单的 Node 程序，它将作业添加到队列中，像这样:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">myFirstQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Bull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;my-first-queue&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">job</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">myFirstQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>正如您所看到的，作业只是一个 javascript 对象。
这个对象需要是可序列化的，更具体的是，它应该可以 JSON 字符串化，因为这是它将如何存储在 Redis。</p>
<p>也可以在作业数据之后提供一个 options 对象，但我们将在后面讨论这个问题。</p>
<h3 id="消费者">消费者</h3>
<p>消费者或工作者(我们将在本指南中交替使用这两个术语)只不过是一个 Node 程序
它定义了像这样的进程函数:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">myFirstQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Bull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;my-first-queue&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">myFirstQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">doSomething</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>每当工作线程处于空闲状态且队列中有作业需要处理时，&rsquo; process &lsquo;函数就会被调用。
由于在添加作业时，消费者不需要在线，因此队列中可能已经有许多作业在等待，因此进程将保持忙碌，一个接一个地处理作业，直到所有作业都完成。</p>
<p>在上面的例子中，我们将进程函数定义为&rsquo; async &lsquo;，这是强烈推荐的定义它们的方式。
如果你的 Node 运行时不支持 async/await，那么你可以在进程结束时返回一个 promise
函数，以得到类似的结果。</p>
<p>进程函数返回的值将存储在 jobs 对象中，稍后可以访问，例如在“completed”事件的监听器中。</p>
<p>有时你需要向外部监听器提供 job 的<em>progress</em>信息，这可以通过在 job 对象上使用&rsquo; progress &lsquo;方法轻松完成:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000">myFirstQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">progress</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">doSomething</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">progress</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">progress</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">progress</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><h3 id="侦听器">侦听器</h3>
<p>最后，您可以只侦听队列中发生的事件。
侦听器可以是本地的，这意味着它们只接收在<em>给定队列实例</em>中产生的通知，也可以是全局的，这意味着它们侦听给定队列的<em>所有</em>事件。
因此，您可以将侦听器附加到任何实例，甚至充当消费者或生产者的实例。
但是请注意，如果队列不是消费者或生产者，本地事件将永远不会触发，在这种情况下，您将需要使用全局事件。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">myFirstQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Bull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;my-first-queue&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Define a local completed event
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">myFirstQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;completed&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`Job completed with result </span><span style="color:#4e9a06">${</span><span style="color:#000">result</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><h3 id="一份工作的生命周期">一份工作的生命周期</h3>
<p>为了充分利用 Bull 队列的潜力，理解作业的生命周期是很重要的。
从生产者对队列实例调用“add”方法的那一刻起，作业就进入了它需要的生命周期
处于不同的状态，直到它完成或失败(尽管技术上失败的作业可以重试并获得新的生命周期)。</p>
<p>显示作业状态的示意图(job-lifecycle.png)</p>
<p>当一个作业被添加到一个队列时，它可以处于两种状态之一，它可以处于“等待”状态，这实际上是一个等待列表，所有的作业都必须进入这个列表才能被处理，或者它可以处于“延迟”状态:延迟状态意味着该作业正在等待超时或等待被提升处理，但是，延迟的作业不会直接被处理，而是被放置在等待列表的开头，当一个 worker 空闲时就会被处理。</p>
<p>作业的下一个状态是“活动”状态。
活动状态由一个集合表示，是当前正在处理的作业，即。
它们运行在上一章解释过的“process”函数中。
作业可以无限长时间处于活动状态，直到流程完成，或者抛出异常，以便作业以“完成”或“失败”状态结束。</p>
<h3 id="停滞不前的工作">停滞不前的工作</h3>
<p>在 Bull 中，我们定义了停滞的工作的概念。
停滞的作业是正在处理的作业，但 Bull 怀疑该作业的流程功能已经挂起。
这种情况发生在进程函数正在处理一个任务，并且使 CPU 一直处于繁忙状态，以至于 worker 无法告诉队列它仍然在处理这个任务。</p>
<p>当一个作业停止时，根据作业设置，该作业可以由另一个空闲的作业重试，也可以转移到失败状态。</p>
<p>可以通过确保进程函数不会让 Node 事件循环太长时间处于繁忙状态(Bull 的默认选项是几秒钟)，或者使用单独的[sandbox -processors](#sandbox -processors)来避免陷入停顿的作业。</p>
<h2 id="事件">事件</h2>
<p>Bull 中的队列生成一些事件，这些事件在许多用例中都很有用。
对于给定的队列实例(一个 worker)，事件可以是本地的，例如，如果一个任务在一个给定的 worker 中完成了，则只会针对该实例发出本地事件。
但是，可以通过在本地事件名称前加上&rsquo; global: &lsquo;来侦听所有事件。
然后，我们可以侦听给定队列中所有工人产生的所有事件。</p>
<p>本地完整事件:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;completed&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`Job with id </span><span style="color:#4e9a06">${</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> has been completed`</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>而事件的全球版本可以通过以下方式来收听:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;global:completed&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">jobId</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`Job with id </span><span style="color:#4e9a06">${</span><span style="color:#000">jobId</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> has been completed`</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>请注意，全局事件的签名与本地事件的签名略有不同，在上面的示例中，它只发送作业 id，而不是作业本身的完整实例，这样做是出于性能原因。</p>
<p>可用事件的列表可以在<a href="https://github.com/OptimalBits/bull/blob/master/REFERENCE.md#eventsk">reference</a>中找到。</p>
<h2 id="队列的选项">队列的选项</h2>
<p>一个队列可以实例化一些有用的选项，例如，你可以指定你的 Redis 服务器的位置和密码，以及其他一些有用的设置。
所有这些设置在 Bull 的<a href="https://github.com/OptimalBits/bull/blob/master/REFERENCE.md#queue">参考文献</a>中都有描述，我们在这里不重复它们，但是，我们将讨论一些用例。</p>
<h3 id="速度限制器">速度限制器</h3>
<p>可以创建限制单位时间内处理的作业数量的队列。
限制器是在每个队列中定义的，与 worker 的数量无关，所以你可以水平扩展，并且仍然可以轻松地限制处理速率:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Limit queue to max 1000 jobs per 5000 milliseconds.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">myRateLimitedQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;rateLimited&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">limiter</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">max</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">duration</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">5000</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>当队列达到速率限制时，请求的作业将加入“延迟”队列。</p>
<h3 id="命名工作">命名工作</h3>
<p>给工作起名字是可能的。
这不会改变队列的任何机制，但可以在 UI 工具中用于更清晰的代码和更好的可视化:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Jobs producer
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">myJob</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">transcoderQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;image&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">input</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;myimagefile&#34;</span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">myJob</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">transcoderQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;audio&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">input</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;myaudiofile&#34;</span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">myJob</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">transcoderQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;video&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">input</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;myvideofile&#34;</span> <span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Worker
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">transcoderQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;image&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">processImage</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">transcoderQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;audio&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">processAudio</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">transcoderQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;video&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">processVideo</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>请记住，每个队列实例都需要为每个<em>指定</em>作业提供一个处理器，否则将会出现异常。</p>
<h3 id="沙箱处理器">沙箱处理器</h3>
<p>如上所述，在定义流程功能时，还可以提供并发设置。
此设置允许工作者并行处理多个作业。
这些作业仍然在同一个 Node 进程中处理，如果作业的 IO 密集，它们将得到很好的处理。</p>
<p>有时，作业的 CPU 占用更大，这可能会锁定 Node 事件循环太长时间，Bull 可能会认为作业已经暂停。
为了避免这种情况，可以在单独的 Node 进程中运行进程函数。
在这种情况下，并发性参数将决定允许运行的最大并发进程数。</p>
<p>我们称这种进程为“沙箱”进程，它们也有这样的属性:如果崩溃，它们不会影响任何其他进程，并且会自动生成一个新进程来替换它。</p>
<h2 id="作业类型">作业类型</h2>
<p>Bull 中的默认作业类型是“FIFO”(先进先出)，这意味着作业的处理顺序与进入队列的顺序相同。
有时，以不同的顺序处理作业是有用的。</p>
<h3 id="lifo">LIFO</h3>
<p>后进先出(LIFO)意味着作业被添加到队列的开头，因此当 worker 空闲时就会被处理。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">myJob</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">myqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;bar&#34;</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">lifo</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><h3 id="延迟">延迟</h3>
<p>还可以将作业添加到队列中，这些作业在被处理之前会延迟一定的时间。
注意，delay 参数表示作业在被处理之前等待的最小时间。
当延迟时间过去后，作业将被移动到队列的开头，并在一个 worker 空闲时立即处理。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Delayed 5 seconds
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">myJob</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">myqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;bar&#34;</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">delay</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">5000</span> <span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><h3 id="优先">优先</h3>
<p>可以将作业添加到具有优先级值的队列中。
优先级高的作业将比优先级低的作业优先处理。
最高优先级为 1，并降低所使用的较大整数。
请记住，优先级队列比标准队列稍慢(当前插入时间为 O(n)， n 是当前在队列中等待的作业数量，而标准队列为 O(1))。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">myJob</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">myqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;bar&#34;</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">priority</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><h3 id="可重复的">可重复的</h3>
<p>可重复作业是一种特殊作业，可以根据 cron 规范或时间间隔无限期地重复自己，或者直到达到一个给定的最大日期或重复次数为止。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Repeat every 10 seconds for 100 times.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">myJob</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">myqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;bar&#34;</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">repeat</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">every</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">limit</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Repeat payment job once every day at 3:15 (am)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">paymentsQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">paymentsData</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">repeat</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">cron</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;15 3 * * *&#34;</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>关于可重复工作有一些重要的考虑:</p>
<ul>
<li>如果重复选项相同，Bull 足够聪明，不会添加相同的可重复作业。
(注意:作业 id 是重复选项的一部分，因为:https://github.com/OptimalBits/bull/pull/603，因此传递作业id将允许在队列中插入具有相同cron的作业)</li>
<li>如果没有工人在运行，那么下一次工人在线时，可重复的工作将不会累积。</li>
<li>可以使用<a href="https://github.com/OptimalBits/bull/blob/master/REFERENCE.md#queueremoverepeatable">removeRepeatable</a>方法删除可重复的作业。</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b2b86a8b70578d701ade6f6cd94fede2">6.3 - 参考</h1>
    
	<ul>
<li><a href="#%E9%98%9F%E5%88%97">队列</a>
<ul>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%88%96%E5%85%B1%E4%BA%AB-ioredis-%E8%BF%9E%E6%8E%A5">自定义或共享 IORedis 连接</a></li>
<li><a href="#%E9%AB%98%E7%BA%A7%E8%AE%BE%E7%BD%AE">高级设置</a></li>
<li><a href="#queueprocess">Queue#process</a></li>
<li><a href="#queueadd">Queue#add</a>
<ul>
<li><a href="#keepjobs-%E9%80%89%E9%A1%B9">KeepJobs 选项</a></li>
<li><a href="#%E8%B6%85%E6%97%B6%E7%9A%84%E5%AE%9E%E7%8E%B0">超时的实现</a></li>
<li><a href="#%E9%87%8D%E5%A4%8D%E7%9A%84%E5%B7%A5%E4%BD%9C%E7%BB%86%E8%8A%82">重复的工作细节</a></li>
<li><a href="#%E8%A1%A5%E5%81%BF%E9%80%89%E9%A1%B9">补偿选项</a></li>
</ul>
</li>
<li><a href="#queueaddbulk">Queue#addBulk</a></li>
<li><a href="#queuepause">Queue#pause</a></li>
<li><a href="#queueispaused">Queue#isPaused</a></li>
<li><a href="#queueresume">Queue#resume</a></li>
<li><a href="#queuewhencurrentjobsfinished">Queue#whenCurrentJobsFinished</a></li>
<li><a href="#queuecount">Queue#count</a></li>
<li><a href="#queueremovejobs">Queue#removeJobs</a></li>
<li><a href="#queueempty">Queue#empty</a></li>
<li><a href="#queueclose">Queue#close</a></li>
<li><a href="#queuegetjob">Queue#getJob</a></li>
<li><a href="#queuegetjobs">Queue#getJobs</a></li>
<li><a href="#queuegetjoblogs">Queue#getJobLogs</a></li>
<li><a href="#queuegetrepeatablejobs">Queue#getRepeatableJobs</a></li>
<li><a href="#queueremoverepeatable">Queue#removeRepeatable</a></li>
<li><a href="#queueremoverepeatablebykey">Queue#removeRepeatableByKey</a></li>
<li><a href="#queuegetjobcounts">Queue#getJobCounts</a></li>
<li><a href="#queuegetcompletedcount">Queue#getCompletedCount</a></li>
<li><a href="#queuegetfailedcount">Queue#getFailedCount</a></li>
<li><a href="#queuegetdelayedcount">Queue#getDelayedCount</a></li>
<li><a href="#queuegetactivecount">Queue#getActiveCount</a></li>
<li><a href="#queuegetwaitingcount">Queue#getWaitingCount</a></li>
<li><a href="#queuegetpausedcount">Queue#getPausedCount</a></li>
<li><a href="#getters">Getters</a></li>
<li><a href="#queuegetwaiting">Queue#getWaiting</a></li>
<li><a href="#queuegetactive">Queue#getActive</a></li>
<li><a href="#queuegetdelayed">Queue#getDelayed</a></li>
<li><a href="#queuegetcompleted">Queue#getCompleted</a></li>
<li><a href="#queuegetfailed">Queue#getFailed</a></li>
<li><a href="#queuegetworkers">Queue#getWorkers</a></li>
<li><a href="#queuegetmetrics">Queue#getMetrics</a></li>
<li><a href="#queueclean">Queue#clean</a>
<ul>
<li><a href="#example">Example</a></li>
</ul>
</li>
<li><a href="#queueobliterate">Queue#obliterate</a>
<ul>
<li><a href="#%E7%A4%BA%E4%BE%8B">示例</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E5%B7%A5%E4%BD%9C">工作</a>
<ul>
<li><a href="#jobprogress">Job#progress</a>
<ul>
<li><a href="#arguments">Arguments</a></li>
</ul>
</li>
<li><a href="#joblog">Job#log</a></li>
<li><a href="#jobgetstate">Job#getState</a></li>
<li><a href="#jobupdate">Job#update</a></li>
<li><a href="#jobremove">Job#remove</a></li>
<li><a href="#jobretry">Job#retry</a></li>
<li><a href="#jobdiscard">Job#discard</a></li>
<li><a href="#jobpromote">Job#promote</a></li>
<li><a href="#jobfinished">Job#finished</a></li>
<li><a href="#jobmovetocompleted">Job#moveToCompleted</a></li>
<li><a href="#jobmovetofailed">Job#moveToFailed</a></li>
</ul>
</li>
<li><a href="#%E6%B4%BB%E5%8A%A8">活动</a>
<ul>
<li><a href="#%E5%85%A8%E5%B1%80%E4%BA%8B%E4%BB%B6">全局事件</a></li>
</ul>
</li>
</ul>
<h2 id="队列">队列</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">queueName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">url?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">opts?</span>: <span style="color:#204a87;font-weight:bold">QueueOptions</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Queue</span>
</span></span></code></pre></div><p>这是 Queue 构造函数。
它创建了一个新的 Queue 持久化在 Redis 中。
每次实例化同一个队列时，它都会尝试处理以前未完成会话中可能存在的所有旧作业。</p>
<p>可选的 <code>url</code> 参数，允许指定一个 redis 连接字符串，例如: <code>redis://mypassword@myredis.server.com:1234</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">QueueOptions</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">createClient</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;client&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;subscriber&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;bclient&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config?</span>: <span style="color:#204a87;font-weight:bold">Redis.RedisOptions</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Redis</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Cluster</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">limiter?</span>: <span style="color:#204a87;font-weight:bold">RateLimiter</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">redis?</span>: <span style="color:#204a87;font-weight:bold">RedisOpts</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">prefix?</span>: <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;bull&#34;</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// prefix for all queue keys.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">metrics?</span>: <span style="color:#204a87;font-weight:bold">MetricsOpts</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Configure metrics
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">defaultJobOptions?</span>: <span style="color:#204a87;font-weight:bold">JobOpts</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">settings?</span>: <span style="color:#204a87;font-weight:bold">AdvancedSettings</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">MetricsOpts</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">maxDataPoints?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">//  Max number of data points to collect, granularity is fixed at one minute.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">RateLimiter</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">max</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Max number of jobs processed
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">duration</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// per duration in milliseconds
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">bounceBack?</span>: <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// When jobs get rate limited, they stay in the waiting queue and are not moved to the delayed queue
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">groupKey?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// allows grouping of jobs with the specified key from the data object passed to the Queue#add (ex.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#4e9a06">&#34;network.handle&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>RedisOpts</code> 直接传递给 ioredis 构造函数，请查看<a href="https://github.com/luin/ioredis/blob/master/API.md">ioredis</a>了解详细信息。
我们在这里只记录最重要的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">RedisOpts</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">port?</span>: <span style="color:#204a87;font-weight:bold">number</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">6379</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">host?</span>: <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">localhost</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">db?</span>: <span style="color:#204a87;font-weight:bold">number</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">password?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">AdvancedSettings</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">lockDuration</span>: <span style="color:#204a87;font-weight:bold">number</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">30000</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Key expiration time for job locks.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">lockRenewTime</span>: <span style="color:#204a87;font-weight:bold">number</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">15000</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Interval on which to acquire the job lock
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">stalledInterval</span>: <span style="color:#204a87;font-weight:bold">number</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">30000</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// How often check for stalled jobs (use 0 for never checking).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">maxStalledCount</span>: <span style="color:#204a87;font-weight:bold">number</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Max amount of times a stalled job will be re-processed.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">guardInterval</span>: <span style="color:#204a87;font-weight:bold">number</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5000</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Poll interval for delayed jobs and added jobs.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">retryProcessDelay</span>: <span style="color:#204a87;font-weight:bold">number</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5000</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// delay before processing next job in case of internal error.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">backoffStrategies</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{};</span> <span style="color:#8f5902;font-style:italic">// A set of custom backoff strategies keyed by name.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">drainDelay</span>: <span style="color:#204a87;font-weight:bold">number</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// A timeout for when the queue is in drained state (empty waiting for jobs).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">isSharedChildPool</span>: <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// enables multiple queues on the same instance of child pool to share the same instance.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h4 id="自定义或共享-ioredis-连接">自定义或共享 IORedis 连接</h4>
<p><code>createClient</code> 被传递一个 <code>type</code> 来指定 Bull 试图创建的连接的类型，以及 <code>Bull</code> 想要为该连接设置的一些选项。</p>
<p>您可以将提供的选项与您自己的一些选项合并，并创建一个 <code>ioredis</code> 连接。</p>
<p>当 type 为 <code>client</code> 或 <code>subscriber</code> 时，你可以为多个队列返回相同的连接，这可以减少你打开到 redis 服务器的连接数。
当队列关闭时，Bull 不会关闭或断开这些连接，所以如果你需要让你的应用程序做一个优雅的关闭，你需要保留对这些连接的引用
Redis 在某个地方连接，并在关闭所有队列后断开连接。</p>
<p>然而， <code>bclient</code> 连接是一个 <code>阻塞客户端</code> ，用于每次等待单个队列上的新作业。
因此，它不能被共享，每次都应该返回一个新的连接。</p>
<h4 id="高级设置">高级设置</h4>
<p><strong>警告:</strong> 不要覆盖这些高级设置，除非你了解队列的内部。</p>
<p><code>lockDuration</code> :获取作业锁的时间，以毫秒为单位。
如果您发现您的作业因为您的作业处理器是 cpu 密集型的并且阻塞了事件循环而被暂停，那么将这个值设置为一个更高的值(请参阅下面关于暂停作业的说明)。
如果您的作业对时间非常敏感，则将此值设置为较低的值，并且如果它们被重复处理(因为它们被错误地认为是暂停的)，则此值可能是可以的。</p>
<p><code>lockRenewTime</code> :以毫秒为单位的获取作业锁的时间间隔。
默认设置为 <code>lockDuration / 2</code> ，以便在每次作业锁到期前提供足够的缓冲区来更新锁。
它不应该设置大于 <code>lockDuration</code> 的值。
如果发现作业由于 cpu 密集型作业处理器功能而陷入停顿，则将此值设置为较低的值。
不过一般来说，你不应该改变这个。</p>
<p><code>stalledInterval</code> :以毫秒为单位的时间间隔，每个 worker 将在此时间间隔内检查暂停的作业(例如:
处于 <code>活动</code> 状态的未锁定作业)。
见下面关于停滞的工作的说明。
如果您的作业对时间非常敏感，请将此值设置为较低的值。
如果你的 Redis CPU 使用率很高，设置一个更高的值，因为这个检查可能会很昂贵。
请注意，因为每个 worker 都在自己的时间间隔内运行它，并检查整个队列，所以被暂停的作业实际运行的频率要比这个值所暗示的高得多。</p>
<p><code>maxStalledCount</code> :在出现 <code>作业停止超过允许限制</code> 错误而导致作业永久失败之前，作业可以重新启动的最大次数。
这被设置为默认值 <code>1</code> ，假设暂停的作业非常罕见(只由于进程崩溃)，并且您希望更安全一点，不要重新启动作业。
如果作业经常宕机(例如进程经常崩溃)，则设置更高的值，这样就可以将处理作业加倍。</p>
<p><code>guardInterval</code> :延迟作业 watchdog 运行的时间间隔(以毫秒为单位)。
当运行多个具有延迟任务的并发 worker 时， <code>guardInterval</code> 的默认值会导致网络带宽、cpu 占用率和内存占用率出现峰值。
每个并发的工人将运行延迟的工作监督程序。
在本例中，将该值设置为更高的值。 <code>guardInterval = numberOfWorkers * 5000</code> 。
设置一个较低的值，如果你的 Redis 连接不稳定，延迟的工作没有被及时处理。</p>
<p><code>retryProcessDelay</code> :在遇到 Redis 错误时，在尝试处理任务之前等待的时间(以毫秒为单位)。
在不稳定的 Redis 连接上设置一个较低的值。</p>
<p><code>backoffStrategies</code> :一个包含自定义 backoffStrategies 的对象。
对象中的键是策略的名称，值是应该返回以毫秒为单位的延迟的函数。
完整的例子参见[Patterns](./ Patterns .md#custom-backoff-strategy)。</p>
<p><code>drainDelay</code> :队列处于 <code>drain</code> 状态(空等待作业)时的超时。
它在调用 <code>queue.getNextJob()</code> 时使用，它将把它传递给<code>。brpoplpush</code> 在 Redis 客户端。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000">backoffStrategies</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">jitter</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">5000</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87">Math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">random</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">500</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><hr>
<h3 id="queueprocess">Queue#process</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 可以将这些函数视为重载函数。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 由于方法重载不存在于文本中，公牛通过检查参数的类型来识别所需的函数调用。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 确保您符合以下定义的模式之一。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 注意:如果未指定，默认为1。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">processor</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">done</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">any</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">concurrency</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">processor</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">done</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">any</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">processor</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">done</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">any</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">concurrency</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">processor</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">done</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">any</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>定义给定队列中的作业的处理函数。</p>
<p>每次将作业放入队列时，都会调用回调。
将作业的一个实例作为第一个参数传递给它。</p>
<p>如果回调签名包含第二个可选的 <code>done</code> 参数，则回调将被传递一个 <code>done</code> 回调，以便在作业完成后调用。
<code>done</code> 回调函数可以与 Error 实例一起调用，表示作业没有成功完成，或者当作业成功时，将结果作为第二个参数(例如: <code>done(null, result);</code> )。
错误将作为第二个参数传递给 <code>failed</code> 事件;结果将作为第二个参数传递给 <code>completed</code> 事件。</p>
<p>但是，如果回调签名不包含 <code>done</code> 参数，则必须返回一个 promise 来表示作业完成。
如果 promise 被拒绝，则错误将作为第二个参数传递给 <code>failed</code> 事件。
如果它被解析，它的值将是 <code>完成</code> 事件的第二个参数。</p>
<p>你可以指定一个<code>并发</code>参数。
然后，Bull 将根据这个最大值并行调用处理程序。</p>
<p>流程功能也可以声明为单独的流程。
这将更好地利用可用的 CPU 内核，并并行运行作业。
这是运行阻塞代码的完美方式。
只需指定到处理器模块的绝对路径。
例如，一个像这样导出 process 函数的文件:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// my-processor.js
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">module</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">exports</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// do some job
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>您可以返回一个值或承诺来表示作业已经完成。</p>
<p>可以提供一个 <code>name</code> 参数，以便每个队列可以定义多个进程函数。
命名进程将只处理与给定名称匹配的作业。
但是，如果在一个 Queue 中定义了多个命名进程函数，则每个进程函数定义的并发性将堆叠到 Queue 中。
请看下面的例子:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/***
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 对于每个命名的处理器，并发性叠加在一起，因此这三个进程函数中的任何一个都可以以125并发性运行。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 为了避免这种行为，您需要为每个进程函数创建一个自己的队列。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">loadBalancerQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;loadbalancer&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">loadBalancerQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;requestProfile&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">requestProfile</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">loadBalancerQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;sendEmail&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">25</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sendEmail</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">loadBalancerQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;sendInvitation&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sendInvite</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">profileQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;profile&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Max concurrency for requestProfile is 100
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">profileQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;requestProfile&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">requestProfile</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">emailQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;email&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Max concurrency for sendEmail is 25
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">emailQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;sendEmail&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">25</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sendEmail</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>指定 <code>*</code> 作为进程名将使其成为所有已命名作业的默认处理器。
它经常用于从一个进程函数中处理所有已命名的作业:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">differentJobsQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;differentJobsQueue&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">differentJobsQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;*&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">processFunction</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">differentJobsQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;jobA&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">opts</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">differentJobsQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;jobB&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">opts</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p><strong>注意:</strong> 为了确定是否通过返回 promise 或调用 <code>done</code> 回调来通知任务完成，Bull 会查看你传递给它的回调的长度属性。</p>
<p>所以要小心，因为下面的方法是行不通的:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// THIS WON&#39;T WORK!!
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">done</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// Oops! done callback here!
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resolve</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>This, however, will:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// No done callback here :)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resolve</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><hr>
<h3 id="queueadd">Queue#add</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span>: <span style="color:#204a87;font-weight:bold">object</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">opts?</span>: <span style="color:#204a87;font-weight:bold">JobOpts</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Job</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>创建一个新作业并将其添加到队列中。
如果队列为空，则直接执行作业，否则将被放入队列并尽快执行。</p>
<p>可以添加一个可选名称，以便只有为该名称(也称为作业类型)定义的流程函数将处理该作业。</p>
<p><strong>注意:</strong> 您需要为添加到队列中的所有已命名作业定义<em>processors</em>，否则队列将报错给定作业缺少一个处理器，除非您在定义处理器时使用 <code>*</code> 作为作业名称。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">JobOpts</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">priority</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Optional priority value.ranges from 1 (highest priority) to MAX_INT  (lowest priority).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Note that using priorities has a slight impact on performance, so do not use it if not required.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">delay</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// An amount of milliseconds to wait until this job can be processed.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Note that for accurate delays, both server and clients should have their clocks synchronized.[optional].
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">attempts</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// The total number of attempts to try the job until it completes.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">repeat</span>: <span style="color:#204a87;font-weight:bold">RepeatOpts</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Repeat job according to a cron specification, see below for details.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">backoff</span>: <span style="color:#204a87;font-weight:bold">number</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BackoffOpts</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Backoff setting for automatic retries if the job fails, default strategy: `fixed`.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Needs `attempts` to be set.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">lifo</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// if true, adds the job to the right of the queue instead of the left (default false)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">timeout</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// The number of milliseconds after which the job should fail with a timeout error [optional]
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">jobId</span>: <span style="color:#204a87;font-weight:bold">number</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Override the job ID - by default, the job ID is a unique integer, but you can use this setting to override it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// If you use this option, it is up to you to ensure the jobId is unique.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// If you attempt to add a job with an id that already exists, it will not be added (see caveat below about repeatable jobs).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">removeOnComplete</span>: <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">number</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">KeepJobs</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// If true, removes the job when it successfully completes.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// A number specified the amount of jobs to keep.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Default behavior is to keep the job in the completed set.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// See KeepJobs if using that interface instead.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">removeOnFail</span>: <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">number</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">KeepJobs</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// If true, removes the job when it fails after all attempts.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// A number specified the amount of jobs to keep, see KeepJobs if using that interface instead.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Default behavior is to keep the job in the failed set.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">stackTraceLimit</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Limits the amount of stack trace lines that will be recorded in the stacktrace.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h4 id="keepjobs-选项">KeepJobs 选项</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * KeepJobs
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * Specify which jobs to keep after finishing.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * If both age and count are  * specified, then the jobs kept will be the ones that satisfies both properties.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">KeepJobs</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">   * Maximum age in *seconds* for job to be kept.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">   */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">age?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">   * Maximum count of jobs to be kept.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">   */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">count?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><hr>
<h4 id="超时的实现">超时的实现</h4>
<p>务必注意，在给定的 <code>超时</code> 之后，作业不会被主动停止。
作业被标记为失败，作业的承诺被拒绝，但是 Bull 没有办法从外部停止处理器功能。</p>
<p>如果您需要一个作业在超时后停止处理，这里有一些建议:</p>
<ul>
<li>让作业本身定期检查 <code>job. getstatus()</code> ，如果状态变为 <code>failed</code> 则退出。</li>
<li>将作业实现为一个可取消承诺_。
如果处理器 promise 有一个 <code>cancel()</code> 方法，它将在作业超时时被调用，作业可以相应地响应。
(注:目前这只适用于原生承诺，参见<a href="https://github.com/OptimalBits/bull/issues/2203">#2203</a></li>
<li>如果您有一种从外部停止作业的方法，那么为 <code>failed</code> 事件添加一个侦听器，并在那里执行该操作。</li>
</ul>
<h4 id="重复的工作细节">重复的工作细节</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">RepeatOpts</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">cron?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Cron string
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">tz?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Timezone
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">startDate?</span>: <span style="color:#204a87;font-weight:bold">Date</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Start date when the repeat job should start repeating (only with cron).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">endDate?</span>: <span style="color:#204a87;font-weight:bold">Date</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// End date when the repeat job should stop repeating.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">limit?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Number of times the job should repeat at max.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">every?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Repeat every millis (cron setting cannot be used together with this setting.)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">count?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// The start value for the repeat iteration count.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">key</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// The key for the repeatable job metadata in Redis.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>添加带有 <code>repeat</code> 选项集的作业实际上会立即完成两件事情:创建一个 Repeatable job 配置，以及在作业第一次运行时调度一个常规的延迟作业。
第一次运行将被安排为 <code>按小时</code> 运行，也就是说，如果您创建了一个在 4:07 每 15 分钟重复一次的作业，那么该作业将首先在 4:15 运行，然后是 4:30，依此类推。
如果设置了 <code>startDate</code> ，作业将不会在 <code>startDate</code> 之前运行，但仍然会按小时运行。
在前面的示例中，如果将 <code>startDate</code> 设置为某一天的 6:05，即当天，第一个作业将在 6:15 运行。</p>
<p>cron 表达式使用<a href="https://github.com/harrisiirak/cron-parser">cron-parser</a>库，请参阅它们的文档以了解更多细节。</p>
<p>可重复作业配置不是作业，因此它不会出现在 <code>getJobs()</code> 等方法中。
要管理可重复作业配置，请使用<a href="#queuegetrepeatablejobs"><code>getRepeatableJobs()</code></a>或类似的方法。
这也意味着重复作业不参与评估 <code>jobId</code> 的唯一性——也就是说，一个不可重复作业可以具有与可重复作业配置相同的 <code>jobId</code> ，而两个可重复作业配置可以具有相同的 <code>jobId</code> ，只要它们具有不同的重复选项。</p>
<p>也就是说，以下代码将导致创建三个任务(一个是立即的，两个是延迟的):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">({},</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">jobId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;example&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">repeat</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">every</span>: <span style="color:#204a87;font-weight:bold">5</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">1000</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">({},</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">jobId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;example&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">repeat</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">every</span>: <span style="color:#204a87;font-weight:bold">5</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">1000</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// Will not be created, same repeat configuration
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">({},</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">jobId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;example&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">repeat</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">every</span>: <span style="color:#204a87;font-weight:bold">10</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">1000</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// Will be created, different repeat configuration
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">({},</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">jobId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;example&#34;</span> <span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// Will be created, no regular job with this id
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">({},</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">jobId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;example&#34;</span> <span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// Will not be created, conflicts with previous regular job
</span></span></span></code></pre></div><h4 id="补偿选项">补偿选项</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">BackoffOpts</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Backoff type, which can be either `fixed` or `exponential`.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// A custom backoff strategy can also be specified in `backoffStrategies` on the queue settings.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">delay</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Backoff delay, in milliseconds.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><hr>
<h3 id="queueaddbulk">Queue#addBulk</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">addBulk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">jobs</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">name?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span>: <span style="color:#204a87;font-weight:bold">object</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">opts?</span>: <span style="color:#204a87;font-weight:bold">JobOpts</span> <span style="color:#000;font-weight:bold">}[])</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Job</span><span style="color:#a40000">[]</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>创建作业数组并将它们添加到队列中。
它们的签名与<a href="#queueadd">Queue#add</a>相同。</p>
<hr>
<h3 id="queuepause">Queue#pause</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">pause</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">isLocal?</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">doNotWaitActive?</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span>
</span></span></code></pre></div><p>返回一个在队列暂停时解析的承诺。
暂停的队列在恢复之前不会处理新作业，但正在处理的当前作业将继续，直到完成。
暂停可以是全局的，也可以是局部的。
如果是全局的，那么给定队列的所有队列实例中的所有 worker 都将被暂停。
如果是本地的，在当前锁过期后，只有这个 worker 将停止处理新作业。
这对于阻止工人在倒闭前接受新工作是很有用的。</p>
<p>如果 <code>doNotWaitActive</code> 为 <code>true</code> ， <code>pause</code> 将不会等待任何活动作业完成后再解析。
否则， <code>pause </code>_将等待活动的作业完成。
更多信息请参见<a href="#queuewhencurrentjobsfinished">Queue#whenCurrentJobsFinished</a>。</p>
<p>暂停已经暂停的队列不会做任何事情。</p>
<hr>
<h3 id="queueispaused">Queue#isPaused</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">isPaused</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">isLocal?</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>检查队列是否被暂停。
如果需要知道这个特定实例是否暂停，则传递 true。</p>
<hr>
<h3 id="queueresume">Queue#resume</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">resume</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">isLocal?</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span>
</span></span></code></pre></div><p>返回一个承诺，该承诺在暂停后恢复队列时解析。
简历可以是本地的，也可以是全球的。
如果是全局的，那么给定队列的所有队列实例中的所有 worker 都将被恢复。
如果是本地的，只有这个工人将被恢复。
注意全局恢复队列不会恢复已经在本地暂停的 worker;对于这些，必须在它们的实例上直接调用 <code>resume(true)</code> 。</p>
<p>恢复未暂停的队列不会执行任何操作。</p>
<hr>
<h3 id="queuewhencurrentjobsfinished">Queue#whenCurrentJobsFinished</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">whenCurrentJobsFinished</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Void</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>返回一个承诺，该承诺在当前由该工人处理的所有作业完成时解决。</p>
<hr>
<h3 id="queuecount">Queue#count</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">count</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>返回一个 promise，该 promise 返回队列中等待或延迟的作业数量。
由于可能有其他进程添加或处理作业，因此该值可能只在非常短的时间内为真。</p>
<hr>
<h3 id="queueremovejobs">Queue#removeJobs</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">removeJobs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pattern</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>删除 jobId 匹配给定模式的所有作业。
模式必须遵循 redis 全局样式模式(语法)[https://redis.io/commands/keys]</p>
<p>例子:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000">myQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">removeJobs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;?oo*&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;done removing jobs&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>将删除 id 为: <code>boo</code> 、 <code>foofighter</code> 等的工作。</p>
<p>注意:此方法不影响可重复作业配置，而是使用<a href="#queueremoverepeatable"><code>removeRepeatable()</code></a>或<a href="#queueremoverepeatablebykey"><code>removeRepeatableByKey()</code></a></p>
<hr>
<h3 id="queueempty">Queue#empty</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">empty</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span>
</span></span></code></pre></div><p>清空一个队列，删除所有<em>input</em>列表和关联的作业。</p>
<p>注意:此函数只删除正在等待队列处理或被延迟处理的作业。
处于其他状态(活动、失败、已完成)的作业和可重复作业配置将保持不变，可重复作业将继续按计划创建。</p>
<p>要删除其他作业状态，请使用<a href="#queueobliterate"><code>clean()</code></a>，要删除包括 Repeatable job 配置在内的所有配置，请使用<a href="#queueobliterate"><code>obliterate()</code></a>。</p>
<hr>
<h3 id="queueclose">Queue#close</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">doNotWaitJobs?</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span>
</span></span></code></pre></div><p>关闭底层 Redis 客户端。
使用它来执行一个优雅的关闭。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Queue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;bull&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">queue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;example&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">after100</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">after</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">close</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;done&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;completed&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">after100</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p><code>close</code> 可以在任何地方调用，但有一点需要注意:如果在作业处理程序内部调用，则队列直到作业处理完毕才会关闭，所以下面的语句不起作用:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">jobDone</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">handle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">close</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">jobDone</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>相反,这样做:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">jobDone</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">handle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">close</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">jobDone</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>Or this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">close</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">handle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(...);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><hr>
<h3 id="queuegetjob">Queue#getJob</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getJob</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">jobId</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Job</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>返回一个 promise，该 promise 将返回与 <code>jobId</code> 参数相关联的作业实例。
如果指定的作业无法找到，承诺将被解析为 <code>null</code> 。</p>
<p>注意: 此方法不返回可重复作业配置，参见<a href="#queuegetrepeatablejobs"><code>getRepeatableJobs()</code></a></p>
<h3 id="queuegetjobs">Queue#getJobs</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getJobs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">types</span>: <span style="color:#204a87;font-weight:bold">JobStatus</span><span style="color:#000;font-weight:bold">[],</span> <span style="color:#000">start?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">asc?</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Job</span><span style="color:#a40000">[]</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>返回一个 promise，该 promise 将返回给定作业状态的作业实例数组。
提供了范围和顺序的可选参数。</p>
<p>注意: <code>start</code> 和 <code>end</code> 选项适用于每个<strong>作业状态</strong>。
例如，如果有 10 个作业处于<code>completed</code>状态，10 个作业处于<code>active</code>状态， <code>getJobs(['completed'，'active']， 0,4)</code> 将生成一个包含 10 个条目的数组，表示前 5 个已完成的作业(0 - 4)和前 5 个活动的作业(0 - 4)。</p>
<p>此方法不返回可重复作业配置，参见<a href="#queuegetrepeatablejobs"><code>getRepeatableJobs()</code></a></p>
<hr>
<h3 id="queuegetjoblogs">Queue#getJobLogs</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getJobLogs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">jobId</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">logs</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">[],</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">count</span>: <span style="color:#204a87;font-weight:bold">number</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>根据 start 和 end 参数返回带有日志的对象。
返回的计数值是日志的总量，这对于实现分页很有用。</p>
<hr>
<h3 id="queuegetrepeatablejobs">Queue#getRepeatableJobs</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getRepeatableJobs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">asc?</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">key</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">endDate</span>: <span style="color:#204a87;font-weight:bold">Date</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">tz</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">cron</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">every</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">next</span>: <span style="color:#204a87;font-weight:bold">number</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}[]</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>返回一个 promise，该 promise 将返回一个可重复作业配置数组。
提供了范围和顺序的可选参数。</p>
<hr>
<h3 id="queueremoverepeatable">Queue#removeRepeatable</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">removeRepeatable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">repeat</span>: <span style="color:#204a87;font-weight:bold">RepeatOpts</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>删除给定的可重复作业配置。
RepeatOpts 需要与添加作业时使用的相同。</p>
<hr>
<hr>
<h3 id="queueremoverepeatablebykey">Queue#removeRepeatableByKey</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">removeRepeatableByKey</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>通过键删除给定的可重复作业配置，以便不再为该特定配置处理任何可重复作业。</p>
<p>目前有两种方法可以获得可重复工作的 <code>关键</code> 。</p>
<p>当第一次创建作业时， <code>queue.add()</code> 将返回一个带有该作业键值的作业对象，你可以将其存储起来供以后使用:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">job</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;remove&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">example</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;data&#34;</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">repeat</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">every</span>: <span style="color:#204a87;font-weight:bold">1000</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// store job.opts.repeat.key somewhere...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">repeatableKey</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">repeat</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ...then later...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">removeRepeatableByKey</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">repeatableKey</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>否则，你可以使用<a href="#queuegetrepeatablejobs"><code>getRepeatableJobs()</code></a>列出所有可重复的作业，在列表中找到你想要删除的作业，并使用那里的键来删除它:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;remove&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">example</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;data&#34;</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">jobId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;findMe&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">repeat</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">every</span>: <span style="color:#204a87;font-weight:bold">1000</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">then</span> <span style="color:#000">later</span> <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">repeatableJobs</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getRepeatableJobs</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">foundJob</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">repeatableJobs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">find</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;findMe&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">removeRepeatableByKey</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">foundJob</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><hr>
<h3 id="queuegetjobcounts">Queue#getJobCounts</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getJobCounts</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">JobCounts</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>返回一个 promise，该 promise 将返回给定队列的作业计数。</p>
<pre tabindex="0"><code class="language-typescript{" data-lang="typescript{">  interface JobCounts {
    waiting: number,
    active: number,
    completed: number,
    failed: number,
    delayed: number
  }
}
</code></pre><hr>
<h3 id="queuegetcompletedcount">Queue#getCompletedCount</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getCompletedCount</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>返回一个 promise，该 promise 将返回给定队列中已完成的作业计数。</p>
<h3 id="queuegetfailedcount">Queue#getFailedCount</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getFailedCount</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>返回一个 promise，该 promise 将返回给定队列的失败作业计数。</p>
<h3 id="queuegetdelayedcount">Queue#getDelayedCount</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getDelayedCount</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>返回一个承诺，该承诺将返回给定队列的延迟作业计数。</p>
<h3 id="queuegetactivecount">Queue#getActiveCount</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getActiveCount</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>返回一个承诺，该承诺将返回给定队列的活动作业计数。</p>
<h3 id="queuegetwaitingcount">Queue#getWaitingCount</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getWaitingCount</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>返回一个 promise，该 promise 将返回给定队列的等待作业计数。</p>
<h3 id="queuegetpausedcount">Queue#getPausedCount</h3>
<p><em>弃用</em> 因为只有队列可以暂停，所以 getWaitingCount 会给出相同的结果。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getPausedCount</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>返回一个承诺，该承诺将返回给定队列的暂停作业计数。</p>
<h3 id="getters">Getters</h3>
<p>下面的方法用于获取处于特定状态的作业。</p>
<p>GetterOpts 可以用于从 getter 中配置某些方面。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">GetterOpts</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">excludeData</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Exclude the data field of the jobs.
</span></span></span></code></pre></div><h3 id="queuegetwaiting">Queue#getWaiting</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getWaiting</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">opts?</span>: <span style="color:#204a87;font-weight:bold">GetterOpts</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Array</span><span style="color:#a40000">&lt;</span><span style="color:#c4a000">Job</span><span style="color:#000;font-weight:bold">&gt;</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>返回一个 promise，该 promise 将返回一个数组，其中包含开始和结束之间的等待作业。</p>
<h3 id="queuegetactive">Queue#getActive</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getActive</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">opts?</span>: <span style="color:#204a87;font-weight:bold">GetterOpts</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Array</span><span style="color:#a40000">&lt;</span><span style="color:#c4a000">Job</span><span style="color:#000;font-weight:bold">&gt;</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>返回一个 promise，该 promise 将返回一个数组，其中包含开始和结束之间的活动作业。</p>
<h3 id="queuegetdelayed">Queue#getDelayed</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getDelayed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">opts?</span>: <span style="color:#204a87;font-weight:bold">GetterOpts</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Array</span><span style="color:#a40000">&lt;</span><span style="color:#c4a000">Job</span><span style="color:#000;font-weight:bold">&gt;</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>返回一个 promise，该 promise 将返回一个数组，其中包含开始和结束之间的延迟作业。</p>
<h3 id="queuegetcompleted">Queue#getCompleted</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getCompleted</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">opts?</span>: <span style="color:#204a87;font-weight:bold">GetterOpts</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Array</span><span style="color:#a40000">&lt;</span><span style="color:#c4a000">Job</span><span style="color:#000;font-weight:bold">&gt;</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>返回一个 promise，该 promise 将返回一个数组，其中包含开始和结束之间已完成的作业。</p>
<h3 id="queuegetfailed">Queue#getFailed</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getFailed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">opts?</span>: <span style="color:#204a87;font-weight:bold">GetterOpts</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Array</span><span style="color:#a40000">&lt;</span><span style="color:#c4a000">Job</span><span style="color:#000;font-weight:bold">&gt;</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>返回一个 promise，该 promise 将返回一个数组，其中包含开始和结束之间失败的作业。</p>
<h3 id="queuegetworkers">Queue#getWorkers</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getWorkers</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Array</span><span style="color:#a40000">&lt;</span><span style="color:#c4a000">Object</span><span style="color:#000;font-weight:bold">&gt;</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>返回一个 promise，该 promise 将解析为当前正在侦听或处理作业的数组工作者。
该对象包含与<a href="https://redis.io/commands/client-list">Redis CLIENT LIST</a>命令相同的字段。</p>
<hr>
<h3 id="queuegetmetrics">Queue#getMetrics</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getMetrics</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;completed&#39;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#39;failed&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">meta</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">count</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">prevTS</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">prevCount</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">data</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">[];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">count</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>返回一个解析为 Metrics 对象的承诺。</p>
<h3 id="queueclean">Queue#clean</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">clean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">grace</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">status?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">limit?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">number</span><span style="color:#a40000">[]</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>通知队列删除在宽限期之外创建的特定类型的作业。</p>
<h4 id="example">Example</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;cleaned&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">jobs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">type</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Cleaned %s %s jobs&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">jobs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">type</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//cleans all jobs that completed over 5 seconds ago.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5000</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//clean all jobs that failed over 10 seconds ago.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;failed&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><h3 id="queueobliterate">Queue#obliterate</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">obliterate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ops</span><span style="color:#ce5c00;font-weight:bold">?:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">force</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">})</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>完全删除一个队列及其所有数据。
为了消除队列，不能有活动作业，但可以使用 <code>force</code> 选项覆盖这种行为。</p>
<p>注意:由于此操作的持续时间可能相当长，这取决于队列中有多少作业，因此它不是自动执行的，而是迭代执行的。
然而，在此过程中队列总是暂停，如果队列在被另一个脚本删除期间取消暂停，则调用将失败，它设法删除的项目将被删除，直到失败。</p>
<h4 id="示例">示例</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Removes everything but only if there are no active jobs
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">obliterate</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">obliterate</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">force</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><hr>
<h2 id="工作">工作</h2>
<p>作业包括执行作业所需的所有数据，以及更新作业进度所需的进度方法。</p>
<p>对于用户来说，最重要的属性是 <code>Job#data</code> ，它包括被传递给<a href="#queueadd"><code>Queue#add</code></a>的对象，通常用于执行作业。</p>
<h3 id="jobprogress">Job#progress</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">progress</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">progress?</span>: <span style="color:#204a87;font-weight:bold">number</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">object</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span>
</span></span></code></pre></div><p>如果使用参数调用，则更新作业进度。
如果没有参数调用，则返回一个解析当前作业进度的 promise。</p>
<h4 id="arguments">Arguments</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>  <span style="color:#000">progress</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">Job</span> <span style="color:#000">progress</span> <span style="color:#000">number</span> <span style="color:#000">or</span> <span style="color:#000">any</span> <span style="color:#000">serializable</span> <span style="color:#000">object</span> <span style="color:#000">representing</span> <span style="color:#000">progress</span> <span style="color:#000">or</span> <span style="color:#000">similar</span><span style="color:#000;font-weight:bold">.</span>
</span></span></code></pre></div><hr>
<h3 id="joblog">Job#log</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">row</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span>
</span></span></code></pre></div><p>向此作业特定的作业添加日志行。
可以使用<a href="#queuegetjoblogs">Queue#getJobLogs</a>检索日志。</p>
<hr>
<h3 id="jobgetstate">Job#getState</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">getState</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span>
</span></span></code></pre></div><p>返回一个承诺，解析当前作业的状态(完成、失败、延迟等)。
可能的返回有:完成的、失败的、延迟的、活动的、等待的、暂停的、卡住的或 null。</p>
<p>请注意，该方法的实现效率不是很高，也不是原子性的。
如果您的队列确实有大量作业，您可能希望避免使用此方法。</p>
<hr>
<h3 id="jobupdate">Job#update</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span>: <span style="color:#204a87;font-weight:bold">object</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span>
</span></span></code></pre></div><p>使用 give data 对象更新了作业数据字段。</p>
<h3 id="jobremove">Job#remove</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">remove</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span>
</span></span></code></pre></div><p>从队列和可能包含作业的任何列表中删除作业。</p>
<h3 id="jobretry">Job#retry</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">retry</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span>
</span></span></code></pre></div><p>重新运行失败的作业。
返回一个承诺，该承诺在作业计划重试时解决。</p>
<hr>
<h3 id="jobdiscard">Job#discard</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">discard</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span>
</span></span></code></pre></div><p>即使 <code>attemptsMade</code> 小于 <code>job.attempts</code> ，也确保不再运行此作业。</p>
<h3 id="jobpromote">Job#promote</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">promote</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span>
</span></span></code></pre></div><p>将当前被 <code>延迟</code> 的作业提升到 <code>等待</code> 状态，并尽快执行。</p>
<h3 id="jobfinished">Job#finished</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">finished</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span>
</span></span></code></pre></div><p>返回一个承诺，该承诺在任务完成或失败时解析或拒绝。</p>
<h3 id="jobmovetocompleted">Job#moveToCompleted</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">moveToCompleted</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">returnValue</span>: <span style="color:#204a87;font-weight:bold">any</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ignoreLock</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">notFetch?</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#a40000">[</span><span style="color:#c4a000">Jobdata</span><span style="color:#a40000">,</span> <span style="color:#c4a000">JobId</span><span style="color:#a40000">]</span> <span style="color:#a40000">|</span> <span style="color:#c4a000">null</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>将作业移动到 <code>已完成</code> 队列。
将一个作业从<code>waiting</code>拉到<code>active</code>，并返回一个包含下一个作业数据和 id 的元组。
如果 <code>等待</code> 队列中没有作业，则返回 null。
设置 <code>notFetch</code> 为 true 以避免预取队列中的下一个作业。</p>
<hr>
<h3 id="jobmovetofailed">Job#moveToFailed</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#000">moveToFailed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errorInfo</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#000;font-weight:bold">{</span> <span style="color:#000">message</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#000">ignoreLock?</span>:<span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#a40000">[</span><span style="color:#c4a000">Jobdata</span><span style="color:#a40000">,</span> <span style="color:#c4a000">JobId</span><span style="color:#a40000">]</span> <span style="color:#a40000">|</span> <span style="color:#c4a000">null</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>将作业移动到 <code>失败</code> 队列。
将一个作业从<code>waiting</code>拉到<code>active</code>，并返回一个包含下一个作业数据和 id 的元组。
如果 <code>等待</code> 队列中没有作业，则返回 null。</p>
<hr>
<h2 id="活动">活动</h2>
<p>队列也会发出一些有用的事件:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;error&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// An error occured.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;waiting&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">jobId</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// A Job is waiting to be processed as soon as a worker is idling.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;active&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">jobPromise</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// A job has started.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// You can use `jobPromise.cancel()`` to abort it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;stalled&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// A job has been marked as stalled.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// This is useful for debugging job workers that crash or pause the event loop.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;lock-extension-failed&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// A job failed to extend lock.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// This will be useful to debug redis connection issues and jobs getting restarted because workers are not able to extend locks.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;progress&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">progress</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// A job&#39;s progress was updated!
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;completed&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// A job successfully completed with a `result`.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;failed&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// A job failed with reason `err`!
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;paused&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// The queue has been paused.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;resumed&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// The queue has been resumed.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;cleaned&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">jobs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">type</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// Old jobs have been cleaned from the queue.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#4e9a06">`jobs`</span> <span style="color:#000">is</span> <span style="color:#000">an</span> <span style="color:#000">array</span> <span style="color:#204a87;font-weight:bold">of</span> <span style="color:#000">cleaned</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// jobs, and `type` is the type of jobs cleaned.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;drained&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// Emitted every time the queue has processed all the waiting jobs (even if there can be some delayed jobs not yet processed)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;removed&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// A job successfully removed.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><h3 id="全局事件">全局事件</h3>
<p>事件在默认情况下是本地的——换句话说，它们只触发在给定 worker 上注册的侦听器。
如果你需要全局监听事件，例如来自其他服务器的事件，只需在事件前加上<code>global: ''</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Will listen locally, just to this queue...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;completed&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">listener</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Will listen globally, to instances of this queue...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;global:completed&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">listener</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>当处理全局事件时，局部事件将一个 <code>Job</code> 实例传递给事件监听器回调，注意全局事件传递的是作业的 ID。</p>
<p>如果你需要在全局监听器中访问 <code>Job</code> 实例，使用<a href="#queuegetjob">Queue#getJob</a>来检索它。
但是，请记住，如果在添加作业时启用了 <code>removeOnComplete</code> ，则作业在完成后将不再可用。
如果您需要访问作业并在完成后删除它，您可以使用<a href="#jobremove">job #remove</a>在侦听器中删除它。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Local events pass the job instance...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;progress&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">progress</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`Job </span><span style="color:#4e9a06">${</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> is </span><span style="color:#4e9a06">${</span><span style="color:#000">progress</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">% ready!`</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;completed&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`Job </span><span style="color:#4e9a06">${</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> completed! Result: </span><span style="color:#4e9a06">${</span><span style="color:#000">result</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">remove</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ...whereas global events only pass the job ID:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;global:progress&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">jobId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">progress</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`Job </span><span style="color:#4e9a06">${</span><span style="color:#000">jobId</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> is </span><span style="color:#4e9a06">${</span><span style="color:#000">progress</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">% ready!`</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;global:completed&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">jobId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`Job </span><span style="color:#4e9a06">${</span><span style="color:#000">jobId</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> completed! Result: </span><span style="color:#4e9a06">${</span><span style="color:#000">result</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getJob</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">jobId</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">remove</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ad94521a760596fc6e71a48e245b8ae8">6.4 - 模式</h1>
    <div class="lead">下面是一些常用的用Bull实现的模式的例子</div>
	<ul>
<li><a href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97">消息队列</a></li>
<li><a href="#%E8%BF%94%E5%9B%9E%E5%B7%A5%E4%BD%9C%E5%AE%8C%E6%88%90">返回工作完成</a></li>
<li><a href="#%E9%87%8D%E7%94%A8-redis-%E8%BF%9E%E6%8E%A5">重用 Redis 连接</a></li>
<li><a href="#redis-%E9%9B%86%E7%BE%A4">Redis 集群</a></li>
<li><a href="#%E8%B0%83%E8%AF%95">调试</a></li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A1%A5%E5%81%BF%E7%AD%96%E7%95%A5">自定义补偿策略</a></li>
<li><a href="#%E6%89%8B%E5%8A%A8%E6%8A%93%E5%8F%96%E5%B7%A5%E4%BD%9C">手动抓取工作</a></li>
</ul>
<p>如果你有任何其他你想要添加的常见模式，拉请求它们!</p>
<h2 id="消息队列">消息队列</h2>
<p>Bull 也可以用于持久消息队列。
在某些用例中，这是一个非常有用的特性。
例如，您可以有两个需要相互通信的服务器。
通过使用队列，服务器不需要同时在线，因此这创建了一个非常健壮的通信通道。
你可以把&rsquo; add &lsquo;当作<em>send</em>，把&rsquo; process &lsquo;当作<em>receive</em>:</p>
<p>服务器:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Queue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;bull&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">sendQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Server B&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">receiveQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Server A&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">receiveQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">done</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Received message&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">msg</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">done</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">sendQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Hello&#34;</span> <span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>Server B:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Queue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;bull&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">sendQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Server A&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">receiveQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Server B&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">receiveQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">done</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Received message&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">msg</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">done</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">sendQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;World&#34;</span> <span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><h2 id="返回工作完成">返回工作完成</h2>
<p>一种常见的模式是，您有一个队列处理器集群，以尽可能快的速度处理作业，而其他一些服务需要获取该处理器的结果并对其进行处理，可能会将结果存储在数据库中。</p>
<p>实现这一目标的最健壮和可伸缩的方法是将标准作业队列与消息队列模式结合起来:服务只需打开作业队列并向其添加作业，就可以将作业发送到集群，集群将以尽可能快的速度开始处理。
每当在集群中完成一个作业时，一条消息就会连同结果数据发送到一个结果消息队列，这个队列由一些存储结果到数据库中的其他服务进行侦听。</p>
<h2 id="重用-redis-连接">重用 Redis 连接</h2>
<p>一个标准的队列需要 3 个连接到 Redis 服务器。
在某些情况下，您可能希望重用连接—例如在 Heroku 中，连接数是受限制的。
你可以通过&rsquo; Queue &lsquo;构造函数中的&rsquo; createClient &lsquo;选项来做到这一点。</p>
<p>注:</p>
<ul>
<li>bclient 连接<a href="https://github.com/OptimalBits/bull/issues/880">不能被重用</a>，所以你应该返回一个新的连接每次调用。</li>
<li>客户端和订阅者连接可以共享，当队列关闭时不会关闭。
当您关闭进程时，首先关闭队列，然后关闭共享连接(如果它们是共享的)。</li>
<li>如果你不共享连接,但仍使用“createClient”做一些定制的连接逻辑,你可能仍然需要您创建的所有连接的列表,这样你就可以手动关闭后,队列关闭,如果你需要优雅的关闭过程</li>
<li>不要在你创建的连接上设置一个“keyPrefix”，如果你需要一个键前缀，使用 bull 的内置前缀特性</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">REDIS_URL</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">process</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">env</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ioredis&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">subscriber</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">opts</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// redisOpts here will contain at least a property of connectionName which will identify the queue based on its name
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">createClient</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">redisOpts</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;client&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">client</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">REDIS_URL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">redisOpts</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;subscriber&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">subscriber</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">subscriber</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">REDIS_URL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">redisOpts</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">subscriber</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;bclient&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">REDIS_URL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">redisOpts</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">default</span><span style="color:#ce5c00;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Unexpected connection type: &#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">type</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">queueFoo</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foobar&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">opts</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">queueQux</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;quxbaz&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">opts</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><h2 id="redis-集群">Redis 集群</h2>
<p>Bull 内部函数需要跨不同键的原子操作。
这种行为打破了 Redis 的集群配置规则。
但是，仍然可以通过使用适当的 Bull 前缀选项作为集群“散列标签”来使用集群环境。
哈希标签是用来保证某些键被放置在相同的哈希槽，阅读更多关于哈希标签在<a href="https://redis.io/topics/cluster-tutorial">redis 集群教程</a>。
散列标记用括号定义。
例如，一个键在括号内有一个子字符串，将使用该子字符串来确定该键将被放置在哪个哈希槽中。</p>
<p>总之，为了使 Bull 与 Redis 集群兼容，在括号内使用队列前缀。</p>
<p>例如:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">queue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;cluster&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">prefix</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;{myprefix}&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>如果在同一个集群中使用多个队列，则应该使用不同的前缀，以便将这些队列均匀地放置在集群节点中。</p>
<h2 id="调试">调试</h2>
<p>要查看调试语句，设置或添加&rsquo; bull &lsquo;到&rsquo; NODE_DEBUG &lsquo;环境变量:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">NODE_DEBUG</span><span style="color:#ce5c00;font-weight:bold">=</span>bull
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">NODE_DEBUG</span><span style="color:#ce5c00;font-weight:bold">=</span>bull node ./your-script.js
</span></span></code></pre></div><h2 id="自定义补偿策略">自定义补偿策略</h2>
<p>当重试时内置的回退策略不够用时，可以定义自定义策略。
自定义回退策略由队列上的函数定义。
已尝试处理作业的次数作为第一个参数传递给该函数，作业失败的错误作为第二个参数传递给该函数。
该函数返回延迟重试的时间，0 表示立即重试，-1 表示立即失败。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Queue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;bull&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">myQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Server B&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">settings</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">backoffStrategies</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">jitter</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">attemptsMade</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">5000</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87">Math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">random</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">500</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div><p>然后，可以使用上面定义的名称在作业中指定新的回退策略:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000">myQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;bar&#34;</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">attempts</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">backoff</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;jitter&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>你可以为你的策略指定选项:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Queue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;bull&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">myQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Server B&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">settings</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">backoffStrategies</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic">// truncated binary exponential backoff
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">binaryExponential</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">attemptsMade</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Options can be undefined, you need to handle it by yourself
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">options</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{};</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">delay</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">delay</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">truncate</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">truncate</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">attemptsMade</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">Math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">round</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">Math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">random</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">Math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">Math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">attemptsMade</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">truncate</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">delay</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">myQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;bar&#34;</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">attempts</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">backoff</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;binaryExponential&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">options</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">delay</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">500</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">truncate</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>你可以根据工作中出现的错误来制定退步策略:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Queue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;bull&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">MySpecificError</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">myQueue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Server C&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">settings</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">backoffStrategies</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">attemptsMade</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">instanceof</span> <span style="color:#000">MySpecificError</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">myQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">done</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">msg</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;Specific Error&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">MySpecificError</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">myQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Hello&#34;</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">attempts</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">backoff</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">myQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Specific Error&#34;</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">attempts</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">backoff</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><h2 id="手动抓取工作">手动抓取工作</h2>
<p>如果您希望实际的作业处理在一个单独的 repo/服务中完成，而不是在运行&rsquo; bull &lsquo;的地方，这个模式可能适合您。</p>
<p>可以使用几个简单的方法来手动转换作业的状态。</p>
<ol>
<li>
<p>向&rsquo;waiting&rsquo;队列添加作业。获取队列并调用&rsquo; add &lsquo;。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">Queue</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;bull&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">queue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">limiter</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">max</span>: <span style="color:#204a87;font-weight:bold">5</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">duration</span>: <span style="color:#204a87;font-weight:bold">5000</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bounceBack</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// important
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">...</span><span style="color:#000">queueOptions</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">random_attr</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;random_value&#34;</span> <span style="color:#000;font-weight:bold">});</span>
</span></span></code></pre></div></li>
<li>
<p>将任务从&rsquo;waiting&rsquo;中拉出并移动到&rsquo;active&rsquo;中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">job</span>: <span style="color:#204a87;font-weight:bold">Job</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getNextJob</span><span style="color:#000;font-weight:bold">();</span>
</span></span></code></pre></div></li>
<li>
<p>如果出现错误，将作业移动到&rsquo;failed&rsquo;队列。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">nextJobData</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nextJobId</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">moveToFailed</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;Call to external service failed!&#39;</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div></li>
<li>
<p>将作业移动到&rsquo;completed&rsquo;队列。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">nextJobData</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nextJobId</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">moveToCompleted</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;succeeded&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div></li>
<li>
<p>如果有任务返回，则返回下一个任务。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">nextJobdata</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">Job</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">fromJSON</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nextJobData</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nextJobId</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div></li>
</ol>
<p><strong>注意</strong></p>
<p>默认情况下，由&rsquo; getNextJob &lsquo;或&rsquo; moveToCompleted &lsquo;返回的作业的锁持续时间是 30 秒，如果它花费的时间超过 30 秒，作业将自动返回
标记为暂停，并根据最大暂停选项将移动回等待状态或标记为失败。
为了避免这种情况，您必须使用&rsquo; job.extendLock(duration) &lsquo;，以便在锁过期前给您更多的时间。
建议在锁时间过了一半后延长锁。</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-435587bcc45d824e4ef8cc4a14b58ca4">7 - OpenAPI-swagger</h1>
    
	<blockquote>
<p><a href="https://wanago.io/2022/02/14/api-nestjs-openapi-swagger/">https://wanago.io/2022/02/14/api-nestjs-openapi-swagger/</a></p>
</blockquote>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-ded90509c1cc7827e36c53eac5c262b5">7.1 - OpenAPI规范和Swagger</h1>
    
	<blockquote>
<p><a href="https://wanago.io/2022/02/14/api-nestjs-openapi-swagger/">https://wanago.io/2022/02/14/api-nestjs-openapi-swagger/</a></p>
</blockquote>
<p>Across this series, we emphasize code readability and maintainability.
In part #52 of this course, we’ve gone through generating documentation with Compodoc and JSDoc.
This time we look into the OpenAPI specification and the Swagger tool.</p>
<p>You can check out an interactive demo prepared by the Swagger team.</p>
<h2 id="openapi-和-swagger-介绍">OpenAPI 和 Swagger 介绍</h2>
<p>With OpenAPI and Swagger, we can create a user interface that serves as interactive API documentation for our project.
However, since it might be confusing, it is worth outlining the difference between the OpenAPI and the Swagger.</p>
<p>The OpenAPI is a specification used to describe our API and gives us a way to provide the details of our endpoints.
It includes the endpoints and the description of each operation’s inputs and outputs.
It also allows us to specify our authentication method, license, and contact information.</p>
<p>Swagger is a set of tools built around the OpenAPI specification.
The one that we present in this article is the Swagger UI.
It allows us to render the OpenAPI specification we wrote in as the API documentation.
The thing that makes it so valuable is that it is interactive.
Swagger generates a web page that we can publish so that people can view our API and make HTTP requests.
It is a great tool to share knowledge with other people working in our organization.
If our API is open to the public, we can also deploy the above page and share it with everyone.</p>
<p>OpenAPI Specification was formerly called the Swagger Specification, which might add more to the confusion.</p>
<h2 id="将-swagger-添加到我们的-nestjs-项目中">将 Swagger 添加到我们的 NestJS 项目中</h2>
<p>We need to install two dependencies to add Swagger to our NestJS project.</p>
<p>npm install @nestjs/swagger swagger-ui-express
If you use Fastify, install fastify-swagger instead of swagger-ui-express.</p>
<p>To generate the basics of our Swagger UI, we need to use the SwaggerModule and DocumentBuilder from @nestjs/swagger.</p>
<p>main.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">NestFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/core&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AppModule</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./app.module&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ConfigService</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/config&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">SwaggerModule</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">DocumentBuilder</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/swagger&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">bootstrap() {</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">app</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">NestFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">AppModule</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">configService</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ConfigService</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">swaggerConfig</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">DocumentBuilder</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">setTitle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;API with NestJS&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">setDescription</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;API developed throughout the API with NestJS course&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">setVersion</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;1.0&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">build</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87">document</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SwaggerModule</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createDocument</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">app</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">swaggerConfig</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">SwaggerModule</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">setup</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;api&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">document</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">port</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">configService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PORT&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">??</span> <span style="color:#0000cf;font-weight:bold">3000</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">listen</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">port</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">bootstrap</span><span style="color:#000;font-weight:bold">();</span>
</span></span></code></pre></div><p>The DocumentBuilder class contains a set of methods we can use to configure our Swagger UI.</p>
<p>Besides the above functions such as the setTitle, we will also go through some of the others in this article.</p>
<p>@nestjs/swagger/dist/document-builder.d.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">declare</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">DocumentBuilder</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">logger</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#204a87">document</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">setTitle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">setDescription</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">description</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">setVersion</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">version</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">setTermsOfService</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">termsOfService</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">setContact</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">url</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">setLicense</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">url</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">addServer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">url</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">description?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">variables?</span>: <span style="color:#204a87;font-weight:bold">Record</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#a40000">,</span> <span style="color:#c4a000">ServerVariableObject</span><span style="color:#000;font-weight:bold">&gt;)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">setExternalDoc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">description</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">url</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">setBasePath</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">path</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">addTag</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">description?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">externalDocs?</span>: <span style="color:#204a87;font-weight:bold">ExternalDocumentationObject</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">addSecurity</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span>: <span style="color:#204a87;font-weight:bold">SecuritySchemeObject</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">addSecurityRequirements</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">SecurityRequirementObject</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">requirements?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">[])</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">addBearerAuth</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options?</span>: <span style="color:#204a87;font-weight:bold">SecuritySchemeObject</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">addOAuth2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options?</span>: <span style="color:#204a87;font-weight:bold">SecuritySchemeObject</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">addApiKey</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options?</span>: <span style="color:#204a87;font-weight:bold">SecuritySchemeObject</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">addBasicAuth</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options?</span>: <span style="color:#204a87;font-weight:bold">SecuritySchemeObject</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">addCookieAuth</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cookieName?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options?</span>: <span style="color:#204a87;font-weight:bold">SecuritySchemeObject</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">securityName?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">build</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Omit</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">OpenAPIObject</span><span style="color:#a40000">,</span> <span style="color:#a40000">&#34;</span><span style="color:#c4a000">paths</span><span style="color:#a40000">&#34;</span><span style="color:#000;font-weight:bold">&gt;;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Doing all of the above generates the Swagger UI and serves it under at http://localhost:3000/api.</p>
<p>The above URL might be different based on the port of your NestJS application.</p>
<h2 id="自动生成-openapi-规范">自动生成 OpenAPI 规范</h2>
<p>Unfortunately, the specification we’ve defined so far does not contain much detail.</p>
<p>We can help NestJS generate a more detailed OpenAPI specification out of the box.
To do that, we need to use the CLI plugin &ldquo;@nestjs/swagger&rdquo; gives us.
To use it, we need to adjust our nest-cli.json file and run nest start.</p>
<p>nest-cli.json</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;collection&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;@nestjs/schematics&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;sourceRoot&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;src&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;compilerOptions&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;plugins&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;@nestjs/swagger&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>The CLI plugin assumes that our DTOs are suffixed with .dto.ts or .entity.ts.
It also assumes that the files that contain controllers end with .controller.ts.</p>
<h2 id="手动定义-openapi-规范">手动定义 OpenAPI 规范</h2>
<p>Thanks to using the above solution, we automatically get a significant part of the specification generated.
If we want to make some changes, we can use the wide variety of decorators that NestJS gives us.</p>
<h3 id="模型定义">模型定义</h3>
<p>We can use the @ApiProperty() decorator to annotate class properties.</p>
<p>register.dto</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">IsEmail</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">IsString</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">IsNotEmpty</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">MinLength</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Matches</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ApiProperty</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/swagger&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">RegisterDto</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsEmail</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsString</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsNotEmpty</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@ApiProperty</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">deprecated</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">description</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Use the name property instead&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">fullName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsString</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsNotEmpty</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@MinLength</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">password</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@ApiProperty</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">description</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Has to match a regular expression: /^\\+[1-9]\\d{1,14}$/&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">example</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;+123123123123&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsString</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@IsNotEmpty</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Matches</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">/^\+[1-9]\d{1,14}$/</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">phoneNumber</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">RegisterDto</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>The CLI plugin can understand the decorators from the class-validator such as @MinLength()</p>
<h3 id="分组端点">分组端点</h3>
<p>All of our endpoints go into the “default” group by default.
To categorize them better, we can use the @ApiTags() decorator.</p>
<p>posts.controller.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Controller</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostsService</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./posts.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ApiTags</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/swagger&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Controller</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;posts&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@ApiTags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;posts&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">postsService</span>: <span style="color:#204a87;font-weight:bold">PostsService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="用更多的细节描述我们的端点">用更多的细节描述我们的端点</h3>
<p>We can use decorators such as @ApiParam() and @ApiResponse() to provide more details about our endpoints.</p>
<p>posts.controller.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">DemoController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;:id&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@ApiParam</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;id&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">required</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">description</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Should be an id of a post that exists in the database&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87">Number</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@ApiResponse</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">status</span>: <span style="color:#204a87;font-weight:bold">200</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">description</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;A post has been successfully fetched&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">PostEntity</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@ApiResponse</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">status</span>: <span style="color:#204a87;font-weight:bold">404</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">description</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;A post with given id does not exist.&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">getPostById</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Param</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span> <span style="color:#000;font-weight:bold">}</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">FindOneParams</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getPostById</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">Number</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Instead of passing status: 200 and status: 404 we could use the @ApiOkResponse() and @ApiNotFoundResponse() decorators.</p>
<h2 id="验证和-cookies">验证和 cookies</h2>
<p>In this series, we use cookie-based authentication.
Since many of our endpoints require the user to log in, let’s add this functionality to our OpenAPI specification.</p>
<p>If you want to know more about authentication, check out API with NestJS #3.
Authenticating users with bcrypt, Passport, JWT, and cookies</p>
<p>Swagger supports a variety of different types of authentication.
Unfortunately, it currently does not support sending cookies when using the “Try it out” button.
We can deal with this issue by using the Swagger interface to directly log in to our API.</p>
<p>In our application, we have the /log-in endpoint.
A lot of its logic happens in the LocalAuthenticationGuard.
Therefore, the CLI plugin does not note that the user needs to provide an email and a password.
Let’s fix that using the @ApiBody() decorator.</p>
<p>authentication.controller.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">DemoController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@HttpCode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@UseGuards</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">LocalAuthenticationGuard</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Post</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;log-in&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@ApiBody</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">LogInDto</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">logIn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Req</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">request</span>: <span style="color:#204a87;font-weight:bold">RequestWithUser</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">user</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">accessTokenCookie</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">authenticationService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getCookieWithJwtAccessToken</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">cookie</span>: <span style="color:#204a87;font-weight:bold">refreshTokenCookie</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">token</span>: <span style="color:#204a87;font-weight:bold">refreshToken</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">authenticationService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getCookieWithJwtRefreshToken</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">usersService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">setCurrentRefreshToken</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">refreshToken</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">setHeader</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Set-Cookie&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">accessTokenCookie</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">refreshTokenCookie</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isTwoFactorAuthenticationEnabled</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>We now can use the “Try it out” button to send a request to the /log-in endpoint.</p>
<p>Performing the above request sets the right cookie in our browser.
Thanks to that, we will send this cookie when interacting with other endpoints automatically.</p>
<h2 id="处理文件上传">处理文件上传</h2>
<p>In part #55 of this series, we’ve implemented a way to upload files and store them on our server.
To reflect that in Swagger, we can use the @ApiBody() and @ApiConsumes() decorators.</p>
<p>users.controller.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">UsersService</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./users.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">BadRequestException</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Req</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UploadedFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UseGuards</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UseInterceptors</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">JwtAuthenticationGuard</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../authentication/jwt-authentication.guard&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">RequestWithUser</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../authentication/requestWithUser.interface&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Express</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;express&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">LocalFilesInterceptor</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../localFiles/localFiles.interceptor&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ApiBody</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ApiConsumes</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/swagger&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">FileUploadDto</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./dto/fileUpload.dto&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@Controller</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UsersController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">usersService</span>: <span style="color:#204a87;font-weight:bold">UsersService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@Post</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;avatar&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@UseGuards</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">JwtAuthenticationGuard</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@UseInterceptors</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">LocalFilesInterceptor</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">fieldName</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;file&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;/avatars&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">fileFilter</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">file</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">callback</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">file</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mimetype</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">includes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;image&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">callback</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">BadRequestException</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Provide a valid image&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">callback</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">limits</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fileSize</span>: <span style="color:#204a87;font-weight:bold">Math.pow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#8f5902;font-style:italic">// 1MB
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@ApiConsumes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;multipart/form-data&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@ApiBody</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">description</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;A new avatar for the user&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">FileUploadDto</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">addAvatar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Req</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">request</span>: <span style="color:#204a87;font-weight:bold">RequestWithUser</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">@UploadedFile</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">file</span>: <span style="color:#204a87;font-weight:bold">Express.Multer.File</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">usersService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">addAvatar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">path</span>: <span style="color:#204a87;font-weight:bold">file.path</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">filename</span>: <span style="color:#204a87;font-weight:bold">file.originalname</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">mimetype</span>: <span style="color:#204a87;font-weight:bold">file.mimetype</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>fileUpload.dto.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ApiProperty</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/swagger&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Express</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;express&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">FileUploadDto</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">@ApiProperty</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;string&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;binary&#34;</span> <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">file</span>: <span style="color:#204a87;font-weight:bold">Express.Multer.File</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">FileUploadDto</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>Doing the above creates an interface in Swagger UI where we can upload our image.</p>
<h2 id="总结">总结</h2>
<p>在本文中，我们已经介绍了 OpenAPI 规范和 Swagger UI 工具。
我们已经使用 CLI 插件获得了很多现成的东西。
尽管如此，在某些情况下，我们必须手动使用 NestJS 提供的不同装饰器。
我们还处理了 cookie 认证和文件上传。
以上内容为我们提供了创建健壮的交互式文档所必需的知识。</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-72a7b9da75676e436dce77dd4f1befe5">8 - awesome</h1>
    
	<blockquote>
<p><a href="https://github.com/nestjs/awesome-nestjs/blob/master/README.md">https://github.com/nestjs/awesome-nestjs/blob/master/README.md</a></p>
</blockquote>
<h2 id="资源">资源</h2>
<h4 id="官方资源">官方资源</h4>
<ul>
<li><a href="https://nestjs.com">Website</a></li>
<li><a href="https://docs.nestjs.com">Official Guide</a></li>
<li><a href="https://github.com/nestjs/nest">GitHub Repo</a></li>
<li>Examples
<ul>
<li><a href="https://github.com/nestjs/typescript-starter">Nest Starter</a> - Nest framework TypeScript starter.</li>
<li><a href="https://github.com/nestjs/javascript-starter">JavaScript Starter</a> - Nest framework JavaScript (ES6 / ES7 / ES8) starter.</li>
</ul>
</li>
</ul>
<h4 id="社区">社区</h4>
<ul>
<li><a href="https://gitter.im/nestjs/">Gitter</a></li>
<li><a href="https://discord.gg/G7Qnnhy">Discord</a></li>
<li><a href="https://t.me/nestjs">Telegram (community maintained)</a></li>
<li><a href="https://t.me/nestjsbr">Telegram (Brazilian Portuguese speak community)</a></li>
<li><a href="https://t.me/nest_ru">Telegram (Russian speak community)</a></li>
<li><a href="https://nestjs.slack.com">Slack (Korean speak community)</a></li>
<li><a href="https://www.reddit.com/r/Nestjs_framework">Reddit (community maintained)</a></li>
<li><a href="https://www.facebook.com/groups/606785643208589">Facebook (Polish speak community)</a></li>
</ul>
<h4 id="会谈">会谈</h4>
<ul>
<li><a href="https://www.youtube.com/watch?v=jo-1EUxMmxc">Revealing framework fundamentals: NestJS behind the curtain by Kamil Myśliwiec</a></li>
</ul>
<h4 id="教程">教程</h4>
<ul>
<li><a href="https://kamilmysliwiec.com/nest-release-canditate-is-here-introduction-modern-node-js-framework">Introduction to modern Node.js framework</a></li>
<li><a href="https://auth0.com/blog/nestjs-brings-typescript-to-nodejs-and-express">NestJS Node Express</a> - Teach how to use NestJS step by step.</li>
<li><a href="https://kamilmysliwiec.com/build-modern-scalable-node-js-web-applications-with-nest">Build web applications with Nest</a></li>
<li><a href="https://github.com/m24927605/Nestjs30Days">NestJS30Days</a> - Learn the NestJS framework in 30 days.</li>
<li><a href="https://pusher.com/tutorials/geofencing-nestjs-googlemaps">Build a geofencing web app using NestJS and the Google Maps API</a></li>
<li><a href="https://pusher.com/tutorials/live-comments-sentiment-analysis-nestjs">Build live comments with sentiment analysis using NestJS</a></li>
<li><a href="https://pusher.com/tutorials/chat-sentiment-analysis-nestjs">Build a chat app with sentiment analysis using NestJS</a></li>
<li><a href="https://pusher.com/tutorials/realtime-graph-nestjs">Create a realtime graph using NestJS</a></li>
<li><a href="https://pusher.com/tutorials/realtime-table-datatables-nestjs">Build a realtime table with DataTables and NestJS</a></li>
<li><a href="https://blog.exceptionfound.com/index.php/2018/06/07/nestjs-basic-auth-and-sessions/">NestJS Basic Auth and Sessions</a></li>
<li><a href="https://blog.exceptionfound.com/2020/12/03/nestjs-hasura-integration-via-schema-stitching/">NestJS Hasura Integration via Schema Stitching And JWT Auth</a></li>
<li><a href="https://medium.com/@ctran2428/mean-stack-with-nestjs-and-swagger-9d8d14862d6b">MEAN Stack with NestJS and Swagger</a></li>
<li><a href="https://www.youtube.com/watch?v=NF9Xn4g5MJY&amp;list=PLBeQxJQNprbiJm55q7nTAfhMmzIC8MWxc">NestJS Ideas API</a></li>
<li><a href="https://hackernoon.com/building-real-time-web-applications-using-nest-js-and-ably-d85887e81f06">Building a real time web applications using NestJS and Ably</a></li>
<li><a href="https://www.youtube.com/watch?v=nz6yFTyLbAQ&amp;list=PLq1kZ5GbKd4qyDcK3IHGSi4FDAL6fRZeL">Video Tutorials</a> - Building a full-stack blog with NestJS, Angular and Angular Material.</li>
<li><a href="https://www.udemy.com/course/the-complete-nestjs-developer-enterprise-nodejs-framework/">Free Video Course</a> - The complete NestJS developer. Enterprise Node.js framework.</li>
</ul>
<h4 id="例子">例子</h4>
<ul>
<li><a href="https://github.com/Pinedo11/nestDemo-ChatServer">ChatServer</a> - Server side of Chat App implemented using NestJS.</li>
<li><a href="https://github.com/Sikora00/ddd-by-examples-library-nestjs">Domain Driven Design - Library</a> - Example of an application that follows Domain Driven Design.</li>
<li><a href="https://github.com/lujakob/nestjs-realworld-example-app">Realworld Example App</a> - Exemplary real world backend API built with NestJS + TypeORM.</li>
<li><a href="https://github.com/vladotesanovic/mant">Mant</a> - New Stack on the Market to beat them all :ring: MANT.</li>
<li><a href="https://github.com/crudjs/rest-nestjs-postgres">REST NestJS Postgres</a> - CrudJS implemented as a REST API, using NestJS and Postgres.</li>
<li><a href="https://github.com/EndyKaufman/nest-permissions-seed">Nest Permissions Seed</a> - A simple application demonstrating the basic usage of permissions with NestJS.</li>
<li><a href="https://github.com/Innovic-io/angular-nestjs-rendering">Angular NestJS Rendering</a> - Angular 5+ server side rendering using NestJS.</li>
<li><a href="https://github.com/Abdallah-khalil/ContactManagerApp">Angular Contact Manager App</a> - A Contact Manager App using Angular, NestJS, Mongoose, Passport, JWT.</li>
<li><a href="https://github.com/Abdallah-khalil/Books-Library-API">Books Library API</a> - A restful API with NestJS and mongoose.</li>
<li><a href="https://github.com/Abdallah-khalil/NodeJsWithPassport">Passport Auth NestJS</a> - Passport strategies and oauth integration built with NestJS.</li>
<li><a href="https://github.com/jajaperson/nestjs-auth0">NestJS Auth0</a> - An example NestJS application that uses Auth0 via Passport for authentication.</li>
<li><a href="https://github.com/kelvin-mai/nest-ideas-api">Nest Ideas API</a> - An implementation of a REST and GraphQL server built with NestJS, PostgresQL and TypeORM.</li>
<li><a href="https://github.com/nest-cloud/nestcloud-starter">Nestcloud Starter</a> - Quickly start a micro-service app use nestcloud.</li>
<li><a href="https://github.com/surmon-china/nodepress">Nodepress</a> - A RESTful API server application for Blog CMS.</li>
<li><a href="https://github.com/International-Slackline-Association/Rankings-Backend">Serverless-Lambda-DynamoDB</a> - A fully SERVERLESS in-production application with AWS Lambda, DynamoDB, DynamoDB Streams.</li>
<li><a href="https://github.com/mamori-i-japan/mamori-i-japan-api">Serverless-Lambda-FirestoreDB</a> - A fully SERVERLESS in-production application with AWS Lambda, FirestoreDB, Firebase Auth, Winston Logger, Swagger. Also implements admin role authorization.</li>
<li><a href="https://github.com/kop7/serverless-nestjs-typeorm">Serverless NestJS TypeOrm</a> - Example how to NestJS using the serverless framework with TypeORM.</li>
<li><a href="https://github.com/marcomelilli/nestjs-email-authentication">Passport Email Auth</a> - Starter project that includes API for user email authentication with MongoDB and PassportJs.</li>
<li><a href="https://github.com/CatsMiaow/node-nestjs-structure">NestJS Project Structure</a> - Example of constructing a project structure with NestJS.</li>
<li><a href="https://github.com/kop7/nest-elasticsearch-vue">NestJS Elasticsearch Vue</a> - Autocomplete search with NestJS, Elasticsearch and Vue.</li>
<li><a href="https://github.com/pvarentsov/typescript-clean-architecture">TypeScript Clean Architecture</a> - Clean Architecture based application with NestJS, PostgreSQL and TypeORM.</li>
<li><a href="https://github.com/Tony133/nestjs-api-mongoose">NestJS Api Mongoose</a> - Simple example Api Rest with Nestjs 8.x and Mongoose</li>
</ul>
<h4 id="样板">样板</h4>
<ul>
<li><a href="https://github.com/VincentJouanne/nest-clean-architecture-ddd-example">🧪 Fully tested NestJS Prisma Clean Architecture Boilerplate</a> - This boilerplate shows how to test your NestJS API with unit, integration and e2e tests. Use-cases are written in functionnal programming with FP-TS.</li>
<li><a href="https://github.com/Ferdysd96/nestjs-permission-boilerplate">NestJS Permission Boilerplate</a> - This is a basic NestJS boilerplate project built on the more powerful Node.js framework. The main purpose of this project is to dynamically handle roles and permissions assigned to the user.</li>
<li><a href="https://github.com/squareboat/nestjs-boilerplate">SQB NestJS Boilerplate</a> - A production-ready 🏭 NestJS boilerplate with batteries 🔋 included. No Kidding!.</li>
<li><a href="https://github.com/ahrnee/nestjs-bff">Nest BFF</a> - A boilerplate <a href="https://samnewman.io/patterns/architectural/bff/">BFF</a> web application starter-project using NestJS. Includes CLI, and MongoDB migrations features.</li>
<li><a href="https://github.com/Saluki/nestjs-template">NestJS Template</a> - Scaffold your next TypeScript API with this production-ready NestJS template crafted for Docker environments.</li>
<li><a href="https://github.com/nartc/nest-mean">MEAN Todo with NestJS</a> - A simple Todo application with NestJS and Swagger. Included Authorization/Authentication.</li>
<li><a href="https://github.com/Vivify-Ideas/nestjs-boilerplate">NestJS Boilerplate</a> - Boilerplate with available authentication, typeorm, env configuration and swagger. Everything you need to start making great things.</li>
<li><a href="https://github.com/NarHakobyan/awesome-nest-boilerplate">Awesome Nest Boilerplate</a> - Typescript, Postgresql, TypeORM, Swagger for Api documentation, Role base access control, and best application architecture.</li>
<li><a href="https://github.com/notiz-dev/nestjs-prisma-starter">NestJS Prisma Starter</a> - Starter project for NestJS includes Graphql with Prisma Client, Passport-JWT authentication, Swagger Api and Docker.</li>
<li><a href="https://github.com/adrien2p/teanjs">TeanJS</a> - TeanJS is a starter that provides you all the keys to be able to start writing your code as quickly as possible.</li>
<li><a href="https://github.com/pezzetti/base-app-nestjs">NestJS DDD Boilerplate</a> - Domain Driven Design Base app with NestJS, Class Validator and TypeORM. SOLID principles applied to create fully testable applications.</li>
<li><a href="https://github.com/benawad/nest-mongo-graphql/">Nest Mongo Graphql</a> - Starter Kit using NestJS MongoDB Graphql and type-graphql <a href="https://typegraphql.ml/">https://typegraphql.ml/</a> inspired the type schema first approach.</li>
<li><a href="https://github.com/juicycleff/ultimate-backend">Ultimate Backend</a> - Enterprise multi-tenant SaaS starter kit with CQRS GraphQL microservice architecture, apollo federation, event source and authentication.</li>
<li><a href="https://github.com/fernandohenriques/nestjs-graphql-boilerplate">NestJS GraphQL Boilerplate</a> - Dockerized API boilerplate with NestJS, TypeORM, TypeGraphQL, MongoDB, GraphQL and automated tasks with Makefile. Code first approach.</li>
<li><a href="https://github.com/tomanagle/NextJS-NestJS-GraphQL-Starter">NextJS &amp; NestJS GraphQL Starter</a> - GraphQL NestJS with NextJS boilerplace. Includes GitHub, Reddit &amp; Google OAuth.</li>
<li><a href="https://github.com/tudorconstantin/knests/">The Knests Stack</a> - Full stack/end starter with: PostgreSQL, Knex.js, NestJS, Next.js, GraphQL, React, Material-UI, Docker multistage images for, Docker compose and a GitLab CI/CD pipeline fully configured.</li>
<li><a href="https://github.com/ahmetuysal/nest-hackathon-starter">Nest Hackathon Starter</a> - Hackathon starter project for NestJS. Includes Prisma, email verification, Passport-JWT authentication, Swagger and more.</li>
<li><a href="https://github.com/chocolat-chaud-io/stator">Stator</a> - A full-stack boilerplate that does it all - automatic releases, deployments, enforced conventions.</li>
<li><a href="https://github.com/monstar-lab-oss/nestjs-starter-rest-api">NestJS REST Starter Kit - By MonstarLab</a> - Features: JWT Auth, RBAC Authorization, TypeORM, winston logger, Pagination, Auto-generated Swagger. Other: prettier, commit-linting husky hooks, SonarCloud, docker-compose.</li>
<li><a href="https://github.com/Tony133/nestjs-api-boilerplate-jwt">NestJS Api Boilerplate JWT</a> - An API Boilerplate to create a ready-to-use REST API in seconds with NestJS + TypeORM and Passport Auth JWT.</li>
<li><a href="https://github.com/brocoders/nestjs-boilerplate">NestJS REST API boilerplate for typical project</a> - Boilerplate with Auth, TypeORM, PostgreSQL, Mailing, I18N, Docker, File uploads (support local and Amazon S3 drivers), Swagger, Tests, CI.</li>
<li><a href="https://github.com/alitnk/nest-prisma-monorepo">NestJS and Prisma Yarn Monorepo Starter Template</a> - Full-stack monorepo starter (Yarn workspaces) with Prisma, GraphQL, CI and more.</li>
<li><a href="https://github.com/gobeam/truthy">Truthy NestJS Headless CMS</a> - Open source headless CMS API written using NestJS, that has built-in modules like User Management, Role Management, Permission Management, Email Module, Account Settings, 2FA settings, Throttling, RBAC support, Localization, frontend application written with ReactJS &amp; Redux Saga, UI built with Ant design and many more. Other: unit test using Jest, prettier, commit-linting husky hooks, PostgreSQL, Redis, docker etc.</li>
<li><a href="https://github.com/mokuteki225/nest-websockets-chat-boilerplate">NestJS Realtime Chat</a> - Boilerplate for a realtime chat based on Websockets, TypeORM, PostgreSQL, REST, Docker which includes PassportJS/JWT auth, rooms, kick/ban user functionality</li>
</ul>
<h2 id="项目使用-nestjs">项目使用 NestJS</h2>
<h4 id="开源">开源</h4>
<ul>
<li><a href="https://github.com/ever-co/ever">Ever®</a> - Open-Source Commerce Platform for On-Demand Economy and Digital Marketplaces.</li>
<li><a href="https://github.com/feednext/feednext">Feednext</a> - Open-Source Social Media Application.</li>
<li><a href="https://github.com/ever-co/gauzy">Gauzy</a> - Open-Source Profits Sharing Platform for modern agencies and studios.</li>
<li><a href="https://github.com/Roche/lxdhub">LXDhub</a> - Management system for Linux Containers (LXC).</li>
<li><a href="https://github.com/notadd/notadd">Notadd</a> - Microservice development architecture.</li>
<li><a href="https://github.com/valueadd-poland/pimp-my-pr">Pimp My PR</a> - Open-Source platform for statistics and pull request management.</li>
<li><a href="https://tooljet.io/">ToolJet</a> - ToolJet is the open-source low-code framework alternative to Retool &amp; Mendix to build &amp; deploy internal tools with minimal engineering effort. (<a href="https://github.com/ToolJet/ToolJet">Source Code</a>) <code>GPL-3.0</code></li>
<li><a href="https://github.com/vendure-ecommerce/vendure">Vendure</a> - Open-Source headless GraphQL ecommerce framework built on NestJS, with a focus on developer productivity and ease of customization.</li>
<li><a href="https://github.com/pvarentsov/iola">iola</a> - Socket client with Rest API.</li>
<li><a href="https://github.com/amplication/amplication">Amplication</a> - Amplication is an open-source low-code devtool that auto-generates backend apps built with TypeScript and Node.js, and a client built with React.</li>
</ul>
<h2 id="组件和库">组件和库</h2>
<h4 id="实用程序">实用程序</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/nestjs/cqrs.svg?style=flat-square" alt=""> <a href="https://github.com/nestjs/cqrs">Nest CQRS</a> - A lightweight CQRS module for Nest framework.</li>
<li><img src="https://img.shields.io/github/stars/valueadd-poland/nestjs-packages.svg?style=flat-square" alt=""> <a href="https://github.com/valueadd-poland/nestjs-packages/tree/master/packages/typed-cqrs">Typed CQRS</a> - A wrapper for the Nest CQRS library for better typing of query and command results.</li>
<li><img src="https://img.shields.io/github/stars/nestjsx/nestjs-config.svg?style=flat-square" alt=""> <a href="https://github.com/nestjsx/nestjs-config">Nest Config</a> - A Great module to handle project configurations.</li>
<li><img src="https://img.shields.io/github/stars/Nikaple/nest-typed-config.svg?style=flat-square" alt=""> <a href="https://github.com/Nikaple/nest-typed-config">Nest Typed Config</a> - Intuitive, type-safe configuration module for Nest framework.</li>
<li><img src="https://img.shields.io/github/stars/nest-cloud/nestcloud.svg?style=flat-square" alt=""> <a href="https://github.com/nest-cloud/nestcloud">Nest Consul Service</a> - A Node.js micro-service solution based on Consul, writing by Typescript language and NestJS framework.</li>
<li><img src="https://img.shields.io/github/stars/rubiin/nestjs-easyconfig.svg?style=flat-square" alt=""> <a href="https://github.com/rubiin/nestjs-easyconfig">Nest Easy Config</a> - A NestJS module for managing configs that provides some sleek features.</li>
<li><img src="https://img.shields.io/github/stars/miaowing/nest-schedule.svg?style=flat-square" alt=""> <a href="https://github.com/miaowing/nest-schedule">Nest Schedule</a> - Schedule job easier by decorator.</li>
<li><img src="https://img.shields.io/github/stars/owl1n/nest-queue.svg?style=flat-square" alt=""> <a href="https://github.com/owl1n/nest-queue">Nest Queue</a> - Easy queue management based on Redis for your application.</li>
<li><img src="https://img.shields.io/github/stars/lupu60/nestjs-toolbox.svg?style=flat-square" alt=""> <a href="https://github.com/lupu60/nestjs-toolbox">Nest Toolbox</a> - The repository contains a suite of components and modules for NestJS.</li>
<li><img src="https://img.shields.io/github/stars/jeffminsungkim/nestjs-multer-extended.svg?style=flat-square" alt=""> <a href="https://github.com/jeffminsungkim/nestjs-multer-extended">Nest Multer Extended</a> - Extended MulterModule for NestJS framework with flexible Amazon S3 upload and helpful features.</li>
<li><img src="https://img.shields.io/github/stars/Papooch/nestjs-cls.svg?style=flat-square" alt=""> <a href="https://github.com/Papooch/nestjs-cls">Nest CLS</a> - A continuation-local storage module for Nest (using <code>async_hooks</code>)</li>
<li><img src="https://img.shields.io/github/stars/benhason1/nestjs-http-promise.svg?style=flat-square" alt=""> <a href="https://github.com/benhason1/nestjs-http-promise">NestJS HTTP Promise</a> - A Promise-based alternative to <code>@nestjs/axios</code>, with retries feature using <code>axios-retry</code> and <code>axios</code>.</li>
</ul>
<h4 id="状态管理">状态管理</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/derekkite/ngrx-nest.svg?style=flat-square" alt=""> <a href="https://github.com/derekkite/ngrx-nest">Ngrx Nest</a> - Ngrx/store and ngrx/effects on the server using the nest framework.</li>
</ul>
<h4 id="代码风格">代码风格</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/basarat/typescript-book.svg?style=flat-square" alt=""> <a href="https://github.com/basarat/typescript-book/blob/master/docs/styleguide/styleguide.md">StyleGuide and Coding Conventions</a> - An unofficial TypeScript StyleGuide.</li>
</ul>
<h4 id="web-sockets">Web Sockets</h4>
<ul>
<li><a href="https://docs.nestjs.com/websockets/gateways">Official</a></li>
</ul>
<h4 id="redis">Redis</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/nest-modules/ioredis.svg?style=flat-square" alt=""> <a href="https://github.com/nest-modules/ioredis">Nest Ioredis</a> - A ioredis module for Nest framework.</li>
<li><img src="https://img.shields.io/github/stars/liaoliaots/nestjs-redis.svg?style=flat-square" alt=""> <a href="https://github.com/liaoliaots/nestjs-redis">Nest Redis Cluster</a> - Redis(ioredis) module for NestJS framework.</li>
</ul>
<h4 id="mail">Mail</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/squareboat/nest-mailman.svg?style=flat-square" alt=""> <a href="https://github.com/squareboat/nest-mailman">Mailman</a> - The only 📮 mailer package you need for your NestJS Applications.</li>
<li><img src="https://img.shields.io/github/stars/partyka95/nest-mailer.svg?style=flat-square" alt=""> <a href="https://github.com/partyka95/nest-mailer">Nest Mailer</a> - A mailer module for Nest framework.</li>
</ul>
<h4 id="api">API</h4>
<ul>
<li><a href="https://github.com/nestjs/swagger">Swagger</a> - This&rsquo;s an OpenAPI (Swagger) module for Nest. <em>[<a href="https://docs.nestjs.com/recipes/swagger">Tutorial</a>]</em>.</li>
<li><img src="https://img.shields.io/github/stars/flamewow/nestjs-asyncapi.svg?style=flat-square" alt=""> <a href="https://github.com/flamewow/nestjs-asyncapi">AsyncAPI</a> - AsyncAPI module for NestJS.</li>
<li><img src="https://img.shields.io/github/stars/doug-martin/nestjs-query.svg?style=flat-square" alt=""> <a href="https://github.com/doug-martin/nestjs-query">Nest-Query</a> - Nest CRUD for GraphQL APIs.</li>
<li><img src="https://img.shields.io/github/stars/samchon/nestia.svg?style=flat-square" alt=""> <a href="https://github.com/samchon/nestia">Nestia</a> - Automatic SDK generator for the clients.</li>
</ul>
<h4 id="中间件">中间件</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/wbhob/nest-middlewares.svg?style=flat-square" alt=""> <a href="https://github.com/wbhob/nest-middlewares">Nest Middlewares</a> - Common, injectable middlewares for NestJS.</li>
</ul>
<h4 id="错误">错误</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/squareboat/nest-eyewitness.svg?style=flat-square" alt=""> <a href="https://github.com/squareboat/nest-eyewitness">Eyewitness</a> - Receive error reports directly to your inbox whenever any exception is witnessed 👀 in your NestJS application.</li>
<li><img src="https://img.shields.io/github/stars/shekohex/nestjs-flub.svg?style=flat-square" alt=""> <a href="https://github.com/shekohex/nestjs-flub">Nest Flub</a> - Pretty Error :tired_face: Stack Viewer for NestJS Framework :hammer_and_wrench:.</li>
<li><img src="https://img.shields.io/github/stars/ozkanonur/nestjs-enlighten.svg?style=flat-square" alt=""> <a href="https://github.com/ozkanonur/nestjs-enlighten">Nest Enlighten</a> - A laravel-ignition like error page for NestJS Framework.</li>
<li><img src="https://img.shields.io/github/stars/ozkanonur/nestjs-rate-limiter.svg?style=flat-square" alt=""> <a href="https://github.com/ozkanonur/nestjs-rate-limiter">Nest Rate Limiter</a> - A highly configurable rate limiter library.</li>
<li><img src="https://img.shields.io/github/stars/mentos1386/nest-raven.svg?style=flat-square" alt=""> <a href="https://github.com/mentos1386/nest-raven">Nest Raven</a> - Sentry Raven Module for NestJS Framework.</li>
</ul>
<h4 id="lint">Lint</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/unlight/eslint-plugin-nestjs.svg?style=flat-square" alt=""> <a href="https://github.com/unlight/eslint-plugin-nestjs">Eslint Plugin NestJS</a> - ESLint rules for NestJS framework.</li>
<li><img src="https://img.shields.io/github/stars/darraghoriordan/eslint-plugin-nestjs-typed.svg?style=flat-square" alt=""> <a href="https://github.com/darraghoriordan/eslint-plugin-nestjs-typed">Typescript-Eslint Plugin NestJS</a> - ESLint rules for NestJS framework.</li>
</ul>
<h4 id="路由器-">路由器 🚦</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/shekohex/nest-router.svg?style=flat-square" alt=""> <a href="https://github.com/shekohex/nest-router">Nest Router</a> - Router Module For NestJS Framework 🚦 🚀
for organizing your Routes, creating a routes tree, and more.</li>
</ul>
<h4 id="satellite">:satellite:</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/adrien2p/nestjs-dialogflow.svg?style=flat-square" alt=""> <a href="https://github.com/adrien2p/nestjs-dialogflow">NestJS Dialogflow</a> - Dialog flow module that simplify the web hook handling for your NLP application using NestJS.</li>
</ul>
<h4 id="日志记录">日志记录</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/gremo/nest-winston.svg?style=flat-square" alt=""> <a href="https://github.com/gremo/nest-winston">Nest Winston</a> - Winston module for NestJS.</li>
<li><img src="https://img.shields.io/github/stars/iamolegga/nestjs-pino.svg?style=flat-square" alt=""> <a href="https://github.com/iamolegga/nestjs-pino">Nest Pino</a> - Pino module for NestJS Log with request context in any place.</li>
<li><img src="https://img.shields.io/github/stars/jmcdo29/ogma.svg?style=flat-square" alt=""> <a href="https://github.com/jmcdo29/ogma">Ogma</a> - A monorepo for the Ogma logger and related packages.</li>
</ul>
<h4 id="监控">监控</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/MetinSeylan/Nestjs-OpenTelemetry.svg?style=flat-square" alt=""> <a href="https://github.com/MetinSeylan/Nestjs-OpenTelemetry">Nest OpenTelemetry</a> - Deeply integrated NestJS OpenTelemetry module with auto instrumentations.</li>
<li><img src="https://img.shields.io/github/stars/GenFirst/nest-status-monitor.svg?style=flat-square" alt=""> <a href="https://github.com/GenFirst/nest-status-monitor">Nest Status Monitor</a> - Simple, self-hosted module based on Socket.io and Chart.js to report realtime server metrics for NestJS based node servers.</li>
<li><img src="https://img.shields.io/github/stars/nestjs/terminus.svg?style=flat-square" alt=""> <a href="https://github.com/nestjs/terminus">Nest Terminus</a> - Integrated healthchecks, based on <a href="https://github.com/godaddy/terminus">Terminus</a> package.</li>
<li><img src="https://img.shields.io/github/stars/narando/nest-xray.svg?style=flat-square" alt=""> <a href="https://github.com/narando/nest-xray">Nest X-Ray</a> - Record incoming and outgoing request for <a href="https://aws.amazon.com/xray/">AWS X-Ray</a>, also supports custom instrumentation.</li>
<li><img src="https://img.shields.io/github/stars/pragmaticivan/nestjs-otel.svg?style=flat-square" alt=""> <a href="https://github.com/pragmaticivan/nestjs-otel">Nest OpenTelemetry (OTEL)</a> - OpenTelemetry module for NestJS.</li>
</ul>
<h4 id="国际化-i18n">国际化 (i18n)</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/ToonvanStrijp/nestjs-i18n.svg?style=flat-square" alt=""> <a href="https://github.com/ToonvanStrijp/nestjs-i18n">Nest i18n</a> - Adds i18n support easily to your server, with a rich formatting api build in.</li>
</ul>
<h4 id="货币">货币</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/vahidvdn/nestjs-cashify.svg?style=flat-square" alt=""> <a href="https://github.com/vahidvdn/nestjs-cashify">Nestjs Cashify</a> - Currency conversion module for NestJS.</li>
</ul>
<h4 id="事件">事件</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/yak0/nest-event.svg?style=flat-square" alt=""> <a href="https://github.com/yak0/nest-event">Nest Event</a> - Event handling with decorators for NestJS Framework.</li>
</ul>
<h4 id="身份验证">身份验证</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/iamolegga/nestjs-session.svg?style=flat-square" alt=""> <a href="https://github.com/iamolegga/nestjs-session">NestJS Session</a> - Idiomatic Session Module for NestJS. Built on top of <a href="https://npm.im/express-session">express-session</a>.</li>
</ul>
<h4 id="rbac-基于角色的访问控制">RBAC (基于角色的访问控制)</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/sergey-telpuk/nestjs-rbac.svg?style=flat-square" alt=""> <a href="https://github.com/sergey-telpuk/nestjs-rbac">Nest RBAC</a> - RBAC module for NestJS, with a dynamic storage and cache.</li>
<li><img src="https://img.shields.io/github/stars/relevantfruit/nestjs-keycloak-admin.svg?style=flat-square" alt=""> <a href="https://github.com/relevantfruit/nestjs-keycloak-admin">Nest Keycloak Admin</a> - Keycloak Admin Client with support for User Managed Access protocol.</li>
<li><img src="https://img.shields.io/github/stars/bjerkio/nestjs-oso.svg?style=flat-square" alt=""> <a href="https://github.com/bjerkio/nestjs-oso">NestJS OSO</a> - Library that simplifies the implementation of OSO (open-source policy engine for authorization).</li>
</ul>
<h4 id="多租赁">多租赁</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/AlexanderC/nestjs-mtenant.svg?style=flat-square" alt=""> <a href="https://github.com/AlexanderC/nestjs-mtenant">Nestjs MTenant</a> - A module for NestJS to enable multitenancy support with deep integration into the system as whole (based on <code>async_hooks</code>).</li>
</ul>
<h4 id="微服务">微服务</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/pvarentsov/nestjs-pg-notify.svg?style=flat-square" alt=""> <a href="https://github.com/pvarentsov/nestjs-pg-notify">NestJS PG Notify</a> - NestJS custom transport strategy for PostgreSQL Pub/Sub.</li>
<li><img src="https://img.shields.io/github/stars/sergey-telpuk/nestjs-transport-eventbus.svg?style=flat-square" alt=""> <a href="https://github.com/sergey-telpuk/nestjs-transport-eventbus">Nestjs Transport Eventbus</a> - The module for Nest to allow broadcasting events via variety of nestjs trasports in easy way</li>
<li><img src="https://img.shields.io/github/stars/p-fedyukovich/nestjs-google-pubsub-microservice.svg?style=flat-square" alt=""> <a href="https://github.com/p-fedyukovich/nestjs-google-pubsub-microservice">NestJS Google Cloud Pub/Sub Microservice Transport</a> - Custom Google Cloud Pub/Sub microservice transport</li>
</ul>
<h4 id="数据库">数据库</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/notiz-dev/nestjs-prisma.svg?style=flat-square" alt=""> <a href="https://github.com/notiz-dev/nestjs-prisma">NestJS Prisma</a> - Library and schematics adding Prisma integration to a NestJS application</li>
</ul>
<h2 id="测试">测试</h2>
<h4 id="集合的例子">集合的例子</h4>
<ul>
<li><a href="https://github.com/jmcdo29/testing-nestjs">Testing Nestjs</a> - A repository to show off to the community methods of testing NestJS including Unit Tests, Integration Tests, E2E Tests, pipes, filters, interceptors, GraphQL, Mongo, TypeORM, and more!</li>
</ul>
<h4 id="使用工具">使用工具</h4>
<ul>
<li><a href="https://www.npmjs.com/package/@golevelup/ts-jest">GoLevelUp utilities for Jest</a> - Utilities for making testing NestJS applications easier. Currently supports Jest.</li>
<li><a href="https://www.npmjs.com/package/mockingbird">Mockingbird</a> - A library to create typed tests fixtures/mocks using decorators and built-in faker support</li>
<li><a href="https://www.npmjs.com/package/nestjs-pact">NestJS + Pact</a> - Injectable Pact.js Consumer/Provider for NestJS</li>
</ul>
<h2 id="集成">集成</h2>
<h4 id="认证">认证</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/cdiaz/nestjs-auth0.svg?style=flat-square" alt=""> <a href="https://github.com/cdiaz/nestjs-auth0">Nest + Auth0</a> - NestJS Framework web application with Auth0.</li>
<li><img src="https://img.shields.io/github/stars/tfarras/nestjs-firebase-auth.svg?style=flat-square" alt=""> <a href="https://github.com/tfarras/nestjs-firebase-auth">Nest Firebase Auth</a> - NestJS Passport Strategy for Firebase Auth using Firebase Admin SDK</li>
</ul>
<h4 id="数据库-1">数据库</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/nestjs/typeorm.svg?style=flat-square" alt=""> <a href="https://github.com/nestjs/typeorm">Typeorm</a> - A TypeORM module for Nest framework [<a href="http://docs.nestjs.com/recipes/sql-typeorm">Tutorial</a>].</li>
<li><img src="https://img.shields.io/github/stars/owl1n/typeorm-factories.svg?style=flat-square" alt=""> <a href="https://github.com/owl1n/typeorm-factories">Nest Typeorm Factories</a> - A TypeORM Entities factories. Useful for NestJS unit testing.</li>
<li><img src="https://img.shields.io/github/stars/alphamikle/nest_transact.svg?style=flat-square" alt=""> <a href="https://github.com/alphamikle/nest_transact">Nest Transact</a> - The simplest transactions using with Nest and TypeORM</li>
<li><img src="https://img.shields.io/github/stars/nestjs/mongoose.svg?style=flat-square" alt=""> <a href="https://github.com/nestjs/mongoose">Nest Mongoose</a> - A Mongoose module for Nest framework.</li>
<li><img src="https://img.shields.io/github/stars/kpfromer/nestjs-typegoose.svg?style=flat-square" alt=""> <a href="https://github.com/kpfromer/nestjs-typegoose">Nest Typegoose</a> - A <a href="https://github.com/typegoose/typegoose">Typegoose</a> module for Nest framework.</li>
<li><img src="https://img.shields.io/github/stars/mikro-orm/nestjs.svg?style=flat-square" alt=""> <a href="https://github.com/mikro-orm/nestjs">Nest MikroORM</a> - A <a href="https://mikro-orm.io/">MikroORM</a> module for Nest Framework.</li>
<li><img src="https://img.shields.io/github/stars/adrien2p/nest-js-sequelize-jwt.svg?style=flat-square" alt=""> <a href="https://github.com/adrien2p/nest-js-sequelize-jwt">Nest Sequelize JWT</a> - Starter kit Nest + Sequelize + jwt.</li>
<li><img src="https://img.shields.io/github/stars/kentloog/nestjs-sequelize-typescript.svg?style=flat-square" alt=""> <a href="https://github.com/kentloog/nestjs-sequelize-typescript">Nest sequelize-typescript</a> - Nest + sequelize-typescript + JWT + Jest + Swagger.</li>
<li><a href="https://www.prisma.io/nestjs">Nest Prisma</a> - A Fully Type-Safe ORM for <a href="https://docs.nestjs.com/recipes/prisma">NestJS</a>.</li>
</ul>
<h4 id="graphql">GraphQL</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/golevelup/nestjs.svg?style=flat-square" alt=""> <a href="https://github.com/golevelup/nestjs/tree/master/packages/graphql-request">GoLevelUp NestJS GraphQL Request</a> - Easily inject and work with GraphQLClient instances from server side NestJS code. Useful for interacting with third party GraphQL APIs.</li>
<li><img src="https://img.shields.io/github/stars/golevelup/nestjs.svg?style=flat-square" alt=""> <a href="https://github.com/golevelup/nestjs/tree/master/packages/hasura">GoLevelUp NestJS Hasura</a> - NestJS integrations for working with <a href="https://hasura.io/">Hasura</a> which provides realtime GraphQL APIs over your Postgres Database.</li>
</ul>
<h4 id="模式">模式</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/nestjsx/nestjs-typeorm-paginate.svg?style=flat-square" alt=""> <a href="https://github.com/nestjsx/nestjs-typeorm-paginate">Nest typeorm paginate</a> - A simple function and interfaces for pagination.</li>
<li><img src="https://img.shields.io/github/stars/Insidexa/nestjs-rpc.svg?style=flat-square" alt=""> <a href="https://github.com/Insidexa/nestjs-rpc">Nest JSON RPC Transport</a> - JSON RPC transport layer for the NestJS framework.</li>
</ul>
<h4 id="编辑器">编辑器</h4>
<ul>
<li>VSCode
<ul>
<li><a href="https://marketplace.visualstudio.com/items?itemName=AbhijoyBasak.nestjs-files">NestJS Files</a> - Quickly create NestJS Files.</li>
<li><a href="https://github.com/ashinzekene/vscode-nestjs-snippets">NestJS Snippets</a> - Vscode NestJS code Snippets.</li>
</ul>
</li>
</ul>
<h4 id="amqp">AMQP</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/nestjsx/nestjs-amqp.svg?style=flat-square" alt=""> <a href="https://github.com/nestjsx/nestjs-amqp">Nest AMQP</a> - An amqp connection manager.</li>
<li><img src="https://img.shields.io/github/stars/AlariCode/nestjs-rmq.svg?style=flat-square" alt=""> <a href="https://github.com/AlariCode/nestjs-rmq">Nest RabbitMQ</a> - A custom library for NestJS microservice. It allows you to use RabbitMQ or AMQP.</li>
<li><img src="https://img.shields.io/github/stars/golevelup/nestjs.svg?style=flat-square" alt=""> <a href="https://github.com/golevelup/nestjs/tree/master/packages/rabbitmq">GoLevelUp NestJS RabbitMQ</a> - Flexible AMQP integrations for NestJS that supports multiple messaging patterns and intuitive decorators.</li>
</ul>
<h4 id="eventstore">EventStore</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/juicycleff/nestjs-event-store.svg?style=flat-square" alt=""> <a href="https://github.com/juicycleff/nestjs-event-store">Nest EventStore</a> - An evenstore.org module for NestJS CQRS with adapter support to persist lastcheckpoint for Catchup subscription.</li>
</ul>
<h4 id="支付网关">支付网关</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/nestjsx/nestjs-braintree.svg?style=flat-square" alt=""> <a href="https://github.com/nestjsx/nestjs-braintree">Nest Braintree</a> - A module for webhooks and transactions.</li>
<li><img src="https://img.shields.io/github/stars/dhaspden/nestjs-stripe.svg?style=flat-square" alt=""> <a href="https://github.com/dhaspden/nestjs-stripe">Nest Stripe</a> - A module for injecting a configured Stripe client into your services.</li>
<li><img src="https://img.shields.io/github/stars/golevelup/nestjs.svg?style=flat-square" alt=""> <a href="https://github.com/golevelup/nestjs/tree/master/packages/stripe">GoLevelUp Nest Stripe</a> - Injectable client plus autowired Stripe webhook handling for deeper integrations.</li>
</ul>
<h4 id="frontend">Frontend</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/FusionWorks/react-admin-nestjsx-crud-dataprovider.svg?style=flat-square" alt=""> <a href="https://github.com/FusionWorks/react-admin-nestjsx-crud-dataprovider">Nest CRUD React Admin</a> - A React Admin data provider for <a href="https://github.com/nestjsx/crud">NextJS CRUD</a>.</li>
<li><img src="https://img.shields.io/github/stars/SoftwareBrothers/admin-bro-nestjs.svg?style=flat-square" alt=""> <a href="https://github.com/SoftwareBrothers/admin-bro-nestjs">Nest AdminBro</a> - NestJS plugin for <a href="https://github.com/SoftwareBrothers/admin-bro">AdminBro</a>, an automatic admin interface which can be plugged into your application.</li>
</ul>
<h4 id="调度">调度</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/nestjsx/nest-bull.svg?style=flat-square" alt=""> <a href="https://github.com/nestjsx/nest-bull">Nest Bull</a> - A Bull module for Nest framework.</li>
</ul>
<h4 id="工作流自动化">工作流自动化</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/camunda-community-hub/nestjs-zeebe.svg?style=flat-square" alt=""> <a href="https://github.com/camunda-community-hub/nestjs-zeebe">Zeebe microservices</a></li>
</ul>
<h4 id="聊天机器人">聊天机器人</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/bukhalo/nestjs-telegraf.svg?style=flat-square" alt=""> <a href="https://github.com/bukhalo/nestjs-telegraf">Nest Telegraf</a> - A module for creating Telegram bots using NestJS, based on <a href="https://github.com/telegraf/telegraf">Telegraf</a>.</li>
<li><img src="https://img.shields.io/github/stars/SocketSomeone/necord.svg?style=flat-square" alt=""> <a href="https://github.com/SocketSomeone/necord">Necord</a> - A module for creating Discord bots using NestJS, based on <a href="https://github.com/discordjs/discord.js">Discord.js</a>.</li>
</ul>
<h4 id="文件存储">文件存储</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/codebrewlab/nestjs-storage.svg?style=flat-square" alt=""> <a href="https://github.com/codebrewlab/nestjs-storage">Nest Storage</a> - A manage file storage module(<a href="https://github.com/Slynova-Org/flydrive">flydrive</a>) for NestJS Framework.</li>
</ul>
<h4 id="云管理配置">云管理配置</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/nonfig/nestjs-config.svg?style=flat-square" alt=""> <a href="https://github.com/nonfig/nestjs-config">Nonfig Config</a> - A module for <a href="https://www.nonfig.com">Nonfig</a> Configuration Management Service. Nonfig combines Configurations and Features. So you change features, and release swiftly, and measure to digital impact.</li>
</ul>
<h4 id="sdk">SDK</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/tfarras/nestjs-firebase-admin.svg?style=flat-square" alt=""> <a href="https://github.com/tfarras/nestjs-firebase-admin">Nest Firebase Admin</a> - NestJS Module for <a href="https://firebase.google.com/">Firebase Admin SDK</a>.</li>
</ul>
<h2 id="运行时">运行时</h2>
<h4 id="命令行终端">命令行/终端</h4>
<ul>
<li><img src="https://img.shields.io/github/stars/jmcdo29/nest-commander.svg?style=flat-square" alt=""> <a href="https://github.com/jmcdo29/nest-commander">Nest Commander</a> - A module for using NestJS to build up CLI applications</li>
<li><img src="https://img.shields.io/github/stars/nestjs/nest-cli.svg?style=flat-square" alt=""> <a href="https://github.com/nestjs/nest-cli">CLI</a> - CLI tool for NestJS applications.</li>
<li><img src="https://img.shields.io/github/stars/ashinzekene/generator-nestjs-app.svg?style=flat-square" alt=""> <a href="https://github.com/ashinzekene/generator-nestjs-app">Yeoman Generator</a> - A yeoman generator for NestJS apps.</li>
<li><img src="https://img.shields.io/github/stars/Pop-Code/nestjs-console.svg?style=flat-square" alt=""> <a href="https://github.com/Pop-Code/nestjs-console">NestJS Console</a> - A NestJS module that provide a cli to application.</li>
<li><img src="https://img.shields.io/github/stars/LoneStone/nest-sdk-generator.svg?style=flat-square" alt=""> <a href="https://github.com/lonestone/nest-sdk-generator">Typescript SDK Generator</a> - A command-line utility to generate a fully typed SDK from a Nest.js REST API</li>
</ul>
<h2 id="meetups">Meetups</h2>
<p>None at the moment.<br>
Why not create a meetup and make a PR?</p>
<h2 id="贡献">贡献</h2>
<p>Contributions welcome! Read the <a href="CONTRIBUTING.md">contribution guidelines</a> first.</p>
<h2 id="许可证">许可证</h2>
<p><a href="http://creativecommons.org/publicdomain/zero/1.0"><img src="http://mirrors.creativecommons.org/presskit/buttons/88x31/svg/cc-zero.svg" alt="CC0"></a></p>
<p>To the extent possible under law, <code>juliandavidmr</code> has waived all copyright and
related or neighboring rights to this work.</p>

</div>



    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="User mailing list" aria-label="User mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/mail" aria-label="User mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/twitter" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Stack Overflow" aria-label="Stack Overflow">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/stack" aria-label="Stack Overflow">
      <i class="fab fa-stack-overflow"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/google/docsy" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/slack" aria-label="Slack">
      <i class="fab fa-slack"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Developer mailing list" aria-label="Developer mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/mail" aria-label="Developer mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2022 kamilmysliwiec 保留所有权利</small>
        <small class="ml-1"><a href="https://kamilmysliwiec.com/" target="_blank" rel="noopener">隐私政策</a></small>
	
		
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='/nestjs-docs/js/tabpane-persist.js'></script>


















<script src="/nestjs-docs/js/main.min.82227759f8f2ead5d4ac2028ff961235745a57120ee2f90ce8f820d05976f9bb.js" integrity="sha256-giJ3Wfjy6tXUrCAo/5YSNXRaVxIO4vkM6Pgg0Fl2&#43;bs=" crossorigin="anonymous"></script>




  </body>
</html>
