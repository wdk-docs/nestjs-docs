<!doctype html>
<html lang="zh-cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.88.1" />
<link rel="canonical" type="text/html" href="https://wdk-docs.github.io/nestjs-docs/docs/mongodb/">
<link rel="alternate" type="application/rss&#43;xml" href="https://wdk-docs.github.io/nestjs-docs/docs/mongodb/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/nestjs-docs/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/nestjs-docs/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/nestjs-docs/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/nestjs-docs/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/nestjs-docs/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/nestjs-docs/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/nestjs-docs/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/nestjs-docs/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/nestjs-docs/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/nestjs-docs/favicons/android-192x192.png" sizes="192x192">

<title>mongodb | NestJS 文档</title>
<meta name="description" content="
https://wanago.io/courses/api-with-nestjs/

">
<meta property="og:title" content="mongodb" />
<meta property="og:description" content="NestJs 文档" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://wdk-docs.github.io/nestjs-docs/docs/mongodb/" /><meta property="og:site_name" content="NestJS 文档" />

<meta itemprop="name" content="mongodb">
<meta itemprop="description" content="NestJs 文档"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="mongodb"/>
<meta name="twitter:description" content="NestJs 文档"/>




<link rel="preload" href="/nestjs-docs/scss/main.min.90983698afafd407e6b72e83a2b749ff1726e8502277108f05bd66510938dec2.css" as="style">
<link href="/nestjs-docs/scss/main.min.90983698afafd407e6b72e83a2b749ff1726e8502277108f05bd66510938dec2.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-00000000-0', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/nestjs-docs/">
		<span class="navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="text-uppercase font-weight-bold">NestJS 文档</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="/nestjs-docs/docs/" ><span class="active">文档</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/nestjs-docs/blog/" ><span>博客</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"><input type="search" class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label="站内搜索…" autocomplete="off">
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href="#" onclick="print();return false;">点击此处打印</a>.
</p><p>
<a href="/nestjs-docs/docs/mongodb/">返回本页常规视图</a>.
</p>
</div>



<h1 class="title">mongodb</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-ee82b5a9ba57222a5fbfd0b80a49cfa9">MongoDB概论</a></li>


    
  
    
    
	
<li>2: <a href="#pg-dcc33887b60b5620de8e60d4faae18bc">实现与MongoDB的关系</a></li>


    
  
    
    
	
<li>3: <a href="#pg-4451ab685262406c61d37462ff2cf30c">MongoDB和Mongoose的虚拟属性</a></li>


    
  
    
    
	
<li>4: <a href="#pg-d6a0d2e2730441d8a1bbcc80b1877247">与MongoDB和Mongoose管理事务</a></li>


    
  
    
    
	
<li>5: <a href="#pg-9dafda6a3ad4a457c936f5058f3f4460">使用MongoDB和Mongoose实现分页</a></li>


    
  
    
    
	
<li>6: <a href="#pg-9fc52bf385551b755df4c394152ea50c">使用MongoDB和Mongoose定义索引</a></li>


    
  
    
    
	
<li>7: <a href="#pg-87745293d49493ba2db7754c111a3568">用PUT和PATCH更新MongoDB和Mongoose</a></li>


    
  

    </ul>


<div class="content">
      <blockquote>
<p><a href="https://wanago.io/courses/api-with-nestjs/">https://wanago.io/courses/api-with-nestjs/</a></p>
</blockquote>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-ee82b5a9ba57222a5fbfd0b80a49cfa9">1 - MongoDB概论</h1>
    
	<p>到目前为止，在本系列文章中，我们主要讨论如何使用 SQL 和 Postgres 数据库。
虽然 PostgreSQL 是一个很好的选择，但它值得一试。
在本文中，我们将了解 MongoDB 是如何工作的，以及它与 SQL 数据库的区别。
我们还使用 MongoDB 和 NestJS 创建了一个简单的应用程序。</p>
<p>您可以从下面的文章中在这个存储库中找到源代码。</p>
<h2 id="mongodb-vs-sql-databases">MongoDB vs. SQL Databases</h2>
<p>MongoDB 的设计原则与传统的 SQL 数据库有很大的不同。
MongoDB 没有使用表和行来表示数据，而是将其存储为类似 json 的文档。
因此，熟悉 JavaScript 的开发人员比较容易掌握。</p>
<p>MongoDB 中的文档由键和值对组成。
它们的重要方面是，在给定集合中的文档中键可以不同。
这是 MongoDB 和 SQL 数据库之间的一个很大的区别。
它使 MongoDB 更加灵活，结构更松散。
因此，它既可以被视为优点，也可以被视为缺点。</p>
<h2 id="mongodb-的优点和缺点">MongoDB 的优点和缺点</h2>
<p>Since MongoDB and SQL databases differ so much, choosing the right tool for a given job is crucial.
Since NoSQL databases put fewer restrictions on the data, it might be a good choice for an application evolving quickly.
We still might need to update our data as our schema changes.</p>
<p>For example, we might want to add a new property containing the user’s avatar URL.
When it happens, we still should deal with documents not containing our new property.
We can do that by writing a script that puts a default value for old documents.
Alternatively, we can assume that this field can be missing and handle it differently on the application level.</p>
<p>On the contrary, adding a new property to an existing SQL database requires writing a migration that explicitly handles the new property.
This might seem like a bit of a chore in a lot of cases.
However, with MongoDB, it is not required.
This might make the work easier and faster, but we need to watch out and not lose the integrity of our data.</p>
<p>If you want to know more about SQL migrations, check out The basics of migrations using TypeORM and Postgres</p>
<p>SQL databases such as Postgres keep the data in tables consisting of columns and rows.
A big part of the design process is defining relationships between the above tables.
For example, a user can be an author of an article.
On the other hand, MongoDB is a non-relational database.
Therefore, while we can mimic SQL-style relationships with MongoDB, they will not be as efficient and foolproof.</p>
<h2 id="using-mongodb-with-nestjs">Using MongoDB with NestJS</h2>
<p>So far, in this series, we’ve used Docker to set up the architecture for our project.
We can easily achieve that with MongoDB also.</p>
<p>docker-compose.yml</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;3&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">services</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">mongo</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mongo:latest</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">environment</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">MONGO_INITDB_ROOT_USERNAME</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">${MONGO_USERNAME}</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">MONGO_INITDB_ROOT_PASSWORD</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">${MONGO_PASSWORD}</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">MONGO_INITDB_DATABASE</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">${MONGO_DATABASE}</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>- <span style="color:#4e9a06">&#39;27017:27017&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><p>Above, you can see that we refer to a few variables.
Let’s put them into our .env file:</p>
<p>.env</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-env" data-lang="env"><span style="color:#000">MONGO_USERNAME</span><span style="color:#ce5c00;font-weight:bold">=</span>admin
<span style="color:#000">MONGO_PASSWORD</span><span style="color:#ce5c00;font-weight:bold">=</span>admin
<span style="color:#000">MONGO_DATABASE</span><span style="color:#ce5c00;font-weight:bold">=</span>nestjs
<span style="color:#000">MONGO_HOST</span><span style="color:#ce5c00;font-weight:bold">=</span>localhost:27017
</code></pre></div><p>In the previous parts of this series, we’ve used TypeORM to connect to our PostgreSQL database and manage our data.
For MongoDB, the most popular library is Mongoose.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">npm install --save @nestjs/mongoose mongoose
</code></pre></div><p>Let’s use Mongoose to connect to our database.
To do that, we need to define a URI connection string:</p>
<p>app.module.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Module</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">MongooseModule</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ConfigModule</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ConfigService</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/config&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostsModule</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./posts/posts.module&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">Joi</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@hapi/joi&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Module</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">imports</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
    <span style="color:#000">ConfigModule</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">forRoot</span><span style="color:#000;font-weight:bold">({</span>
      <span style="color:#000">validationSchema</span>: <span style="color:#204a87;font-weight:bold">Joi.object</span><span style="color:#000;font-weight:bold">({</span>
        <span style="color:#000">MONGO_USERNAME</span>: <span style="color:#204a87;font-weight:bold">Joi.string</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">required</span><span style="color:#000;font-weight:bold">(),</span>
        <span style="color:#000">MONGO_PASSWORD</span>: <span style="color:#204a87;font-weight:bold">Joi.string</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">required</span><span style="color:#000;font-weight:bold">(),</span>
        <span style="color:#000">MONGO_DATABASE</span>: <span style="color:#204a87;font-weight:bold">Joi.string</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">required</span><span style="color:#000;font-weight:bold">(),</span>
        <span style="color:#000">MONGO_PATH</span>: <span style="color:#204a87;font-weight:bold">Joi.string</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">required</span><span style="color:#000;font-weight:bold">(),</span>
      <span style="color:#000;font-weight:bold">}),</span>
    <span style="color:#000;font-weight:bold">}),</span>
    <span style="color:#000">MongooseModule</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">forRootAsync</span><span style="color:#000;font-weight:bold">({</span>
      <span style="color:#000">imports</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">ConfigModule</span><span style="color:#000;font-weight:bold">],</span>
      <span style="color:#000">useFactory</span>: <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">configService</span>: <span style="color:#204a87;font-weight:bold">ConfigService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">username</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">configService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;MONGO_USERNAME&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">password</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">configService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;MONGO_PASSWORD&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">database</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">configService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;MONGO_DATABASE&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">host</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">configService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;MONGO_HOST&#34;</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">uri</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">`mongodb://</span><span style="color:#4e9a06">${</span><span style="color:#000">username</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">:</span><span style="color:#4e9a06">${</span><span style="color:#000">password</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">@</span><span style="color:#4e9a06">${</span><span style="color:#000">host</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dbName</span>: <span style="color:#204a87;font-weight:bold">database</span> <span style="color:#000;font-weight:bold">};</span>
      <span style="color:#000;font-weight:bold">},</span>
      <span style="color:#000">inject</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">ConfigService</span><span style="color:#000;font-weight:bold">],</span>
    <span style="color:#000;font-weight:bold">}),</span>
    <span style="color:#000">PostsModule</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">],</span>
  <span style="color:#000">controllers</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[],</span>
  <span style="color:#000">providers</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[],</span>
<span style="color:#000;font-weight:bold">})</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">AppModule</span> <span style="color:#000;font-weight:bold">{}</span>
</code></pre></div><h2 id="保存和检索数据">保存和检索数据</h2>
<p>With MongoDB, we operate on documents grouped into collections.
To start saving and retrieving data with MongoDB and Mongoose, we first need to define a schema.
This might seem surprising at first because MongoDB is considered schemaless.
Even though MongoDB is flexible, Mongoose uses schemas to operate on collections and define their shape.</p>
<h2 id="定义一个模式">定义一个模式</h2>
<p>每个模式映射到一个 MongoDB 集合。
它还定义了其中文档的形状。</p>
<p>post.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PostDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Post</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">content</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">PostSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>使用<code>@Schema()</code>装饰器，我们可以将类标记为模式定义，并将其映射到 MongoDB 集合。
我们使用<code>@Prop()</code>装饰器来确定文档的属性。
多亏了 TypeScript 元数据，我们的属性的模式类型是自动推断出来的。</p>
<p>我们将在后续文章中展开定义模式的主题。</p>
<h2 id="使用模型">使用模型</h2>
<p>Mongoose 将我们的模式包装成模型。
我们可以使用它们来创建和读取文档。
为了让我们的服务使用模型，我们需要将其添加到我们的模块中。</p>
<p>posts.module.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Module</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">MongooseModule</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostsController</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./posts.controller&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostsService</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./posts.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostSchema</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Module</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">imports</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">MongooseModule</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">forFeature</span><span style="color:#000;font-weight:bold">([{</span> <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">Post.name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">schema</span>: <span style="color:#204a87;font-weight:bold">PostSchema</span> <span style="color:#000;font-weight:bold">}])],</span>
  <span style="color:#000">controllers</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">PostsController</span><span style="color:#000;font-weight:bold">],</span>
  <span style="color:#000">providers</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">],</span>
<span style="color:#000;font-weight:bold">})</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsModule</span> <span style="color:#000;font-weight:bold">{}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostsModule</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>我们还需要将模型注入到我们的服务中:</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>一旦我们这样做了，我们就可以开始与我们的收藏进行交互了。</p>
<h2 id="获取所有实体">获取所有实体</h2>
<p>我们能做的最基本的事情是获取所有文档的列表。
为此，我们需要<code>find()</code>方法:</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">findAll() {</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">find</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="获取单个实体">获取单个实体</h2>
<p>Every document we create is assigned with a string id.
If we want to fetch a single document, we can use the findById method:</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">NotFoundException</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">findOne</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">post</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findById</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">NotFoundException</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">post</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="创建实体">创建实体</h2>
<p>In the fourth part of this series, we’ve tackled data validation.
Let’s create a Data Transfer Object for our entity.</p>
<p>post.dto.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">IsString</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">IsNotEmpty</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostDto</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@IsString</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@IsNotEmpty</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@IsString</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@IsNotEmpty</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">content</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostDto</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>We can now use it when creating a new instance of our model and saving it.</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostDto</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./dto/post.dto&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#000">create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">postData</span>: <span style="color:#204a87;font-weight:bold">PostDto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">createdPost</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">postData</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">createdPost</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">save</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="更新实体">更新实体</h2>
<p>We might also need to update an entity we’ve already created.
To do that, we can use the findByIdAndUpdate method:</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">NotFoundException</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostDto</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./dto/post.dto&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">postData</span>: <span style="color:#204a87;font-weight:bold">PostDto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">post</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findByIdAndUpdate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">postData</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">setOptions</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">overwrite</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">new</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">NotFoundException</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">post</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Above, a few important things are happening.
Thanks to using the new: true parameter, the findByIdAndUpdate method returns an updated version of our entity.</p>
<p>By using overwrite: true, we indicate that we want to replace a whole document instead of performing a partial update.
This is what differentiates the PUT and PATCH HTTP methods.</p>
<p>If you want to know more, check out TypeScript Express tutorial #15.
Using PUT vs PATCH in MongoDB with Mongoose.</p>
<h2 id="删除实体">删除实体</h2>
<p>To delete an existing entity, we need to use the findByIdAndDelete method:</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">NotFoundException</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">postId</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findByIdAndDelete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">postId</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">NotFoundException</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="定义一个控制器">定义一个控制器</h2>
<p>一旦我们的服务启动并运行，我们就可以在控制器中使用它:</p>
<p>posts.controller.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Body</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Get</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Param</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Put</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostsService</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./posts.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">ParamsWithId</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../utils/paramsWithId&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostDto</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./dto/post.dto&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Controller</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;posts&#34;</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsController</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">postsService</span>: <span style="color:#204a87;font-weight:bold">PostsService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">@Get</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">getAllPosts() {</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findAll</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#204a87;font-weight:bold">@Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;:id&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">getPost</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Param</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span> <span style="color:#000;font-weight:bold">}</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">ParamsWithId</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findOne</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#204a87;font-weight:bold">@Post</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">createPost</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Body</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">post</span>: <span style="color:#204a87;font-weight:bold">PostDto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#204a87;font-weight:bold">@Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;:id&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">deletePost</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Param</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span> <span style="color:#000;font-weight:bold">}</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">ParamsWithId</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#204a87;font-weight:bold">@Put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;:id&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">updatePost</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Param</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span> <span style="color:#000;font-weight:bold">}</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">ParamsWithId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">@Body</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">post</span>: <span style="color:#204a87;font-weight:bold">PostDto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">post</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>上面的关键部分是我们已经定义了 ParamsWithId 类。
使用它，我们可以验证提供的字符串是否是一个有效的 MongoDB id:</p>
<p>paramsWithId.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">IsMongoId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">ParamsWithId</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@IsMongoId</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">ParamsWithId</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><h2 id="summary">Summary</h2>
<p>In this article, we’ve learned the very basics of how to use MongoDB with NestJS.
To do that, we’ve created a local MongoDB database using Docker Compose and connected it with NestJS and Mongoose.
To better grasp MongoDB, we’ve also compared it to SQL databases such as Postgres.
There are still a lot of things to cover when it comes to MongoDB, so stay tuned!</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-dcc33887b60b5620de8e60d4faae18bc">2 - 实现与MongoDB的关系</h1>
    
	<p>An essential thing about MongoDB is that it is non-relational. Therefore, it might not be the best fit if relationships are a big part of our database design. That being said, we definitely can mimic SQL-style relations by using references of embedding documents directly.</p>
<p>You can get all of the code from this article in this repository.</p>
<h2 id="定义初始模式">定义初始模式</h2>
<p>In this article, we base the code on many of the functionalities we’ve implemented in the previous parts of this series. If you want to know how we register and authenticate users, check out API with NestJS #3. Authenticating users with bcrypt, Passport, JWT, and cookies.</p>
<p>Let’s start by defining a schema for our users.</p>
<p>user.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Exclude</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Transform</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">UserDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">User</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">())</span>
  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#204a87;font-weight:bold">unique</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@Exclude</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">password</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">UserSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>A few significant things are happening above. We use unique: true above to make sure that all users have unique emails. It sets up unique indexes under the hood and deserves a separate article.</p>
<p>The @Exclude and @Transform decorators come from the class-transformer library. We cover serialization in more detail in API with NestJS #5. Serializing the response with interceptors. There is a significant catch here with MongoDB and Mongoose, though.</p>
<p>The Mongoose library that we use for connecting to MongoDB and fetching entities does not return instances of our User class. Therefore, the ClassSerializerInterceptor won’t work out of the box. Let’s change it a bit using the mixin pattern.</p>
<p>mongooseClassSerializer.interceptor.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ClassSerializerInterceptor</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PlainLiteralObject</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ClassTransformOptions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">plainToClass</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">MongooseClassSerializerInterceptor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">classToIntercept</span>: <span style="color:#204a87;font-weight:bold">Type</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">ClassSerializerInterceptor</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Interceptor</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">ClassSerializerInterceptor</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">changePlainObjectToClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">document</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">PlainLiteralObject</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">document</span> <span style="color:#204a87;font-weight:bold">instanceof</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">document</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#000;font-weight:bold">}</span>

      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">plainToClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">classToIntercept</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">document</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toJSON</span><span style="color:#000;font-weight:bold">());</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">prepareResponse</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span>: <span style="color:#204a87;font-weight:bold">PlainLiteralObject</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">PlainLiteralObject</span><span style="color:#000;font-weight:bold">[])</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">Array</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isArray</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">changePlainObjectToClass</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span>

      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">changePlainObjectToClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#000">serialize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span>: <span style="color:#204a87;font-weight:bold">PlainLiteralObject</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">PlainLiteralObject</span><span style="color:#000;font-weight:bold">[],</span> <span style="color:#000">options</span>: <span style="color:#204a87;font-weight:bold">ClassTransformOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">super</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serialize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">prepareResponse</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">};</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">MongooseClassSerializerInterceptor</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>I wrote the above code with the help of Jay McDoniel. The official NestJS discord is a great place to ask for tips.</p>
<p>Above, we change MongoDB documents into instances of the provided class. Let’s use it with our controller:</p>
<p>authentication.controller.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Body</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UseInterceptors</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AuthenticationService</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./authentication.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">RegisterDto</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./dto/register.dto&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../users/user.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">MongooseClassSerializerInterceptor</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../utils/mongooseClassSerializer.interceptor&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Controller</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;authentication&#34;</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">@UseInterceptors</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">MongooseClassSerializerInterceptor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">))</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">AuthenticationController</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">authenticationService</span>: <span style="color:#204a87;font-weight:bold">AuthenticationService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">@Post</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;register&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">register</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Body</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">registrationData</span>: <span style="color:#204a87;font-weight:bold">RegisterDto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">authenticationService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">register</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">registrationData</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Thanks to doing the above, we exclude the password when returning the data of the user.</p>
<h2 id="一对一">一对一</h2>
<p>With the one-to-one relationship, the document in the first collection has just one matching document in the second collection and vice versa. Let’s create a schema for the address:</p>
<p>address.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Transform</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">AddressDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Address</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Address</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">())</span>
  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">city</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">street</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">AddressSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Address</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>There is a big chance that just one user is assigned to a particular address in our application. Therefore, it is a good example of a one-to-one relationship. Because of that, we can take advantage of embedding documents, which is an approach very good performance-wise.</p>
<p>For it to work properly, we need to explicitly pass AddressSchema to the @Prop decorator:</p>
<p>user.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ObjectId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Exclude</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Transform</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Address</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">AddressSchema</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./address.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">UserDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">User</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">())</span>
  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">ObjectId</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#204a87;font-weight:bold">unique</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@Exclude</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">password</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">AddressSchema</span> <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Address</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000">address</span>: <span style="color:#204a87;font-weight:bold">Address</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">UserSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>We use @Type(() =&gt; Address) above to make sure that the class-transformer transforms the Address object too.</p>
<p>When we create the document for the user, MongoDB also creates the document for the address. It also gives it a distinct id.</p>
<p>In our one-to-one relationship example, the user has just one address. Also, one address belongs to only one user. Since that’s the case, it makes sense to embed the user straight into the user’s document. This way, MongoDB can return it fast. Let’s use MongoDB Compass to make sure that this is the case here.</p>
<h2 id="一对多">一对多</h2>
<p>We implement the one-to-many and many-to-one relationships when a document from the first collection can be linked to multiple documents from the second collection. Documents from the second collection can be linked to just one document from the first collection.</p>
<p>Great examples are posts and authors where the user can be an author of multiple posts. In our implementation, the post can only have one author, though.</p>
<p>post.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ObjectId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">mongoose</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../users/user.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Transform</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PostDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Post</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">())</span>
  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">ObjectId</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">content</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">mongoose</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ref</span>: <span style="color:#204a87;font-weight:bold">User.name</span> <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000">author</span>: <span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">PostSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>Thanks to defining the above reference, we can now assign the user to the author property in the post.</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostDto</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./dto/post.dto&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../users/user.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#000">create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">postData</span>: <span style="color:#204a87;font-weight:bold">PostDto</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">author</span>: <span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">createdPost</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">({</span>
      <span style="color:#000;font-weight:bold">...</span><span style="color:#000">postData</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">author</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000;font-weight:bold">});</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">createdPost</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">save</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><h3 id="使用-mongoose-填充数据">使用 Mongoose 填充数据</h3>
<p>Saving the posts like that results in storing the id of the author in the database.</p>
<p>A great thing about it is that we can easily replace the id with the actual data using the populate function Mongoose provides.</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">findAll() {</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">find</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;author&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>Doing the above results in Mongoose returning the data of the author along with the post.</p>
<h3 id="参考点的方向">参考点的方向</h3>
<p>In the code above, we store the id of the author in the document of the post.
We could do that the other way around and store the posts’ id in the author’s document.
When deciding that, we need to take a few factors into account.</p>
<p>First, we need to think of how many references we want to store.
Imagine a situation where we want to store logs for different machines in our server room. We need to remember that the maximum size of a MongoDB document is 16MB.
If we store an array of the ids of the Log document in the Machine document, in theory, we could run out of space at some point. We can store a single id of the machine in the Log document instead.</p>
<p>The other thing to think through is what queries we will run most often.
For example, in our implementation of posts and authors, it is effortless to retrieve the author’s data if we have the post.
This is thanks to the fact that we store the author’s id in the document of the post. On the other hand, it would be more time-consuming to retrieve a list of posts by a single user.
To do that, we would need to query all of the posts and check the author’s id.</p>
<p>We could implement two-way referencing and store the reference on both sides to deal with the above issue.
The above would speed up some of the queries but require us to put more effort into keeping our data consistent.</p>
<h3 id="嵌入">嵌入</h3>
<p>We could also embed the document of the posts into the document of the user. The advantage of doing that would be not performing additional queries to the database to get the missing information. But, unfortunately, this would make getting a particular post more difficult.</p>
<h2 id="多对多">多对多</h2>
<p>Another important relationship to consider is many-to-many. A document from the first collection can refer to multiple documents from the second collection and the other way around.</p>
<p>A good example would be posts that can belong to multiple categories. Also, a single category can belong to multiple posts. First, let’s define the schema of our category.</p>
<p>category.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ObjectId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Transform</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">CategoryDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Category</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Category</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">())</span>
  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">ObjectId</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">CategorySchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Category</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>Now we can use it in the schema of the user.</p>
<p>user.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ObjectId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">mongoose</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../users/user.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Transform</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Category</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../categories/category.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PostDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Post</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">())</span>
  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">ObjectId</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">content</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">mongoose</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ref</span>: <span style="color:#204a87;font-weight:bold">User.name</span> <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000">author</span>: <span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span>
    <span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[{</span> <span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">mongoose</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ref</span>: <span style="color:#204a87;font-weight:bold">Category.name</span> <span style="color:#000;font-weight:bold">}],</span>
  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Category</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000">categories</span>: <span style="color:#204a87;font-weight:bold">Category</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">PostSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>A thing worth knowing is that we can also use the populate method right after saving our document.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostDto</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./dto/post.dto&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../users/user.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">postData</span>: <span style="color:#204a87;font-weight:bold">PostDto</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">author</span>: <span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">createdPost</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">({</span>
      <span style="color:#000;font-weight:bold">...</span><span style="color:#000">postData</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">author</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000;font-weight:bold">});</span>
    <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">createdPost</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;categories&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">execPopulate</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">createdPost</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">save</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>上面的一件重要的事情是，我们在 MongoDB 文档的一个实例上调用 populate 方法。
由于是这种情况，我们还需要调用 execPopulate 来运行它。
在我们的其余示例中，我们在 MongoDB 查询的一个实例上调用 populate，这是不需要的。</p>
<h2 id="总结">总结</h2>
<p>在本文中，我们介绍了使用 NestJS 在 MongoDB 中定义文档之间的关系。
我们已经学习了各种类型的关系，并考虑了如何存储引用以提高性能。
我们还讨论了如何用 NestJS 和 MongoDB 实现序列化。
还有很多东西要学，所以请继续关注!</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4451ab685262406c61d37462ff2cf30c">3 - MongoDB和Mongoose的虚拟属性</h1>
    
	<p>在本系列中，我们使用 Mongoose 在模式中定义属性，并使用文档的模型。
我们还定义了集合之间的各种关系。
使用 Mongoose，我们还可以利用没有存储在 MongoDB 中的虚拟属性。
要理解它们，我们首先要掌握 <code>getter</code> 和 <code>setter</code> 的概念。</p>
<p>您可以在这个存储库中找到本文中的代码。</p>
<h2 id="mongoose-的-getters-和-setters">Mongoose 的 Getters 和 setters</h2>
<p>当使用 <code>getter</code> 和 <code>setter</code> 在文档中获取和设置属性时，可以执行自定义逻辑。</p>
<h3 id="getters">Getters</h3>
<p>通过使用 <code>getter</code> ，我们可以在检索文档数据时修改文档数据。
让我们创建一个示例，当用户有一个信用卡号码时，我们希望在响应 API 请求时对其进行混淆。</p>
<p>user.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">UserDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">User</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">toJSON</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">getters</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">})</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#204a87;font-weight:bold">unique</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span>
    <span style="color:#204a87;font-weight:bold">get</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">creditCardNumber</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">creditCardNumber</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">lastFourDigits</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">creditCardNumber</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">slice</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">creditCardNumber</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">`****-****-****-</span><span style="color:#4e9a06">${</span><span style="color:#000">lastFourDigits</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000">creditCardNumber?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">UserSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>当我们从 API 返回文档时，NestJS 将我们的数据字符串化。
当这种情况发生时， <code>toJSON</code> 方法就会在我们的 Mongoose 模型上被调用。
因此，如果我们想要考虑我们的 <code>getter</code> ，我们需要在配置中显式地添加 <code>getter:true</code>。</p>
<p>文档也有 tobject 方法，我们可以用类似的方式自定义它。</p>
<p>我们也在 mongoosecasserializerinterceptor 中使用 toJSON。
要了解更多细节，请查看 NestJS #44 中的 API。
实现与 MongoDB 的关系</p>
<p>在上面的代码中，每次从 API 返回用户文档时，都会混淆信用卡号。</p>
<p>Mongoose 为我们的模式分配一个 id 字段的虚 <code>getter</code> 。
它现在出现在响应中，因为我们通过 <code>getters:true</code> 打开了 getters。
稍后会有更多关于虚拟的内容。</p>
<p>有时，我们希望访问原始的、未修改的属性。
为此，我们可以使用 <code>Document.prototype.get()</code> 函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">usersService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getByEmail</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">email</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">creditCardNumber</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">usersService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getByEmail</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">email</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><h3 id="setters">Setters</h3>
<p>使用 <code>setter</code> ，我们可以在将数据保存到数据库之前修改数据。</p>
<p>post.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ObjectId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Transform</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PostDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Post</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">())</span>
  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">ObjectId</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span>
    <span style="color:#204a87;font-weight:bold">set</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">content</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">content</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">trim</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000">content</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">PostSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>由于做了上述操作，我们现在从内容字符串的两端删除空白。</p>
<p>虽然<code>setter</code>是一种有效的技术，但是为了提高可读性，您可能更愿意将此逻辑放在服务中。
然而，即使是这样，<code>setter</code>也是值得了解的。</p>
<h2 id="虚拟属性">虚拟属性</h2>
<p><code>virtual</code> 是我们可以获取和设置的属性，但它不存储在数据库中。
让我们定义一个简单的用例示例。</p>
<p>user.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">UserDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">User</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">firstName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">lastName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">fullName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">UserSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>不幸的是，上述方法是有缺陷的。
如果我们将 <code>fullName</code> 属性持久化到 MongoDB 中，我们将复制信息，因为我们已经有了 firstName 和 lastName。
更合适的方法是基于其他属性动态创建 <code>fullName</code> 。</p>
<h3 id="getters-1">Getters</h3>
<p>我们可以通过虚拟财产实现上述目的。
让我们创建它和 <code>getter</code> 。</p>
<p>user.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">UserDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">User</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">toJSON</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">virtuals</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">})</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">firstName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">lastName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#000">fullName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">UserSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">UserSchema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">virtual</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;fullName&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">UserDocument</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">`</span><span style="color:#4e9a06">${</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">firstName</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> </span><span style="color:#4e9a06">${</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lastName</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">UserSchema</span> <span style="color:#000;font-weight:bold">};</span>
</code></pre></div><p>请注意，我们没有在<code>fullName</code>属性上使用<code>@Prop()</code>装饰器。
相反，我们调用文件底部的<code>UserSchema.virtual</code>函数。</p>
<p>由于添加了<code>virtuals:true</code>，我们的虚拟属性在将文档转换为 <code>JSON</code> 时是可见的。
尽管我们可以在上面的响应中看到 <code>fullName</code> ，但它并没有保存到数据库中。</p>
<h3 id="setters-1">Setters</h3>
<p>使用 <code>virtual</code> ，我们还可以创建 <code>setter</code> 。
例如，我们可以使用它们一次设置多个属性。</p>
<p>user.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ObjectId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Transform</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">UserDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">User</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">toJSON</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">getters</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">virtuals</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">})</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">firstName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">lastName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#000">fullName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">UserSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">UserSchema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">virtual</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;fullName&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">UserDocument</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">`</span><span style="color:#4e9a06">${</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">firstName</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> </span><span style="color:#4e9a06">${</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lastName</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">UserDocument</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fullName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">firstName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lastName</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fullName</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">split</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34; &#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">firstName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lastName</span> <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">UserSchema</span> <span style="color:#000;font-weight:bold">};</span>
</code></pre></div><p>上面，我们基于 <code>fullName</code> 设置了 <code>firstName</code> 和 <code>lastName</code> 属性。</p>
<h2 id="填充虚拟属性">填充虚拟属性</h2>
<p>虚拟属性的一个便利特性是使用它们来填充来自另一个集合的文档。</p>
<p>我们学习了使用 NestJS 在 API 中填充特性的基础知识 <a href="">#44.使用 MongoDB 实现关系</a></p>
<p>在上一篇文章的示例中，我们为一篇文章创建了一个模式，使用它来存储对作者的引用。</p>
<p>post.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ObjectId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">mongoose</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../users/user.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Transform</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PostDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Post</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">())</span>
  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">ObjectId</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">content</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">mongoose</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ref</span>: <span style="color:#204a87;font-weight:bold">User.name</span> <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000">author</span>: <span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">PostSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>因此，当我们获取 <code>User</code> 文档时，我们没有任何帖子的信息。
我们可以使用虚拟属性来解决这个问题。</p>
<p>user.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../posts/post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">UserDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">User</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">toJSON</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">getters</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">virtuals</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">})</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#204a87;font-weight:bold">unique</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000">posts</span>: <span style="color:#204a87;font-weight:bold">Post</span><span style="color:#000;font-weight:bold">[];</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">UserSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">UserSchema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">virtual</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;posts&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ref</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">localField</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;_id&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">foreignField</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;author&#34;</span> <span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">UserSchema</span> <span style="color:#000;font-weight:bold">};</span>
</code></pre></div><p>最后一步是调用 <code>populate</code> 函数以及用户的文档。
同时，我们还可以填充嵌套的 <code>categories</code> 属性。</p>
<p>users.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NotFoundException</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">UserDocument</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./user.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UsersService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">userModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">UserDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">getById</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">userModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findById</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;posts&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">populate</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;categories&#34;</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">});</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">NotFoundException</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="总结">总结</h2>
<p>在本文中，我们学习了什么是虚拟属性以及它们如何有用。
我们已经使用它们来添加简单的属性和填充来自其他集合的文档。
为了更好地掌握 <code>virtual</code> 的概念，我们还研究了 <code>getter</code> 和 <code>setter</code> 。
当使用 <code>Mongoose</code> 来定义 <code>MongoDB</code> 模式时，上述所有内容肯定会派上用场。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d6a0d2e2730441d8a1bbcc80b1877247">4 - 与MongoDB和Mongoose管理事务</h1>
    
	<p>在使用数据库时，保持数据的完整性至关重要。
例如，想象一下把钱从一个银行账户转到另一个。
为此，我们需要执行两个独立的操作。
首先，我们从第一个银行账户中提取金额。
然后，我们将相同的金额添加到第二个帐户。</p>
<p>如果由于某种原因第二次操作失败，而第一次操作成功，则会导致数据库的状态无效。
我们需要上述所有操作的成功或失败。
我们可以通过事务来实现这一点。</p>
<h2 id="acid-properties">ACID properties</h2>
<p>A transaction to be valid needs to have the following properties.
Together, they form the ACID acronym:</p>
<h2 id="atomicity">Atomicity</h2>
<p>Operations in the transaction are a single unit.
Therefore, it either fully succeeds or fails together.</p>
<h2 id="consistency">Consistency</h2>
<p>The transaction moves the database from one valid state to the next.</p>
<h2 id="isolation">Isolation</h2>
<p>The isolation property ensures that multiple transactions can occur concurrently, resulting in a valid database state.
To better understand that, let’s continue the example with the banking transaction from above.
Another transaction should see the funds in one account or the other, but not in both.</p>
<h2 id="durability">Durability</h2>
<p>Once the changes from a transaction are committed, they should survive permanently.</p>
<h2 id="transactions-in-mongodb-and-mongoose">Transactions in MongoDB and Mongoose</h2>
<p>Fortunately, MongoDB is equipped with support for multi-document transactions since version 4.0.
We can tell the database that we do a transaction, and it keeps track of every update we make.
If something fails, then the database rolls back all our updates.
The above requires the database to do extra work making notes of our updates and locking the involved resources.
Other clients trying to perform operations on the data might be stuck waiting for the transaction to complete.
Therefore, this is something to watch out for.</p>
<h2 id="running-a-replica-set">Running a replica set</h2>
<p>Transactions with MongoDB only work with a replica set, a group of MongoDB processes that maintain the same data set.
In this series, we’ve been using docker-compose to run MongoDB for us.
We can either run a replica set locally with docker or use MongoDB atlas.
For this article, I’m doing the latter.</p>
<p>If you want to run a replica set, check out this page on Stackoverflow.</p>
<h2 id="deleting-a-user">Deleting a user</h2>
<p>Let’s implement a feature of deleting a user.
When we remove users from the database, we also want to delete all posts they wrote.</p>
<p>users.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NotFoundException</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">UserDocument</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./user.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostsService</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../posts/posts.service&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UsersService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span>
    <span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">userModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">UserDocument</span><span style="color:#000;font-weight:bold">&gt;,</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">postsService</span>: <span style="color:#204a87;font-weight:bold">PostsService</span>
  <span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">userModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findByIdAndDelete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;posts&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">NotFoundException</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">posts</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">posts</span><span style="color:#000;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deleteMany</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">posts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">_id</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">()));</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">UsersService</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>To do the above, we also need to define the deleteMany in our PostsService.</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">deleteMany</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ids</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">[])</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deleteMany</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">ids</span> <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>The shortcoming of the above code is that the delete method might succeed partially.
When this happens, we delete the user, but the posts are left in the database without the author.
We can deal with the above issue by defining a transaction.</p>
<p>To start a transaction, we need to access the connection we’ve established with MongoDB.
To do that, we can use the @InjectConnection decorator:</p>
<p>users.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">UserDocument</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./user.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostsService</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../posts/posts.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectConnection</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">mongoose</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UsersService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span>
    <span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">userModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">UserDocument</span><span style="color:#000;font-weight:bold">&gt;,</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">postsService</span>: <span style="color:#204a87;font-weight:bold">PostsService</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">@InjectConnection</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">connection</span>: <span style="color:#204a87;font-weight:bold">mongoose.Connection</span>
  <span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">UsersService</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><h2 id="控制事务">控制事务</h2>
<p>There are two ways of working with transactions with Mongoose.
To have full control over it, we can call the startTransaction method:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">session</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">connection</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startSession</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startTransaction</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div><p>When we indicate that everything worked fine, we need to call session.commitTransaction().
This writes our changes to the database.</p>
<p>If we encounter an error, we need to call session.abortTransaction() to indicate that we want to discard the operations we’ve performed so far.
Once we’re done with the transaction, we need to call the session.endSession() method.</p>
<p>To indicate that we want to perform an operation within a given session, we need to use the session() method.</p>
<p>users.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UsersService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">session</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">connection</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startSession</span><span style="color:#000;font-weight:bold">();</span>

    <span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startTransaction</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">userModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findByIdAndDelete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;posts&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">);</span>

      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">NotFoundException</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">posts</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">posts</span><span style="color:#000;font-weight:bold">;</span>

      <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deleteMany</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">posts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">_id</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">()));</span>
      <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">commitTransaction</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">abortTransaction</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#000">error</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">finally</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">endSession</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Still, there is an important issue with the above code.
Although we’ve deleted the user within a transaction, we didn’t do that when removing posts.
To delete posts within a session, we need to modify the postsService.deleteMany function:</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">mongoose</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">deleteMany</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ids</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">[],</span> <span style="color:#000">session</span>: <span style="color:#204a87;font-weight:bold">mongoose.ClientSession</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">null</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deleteMany</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">ids</span> <span style="color:#000;font-weight:bold">}).</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>By adding the optional session argument to the deleteMany method, we can delete posts within a transaction.
Let’s use it:</p>
<p>users.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UsersService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">session</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">connection</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startSession</span><span style="color:#000;font-weight:bold">();</span>

    <span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startTransaction</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">userModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findByIdAndDelete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;posts&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">);</span>

      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">NotFoundException</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">posts</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">posts</span><span style="color:#000;font-weight:bold">;</span>

      <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deleteMany</span><span style="color:#000;font-weight:bold">(</span>
        <span style="color:#000">posts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">_id</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">()),</span>
        <span style="color:#000">session</span>
      <span style="color:#000;font-weight:bold">);</span>
      <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">commitTransaction</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">abortTransaction</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#000">error</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">finally</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">endSession</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>If removing the posts fail for some reason, the user is not deleted from the database either.
Thanks to that, the whole operation either succeeds as a whole or fails completely.</p>
<p>A simpler way of using transactions
Instead of controlling every step of the transaction manually, we can use the session.withTransaction() helper.</p>
<p>users.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">session</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">connection</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startSession</span><span style="color:#000;font-weight:bold">();</span>

<span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">withTransaction</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">userModel</span>
<span style="color:#000;font-weight:bold">.</span><span style="color:#000">findByIdAndDelete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userId</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;posts&#39;</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">.</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">);</span>

    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">NotFoundException</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">posts</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">posts</span><span style="color:#000;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deleteMany</span><span style="color:#000;font-weight:bold">(</span>
      <span style="color:#000">posts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">_id</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">()),</span>
      <span style="color:#000">session</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000;font-weight:bold">);</span>

<span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">endSession</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Please notice that we no longer need to call startTransaction(), commitTransaction(), and abortTransaction().
We still are required to end the session with the endSession method, though.</p>
<h2 id="summary">Summary</h2>
<p>In this article, we’ve gone through transactions in MongoDB by describing their principles and use-cases.
We’ve also implemented them into our application with Mongoose.
It is definitely worth it to understand transactions because they can increase the reliability of our application quite a lot.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9dafda6a3ad4a457c936f5058f3f4460">5 - 使用MongoDB和Mongoose实现分页</h1>
    
	<p>当我们的应用程序增长时，数据库也会增长。
在某些情况下，我们可能会从端点返回大量数据。
例如，对于我们的前端应用程序来说，这可能会被证明是太多了。
因此，我们可能需要通过返回记录的一部分来对记录进行分页。
本文探讨了使用 MongoDB 和 Mongoose 实现这一目标的不同方法，并考虑了它们的优缺点。</p>
<p>您可以在这个存储库中找到本文中的代码。</p>
<h2 id="使用-skip-和-limit">使用 skip 和 limit</h2>
<p>最直接的分页形式是期望用户提供他们想要跳过的文档数量。
此外，他们还可以声明希望接收多少文件。</p>
<p>为了成功实现分页，我们需要一个可预测的文档顺序。
为了实现这一点，我们必须对它们进行排序:</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">findAll() {</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">find</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">sort</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">}).</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;author&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;categories&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>通过执行<code>sort({ _id: 1 })</code>，我们按升序排序。</p>
<p>上面，我们在 MongoDB 中使用了 id 的一个重要特性。
MongoDB 中的 id 由 12 个字节组成，其中 4 个字节是时间戳。
在这样做的同时，我们需要意识到一些缺点:</p>
<p>时间戳的值以秒为单位，在同一秒内创建的文档没有保证有效的顺序，
id 由可能具有不同系统时钟的客户端生成。
根据<code>_id</code>进行排序有一个显著的优势，因为 MongoDB 在<code>_id</code>字段上创建了一个唯一的索引。
这增加了按<code>_id</code>对文档进行排序的性能。</p>
<h3 id="实现分页">实现分页</h3>
<p>实现上述方法的第一步是允许用户通过查询参数提供偏移量和限制。
为此，让我们使用类验证器和类转换器。</p>
<p>paginationParams.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">IsNumber</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Min</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">IsOptional</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PaginationParams</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#204a87">Number</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">@IsNumber</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@Min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000">skip?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#204a87">Number</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">@IsNumber</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@Min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000">limit?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>如果您想了解更多关于类验证器和类转换器的信息，请参阅错误处理和数据验证以及使用拦截器序列化响应。</p>
<p>我们现在可以在控制器中使用上述参数:</p>
<p>posts.controller.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Get</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Query</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UseInterceptors</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostsService</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./posts.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">MongooseClassSerializerInterceptor</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../utils/mongooseClassSerializer.interceptor&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">PostModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">PaginationParams</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../utils/paginationParams&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Controller</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;posts&#34;</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">@UseInterceptors</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">MongooseClassSerializerInterceptor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PostModel</span><span style="color:#000;font-weight:bold">))</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsController</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">postsService</span>: <span style="color:#204a87;font-weight:bold">PostsService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">@Get</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">getAllPosts</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Query</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">skip</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">limit</span> <span style="color:#000;font-weight:bold">}</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">PaginationParams</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skip</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">limit</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>现在我们可以在 findAll 方法中使用上述参数。</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">findAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">documentsToSkip</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">limitOfDocuments?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">query</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">find</span><span style="color:#000;font-weight:bold">()</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">sort</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">})</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">skip</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">documentsToSkip</span><span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;author&#34;</span><span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;categories&#34;</span><span style="color:#000;font-weight:bold">);</span>

    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">limitOfDocuments</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">query</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">limit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">limitOfDocuments</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">query</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>通过这样做，用户现在可以指定他们想要获取多少篇文章以及要跳过多少篇文章。
例如，请求<code>/posts?skip=20&amp;limit=10</code>在省略前 20 个文档的同时产生 10 个帖子。</p>
<h3 id="计算文件">计算文件</h3>
<p>一种常见的方法是显示我们有多少页面的文章。
为此，我们需要计算数据库中有多少个文档。
为此，我们需要使用聚合框架或执行两个单独的查询。</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">findAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">documentsToSkip</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">limitOfDocuments?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">findQuery</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">find</span><span style="color:#000;font-weight:bold">()</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">sort</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">})</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">skip</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">documentsToSkip</span><span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;author&#34;</span><span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;categories&#34;</span><span style="color:#000;font-weight:bold">);</span>

    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">limitOfDocuments</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">findQuery</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">limit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">limitOfDocuments</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">results</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">findQuery</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">count</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">count</span><span style="color:#000;font-weight:bold">();</span>

    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">results</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">count</span> <span style="color:#000;font-weight:bold">};</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>现在，在我们的响应中，我们得到了结果和文档的总数。</p>
<h3 id="缺点">缺点</h3>
<p>使用限制和偏移量的解决方案在 SQL 数据库和 MongoDB 中都被广泛使用。
不幸的是，它的性能还有改进的空间。
使用 <code>skip()</code> 方法仍然需要数据库从收集的开始进行扫描。
首先，数据库根据 id 对所有文档进行排序。
然后，MongoDB 丢弃指定数量的文档。
对于大的集合来说，这可能是相当多的工作。</p>
<p>除了性能问题，我们还需要考虑一致性。
理想情况下，文档应该只出现在结果中一次。
事实可能并非如此:</p>
<p>第一个用户获取带有文章的第 1 页，
在这之后，第二个用户创建了一个新的帖子——在排序之后，它结束在第 1 页，
第一个用户获取第二个页面。
用户在第二个页面上再次看到第一个页面的最后一个元素。
不幸的是，用户还错过了添加到第一个页面的元素，这更糟糕。</p>
<h3 id="优势">优势</h3>
<p>带有限制和偏移量的方法是常见的，并且易于实现。
它的最大优点是可以直接跳过多个页面的文档。
此外，更改用于排序的列也很简单，包括按多个列排序。
因此，如果期望偏移量不太大，且不一致是可以接受的，那么它是一个可行的解决方案。</p>
<h2 id="键集分页">键集分页</h2>
<p>如果我们非常关心性能，我们可能希望寻找上述方法的替代方法。
其中之一是键集分页。
在这里，我们使用了 MongoDB 中的 id 由时间戳组成的事实，可以进行比较:</p>
<p>我们从 API 中获取一页文档，
我们检查最后一个文档的 id，
然后，请求 id 大于上一个文档 id 的文档。
由于采用了上述方法，数据库不再需要处理不必要的文档。
首先，让我们为用户创建一种方式来提供起始 id。</p>
<p>paginationParams.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">IsNumber</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">IsMongoId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Min</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">IsOptional</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PaginationParams</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@IsMongoId</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">startId?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#204a87">Number</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">@IsNumber</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@Min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000">skip?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#204a87">Number</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">@IsNumber</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@Min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000">limit?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>现在，我们需要在服务中使用 <code>startId</code> 属性。</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">findAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">documentsToSkip</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">limitOfDocuments?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">startId?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">findQuery</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">find</span><span style="color:#000;font-weight:bold">({</span><span style="color:#000">_id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">$gt</span>: <span style="color:#204a87;font-weight:bold">startId</span><span style="color:#000;font-weight:bold">}}).</span><span style="color:#000">sort</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">}).</span><span style="color:#000">skip</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">documentsToSkip</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;author&#39;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;categories&#39;</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">limitOfDocuments</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">findQuery</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">limit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">limitOfDocuments</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">results</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">findQuery</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">count</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">count</span><span style="color:#000;font-weight:bold">();</span>

  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">results</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">count</span> <span style="color:#000;font-weight:bold">};</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>由于执行了<code>$gt: startId</code>，用户只接收到使用提供的 id 的帖子之后创建的帖子。</p>
<h3 id="缺点-1">缺点</h3>
<p>键集分页的一个很大的缺点是需要知道我们想要开始的确切文档。
我们可以通过将其与基于偏移量的分页相结合来克服这个问题。
这种方法的另一个问题是，用户很难一次跳过多个数据页面。</p>
<h3 id="优点">优点</h3>
<p>与基于偏移量的方法相比，键集分页最显著的优点是性能提高。
此外，它还有助于解决用户在获取页面之间添加或删除元素时不一致的问题。</p>
<h2 id="总结">总结</h2>
<p>在本文中，我们比较了 MongoDB 和 Mongoose 两种类型的分页。
我们已经考虑了键集分页和基于偏移量的方法的优缺点。
它们都不是完美的，但将它们结合起来可以涵盖很多不同的情况。
为特定的工作选择合适的工具是至关重要的。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9fc52bf385551b755df4c394152ea50c">6 - 使用MongoDB和Mongoose定义索引</h1>
    
	<p>The bigger our database is, the more demanding our queries become in terms of computing power.
A common way of tackling this problem is by creating indexes.
In this article, we explore this concept and create indexes with MongoDB and Mongoose.</p>
<p>When performing a MongoDB query, the database must scan every document in a given collection to find matching documents.
MongoDB can limit the number of records to inspect if we have an appropriate index in our database.
Since it makes it easier to search for the documents in the database, indexes can speed up finding, updating, and deleting.</p>
<p>Under the hood, indexes are data structures that store a small part of the collection’s data in an easy-to-traverse way.
It includes the ordered values of a particular field of the documents.
It makes MongoDB indexes similar to indexes in databases such as PostgreSQL.</p>
<p>When we define indexes, MongoDB needs to store additional data to speed up our queries.
But, unfortunately, it slows down our write queries.
It also takes up more memory.
Therefore, we need to create indexes sparingly.</p>
<h2 id="唯一索引">唯一索引</h2>
<p>The unique index makes sure that we don’t store duplicate values.
We can create it by passing unique: true to the @Prop decorator.</p>
<p>user.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ObjectId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Transform</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">UserDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">User</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">toJSON</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">getters</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">virtuals</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">})</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">())</span>
  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">ObjectId</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#204a87;font-weight:bold">unique</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">UserSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>It is important to know that MongoDB creates a unique index on the _id field when creating a collection.
Therefore, we sometimes refer to it as the primary index.
We take advantage of the above in the last part of this series, where we implement pagination and sort documents by the _id field.</p>
<p>When we sort documents using a field without an index, MongoDB performs sorting at query time.
It takes time and resources to do that and makes our app response slower.
However, having the right index can help us avoid sorting results at query time because the results are already sorted in the index.
Therefore, we can return them immediately.</p>
<p>We need to keep in mind that making a property unique creates an index and slows down our write queries.</p>
<h2 id="使用-mongoose-实现索引">使用 Mongoose 实现索引</h2>
<p>With MongoDB, we can also define secondary indexes that don’t make properties unique.</p>
<p>post.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ObjectId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Transform</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PostDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Post</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">())</span>
  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">ObjectId</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">index</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">PostSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>By doing the above, we speed up queries, such as when we look for a post with a specific title, for example.
We also speed up queries where we sort posts by the title alphabetically.</p>
<h2 id="文本索引">文本索引</h2>
<p>MongoDB 还实现了文本索引，支持对字符串内容的搜索查询。
要定义文本索引，需要使用<code>index()</code>方法。</p>
<p>post.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ObjectId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Transform</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PostDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Post</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Post</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">())</span>
  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">ObjectId</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">PostSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">PostSchema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">title</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;text&#34;</span> <span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">PostSchema</span> <span style="color:#000;font-weight:bold">};</span>
</code></pre></div><p>设置文本索引时，可以利用 <code>$text</code> 操作符。
它对用文本索引索引的字段的内容执行文本搜索。</p>
<p>一个集合不能有一个以上的文本索引。</p>
<p>让我们通过添加一个新的查询参数来实现搜索帖子的功能。</p>
<p>post.controller.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Get</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Query</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UseInterceptors</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostsService</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./posts.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">MongooseClassSerializerInterceptor</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../utils/mongooseClassSerializer.interceptor&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">PostModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">PaginationParams</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../utils/paginationParams&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Controller</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;posts&#34;</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">@UseInterceptors</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">MongooseClassSerializerInterceptor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PostModel</span><span style="color:#000;font-weight:bold">))</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsController</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">postsService</span>: <span style="color:#204a87;font-weight:bold">PostsService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">@Get</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">getAllPosts</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Query</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">skip</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">limit</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">startId</span> <span style="color:#000;font-weight:bold">}</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">PaginationParams</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">@Query</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;searchQuery&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">searchQuery</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skip</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">limit</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">startId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">searchQuery</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">//...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>我们还需要将 <code>$text</code> 查询添加到服务中。</p>
<p>post.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">FilterQuery</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">findAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">documentsToSkip</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">limitOfDocuments?</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">startId?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">searchQuery?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">filters</span>: <span style="color:#204a87;font-weight:bold">FilterQuery</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">startId</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">_id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$gt</span>: <span style="color:#204a87;font-weight:bold">startId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{};</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">searchQuery</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">filters</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">$text</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$search</span>: <span style="color:#204a87;font-weight:bold">searchQuery</span> <span style="color:#000;font-weight:bold">};</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">findQuery</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">find</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filters</span><span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">sort</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">})</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">skip</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">documentsToSkip</span><span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;author&#34;</span><span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;categories&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">limitOfDocuments</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">findQuery</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">limit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">limitOfDocuments</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">results</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">findQuery</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">count</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">count</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">results</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">count</span> <span style="color:#000;font-weight:bold">};</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>感谢以上，MongoDB 可以搜索我们的文章标题。</p>
<p><code>$text</code>查询有更多的参数，比如 <code>$caseSensitive</code> 布尔值。
更多信息，请查看官方文档。</p>
<h2 id="复合索引">复合索引</h2>
<p>The $text query searches through all of the fields indexed with the text index.
With MongoDB, we can create compound indexes where the index structure holds references to multiple fields.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#000">PostSchema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">title</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;text&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">content</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;text&#34;</span> <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>Thanks to doing the above, the $text query will search both through the titles and contents of posts.</p>
<p>Besides the text indexes, we can also create regular compound indexes.</p>
<p>user.schema.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Prop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SchemaFactory</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ObjectId</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Transform</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">UserDocument</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">User</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">Document</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Schema</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">toJSON</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">getters</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">virtuals</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">})</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@Transform</span><span style="color:#000;font-weight:bold">(({</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">())</span>
  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">ObjectId</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">firstName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Prop</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">lastName</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">UserSchema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SchemaFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createForClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">UserSchema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">firstName</span>: <span style="color:#204a87;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lastName</span>: <span style="color:#204a87;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">UserSchema</span> <span style="color:#000;font-weight:bold">};</span>
</code></pre></div><p>Doing the above creates a compound index on the firstName and lastName fields.
It can speed queries such as the ones where we look for a user with a specific first name and last name.</p>
<p>By using 1, we create an ascending index.
When we use -1, we create a descending index.
The direction doesn’t matter for single key indexes because MongoDB can traverse the index in either direction.
It can be significant for compound indexes, though.
The official documentation and this Stackoverflow page provide a good explanation.</p>
<p><code>@Prop({ index: true })</code> 装饰器创建了一个升序索引。</p>
<h2 id="总结">总结</h2>
<p>在本文中，我们讨论了 MongoDB 中的索引问题。
我们已经解释了不同类型的索引，例如惟一索引、单字段索引和复合索引。
我们还学习了文本索引并使用它们实现了搜索功能。
我们还了解到，创造优势可以加快某些查询的速度，同时降低其他查询的速度。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-87745293d49493ba2db7754c111a3568">7 - 用PUT和PATCH更新MongoDB和Mongoose</h1>
    
	<p>When we develop a REST API, there is a set of HTTP methods that we can choose from, such as GET, POST, and DELETE. A crucial thing to understand is that HTTP methods are largely conventional. It is our job to make them work in a way that’s consistent with the specification. For example, in theory, we could delete entities with the GET method. However, we should make our API predictable to make it easy to understand both to developers working on our backend and the users.</p>
<p>A lot of HTTP methods are very straightforward. However, the PUT and PATCH methods are worth digging into a bit more. In this article, we compare both of them and implement them with NestJS and Mongoose.</p>
<p>PUT
The PUT method is responsible for modifying an existing entity. The crucial part about it is that it is supposed to replace an entity. Therefore, if we don’t send a field of an entity when performing a PUT request, the missing field should be removed from the document.</p>
<p>GET /posts/613e2dcbe2b947c10b669292</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">&#34;categories&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[],</span>
  <span style="color:#204a87;font-weight:bold">&#34;_id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;614fa87e4027d3141f28e9e7&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#204a87;font-weight:bold">&#34;title&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;API with NestJS #49. PUT vs PATCH with MongoDB and Mongoose&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#204a87;font-weight:bold">&#34;content&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;...&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#204a87;font-weight:bold">&#34;series&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">&#34;_id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;614fa8364027d3141f28e9e2&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;API with NestJS&#34;</span>
  <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#204a87;font-weight:bold">&#34;author&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">&#34;_id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;61350362017a80b8d443b012&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;email&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;marcin@wanago.io&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;firstName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Marcin&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;lastName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Wanago&#34;</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Above, we can see the properties our post contains. Let’s make a PUT request now.</p>
<p>PUT /posts/614fa87e4027d3141f28e9e7</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">&#34;_id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;614fa87e4027d3141f28e9e7&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#204a87;font-weight:bold">&#34;categories&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[],</span>
  <span style="color:#204a87;font-weight:bold">&#34;title&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;API with NestJS #49. PUT vs PATCH with MongoDB and Mongoose&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#204a87;font-weight:bold">&#34;content&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;...&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#204a87;font-weight:bold">&#34;author&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">&#34;_id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;61350362017a80b8d443b012&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;email&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;marcin@wanago.io&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;firstName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Marcin&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;lastName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Wanago&#34;</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>The crucial thing above is that we didn’t send the series property in the body of our request. Because the PUT method is supposed to replace a whole entity, we’ve deleted the series property.</p>
<p>Implementing the PUT method with MongoDB and Mongoose
There are quite a few ways of implementing a proper PUT method with MongoDB and Mongoose. The findByIdAndUpdate and findOneAndUpdate methods are common, but they don’t replace the whole document by default. Instead, they perform a partial update on it. Because of that, not including a property in the body of the request does not remove it. We can fix that with the overwrite: true option.</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">NotFoundException</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostDto</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./dto/post.dto&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">postData</span>: <span style="color:#204a87;font-weight:bold">PostDto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">post</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">findByIdAndUpdate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">postData</span><span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">setOptions</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">overwrite</span>: <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">new</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;author&#34;</span><span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;categories&#34;</span><span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;series&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">NotFoundException</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">post</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>By setting new: true, we indicate that we want the findByIdAndUpdate method to return the modified version of the document.</p>
<p>posts.controller.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Body</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Param</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Put</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UseInterceptors</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostsService</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./posts.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">ParamsWithId</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../utils/paramsWithId&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">MongooseClassSerializerInterceptor</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../utils/mongooseClassSerializer.interceptor&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">PostModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">UpdatePostDto</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./dto/updatePost.dto&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Controller</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;posts&#34;</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">@UseInterceptors</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">MongooseClassSerializerInterceptor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PostModel</span><span style="color:#000;font-weight:bold">))</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsController</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">postsService</span>: <span style="color:#204a87;font-weight:bold">PostsService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">@Put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;:id&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">updatePost</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Param</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span> <span style="color:#000;font-weight:bold">}</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">ParamsWithId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">@Body</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">post</span>: <span style="color:#204a87;font-weight:bold">UpdatePostDto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">post</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Thanks to doing the above, when we update a document, we replace it as a whole and remove not included fields.</p>
<p>We could also use the findOneAndReplace method. Not so long back, it wasn’t included with the TypeScript definitions shipped with the @types/mongoose, unfortunately. Thankfully, the Mongoose team started working on official TypeScript definitions. They released it in version v5.11.0.</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">NotFoundException</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">UpdatePostDto</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./dto/updatePost.dto&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">postData</span>: <span style="color:#204a87;font-weight:bold">UpdatePostDto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">post</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">findOneAndReplace</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">id</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#000">postData</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">new</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;author&#34;</span><span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;categories&#34;</span><span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;series&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">NotFoundException</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">post</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>createPost.dto.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">IsString</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">IsNotEmpty</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">IsMongoId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">IsOptional</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../../users/user.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Category</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../../categories/category.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Series</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../../series/series.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UpdatePostDto</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@IsMongoId</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@IsNotEmpty</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@IsString</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@IsNotEmpty</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@IsString</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@IsNotEmpty</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">content</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Category</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000">categories</span>: <span style="color:#204a87;font-weight:bold">Category</span><span style="color:#000;font-weight:bold">[];</span>

  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">@IsNotEmpty</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">author</span>: <span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Series</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">series?</span>: <span style="color:#204a87;font-weight:bold">Series</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">UpdatePostDto</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>Preventing the id from being updated
Since we expect the users to send the whole document, they also send the _id property. The above doesn’t cause any issues as long as the user doesn’t alter the id. That’s because doing that can cause an unexpected error:</p>
<p>MongoError: Plan executor error during findAndModify :: caused by :: After applying the update, the (immutable) field ‘_id’ was found to have been altered</p>
<p>We can deal with the above error by excluding the _id property from the body of our PUT request.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">IsOptional</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Exclude</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UpdatePostDto</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@Exclude</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">UpdatePostDto</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>Even if the user provides the _id property in the request, we exclude it and don’t pass it to the findOneAndReplace or the findByIdAndUpdate methods. Rest assured, because MongoDB won’t remove the _id property in such a case, even though we are implementing the PUT method here.</p>
<p>PATCH
While the PUT method is a common and valid choice, it might not fit every situation. For example, when implementing the PUT method, we assume that the API users know all of the details of a particular entity. Since omitting single property results in removing it, they need to be careful. A solution to this issue can be the PATCH method.</p>
<p>The PATCH method was introduced to the HTTP protocol in 2010 and aimed to apply a partial modification to an entity. The specification describes it as a set of instructions describing how a resource should be modified. The most straightforward way of implementing the PATCH method is to handle a body with a partial document.</p>
<p>PATCH /posts/614fa87e4027d3141f28e9e7</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">&#34;title&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;A new title&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#204a87;font-weight:bold">&#34;series&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>The above request modifies the post by changing the title and removing the series property. Please note that to delete a field, we need to send the null value explicitly. Thanks to this, no fields are deleted by accident.</p>
<p>Implementing PATCH with MongoDB and Mongoose
To implement a PATCH handler using Mongoose, we can use the findByIdAndUpdate method without the overwrite: true option. First, let’s use the @Patch decorator in our controller:</p>
<p>posts.controller.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Body</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Param</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Patch</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UseInterceptors</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PostsService</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./posts.service&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">ParamsWithId</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../utils/paramsWithId&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">MongooseClassSerializerInterceptor</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../utils/mongooseClassSerializer.interceptor&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">PostModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">UpdatePostDto</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./dto/updatePost.dto&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Controller</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;posts&#34;</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">@UseInterceptors</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">MongooseClassSerializerInterceptor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PostModel</span><span style="color:#000;font-weight:bold">))</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsController</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">postsService</span>: <span style="color:#204a87;font-weight:bold">PostsService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">@Patch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;:id&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">updatePost</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@Param</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span> <span style="color:#000;font-weight:bold">}</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">ParamsWithId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">@Body</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">post</span>: <span style="color:#204a87;font-weight:bold">UpdatePostDto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postsService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">post</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Now, let’s modify the service:</p>
<p>posts.service.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Injectable</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">InjectModel</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Post</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PostDocument</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./post.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">NotFoundException</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@nestjs/common&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">UpdatePostDto</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./dto/updatePost.dto&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">@Injectable</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PostsService</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">@InjectModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Post</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">postModel</span>: <span style="color:#204a87;font-weight:bold">Model</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PostDocument</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">postData</span>: <span style="color:#204a87;font-weight:bold">UpdatePostDto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">post</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">postModel</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">findByIdAndUpdate</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">_id</span>: <span style="color:#204a87;font-weight:bold">id</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#000">postData</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">new</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">})</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;author&#34;</span><span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;categories&#34;</span><span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#000">populate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;series&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">NotFoundException</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">post</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">PostsService</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>For the above to work correctly, we also need to modify our DTO by adding the @IsOptional decorators:</p>
<p>updatePost.dto.ts</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">IsString</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">IsNotEmpty</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">IsOptional</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-validator&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../../users/user.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Exclude</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;class-transformer&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Category</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../../categories/category.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Series</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../../series/series.schema&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UpdatePostDto</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@Exclude</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">_id?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@IsString</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@IsNotEmpty</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">title?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@IsString</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@IsNotEmpty</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">content?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Category</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">categories?</span>: <span style="color:#204a87;font-weight:bold">Category</span><span style="color:#000;font-weight:bold">[];</span>

  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#204a87;font-weight:bold">@IsNotEmpty</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">author?</span>: <span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">@Type</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Series</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#204a87;font-weight:bold">@IsOptional</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000">series?</span>: <span style="color:#204a87;font-weight:bold">Series</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">UpdatePostDto</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>Thanks to adding the @IsOptional decorators, the user no longer has to provide all of the document’s properties.</p>
<p>JSON Patch
An alternative approach to our implementation is to quite literally send a set of instructions on how to modify an object. A way to do that is to use the JSON Patch format.</p>
<p>PATCH /posts/614fa87e4027d3141f28e9e7</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">[</span>
  <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#a40000">op:</span> <span style="color:#204a87;font-weight:bold">&#34;replace&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#a40000">path:</span> <span style="color:#204a87;font-weight:bold">&#34;/content&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#a40000">value:</span> <span style="color:#204a87;font-weight:bold">&#34;A brand new content&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">]</span><span style="color:#a40000">;</span>
</code></pre></div><p>If you want to know more, check out the jsonpatch.com website. Additionally, the fast-json-patch library might come in handy when implementing the above format into your application.</p>
<h2 id="summary">Summary</h2>
<p>In this article, we’ve learned about various ways of implementing the update functionality. Thanks to getting to know both about PUT and PATCH, we can choose the best approach for a particular case. When selecting one of the above, we should follow the specification and implement our API predictably and transparently. If we do that, we will make the life of our teammates and API users easier.</p>

</div>



    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="User mailing list" aria-label="User mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/mail" aria-label="User mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/twitter" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Stack Overflow" aria-label="Stack Overflow">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/stack" aria-label="Stack Overflow">
      <i class="fab fa-stack-overflow"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/google/docsy" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/slack" aria-label="Slack">
      <i class="fab fa-slack"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Developer mailing list" aria-label="Developer mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/mail" aria-label="Developer mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2022 kamilmysliwiec 保留所有权利</small>
        <small class="ml-1"><a href="https://kamilmysliwiec.com/" target="_blank" rel="noopener">隐私政策</a></small>
	
		
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='/nestjs-docs/js/tabpane-persist.js'></script>


















<script src="/nestjs-docs/js/main.min.5f8acc65da891d70878ed44429f6a9dd7fab27a5cf9a7ceaa139c4059e89cfdc.js" integrity="sha256-X4rMZdqJHXCHjtREKfap3X&#43;rJ6XPmnzqoTnEBZ6Jz9w=" crossorigin="anonymous"></script>




  </body>
</html>
